<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › target › target_core_device.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>target_core_device.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>
<span class="cm"> * Filename:  target_core_device.c (based on iscsi_target_device.c)</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains the TCM Virtual Device and Disk Transport</span>
<span class="cm"> * agnostic related functions.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2003, 2004, 2005 PyX Technologies, Inc.</span>
<span class="cm"> * Copyright (c) 2005-2006 SBE, Inc.  All Rights Reserved.</span>
<span class="cm"> * Copyright (c) 2007-2010 Rising Tide Systems</span>
<span class="cm"> * Copyright (c) 2008-2010 Linux-iSCSI.org</span>
<span class="cm"> *</span>
<span class="cm"> * Nicholas A. Bellinger &lt;nab@kernel.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>

<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &lt;net/tcp.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>

<span class="cp">#include &lt;target/target_core_base.h&gt;</span>
<span class="cp">#include &lt;target/target_core_backend.h&gt;</span>
<span class="cp">#include &lt;target/target_core_fabric.h&gt;</span>

<span class="cp">#include &quot;target_core_internal.h&quot;</span>
<span class="cp">#include &quot;target_core_alua.h&quot;</span>
<span class="cp">#include &quot;target_core_pr.h&quot;</span>
<span class="cp">#include &quot;target_core_ua.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">se_dev_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">se_dev_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">lun0_hba</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">lun0_su_dev</span><span class="p">;</span>
<span class="cm">/* not static, needed by tpg.c */</span>
<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">g_lun0_dev</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">transport_lookup_cmd_lun</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">unpacked_lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">se_lun</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unpacked_lun</span> <span class="o">&gt;=</span> <span class="n">TRANSPORT_MAX_LUNS_PER_TPG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_NON_EXISTENT_LUN</span><span class="p">;</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_cmd_flags</span> <span class="o">|=</span> <span class="n">SCF_SCSI_CDB_EXCEPTION</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_deve</span> <span class="o">=</span> <span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">[</span><span class="n">unpacked_lun</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_LUNFLAGS_INITIATOR_ACCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">deve</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_deve</span><span class="p">;</span>

		<span class="n">deve</span><span class="o">-&gt;</span><span class="n">total_cmds</span><span class="o">++</span><span class="p">;</span>
		<span class="n">deve</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_LUNFLAGS_READ_ONLY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_WRITE_PROTECTED</span><span class="p">;</span>
			<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_cmd_flags</span> <span class="o">|=</span> <span class="n">SCF_SCSI_CDB_EXCEPTION</span><span class="p">;</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;TARGET_CORE[%s]: Detected WRITE_PROTECTED LUN&quot;</span>
				<span class="s">&quot; Access for 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
				<span class="n">unpacked_lun</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
			<span class="n">deve</span><span class="o">-&gt;</span><span class="n">write_bytes</span> <span class="o">+=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span>
			<span class="n">deve</span><span class="o">-&gt;</span><span class="n">read_bytes</span> <span class="o">+=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">;</span>

		<span class="n">deve</span><span class="o">-&gt;</span><span class="n">deve_cmds</span><span class="o">++</span><span class="p">;</span>

		<span class="n">se_lun</span> <span class="o">=</span> <span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="p">;</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_lun</span> <span class="o">=</span> <span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="p">;</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">=</span> <span class="n">deve</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">;</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">orig_fe_lun</span> <span class="o">=</span> <span class="n">unpacked_lun</span><span class="p">;</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_cmd_flags</span> <span class="o">|=</span> <span class="n">SCF_SE_LUN_CMD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se_lun</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Use the se_portal_group-&gt;tpg_virt_lun0 to allow for</span>
<span class="cm">		 * REPORT_LUNS, et al to be returned when no active</span>
<span class="cm">		 * MappedLUN=0 exists for this Initiator Port.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unpacked_lun</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_NON_EXISTENT_LUN</span><span class="p">;</span>
			<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_cmd_flags</span> <span class="o">|=</span> <span class="n">SCF_SCSI_CDB_EXCEPTION</span><span class="p">;</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;TARGET_CORE[%s]: Detected NON_EXISTENT_LUN&quot;</span>
				<span class="s">&quot; Access for 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
				<span class="n">unpacked_lun</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Force WRITE PROTECT for virtual LUN 0</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">!=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">!=</span> <span class="n">DMA_NONE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_WRITE_PROTECTED</span><span class="p">;</span>
			<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_cmd_flags</span> <span class="o">|=</span> <span class="n">SCF_SCSI_CDB_EXCEPTION</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">se_lun</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">tpg_virt_lun0</span><span class="p">;</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_lun</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="o">-&gt;</span><span class="n">tpg_virt_lun0</span><span class="p">;</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">orig_fe_lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_cmd_flags</span> <span class="o">|=</span> <span class="n">SCF_SE_LUN_CMD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Determine if the struct se_lun is online.</span>
<span class="cm">	 * FIXME: Check for LUN_RESET + UNIT Attention</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">se_dev_check_online</span><span class="p">(</span><span class="n">se_lun</span><span class="o">-&gt;</span><span class="n">lun_se_dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_NON_EXISTENT_LUN</span><span class="p">;</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_cmd_flags</span> <span class="o">|=</span> <span class="n">SCF_SCSI_CDB_EXCEPTION</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Directly associate cmd with se_dev */</span>
	<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">se_lun</span><span class="o">-&gt;</span><span class="n">lun_se_dev</span><span class="p">;</span>

	<span class="cm">/* TODO: get rid of this and use atomics for stats */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">se_lun</span><span class="o">-&gt;</span><span class="n">lun_se_dev</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_cmds</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">write_bytes</span> <span class="o">+=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read_bytes</span> <span class="o">+=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_lun</span><span class="o">-&gt;</span><span class="n">lun_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_lun_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">se_lun</span><span class="o">-&gt;</span><span class="n">lun_cmd_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_lun</span><span class="o">-&gt;</span><span class="n">lun_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">transport_lookup_cmd_lun</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">transport_lookup_tmr_lun</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">unpacked_lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">deve</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">se_lun</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_tmr_req</span> <span class="o">*</span><span class="n">se_tmr</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_tmr_req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unpacked_lun</span> <span class="o">&gt;=</span> <span class="n">TRANSPORT_MAX_LUNS_PER_TPG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">scsi_sense_reason</span> <span class="o">=</span> <span class="n">TCM_NON_EXISTENT_LUN</span><span class="p">;</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_cmd_flags</span> <span class="o">|=</span> <span class="n">SCF_SCSI_CDB_EXCEPTION</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_deve</span> <span class="o">=</span> <span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">[</span><span class="n">unpacked_lun</span><span class="p">];</span>
	<span class="n">deve</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_deve</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_LUNFLAGS_INITIATOR_ACCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">se_tmr</span><span class="o">-&gt;</span><span class="n">tmr_lun</span> <span class="o">=</span> <span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="p">;</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_lun</span> <span class="o">=</span> <span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="p">;</span>
		<span class="n">se_lun</span> <span class="o">=</span> <span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="p">;</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">pr_res_key</span> <span class="o">=</span> <span class="n">deve</span><span class="o">-&gt;</span><span class="n">pr_res_key</span><span class="p">;</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">orig_fe_lun</span> <span class="o">=</span> <span class="n">unpacked_lun</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se_lun</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;TARGET_CORE[%s]: Detected NON_EXISTENT_LUN&quot;</span>
			<span class="s">&quot; Access for 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
			<span class="n">unpacked_lun</span><span class="p">);</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_cmd_flags</span> <span class="o">|=</span> <span class="n">SCF_SCSI_CDB_EXCEPTION</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Determine if the struct se_lun is online.</span>
<span class="cm">	 * FIXME: Check for LUN_RESET + UNIT Attention</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">se_dev_check_online</span><span class="p">(</span><span class="n">se_lun</span><span class="o">-&gt;</span><span class="n">lun_se_dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_cmd_flags</span> <span class="o">|=</span> <span class="n">SCF_SCSI_CDB_EXCEPTION</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Directly associate cmd with se_dev */</span>
	<span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_dev</span> <span class="o">=</span> <span class="n">se_lun</span><span class="o">-&gt;</span><span class="n">lun_se_dev</span><span class="p">;</span>
	<span class="n">se_tmr</span><span class="o">-&gt;</span><span class="n">tmr_dev</span> <span class="o">=</span> <span class="n">se_lun</span><span class="o">-&gt;</span><span class="n">lun_se_dev</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_tmr</span><span class="o">-&gt;</span><span class="n">tmr_dev</span><span class="o">-&gt;</span><span class="n">se_tmr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_tmr</span><span class="o">-&gt;</span><span class="n">tmr_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">se_tmr</span><span class="o">-&gt;</span><span class="n">tmr_dev</span><span class="o">-&gt;</span><span class="n">dev_tmr_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_tmr</span><span class="o">-&gt;</span><span class="n">tmr_dev</span><span class="o">-&gt;</span><span class="n">se_tmr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">transport_lookup_tmr_lun</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called from core_scsi3_emulate_pro_register_and_move()</span>
<span class="cm"> * and core_scsi3_decode_spec_i_port(), and will increment &amp;deve-&gt;pr_ref_count</span>
<span class="cm"> * when a matching rtpi is found.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="nf">core_get_se_deve_from_rtpi</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">rtpi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">deve</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">se_tpg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TRANSPORT_MAX_LUNS_PER_TPG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deve</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_LUNFLAGS_INITIATOR_ACCESS</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">lun</span> <span class="o">=</span> <span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lun</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s device entries device pointer is&quot;</span>
				<span class="s">&quot; NULL, but Initiator has access.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">());</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_sep</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s device entries device pointer is&quot;</span>
				<span class="s">&quot; NULL, but Initiator has access.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">());</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_rtpi</span> <span class="o">!=</span> <span class="n">rtpi</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deve</span><span class="o">-&gt;</span><span class="n">pr_ref_count</span><span class="p">);</span>
		<span class="n">smp_mb__after_atomic_inc</span><span class="p">();</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">deve</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">core_free_device_list_for_node</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">deve</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TRANSPORT_MAX_LUNS_PER_TPG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deve</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_LUNFLAGS_INITIATOR_ACCESS</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s device entries device pointer is&quot;</span>
				<span class="s">&quot; NULL, but Initiator has access.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">());</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lun</span> <span class="o">=</span> <span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="p">;</span>

		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>
		<span class="n">core_update_device_list_for_node</span><span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">deve</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">,</span>
			<span class="n">TRANSPORT_LUNFLAGS_NO_ACCESS</span><span class="p">,</span> <span class="n">nacl</span><span class="p">,</span> <span class="n">tpg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>

	<span class="n">array_free</span><span class="p">(</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">,</span> <span class="n">TRANSPORT_MAX_LUNS_PER_TPG</span><span class="p">);</span>
	<span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">core_dec_lacl_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">se_nacl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">deve</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">deve</span> <span class="o">=</span> <span class="n">se_nacl</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">[</span><span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">orig_fe_lun</span><span class="p">];</span>
	<span class="n">deve</span><span class="o">-&gt;</span><span class="n">deve_cmds</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">core_update_device_list_access</span><span class="p">(</span>
	<span class="n">u32</span> <span class="n">mapped_lun</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">lun_access</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">deve</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>
	<span class="n">deve</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">[</span><span class="n">mapped_lun</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lun_access</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_LUNFLAGS_READ_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TRANSPORT_LUNFLAGS_READ_ONLY</span><span class="p">;</span>
		<span class="n">deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">|=</span> <span class="n">TRANSPORT_LUNFLAGS_READ_WRITE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TRANSPORT_LUNFLAGS_READ_WRITE</span><span class="p">;</span>
		<span class="n">deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">|=</span> <span class="n">TRANSPORT_LUNFLAGS_READ_ONLY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*      core_update_device_list_for_node():</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">core_update_device_list_for_node</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_lun_acl</span> <span class="o">*</span><span class="n">lun_acl</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">mapped_lun</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">lun_access</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_sep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">deve</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">[</span><span class="n">mapped_lun</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">trans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the MappedLUN entry is being disabled, the entry in</span>
<span class="cm">	 * port-&gt;sep_alua_list must be removed now before clearing the</span>
<span class="cm">	 * struct se_dev_entry pointers below as logic in</span>
<span class="cm">	 * core_alua_do_transition_tg_pt() depends on these being present.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * deve-&gt;se_lun_acl will be NULL for demo-mode created LUNs</span>
<span class="cm">		 * that have not been explicitly concerted to MappedLUNs -&gt;</span>
<span class="cm">		 * struct se_lun_acl, but we remove deve-&gt;alua_port_list from</span>
<span class="cm">		 * port-&gt;sep_alua_list. This also means that active UAs and</span>
<span class="cm">		 * NodeACL context specific PR metadata for demo-mode</span>
<span class="cm">		 * MappedLUN *deve will be released below..</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_alua_lock</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deve</span><span class="o">-&gt;</span><span class="n">alua_port_list</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_alua_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Check if the call is handling demo mode -&gt; explict LUN ACL</span>
<span class="cm">		 * transition.  This transition must be for the same struct se_lun</span>
<span class="cm">		 * + mapped_lun that was setup in demo mode..</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_LUNFLAGS_INITIATOR_ACCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun_acl</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;struct se_dev_entry-&gt;se_lun_acl&quot;</span>
					<span class="s">&quot; already set for demo mode -&gt; explict&quot;</span>
					<span class="s">&quot; LUN ACL transition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun</span> <span class="o">!=</span> <span class="n">lun</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;struct se_dev_entry-&gt;se_lun does&quot;</span>
					<span class="s">&quot; match passed struct se_lun for demo mode&quot;</span>
					<span class="s">&quot; -&gt; explict LUN ACL transition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun_acl</span> <span class="o">=</span> <span class="n">lun_acl</span><span class="p">;</span>
			<span class="n">trans</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun</span> <span class="o">=</span> <span class="n">lun</span><span class="p">;</span>
			<span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun_acl</span> <span class="o">=</span> <span class="n">lun_acl</span><span class="p">;</span>
			<span class="n">deve</span><span class="o">-&gt;</span><span class="n">mapped_lun</span> <span class="o">=</span> <span class="n">mapped_lun</span><span class="p">;</span>
			<span class="n">deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">|=</span> <span class="n">TRANSPORT_LUNFLAGS_INITIATOR_ACCESS</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lun_access</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_LUNFLAGS_READ_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TRANSPORT_LUNFLAGS_READ_ONLY</span><span class="p">;</span>
			<span class="n">deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">|=</span> <span class="n">TRANSPORT_LUNFLAGS_READ_WRITE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TRANSPORT_LUNFLAGS_READ_WRITE</span><span class="p">;</span>
			<span class="n">deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">|=</span> <span class="n">TRANSPORT_LUNFLAGS_READ_ONLY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">trans</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">deve</span><span class="o">-&gt;</span><span class="n">creation_time</span> <span class="o">=</span> <span class="n">get_jiffies_64</span><span class="p">();</span>
		<span class="n">deve</span><span class="o">-&gt;</span><span class="n">attach_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_alua_lock</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deve</span><span class="o">-&gt;</span><span class="n">alua_port_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_alua_list</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_alua_lock</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Wait for any in process SPEC_I_PT=1 or REGISTER_AND_MOVE</span>
<span class="cm">	 * PR operation to complete.</span>
<span class="cm">	 */</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deve</span><span class="o">-&gt;</span><span class="n">pr_ref_count</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Disable struct se_dev_entry LUN ACL mapping</span>
<span class="cm">	 */</span>
	<span class="n">core_scsi3_ua_release_all</span><span class="p">(</span><span class="n">deve</span><span class="p">);</span>
	<span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun_acl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">deve</span><span class="o">-&gt;</span><span class="n">creation_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">deve</span><span class="o">-&gt;</span><span class="n">attach_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>

	<span class="n">core_scsi3_free_pr_reg_from_nacl</span><span class="p">(</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_se_dev</span><span class="p">,</span> <span class="n">nacl</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*      core_clear_lun_from_tpg():</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">core_clear_lun_from_tpg</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">,</span> <span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">deve</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">acl_node_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">nacl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">acl_node_list</span><span class="p">,</span> <span class="n">acl_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">acl_node_lock</span><span class="p">);</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TRANSPORT_MAX_LUNS_PER_TPG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">deve</span> <span class="o">=</span> <span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lun</span> <span class="o">!=</span> <span class="n">deve</span><span class="o">-&gt;</span><span class="n">se_lun</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>

			<span class="n">core_update_device_list_for_node</span><span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="n">deve</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">,</span> <span class="n">TRANSPORT_LUNFLAGS_NO_ACCESS</span><span class="p">,</span>
				<span class="n">nacl</span><span class="p">,</span> <span class="n">tpg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nacl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">acl_node_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">acl_node_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">se_port</span> <span class="o">*</span><span class="nf">core_alloc_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="o">*</span><span class="n">port_tmp</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_port</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate struct se_port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_alua_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_list</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_tg_pt_secondary_offline</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_alua_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_tg_pt_md_mutex</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_port_count</span> <span class="o">==</span> <span class="mh">0x0000ffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Reached dev-&gt;dev_port_count ==&quot;</span>
				<span class="s">&quot; 0x0000ffff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOSPC</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">again:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Allocate the next RELATIVE TARGET PORT IDENTIFER for this struct se_device</span>
<span class="cm">	 * Here is the table from spc4r17 section 7.7.3.8.</span>
<span class="cm">	 *</span>
<span class="cm">	 *    Table 473 -- RELATIVE TARGET PORT IDENTIFIER field</span>
<span class="cm">	 *</span>
<span class="cm">	 * Code      Description</span>
<span class="cm">	 * 0h        Reserved</span>
<span class="cm">	 * 1h        Relative port 1, historically known as port A</span>
<span class="cm">	 * 2h        Relative port 2, historically known as port B</span>
<span class="cm">	 * 3h to FFFFh    Relative port 3 through 65 535</span>
<span class="cm">	 */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_rtpi</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_rpti_counter</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_rtpi</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">port_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_sep_list</span><span class="p">,</span> <span class="n">sep_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Make sure RELATIVE TARGET PORT IDENTIFER is unique</span>
<span class="cm">		 * for 16-bit wrap..</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_rtpi</span> <span class="o">==</span> <span class="n">port_tmp</span><span class="o">-&gt;</span><span class="n">sep_rtpi</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">port</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">core_export_port</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">t10_alua_tg_pt_gp_member</span> <span class="o">*</span><span class="n">tg_pt_gp_mem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_sep_lock</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_tpg</span> <span class="o">=</span> <span class="n">tpg</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_lun</span> <span class="o">=</span> <span class="n">lun</span><span class="p">;</span>
	<span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_sep</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_sep_lock</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_sep_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">alua_type</span> <span class="o">==</span> <span class="n">SPC3_ALUA_EMULATED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tg_pt_gp_mem</span> <span class="o">=</span> <span class="n">core_alua_allocate_tg_pt_gp_mem</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tg_pt_gp_mem</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">tg_pt_gp_mem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate t10_alua_tg_pt&quot;</span>
					<span class="s">&quot;_gp_member_t</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tg_pt_gp_mem</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_mem_lock</span><span class="p">);</span>
		<span class="n">__core_alua_attach_tg_pt_gp_mem</span><span class="p">(</span><span class="n">tg_pt_gp_mem</span><span class="p">,</span>
			<span class="n">su_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">default_tg_pt_gp</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tg_pt_gp_mem</span><span class="o">-&gt;</span><span class="n">tg_pt_gp_mem_lock</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s/%s: Adding to default ALUA Target Port&quot;</span>
			<span class="s">&quot; Group: alua/default_tg_pt_gp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">());</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_port_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_index</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_rtpi</span><span class="p">;</span> <span class="cm">/* RELATIVE TARGET PORT IDENTIFER */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Called with struct se_device-&gt;se_port_lock spinlock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">core_release_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">se_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">)</span> <span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Wait for any port reference for PR ALL_TG_PT=1 operation</span>
<span class="cm">	 * to complete in __core_scsi3_alloc_registration()</span>
<span class="cm">	 */</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_tg_pt_ref_cnt</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>

	<span class="n">core_alua_free_tg_pt_gp_mem</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sep_list</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_port_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">core_dev_export</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">core_alloc_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_se_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">se_dev_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">);</span>
	<span class="n">core_export_port</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tpg</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">core_dev_unexport</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_sep</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_sep_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_se_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_sep_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_sep_lock</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">);</span>
	<span class="n">core_release_port</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_port_lock</span><span class="p">);</span>

	<span class="n">se_dev_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_se_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">target_report_luns</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_cmd</span> <span class="o">*</span><span class="n">se_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_dev_entry</span> <span class="o">*</span><span class="n">deve</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span> <span class="o">=</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lun_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">transport_kmap_data_sg</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If no struct se_session pointer is present, this struct se_cmd is</span>
<span class="cm">	 * coming via a target_core_mod PASSTHROUGH op, and not through</span>
<span class="cm">	 * a $FABRIC_MOD.  In that case, report LUN=0 only.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se_sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">int_to_scsilun</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">offset</span><span class="p">]);</span>
		<span class="n">lun_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TRANSPORT_MAX_LUNS_PER_TPG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">deve</span> <span class="o">=</span> <span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">device_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">deve</span><span class="o">-&gt;</span><span class="n">lun_flags</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_LUNFLAGS_INITIATOR_ACCESS</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * We determine the correct LUN LIST LENGTH even once we</span>
<span class="cm">		 * have reached the initial allocation length.</span>
<span class="cm">		 * See SPC2-R20 7.19.</span>
<span class="cm">		 */</span>
		<span class="n">lun_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">se_cmd</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">deve</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">offset</span><span class="p">]);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_sess</span><span class="o">-&gt;</span><span class="n">se_node_acl</span><span class="o">-&gt;</span><span class="n">device_list_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * See SPC3 r07, page 159.</span>
<span class="cm">	 */</span>
<span class="nl">done:</span>
	<span class="n">lun_count</span> <span class="o">*=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">lun_count</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">lun_count</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">lun_count</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lun_count</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">transport_kunmap_data_sg</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">);</span>

	<span class="n">target_complete_cmd</span><span class="p">(</span><span class="n">se_cmd</span><span class="p">,</span> <span class="n">GOOD</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*	se_release_device_for_hba():</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">se_release_device_for_hba</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_hba</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_DEVICE_ACTIVATED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_DEVICE_DEACTIVATED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_DEVICE_SHUTDOWN</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_DEVICE_OFFLINE_ACTIVATED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_DEVICE_OFFLINE_DEACTIVATED</span><span class="p">))</span>
		<span class="n">se_dev_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">process_thread</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">free_device</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">free_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">);</span>
	<span class="n">hba</span><span class="o">-&gt;</span><span class="n">dev_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>

	<span class="n">core_scsi3_free_all_registrations</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">se_release_vpd_for_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">se_release_vpd_for_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">t10_vpd</span> <span class="o">*</span><span class="n">vpd</span><span class="p">,</span> <span class="o">*</span><span class="n">vpd_tmp</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_wwn</span><span class="p">.</span><span class="n">t10_vpd_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">vpd</span><span class="p">,</span> <span class="n">vpd_tmp</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_wwn</span><span class="p">.</span><span class="n">t10_vpd_list</span><span class="p">,</span> <span class="n">vpd_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vpd</span><span class="o">-&gt;</span><span class="n">vpd_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vpd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">t10_wwn</span><span class="p">.</span><span class="n">t10_vpd_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*	se_free_virtual_device():</span>
<span class="cm"> *</span>
<span class="cm"> *	Used for IBLOCK, RAMDISK, and FILEIO Transport Drivers.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">se_free_virtual_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_sep_list</span><span class="p">))</span>
		<span class="n">dump_stack</span><span class="p">();</span>

	<span class="n">core_alua_free_lu_gp_mem</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">se_release_device_for_hba</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">se_dev_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_hba</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_DEVICE_DEACTIVATED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TRANSPORT_DEVICE_DEACTIVATED</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">|=</span> <span class="n">TRANSPORT_DEVICE_ACTIVATED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">&amp;</span>
			   <span class="n">TRANSPORT_DEVICE_OFFLINE_DEACTIVATED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="n">TRANSPORT_DEVICE_OFFLINE_DEACTIVATED</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">|=</span> <span class="n">TRANSPORT_DEVICE_OFFLINE_ACTIVATED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">se_dev_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_hba</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_DEVICE_ACTIVATED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TRANSPORT_DEVICE_ACTIVATED</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">|=</span> <span class="n">TRANSPORT_DEVICE_DEACTIVATED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">&amp;</span>
			   <span class="n">TRANSPORT_DEVICE_OFFLINE_ACTIVATED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TRANSPORT_DEVICE_OFFLINE_ACTIVATED</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">|=</span> <span class="n">TRANSPORT_DEVICE_OFFLINE_DEACTIVATED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">device_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_check_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_DEVICE_ACTIVATED</span><span class="p">)</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_DEVICE_DEACTIVATED</span><span class="p">))</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_check_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_DEVICE_SHUTDOWN</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_status_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">se_dev_align_max_sectors</span><span class="p">(</span><span class="n">u32</span> <span class="n">max_sectors</span><span class="p">,</span> <span class="n">u32</span> <span class="n">block_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">aligned_max_sectors</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Limit max_sectors to a PAGE_SIZE aligned value for modern</span>
<span class="cm">	 * transport_allocate_data_tasks() operation.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">rounddown</span><span class="p">((</span><span class="n">max_sectors</span> <span class="o">*</span> <span class="n">block_size</span><span class="p">),</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">aligned_max_sectors</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">/</span> <span class="n">block_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_sectors</span> <span class="o">!=</span> <span class="n">aligned_max_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Rounding down aligned max_sectors from %u&quot;</span>
				<span class="s">&quot; to %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_sectors</span><span class="p">,</span> <span class="n">aligned_max_sectors</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">aligned_max_sectors</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">max_sectors</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">se_dev_set_default_attribs</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_dev_limits</span> <span class="o">*</span><span class="n">dev_limits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">queue_limits</span> <span class="o">*</span><span class="n">limits</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_limits</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_dpo</span> <span class="o">=</span> <span class="n">DA_EMULATE_DPO</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_fua_write</span> <span class="o">=</span> <span class="n">DA_EMULATE_FUA_WRITE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_fua_read</span> <span class="o">=</span> <span class="n">DA_EMULATE_FUA_READ</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_write_cache</span> <span class="o">=</span> <span class="n">DA_EMULATE_WRITE_CACHE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_ua_intlck_ctrl</span> <span class="o">=</span> <span class="n">DA_EMULATE_UA_INTLLCK_CTRL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_tas</span> <span class="o">=</span> <span class="n">DA_EMULATE_TAS</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_tpu</span> <span class="o">=</span> <span class="n">DA_EMULATE_TPU</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_tpws</span> <span class="o">=</span> <span class="n">DA_EMULATE_TPWS</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_reservations</span> <span class="o">=</span> <span class="n">DA_EMULATE_RESERVATIONS</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_alua</span> <span class="o">=</span> <span class="n">DA_EMULATE_ALUA</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">enforce_pr_isids</span> <span class="o">=</span> <span class="n">DA_ENFORCE_PR_ISIDS</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">is_nonrot</span> <span class="o">=</span> <span class="n">DA_IS_NONROT</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_rest_reord</span> <span class="o">=</span> <span class="n">DA_EMULATE_REST_REORD</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The TPU=1 and TPWS=1 settings will be set in TCM/IBLOCK</span>
<span class="cm">	 * iblock_create_virtdevice() from struct queue_limits values</span>
<span class="cm">	 * if blk_queue_discard()==1</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">max_unmap_lba_count</span> <span class="o">=</span> <span class="n">DA_MAX_UNMAP_LBA_COUNT</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">max_unmap_block_desc_count</span> <span class="o">=</span>
		<span class="n">DA_MAX_UNMAP_BLOCK_DESC_COUNT</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">unmap_granularity</span> <span class="o">=</span> <span class="n">DA_UNMAP_GRANULARITY_DEFAULT</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">unmap_granularity_alignment</span> <span class="o">=</span>
				<span class="n">DA_UNMAP_GRANULARITY_ALIGNMENT_DEFAULT</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * block_size is based on subsystem plugin dependent requirements.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">hw_block_size</span> <span class="o">=</span> <span class="n">limits</span><span class="o">-&gt;</span><span class="n">logical_block_size</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">limits</span><span class="o">-&gt;</span><span class="n">logical_block_size</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Align max_hw_sectors down to PAGE_SIZE I/O transfers</span>
<span class="cm">	 */</span>
	<span class="n">limits</span><span class="o">-&gt;</span><span class="n">max_hw_sectors</span> <span class="o">=</span> <span class="n">se_dev_align_max_sectors</span><span class="p">(</span><span class="n">limits</span><span class="o">-&gt;</span><span class="n">max_hw_sectors</span><span class="p">,</span>
						<span class="n">limits</span><span class="o">-&gt;</span><span class="n">logical_block_size</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">hw_max_sectors</span> <span class="o">=</span> <span class="n">limits</span><span class="o">-&gt;</span><span class="n">max_hw_sectors</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set fabric_max_sectors, which is reported in block limits</span>
<span class="cm">	 * VPD page (B0h).</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">fabric_max_sectors</span> <span class="o">=</span> <span class="n">DA_FABRIC_MAX_SECTORS</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set optimal_sectors from fabric_max_sectors, which can be</span>
<span class="cm">	 * lowered via configfs.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">optimal_sectors</span> <span class="o">=</span> <span class="n">DA_FABRIC_MAX_SECTORS</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * queue_depth is based on subsystem plugin dependent requirements.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">hw_queue_depth</span> <span class="o">=</span> <span class="n">dev_limits</span><span class="o">-&gt;</span><span class="n">hw_queue_depth</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">queue_depth</span> <span class="o">=</span> <span class="n">dev_limits</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_max_unmap_lba_count</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">max_unmap_lba_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">max_unmap_lba_count</span> <span class="o">=</span> <span class="n">max_unmap_lba_count</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: Set max_unmap_lba_count: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">max_unmap_lba_count</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_max_unmap_block_desc_count</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">max_unmap_block_desc_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">max_unmap_block_desc_count</span> <span class="o">=</span>
		<span class="n">max_unmap_block_desc_count</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: Set max_unmap_block_desc_count: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">max_unmap_block_desc_count</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_unmap_granularity</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">unmap_granularity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">unmap_granularity</span> <span class="o">=</span> <span class="n">unmap_granularity</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: Set unmap_granularity: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">unmap_granularity</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_unmap_granularity_alignment</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">unmap_granularity_alignment</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">unmap_granularity_alignment</span> <span class="o">=</span> <span class="n">unmap_granularity_alignment</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: Set unmap_granularity_alignment: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">unmap_granularity_alignment</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_emulate_dpo</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">flag</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Illegal value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dpo_emulated not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_emulate_fua_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">flag</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Illegal value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">fua_write_emulated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;fua_write_emulated not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_fua_write</span> <span class="o">=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: SE Device Forced Unit Access WRITEs: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_fua_write</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_emulate_fua_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">flag</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Illegal value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ua read emulated not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_emulate_write_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">flag</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Illegal value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">write_cache_emulated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;write_cache_emulated not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_write_cache</span> <span class="o">=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: SE Device WRITE_CACHE_EMULATION flag: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_write_cache</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_emulate_ua_intlck_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Illegal value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Unable to change SE Device&quot;</span>
			<span class="s">&quot; UA_INTRLCK_CTRL while dev_export_obj: %d count&quot;</span>
			<span class="s">&quot; exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_ua_intlck_ctrl</span> <span class="o">=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: SE Device UA_INTRLCK_CTRL flag: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_ua_intlck_ctrl</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_emulate_tas</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Illegal value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Unable to change SE Device TAS while&quot;</span>
			<span class="s">&quot; dev_export_obj: %d count exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_tas</span> <span class="o">=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: SE Device TASK_ABORTED status bit: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_tas</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;Disabled&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_emulate_tpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Illegal value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * We expect this value to be non-zero when generic Block Layer</span>
<span class="cm">	 * Discard supported is detected iblock_create_virtdevice().</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">max_unmap_block_desc_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Generic Block Discard not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_tpu</span> <span class="o">=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: SE Device Thin Provisioning UNMAP bit: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_emulate_tpws</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Illegal value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * We expect this value to be non-zero when generic Block Layer</span>
<span class="cm">	 * Discard supported is detected iblock_create_virtdevice().</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">max_unmap_block_desc_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Generic Block Discard not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_tpws</span> <span class="o">=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: SE Device Thin Provisioning WRITE_SAME: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_enforce_pr_isids</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Illegal value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">enforce_pr_isids</span> <span class="o">=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: SE Device enforce_pr_isids bit: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">enforce_pr_isids</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;Disabled&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_is_nonrot</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Illegal value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">is_nonrot</span> <span class="o">=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: SE Device is_nonrot bit: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_emulate_rest_reord</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dev[%p]: SE Device emulatation of restricted&quot;</span>
			<span class="s">&quot; reordering not implemented</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">emulate_rest_reord</span> <span class="o">=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: SE Device emulate_rest_reord: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Note, this can only be called on unexported SE Device Object.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">se_dev_set_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">queue_depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Unable to change SE Device TCQ while&quot;</span>
			<span class="s">&quot; dev_export_obj: %d count exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Illegal ZERO value for queue&quot;</span>
			<span class="s">&quot;_depth</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">transport_type</span> <span class="o">==</span> <span class="n">TRANSPORT_PLUGIN_PHBA_PDEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queue_depth</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">hw_queue_depth</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Passed queue_depth: %u&quot;</span>
				<span class="s">&quot; exceeds TCM/SE_Device TCQ: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="p">,</span> <span class="n">queue_depth</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">hw_queue_depth</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queue_depth</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">queue_depth</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">queue_depth</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">hw_queue_depth</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Passed queue_depth:&quot;</span>
					<span class="s">&quot; %u exceeds TCM/SE_Device MAX&quot;</span>
					<span class="s">&quot; TCQ: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">queue_depth</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">hw_queue_depth</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">queue_depth</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">queue_depth</span> <span class="o">=</span> <span class="n">queue_depth</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: SE Device TCQ Depth changed to: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="p">,</span> <span class="n">queue_depth</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_fabric_max_sectors</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fabric_max_sectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Unable to change SE Device&quot;</span>
			<span class="s">&quot; fabric_max_sectors while dev_export_obj: %d count exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fabric_max_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Illegal ZERO value for&quot;</span>
			<span class="s">&quot; fabric_max_sectors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fabric_max_sectors</span> <span class="o">&lt;</span> <span class="n">DA_STATUS_MAX_SECTORS_MIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Passed fabric_max_sectors: %u less than&quot;</span>
			<span class="s">&quot; DA_STATUS_MAX_SECTORS_MIN: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">fabric_max_sectors</span><span class="p">,</span>
				<span class="n">DA_STATUS_MAX_SECTORS_MIN</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">transport_type</span> <span class="o">==</span> <span class="n">TRANSPORT_PLUGIN_PHBA_PDEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fabric_max_sectors</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">hw_max_sectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Passed fabric_max_sectors: %u&quot;</span>
				<span class="s">&quot; greater than TCM/SE_Device max_sectors:&quot;</span>
				<span class="s">&quot; %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">fabric_max_sectors</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">hw_max_sectors</span><span class="p">);</span>
			 <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fabric_max_sectors</span> <span class="o">&gt;</span> <span class="n">DA_STATUS_MAX_SECTORS_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Passed fabric_max_sectors: %u&quot;</span>
				<span class="s">&quot; greater than DA_STATUS_MAX_SECTORS_MAX:&quot;</span>
				<span class="s">&quot; %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">fabric_max_sectors</span><span class="p">,</span>
				<span class="n">DA_STATUS_MAX_SECTORS_MAX</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Align max_sectors down to PAGE_SIZE to follow transport_allocate_data_tasks()</span>
<span class="cm">	 */</span>
	<span class="n">fabric_max_sectors</span> <span class="o">=</span> <span class="n">se_dev_align_max_sectors</span><span class="p">(</span><span class="n">fabric_max_sectors</span><span class="p">,</span>
						      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">block_size</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">fabric_max_sectors</span> <span class="o">=</span> <span class="n">fabric_max_sectors</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: SE Device max_sectors changed to %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="p">,</span> <span class="n">fabric_max_sectors</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_optimal_sectors</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">optimal_sectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Unable to change SE Device&quot;</span>
			<span class="s">&quot; optimal_sectors while dev_export_obj: %d count exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">transport_type</span> <span class="o">==</span> <span class="n">TRANSPORT_PLUGIN_PHBA_PDEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Passed optimal_sectors cannot be&quot;</span>
				<span class="s">&quot; changed for TCM/pSCSI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">optimal_sectors</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">fabric_max_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Passed optimal_sectors %u cannot be&quot;</span>
			<span class="s">&quot; greater than fabric_max_sectors: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			<span class="n">optimal_sectors</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">fabric_max_sectors</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">optimal_sectors</span> <span class="o">=</span> <span class="n">optimal_sectors</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: SE Device optimal_sectors changed to %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="p">,</span> <span class="n">optimal_sectors</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">se_dev_set_block_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">block_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Unable to change SE Device block_size&quot;</span>
			<span class="s">&quot; while dev_export_obj: %d count exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_export_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">512</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">block_size</span> <span class="o">!=</span> <span class="mi">4096</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Illegal value for block_device: %u&quot;</span>
			<span class="s">&quot; for SE device, must be 512, 1024, 2048 or 4096</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">transport</span><span class="o">-&gt;</span><span class="n">transport_type</span> <span class="o">==</span> <span class="n">TRANSPORT_PLUGIN_PHBA_PDEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;dev[%p]: Not allowed to change block_size for&quot;</span>
			<span class="s">&quot; Physical Device, use for Linux/SCSI to change&quot;</span>
			<span class="s">&quot; block_size for underlying hardware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">se_sub_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">block_size</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dev[%p]: SE Device block_size changed to %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="nf">core_dev_add_lun</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun_p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_access_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to export struct se_device while dev_access_obj: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_access_obj</span><span class="p">.</span><span class="n">obj_access_count</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lun_p</span> <span class="o">=</span> <span class="n">core_tpg_pre_addlun</span><span class="p">(</span><span class="n">tpg</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">lun_p</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">lun_p</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">core_tpg_post_addlun</span><span class="p">(</span><span class="n">tpg</span><span class="p">,</span> <span class="n">lun_p</span><span class="p">,</span>
				<span class="n">TRANSPORT_LUNFLAGS_READ_WRITE</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s_TPG[%u]_LUN[%u] - Activated %s Logical Unit from&quot;</span>
		<span class="s">&quot; CORE HBA: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_tag</span><span class="p">(</span><span class="n">tpg</span><span class="p">),</span> <span class="n">lun_p</span><span class="o">-&gt;</span><span class="n">unpacked_lun</span><span class="p">,</span>
		<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">hba_id</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Update LUN maps for dynamically added initiators when</span>
<span class="cm">	 * generate_node_acl is enabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_check_demo_mode</span><span class="p">(</span><span class="n">tpg</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">acl</span><span class="p">;</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">acl_node_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">acl_node_list</span><span class="p">,</span> <span class="n">acl_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">dynamic_node_acl</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="o">!</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_check_demo_mode_login_only</span> <span class="o">||</span>
			     <span class="o">!</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_check_demo_mode_login_only</span><span class="p">(</span><span class="n">tpg</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">acl_node_lock</span><span class="p">);</span>
				<span class="n">core_tpg_add_node_to_devs</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">tpg</span><span class="p">);</span>
				<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">acl_node_lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">acl_node_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">lun_p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*      core_dev_del_lun():</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">core_dev_del_lun</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">unpacked_lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">;</span>

	<span class="n">lun</span> <span class="o">=</span> <span class="n">core_tpg_pre_dellun</span><span class="p">(</span><span class="n">tpg</span><span class="p">,</span> <span class="n">unpacked_lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">lun</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">lun</span><span class="p">);</span>

	<span class="n">core_tpg_post_dellun</span><span class="p">(</span><span class="n">tpg</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s_TPG[%u]_LUN[%u] - Deactivated %s Logical Unit from&quot;</span>
		<span class="s">&quot; device object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_tag</span><span class="p">(</span><span class="n">tpg</span><span class="p">),</span> <span class="n">unpacked_lun</span><span class="p">,</span>
		<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">());</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="nf">core_get_lun_from_tpg</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">unpacked_lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_lun_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unpacked_lun</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">TRANSPORT_MAX_LUNS_PER_TPG</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s LUN: %u exceeds TRANSPORT_MAX_LUNS&quot;</span>
			<span class="s">&quot;_PER_TPG-1: %u for Target Portal Group: %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">unpacked_lun</span><span class="p">,</span>
			<span class="n">TRANSPORT_MAX_LUNS_PER_TPG</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_tag</span><span class="p">(</span><span class="n">tpg</span><span class="p">));</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_lun_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_lun_list</span><span class="p">[</span><span class="n">unpacked_lun</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_status</span> <span class="o">!=</span> <span class="n">TRANSPORT_LUN_STATUS_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s Logical Unit Number: %u is not free on&quot;</span>
			<span class="s">&quot; Target Portal Group: %hu, ignoring request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">unpacked_lun</span><span class="p">,</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_tag</span><span class="p">(</span><span class="n">tpg</span><span class="p">));</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_lun_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_lun_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">lun</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*      core_dev_get_lun():</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="nf">core_dev_get_lun</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">unpacked_lun</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_lun_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unpacked_lun</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">TRANSPORT_MAX_LUNS_PER_TPG</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s LUN: %u exceeds TRANSPORT_MAX_LUNS_PER&quot;</span>
			<span class="s">&quot;_TPG-1: %u for Target Portal Group: %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">unpacked_lun</span><span class="p">,</span>
			<span class="n">TRANSPORT_MAX_LUNS_PER_TPG</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_tag</span><span class="p">(</span><span class="n">tpg</span><span class="p">));</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_lun_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lun</span> <span class="o">=</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_lun_list</span><span class="p">[</span><span class="n">unpacked_lun</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_status</span> <span class="o">!=</span> <span class="n">TRANSPORT_LUN_STATUS_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s Logical Unit Number: %u is not active on&quot;</span>
			<span class="s">&quot; Target Portal Group: %hu, ignoring request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">unpacked_lun</span><span class="p">,</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_tag</span><span class="p">(</span><span class="n">tpg</span><span class="p">));</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_lun_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpg</span><span class="o">-&gt;</span><span class="n">tpg_lun_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">lun</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">se_lun_acl</span> <span class="o">*</span><span class="nf">core_dev_init_initiator_node_lun_acl</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">mapped_lun</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">initiatorname</span><span class="p">,</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_lun_acl</span> <span class="o">*</span><span class="n">lacl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">initiatorname</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">TRANSPORT_IQN_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s InitiatorName exceeds maximum size.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">());</span>
		<span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nacl</span> <span class="o">=</span> <span class="n">core_tpg_get_initiator_node_acl</span><span class="p">(</span><span class="n">tpg</span><span class="p">,</span> <span class="n">initiatorname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nacl</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lacl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_lun_acl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lacl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate memory for struct se_lun_acl.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lacl</span><span class="o">-&gt;</span><span class="n">lacl_list</span><span class="p">);</span>
	<span class="n">lacl</span><span class="o">-&gt;</span><span class="n">mapped_lun</span> <span class="o">=</span> <span class="n">mapped_lun</span><span class="p">;</span>
	<span class="n">lacl</span><span class="o">-&gt;</span><span class="n">se_lun_nacl</span> <span class="o">=</span> <span class="n">nacl</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">lacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span> <span class="n">TRANSPORT_IQN_LEN</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">initiatorname</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">lacl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">core_dev_add_initiator_node_lun_acl</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_lun_acl</span> <span class="o">*</span><span class="n">lacl</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">unpacked_lun</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">lun_access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">;</span>

	<span class="n">lun</span> <span class="o">=</span> <span class="n">core_dev_get_lun</span><span class="p">(</span><span class="n">tpg</span><span class="p">,</span> <span class="n">unpacked_lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lun</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s Logical Unit Number: %u is not active on&quot;</span>
			<span class="s">&quot; Target Portal Group: %hu, ignoring request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span> <span class="n">unpacked_lun</span><span class="p">,</span>
			<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_tag</span><span class="p">(</span><span class="n">tpg</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nacl</span> <span class="o">=</span> <span class="n">lacl</span><span class="o">-&gt;</span><span class="n">se_lun_nacl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nacl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_access</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_LUNFLAGS_READ_ONLY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">lun_access</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_LUNFLAGS_READ_WRITE</span><span class="p">))</span>
		<span class="n">lun_access</span> <span class="o">=</span> <span class="n">TRANSPORT_LUNFLAGS_READ_ONLY</span><span class="p">;</span>

	<span class="n">lacl</span><span class="o">-&gt;</span><span class="n">se_lun</span> <span class="o">=</span> <span class="n">lun</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core_update_device_list_for_node</span><span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="n">lacl</span><span class="p">,</span> <span class="n">lacl</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">,</span>
			<span class="n">lun_access</span><span class="p">,</span> <span class="n">nacl</span><span class="p">,</span> <span class="n">tpg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_acl_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lacl</span><span class="o">-&gt;</span><span class="n">lacl_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_acl_list</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_acl_count</span><span class="p">);</span>
	<span class="n">smp_mb__after_atomic_inc</span><span class="p">();</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_acl_lock</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s_TPG[%hu]_LUN[%u-&gt;%u] - Added %s ACL for &quot;</span>
		<span class="s">&quot; InitiatorNode: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_tag</span><span class="p">(</span><span class="n">tpg</span><span class="p">),</span> <span class="n">unpacked_lun</span><span class="p">,</span> <span class="n">lacl</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">,</span>
		<span class="p">(</span><span class="n">lun_access</span> <span class="o">&amp;</span> <span class="n">TRANSPORT_LUNFLAGS_READ_WRITE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RW&quot;</span> <span class="o">:</span> <span class="s">&quot;RO&quot;</span><span class="p">,</span>
		<span class="n">lacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check to see if there are any existing persistent reservation APTPL</span>
<span class="cm">	 * pre-registrations that need to be enabled for this LUN ACL..</span>
<span class="cm">	 */</span>
	<span class="n">core_scsi3_check_aptpl_registration</span><span class="p">(</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_se_dev</span><span class="p">,</span> <span class="n">tpg</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">lacl</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*      core_dev_del_initiator_node_lun_acl():</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">core_dev_del_initiator_node_lun_acl</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_lun_acl</span> <span class="o">*</span><span class="n">lacl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="o">*</span><span class="n">nacl</span><span class="p">;</span>

	<span class="n">nacl</span> <span class="o">=</span> <span class="n">lacl</span><span class="o">-&gt;</span><span class="n">se_lun_nacl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nacl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_acl_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lacl</span><span class="o">-&gt;</span><span class="n">lacl_list</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_acl_count</span><span class="p">);</span>
	<span class="n">smp_mb__after_atomic_dec</span><span class="p">();</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lun</span><span class="o">-&gt;</span><span class="n">lun_acl_lock</span><span class="p">);</span>

	<span class="n">core_update_device_list_for_node</span><span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">lacl</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">,</span>
		<span class="n">TRANSPORT_LUNFLAGS_NO_ACCESS</span><span class="p">,</span> <span class="n">nacl</span><span class="p">,</span> <span class="n">tpg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">lacl</span><span class="o">-&gt;</span><span class="n">se_lun</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s_TPG[%hu]_LUN[%u] - Removed ACL for&quot;</span>
		<span class="s">&quot; InitiatorNode: %s Mapped LUN: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_tag</span><span class="p">(</span><span class="n">tpg</span><span class="p">),</span> <span class="n">lun</span><span class="o">-&gt;</span><span class="n">unpacked_lun</span><span class="p">,</span>
		<span class="n">lacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span> <span class="n">lacl</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">core_dev_free_initiator_node_lun_acl</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="o">*</span><span class="n">tpg</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">se_lun_acl</span> <span class="o">*</span><span class="n">lacl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s_TPG[%hu] - Freeing ACL for %s InitiatorNode: %s&quot;</span>
		<span class="s">&quot; Mapped LUN: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">tpg_get_tag</span><span class="p">(</span><span class="n">tpg</span><span class="p">),</span>
		<span class="n">tpg</span><span class="o">-&gt;</span><span class="n">se_tpg_tfo</span><span class="o">-&gt;</span><span class="n">get_fabric_name</span><span class="p">(),</span>
		<span class="n">lacl</span><span class="o">-&gt;</span><span class="n">initiatorname</span><span class="p">,</span> <span class="n">lacl</span><span class="o">-&gt;</span><span class="n">mapped_lun</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">lacl</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">core_dev_setup_virtual_lun0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">se_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_api</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">hba</span> <span class="o">=</span> <span class="n">core_alloc_hba</span><span class="p">(</span><span class="s">&quot;rd_mcp&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HBA_FLAGS_INTERNAL_USE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hba</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>

	<span class="n">lun0_hba</span> <span class="o">=</span> <span class="n">hba</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">transport</span><span class="p">;</span>

	<span class="n">se_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">se_subsystem_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to allocate memory for&quot;</span>
				<span class="s">&quot; struct se_subsystem_dev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_wwn</span><span class="p">.</span><span class="n">t10_vpd_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_wwn</span><span class="p">.</span><span class="n">t10_vpd_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">registration_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">aptpl_reg_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">registration_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">aptpl_reg_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">tg_pt_gps_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">tg_pt_gps_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_lock</span><span class="p">);</span>
	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_pr</span><span class="p">.</span><span class="n">pr_aptpl_buf_len</span> <span class="o">=</span> <span class="n">PR_APTPL_BUF_LEN</span><span class="p">;</span>
	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_wwn</span><span class="p">.</span><span class="n">t10_sub_dev</span> <span class="o">=</span> <span class="n">se_dev</span><span class="p">;</span>
	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">t10_alua</span><span class="p">.</span><span class="n">t10_sub_dev</span> <span class="o">=</span> <span class="n">se_dev</span><span class="p">;</span>
	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_attrib</span><span class="p">.</span><span class="n">da_sub_dev</span> <span class="o">=</span> <span class="n">se_dev</span><span class="p">;</span>
	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_hba</span> <span class="o">=</span> <span class="n">hba</span><span class="p">;</span>

	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_su_ptr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">allocate_virtdevice</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="s">&quot;virt_lun0&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_su_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to locate subsystem dependent pointer&quot;</span>
			<span class="s">&quot; from allocate_virtdevice()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lun0_su_dev</span> <span class="o">=</span> <span class="n">se_dev</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;rd_pages=8&quot;</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">set_configfs_dev_params</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">se_dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">create_virtdevice</span><span class="p">(</span><span class="n">hba</span><span class="p">,</span> <span class="n">se_dev</span><span class="p">,</span> <span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_su_ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">se_dev</span><span class="o">-&gt;</span><span class="n">se_dev_ptr</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">g_lun0_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">lun0_su_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">se_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lun0_hba</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">core_delete_hba</span><span class="p">(</span><span class="n">lun0_hba</span><span class="p">);</span>
		<span class="n">lun0_hba</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">core_dev_release_virtual_lun0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">se_hba</span> <span class="o">*</span><span class="n">hba</span> <span class="o">=</span> <span class="n">lun0_hba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_subsystem_dev</span> <span class="o">*</span><span class="n">su_dev</span> <span class="o">=</span> <span class="n">lun0_su_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hba</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">g_lun0_dev</span><span class="p">)</span>
		<span class="n">se_free_virtual_device</span><span class="p">(</span><span class="n">g_lun0_dev</span><span class="p">,</span> <span class="n">hba</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">su_dev</span><span class="p">);</span>
	<span class="n">core_delete_hba</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
