<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › target › sbp › sbp_target.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sbp_target.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _SBP_BASE_H</span>
<span class="cp">#define _SBP_BASE_H</span>

<span class="cp">#include &lt;linux/firewire.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;target/target_core_base.h&gt;</span>

<span class="cp">#define SBP_VERSION  &quot;v0.1&quot;</span>
<span class="cp">#define SBP_NAMELEN 32</span>

<span class="cp">#define SBP_ORB_FETCH_SIZE	8</span>

<span class="cp">#define MANAGEMENT_AGENT_STATE_IDLE	0</span>
<span class="cp">#define MANAGEMENT_AGENT_STATE_BUSY	1</span>

<span class="cp">#define ORB_NOTIFY(v)			(((v) &gt;&gt; 31) &amp; 0x01)</span>
<span class="cp">#define ORB_REQUEST_FORMAT(v)		(((v) &gt;&gt; 29) &amp; 0x03)</span>

<span class="cp">#define MANAGEMENT_ORB_FUNCTION(v)	(((v) &gt;&gt; 16) &amp; 0x0f)</span>

<span class="cp">#define MANAGEMENT_ORB_FUNCTION_LOGIN			0x0</span>
<span class="cp">#define MANAGEMENT_ORB_FUNCTION_QUERY_LOGINS		0x1</span>
<span class="cp">#define MANAGEMENT_ORB_FUNCTION_RECONNECT		0x3</span>
<span class="cp">#define MANAGEMENT_ORB_FUNCTION_SET_PASSWORD		0x4</span>
<span class="cp">#define MANAGEMENT_ORB_FUNCTION_LOGOUT			0x7</span>
<span class="cp">#define MANAGEMENT_ORB_FUNCTION_ABORT_TASK		0xb</span>
<span class="cp">#define MANAGEMENT_ORB_FUNCTION_ABORT_TASK_SET		0xc</span>
<span class="cp">#define MANAGEMENT_ORB_FUNCTION_LOGICAL_UNIT_RESET	0xe</span>
<span class="cp">#define MANAGEMENT_ORB_FUNCTION_TARGET_RESET		0xf</span>

<span class="cp">#define LOGIN_ORB_EXCLUSIVE(v)		(((v) &gt;&gt; 28) &amp;   0x01)</span>
<span class="cp">#define LOGIN_ORB_RESERVED(v)		(((v) &gt;&gt; 24) &amp;   0x0f)</span>
<span class="cp">#define LOGIN_ORB_RECONNECT(v)		(((v) &gt;&gt; 20) &amp;   0x0f)</span>
<span class="cp">#define LOGIN_ORB_LUN(v)		(((v) &gt;&gt;  0) &amp; 0xffff)</span>
<span class="cp">#define LOGIN_ORB_PASSWORD_LENGTH(v)	(((v) &gt;&gt; 16) &amp; 0xffff)</span>
<span class="cp">#define LOGIN_ORB_RESPONSE_LENGTH(v)	(((v) &gt;&gt;  0) &amp; 0xffff)</span>

<span class="cp">#define RECONNECT_ORB_LOGIN_ID(v)	(((v) &gt;&gt;  0) &amp; 0xffff)</span>
<span class="cp">#define LOGOUT_ORB_LOGIN_ID(v)		(((v) &gt;&gt;  0) &amp; 0xffff)</span>

<span class="cp">#define CMDBLK_ORB_DIRECTION(v)		(((v) &gt;&gt; 27) &amp;   0x01)</span>
<span class="cp">#define CMDBLK_ORB_SPEED(v)		(((v) &gt;&gt; 24) &amp;   0x07)</span>
<span class="cp">#define CMDBLK_ORB_MAX_PAYLOAD(v)	(((v) &gt;&gt; 20) &amp;   0x0f)</span>
<span class="cp">#define CMDBLK_ORB_PG_TBL_PRESENT(v)	(((v) &gt;&gt; 19) &amp;   0x01)</span>
<span class="cp">#define CMDBLK_ORB_PG_SIZE(v)		(((v) &gt;&gt; 16) &amp;   0x07)</span>
<span class="cp">#define CMDBLK_ORB_DATA_SIZE(v)		(((v) &gt;&gt;  0) &amp; 0xffff)</span>

<span class="cp">#define STATUS_BLOCK_SRC(v)		(((v) &amp;   0x03) &lt;&lt; 30)</span>
<span class="cp">#define STATUS_BLOCK_RESP(v)		(((v) &amp;   0x03) &lt;&lt; 28)</span>
<span class="cp">#define STATUS_BLOCK_DEAD(v)		(((v) ? 1 : 0)  &lt;&lt; 27)</span>
<span class="cp">#define STATUS_BLOCK_LEN(v)		(((v) &amp;   0x07) &lt;&lt; 24)</span>
<span class="cp">#define STATUS_BLOCK_SBP_STATUS(v)	(((v) &amp;   0xff) &lt;&lt; 16)</span>
<span class="cp">#define STATUS_BLOCK_ORB_OFFSET_HIGH(v)	(((v) &amp; 0xffff) &lt;&lt;  0)</span>

<span class="cp">#define STATUS_SRC_ORB_CONTINUING	0</span>
<span class="cp">#define STATUS_SRC_ORB_FINISHED		1</span>
<span class="cp">#define STATUS_SRC_UNSOLICITED		2</span>

<span class="cp">#define STATUS_RESP_REQUEST_COMPLETE	0</span>
<span class="cp">#define STATUS_RESP_TRANSPORT_FAILURE	1</span>
<span class="cp">#define STATUS_RESP_ILLEGAL_REQUEST	2</span>
<span class="cp">#define STATUS_RESP_VENDOR_DEPENDENT	3</span>

<span class="cp">#define SBP_STATUS_OK			0</span>
<span class="cp">#define SBP_STATUS_REQ_TYPE_NOTSUPP	1</span>
<span class="cp">#define SBP_STATUS_SPEED_NOTSUPP	2</span>
<span class="cp">#define SBP_STATUS_PAGE_SIZE_NOTSUPP	3</span>
<span class="cp">#define SBP_STATUS_ACCESS_DENIED	4</span>
<span class="cp">#define SBP_STATUS_LUN_NOTSUPP		5</span>
<span class="cp">#define SBP_STATUS_PAYLOAD_TOO_SMALL	6</span>
<span class="cm">/* 7 is reserved */</span>
<span class="cp">#define SBP_STATUS_RESOURCES_UNAVAIL	8</span>
<span class="cp">#define SBP_STATUS_FUNCTION_REJECTED	9</span>
<span class="cp">#define SBP_STATUS_LOGIN_ID_UNKNOWN	10</span>
<span class="cp">#define SBP_STATUS_DUMMY_ORB_COMPLETE	11</span>
<span class="cp">#define SBP_STATUS_REQUEST_ABORTED	12</span>
<span class="cp">#define SBP_STATUS_UNSPECIFIED_ERROR	0xff</span>

<span class="cp">#define AGENT_STATE_RESET	0</span>
<span class="cp">#define AGENT_STATE_ACTIVE	1</span>
<span class="cp">#define AGENT_STATE_SUSPENDED	2</span>
<span class="cp">#define AGENT_STATE_DEAD	3</span>

<span class="k">struct</span> <span class="n">sbp2_pointer</span> <span class="p">{</span>
	<span class="n">__be32</span> <span class="n">high</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">low</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sbp_command_block_orb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbp2_pointer</span> <span class="n">next_orb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbp2_pointer</span> <span class="n">data_descriptor</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">misc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">command_block</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sbp_page_table_entry</span> <span class="p">{</span>
	<span class="n">__be16</span> <span class="n">segment_length</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">segment_base_hi</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">segment_base_lo</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sbp_management_orb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbp2_pointer</span> <span class="n">ptr1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbp2_pointer</span> <span class="n">ptr2</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">misc</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbp2_pointer</span> <span class="n">status_fifo</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sbp_status_block</span> <span class="p">{</span>
	<span class="n">__be32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">orb_low</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sbp_login_response_block</span> <span class="p">{</span>
	<span class="n">__be32</span> <span class="n">misc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbp2_pointer</span> <span class="n">command_block_agent</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">reconnect_hold</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sbp_login_descriptor</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbp_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">link</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">se_lun</span> <span class="o">*</span><span class="n">lun</span><span class="p">;</span>

	<span class="n">u64</span> <span class="n">status_fifo_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">exclusive</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">login_id</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sbp_target_agent</span> <span class="o">*</span><span class="n">tgt_agt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sbp_session</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">se_session</span> <span class="o">*</span><span class="n">se_sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">login_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">maint_work</span><span class="p">;</span>

	<span class="n">u64</span> <span class="n">guid</span><span class="p">;</span> <span class="cm">/* login_owner_EUI_64 */</span>
	<span class="kt">int</span> <span class="n">node_id</span><span class="p">;</span> <span class="cm">/* login_owner_ID */</span>

	<span class="k">struct</span> <span class="n">fw_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">generation</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">speed</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">reconnect_hold</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">reconnect_expires</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sbp_nacl</span> <span class="p">{</span>
	<span class="cm">/* Initiator EUI-64 */</span>
	<span class="n">u64</span> <span class="n">guid</span><span class="p">;</span>
	<span class="cm">/* ASCII formatted GUID for SBP Initiator port */</span>
	<span class="kt">char</span> <span class="n">iport_name</span><span class="p">[</span><span class="n">SBP_NAMELEN</span><span class="p">];</span>
	<span class="cm">/* Returned by sbp_make_nodeacl() */</span>
	<span class="k">struct</span> <span class="n">se_node_acl</span> <span class="n">se_node_acl</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sbp_tpg</span> <span class="p">{</span>
	<span class="cm">/* Target portal group tag for TCM */</span>
	<span class="n">u16</span> <span class="n">tport_tpgt</span><span class="p">;</span>
	<span class="cm">/* Pointer back to sbp_tport */</span>
	<span class="k">struct</span> <span class="n">sbp_tport</span> <span class="o">*</span><span class="n">tport</span><span class="p">;</span>
	<span class="cm">/* Returned by sbp_make_tpg() */</span>
	<span class="k">struct</span> <span class="n">se_portal_group</span> <span class="n">se_tpg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sbp_tport</span> <span class="p">{</span>
	<span class="cm">/* Target Unit Identifier (EUI-64) */</span>
	<span class="n">u64</span> <span class="n">guid</span><span class="p">;</span>
	<span class="cm">/* Target port name */</span>
	<span class="kt">char</span> <span class="n">tport_name</span><span class="p">[</span><span class="n">SBP_NAMELEN</span><span class="p">];</span>
	<span class="cm">/* Returned by sbp_make_tport() */</span>
	<span class="k">struct</span> <span class="n">se_wwn</span> <span class="n">tport_wwn</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sbp_tpg</span> <span class="o">*</span><span class="n">tpg</span><span class="p">;</span>

	<span class="cm">/* FireWire unit directory */</span>
	<span class="k">struct</span> <span class="n">fw_descriptor</span> <span class="n">unit_directory</span><span class="p">;</span>

	<span class="cm">/* SBP Management Agent */</span>
	<span class="k">struct</span> <span class="n">sbp_management_agent</span> <span class="o">*</span><span class="n">mgt_agt</span><span class="p">;</span>

	<span class="cm">/* Parameters */</span>
	<span class="kt">int</span> <span class="n">enable</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">directory_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mgt_orb_timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_reconnect_timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_logins_per_lun</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">sbp2_pointer_to_addr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sbp2_pointer</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">high</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">low</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffffffc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">addr_to_sbp2_pointer</span><span class="p">(</span><span class="n">u64</span> <span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sbp2_pointer</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">high</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">low</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sbp_target_agent</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_address_handler</span> <span class="n">handler</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbp_login_descriptor</span> <span class="o">*</span><span class="n">login</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">orb_pointer</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">doorbell</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sbp_target_request</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbp_login_descriptor</span> <span class="o">*</span><span class="n">login</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">orb_pointer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbp_command_block_orb</span> <span class="n">orb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbp_status_block</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">se_cmd</span> <span class="n">se_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbp_page_table_entry</span> <span class="o">*</span><span class="n">pg_tbl</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cmd_buf</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sense_buf</span><span class="p">[</span><span class="n">TRANSPORT_SENSE_BUFFER</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sbp_management_agent</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbp_tport</span> <span class="o">*</span><span class="n">tport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_address_handler</span> <span class="n">handler</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">orb_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbp_management_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sbp_management_request</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbp_management_orb</span> <span class="n">orb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbp_status_block</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">generation</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">node_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">speed</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
