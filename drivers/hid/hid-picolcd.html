<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hid › hid-picolcd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>hid-picolcd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/***************************************************************************</span>
<span class="cm"> *   Copyright (C) 2010 by Bruno Prémont &lt;bonbons@linux-vserver.org&gt;       *</span>
<span class="cm"> *                                                                         *</span>
<span class="cm"> *   Based on Logitech G13 driver (v0.4)                                   *</span>
<span class="cm"> *     Copyright (C) 2009 by Rick L. Vinyard, Jr. &lt;rvinyard@cs.nmsu.edu&gt;   *</span>
<span class="cm"> *                                                                         *</span>
<span class="cm"> *   This program is free software: you can redistribute it and/or modify  *</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by  *</span>
<span class="cm"> *   the Free Software Foundation, version 2 of the License.               *</span>
<span class="cm"> *                                                                         *</span>
<span class="cm"> *   This driver is distributed in the hope that it will be useful, but    *</span>
<span class="cm"> *   WITHOUT ANY WARRANTY; without even the implied warranty of            *</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU      *</span>
<span class="cm"> *   General Public License for more details.                              *</span>
<span class="cm"> *                                                                         *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License     *</span>
<span class="cm"> *   along with this software. If not see &lt;http://www.gnu.org/licenses/&gt;.  *</span>
<span class="cm"> ***************************************************************************/</span>

<span class="cp">#include &lt;linux/hid.h&gt;</span>
<span class="cp">#include &lt;linux/hid-debug.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &quot;hid-ids.h&quot;</span>
<span class="cp">#include &quot;usbhid/usbhid.h&quot;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>

<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/backlight.h&gt;</span>
<span class="cp">#include &lt;linux/lcd.h&gt;</span>

<span class="cp">#include &lt;linux/leds.h&gt;</span>

<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>

<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#define PICOLCD_NAME &quot;PicoLCD (graphic)&quot;</span>

<span class="cm">/* Report numbers */</span>
<span class="cp">#define REPORT_ERROR_CODE      0x10 </span><span class="cm">/* LCD: IN[16]  */</span><span class="cp"></span>
<span class="cp">#define   ERR_SUCCESS            0x00</span>
<span class="cp">#define   ERR_PARAMETER_MISSING  0x01</span>
<span class="cp">#define   ERR_DATA_MISSING       0x02</span>
<span class="cp">#define   ERR_BLOCK_READ_ONLY    0x03</span>
<span class="cp">#define   ERR_BLOCK_NOT_ERASABLE 0x04</span>
<span class="cp">#define   ERR_BLOCK_TOO_BIG      0x05</span>
<span class="cp">#define   ERR_SECTION_OVERFLOW   0x06</span>
<span class="cp">#define   ERR_INVALID_CMD_LEN    0x07</span>
<span class="cp">#define   ERR_INVALID_DATA_LEN   0x08</span>
<span class="cp">#define REPORT_KEY_STATE       0x11 </span><span class="cm">/* LCD: IN[2]   */</span><span class="cp"></span>
<span class="cp">#define REPORT_IR_DATA         0x21 </span><span class="cm">/* LCD: IN[63]  */</span><span class="cp"></span>
<span class="cp">#define REPORT_EE_DATA         0x32 </span><span class="cm">/* LCD: IN[63]  */</span><span class="cp"></span>
<span class="cp">#define REPORT_MEMORY          0x41 </span><span class="cm">/* LCD: IN[63]  */</span><span class="cp"></span>
<span class="cp">#define REPORT_LED_STATE       0x81 </span><span class="cm">/* LCD: OUT[1]  */</span><span class="cp"></span>
<span class="cp">#define REPORT_BRIGHTNESS      0x91 </span><span class="cm">/* LCD: OUT[1]  */</span><span class="cp"></span>
<span class="cp">#define REPORT_CONTRAST        0x92 </span><span class="cm">/* LCD: OUT[1]  */</span><span class="cp"></span>
<span class="cp">#define REPORT_RESET           0x93 </span><span class="cm">/* LCD: OUT[2]  */</span><span class="cp"></span>
<span class="cp">#define REPORT_LCD_CMD         0x94 </span><span class="cm">/* LCD: OUT[63] */</span><span class="cp"></span>
<span class="cp">#define REPORT_LCD_DATA        0x95 </span><span class="cm">/* LCD: OUT[63] */</span><span class="cp"></span>
<span class="cp">#define REPORT_LCD_CMD_DATA    0x96 </span><span class="cm">/* LCD: OUT[63] */</span><span class="cp"></span>
<span class="cp">#define	REPORT_EE_READ         0xa3 </span><span class="cm">/* LCD: OUT[63] */</span><span class="cp"></span>
<span class="cp">#define REPORT_EE_WRITE        0xa4 </span><span class="cm">/* LCD: OUT[63] */</span><span class="cp"></span>
<span class="cp">#define REPORT_ERASE_MEMORY    0xb2 </span><span class="cm">/* LCD: OUT[2]  */</span><span class="cp"></span>
<span class="cp">#define REPORT_READ_MEMORY     0xb3 </span><span class="cm">/* LCD: OUT[3]  */</span><span class="cp"></span>
<span class="cp">#define REPORT_WRITE_MEMORY    0xb4 </span><span class="cm">/* LCD: OUT[63] */</span><span class="cp"></span>
<span class="cp">#define REPORT_SPLASH_RESTART  0xc1 </span><span class="cm">/* LCD: OUT[1]  */</span><span class="cp"></span>
<span class="cp">#define REPORT_EXIT_KEYBOARD   0xef </span><span class="cm">/* LCD: OUT[2]  */</span><span class="cp"></span>
<span class="cp">#define REPORT_VERSION         0xf1 </span><span class="cm">/* LCD: IN[2],OUT[1]    Bootloader: IN[2],OUT[1]   */</span><span class="cp"></span>
<span class="cp">#define REPORT_BL_ERASE_MEMORY 0xf2 </span><span class="cm">/*                      Bootloader: IN[36],OUT[4]  */</span><span class="cp"></span>
<span class="cp">#define REPORT_BL_READ_MEMORY  0xf3 </span><span class="cm">/*                      Bootloader: IN[36],OUT[4]  */</span><span class="cp"></span>
<span class="cp">#define REPORT_BL_WRITE_MEMORY 0xf4 </span><span class="cm">/*                      Bootloader: IN[36],OUT[36] */</span><span class="cp"></span>
<span class="cp">#define REPORT_DEVID           0xf5 </span><span class="cm">/* LCD: IN[5], OUT[1]   Bootloader: IN[5],OUT[1]   */</span><span class="cp"></span>
<span class="cp">#define REPORT_SPLASH_SIZE     0xf6 </span><span class="cm">/* LCD: IN[4], OUT[1]   */</span><span class="cp"></span>
<span class="cp">#define REPORT_HOOK_VERSION    0xf7 </span><span class="cm">/* LCD: IN[2], OUT[1]   */</span><span class="cp"></span>
<span class="cp">#define REPORT_EXIT_FLASHER    0xff </span><span class="cm">/*                      Bootloader: OUT[2]         */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_HID_PICOLCD_FB</span>
<span class="cm">/* Framebuffer</span>
<span class="cm"> *</span>
<span class="cm"> * The PicoLCD use a Topway LCD module of 256x64 pixel</span>
<span class="cm"> * This display area is tiled over 4 controllers with 8 tiles</span>
<span class="cm"> * each. Each tile has 8x64 pixel, each data byte representing</span>
<span class="cm"> * a 1-bit wide vertical line of the tile.</span>
<span class="cm"> *</span>
<span class="cm"> * The display can be updated at a tile granularity.</span>
<span class="cm"> *</span>
<span class="cm"> *       Chip 1           Chip 2           Chip 3           Chip 4</span>
<span class="cm"> * +----------------+----------------+----------------+----------------+</span>
<span class="cm"> * |     Tile 1     |     Tile 1     |     Tile 1     |     Tile 1     |</span>
<span class="cm"> * +----------------+----------------+----------------+----------------+</span>
<span class="cm"> * |     Tile 2     |     Tile 2     |     Tile 2     |     Tile 2     |</span>
<span class="cm"> * +----------------+----------------+----------------+----------------+</span>
<span class="cm"> *                                  ...</span>
<span class="cm"> * +----------------+----------------+----------------+----------------+</span>
<span class="cm"> * |     Tile 8     |     Tile 8     |     Tile 8     |     Tile 8     |</span>
<span class="cm"> * +----------------+----------------+----------------+----------------+</span>
<span class="cm"> */</span>
<span class="cp">#define PICOLCDFB_NAME &quot;picolcdfb&quot;</span>
<span class="cp">#define PICOLCDFB_WIDTH (256)</span>
<span class="cp">#define PICOLCDFB_HEIGHT (64)</span>
<span class="cp">#define PICOLCDFB_SIZE (PICOLCDFB_WIDTH * PICOLCDFB_HEIGHT / 8)</span>

<span class="cp">#define PICOLCDFB_UPDATE_RATE_LIMIT   10</span>
<span class="cp">#define PICOLCDFB_UPDATE_RATE_DEFAULT  2</span>

<span class="cm">/* Framebuffer visual structures */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">picolcdfb_fix</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>          <span class="o">=</span> <span class="n">PICOLCDFB_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>        <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">visual</span>      <span class="o">=</span> <span class="n">FB_VISUAL_MONO01</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xpanstep</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ypanstep</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ywrapstep</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">PICOLCDFB_WIDTH</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel</span>       <span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">picolcdfb_var</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xres</span>           <span class="o">=</span> <span class="n">PICOLCDFB_WIDTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres</span>           <span class="o">=</span> <span class="n">PICOLCDFB_HEIGHT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres_virtual</span>   <span class="o">=</span> <span class="n">PICOLCDFB_WIDTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres_virtual</span>   <span class="o">=</span> <span class="n">PICOLCDFB_HEIGHT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">width</span>          <span class="o">=</span> <span class="mi">103</span><span class="p">,</span>
	<span class="p">.</span><span class="n">height</span>         <span class="o">=</span> <span class="mi">26</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">grayscale</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">red</span>            <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">green</span>          <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">blue</span>           <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">transp</span>         <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">msb_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_HID_PICOLCD_FB */</span><span class="cp"></span>

<span class="cm">/* Input device</span>
<span class="cm"> *</span>
<span class="cm"> * The PicoLCD has an IR receiver header, a built-in keypad with 5 keys</span>
<span class="cm"> * and header for 4x4 key matrix. The built-in keys are part of the matrix.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">def_keymap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* none */</span>
	<span class="n">KEY_BACK</span><span class="p">,</span>	<span class="cm">/* col 4 + row 1 */</span>
	<span class="n">KEY_HOMEPAGE</span><span class="p">,</span>	<span class="cm">/* col 3 + row 1 */</span>
	<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* col 2 + row 1 */</span>
	<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* col 1 + row 1 */</span>
	<span class="n">KEY_SCROLLUP</span><span class="p">,</span>	<span class="cm">/* col 4 + row 2 */</span>
	<span class="n">KEY_OK</span><span class="p">,</span>		<span class="cm">/* col 3 + row 2 */</span>
	<span class="n">KEY_SCROLLDOWN</span><span class="p">,</span>	<span class="cm">/* col 2 + row 2 */</span>
	<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* col 1 + row 2 */</span>
	<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* col 4 + row 3 */</span>
	<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* col 3 + row 3 */</span>
	<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* col 2 + row 3 */</span>
	<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* col 1 + row 3 */</span>
	<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* col 4 + row 4 */</span>
	<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* col 3 + row 4 */</span>
	<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* col 2 + row 4 */</span>
	<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* col 1 + row 4 */</span>
<span class="p">};</span>
<span class="cp">#define PICOLCD_KEYS ARRAY_SIZE(def_keymap)</span>

<span class="cm">/* Description of in-progress IO operation, used for operations</span>
<span class="cm"> * that trigger response from device */</span>
<span class="k">struct</span> <span class="n">picolcd_pending</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">out_report</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">in_report</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">ready</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">raw_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* Per device data structure */</span>
<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debug_reset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debug_eeprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debug_flash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex_flash</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">addr_sz</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">u8</span> <span class="n">version</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">opmode_delay</span><span class="p">;</span>
	<span class="cm">/* input stuff */</span>
	<span class="n">u8</span> <span class="n">pressed_keys</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_keys</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_cir</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">keycode</span><span class="p">[</span><span class="n">PICOLCD_KEYS</span><span class="p">];</span>

<span class="cp">#ifdef CONFIG_HID_PICOLCD_FB</span>
	<span class="cm">/* Framebuffer stuff */</span>
	<span class="n">u8</span> <span class="n">fb_update_rate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fb_bpp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fb_force</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">fb_vbitmap</span><span class="p">;</span>		<span class="cm">/* local copy of what was sent to PicoLCD */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">fb_bitmap</span><span class="p">;</span>		<span class="cm">/* framebuffer */</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_deferred_io</span> <span class="n">fb_defio</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_HID_PICOLCD_FB */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_HID_PICOLCD_LCD</span>
	<span class="k">struct</span> <span class="n">lcd_device</span> <span class="o">*</span><span class="n">lcd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lcd_contrast</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_HID_PICOLCD_LCD */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_HID_PICOLCD_BACKLIGHT</span>
	<span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">backlight</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lcd_brightness</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lcd_power</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_HID_PICOLCD_BACKLIGHT */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_HID_PICOLCD_LEDS</span>
	<span class="cm">/* LED stuff */</span>
	<span class="n">u8</span> <span class="n">led_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_HID_PICOLCD_LEDS */</span><span class="cp"></span>

	<span class="cm">/* Housekeeping stuff */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">picolcd_pending</span> <span class="o">*</span><span class="n">pending</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
<span class="cp">#define PICOLCD_BOOTLOADER 1</span>
<span class="cp">#define PICOLCD_FAILED 2</span>
<span class="cp">#define PICOLCD_READY_FB 4</span>
<span class="p">};</span>


<span class="cm">/* Find a given report */</span>
<span class="cp">#define picolcd_in_report(id, dev) picolcd_report(id, dev, HID_INPUT_REPORT)</span>
<span class="cp">#define picolcd_out_report(id, dev) picolcd_report(id, dev, HID_OUTPUT_REPORT)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="nf">picolcd_report</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">feature_report_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">report_enum</span><span class="p">[</span><span class="n">dir</span><span class="p">].</span><span class="n">report_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">feature_report_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">report</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hid_warn</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;No report with id 0x%x found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">picolcd_debug_out_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">);</span>
<span class="cp">#define usbhid_submit_report(a, b, c) \</span>
<span class="cp">	do { \</span>
<span class="cp">		picolcd_debug_out_report(hid_get_drvdata(a), a, b); \</span>
<span class="cp">		usbhid_submit_report(a, b, c); \</span>
<span class="cp">	} while (0)</span>
<span class="cp">#endif</span>

<span class="cm">/* Submit a report and wait for a reply from device - if device fades away</span>
<span class="cm"> * or does not respond in time, return NULL */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">picolcd_pending</span> <span class="o">*</span><span class="nf">picolcd_send_and_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">report_id</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">hid_get_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">picolcd_pending</span> <span class="o">*</span><span class="n">work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span> <span class="o">=</span> <span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">report_id</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">report</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PICOLCD_FAILED</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">work</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">work</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">work</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">);</span>
	<span class="n">work</span><span class="o">-&gt;</span><span class="n">out_report</span> <span class="o">=</span> <span class="n">report</span><span class="p">;</span>
	<span class="n">work</span><span class="o">-&gt;</span><span class="n">in_report</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">work</span><span class="o">-&gt;</span><span class="n">raw_size</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">report_count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">?</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">k</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="n">work</span><span class="p">;</span>
	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wait_for_completion_interruptible_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">,</span> <span class="n">HZ</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">work</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HID_PICOLCD_FB</span>
<span class="cm">/* Send a given tile to PicoLCD */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_fb_send_tile</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tile</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">hid_get_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report1</span> <span class="o">=</span> <span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_LCD_CMD_DATA</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report2</span> <span class="o">=</span> <span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_LCD_DATA</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">report1</span> <span class="o">||</span> <span class="n">report1</span><span class="o">-&gt;</span><span class="n">maxfield</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="o">!</span><span class="n">report2</span> <span class="o">||</span> <span class="n">report2</span><span class="o">-&gt;</span><span class="n">maxfield</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report1</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="mi">0</span><span class="p">,</span> <span class="n">chip</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report1</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="mi">1</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report1</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="mi">2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report1</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="mi">3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report1</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="mi">4</span><span class="p">,</span> <span class="mh">0xb8</span> <span class="o">|</span> <span class="n">tile</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report1</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="mi">5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report1</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="mi">6</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report1</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="mi">7</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report1</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="mi">8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report1</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="mi">9</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report1</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span>   <span class="mi">32</span><span class="p">);</span>

	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report2</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">chip</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report2</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="mi">1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report2</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="mi">2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report2</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="mi">3</span><span class="p">,</span>   <span class="mi">32</span><span class="p">);</span>

	<span class="n">tdata</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_vbitmap</span> <span class="o">+</span> <span class="p">(</span><span class="n">tile</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">chip</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report1</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">11</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">tdata</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report2</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">32</span><span class="p">,</span> <span class="n">tdata</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">report1</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span><span class="p">);</span>
	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">report2</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Translate a single tile*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_fb_update_tile</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">vbitmap</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tile</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tdata</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">vdata</span> <span class="o">=</span> <span class="n">vbitmap</span> <span class="o">+</span> <span class="p">(</span><span class="n">tile</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">chip</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">b</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bdata</span> <span class="o">=</span> <span class="n">bitmap</span> <span class="o">+</span> <span class="n">tile</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">chip</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">tdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bdata</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">b</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bdata</span> <span class="o">=</span> <span class="n">bitmap</span> <span class="o">+</span> <span class="p">(</span><span class="n">tile</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">chip</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="mi">32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">tdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Oops, we should never get here! */</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">vdata</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">vdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tdata</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Reconfigure LCD display */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_fb_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span> <span class="o">=</span> <span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_LCD_CMD</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">mapcmd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xc0</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">report</span> <span class="o">||</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">maxusage</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mapcmd</span><span class="p">))</span>
				<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span><span class="p">,</span> <span class="n">mapcmd</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">PICOLCD_READY_FB</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_bitmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clear</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_vbitmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PICOLCDFB_SIZE</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_bitmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PICOLCDFB_SIZE</span><span class="o">*</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_bpp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_force</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* schedule first output of framebuffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">deferred_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Update fb_vbitmap from the screen_base and send changed tiles to device */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_fb_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chip</span><span class="p">,</span> <span class="n">tile</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PICOLCD_READY_FB</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">picolcd_fb_reset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Translate the framebuffer into the format needed by the PicoLCD.</span>
<span class="cm">	 * See display layout above.</span>
<span class="cm">	 * Do this one tile after the other and push those tiles that changed.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Wait for our IO to complete as otherwise we might flood the queue!</span>
<span class="cm">	 */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chip</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">chip</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">tile</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tile</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">tile</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">picolcd_fb_update_tile</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_vbitmap</span><span class="p">,</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_bitmap</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_bpp</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">tile</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_force</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">n</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">)</span>
					<span class="k">return</span><span class="p">;</span> <span class="cm">/* device lost! */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">HID_OUTPUT_FIFO_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">usbhid_wait_io</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>
					<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">picolcd_fb_send_tile</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">tile</span><span class="p">);</span>
			<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_force</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
		<span class="n">usbhid_wait_io</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Stub to call the system default and update the image on the picoLCD */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_fb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">sys_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">rect</span><span class="p">);</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">deferred_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Stub to call the system default and update the image on the picoLCD */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_fb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">area</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">sys_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">area</span><span class="p">);</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">deferred_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Stub to call the system default and update the image on the picoLCD */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_fb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">sys_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">deferred_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * this is the slow path from userspace. they can seek and write to</span>
<span class="cm"> * the fb. it&#39;s inefficient to do anything less than a full screen draw</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">picolcd_fb_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_sys_write</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">deferred_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_fb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="cm">/* We let fb notification do this for us via lcd/backlight device */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_fb_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ref_cnt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">may_release</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fb_deferred_io_cleanup</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">ref_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">ref_cnt</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>
	<span class="n">may_release</span> <span class="o">=</span> <span class="o">!*</span><span class="n">ref_cnt</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">may_release</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">);</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_fb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">bpp</span>      <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">activate</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span><span class="p">;</span>

	<span class="cm">/* only allow 1/8 bit depth (8-bit is grayscale) */</span>
	<span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="n">picolcdfb_var</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">=</span> <span class="n">activate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>     <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>   <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>    <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tmp_fb</span><span class="p">,</span> <span class="o">*</span><span class="n">o_fb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_bpp</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* switch between 1/8 bit depths */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">o_fb</span>   <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_bitmap</span><span class="p">;</span>
	<span class="n">tmp_fb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PICOLCDFB_SIZE</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_fb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* translate FB content to new bits-per-pixel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PICOLCDFB_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">b</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">p</span> <span class="o">|=</span> <span class="n">o_fb</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="n">b</span><span class="p">]</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tmp_fb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">o_fb</span><span class="p">,</span> <span class="n">tmp_fb</span><span class="p">,</span> <span class="n">PICOLCDFB_SIZE</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_MONO01</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">PICOLCDFB_WIDTH</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp_fb</span><span class="p">,</span> <span class="n">o_fb</span><span class="p">,</span> <span class="n">PICOLCDFB_SIZE</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PICOLCDFB_SIZE</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">o_fb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_fb</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">8</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0xff</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">PICOLCDFB_WIDTH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">tmp_fb</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_bpp</span>      <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Do refcounting on our FB and cleanup per worker if FB is</span>
<span class="cm"> * closed after unplug of our device</span>
<span class="cm"> * (fb_release holds info-&gt;lock and still touches info after</span>
<span class="cm"> *  we return so we can&#39;t release it immediately.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">picolcd_fb_cleanup_item</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">picolcd_fb_cleanup_item</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">picolcd_fb_cleanup_item</span> <span class="o">*</span><span class="n">fb_pending</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">fb_pending_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_fb_do_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_fb_cleanup_item</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_pending_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">item</span> <span class="o">=</span> <span class="n">fb_pending</span><span class="p">;</span>
		<span class="n">fb_pending</span> <span class="o">=</span> <span class="n">item</span> <span class="o">?</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_pending_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">;</span>
			<span class="cm">/* make sure we do not race against fb core when</span>
<span class="cm">			 * releasing */</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">picolcd_fb_cleanup</span><span class="p">,</span> <span class="n">picolcd_fb_do_cleanup</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_fb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ref_cnt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>
	<span class="n">ref_cnt</span><span class="o">--</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">ref_cnt</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_fb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ref_cnt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>
	<span class="n">ref_cnt</span><span class="o">--</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">ref_cnt</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">ref_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">picolcd_fb_cleanup_item</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_fb_cleanup_item</span> <span class="o">*</span><span class="p">)</span><span class="n">ref_cnt</span><span class="p">;</span>
		<span class="n">item</span><span class="o">--</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_pending_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">item</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">fb_pending</span><span class="p">;</span>
		<span class="n">fb_pending</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_pending_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">picolcd_fb_cleanup</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Note this can&#39;t be const because of struct fb_info definition */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">picolcdfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>        <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_destroy</span>   <span class="o">=</span> <span class="n">picolcd_fb_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_open</span>      <span class="o">=</span> <span class="n">picolcd_fb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_release</span>   <span class="o">=</span> <span class="n">picolcd_fb_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_read</span>      <span class="o">=</span> <span class="n">fb_sys_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_write</span>     <span class="o">=</span> <span class="n">picolcd_fb_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>     <span class="o">=</span> <span class="n">picolcd_fb_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>  <span class="o">=</span> <span class="n">picolcd_fb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>  <span class="o">=</span> <span class="n">picolcd_fb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span> <span class="o">=</span> <span class="n">picolcd_fb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span> <span class="o">=</span> <span class="n">picolcd_fb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>   <span class="o">=</span> <span class="n">picolcd_set_par</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* Callback from deferred IO workqueue */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_fb_deferred_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pagelist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">picolcd_fb_update</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_deferred_io</span> <span class="n">picolcd_fb_defio</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="n">PICOLCDFB_UPDATE_RATE_DEFAULT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deferred_io</span> <span class="o">=</span> <span class="n">picolcd_fb_deferred_io</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * The &quot;fb_update_rate&quot; sysfs attribute</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">picolcd_fb_update_rate_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">fb_update_rate</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_update_rate</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">PICOLCDFB_UPDATE_RATE_LIMIT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">fb_update_rate</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">ret</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="n">ret</span><span class="p">,</span> <span class="s">&quot;[%u] &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">ret</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="n">ret</span><span class="p">,</span> <span class="s">&quot;%u &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">min</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">PAGE_SIZE</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">picolcd_fb_update_rate_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">u</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">&gt;</span> <span class="n">PICOLCDFB_UPDATE_RATE_LIMIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">u</span> <span class="o">=</span> <span class="n">PICOLCDFB_UPDATE_RATE_DEFAULT</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_update_rate</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_defio</span><span class="p">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_update_rate</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">fb_update_rate</span><span class="p">,</span> <span class="mo">0666</span><span class="p">,</span> <span class="n">picolcd_fb_update_rate_show</span><span class="p">,</span>
		<span class="n">picolcd_fb_update_rate_store</span><span class="p">);</span>

<span class="cm">/* initialize Framebuffer device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_init_framebuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">fb_vbitmap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">fb_bitmap</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">palette</span><span class="p">;</span>

	<span class="n">fb_bitmap</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">PICOLCDFB_SIZE</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_bitmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t get a free page for framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_nomem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb_vbitmap</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PICOLCDFB_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_vbitmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t alloc vbitmap image buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_nomem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_update_rate</span> <span class="o">=</span> <span class="n">PICOLCDFB_UPDATE_RATE_DEFAULT</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_defio</span> <span class="o">=</span> <span class="n">picolcd_fb_defio</span><span class="p">;</span>
	<span class="cm">/* The extra memory is:</span>
<span class="cm">	 * - struct picolcd_fb_cleanup_item</span>
<span class="cm">	 * - u32 for ref_count</span>
<span class="cm">	 * - 256*u32 for pseudo_palette</span>
<span class="cm">	 */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="mi">257</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_fb_cleanup_item</span><span class="p">),</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate a framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_nomem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">palette</span>  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_fb_cleanup_item</span><span class="p">);</span>
	<span class="o">*</span><span class="n">palette</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">palette</span><span class="o">++</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">?</span> <span class="mh">0xff</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">palette</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbdefio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_defio</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__force</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">fb_bitmap</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">picolcdfb_ops</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">=</span> <span class="n">picolcdfb_var</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span> <span class="o">=</span> <span class="n">picolcdfb_fix</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span>   <span class="o">=</span> <span class="n">PICOLCDFB_SIZE</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fb_bitmap</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_FLAG_DEFAULT</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_vbitmap</span> <span class="o">=</span> <span class="n">fb_vbitmap</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_bitmap</span>  <span class="o">=</span> <span class="n">fb_bitmap</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_bpp</span>     <span class="o">=</span> <span class="n">picolcdfb_var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">picolcd_fb_reset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to configure display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_fb_update_rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create sysfs attributes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fb_deferred_io_init</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_info</span>    <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_sysfs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* schedule first output of framebuffer */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_force</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">deferred_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_sysfs:</span>
	<span class="n">fb_deferred_io_cleanup</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_fb_update_rate</span><span class="p">);</span>
<span class="nl">err_cleanup:</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_vbitmap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_bitmap</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_bpp</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_info</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">err_nomem:</span>
	<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">fb_bitmap</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fb_vbitmap</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_exit_framebuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">fb_vbitmap</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_vbitmap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_fb_update_rate</span><span class="p">);</span>
	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_vbitmap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_bitmap</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_bpp</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_info</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fb_vbitmap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define picolcd_fbinfo(d) ((d)-&gt;fb_info)</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">picolcd_fb_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">picolcd_init_framebuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">picolcd_exit_framebuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#define picolcd_fbinfo(d) NULL</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_HID_PICOLCD_FB */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_HID_PICOLCD_BACKLIGHT</span>
<span class="cm">/*</span>
<span class="cm"> * backlight class device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_get_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">bl_get_data</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_brightness</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_set_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">bl_get_data</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span> <span class="o">=</span> <span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_BRIGHTNESS</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">report</span> <span class="o">||</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">report_count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_brightness</span> <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span> <span class="o">&amp;</span> <span class="mh">0x0ff</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_power</span>      <span class="o">=</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_power</span> <span class="o">==</span> <span class="n">FB_BLANK_UNBLANK</span> <span class="o">?</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_brightness</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_check_bl_fb</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fb</span> <span class="o">&amp;&amp;</span> <span class="n">fb</span> <span class="o">==</span> <span class="n">picolcd_fbinfo</span><span class="p">((</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="p">)</span><span class="n">bl_get_data</span><span class="p">(</span><span class="n">bdev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">backlight_ops</span> <span class="n">picolcd_blops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">update_status</span>  <span class="o">=</span> <span class="n">picolcd_set_brightness</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_brightness</span> <span class="o">=</span> <span class="n">picolcd_get_brightness</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_fb</span>       <span class="o">=</span> <span class="n">picolcd_check_bl_fb</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_init_backlight</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">backlight_properties</span> <span class="n">props</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">report</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">report_count</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span>
			<span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">report_size</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unsupported BRIGHTNESS report&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">props</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">props</span><span class="p">));</span>
	<span class="n">props</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BACKLIGHT_RAW</span><span class="p">;</span>
	<span class="n">props</span><span class="p">.</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">bdev</span> <span class="o">=</span> <span class="n">backlight_device_register</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">picolcd_blops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">props</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register backlight</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bdev</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span>     <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_brightness</span>       <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">backlight</span>            <span class="o">=</span> <span class="n">bdev</span><span class="p">;</span>
	<span class="n">picolcd_set_brightness</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_exit_backlight</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bdev</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">backlight</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">backlight</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="p">)</span>
		<span class="n">backlight_device_unregister</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">picolcd_resume_backlight</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">backlight</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">picolcd_set_brightness</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">backlight</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_suspend_backlight</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bl_power</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_power</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">backlight</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">backlight</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">FB_BLANK_POWERDOWN</span><span class="p">;</span>
	<span class="n">picolcd_set_brightness</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">backlight</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_power</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">backlight</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">bl_power</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">picolcd_init_backlight</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">picolcd_exit_backlight</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">picolcd_resume_backlight</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">picolcd_suspend_backlight</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_HID_PICOLCD_BACKLIGHT */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_HID_PICOLCD_LCD</span>
<span class="cm">/*</span>
<span class="cm"> * lcd class device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_get_contrast</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcd_device</span> <span class="o">*</span><span class="n">ldev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lcd_get_data</span><span class="p">(</span><span class="n">ldev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_contrast</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_set_contrast</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcd_device</span> <span class="o">*</span><span class="n">ldev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">contrast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">lcd_get_data</span><span class="p">(</span><span class="n">ldev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span> <span class="o">=</span> <span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_CONTRAST</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">report</span> <span class="o">||</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">report_count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_contrast</span> <span class="o">=</span> <span class="n">contrast</span> <span class="o">&amp;</span> <span class="mh">0x0ff</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_contrast</span><span class="p">);</span>
	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_check_lcd_fb</span><span class="p">(</span><span class="k">struct</span> <span class="n">lcd_device</span> <span class="o">*</span><span class="n">ldev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fb</span> <span class="o">&amp;&amp;</span> <span class="n">fb</span> <span class="o">==</span> <span class="n">picolcd_fbinfo</span><span class="p">((</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="p">)</span><span class="n">lcd_get_data</span><span class="p">(</span><span class="n">ldev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">lcd_ops</span> <span class="n">picolcd_lcdops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_contrast</span>   <span class="o">=</span> <span class="n">picolcd_get_contrast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_contrast</span>   <span class="o">=</span> <span class="n">picolcd_set_contrast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_fb</span>       <span class="o">=</span> <span class="n">picolcd_check_lcd_fb</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_init_lcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcd_device</span> <span class="o">*</span><span class="n">ldev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">report</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">report_count</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span>
			<span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">report_size</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unsupported CONTRAST report&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ldev</span> <span class="o">=</span> <span class="n">lcd_device_register</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">picolcd_lcdops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ldev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register LCD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ldev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ldev</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">max_contrast</span> <span class="o">=</span> <span class="mh">0x0ff</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_contrast</span> <span class="o">=</span> <span class="mh">0xe5</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd</span> <span class="o">=</span> <span class="n">ldev</span><span class="p">;</span>
	<span class="n">picolcd_set_contrast</span><span class="p">(</span><span class="n">ldev</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_exit_lcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lcd_device</span> <span class="o">*</span><span class="n">ldev</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ldev</span><span class="p">)</span>
		<span class="n">lcd_device_unregister</span><span class="p">(</span><span class="n">ldev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">picolcd_resume_lcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">picolcd_set_contrast</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">lcd_contrast</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">picolcd_init_lcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">picolcd_exit_lcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">picolcd_resume_lcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_HID_PICOLCD_LCD */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_HID_PICOLCD_LEDS</span>
<span class="cm">/**</span>
<span class="cm"> * LED class device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_leds_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">report</span> <span class="o">=</span> <span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_LED_STATE</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">report</span> <span class="o">||</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">report_count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">);</span>
	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_led_set_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span>  <span class="o">=</span> <span class="n">led_cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">hdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hid_get_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">led_cdev</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">LED_OFF</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">picolcd_leds_set</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">LED_OFF</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">picolcd_leds_set</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">led_brightness</span> <span class="nf">picolcd_led_get_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span>  <span class="o">=</span> <span class="n">led_cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">hdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hid_get_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">led_cdev</span> <span class="o">==</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="n">value</span> <span class="o">?</span> <span class="n">LED_FULL</span> <span class="o">:</span> <span class="n">LED_OFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_init_leds</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">name_sz</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">report</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">report_count</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span>
			<span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">report_size</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unsupported LED_STATE report&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span><span class="p">)</span><span class="o">+</span><span class="n">name_sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">led</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate memory for LED %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name_sz</span><span class="p">,</span> <span class="s">&quot;%s::GPO%d&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">brightness_get</span> <span class="o">=</span> <span class="n">picolcd_led_get_brightness</span><span class="p">;</span>
		<span class="n">led</span><span class="o">-&gt;</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">picolcd_led_set_brightness</span><span class="p">;</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">led</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t register LED %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">led</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_exit_leds</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">led</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">picolcd_init_leds</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">picolcd_exit_leds</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">picolcd_leds_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_HID_PICOLCD_LEDS */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * input class device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_raw_keypad</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Keypad event</span>
<span class="cm">	 * First and second data bytes list currently pressed keys,</span>
<span class="cm">	 * 0x00 means no key and at most 2 keys may be pressed at same time</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="cm">/* determine newly pressed keys */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key_code</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pressed_keys</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pressed_keys</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">goto</span> <span class="n">key_already_down</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pressed_keys</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pressed_keys</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">pressed_keys</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="n">input_event</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">input_keys</span><span class="p">,</span> <span class="n">EV_MSC</span><span class="p">,</span> <span class="n">MSC_SCAN</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">PICOLCD_KEYS</span><span class="p">)</span>
			<span class="n">key_code</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">raw_data</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
		<span class="k">else</span>
			<span class="n">key_code</span> <span class="o">=</span> <span class="n">KEY_UNKNOWN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key_code</span> <span class="o">!=</span> <span class="n">KEY_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg_hid</span><span class="p">(</span><span class="n">PICOLCD_NAME</span> <span class="s">&quot; got key press for %u:%d&quot;</span><span class="p">,</span>
					<span class="n">raw_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">key_code</span><span class="p">);</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">input_keys</span><span class="p">,</span> <span class="n">key_code</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">input_keys</span><span class="p">);</span>
<span class="nl">key_already_down:</span>
		<span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* determine newly released keys */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pressed_keys</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key_code</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pressed_keys</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pressed_keys</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">goto</span> <span class="n">key_still_down</span><span class="p">;</span>
		<span class="n">input_event</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">input_keys</span><span class="p">,</span> <span class="n">EV_MSC</span><span class="p">,</span> <span class="n">MSC_SCAN</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pressed_keys</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pressed_keys</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">PICOLCD_KEYS</span><span class="p">)</span>
			<span class="n">key_code</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pressed_keys</span><span class="p">[</span><span class="n">j</span><span class="p">]];</span>
		<span class="k">else</span>
			<span class="n">key_code</span> <span class="o">=</span> <span class="n">KEY_UNKNOWN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key_code</span> <span class="o">!=</span> <span class="n">KEY_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg_hid</span><span class="p">(</span><span class="n">PICOLCD_NAME</span> <span class="s">&quot; got key release for %u:%d&quot;</span><span class="p">,</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">pressed_keys</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">key_code</span><span class="p">);</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">input_keys</span><span class="p">,</span> <span class="n">key_code</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">input_keys</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pressed_keys</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">key_still_down:</span>
		<span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_raw_cir</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Need understanding of CIR data format to implement ... */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_check_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">hid_get_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">picolcd_pending</span> <span class="o">*</span><span class="n">verinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">verinfo</span> <span class="o">=</span> <span class="n">picolcd_send_and_wait</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">REPORT_VERSION</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">verinfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;no version response from PicoLCD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">verinfo</span><span class="o">-&gt;</span><span class="n">raw_size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">verinfo</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">verinfo</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PICOLCD_BOOTLOADER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hid_info</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;PicoLCD, bootloader version %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">verinfo</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">verinfo</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hid_info</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;PicoLCD, firmware version %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">verinfo</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">verinfo</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;confused, got unexpected version response from PicoLCD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">verinfo</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset our device and wait for answer to VERSION request</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">hid_get_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span> <span class="o">=</span> <span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_RESET</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span> <span class="o">||</span> <span class="o">!</span><span class="n">report</span> <span class="o">||</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">==</span> <span class="n">USB_DEVICE_ID_PICOLCD_BOOTLOADER</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">PICOLCD_BOOTLOADER</span><span class="p">;</span>

	<span class="cm">/* perform the reset */</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">picolcd_check_version</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">picolcd_resume_lcd</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">picolcd_resume_backlight</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_HID_PICOLCD_FB</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">deferred_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_HID_PICOLCD_FB */</span><span class="cp"></span>

	<span class="n">picolcd_leds_set</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The &quot;operation_mode&quot; sysfs attribute</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">picolcd_operation_mode_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PICOLCD_BOOTLOADER</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;[bootloader] lcd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;bootloader [lcd]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">picolcd_operation_mode_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">opmode_delay</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;lcd&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PICOLCD_BOOTLOADER</span><span class="p">)</span>
			<span class="n">report</span> <span class="o">=</span> <span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_EXIT_FLASHER</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">cnt</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;bootloader&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PICOLCD_BOOTLOADER</span><span class="p">))</span>
			<span class="n">report</span> <span class="o">=</span> <span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_EXIT_KEYBOARD</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">cnt</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">report</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">))</span>
		<span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">hid_set_field</span><span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">USB_DIR_OUT</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">operation_mode</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">picolcd_operation_mode_show</span><span class="p">,</span>
		<span class="n">picolcd_operation_mode_store</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The &quot;operation_mode_delay&quot; sysfs attribute</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">picolcd_operation_mode_delay_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">opmode_delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">picolcd_operation_mode_delay_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">u</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">&gt;</span> <span class="mi">30000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">opmode_delay</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">operation_mode_delay</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">picolcd_operation_mode_delay_show</span><span class="p">,</span>
		<span class="n">picolcd_operation_mode_delay_store</span><span class="p">);</span>


<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="cm">/*</span>
<span class="cm"> * The &quot;reset&quot; file</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_debug_reset_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">picolcd_fbinfo</span><span class="p">((</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="p">)</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">))</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;all fb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;all</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_debug_reset_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">picolcd_debug_reset_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">picolcd_debug_reset_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="p">)</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">user_buf</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span>
		<span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;all&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">picolcd_reset</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>
		<span class="n">picolcd_fb_reset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;fb&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">picolcd_fb_reset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">picolcd_debug_reset_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>    <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>     <span class="o">=</span> <span class="n">picolcd_debug_reset_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>     <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>   <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>    <span class="o">=</span> <span class="n">picolcd_debug_reset_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>  <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The &quot;eeprom&quot; file</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">picolcd_debug_eeprom_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">u</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">s</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">picolcd_pending</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&gt;</span> <span class="mh">0x0ff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* prepare buffer with info about what we want to read (addr &amp; len) */</span>
	<span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">?</span> <span class="n">s</span> <span class="o">:</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">+</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x100</span> <span class="o">-</span> <span class="o">*</span><span class="n">off</span><span class="p">;</span>
	<span class="n">resp</span> <span class="o">=</span> <span class="n">picolcd_send_and_wait</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">REPORT_EE_READ</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">raw_data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">in_report</span> <span class="o">&amp;&amp;</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">in_report</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">REPORT_EE_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* successful read :) */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">s</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">ret</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">off</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* anything else is some kind of IO error */</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">resp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">picolcd_debug_eeprom_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">u</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">s</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">picolcd_pending</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">23</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&gt;</span> <span class="mh">0x0ff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">raw_data</span><span class="p">));</span>
	<span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span><span class="mi">20</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">+</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x100</span> <span class="o">-</span> <span class="o">*</span><span class="n">off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">raw_data</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">min</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="mi">20</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">resp</span> <span class="o">=</span> <span class="n">picolcd_send_and_wait</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">REPORT_EE_WRITE</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">raw_data</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">in_report</span> <span class="o">&amp;&amp;</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">in_report</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">REPORT_EE_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check if written data matches */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="p">,</span> <span class="mi">3</span><span class="o">+</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">off</span> <span class="o">+=</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">resp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Notes:</span>
<span class="cm"> * - read/write happens in chunks of at most 20 bytes, it&#39;s up to userspace</span>
<span class="cm"> *   to loop in order to get more data.</span>
<span class="cm"> * - on write errors on otherwise correct write request the bytes</span>
<span class="cm"> *   that should have been written are in undefined state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">picolcd_debug_eeprom_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>    <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>     <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>     <span class="o">=</span> <span class="n">picolcd_debug_eeprom_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>    <span class="o">=</span> <span class="n">picolcd_debug_eeprom_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>   <span class="o">=</span> <span class="n">generic_file_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The &quot;flash&quot; file</span>
<span class="cm"> */</span>
<span class="cm">/* record a flash address to buf (bounds check to be done by caller) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">_picolcd_flash_setaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">long</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr_sz</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">addr_sz</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* read a given size of data (bounds check to be done by caller) */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">_picolcd_flash_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">report_id</span><span class="p">,</span>
		<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">u</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">s</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_pending</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len_off</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">len_off</span> <span class="o">=</span> <span class="n">_picolcd_flash_setaddr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="o">*</span><span class="n">off</span><span class="p">);</span>
		<span class="n">raw_data</span><span class="p">[</span><span class="n">len_off</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">32</span> <span class="o">?</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">s</span><span class="p">;</span>
		<span class="n">resp</span> <span class="o">=</span> <span class="n">picolcd_send_and_wait</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">report_id</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">len_off</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resp</span> <span class="o">||</span> <span class="o">!</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">in_report</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">in_report</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">REPORT_MEMORY</span> <span class="o">||</span>
			<span class="n">resp</span><span class="o">-&gt;</span><span class="n">in_report</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">REPORT_BL_READ_MEMORY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">len_off</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">u</span><span class="o">+</span><span class="n">ret</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="o">+</span><span class="n">len_off</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">len_off</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">off</span> <span class="o">+=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">len_off</span><span class="p">];</span>
			<span class="n">s</span>    <span class="o">-=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">len_off</span><span class="p">];</span>
			<span class="n">ret</span>  <span class="o">+=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">len_off</span><span class="p">];</span>
			<span class="n">err</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="nl">skip:</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">resp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">picolcd_debug_flash_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">u</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">s</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&gt;</span> <span class="mh">0x05fff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">+</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mh">0x05fff</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="mh">0x06000</span> <span class="o">-</span> <span class="o">*</span><span class="n">off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PICOLCD_BOOTLOADER</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">_picolcd_flash_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">REPORT_BL_READ_MEMORY</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">_picolcd_flash_read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">REPORT_READ_MEMORY</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* erase block aligned to 64bytes boundary */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">_picolcd_flash_erase64</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">report_id</span><span class="p">,</span>
		<span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_pending</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len_off</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">len_off</span> <span class="o">=</span> <span class="n">_picolcd_flash_setaddr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="o">*</span><span class="n">off</span><span class="p">);</span>
	<span class="n">resp</span> <span class="o">=</span> <span class="n">picolcd_send_and_wait</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">report_id</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">len_off</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resp</span> <span class="o">||</span> <span class="o">!</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">in_report</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">in_report</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">REPORT_MEMORY</span> <span class="o">||</span>
		<span class="n">resp</span><span class="o">-&gt;</span><span class="n">in_report</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">REPORT_BL_ERASE_MEMORY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">len_off</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">skip:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">resp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* write a given size of data (bounds check to be done by caller) */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">_picolcd_flash_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">report_id</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">u</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">s</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_pending</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">36</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len_off</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">len_off</span> <span class="o">=</span> <span class="n">_picolcd_flash_setaddr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="o">*</span><span class="n">off</span><span class="p">);</span>
		<span class="n">raw_data</span><span class="p">[</span><span class="n">len_off</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">32</span> <span class="o">?</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">s</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">raw_data</span><span class="o">+</span><span class="n">len_off</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">len_off</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">resp</span> <span class="o">=</span> <span class="n">picolcd_send_and_wait</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">,</span> <span class="n">report_id</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span>
				<span class="n">len_off</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">raw_data</span><span class="p">[</span><span class="n">len_off</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resp</span> <span class="o">||</span> <span class="o">!</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">in_report</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">in_report</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">REPORT_MEMORY</span> <span class="o">||</span>
			<span class="n">resp</span><span class="o">-&gt;</span><span class="n">in_report</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">REPORT_BL_WRITE_MEMORY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">len_off</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">raw_data</span><span class="p">[</span><span class="n">len_off</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>
			<span class="o">*</span><span class="n">off</span> <span class="o">+=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">len_off</span><span class="p">];</span>
			<span class="n">s</span>    <span class="o">-=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">len_off</span><span class="p">];</span>
			<span class="n">ret</span>  <span class="o">+=</span> <span class="n">raw_data</span><span class="p">[</span><span class="n">len_off</span><span class="p">];</span>
			<span class="n">err</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="nl">skip:</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">resp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">picolcd_debug_flash_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">u</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">s</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">err</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">report_erase</span><span class="p">,</span> <span class="n">report_write</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&gt;</span> <span class="mh">0x5fff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">off</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PICOLCD_BOOTLOADER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">report_erase</span> <span class="o">=</span> <span class="n">REPORT_BL_ERASE_MEMORY</span><span class="p">;</span>
		<span class="n">report_write</span> <span class="o">=</span> <span class="n">REPORT_BL_WRITE_MEMORY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">report_erase</span> <span class="o">=</span> <span class="n">REPORT_ERASE_MEMORY</span><span class="p">;</span>
		<span class="n">report_write</span> <span class="o">=</span> <span class="n">REPORT_WRITE_MEMORY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mutex_flash</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">_picolcd_flash_erase64</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">report_erase</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">_picolcd_flash_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">report_write</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">err</span><span class="p">;</span>
		<span class="o">*</span><span class="n">off</span> <span class="o">+=</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">-=</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">64</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mutex_flash</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Notes:</span>
<span class="cm"> * - concurrent writing is prevented by mutex and all writes must be</span>
<span class="cm"> *   n*64 bytes and 64-byte aligned, each write being preceded by an</span>
<span class="cm"> *   ERASE which erases a 64byte block.</span>
<span class="cm"> *   If less than requested was written or an error is returned for an</span>
<span class="cm"> *   otherwise correct write request the next 64-byte block which should</span>
<span class="cm"> *   have been written is in undefined state (mostly: original, erased,</span>
<span class="cm"> *   (half-)written with write error)</span>
<span class="cm"> * - reading can happen without special restriction</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">picolcd_debug_flash_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>    <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>     <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>     <span class="o">=</span> <span class="n">picolcd_debug_flash_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>    <span class="o">=</span> <span class="n">picolcd_debug_flash_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>   <span class="o">=</span> <span class="n">generic_file_llseek</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Helper code for HID report level dumping/debugging</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">error_codes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;success&quot;</span><span class="p">,</span> <span class="s">&quot;parameter missing&quot;</span><span class="p">,</span> <span class="s">&quot;data_missing&quot;</span><span class="p">,</span> <span class="s">&quot;block readonly&quot;</span><span class="p">,</span>
	<span class="s">&quot;block not erasable&quot;</span><span class="p">,</span> <span class="s">&quot;block too big&quot;</span><span class="p">,</span> <span class="s">&quot;section overflow&quot;</span><span class="p">,</span>
	<span class="s">&quot;invalid command length&quot;</span><span class="p">,</span> <span class="s">&quot;invalid data length&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_buff_as_hex</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">dst_sz</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">size_t</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">&lt;</span> <span class="n">dst_sz</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">];</span>
		<span class="n">dst</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">];</span>
		<span class="n">dst</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">dst_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span><span class="p">[</span><span class="n">j</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">dst</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dst</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_debug_out_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">70</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">raw_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">;</span>
<span class="cp">#define BUFF_SZ 256</span>

	<span class="cm">/* Avoid unnecessary overhead if debugfs is disabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">debug_events</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">buff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">BUFF_SZ</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buff</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">out report %d (size %d) =  &quot;</span><span class="p">,</span>
			<span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="p">);</span>
	<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raw_size</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">raw_data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot; TOO BIG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">raw_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">hid_output_report</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">);</span>
		<span class="n">dump_buff_as_hex</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">raw_size</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">REPORT_LED_STATE</span>:
		<span class="cm">/* 1 data byte with GPO state */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_LED_STATE&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">GPO state: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_BRIGHTNESS</span>:
		<span class="cm">/* 1 data byte with brightness */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_BRIGHTNESS&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Brightness: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_CONTRAST</span>:
		<span class="cm">/* 1 data byte with contrast */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_CONTRAST&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Contrast: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_RESET</span>:
		<span class="cm">/* 2 data bytes with reset duration in ms */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_RESET&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Duration: 0x%02x%02x (%dms)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_LCD_CMD</span>:
		<span class="cm">/* 63 data bytes with LCD commands */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_LCD_CMD&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="cm">/* TODO: format decoding */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_LCD_DATA</span>:
		<span class="cm">/* 63 data bytes with LCD data */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_LCD_CMD&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* TODO: format decoding */</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_LCD_CMD_DATA</span>:
		<span class="cm">/* 63 data bytes with LCD commands and data */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_LCD_CMD&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* TODO: format decoding */</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_EE_READ</span>:
		<span class="cm">/* 3 data bytes with read area description */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_EE_READ&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data address: 0x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_EE_WRITE</span>:
		<span class="cm">/* 3+1..20 data bytes with write area description */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_EE_WRITE&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data address: 0x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">No data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">raw_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data: &quot;</span><span class="p">);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
			<span class="n">dump_buff_as_hex</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data overflowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_ERASE_MEMORY</span>:
	<span class="k">case</span> <span class="n">REPORT_BL_ERASE_MEMORY</span>:
		<span class="cm">/* 3 data bytes with pointer inside erase block */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_ERASE_MEMORY&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Address inside 64 byte block: 0x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Address inside 64 byte block: 0x%02x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_READ_MEMORY</span>:
	<span class="k">case</span> <span class="n">REPORT_BL_READ_MEMORY</span>:
		<span class="cm">/* 4 data bytes with read area description */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_READ_MEMORY&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data address: 0x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data address: 0x%02x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_WRITE_MEMORY</span>:
	<span class="k">case</span> <span class="n">REPORT_BL_WRITE_MEMORY</span>:
		<span class="cm">/* 4+1..32 data bytes with write adrea description */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_WRITE_MEMORY&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data address: 0x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">No data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">raw_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data: &quot;</span><span class="p">);</span>
				<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
				<span class="n">dump_buff_as_hex</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data overflowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data address: 0x%02x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">No data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">&lt;=</span> <span class="n">raw_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data: &quot;</span><span class="p">);</span>
				<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
				<span class="n">dump_buff_as_hex</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data overflowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_SPLASH_RESTART</span>:
		<span class="cm">/* TODO */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_EXIT_KEYBOARD</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_EXIT_KEYBOARD&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Restart delay: %dms (0x%02x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
				<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_VERSION</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_VERSION&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_DEVID</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_DEVID&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_SPLASH_SIZE</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_SPLASH_SIZE&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_HOOK_VERSION</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_HOOK_VERSION&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_EXIT_FLASHER</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_VERSION&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Restart delay: %dms (0x%02x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
				<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;out report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">raw_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">debug_wait</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_debug_raw_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">;</span>

<span class="cp">#define BUFF_SZ 256</span>
	<span class="cm">/* Avoid unnecessary overhead if debugfs is disabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">debug_events</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">buff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">BUFF_SZ</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buff</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">REPORT_ERROR_CODE</span>:
		<span class="cm">/* 2 data bytes with affected report and error code */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_ERROR_CODE&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">error_codes</span><span class="p">))</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Error code 0x%02x (%s) in reply to report 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">error_codes</span><span class="p">[</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Error code 0x%02x in reply to report 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_KEY_STATE</span>:
		<span class="cm">/* 2 data bytes with key state */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_KEY_STATE&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">No key pressed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">One key pressed: 0x%02x (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Two keys pressed: 0x%02x (%d), 0x%02x (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_IR_DATA</span>:
		<span class="cm">/* Up to 20 byes of IR scancode data */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_IR_DATA&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Unexpectedly 0 data length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data length: %d</span><span class="se">\n\t</span><span class="s">IR Data: &quot;</span><span class="p">,</span>
					<span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
			<span class="n">dump_buff_as_hex</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Overflowing data length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_EE_DATA</span>:
		<span class="cm">/* Data buffer in response to REPORT_EE_READ or REPORT_EE_WRITE */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_EE_DATA&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data address: 0x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">No data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data: &quot;</span><span class="p">);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
			<span class="n">dump_buff_as_hex</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data overflowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_MEMORY</span>:
		<span class="cm">/* Data buffer in response to REPORT_READ_MEMORY or REPORT_WRTIE_MEMORY */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_MEMORY&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data address: 0x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">No data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data: &quot;</span><span class="p">);</span>
				<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
				<span class="n">dump_buff_as_hex</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data overflowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data address: 0x%02x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">No data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data: &quot;</span><span class="p">);</span>
				<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
				<span class="n">dump_buff_as_hex</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data overflowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_VERSION</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_VERSION&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Firmware version: %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_BL_ERASE_MEMORY</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_BL_ERASE_MEMORY&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="cm">/* TODO */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_BL_READ_MEMORY</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_BL_READ_MEMORY&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="cm">/* TODO */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_BL_WRITE_MEMORY</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_BL_WRITE_MEMORY&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="cm">/* TODO */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_DEVID</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_DEVID&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Serial: 0x%02x%02x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Type: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">raw_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_SPLASH_SIZE</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_SPLASH_SIZE&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Total splash space: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Used splash space: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_HOOK_VERSION</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;REPORT_HOOK_VERSION&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Firmware version: %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">raw_data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">raw_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="n">BUFF_SZ</span><span class="p">,</span> <span class="s">&quot;report %s (%d, size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hid_debug_event</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">debug_wait</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_init_devfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">eeprom_r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">eeprom_w</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">flash_r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">flash_w</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mutex_flash</span><span class="p">);</span>

	<span class="cm">/* reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">debug_reset</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;reset&quot;</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span>
				<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">debug_dir</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">picolcd_debug_reset_fops</span><span class="p">);</span>

	<span class="cm">/* eeprom */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom_r</span> <span class="o">||</span> <span class="n">eeprom_w</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">debug_eeprom</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;eeprom&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">eeprom_w</span> <span class="o">?</span> <span class="n">S_IWUSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">eeprom_r</span> <span class="o">?</span> <span class="n">S_IRUSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">debug_dir</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">picolcd_debug_eeprom_fops</span><span class="p">);</span>

	<span class="cm">/* flash */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flash_r</span> <span class="o">&amp;&amp;</span> <span class="n">flash_r</span><span class="o">-&gt;</span><span class="n">maxfield</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">flash_r</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">report_size</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">addr_sz</span> <span class="o">=</span> <span class="n">flash_r</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">report_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">addr_sz</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">addr_sz</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">addr_sz</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">debug_flash</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;flash&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">flash_w</span> <span class="o">?</span> <span class="n">S_IWUSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">flash_r</span> <span class="o">?</span> <span class="n">S_IRUSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">debug_dir</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">picolcd_debug_flash_fops</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flash_r</span> <span class="o">||</span> <span class="n">flash_w</span><span class="p">)</span>
		<span class="n">hid_warn</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;Unexpected FLASH access reports, please submit rdesc for review</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_exit_devfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dent</span><span class="p">;</span>

	<span class="n">dent</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">debug_reset</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">debug_reset</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dent</span><span class="p">)</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">dent</span><span class="p">);</span>
	<span class="n">dent</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">debug_eeprom</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">debug_eeprom</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dent</span><span class="p">)</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">dent</span><span class="p">);</span>
	<span class="n">dent</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">debug_flash</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">debug_flash</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dent</span><span class="p">)</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">dent</span><span class="p">);</span>
	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mutex_flash</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">picolcd_debug_raw_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">picolcd_init_devfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">eeprom_r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">eeprom_w</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">flash_r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">flash_w</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">reset</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">picolcd_exit_devfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_DEBUG_FS */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Handle raw report as sent by device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_raw_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">raw_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">hid_get_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">REPORT_KEY_STATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">input_keys</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">picolcd_raw_keypad</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">REPORT_IR_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">input_cir</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">picolcd_raw_cir</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * We let the caller of picolcd_send_and_wait() check if the</span>
<span class="cm">		 * report we got is one of the expected ones or not.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pending</span><span class="o">-&gt;</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pending</span><span class="o">-&gt;</span><span class="n">raw_size</span>  <span class="o">=</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pending</span><span class="o">-&gt;</span><span class="n">in_report</span> <span class="o">=</span> <span class="n">report</span><span class="p">;</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pending</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">picolcd_debug_raw_event</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hdev</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PMSG_IS_AUTO</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">picolcd_suspend_backlight</span><span class="p">(</span><span class="n">hid_get_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">));</span>
	<span class="n">dbg_hid</span><span class="p">(</span><span class="n">PICOLCD_NAME</span> <span class="s">&quot; device ready for suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">picolcd_resume_backlight</span><span class="p">(</span><span class="n">hid_get_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dbg_hid</span><span class="p">(</span><span class="n">PICOLCD_NAME</span> <span class="s">&quot; restoring backlight failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_reset_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">picolcd_reset</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dbg_hid</span><span class="p">(</span><span class="n">PICOLCD_NAME</span> <span class="s">&quot; resetting our device failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">picolcd_fb_reset</span><span class="p">(</span><span class="n">hid_get_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dbg_hid</span><span class="p">(</span><span class="n">PICOLCD_NAME</span> <span class="s">&quot; restoring framebuffer content failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">picolcd_resume_lcd</span><span class="p">(</span><span class="n">hid_get_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dbg_hid</span><span class="p">(</span><span class="n">PICOLCD_NAME</span> <span class="s">&quot; restoring lcd failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">picolcd_resume_backlight</span><span class="p">(</span><span class="n">hid_get_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dbg_hid</span><span class="p">(</span><span class="n">PICOLCD_NAME</span> <span class="s">&quot; restoring backlight failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">picolcd_leds_set</span><span class="p">(</span><span class="n">hid_get_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* initialize keypad input device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_init_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">report</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">report_count</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">||</span>
			<span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">report_size</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;unsupported KEY_STATE report</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">idev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;failed to allocate input device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">hdev</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">,</span> <span class="n">def_keymap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">def_keymap</span><span class="p">));</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">uniq</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">uniq</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span>  <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">keycode</span>     <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">keycodemax</span>  <span class="o">=</span> <span class="n">PICOLCD_KEYS</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">keycodesize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">input_set_capability</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">EV_MSC</span><span class="p">,</span> <span class="n">MSC_SCAN</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">EV_REP</span><span class="p">,</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PICOLCD_KEYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">input_set_capability</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;error registering the input device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">input_free_device</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">input_keys</span> <span class="o">=</span> <span class="n">idev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_exit_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">input_keys</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">input_keys</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="p">)</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* initialize CIR input device */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">picolcd_init_cir</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* support not implemented yet */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">picolcd_exit_cir</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_probe_lcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">picolcd_check_version</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">hid_info</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;Device with untested firmware revision, please submit /sys/kernel/debug/hid/%s/rdesc for this device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="cm">/* Setup keypad input device */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">picolcd_init_keys</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">picolcd_in_report</span><span class="p">(</span><span class="n">REPORT_KEY_STATE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Setup CIR input device */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">picolcd_init_cir</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">picolcd_in_report</span><span class="p">(</span><span class="n">REPORT_IR_DATA</span><span class="p">,</span> <span class="n">hdev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Set up the framebuffer device */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">picolcd_init_framebuffer</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Setup lcd class device */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">picolcd_init_lcd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_CONTRAST</span><span class="p">,</span> <span class="n">hdev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Setup backlight class device */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">picolcd_init_backlight</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_BRIGHTNESS</span><span class="p">,</span> <span class="n">hdev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Setup the LED class devices */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">picolcd_init_leds</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_LED_STATE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">picolcd_init_devfs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_EE_READ</span><span class="p">,</span> <span class="n">hdev</span><span class="p">),</span>
			<span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_EE_WRITE</span><span class="p">,</span> <span class="n">hdev</span><span class="p">),</span>
			<span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_READ_MEMORY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">),</span>
			<span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_WRITE_MEMORY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">),</span>
			<span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_RESET</span><span class="p">,</span> <span class="n">hdev</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">picolcd_exit_leds</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">picolcd_exit_backlight</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">picolcd_exit_lcd</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">picolcd_exit_framebuffer</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">picolcd_exit_cir</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">picolcd_exit_keys</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_probe_bootloader</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">picolcd_check_version</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hid_info</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;Device with untested bootloader revision, please submit /sys/kernel/debug/hid/%s/rdesc for this device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">picolcd_init_devfs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_BL_READ_MEMORY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">),</span>
			<span class="n">picolcd_out_report</span><span class="p">(</span><span class="n">REPORT_BL_WRITE_MEMORY</span><span class="p">,</span> <span class="n">hdev</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">picolcd_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
		     <span class="k">const</span> <span class="k">struct</span> <span class="n">hid_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dbg_hid</span><span class="p">(</span><span class="n">PICOLCD_NAME</span> <span class="s">&quot; hardware probe...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Let&#39;s allocate the picolcd data structure, set some reasonable</span>
<span class="cm">	 * defaults, and associate it with the device</span>
<span class="cm">	 */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">picolcd_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate space for Minibox PicoLCD device data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_no_cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">hdev</span> <span class="o">=</span> <span class="n">hdev</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">opmode_delay</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">==</span> <span class="n">USB_DEVICE_ID_PICOLCD_BOOTLOADER</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">PICOLCD_BOOTLOADER</span><span class="p">;</span>
	<span class="n">hid_set_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* Parse the device reports and start it up */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">hid_parse</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;device report parse failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_cleanup_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We don&#39;t use hidinput but hid_hw_start() fails if nothing is</span>
<span class="cm">	 * claimed. So spoof claimed input. */</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">claimed</span> <span class="o">=</span> <span class="n">HID_CLAIMED_INPUT</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">hid_hw_start</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hdev</span><span class="o">-&gt;</span><span class="n">claimed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;hardware start failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_cleanup_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">hid_hw_open</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;failed to open input interrupt pipe for key and IR events</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_cleanup_hid_hw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_operation_mode_delay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;failed to create sysfs attributes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_cleanup_hid_ll</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_operation_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="s">&quot;failed to create sysfs attributes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_cleanup_sysfs1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PICOLCD_BOOTLOADER</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">picolcd_probe_bootloader</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">picolcd_probe_lcd</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_cleanup_sysfs2</span><span class="p">;</span>

	<span class="n">dbg_hid</span><span class="p">(</span><span class="n">PICOLCD_NAME</span> <span class="s">&quot; activated and initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_cleanup_sysfs2:</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_operation_mode</span><span class="p">);</span>
<span class="nl">err_cleanup_sysfs1:</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_operation_mode_delay</span><span class="p">);</span>
<span class="nl">err_cleanup_hid_ll:</span>
	<span class="n">hid_hw_close</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="nl">err_cleanup_hid_hw:</span>
	<span class="n">hid_hw_stop</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
<span class="nl">err_cleanup_data:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="nl">err_no_cleanup:</span>
	<span class="n">hid_set_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">picolcd_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">picolcd_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">hid_get_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dbg_hid</span><span class="p">(</span><span class="n">PICOLCD_NAME</span> <span class="s">&quot; hardware remove...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">PICOLCD_FAILED</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_HID_PICOLCD_FB</span>
	<span class="cm">/* short-circuit FB as early as possible in order to</span>
<span class="cm">	 * avoid long delays if we host console.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">fb_info</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">picolcd_exit_devfs</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_operation_mode</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_operation_mode_delay</span><span class="p">);</span>
	<span class="n">hid_hw_close</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hid_hw_stop</span><span class="p">(</span><span class="n">hdev</span><span class="p">);</span>
	<span class="n">hid_set_drvdata</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Shortcut potential pending reply that will never arrive */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pending</span><span class="o">-&gt;</span><span class="n">ready</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Cleanup LED */</span>
	<span class="n">picolcd_exit_leds</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="cm">/* Clean up the framebuffer */</span>
	<span class="n">picolcd_exit_backlight</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">picolcd_exit_lcd</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">picolcd_exit_framebuffer</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="cm">/* Cleanup input */</span>
	<span class="n">picolcd_exit_cir</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">picolcd_exit_keys</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="cm">/* Finally, clean up the picolcd data itself */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hid_device_id</span> <span class="n">picolcd_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">HID_USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_MICROCHIP</span><span class="p">,</span> <span class="n">USB_DEVICE_ID_PICOLCD</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HID_USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_MICROCHIP</span><span class="p">,</span> <span class="n">USB_DEVICE_ID_PICOLCD_BOOTLOADER</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">picolcd_devices</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hid_driver</span> <span class="n">picolcd_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>          <span class="s">&quot;hid-picolcd&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>      <span class="n">picolcd_devices</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>         <span class="n">picolcd_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>        <span class="n">picolcd_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">raw_event</span> <span class="o">=</span>     <span class="n">picolcd_raw_event</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span>       <span class="n">picolcd_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span>        <span class="n">picolcd_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_resume</span> <span class="o">=</span>  <span class="n">picolcd_reset_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">picolcd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hid_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">picolcd_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">picolcd_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hid_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">picolcd_driver</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_HID_PICOLCD_FB</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">picolcd_fb_cleanup</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">fb_pending</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">picolcd_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">picolcd_exit</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Minibox graphics PicoLCD Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
