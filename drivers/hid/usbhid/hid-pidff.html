<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hid › usbhid › hid-pidff.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hid-pidff.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Force feedback driver for USB HID PID compliant devices</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2005, 2006 Anssi Hannula &lt;anssi.hannula@gmail.com&gt;</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cm">/* #define DEBUG */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>

<span class="cp">#include &lt;linux/hid.h&gt;</span>

<span class="cp">#include &quot;usbhid.h&quot;</span>

<span class="cp">#define	PID_EFFECTS_MAX		64</span>

<span class="cm">/* Report usage table used to put reports into an array */</span>

<span class="cp">#define PID_SET_EFFECT		0</span>
<span class="cp">#define PID_EFFECT_OPERATION	1</span>
<span class="cp">#define PID_DEVICE_GAIN		2</span>
<span class="cp">#define PID_POOL		3</span>
<span class="cp">#define PID_BLOCK_LOAD		4</span>
<span class="cp">#define PID_BLOCK_FREE		5</span>
<span class="cp">#define PID_DEVICE_CONTROL	6</span>
<span class="cp">#define PID_CREATE_NEW_EFFECT	7</span>

<span class="cp">#define PID_REQUIRED_REPORTS	7</span>

<span class="cp">#define PID_SET_ENVELOPE	8</span>
<span class="cp">#define PID_SET_CONDITION	9</span>
<span class="cp">#define PID_SET_PERIODIC	10</span>
<span class="cp">#define PID_SET_CONSTANT	11</span>
<span class="cp">#define PID_SET_RAMP		12</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pidff_reports</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span>
	<span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x74</span>
<span class="p">};</span>

<span class="cm">/* device_control is really 0x95, but 0x96 specified as it is the usage of</span>
<span class="cm">the only field in that report */</span>

<span class="cm">/* Value usage tables used to put fields and values into arrays */</span>

<span class="cp">#define PID_EFFECT_BLOCK_INDEX	0</span>

<span class="cp">#define PID_DURATION		1</span>
<span class="cp">#define PID_GAIN		2</span>
<span class="cp">#define PID_TRIGGER_BUTTON	3</span>
<span class="cp">#define PID_TRIGGER_REPEAT_INT	4</span>
<span class="cp">#define PID_DIRECTION_ENABLE	5</span>
<span class="cp">#define PID_START_DELAY		6</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pidff_set_effect</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xa7</span>
<span class="p">};</span>

<span class="cp">#define PID_ATTACK_LEVEL	1</span>
<span class="cp">#define PID_ATTACK_TIME		2</span>
<span class="cp">#define PID_FADE_LEVEL		3</span>
<span class="cp">#define PID_FADE_TIME		4</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pidff_set_envelope</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x5e</span> <span class="p">};</span>

<span class="cp">#define PID_PARAM_BLOCK_OFFSET	1</span>
<span class="cp">#define PID_CP_OFFSET		2</span>
<span class="cp">#define PID_POS_COEFFICIENT	3</span>
<span class="cp">#define PID_NEG_COEFFICIENT	4</span>
<span class="cp">#define PID_POS_SATURATION	5</span>
<span class="cp">#define PID_NEG_SATURATION	6</span>
<span class="cp">#define PID_DEAD_BAND		7</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pidff_set_condition</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x65</span>
<span class="p">};</span>

<span class="cp">#define PID_MAGNITUDE		1</span>
<span class="cp">#define PID_OFFSET		2</span>
<span class="cp">#define PID_PHASE		3</span>
<span class="cp">#define PID_PERIOD		4</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pidff_set_periodic</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x72</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pidff_set_constant</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x70</span> <span class="p">};</span>

<span class="cp">#define PID_RAMP_START		1</span>
<span class="cp">#define PID_RAMP_END		2</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pidff_set_ramp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x76</span> <span class="p">};</span>

<span class="cp">#define PID_RAM_POOL_AVAILABLE	1</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pidff_block_load</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xac</span> <span class="p">};</span>

<span class="cp">#define PID_LOOP_COUNT		1</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pidff_effect_operation</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x7c</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pidff_block_free</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x22</span> <span class="p">};</span>

<span class="cp">#define PID_DEVICE_GAIN_FIELD	0</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pidff_device_gain</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x7e</span> <span class="p">};</span>

<span class="cp">#define PID_RAM_POOL_SIZE	0</span>
<span class="cp">#define PID_SIMULTANEOUS_MAX	1</span>
<span class="cp">#define PID_DEVICE_MANAGED_POOL	2</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pidff_pool</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xa9</span> <span class="p">};</span>

<span class="cm">/* Special field key tables used to put special field keys into arrays */</span>

<span class="cp">#define PID_ENABLE_ACTUATORS	0</span>
<span class="cp">#define PID_RESET		1</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pidff_device_control</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x9a</span> <span class="p">};</span>

<span class="cp">#define PID_CONSTANT	0</span>
<span class="cp">#define PID_RAMP	1</span>
<span class="cp">#define PID_SQUARE	2</span>
<span class="cp">#define PID_SINE	3</span>
<span class="cp">#define PID_TRIANGLE	4</span>
<span class="cp">#define PID_SAW_UP	5</span>
<span class="cp">#define PID_SAW_DOWN	6</span>
<span class="cp">#define PID_SPRING	7</span>
<span class="cp">#define PID_DAMPER	8</span>
<span class="cp">#define PID_INERTIA	9</span>
<span class="cp">#define PID_FRICTION	10</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pidff_effect_types</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span>
	<span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x43</span>
<span class="p">};</span>

<span class="cp">#define PID_BLOCK_LOAD_SUCCESS	0</span>
<span class="cp">#define PID_BLOCK_LOAD_FULL	1</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pidff_block_load_status</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x8d</span> <span class="p">};</span>

<span class="cp">#define PID_EFFECT_START	0</span>
<span class="cp">#define PID_EFFECT_STOP		1</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">pidff_effect_operation_status</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x7b</span> <span class="p">};</span>

<span class="k">struct</span> <span class="n">pidff_usage</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
	<span class="n">s32</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pidff_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">reports</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_reports</span><span class="p">)];</span>

	<span class="k">struct</span> <span class="n">pidff_usage</span> <span class="n">set_effect</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_set_effect</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">pidff_usage</span> <span class="n">set_envelope</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_set_envelope</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">pidff_usage</span> <span class="n">set_condition</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_set_condition</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">pidff_usage</span> <span class="n">set_periodic</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_set_periodic</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">pidff_usage</span> <span class="n">set_constant</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_set_constant</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">pidff_usage</span> <span class="n">set_ramp</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_set_ramp</span><span class="p">)];</span>

	<span class="k">struct</span> <span class="n">pidff_usage</span> <span class="n">device_gain</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_device_gain</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">pidff_usage</span> <span class="n">block_load</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_block_load</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">pidff_usage</span> <span class="n">pool</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_pool</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">pidff_usage</span> <span class="n">effect_operation</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_effect_operation</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">pidff_usage</span> <span class="n">block_free</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_block_free</span><span class="p">)];</span>

	<span class="cm">/* Special field is a field that is not composed of</span>
<span class="cm">	   usage&lt;-&gt;value pairs that pidff_usage values are */</span>

	<span class="cm">/* Special field in create_new_effect */</span>
	<span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">create_new_effect_type</span><span class="p">;</span>

	<span class="cm">/* Special fields in set_effect */</span>
	<span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">set_effect_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">effect_direction</span><span class="p">;</span>

	<span class="cm">/* Special field in device_control */</span>
	<span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">device_control</span><span class="p">;</span>

	<span class="cm">/* Special field in block_load */</span>
	<span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">block_load_status</span><span class="p">;</span>

	<span class="cm">/* Special field in effect_operation */</span>
	<span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">effect_operation_status</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">control_id</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_device_control</span><span class="p">)];</span>
	<span class="kt">int</span> <span class="n">type_id</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_effect_types</span><span class="p">)];</span>
	<span class="kt">int</span> <span class="n">status_id</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_block_load_status</span><span class="p">)];</span>
	<span class="kt">int</span> <span class="n">operation_id</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_effect_operation_status</span><span class="p">)];</span>

	<span class="kt">int</span> <span class="n">pid_id</span><span class="p">[</span><span class="n">PID_EFFECTS_MAX</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Scale an unsigned value with range 0..max for the given field</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_rescale</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_maximum</span> <span class="o">-</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_minimum</span><span class="p">)</span> <span class="o">/</span> <span class="n">max</span> <span class="o">+</span>
	    <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_minimum</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Scale a signed value in range -0x8000..0x7fff for the given field</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_rescale_signed</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">i</span> <span class="o">&gt;</span>
	    <span class="mi">0</span> <span class="o">?</span> <span class="n">i</span> <span class="o">*</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_maximum</span> <span class="o">/</span> <span class="mh">0x7fff</span> <span class="o">:</span> <span class="n">i</span> <span class="o">*</span>
	    <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_minimum</span> <span class="o">/</span> <span class="o">-</span><span class="mh">0x8000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pidff_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_usage</span> <span class="o">*</span><span class="n">usage</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usage</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pidff_rescale</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;calculated from %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pidff_set_signed</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_usage</span> <span class="o">*</span><span class="n">usage</span><span class="p">,</span> <span class="n">s16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_minimum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">usage</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pidff_rescale_signed</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">usage</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">pidff_rescale</span><span class="p">(</span><span class="o">-</span><span class="n">value</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">usage</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">pidff_rescale</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mh">0x7fff</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;calculated from %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send envelope report to the device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pidff_set_envelope_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ff_envelope</span> <span class="o">*</span><span class="n">envelope</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_envelope</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
	    <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_envelope</span><span class="p">[</span><span class="n">PID_ATTACK_LEVEL</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
	    <span class="n">pidff_rescale</span><span class="p">(</span><span class="n">envelope</span><span class="o">-&gt;</span><span class="n">attack_level</span> <span class="o">&gt;</span>
			  <span class="mh">0x7fff</span> <span class="o">?</span> <span class="mh">0x7fff</span> <span class="o">:</span> <span class="n">envelope</span><span class="o">-&gt;</span><span class="n">attack_level</span><span class="p">,</span> <span class="mh">0x7fff</span><span class="p">,</span>
			  <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_envelope</span><span class="p">[</span><span class="n">PID_ATTACK_LEVEL</span><span class="p">].</span><span class="n">field</span><span class="p">);</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_envelope</span><span class="p">[</span><span class="n">PID_FADE_LEVEL</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
	    <span class="n">pidff_rescale</span><span class="p">(</span><span class="n">envelope</span><span class="o">-&gt;</span><span class="n">fade_level</span> <span class="o">&gt;</span>
			  <span class="mh">0x7fff</span> <span class="o">?</span> <span class="mh">0x7fff</span> <span class="o">:</span> <span class="n">envelope</span><span class="o">-&gt;</span><span class="n">fade_level</span><span class="p">,</span> <span class="mh">0x7fff</span><span class="p">,</span>
			  <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_envelope</span><span class="p">[</span><span class="n">PID_FADE_LEVEL</span><span class="p">].</span><span class="n">field</span><span class="p">);</span>

	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_envelope</span><span class="p">[</span><span class="n">PID_ATTACK_TIME</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">envelope</span><span class="o">-&gt;</span><span class="n">attack_length</span><span class="p">;</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_envelope</span><span class="p">[</span><span class="n">PID_FADE_TIME</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">envelope</span><span class="o">-&gt;</span><span class="n">fade_length</span><span class="p">;</span>

	<span class="n">hid_dbg</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;attack %u =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">envelope</span><span class="o">-&gt;</span><span class="n">attack_level</span><span class="p">,</span>
		<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_envelope</span><span class="p">[</span><span class="n">PID_ATTACK_LEVEL</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_SET_ENVELOPE</span><span class="p">],</span>
			  <span class="n">USB_DIR_OUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Test if the new envelope differs from old one</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_needs_set_envelope</span><span class="p">(</span><span class="k">struct</span> <span class="n">ff_envelope</span> <span class="o">*</span><span class="n">envelope</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ff_envelope</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">envelope</span><span class="o">-&gt;</span><span class="n">attack_level</span> <span class="o">!=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">attack_level</span> <span class="o">||</span>
	       <span class="n">envelope</span><span class="o">-&gt;</span><span class="n">fade_level</span> <span class="o">!=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">fade_level</span> <span class="o">||</span>
	       <span class="n">envelope</span><span class="o">-&gt;</span><span class="n">attack_length</span> <span class="o">!=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">attack_length</span> <span class="o">||</span>
	       <span class="n">envelope</span><span class="o">-&gt;</span><span class="n">fade_length</span> <span class="o">!=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">fade_length</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send constant force report to the device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pidff_set_constant_force_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">effect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_constant</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">pidff_set_signed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_constant</span><span class="p">[</span><span class="n">PID_MAGNITUDE</span><span class="p">],</span>
			 <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">constant</span><span class="p">.</span><span class="n">level</span><span class="p">);</span>

	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_SET_CONSTANT</span><span class="p">],</span>
			  <span class="n">USB_DIR_OUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Test if the constant parameters have changed between effects</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_needs_set_constant</span><span class="p">(</span><span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">effect</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">constant</span><span class="p">.</span><span class="n">level</span> <span class="o">!=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">constant</span><span class="p">.</span><span class="n">level</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send set effect report to the device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pidff_set_effect_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">effect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect_type</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">create_new_effect_type</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect</span><span class="p">[</span><span class="n">PID_DURATION</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">effect</span><span class="o">-&gt;</span><span class="n">replay</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect</span><span class="p">[</span><span class="n">PID_TRIGGER_BUTTON</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">effect</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">.</span><span class="n">button</span><span class="p">;</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect</span><span class="p">[</span><span class="n">PID_TRIGGER_REPEAT_INT</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">effect</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">.</span><span class="n">interval</span><span class="p">;</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect</span><span class="p">[</span><span class="n">PID_GAIN</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect</span><span class="p">[</span><span class="n">PID_GAIN</span><span class="p">].</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_maximum</span><span class="p">;</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect</span><span class="p">[</span><span class="n">PID_DIRECTION_ENABLE</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">effect_direction</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">pidff_rescale</span><span class="p">(</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span>
				<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">effect_direction</span><span class="p">);</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect</span><span class="p">[</span><span class="n">PID_START_DELAY</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">effect</span><span class="o">-&gt;</span><span class="n">replay</span><span class="p">.</span><span class="n">delay</span><span class="p">;</span>

	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_SET_EFFECT</span><span class="p">],</span>
			  <span class="n">USB_DIR_OUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Test if the values used in set_effect have changed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_needs_set_effect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">effect</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">effect</span><span class="o">-&gt;</span><span class="n">replay</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">replay</span><span class="p">.</span><span class="n">length</span> <span class="o">||</span>
	       <span class="n">effect</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">.</span><span class="n">interval</span> <span class="o">!=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">.</span><span class="n">interval</span> <span class="o">||</span>
	       <span class="n">effect</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">.</span><span class="n">button</span> <span class="o">!=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">.</span><span class="n">button</span> <span class="o">||</span>
	       <span class="n">effect</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">!=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">||</span>
	       <span class="n">effect</span><span class="o">-&gt;</span><span class="n">replay</span><span class="p">.</span><span class="n">delay</span> <span class="o">!=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">replay</span><span class="p">.</span><span class="n">delay</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send periodic effect report to the device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pidff_set_periodic_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">effect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_periodic</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">pidff_set_signed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_periodic</span><span class="p">[</span><span class="n">PID_MAGNITUDE</span><span class="p">],</span>
			 <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">periodic</span><span class="p">.</span><span class="n">magnitude</span><span class="p">);</span>
	<span class="n">pidff_set_signed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_periodic</span><span class="p">[</span><span class="n">PID_OFFSET</span><span class="p">],</span>
			 <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">periodic</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">pidff_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_periodic</span><span class="p">[</span><span class="n">PID_PHASE</span><span class="p">],</span> <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">periodic</span><span class="p">.</span><span class="n">phase</span><span class="p">);</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_periodic</span><span class="p">[</span><span class="n">PID_PERIOD</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">periodic</span><span class="p">.</span><span class="n">period</span><span class="p">;</span>

	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_SET_PERIODIC</span><span class="p">],</span>
			  <span class="n">USB_DIR_OUT</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Test if periodic effect parameters have changed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_needs_set_periodic</span><span class="p">(</span><span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">effect</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">periodic</span><span class="p">.</span><span class="n">magnitude</span> <span class="o">!=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">periodic</span><span class="p">.</span><span class="n">magnitude</span> <span class="o">||</span>
	       <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">periodic</span><span class="p">.</span><span class="n">offset</span> <span class="o">!=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">periodic</span><span class="p">.</span><span class="n">offset</span> <span class="o">||</span>
	       <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">periodic</span><span class="p">.</span><span class="n">phase</span> <span class="o">!=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">periodic</span><span class="p">.</span><span class="n">phase</span> <span class="o">||</span>
	       <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">periodic</span><span class="p">.</span><span class="n">period</span> <span class="o">!=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">periodic</span><span class="p">.</span><span class="n">period</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send condition effect reports to the device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pidff_set_condition_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">effect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_condition</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_condition</span><span class="p">[</span><span class="n">PID_PARAM_BLOCK_OFFSET</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">pidff_set_signed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_condition</span><span class="p">[</span><span class="n">PID_CP_OFFSET</span><span class="p">],</span>
				 <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">condition</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">center</span><span class="p">);</span>
		<span class="n">pidff_set_signed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_condition</span><span class="p">[</span><span class="n">PID_POS_COEFFICIENT</span><span class="p">],</span>
				 <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">condition</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">right_coeff</span><span class="p">);</span>
		<span class="n">pidff_set_signed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_condition</span><span class="p">[</span><span class="n">PID_NEG_COEFFICIENT</span><span class="p">],</span>
				 <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">condition</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">left_coeff</span><span class="p">);</span>
		<span class="n">pidff_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_condition</span><span class="p">[</span><span class="n">PID_POS_SATURATION</span><span class="p">],</span>
			  <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">condition</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">right_saturation</span><span class="p">);</span>
		<span class="n">pidff_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_condition</span><span class="p">[</span><span class="n">PID_NEG_SATURATION</span><span class="p">],</span>
			  <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">condition</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">left_saturation</span><span class="p">);</span>
		<span class="n">pidff_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_condition</span><span class="p">[</span><span class="n">PID_DEAD_BAND</span><span class="p">],</span>
			  <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">condition</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">deadband</span><span class="p">);</span>
		<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_SET_CONDITION</span><span class="p">],</span>
				  <span class="n">USB_DIR_OUT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Test if condition effect parameters have changed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_needs_set_condition</span><span class="p">(</span><span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">effect</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ff_condition_effect</span> <span class="o">*</span><span class="n">cond</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">condition</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">ff_condition_effect</span> <span class="o">*</span><span class="n">old_cond</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">condition</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">center</span> <span class="o">!=</span> <span class="n">old_cond</span><span class="o">-&gt;</span><span class="n">center</span> <span class="o">||</span>
		       <span class="n">cond</span><span class="o">-&gt;</span><span class="n">right_coeff</span> <span class="o">!=</span> <span class="n">old_cond</span><span class="o">-&gt;</span><span class="n">right_coeff</span> <span class="o">||</span>
		       <span class="n">cond</span><span class="o">-&gt;</span><span class="n">left_coeff</span> <span class="o">!=</span> <span class="n">old_cond</span><span class="o">-&gt;</span><span class="n">left_coeff</span> <span class="o">||</span>
		       <span class="n">cond</span><span class="o">-&gt;</span><span class="n">right_saturation</span> <span class="o">!=</span> <span class="n">old_cond</span><span class="o">-&gt;</span><span class="n">right_saturation</span> <span class="o">||</span>
		       <span class="n">cond</span><span class="o">-&gt;</span><span class="n">left_saturation</span> <span class="o">!=</span> <span class="n">old_cond</span><span class="o">-&gt;</span><span class="n">left_saturation</span> <span class="o">||</span>
		       <span class="n">cond</span><span class="o">-&gt;</span><span class="n">deadband</span> <span class="o">!=</span> <span class="n">old_cond</span><span class="o">-&gt;</span><span class="n">deadband</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send ramp force report to the device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pidff_set_ramp_force_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">effect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_ramp</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">pidff_set_signed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_ramp</span><span class="p">[</span><span class="n">PID_RAMP_START</span><span class="p">],</span>
			 <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ramp</span><span class="p">.</span><span class="n">start_level</span><span class="p">);</span>
	<span class="n">pidff_set_signed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_ramp</span><span class="p">[</span><span class="n">PID_RAMP_END</span><span class="p">],</span>
			 <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ramp</span><span class="p">.</span><span class="n">end_level</span><span class="p">);</span>
	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_SET_RAMP</span><span class="p">],</span>
			  <span class="n">USB_DIR_OUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Test if ramp force parameters have changed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_needs_set_ramp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">effect</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ramp</span><span class="p">.</span><span class="n">start_level</span> <span class="o">!=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ramp</span><span class="p">.</span><span class="n">start_level</span> <span class="o">||</span>
	       <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ramp</span><span class="p">.</span><span class="n">end_level</span> <span class="o">!=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ramp</span><span class="p">.</span><span class="n">end_level</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send a request for effect upload to the device</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if device reported success, -ENOSPC if the device reported memory</span>
<span class="cm"> * is full. Upon unknown response the function will retry for 60 times, if</span>
<span class="cm"> * still unsuccessful -EIO is returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_request_effect_upload</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">,</span> <span class="kt">int</span> <span class="n">efnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">create_new_effect_type</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">efnum</span><span class="p">;</span>
	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_CREATE_NEW_EFFECT</span><span class="p">],</span>
			  <span class="n">USB_DIR_OUT</span><span class="p">);</span>
	<span class="n">hid_dbg</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;create_new_effect sent, type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">efnum</span><span class="p">);</span>

	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load_status</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbhid_wait_io</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_dbg</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;pid_block_load requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_BLOCK_LOAD</span><span class="p">],</span>
				  <span class="n">USB_DIR_IN</span><span class="p">);</span>
		<span class="n">usbhid_wait_io</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load_status</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span>
		    <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">status_id</span><span class="p">[</span><span class="n">PID_BLOCK_LOAD_SUCCESS</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">hid_dbg</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;device reported free memory: %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_RAM_POOL_AVAILABLE</span><span class="p">].</span><span class="n">value</span> <span class="o">?</span>
				 <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_RAM_POOL_AVAILABLE</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load_status</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span>
		    <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">status_id</span><span class="p">[</span><span class="n">PID_BLOCK_LOAD_FULL</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">hid_dbg</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;not enough memory free: %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_RAM_POOL_AVAILABLE</span><span class="p">].</span><span class="n">value</span> <span class="o">?</span>
				<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_RAM_POOL_AVAILABLE</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;pid_block_load failed 60 times</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Play the effect with PID id n times</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pidff_playback_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pid_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">effect_operation</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">effect_operation_status</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">operation_id</span><span class="p">[</span><span class="n">PID_EFFECT_STOP</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">effect_operation_status</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">operation_id</span><span class="p">[</span><span class="n">PID_EFFECT_START</span><span class="p">];</span>
		<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">effect_operation</span><span class="p">[</span><span class="n">PID_LOOP_COUNT</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_EFFECT_OPERATION</span><span class="p">],</span>
			  <span class="n">USB_DIR_OUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Play the effect with effect id @effect_id for @value times</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_playback</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">effect_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ff</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">pidff_playback_pid</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">pid_id</span><span class="p">[</span><span class="n">effect_id</span><span class="p">],</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Erase effect with PID id</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pidff_erase_pid</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pid_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_free</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid_id</span><span class="p">;</span>
	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_BLOCK_FREE</span><span class="p">],</span>
			  <span class="n">USB_DIR_OUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stop and erase effect with effect_id</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_erase_effect</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">effect_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ff</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pid_id</span> <span class="o">=</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">pid_id</span><span class="p">[</span><span class="n">effect_id</span><span class="p">];</span>

	<span class="n">hid_dbg</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;starting to erase %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">effect_id</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">pid_id</span><span class="p">[</span><span class="n">effect_id</span><span class="p">]);</span>
	<span class="cm">/* Wait for the queue to clear. We do not want a full fifo to</span>
<span class="cm">	   prevent the effect removal. */</span>
	<span class="n">usbhid_wait_io</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">);</span>
	<span class="n">pidff_playback_pid</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">pid_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pidff_erase_pid</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">pid_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Effect upload handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_upload_effect</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">effect</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ff</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FF_CONSTANT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">pidff_request_effect_upload</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span>
					<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_CONSTANT</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span> <span class="n">pidff_needs_set_effect</span><span class="p">(</span><span class="n">effect</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span>
			<span class="n">pidff_set_effect_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">effect</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span> <span class="n">pidff_needs_set_constant</span><span class="p">(</span><span class="n">effect</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span>
			<span class="n">pidff_set_constant_force_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">effect</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span>
		    <span class="n">pidff_needs_set_envelope</span><span class="p">(</span><span class="o">&amp;</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">constant</span><span class="p">.</span><span class="n">envelope</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">constant</span><span class="p">.</span><span class="n">envelope</span><span class="p">))</span>
			<span class="n">pidff_set_envelope_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">constant</span><span class="p">.</span><span class="n">envelope</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FF_PERIODIC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">periodic</span><span class="p">.</span><span class="n">waveform</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">FF_SQUARE</span>:
				<span class="n">type_id</span> <span class="o">=</span> <span class="n">PID_SQUARE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FF_TRIANGLE</span>:
				<span class="n">type_id</span> <span class="o">=</span> <span class="n">PID_TRIANGLE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FF_SINE</span>:
				<span class="n">type_id</span> <span class="o">=</span> <span class="n">PID_SINE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FF_SAW_UP</span>:
				<span class="n">type_id</span> <span class="o">=</span> <span class="n">PID_SAW_UP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FF_SAW_DOWN</span>:
				<span class="n">type_id</span> <span class="o">=</span> <span class="n">PID_SAW_DOWN</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;invalid waveform</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">pidff_request_effect_upload</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span>
					<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">type_id</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span> <span class="n">pidff_needs_set_effect</span><span class="p">(</span><span class="n">effect</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span>
			<span class="n">pidff_set_effect_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">effect</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span> <span class="n">pidff_needs_set_periodic</span><span class="p">(</span><span class="n">effect</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span>
			<span class="n">pidff_set_periodic_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">effect</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span>
		    <span class="n">pidff_needs_set_envelope</span><span class="p">(</span><span class="o">&amp;</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">periodic</span><span class="p">.</span><span class="n">envelope</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">periodic</span><span class="p">.</span><span class="n">envelope</span><span class="p">))</span>
			<span class="n">pidff_set_envelope_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">periodic</span><span class="p">.</span><span class="n">envelope</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FF_RAMP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">pidff_request_effect_upload</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span>
					<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_RAMP</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span> <span class="n">pidff_needs_set_effect</span><span class="p">(</span><span class="n">effect</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span>
			<span class="n">pidff_set_effect_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">effect</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span> <span class="n">pidff_needs_set_ramp</span><span class="p">(</span><span class="n">effect</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span>
			<span class="n">pidff_set_ramp_force_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">effect</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span>
		    <span class="n">pidff_needs_set_envelope</span><span class="p">(</span><span class="o">&amp;</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ramp</span><span class="p">.</span><span class="n">envelope</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ramp</span><span class="p">.</span><span class="n">envelope</span><span class="p">))</span>
			<span class="n">pidff_set_envelope_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ramp</span><span class="p">.</span><span class="n">envelope</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FF_SPRING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">pidff_request_effect_upload</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span>
					<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_SPRING</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span> <span class="n">pidff_needs_set_effect</span><span class="p">(</span><span class="n">effect</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span>
			<span class="n">pidff_set_effect_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">effect</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span> <span class="n">pidff_needs_set_condition</span><span class="p">(</span><span class="n">effect</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span>
			<span class="n">pidff_set_condition_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">effect</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FF_FRICTION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">pidff_request_effect_upload</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span>
					<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_FRICTION</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span> <span class="n">pidff_needs_set_effect</span><span class="p">(</span><span class="n">effect</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span>
			<span class="n">pidff_set_effect_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">effect</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span> <span class="n">pidff_needs_set_condition</span><span class="p">(</span><span class="n">effect</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span>
			<span class="n">pidff_set_condition_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">effect</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FF_DAMPER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">pidff_request_effect_upload</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span>
					<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_DAMPER</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span> <span class="n">pidff_needs_set_effect</span><span class="p">(</span><span class="n">effect</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span>
			<span class="n">pidff_set_effect_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">effect</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span> <span class="n">pidff_needs_set_condition</span><span class="p">(</span><span class="n">effect</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span>
			<span class="n">pidff_set_condition_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">effect</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FF_INERTIA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">pidff_request_effect_upload</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span>
					<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_INERTIA</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span> <span class="n">pidff_needs_set_effect</span><span class="p">(</span><span class="n">effect</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span>
			<span class="n">pidff_set_effect_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">effect</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">||</span> <span class="n">pidff_needs_set_condition</span><span class="p">(</span><span class="n">effect</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span>
			<span class="n">pidff_set_condition_report</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">effect</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;invalid type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span><span class="p">)</span>
		<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">pid_id</span><span class="p">[</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">hid_dbg</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;uploaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set_gain() handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pidff_set_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">gain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ff</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">pidff_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">device_gain</span><span class="p">[</span><span class="n">PID_DEVICE_GAIN_FIELD</span><span class="p">],</span> <span class="n">gain</span><span class="p">);</span>
	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_DEVICE_GAIN</span><span class="p">],</span>
			  <span class="n">USB_DIR_OUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pidff_autocenter</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">,</span> <span class="n">u16</span> <span class="n">magnitude</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">field</span> <span class="o">=</span>
		<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">field</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">magnitude</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pidff_playback_pid</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_minimum</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pidff_playback_pid</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_minimum</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_minimum</span><span class="p">;</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect_type</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_SPRING</span><span class="p">];</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect</span><span class="p">[</span><span class="n">PID_DURATION</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect</span><span class="p">[</span><span class="n">PID_TRIGGER_BUTTON</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect</span><span class="p">[</span><span class="n">PID_TRIGGER_REPEAT_INT</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pidff_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect</span><span class="p">[</span><span class="n">PID_GAIN</span><span class="p">],</span> <span class="n">magnitude</span><span class="p">);</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect</span><span class="p">[</span><span class="n">PID_DIRECTION_ENABLE</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect</span><span class="p">[</span><span class="n">PID_START_DELAY</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_SET_EFFECT</span><span class="p">],</span>
			  <span class="n">USB_DIR_OUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pidff_set_autocenter() handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pidff_set_autocenter</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">magnitude</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ff</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">pidff_autocenter</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">magnitude</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find fields from a report and fill a pidff_usage</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_find_fields</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_usage</span> <span class="o">*</span><span class="n">usage</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">strict</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">found</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">maxusage</span> <span class="o">!=</span>
			    <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">report_count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;maxusage and report_count do not match, skipping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">maxusage</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">hid</span> <span class="o">==</span>
				    <span class="p">(</span><span class="n">HID_UP_PID</span> <span class="o">|</span> <span class="n">table</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="p">{</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;found %d at %d-&gt;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
					<span class="n">usage</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">field</span> <span class="o">=</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="n">usage</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span>
						<span class="o">&amp;</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
					<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span> <span class="o">&amp;&amp;</span> <span class="n">strict</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;failed to locate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return index into pidff_reports for the given usage</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_check_usage</span><span class="p">(</span><span class="kt">int</span> <span class="n">usage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_reports</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usage</span> <span class="o">==</span> <span class="p">(</span><span class="n">HID_UP_PID</span> <span class="o">|</span> <span class="n">pidff_reports</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find the reports and fill pidff-&gt;reports[]</span>
<span class="cm"> * report_type specifies either OUTPUT or FEATURE reports</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pidff_find_reports</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">report_type</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">report</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">report_enum</span><span class="p">[</span><span class="n">report_type</span><span class="p">].</span><span class="n">report_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pidff_check_usage</span><span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">logical</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hid_dbg</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;found usage 0x%02x from field-&gt;logical</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pidff_reports</span><span class="p">[</span><span class="n">ret</span><span class="p">]);</span>
			<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">ret</span><span class="p">]</span> <span class="o">=</span> <span class="n">report</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Sometimes logical collections are stacked to indicate</span>
<span class="cm">		 * different usages for the report and the field, in which</span>
<span class="cm">		 * case we want the usage of the parent. However, Linux HID</span>
<span class="cm">		 * implementation hides this fact, so we have to dig it up</span>
<span class="cm">		 * ourselves</span>
<span class="cm">		 */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">collection_index</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">hid</span><span class="o">-&gt;</span><span class="n">collection</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">HID_COLLECTION_LOGICAL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pidff_check_usage</span><span class="p">(</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">collection</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">usage</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">ret</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">hid_dbg</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span>
				<span class="s">&quot;found usage 0x%02x from collection array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pidff_reports</span><span class="p">[</span><span class="n">ret</span><span class="p">]);</span>
			<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">ret</span><span class="p">]</span> <span class="o">=</span> <span class="n">report</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Test if the required reports have been found</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_reports_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">PID_REQUIRED_REPORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">hid_dbg</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;%d missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find a field with a specific usage within a report</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="nf">pidff_find_special_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">,</span>
						  <span class="kt">int</span> <span class="n">usage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enforce_min</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">logical</span> <span class="o">==</span> <span class="p">(</span><span class="n">HID_UP_PID</span> <span class="o">|</span> <span class="n">usage</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">report_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enforce_min</span> <span class="o">||</span>
			    <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">logical_minimum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;logical_minimum is not 1 as it should be</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fill a pidff-&gt;*_id struct table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_find_special_keys</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">keys</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">fld</span><span class="p">,</span>
				   <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">usagetable</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">fld</span><span class="o">-&gt;</span><span class="n">maxusage</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fld</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">hid</span> <span class="o">==</span> <span class="p">(</span><span class="n">HID_UP_PID</span> <span class="o">|</span> <span class="n">usagetable</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">found</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PIDFF_FIND_SPECIAL_KEYS(keys, field, name) \</span>
<span class="cp">	pidff_find_special_keys(pidff-&gt;keys, pidff-&gt;field, pidff_ ## name, \</span>
<span class="cp">		sizeof(pidff_ ## name))</span>

<span class="cm">/*</span>
<span class="cm"> * Find and check the special fields</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_find_special_fields</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hid_dbg</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;finding special fields</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">create_new_effect_type</span> <span class="o">=</span>
		<span class="n">pidff_find_special_field</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_CREATE_NEW_EFFECT</span><span class="p">],</span>
					 <span class="mh">0x25</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect_type</span> <span class="o">=</span>
		<span class="n">pidff_find_special_field</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_SET_EFFECT</span><span class="p">],</span>
					 <span class="mh">0x25</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">effect_direction</span> <span class="o">=</span>
		<span class="n">pidff_find_special_field</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_SET_EFFECT</span><span class="p">],</span>
					 <span class="mh">0x57</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">device_control</span> <span class="o">=</span>
		<span class="n">pidff_find_special_field</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_DEVICE_CONTROL</span><span class="p">],</span>
					 <span class="mh">0x96</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load_status</span> <span class="o">=</span>
		<span class="n">pidff_find_special_field</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_BLOCK_LOAD</span><span class="p">],</span>
					 <span class="mh">0x8b</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">effect_operation_status</span> <span class="o">=</span>
		<span class="n">pidff_find_special_field</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_EFFECT_OPERATION</span><span class="p">],</span>
					 <span class="mh">0x78</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">hid_dbg</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;search done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">create_new_effect_type</span> <span class="o">||</span> <span class="o">!</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;effect lists not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">effect_direction</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;direction field not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">device_control</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;device control field not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;block load status field not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">effect_operation_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;effect operation field not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pidff_find_special_keys</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">control_id</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">device_control</span><span class="p">,</span>
				<span class="n">pidff_device_control</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_device_control</span><span class="p">));</span>

	<span class="n">PIDFF_FIND_SPECIAL_KEYS</span><span class="p">(</span><span class="n">control_id</span><span class="p">,</span> <span class="n">device_control</span><span class="p">,</span> <span class="n">device_control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PIDFF_FIND_SPECIAL_KEYS</span><span class="p">(</span><span class="n">type_id</span><span class="p">,</span> <span class="n">create_new_effect_type</span><span class="p">,</span>
				     <span class="n">effect_types</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;no effect types found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PIDFF_FIND_SPECIAL_KEYS</span><span class="p">(</span><span class="n">status_id</span><span class="p">,</span> <span class="n">block_load_status</span><span class="p">,</span>
				    <span class="n">block_load_status</span><span class="p">)</span> <span class="o">!=</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_block_load_status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span>
			<span class="s">&quot;block load status identifiers not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PIDFF_FIND_SPECIAL_KEYS</span><span class="p">(</span><span class="n">operation_id</span><span class="p">,</span> <span class="n">effect_operation_status</span><span class="p">,</span>
				    <span class="n">effect_operation_status</span><span class="p">)</span> <span class="o">!=</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_effect_operation_status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;effect operation identifiers not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Find the implemented effect types</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_find_effects</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pidff_effect_types</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pidff_type</span> <span class="o">=</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">set_effect_type</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">pidff_type</span><span class="p">].</span><span class="n">hid</span> <span class="o">!=</span>
		    <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">create_new_effect_type</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">pidff_type</span><span class="p">].</span><span class="n">hid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span>
				<span class="s">&quot;effect type number %d is invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_CONSTANT</span><span class="p">])</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_CONSTANT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_RAMP</span><span class="p">])</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_RAMP</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_SQUARE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_SQUARE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_PERIODIC</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_SINE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_SINE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_PERIODIC</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_TRIANGLE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_TRIANGLE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_PERIODIC</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_SAW_UP</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_SAW_UP</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_PERIODIC</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_SAW_DOWN</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_SAW_DOWN</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_PERIODIC</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_SPRING</span><span class="p">])</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_SPRING</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_DAMPER</span><span class="p">])</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_DAMPER</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_INERTIA</span><span class="p">])</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_INERTIA</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">type_id</span><span class="p">[</span><span class="n">PID_FRICTION</span><span class="p">])</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_FRICTION</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cp">#define PIDFF_FIND_FIELDS(name, report, strict) \</span>
<span class="cp">	pidff_find_fields(pidff-&gt;name, pidff_ ## name, \</span>
<span class="cp">		pidff-&gt;reports[report], \</span>
<span class="cp">		sizeof(pidff_ ## name), strict)</span>

<span class="cm">/*</span>
<span class="cm"> * Fill and check the pidff_usages</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_init_fields</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">,</span> <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">envelope_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PIDFF_FIND_FIELDS</span><span class="p">(</span><span class="n">set_effect</span><span class="p">,</span> <span class="n">PID_SET_EFFECT</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;unknown set_effect report layout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PIDFF_FIND_FIELDS</span><span class="p">(</span><span class="n">block_load</span><span class="p">,</span> <span class="n">PID_BLOCK_LOAD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;unknown pid_block_load report layout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PIDFF_FIND_FIELDS</span><span class="p">(</span><span class="n">effect_operation</span><span class="p">,</span> <span class="n">PID_EFFECT_OPERATION</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;unknown effect_operation report layout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PIDFF_FIND_FIELDS</span><span class="p">(</span><span class="n">block_free</span><span class="p">,</span> <span class="n">PID_BLOCK_FREE</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;unknown pid_block_free report layout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PIDFF_FIND_FIELDS</span><span class="p">(</span><span class="n">set_envelope</span><span class="p">,</span> <span class="n">PID_SET_ENVELOPE</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">envelope_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pidff_find_special_fields</span><span class="p">(</span><span class="n">pidff</span><span class="p">)</span> <span class="o">||</span> <span class="n">pidff_find_effects</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">envelope_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FF_CONSTANT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">))</span>
			<span class="n">hid_warn</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span>
				 <span class="s">&quot;has constant effect but no envelope</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FF_RAMP</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">))</span>
			<span class="n">hid_warn</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span>
				 <span class="s">&quot;has ramp effect but no envelope</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FF_PERIODIC</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">))</span>
			<span class="n">hid_warn</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span>
				 <span class="s">&quot;has periodic effect but no envelope</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FF_CONSTANT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">PIDFF_FIND_FIELDS</span><span class="p">(</span><span class="n">set_constant</span><span class="p">,</span> <span class="n">PID_SET_CONSTANT</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hid_warn</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;unknown constant effect layout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FF_CONSTANT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FF_RAMP</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">PIDFF_FIND_FIELDS</span><span class="p">(</span><span class="n">set_ramp</span><span class="p">,</span> <span class="n">PID_SET_RAMP</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hid_warn</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;unknown ramp effect layout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FF_RAMP</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FF_SPRING</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">FF_DAMPER</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">FF_FRICTION</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">FF_INERTIA</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">PIDFF_FIND_FIELDS</span><span class="p">(</span><span class="n">set_condition</span><span class="p">,</span> <span class="n">PID_SET_CONDITION</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hid_warn</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;unknown condition effect layout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FF_SPRING</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FF_DAMPER</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FF_FRICTION</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FF_INERTIA</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FF_PERIODIC</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">PIDFF_FIND_FIELDS</span><span class="p">(</span><span class="n">set_periodic</span><span class="p">,</span> <span class="n">PID_SET_PERIODIC</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hid_warn</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;unknown periodic effect layout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FF_PERIODIC</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">PIDFF_FIND_FIELDS</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">PID_POOL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PIDFF_FIND_FIELDS</span><span class="p">(</span><span class="n">device_gain</span><span class="p">,</span> <span class="n">PID_DEVICE_GAIN</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_GAIN</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pidff_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span> <span class="o">=</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">device_control</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">control_id</span><span class="p">[</span><span class="n">PID_RESET</span><span class="p">];</span>
	<span class="cm">/* We reset twice as sometimes hid_wait_io isn&#39;t waiting long enough */</span>
	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_DEVICE_CONTROL</span><span class="p">],</span> <span class="n">USB_DIR_OUT</span><span class="p">);</span>
	<span class="n">usbhid_wait_io</span><span class="p">(</span><span class="n">hid</span><span class="p">);</span>
	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_DEVICE_CONTROL</span><span class="p">],</span> <span class="n">USB_DIR_OUT</span><span class="p">);</span>
	<span class="n">usbhid_wait_io</span><span class="p">(</span><span class="n">hid</span><span class="p">);</span>

	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">device_control</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">control_id</span><span class="p">[</span><span class="n">PID_ENABLE_ACTUATORS</span><span class="p">];</span>
	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_DEVICE_CONTROL</span><span class="p">],</span> <span class="n">USB_DIR_OUT</span><span class="p">);</span>
	<span class="n">usbhid_wait_io</span><span class="p">(</span><span class="n">hid</span><span class="p">);</span>

	<span class="cm">/* pool report is sometimes messed up, refetch it */</span>
	<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_POOL</span><span class="p">],</span> <span class="n">USB_DIR_IN</span><span class="p">);</span>
	<span class="n">usbhid_wait_io</span><span class="p">(</span><span class="n">hid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">PID_SIMULTANEOUS_MAX</span><span class="p">].</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">PID_SIMULTANEOUS_MAX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hid_warn</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span>
					 <span class="s">&quot;device reports %d simultaneous effects</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">PID_SIMULTANEOUS_MAX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">hid_dbg</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;pid_pool requested again</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_POOL</span><span class="p">],</span>
					  <span class="n">USB_DIR_IN</span><span class="p">);</span>
			<span class="n">usbhid_wait_io</span><span class="p">(</span><span class="n">hid</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Test if autocenter modification is using the supported method</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pidff_check_autocenter</span><span class="p">(</span><span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Let&#39;s find out if autocenter modification is supported</span>
<span class="cm">	 * Specification doesn&#39;t specify anything, so we request an</span>
<span class="cm">	 * effect upload and cancel it immediately. If the approved</span>
<span class="cm">	 * effect id was one above the minimum, then we assume the first</span>
<span class="cm">	 * effect id is a built-in spring type effect used for autocenter</span>
<span class="cm">	 */</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">pidff_request_effect_upload</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_err</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;upload request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span>
	    <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_minimum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pidff_autocenter</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FF_AUTOCENTER</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hid_notice</span><span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">,</span>
			   <span class="s">&quot;device has unknown autocenter control method</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pidff_erase_pid</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span>
			<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if the device is PID and initialize it</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">hid_pidff_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pidff_device</span> <span class="o">*</span><span class="n">pidff</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hid_input</span> <span class="o">*</span><span class="n">hidinput</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">hid_input</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">hidinput</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ff_device</span> <span class="o">*</span><span class="n">ff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_effects</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">hid_dbg</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;starting pid init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">report_enum</span><span class="p">[</span><span class="n">HID_OUTPUT_REPORT</span><span class="p">].</span><span class="n">report_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hid_dbg</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;not a PID device, no output report</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pidff</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pidff</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pidff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">=</span> <span class="n">hid</span><span class="p">;</span>

	<span class="n">pidff_find_reports</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">HID_OUTPUT_REPORT</span><span class="p">,</span> <span class="n">pidff</span><span class="p">);</span>
	<span class="n">pidff_find_reports</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">HID_FEATURE_REPORT</span><span class="p">,</span> <span class="n">pidff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pidff_reports_ok</span><span class="p">(</span><span class="n">pidff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hid_dbg</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;reports not ok, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">pidff_init_fields</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">pidff_reset</span><span class="p">(</span><span class="n">pidff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FF_GAIN</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffbit</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pidff_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">device_gain</span><span class="p">[</span><span class="n">PID_DEVICE_GAIN_FIELD</span><span class="p">],</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="n">usbhid_submit_report</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">reports</span><span class="p">[</span><span class="n">PID_DEVICE_GAIN</span><span class="p">],</span>
				     <span class="n">USB_DIR_OUT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">pidff_check_autocenter</span><span class="p">(</span><span class="n">pidff</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">max_effects</span> <span class="o">=</span>
	    <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_maximum</span> <span class="o">-</span>
	    <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">block_load</span><span class="p">[</span><span class="n">PID_EFFECT_BLOCK_INDEX</span><span class="p">].</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_minimum</span> <span class="o">+</span>
	    <span class="mi">1</span><span class="p">;</span>
	<span class="n">hid_dbg</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;max effects is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_effects</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_effects</span> <span class="o">&gt;</span> <span class="n">PID_EFFECTS_MAX</span><span class="p">)</span>
		<span class="n">max_effects</span> <span class="o">=</span> <span class="n">PID_EFFECTS_MAX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">PID_SIMULTANEOUS_MAX</span><span class="p">].</span><span class="n">value</span><span class="p">)</span>
		<span class="n">hid_dbg</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;max simultaneous effects is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">PID_SIMULTANEOUS_MAX</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">PID_RAM_POOL_SIZE</span><span class="p">].</span><span class="n">value</span><span class="p">)</span>
		<span class="n">hid_dbg</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;device memory size is %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pidff</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">PID_RAM_POOL_SIZE</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pidff</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">PID_DEVICE_MANAGED_POOL</span><span class="p">].</span><span class="n">value</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pidff</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">PID_DEVICE_MANAGED_POOL</span><span class="p">].</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_notice</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span>
			   <span class="s">&quot;device does not support device managed pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">input_ff_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">max_effects</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ff</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ff</span><span class="p">;</span>
	<span class="n">ff</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">pidff</span><span class="p">;</span>
	<span class="n">ff</span><span class="o">-&gt;</span><span class="n">upload</span> <span class="o">=</span> <span class="n">pidff_upload_effect</span><span class="p">;</span>
	<span class="n">ff</span><span class="o">-&gt;</span><span class="n">erase</span> <span class="o">=</span> <span class="n">pidff_erase_effect</span><span class="p">;</span>
	<span class="n">ff</span><span class="o">-&gt;</span><span class="n">set_gain</span> <span class="o">=</span> <span class="n">pidff_set_gain</span><span class="p">;</span>
	<span class="n">ff</span><span class="o">-&gt;</span><span class="n">set_autocenter</span> <span class="o">=</span> <span class="n">pidff_set_autocenter</span><span class="p">;</span>
	<span class="n">ff</span><span class="o">-&gt;</span><span class="n">playback</span> <span class="o">=</span> <span class="n">pidff_playback</span><span class="p">;</span>

	<span class="n">hid_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Force feedback for USB HID PID devices by Anssi Hannula &lt;anssi.hannula@gmail.com&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pidff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
