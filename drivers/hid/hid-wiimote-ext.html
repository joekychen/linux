<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hid › hid-wiimote-ext.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>hid-wiimote-ext.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * HID driver for Nintendo Wiimote extension devices</span>
<span class="cm"> * Copyright (c) 2011 David Herrmann</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the Free</span>
<span class="cm"> * Software Foundation; either version 2 of the License, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &quot;hid-wiimote.h&quot;</span>

<span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiimote_data</span> <span class="o">*</span><span class="n">wdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">worker</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">mp_input</span><span class="p">;</span>

	<span class="n">atomic_t</span> <span class="n">opened</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">mp_opened</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">plugged</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">mp_plugged</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">motionp</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">ext_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">wiiext_type</span> <span class="p">{</span>
	<span class="n">WIIEXT_NONE</span><span class="p">,</span>		<span class="cm">/* placeholder */</span>
	<span class="n">WIIEXT_CLASSIC</span><span class="p">,</span>		<span class="cm">/* Nintendo classic controller */</span>
	<span class="n">WIIEXT_NUNCHUCK</span><span class="p">,</span>	<span class="cm">/* Nintendo nunchuck controller */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">wiiext_keys</span> <span class="p">{</span>
	<span class="n">WIIEXT_KEY_C</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_Z</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_A</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_B</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_X</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_Y</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_ZL</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_ZR</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_PLUS</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_MINUS</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_HOME</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_LEFT</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_RIGHT</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_UP</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_DOWN</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_LT</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_RT</span><span class="p">,</span>
	<span class="n">WIIEXT_KEY_COUNT</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__u16</span> <span class="n">wiiext_keymap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BTN_C</span><span class="p">,</span>		<span class="cm">/* WIIEXT_KEY_C */</span>
	<span class="n">BTN_Z</span><span class="p">,</span>		<span class="cm">/* WIIEXT_KEY_Z */</span>
	<span class="n">BTN_A</span><span class="p">,</span>		<span class="cm">/* WIIEXT_KEY_A */</span>
	<span class="n">BTN_B</span><span class="p">,</span>		<span class="cm">/* WIIEXT_KEY_B */</span>
	<span class="n">BTN_X</span><span class="p">,</span>		<span class="cm">/* WIIEXT_KEY_X */</span>
	<span class="n">BTN_Y</span><span class="p">,</span>		<span class="cm">/* WIIEXT_KEY_Y */</span>
	<span class="n">BTN_TL2</span><span class="p">,</span>	<span class="cm">/* WIIEXT_KEY_ZL */</span>
	<span class="n">BTN_TR2</span><span class="p">,</span>	<span class="cm">/* WIIEXT_KEY_ZR */</span>
	<span class="n">KEY_NEXT</span><span class="p">,</span>	<span class="cm">/* WIIEXT_KEY_PLUS */</span>
	<span class="n">KEY_PREVIOUS</span><span class="p">,</span>	<span class="cm">/* WIIEXT_KEY_MINUS */</span>
	<span class="n">BTN_MODE</span><span class="p">,</span>	<span class="cm">/* WIIEXT_KEY_HOME */</span>
	<span class="n">KEY_LEFT</span><span class="p">,</span>	<span class="cm">/* WIIEXT_KEY_LEFT */</span>
	<span class="n">KEY_RIGHT</span><span class="p">,</span>	<span class="cm">/* WIIEXT_KEY_RIGHT */</span>
	<span class="n">KEY_UP</span><span class="p">,</span>		<span class="cm">/* WIIEXT_KEY_UP */</span>
	<span class="n">KEY_DOWN</span><span class="p">,</span>	<span class="cm">/* WIIEXT_KEY_DOWN */</span>
	<span class="n">BTN_TL</span><span class="p">,</span>		<span class="cm">/* WIIEXT_KEY_LT */</span>
	<span class="n">BTN_TR</span><span class="p">,</span>		<span class="cm">/* WIIEXT_KEY_RT */</span>
<span class="p">};</span>

<span class="cm">/* diable all extensions */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="o">*</span><span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">wmem</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wiimote_cmd_acquire</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiimote_cmd_write</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">,</span> <span class="mh">0xa400f0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wmem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wmem</span><span class="p">));</span>
		<span class="n">wiimote_cmd_release</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">motionp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_type</span> <span class="o">=</span> <span class="n">WIIEXT_NONE</span><span class="p">;</span>
	<span class="n">wiiproto_req_drm</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">,</span> <span class="n">WIIPROTO_REQ_NULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">motionp_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="o">*</span><span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">rmem</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">wmem</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">avail</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_opened</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wiimote_cmd_acquire</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* initialize motion plus */</span>
	<span class="n">wmem</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wiimote_cmd_write</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">,</span> <span class="mh">0xa600f0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wmem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wmem</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* read motion plus ID */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wiimote_cmd_read</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">,</span> <span class="mh">0xa600fe</span><span class="p">,</span> <span class="n">rmem</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">rmem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x5</span><span class="p">)</span>
		<span class="n">avail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">wiimote_cmd_release</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">avail</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__u8</span> <span class="nf">ext_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="o">*</span><span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">rmem</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">wmem</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">WIIEXT_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">plugged</span> <span class="o">||</span> <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">WIIEXT_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wiimote_cmd_acquire</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">WIIEXT_NONE</span><span class="p">;</span>

	<span class="cm">/* initialize extension */</span>
	<span class="n">wmem</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wiimote_cmd_write</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">,</span> <span class="mh">0xa400f0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wmem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wmem</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable encryption */</span>
		<span class="n">wmem</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">wiimote_cmd_write</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">,</span> <span class="mh">0xa400fb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wmem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wmem</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* read extension ID */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wiimote_cmd_read</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">,</span> <span class="mh">0xa400fe</span><span class="p">,</span> <span class="n">rmem</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rmem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rmem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">WIIEXT_NUNCHUCK</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rmem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="n">rmem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">WIIEXT_CLASSIC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wiimote_cmd_release</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ext_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="o">*</span><span class="n">ext</span><span class="p">,</span> <span class="n">bool</span> <span class="n">motionp</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">ext_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">wmem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">motionp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wiimote_cmd_acquire</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ext_type</span> <span class="o">==</span> <span class="n">WIIEXT_CLASSIC</span><span class="p">)</span>
			<span class="n">wmem</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ext_type</span> <span class="o">==</span> <span class="n">WIIEXT_NUNCHUCK</span><span class="p">)</span>
			<span class="n">wmem</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">wmem</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wiimote_cmd_write</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">,</span> <span class="mh">0xa600fe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wmem</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wmem</span><span class="p">));</span>
		<span class="n">wiimote_cmd_release</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">motionp</span> <span class="o">=</span> <span class="n">motionp</span><span class="p">;</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_type</span> <span class="o">=</span> <span class="n">ext_type</span><span class="p">;</span>
	<span class="n">wiiproto_req_drm</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">,</span> <span class="n">WIIPROTO_REQ_NULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wiiext_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wiimote_ext</span><span class="p">,</span>
									<span class="n">worker</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">motionp</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">ext_type</span><span class="p">;</span>

	<span class="n">ext_disable</span><span class="p">(</span><span class="n">ext</span><span class="p">);</span>
	<span class="n">motionp</span> <span class="o">=</span> <span class="n">motionp_read</span><span class="p">(</span><span class="n">ext</span><span class="p">);</span>
	<span class="n">ext_type</span> <span class="o">=</span> <span class="n">ext_read</span><span class="p">(</span><span class="n">ext</span><span class="p">);</span>
	<span class="n">ext_enable</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">motionp</span><span class="p">,</span> <span class="n">ext_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* schedule work only once, otherwise mark for reschedule */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wiiext_schedule</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="o">*</span><span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">system_nrt_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">worker</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reacts on extension port events</span>
<span class="cm"> * Whenever the driver gets an event from the wiimote that an extension has been</span>
<span class="cm"> * plugged or unplugged, this funtion shall be called. It checks what extensions</span>
<span class="cm"> * are connected and initializes and activates them.</span>
<span class="cm"> * This can be called in atomic context. The initialization is done in a</span>
<span class="cm"> * separate worker thread. The state.lock spinlock must be held by the caller.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">wiiext_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiimote_data</span> <span class="o">*</span><span class="n">wdata</span><span class="p">,</span> <span class="n">bool</span> <span class="n">plugged</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">plugged</span> <span class="o">==</span> <span class="n">plugged</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wdata</span><span class="o">-&gt;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">plugged</span> <span class="o">=</span> <span class="n">plugged</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plugged</span><span class="p">)</span>
		<span class="n">wdata</span><span class="o">-&gt;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_plugged</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to call wiiext_schedule(wdata-&gt;ext) here, however, the</span>
<span class="cm">	 * extension initialization logic is not fully understood and so</span>
<span class="cm">	 * automatic initialization is not supported, yet.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns true if the current DRM mode should contain extension data and false</span>
<span class="cm"> * if there is no interest in extension data.</span>
<span class="cm"> * All supported extensions send 6 byte extension data so any DRM that contains</span>
<span class="cm"> * extension bytes is fine.</span>
<span class="cm"> * The caller must hold the state.lock spinlock.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">wiiext_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiimote_data</span> <span class="o">*</span><span class="n">wdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">motionp</span> <span class="o">||</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handler_motionp</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="o">*</span><span class="n">ext</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__s32</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">plugged</span><span class="p">;</span>

	<span class="cm">/*        |   8    7    6    5    4    3 |  2  |  1  |</span>
<span class="cm">	 *   -----+------------------------------+-----+-----+</span>
<span class="cm">	 *    1   |               Yaw Speed &lt;7:0&gt;            |</span>
<span class="cm">	 *    2   |              Roll Speed &lt;7:0&gt;            |</span>
<span class="cm">	 *    3   |             Pitch Speed &lt;7:0&gt;            |</span>
<span class="cm">	 *   -----+------------------------------+-----+-----+</span>
<span class="cm">	 *    4   |       Yaw Speed &lt;13:8&gt;       | Yaw |Pitch|</span>
<span class="cm">	 *   -----+------------------------------+-----+-----+</span>
<span class="cm">	 *    5   |      Roll Speed &lt;13:8&gt;       |Roll | Ext |</span>
<span class="cm">	 *   -----+------------------------------+-----+-----+</span>
<span class="cm">	 *    6   |     Pitch Speed &lt;13:8&gt;       |  1  |  0  |</span>
<span class="cm">	 *   -----+------------------------------+-----+-----+</span>
<span class="cm">	 * The single bits Yaw, Roll, Pitch in the lower right corner specify</span>
<span class="cm">	 * whether the wiimote is rotating fast (0) or slow (1). Speed for slow</span>
<span class="cm">	 * roation is 440 deg/s and for fast rotation 2000 deg/s. To get a</span>
<span class="cm">	 * linear scale we multiply by 2000/440 = ~4.5454 which is 18 for fast</span>
<span class="cm">	 * and 9 for slow.</span>
<span class="cm">	 * If the wiimote is not rotating the sensor reports 2^13 = 8192.</span>
<span class="cm">	 * Ext specifies whether an extension is connected to the motionp.</span>
<span class="cm">	 */</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">y</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">z</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">x</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">__u16</span><span class="p">)</span><span class="n">payload</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">;</span>
	<span class="n">y</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">__u16</span><span class="p">)</span><span class="n">payload</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">;</span>
	<span class="n">z</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">__u16</span><span class="p">)</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">-=</span> <span class="mi">8192</span><span class="p">;</span>
	<span class="n">y</span> <span class="o">-=</span> <span class="mi">8192</span><span class="p">;</span>
	<span class="n">z</span> <span class="o">-=</span> <span class="mi">8192</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span>
		<span class="n">x</span> <span class="o">*=</span> <span class="mi">18</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">x</span> <span class="o">*=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span>
		<span class="n">y</span> <span class="o">*=</span> <span class="mi">18</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">y</span> <span class="o">*=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
		<span class="n">z</span> <span class="o">*=</span> <span class="mi">18</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">z</span> <span class="o">*=</span> <span class="mi">9</span><span class="p">;</span>

	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="p">,</span> <span class="n">ABS_RX</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="p">,</span> <span class="n">ABS_RY</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="p">,</span> <span class="n">ABS_RZ</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
	<span class="n">input_sync</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="p">);</span>

	<span class="n">plugged</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plugged</span> <span class="o">!=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_plugged</span><span class="p">)</span>
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_plugged</span> <span class="o">=</span> <span class="n">plugged</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handler_nunchuck</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="o">*</span><span class="n">ext</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__s16</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">;</span>

	<span class="cm">/*   Byte |   8    7 |  6    5 |  4    3 |  2 |  1  |</span>
<span class="cm">	 *   -----+----------+---------+---------+----+-----+</span>
<span class="cm">	 *    1   |              Button X &lt;7:0&gt;             |</span>
<span class="cm">	 *    2   |              Button Y &lt;7:0&gt;             |</span>
<span class="cm">	 *   -----+----------+---------+---------+----+-----+</span>
<span class="cm">	 *    3   |               Speed X &lt;9:2&gt;             |</span>
<span class="cm">	 *    4   |               Speed Y &lt;9:2&gt;             |</span>
<span class="cm">	 *    5   |               Speed Z &lt;9:2&gt;             |</span>
<span class="cm">	 *   -----+----------+---------+---------+----+-----+</span>
<span class="cm">	 *    6   | Z &lt;1:0&gt;  | Y &lt;1:0&gt; | X &lt;1:0&gt; | BC | BZ  |</span>
<span class="cm">	 *   -----+----------+---------+---------+----+-----+</span>
<span class="cm">	 * Button X/Y is the analog stick. Speed X, Y and Z are the</span>
<span class="cm">	 * accelerometer data in the same format as the wiimote&#39;s accelerometer.</span>
<span class="cm">	 * The 6th byte contains the LSBs of the accelerometer data.</span>
<span class="cm">	 * BC and BZ are the C and Z buttons: 0 means pressed</span>
<span class="cm">	 *</span>
<span class="cm">	 * If reported interleaved with motionp, then the layout changes. The</span>
<span class="cm">	 * 5th and 6th byte changes to:</span>
<span class="cm">	 *   -----+-----------------------------------+-----+</span>
<span class="cm">	 *    5   |            Speed Z &lt;9:3&gt;          | EXT |</span>
<span class="cm">	 *   -----+--------+-----+-----+----+----+----+-----+</span>
<span class="cm">	 *    6   |Z &lt;2:1&gt; |Y &lt;1&gt;|X &lt;1&gt;| BC | BZ | 0  |  0  |</span>
<span class="cm">	 *   -----+--------+-----+-----+----+----+----+-----+</span>
<span class="cm">	 * All three accelerometer values lose their LSB. The other data is</span>
<span class="cm">	 * still available but slightly moved.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Center data for button values is 128. Center value for accelerometer</span>
<span class="cm">	 * values it 512 / 0x200</span>
<span class="cm">	 */</span>

	<span class="n">bx</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">by</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">bx</span> <span class="o">-=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">by</span> <span class="o">-=</span> <span class="mi">128</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">y</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">z</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">motionp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span> <span class="o">|=</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">y</span> <span class="o">|=</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">z</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x4</span><span class="p">;</span>
		<span class="n">z</span> <span class="o">|=</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">x</span> <span class="o">|=</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="n">y</span> <span class="o">|=</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="n">z</span> <span class="o">|=</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">x</span> <span class="o">-=</span> <span class="mh">0x200</span><span class="p">;</span>
	<span class="n">y</span> <span class="o">-=</span> <span class="mh">0x200</span><span class="p">;</span>
	<span class="n">z</span> <span class="o">-=</span> <span class="mh">0x200</span><span class="p">;</span>

	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_HAT0X</span><span class="p">,</span> <span class="n">bx</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_HAT0Y</span><span class="p">,</span> <span class="n">by</span><span class="p">);</span>

	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_RX</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_RY</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_RZ</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">motionp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span>
			<span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_Z</span><span class="p">],</span> <span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">));</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span>
			<span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_C</span><span class="p">],</span> <span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span>
			<span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_Z</span><span class="p">],</span> <span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span>
			<span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_C</span><span class="p">],</span> <span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">input_sync</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handler_classic</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="o">*</span><span class="n">ext</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__s8</span> <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">lx</span><span class="p">,</span> <span class="n">ly</span><span class="p">,</span> <span class="n">lt</span><span class="p">,</span> <span class="n">rt</span><span class="p">;</span>

	<span class="cm">/*   Byte |  8  |  7  |  6  |  5  |  4  |  3  |  2  |  1  |</span>
<span class="cm">	 *   -----+-----+-----+-----+-----+-----+-----+-----+-----+</span>
<span class="cm">	 *    1   | RX &lt;5:4&gt;  |              LX &lt;5:0&gt;             |</span>
<span class="cm">	 *    2   | RX &lt;3:2&gt;  |              LY &lt;5:0&gt;             |</span>
<span class="cm">	 *   -----+-----+-----+-----+-----------------------------+</span>
<span class="cm">	 *    3   |RX&lt;1&gt;| LT &lt;5:4&gt;  |         RY &lt;5:1&gt;            |</span>
<span class="cm">	 *   -----+-----+-----------+-----------------------------+</span>
<span class="cm">	 *    4   |     LT &lt;3:1&gt;    |         RT &lt;5:1&gt;            |</span>
<span class="cm">	 *   -----+-----+-----+-----+-----+-----+-----+-----+-----+</span>
<span class="cm">	 *    5   | BDR | BDD | BLT | B-  | BH  | B+  | BRT |  1  |</span>
<span class="cm">	 *   -----+-----+-----+-----+-----+-----+-----+-----+-----+</span>
<span class="cm">	 *    6   | BZL | BB  | BY  | BA  | BX  | BZR | BDL | BDU |</span>
<span class="cm">	 *   -----+-----+-----+-----+-----+-----+-----+-----+-----+</span>
<span class="cm">	 * All buttons are 0 if pressed</span>
<span class="cm">	 * RX and RY are right analog stick</span>
<span class="cm">	 * LX and LY are left analog stick</span>
<span class="cm">	 * LT is left trigger, RT is right trigger</span>
<span class="cm">	 * BLT is 0 if left trigger is fully pressed</span>
<span class="cm">	 * BRT is 0 if right trigger is fully pressed</span>
<span class="cm">	 * BDR, BDD, BDL, BDU form the D-Pad with right, down, left, up buttons</span>
<span class="cm">	 * BZL is left Z button and BZR is right Z button</span>
<span class="cm">	 * B-, BH, B+ are +, HOME and - buttons</span>
<span class="cm">	 * BB, BY, BA, BX are A, B, X, Y buttons</span>
<span class="cm">	 * LSB of RX, RY, LT, and RT are not transmitted and always 0.</span>
<span class="cm">	 *</span>
<span class="cm">	 * With motionp enabled it changes slightly to this:</span>
<span class="cm">	 *   Byte |  8  |  7  |  6  |  5  |  4  |  3  |  2  |  1  |</span>
<span class="cm">	 *   -----+-----+-----+-----+-----+-----+-----+-----+-----+</span>
<span class="cm">	 *    1   | RX &lt;4:3&gt;  |          LX &lt;5:1&gt;           | BDU |</span>
<span class="cm">	 *    2   | RX &lt;2:1&gt;  |          LY &lt;5:1&gt;           | BDL |</span>
<span class="cm">	 *   -----+-----+-----+-----+-----------------------+-----+</span>
<span class="cm">	 *    3   |RX&lt;0&gt;| LT &lt;4:3&gt;  |         RY &lt;4:0&gt;            |</span>
<span class="cm">	 *   -----+-----+-----------+-----------------------------+</span>
<span class="cm">	 *    4   |     LT &lt;2:0&gt;    |         RT &lt;4:0&gt;            |</span>
<span class="cm">	 *   -----+-----+-----+-----+-----+-----+-----+-----+-----+</span>
<span class="cm">	 *    5   | BDR | BDD | BLT | B-  | BH  | B+  | BRT | EXT |</span>
<span class="cm">	 *   -----+-----+-----+-----+-----+-----+-----+-----+-----+</span>
<span class="cm">	 *    6   | BZL | BB  | BY  | BA  | BX  | BZR |  0  |  0  |</span>
<span class="cm">	 *   -----+-----+-----+-----+-----+-----+-----+-----+-----+</span>
<span class="cm">	 * Only the LSBs of LX and LY are lost. BDU and BDL are moved, the rest</span>
<span class="cm">	 * is the same as before.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">motionp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lx</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3e</span><span class="p">;</span>
		<span class="n">ly</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3e</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lx</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">ly</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rx</span> <span class="o">=</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x14</span><span class="p">;</span>
	<span class="n">rx</span> <span class="o">|=</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x06</span><span class="p">;</span>
	<span class="n">rx</span> <span class="o">|=</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">ry</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>

	<span class="n">rt</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">lt</span> <span class="o">=</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">;</span>
	<span class="n">lt</span> <span class="o">|=</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>

	<span class="n">rx</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ry</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rt</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lt</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_HAT1X</span><span class="p">,</span> <span class="n">lx</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_HAT1Y</span><span class="p">,</span> <span class="n">ly</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_HAT2X</span><span class="p">,</span> <span class="n">rx</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_HAT2Y</span><span class="p">,</span> <span class="n">ry</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_HAT3X</span><span class="p">,</span> <span class="n">rt</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_HAT3Y</span><span class="p">,</span> <span class="n">lt</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_RIGHT</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">));</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_DOWN</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">));</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_LT</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">));</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_MINUS</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">));</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_HOME</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">));</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_PLUS</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">));</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_RT</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">));</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_ZL</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">));</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_B</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">));</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_Y</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">));</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_A</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">));</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_X</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">));</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_ZR</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">motionp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_UP</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_LEFT</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_UP</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">WIIEXT_KEY_LEFT</span><span class="p">],</span>
							<span class="o">!!</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">input_sync</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* call this with state.lock spinlock held */</span>
<span class="kt">void</span> <span class="nf">wiiext_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiimote_data</span> <span class="o">*</span><span class="n">wdata</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">motionp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">handler_motionp</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_type</span> <span class="o">==</span> <span class="n">WIIEXT_NUNCHUCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handler_nunchuck</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_type</span> <span class="o">==</span> <span class="n">WIIEXT_CLASSIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handler_classic</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">wiiext_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
								<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiimote_data</span> <span class="o">*</span><span class="n">wdata</span> <span class="o">=</span> <span class="n">dev_to_wii</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">__u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">WIIEXT_NONE</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">motionp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">motionp</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">motionp</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_type</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">WIIEXT_NUNCHUCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">motionp</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;motionp+nunchuck</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;nunchuck</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">WIIEXT_CLASSIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">motionp</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;motionp+classic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;classic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">motionp</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;motionp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">wiiext_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wiiext_input_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hid_hw_open</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">);</span>
	<span class="n">wiiext_schedule</span><span class="p">(</span><span class="n">ext</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wiiext_input_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">);</span>
	<span class="n">wiiext_schedule</span><span class="p">(</span><span class="n">ext</span><span class="p">);</span>
	<span class="n">hid_hw_close</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wiiext_mp_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hid_hw_open</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_opened</span><span class="p">);</span>
	<span class="n">wiiext_schedule</span><span class="p">(</span><span class="n">ext</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wiiext_mp_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_opened</span><span class="p">);</span>
	<span class="n">wiiext_schedule</span><span class="p">(</span><span class="n">ext</span><span class="p">);</span>
	<span class="n">hid_hw_close</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Initializes the extension driver of a wiimote */</span>
<span class="kt">int</span> <span class="nf">wiiext_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiimote_data</span> <span class="o">*</span><span class="n">wdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="o">*</span><span class="n">ext</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ext</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ext</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">wdata</span> <span class="o">=</span> <span class="n">wdata</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">worker</span><span class="p">,</span> <span class="n">wiiext_worker</span><span class="p">);</span>

	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_input</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ext</span><span class="p">);</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">wiiext_input_open</span><span class="p">;</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">wiiext_input_close</span><span class="p">;</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">;</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">WIIMOTE_NAME</span> <span class="s">&quot; Extension&quot;</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WIIEXT_KEY_COUNT</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">wiiext_keymap</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ABS_HAT0X</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ABS_HAT0Y</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ABS_HAT1X</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ABS_HAT1Y</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ABS_HAT2X</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ABS_HAT2Y</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ABS_HAT3X</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ABS_HAT3Y</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_HAT0X</span><span class="p">,</span> <span class="o">-</span><span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_HAT0Y</span><span class="p">,</span> <span class="o">-</span><span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_HAT1X</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_HAT1Y</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_HAT2X</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_HAT2Y</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_HAT3X</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_HAT3Y</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ABS_RX</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ABS_RY</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ABS_RZ</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_RX</span><span class="p">,</span> <span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_RY</span><span class="p">,</span> <span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_RZ</span><span class="p">,</span> <span class="o">-</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_free_device</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_input</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_mp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="p">,</span> <span class="n">ext</span><span class="p">);</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">wiiext_mp_open</span><span class="p">;</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">wiiext_mp_close</span><span class="p">;</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">;</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">WIIMOTE_NAME</span> <span class="s">&quot; Motion+&quot;</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ABS_RX</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ABS_RY</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ABS_RZ</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="p">,</span> <span class="n">ABS_RX</span><span class="p">,</span> <span class="o">-</span><span class="mi">160000</span><span class="p">,</span> <span class="mi">160000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="p">,</span> <span class="n">ABS_RY</span><span class="p">,</span> <span class="o">-</span><span class="mi">160000</span><span class="p">,</span> <span class="mi">160000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="p">,</span> <span class="n">ABS_RZ</span><span class="p">,</span> <span class="o">-</span><span class="mi">160000</span><span class="p">,</span> <span class="mi">160000</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_free_device</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_mp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_extension</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_dev</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wdata</span><span class="o">-&gt;</span><span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_dev:</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="p">);</span>
<span class="nl">err_mp:</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
<span class="nl">err_input:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ext</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Deinitializes the extension driver of a wiimote */</span>
<span class="kt">void</span> <span class="nf">wiiext_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiimote_data</span> <span class="o">*</span><span class="n">wdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiimote_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="n">wdata</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ext</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We first unset wdata-&gt;ext to avoid further input from the wiimote</span>
<span class="cm">	 * core. The worker thread does not access this pointer so it is not</span>
<span class="cm">	 * affected by this.</span>
<span class="cm">	 * We kill the worker after this so it does not get respawned during</span>
<span class="cm">	 * deinitialization.</span>
<span class="cm">	 */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wdata</span><span class="o">-&gt;</span><span class="n">ext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wdata</span><span class="o">-&gt;</span><span class="n">hdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_extension</span><span class="p">);</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">mp_input</span><span class="p">);</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">worker</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ext</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
