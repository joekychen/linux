<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › hid › hid-input.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>hid-input.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (c) 2000-2001 Vojtech Pavlik</span>
<span class="cm"> *  Copyright (c) 2006-2010 Jiri Kosina</span>
<span class="cm"> *</span>
<span class="cm"> *  HID to Linux Input mapping</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> * Should you need to contact me, the author, you can do so either by</span>
<span class="cm"> * e-mail - mail your message to &lt;vojtech@ucw.cz&gt;, or by paper mail:</span>
<span class="cm"> * Vojtech Pavlik, Simunkova 1594, Prague 8, 182 00 Czech Republic</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>

<span class="cp">#include &lt;linux/hid.h&gt;</span>
<span class="cp">#include &lt;linux/hid-debug.h&gt;</span>

<span class="cp">#include &quot;hid-ids.h&quot;</span>

<span class="cp">#define unk	KEY_UNKNOWN</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hid_keyboard</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span>
	 <span class="mi">50</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>
	  <span class="mi">4</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span>
	 <span class="mi">27</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span>
	 <span class="mi">65</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">107</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span>
	<span class="mi">105</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">103</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span>
	 <span class="mi">72</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mi">117</span><span class="p">,</span><span class="mi">183</span><span class="p">,</span><span class="mi">184</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">186</span><span class="p">,</span><span class="mi">187</span><span class="p">,</span><span class="mi">188</span><span class="p">,</span><span class="mi">189</span><span class="p">,</span><span class="mi">190</span><span class="p">,</span>
	<span class="mi">191</span><span class="p">,</span><span class="mi">192</span><span class="p">,</span><span class="mi">193</span><span class="p">,</span><span class="mi">194</span><span class="p">,</span><span class="mi">134</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mi">130</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">129</span><span class="p">,</span><span class="mi">131</span><span class="p">,</span><span class="mi">137</span><span class="p">,</span><span class="mi">133</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mi">136</span><span class="p">,</span><span class="mi">113</span><span class="p">,</span>
	<span class="mi">115</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span><span class="mi">124</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span>
	<span class="mi">122</span><span class="p">,</span><span class="mi">123</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span>
	<span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span>
	<span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="mi">179</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span>
	<span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span>
	<span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span>
	 <span class="mi">29</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span><span class="mi">125</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">126</span><span class="p">,</span><span class="mi">164</span><span class="p">,</span><span class="mi">166</span><span class="p">,</span><span class="mi">165</span><span class="p">,</span><span class="mi">163</span><span class="p">,</span><span class="mi">161</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">113</span><span class="p">,</span>
	<span class="mi">150</span><span class="p">,</span><span class="mi">158</span><span class="p">,</span><span class="mi">159</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">136</span><span class="p">,</span><span class="mi">177</span><span class="p">,</span><span class="mi">178</span><span class="p">,</span><span class="mi">176</span><span class="p">,</span><span class="mi">142</span><span class="p">,</span><span class="mi">152</span><span class="p">,</span><span class="mi">173</span><span class="p">,</span><span class="mi">140</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span><span class="p">,</span><span class="n">unk</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">__s32</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span>  <span class="n">hid_hat_to_axis</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">}};</span>

<span class="cp">#define map_abs(c)	hid_map_usage(hidinput, usage, &amp;bit, &amp;max, EV_ABS, (c))</span>
<span class="cp">#define map_rel(c)	hid_map_usage(hidinput, usage, &amp;bit, &amp;max, EV_REL, (c))</span>
<span class="cp">#define map_key(c)	hid_map_usage(hidinput, usage, &amp;bit, &amp;max, EV_KEY, (c))</span>
<span class="cp">#define map_led(c)	hid_map_usage(hidinput, usage, &amp;bit, &amp;max, EV_LED, (c))</span>

<span class="cp">#define map_abs_clear(c)	hid_map_usage_clear(hidinput, usage, &amp;bit, \</span>
<span class="cp">		&amp;max, EV_ABS, (c))</span>
<span class="cp">#define map_key_clear(c)	hid_map_usage_clear(hidinput, usage, &amp;bit, \</span>
<span class="cp">		&amp;max, EV_KEY, (c))</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">match_scancode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_usage</span> <span class="o">*</span><span class="n">usage</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scancode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HID_USAGE_PAGE</span> <span class="o">|</span> <span class="n">HID_USAGE</span><span class="p">))</span> <span class="o">==</span> <span class="n">scancode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">match_keycode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_usage</span> <span class="o">*</span><span class="n">usage</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keycode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We should exclude unmapped usages when doing lookup by keycode.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_KEY</span> <span class="o">&amp;&amp;</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">keycode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">match_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_usage</span> <span class="o">*</span><span class="n">usage</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cur_idx</span> <span class="o">==</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="n">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">hid_usage_cmp_t</span><span class="p">)(</span><span class="k">struct</span> <span class="n">hid_usage</span> <span class="o">*</span><span class="n">usage</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hid_usage</span> <span class="o">*</span><span class="nf">hidinput_find_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span><span class="p">,</span>
					   <span class="n">hid_usage_cmp_t</span> <span class="n">match</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">usage_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">cur_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hid_usage</span> <span class="o">*</span><span class="n">usage</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">HID_INPUT_REPORT</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">HID_OUTPUT_REPORT</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">report_enum</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">report_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">maxusage</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">usage</span> <span class="o">=</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">usage</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_KEY</span> <span class="o">||</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">(</span><span class="n">usage</span><span class="p">,</span> <span class="n">cur_idx</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">usage_idx</span><span class="p">)</span>
								<span class="o">*</span><span class="n">usage_idx</span> <span class="o">=</span> <span class="n">cur_idx</span><span class="p">;</span>
							<span class="k">return</span> <span class="n">usage</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">cur_idx</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hid_usage</span> <span class="o">*</span><span class="nf">hidinput_locate_usage</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">input_keymap_entry</span> <span class="o">*</span><span class="n">ke</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_usage</span> <span class="o">*</span><span class="n">usage</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scancode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ke</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">INPUT_KEYMAP_BY_INDEX</span><span class="p">)</span>
		<span class="n">usage</span> <span class="o">=</span> <span class="n">hidinput_find_key</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">match_index</span><span class="p">,</span> <span class="n">ke</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">input_scancode_to_scalar</span><span class="p">(</span><span class="n">ke</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scancode</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">usage</span> <span class="o">=</span> <span class="n">hidinput_find_key</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">match_scancode</span><span class="p">,</span> <span class="n">scancode</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">usage</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">usage</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hidinput_getkeycode</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">input_keymap_entry</span> <span class="o">*</span><span class="n">ke</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hid_usage</span> <span class="o">*</span><span class="n">usage</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scancode</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">usage</span> <span class="o">=</span> <span class="n">hidinput_locate_usage</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ke</span><span class="o">-&gt;</span><span class="n">keycode</span> <span class="o">=</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_KEY</span> <span class="o">?</span>
				<span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">:</span> <span class="n">KEY_RESERVED</span><span class="p">;</span>
		<span class="n">ke</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">scancode</span> <span class="o">=</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HID_USAGE_PAGE</span> <span class="o">|</span> <span class="n">HID_USAGE</span><span class="p">);</span>
		<span class="n">ke</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scancode</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ke</span><span class="o">-&gt;</span><span class="n">scancode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scancode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scancode</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hidinput_setkeycode</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">input_keymap_entry</span> <span class="o">*</span><span class="n">ke</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">old_keycode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hid_usage</span> <span class="o">*</span><span class="n">usage</span><span class="p">;</span>

	<span class="n">usage</span> <span class="o">=</span> <span class="n">hidinput_locate_usage</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">old_keycode</span> <span class="o">=</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_KEY</span> <span class="o">?</span>
				<span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">:</span> <span class="n">KEY_RESERVED</span><span class="p">;</span>
		<span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">ke</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">;</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="o">*</span><span class="n">old_keycode</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">dbg_hid</span><span class="p">(</span><span class="s">&quot;Assigned keycode %d to HID usage code %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set the keybit for the old keycode if the old keycode is used</span>
<span class="cm">		 * by another key</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hidinput_find_key</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">match_keycode</span><span class="p">,</span> <span class="o">*</span><span class="n">old_keycode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="o">*</span><span class="n">old_keycode</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * hidinput_calc_abs_res - calculate an absolute axis resolution</span>
<span class="cm"> * @field: the HID report field to calculate resolution for</span>
<span class="cm"> * @code: axis code</span>
<span class="cm"> *</span>
<span class="cm"> * The formula is:</span>
<span class="cm"> *                         (logical_maximum - logical_minimum)</span>
<span class="cm"> * resolution = ----------------------------------------------------------</span>
<span class="cm"> *              (physical_maximum - physical_minimum) * 10 ^ unit_exponent</span>
<span class="cm"> *</span>
<span class="cm"> * as seen in the HID specification v1.11 6.2.2.7 Global Items.</span>
<span class="cm"> *</span>
<span class="cm"> * Only exponent 1 length units are processed. Centimeters and inches are</span>
<span class="cm"> * converted to millimeters. Degrees are converted to radians.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__s32</span> <span class="nf">hidinput_calc_abs_res</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">field</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__s32</span> <span class="n">unit_exponent</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">unit_exponent</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">logical_extents</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_maximum</span> <span class="o">-</span>
					<span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_minimum</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">physical_extents</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">physical_maximum</span> <span class="o">-</span>
					<span class="n">field</span><span class="o">-&gt;</span><span class="n">physical_minimum</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">prev</span><span class="p">;</span>

	<span class="cm">/* Check if the extents are sane */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">logical_extents</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">physical_extents</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Verify and convert units.</span>
<span class="cm">	 * See HID specification v1.11 6.2.2.7 Global Items for unit decoding</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ABS_X</span>:
	<span class="k">case</span> <span class="n">ABS_Y</span>:
	<span class="k">case</span> <span class="n">ABS_Z</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* If centimeters */</span>
			<span class="cm">/* Convert to millimeters */</span>
			<span class="n">unit_exponent</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">==</span> <span class="mh">0x13</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* If inches */</span>
			<span class="cm">/* Convert to millimeters */</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="n">physical_extents</span><span class="p">;</span>
			<span class="n">physical_extents</span> <span class="o">*=</span> <span class="mi">254</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">physical_extents</span> <span class="o">&lt;</span> <span class="n">prev</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">unit_exponent</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ABS_RX</span>:
	<span class="k">case</span> <span class="n">ABS_RY</span>:
	<span class="k">case</span> <span class="n">ABS_RZ</span>:
	<span class="k">case</span> <span class="n">ABS_TILT_X</span>:
	<span class="k">case</span> <span class="n">ABS_TILT_Y</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">==</span> <span class="mh">0x14</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* If degrees */</span>
			<span class="cm">/* Convert to radians */</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="n">logical_extents</span><span class="p">;</span>
			<span class="n">logical_extents</span> <span class="o">*=</span> <span class="mi">573</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">logical_extents</span> <span class="o">&lt;</span> <span class="n">prev</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">unit_exponent</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">!=</span> <span class="mh">0x12</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* If not radians */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Apply negative unit exponent */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">unit_exponent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">unit_exponent</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">logical_extents</span><span class="p">;</span>
		<span class="n">logical_extents</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">logical_extents</span> <span class="o">&lt;</span> <span class="n">prev</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Apply positive unit exponent */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">unit_exponent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">unit_exponent</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">physical_extents</span><span class="p">;</span>
		<span class="n">physical_extents</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">physical_extents</span> <span class="o">&lt;</span> <span class="n">prev</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate resolution */</span>
	<span class="k">return</span> <span class="n">logical_extents</span> <span class="o">/</span> <span class="n">physical_extents</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HID_BATTERY_STRENGTH</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">hidinput_battery_props</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">POWER_SUPPLY_PROP_PRESENT</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_ONLINE</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CAPACITY</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_MODEL_NAME</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_STATUS</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_SCOPE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define HID_BATTERY_QUIRK_PERCENT	(1 &lt;&lt; 0) </span><span class="cm">/* always reports percent */</span><span class="cp"></span>
<span class="cp">#define HID_BATTERY_QUIRK_FEATURE	(1 &lt;&lt; 1) </span><span class="cm">/* ask for feature report */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hid_device_id</span> <span class="n">hid_battery_quirks</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">HID_BLUETOOTH_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_APPLE</span><span class="p">,</span>
			       <span class="n">USB_DEVICE_ID_APPLE_ALU_WIRELESS_2011_ANSI</span><span class="p">),</span>
	  <span class="n">HID_BATTERY_QUIRK_PERCENT</span> <span class="o">|</span> <span class="n">HID_BATTERY_QUIRK_FEATURE</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">find_battery_quirk</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">quirks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hid_device_id</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>

	<span class="n">match</span> <span class="o">=</span> <span class="n">hid_match_id</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">hid_battery_quirks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">quirks</span> <span class="o">=</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">quirks</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hidinput_get_battery_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">prop</span><span class="p">,</span>
					 <span class="k">union</span> <span class="n">power_supply_propval</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">psy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_device</span><span class="p">,</span> <span class="n">battery</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_PRESENT</span>:
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_ONLINE</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CAPACITY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hid_get_raw_report</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery_report_id</span><span class="p">,</span>
					      <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span>
					      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery_report_type</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery_min</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery_max</span> <span class="o">&amp;&amp;</span>
		    <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery_min</span> <span class="o">&amp;&amp;</span>
		    <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery_max</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery_min</span><span class="p">))</span> <span class="o">/</span>
				<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery_max</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery_min</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_MODEL_NAME</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">strval</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_STATUS</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_STATUS_DISCHARGING</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_SCOPE</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_SCOPE_DEVICE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">hidinput_setup_battery</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">report_type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">battery</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">quirks</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">!=</span> <span class="n">HID_DC_BATTERYSTRENGTH</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* no match */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">battery</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>	<span class="cm">/* already initialized? */</span>

	<span class="n">battery</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">kasprintf</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="s">&quot;hid-%s-battery&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">uniq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">battery</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">battery</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span><span class="p">;</span>
	<span class="n">battery</span><span class="o">-&gt;</span><span class="n">properties</span> <span class="o">=</span> <span class="n">hidinput_battery_props</span><span class="p">;</span>
	<span class="n">battery</span><span class="o">-&gt;</span><span class="n">num_properties</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hidinput_battery_props</span><span class="p">);</span>
	<span class="n">battery</span><span class="o">-&gt;</span><span class="n">use_for_apm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">battery</span><span class="o">-&gt;</span><span class="n">get_property</span> <span class="o">=</span> <span class="n">hidinput_get_battery_property</span><span class="p">;</span>

	<span class="n">quirks</span> <span class="o">=</span> <span class="n">find_battery_quirk</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hid_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;device %x:%x:%x %d quirks %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">quirks</span><span class="p">);</span>

	<span class="n">min</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_minimum</span><span class="p">;</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_maximum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">HID_BATTERY_QUIRK_PERCENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">max</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">HID_BATTERY_QUIRK_FEATURE</span><span class="p">)</span>
		<span class="n">report_type</span> <span class="o">=</span> <span class="n">HID_FEATURE_REPORT</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery_min</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery_max</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery_report_type</span> <span class="o">=</span> <span class="n">report_type</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery_report_id</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">power_supply_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">battery</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hid_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t register power supply: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">battery</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">battery</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">power_supply_powers</span><span class="p">(</span><span class="n">battery</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hidinput_cleanup_battery</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">power_supply_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else  </span><span class="cm">/* !CONFIG_HID_BATTERY_STRENGTH */</span><span class="cp"></span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">hidinput_setup_battery</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">report_type</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hidinput_cleanup_battery</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_HID_BATTERY_STRENGTH */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hidinput_configure_usage</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_input</span> <span class="o">*</span><span class="n">hidinput</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">field</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">hid_usage</span> <span class="o">*</span><span class="n">usage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="n">hidinput</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">code</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bit</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">field</span><span class="o">-&gt;</span><span class="n">hidinput</span> <span class="o">=</span> <span class="n">hidinput</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HID_MAIN_ITEM_CONSTANT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>

	<span class="cm">/* only LED usages are supported in output fields */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">report_type</span> <span class="o">==</span> <span class="n">HID_OUTPUT_REPORT</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="n">HID_USAGE_PAGE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HID_UP_LED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">input_mapping</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">input_mapping</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">hidinput</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span>
				<span class="n">usage</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">mapped</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="n">HID_USAGE_PAGE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HID_UP_UNDEFINED</span>:
		<span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HID_UP_KEYBOARD</span>:
		<span class="n">set_bit</span><span class="p">(</span><span class="n">EV_REP</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="n">HID_USAGE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hid_keyboard</span><span class="p">[</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="n">HID_USAGE</span><span class="p">])</span> <span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>
			<span class="n">map_key_clear</span><span class="p">(</span><span class="n">hid_keyboard</span><span class="p">[</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="n">HID_USAGE</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">map_key</span><span class="p">(</span><span class="n">KEY_UNKNOWN</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HID_UP_BUTTON</span>:
		<span class="n">code</span> <span class="o">=</span> <span class="p">((</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HID_USAGE</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">application</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HID_GD_MOUSE</span>:
		<span class="k">case</span> <span class="n">HID_GD_POINTER</span>:  <span class="n">code</span> <span class="o">+=</span> <span class="n">BTN_MOUSE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HID_GD_JOYSTICK</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">&lt;=</span> <span class="mh">0xf</span><span class="p">)</span>
					<span class="n">code</span> <span class="o">+=</span> <span class="n">BTN_JOYSTICK</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">code</span> <span class="o">+=</span> <span class="n">BTN_TRIGGER_HAPPY</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HID_GD_GAMEPAD</span>:  <span class="n">code</span> <span class="o">+=</span> <span class="n">BTN_GAMEPAD</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">physical</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">HID_GD_MOUSE</span>:
			<span class="k">case</span> <span class="n">HID_GD_POINTER</span>:  <span class="n">code</span> <span class="o">+=</span> <span class="n">BTN_MOUSE</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HID_GD_JOYSTICK</span>: <span class="n">code</span> <span class="o">+=</span> <span class="n">BTN_JOYSTICK</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HID_GD_GAMEPAD</span>:  <span class="n">code</span> <span class="o">+=</span> <span class="n">BTN_GAMEPAD</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>              <span class="n">code</span> <span class="o">+=</span> <span class="n">BTN_MISC</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">map_key</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HID_UP_SIMULATION</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0xba</span>: <span class="n">map_abs</span><span class="p">(</span><span class="n">ABS_RUDDER</span><span class="p">);</span>   <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xbb</span>: <span class="n">map_abs</span><span class="p">(</span><span class="n">ABS_THROTTLE</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xc4</span>: <span class="n">map_abs</span><span class="p">(</span><span class="n">ABS_GAS</span><span class="p">);</span>      <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xc5</span>: <span class="n">map_abs</span><span class="p">(</span><span class="n">ABS_BRAKE</span><span class="p">);</span>    <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xc8</span>: <span class="n">map_abs</span><span class="p">(</span><span class="n">ABS_WHEEL</span><span class="p">);</span>    <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>   <span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HID_UP_GENDESK</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* SystemControl */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x1</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_POWER</span><span class="p">);</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x2</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SLEEP</span><span class="p">);</span>  <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x3</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_WAKEUP</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x4</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_CONTEXT_MENU</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x5</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_MENU</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x6</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_PROG1</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x7</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_HELP</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x8</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_EXIT</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x9</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SELECT</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0xa</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_RIGHT</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0xb</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_LEFT</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0xc</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_UP</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0xd</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_DOWN</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0xe</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_POWER2</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0xf</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_RESTART</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span> <span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x90</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* D-pad */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">HID_GD_UP</span>:	   <span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HID_GD_DOWN</span>:  <span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_dir</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HID_GD_RIGHT</span>: <span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_dir</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HID_GD_LEFT</span>:  <span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_dir</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span> <span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">dpad</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">map_abs</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">dpad</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">map_abs</span><span class="p">(</span><span class="n">ABS_HAT0X</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* These usage IDs map directly to the usage codes. */</span>
		<span class="k">case</span> <span class="n">HID_GD_X</span>: <span class="k">case</span> <span class="n">HID_GD_Y</span>: <span class="k">case</span> <span class="n">HID_GD_Z</span>:
		<span class="k">case</span> <span class="n">HID_GD_RX</span>: <span class="k">case</span> <span class="n">HID_GD_RY</span>: <span class="k">case</span> <span class="n">HID_GD_RZ</span>:
		<span class="k">case</span> <span class="n">HID_GD_SLIDER</span>: <span class="k">case</span> <span class="n">HID_GD_DIAL</span>: <span class="k">case</span> <span class="n">HID_GD_WHEEL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HID_MAIN_ITEM_RELATIVE</span><span class="p">)</span>
				<span class="n">map_rel</span><span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">map_abs</span><span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HID_GD_HATSWITCH</span>:
			<span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_min</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_minimum</span><span class="p">;</span>
			<span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_max</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_maximum</span><span class="p">;</span>
			<span class="n">map_abs</span><span class="p">(</span><span class="n">ABS_HAT0X</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HID_GD_START</span>:	<span class="n">map_key_clear</span><span class="p">(</span><span class="n">BTN_START</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HID_GD_SELECT</span>:	<span class="n">map_key_clear</span><span class="p">(</span><span class="n">BTN_SELECT</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span> <span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HID_UP_LED</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>		      <span class="cm">/* HID-Value:                   */</span>
		<span class="k">case</span> <span class="mh">0x01</span>:  <span class="n">map_led</span> <span class="p">(</span><span class="n">LED_NUML</span><span class="p">);</span>     <span class="k">break</span><span class="p">;</span>    <span class="cm">/*   &quot;Num Lock&quot;                 */</span>
		<span class="k">case</span> <span class="mh">0x02</span>:  <span class="n">map_led</span> <span class="p">(</span><span class="n">LED_CAPSL</span><span class="p">);</span>    <span class="k">break</span><span class="p">;</span>    <span class="cm">/*   &quot;Caps Lock&quot;                */</span>
		<span class="k">case</span> <span class="mh">0x03</span>:  <span class="n">map_led</span> <span class="p">(</span><span class="n">LED_SCROLLL</span><span class="p">);</span>  <span class="k">break</span><span class="p">;</span>    <span class="cm">/*   &quot;Scroll Lock&quot;              */</span>
		<span class="k">case</span> <span class="mh">0x04</span>:  <span class="n">map_led</span> <span class="p">(</span><span class="n">LED_COMPOSE</span><span class="p">);</span>  <span class="k">break</span><span class="p">;</span>    <span class="cm">/*   &quot;Compose&quot;                  */</span>
		<span class="k">case</span> <span class="mh">0x05</span>:  <span class="n">map_led</span> <span class="p">(</span><span class="n">LED_KANA</span><span class="p">);</span>     <span class="k">break</span><span class="p">;</span>    <span class="cm">/*   &quot;Kana&quot;                     */</span>
		<span class="k">case</span> <span class="mh">0x27</span>:  <span class="n">map_led</span> <span class="p">(</span><span class="n">LED_SLEEP</span><span class="p">);</span>    <span class="k">break</span><span class="p">;</span>    <span class="cm">/*   &quot;Stand-By&quot;                 */</span>
		<span class="k">case</span> <span class="mh">0x4c</span>:  <span class="n">map_led</span> <span class="p">(</span><span class="n">LED_SUSPEND</span><span class="p">);</span>  <span class="k">break</span><span class="p">;</span>    <span class="cm">/*   &quot;System Suspend&quot;           */</span>
		<span class="k">case</span> <span class="mh">0x09</span>:  <span class="n">map_led</span> <span class="p">(</span><span class="n">LED_MUTE</span><span class="p">);</span>     <span class="k">break</span><span class="p">;</span>    <span class="cm">/*   &quot;Mute&quot;                     */</span>
		<span class="k">case</span> <span class="mh">0x4b</span>:  <span class="n">map_led</span> <span class="p">(</span><span class="n">LED_MISC</span><span class="p">);</span>     <span class="k">break</span><span class="p">;</span>    <span class="cm">/*   &quot;Generic Indicator&quot;        */</span>
		<span class="k">case</span> <span class="mh">0x19</span>:  <span class="n">map_led</span> <span class="p">(</span><span class="n">LED_MAIL</span><span class="p">);</span>     <span class="k">break</span><span class="p">;</span>    <span class="cm">/*   &quot;Message Waiting&quot;          */</span>
		<span class="k">case</span> <span class="mh">0x4d</span>:  <span class="n">map_led</span> <span class="p">(</span><span class="n">LED_CHARGING</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>    <span class="cm">/*   &quot;External Power Connected&quot; */</span>

		<span class="nl">default:</span> <span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HID_UP_DIGITIZER</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>: <span class="cm">/* Undefined */</span>
			<span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x30</span>: <span class="cm">/* TipPressure */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">device</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">|=</span> <span class="n">HID_QUIRK_NOTOUCH</span><span class="p">;</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">map_abs_clear</span><span class="p">(</span><span class="n">ABS_PRESSURE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x32</span>: <span class="cm">/* InRange */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">physical</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x21</span>: <span class="n">map_key</span><span class="p">(</span><span class="n">BTN_TOOL_MOUSE</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x22</span>: <span class="n">map_key</span><span class="p">(</span><span class="n">BTN_TOOL_FINGER</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span> <span class="n">map_key</span><span class="p">(</span><span class="n">BTN_TOOL_PEN</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x3c</span>: <span class="cm">/* Invert */</span>
			<span class="n">map_key_clear</span><span class="p">(</span><span class="n">BTN_TOOL_RUBBER</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x3d</span>: <span class="cm">/* X Tilt */</span>
			<span class="n">map_abs_clear</span><span class="p">(</span><span class="n">ABS_TILT_X</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x3e</span>: <span class="cm">/* Y Tilt */</span>
			<span class="n">map_abs_clear</span><span class="p">(</span><span class="n">ABS_TILT_Y</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x33</span>: <span class="cm">/* Touch */</span>
		<span class="k">case</span> <span class="mh">0x42</span>: <span class="cm">/* TipSwitch */</span>
		<span class="k">case</span> <span class="mh">0x43</span>: <span class="cm">/* TipSwitch2 */</span>
			<span class="n">device</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HID_QUIRK_NOTOUCH</span><span class="p">;</span>
			<span class="n">map_key_clear</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x44</span>: <span class="cm">/* BarrelSwitch */</span>
			<span class="n">map_key_clear</span><span class="p">(</span><span class="n">BTN_STYLUS</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x46</span>: <span class="cm">/* TabletPick */</span>
			<span class="n">map_key_clear</span><span class="p">(</span><span class="n">BTN_STYLUS2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>  <span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HID_UP_CONSUMER</span>:	<span class="cm">/* USB HUT v1.12, pages 75-84 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="n">HID_USAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x000</span>: <span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x030</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_POWER</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x031</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_RESTART</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x032</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SLEEP</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x034</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SLEEP</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x035</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_KBDILLUMTOGGLE</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x036</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">BTN_MISC</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x040</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_MENU</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span> <span class="cm">/* Menu */</span>
		<span class="k">case</span> <span class="mh">0x041</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SELECT</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span> <span class="cm">/* Menu Pick */</span>
		<span class="k">case</span> <span class="mh">0x042</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_UP</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span> <span class="cm">/* Menu Up */</span>
		<span class="k">case</span> <span class="mh">0x043</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_DOWN</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span> <span class="cm">/* Menu Down */</span>
		<span class="k">case</span> <span class="mh">0x044</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_LEFT</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span> <span class="cm">/* Menu Left */</span>
		<span class="k">case</span> <span class="mh">0x045</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_RIGHT</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span> <span class="cm">/* Menu Right */</span>
		<span class="k">case</span> <span class="mh">0x046</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_ESC</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span> <span class="cm">/* Menu Escape */</span>
		<span class="k">case</span> <span class="mh">0x047</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_KPPLUS</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span> <span class="cm">/* Menu Value Increase */</span>
		<span class="k">case</span> <span class="mh">0x048</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_KPMINUS</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span> <span class="cm">/* Menu Value Decrease */</span>

		<span class="k">case</span> <span class="mh">0x060</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_INFO</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span> <span class="cm">/* Data On Screen */</span>
		<span class="k">case</span> <span class="mh">0x061</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SUBTITLE</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span> <span class="cm">/* Closed Caption */</span>
		<span class="k">case</span> <span class="mh">0x063</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_VCR</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span> <span class="cm">/* VCR/TV */</span>
		<span class="k">case</span> <span class="mh">0x065</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_CAMERA</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span> <span class="cm">/* Snapshot */</span>
		<span class="k">case</span> <span class="mh">0x069</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_RED</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x06a</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_GREEN</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x06b</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_BLUE</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x06c</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_YELLOW</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x06d</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_ZOOM</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x082</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_VIDEO_NEXT</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x083</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_LAST</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x084</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_ENTER</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x088</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_PC</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x089</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_TV</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08a</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_WWW</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08b</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_DVD</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08c</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_PHONE</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08d</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_PROGRAM</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08e</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_VIDEOPHONE</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08f</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_GAMES</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x090</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_MEMO</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x091</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_CD</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x092</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_VCR</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x093</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_TUNER</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x094</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_EXIT</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x095</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_HELP</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x096</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_TAPE</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x097</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_TV2</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x098</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SAT</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x09a</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_PVR</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x09c</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_CHANNELUP</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x09d</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_CHANNELDOWN</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0a0</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_VCR2</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x0b0</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_PLAY</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0b1</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_PAUSE</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0b2</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_RECORD</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0b3</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_FASTFORWARD</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0b4</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_REWIND</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0b5</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_NEXTSONG</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0b6</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_PREVIOUSSONG</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0b7</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_STOPCD</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0b8</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_EJECTCD</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0bc</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_MEDIA_REPEAT</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0b9</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SHUFFLE</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0bf</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SLOW</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x0cd</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_PLAYPAUSE</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0e0</span>: <span class="n">map_abs_clear</span><span class="p">(</span><span class="n">ABS_VOLUME</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0e2</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_MUTE</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0e5</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_BASSBOOST</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0e9</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_VOLUMEUP</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0ea</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_VOLUMEDOWN</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0f5</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SLOW</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x182</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_BOOKMARKS</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x183</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_CONFIG</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x184</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_WORDPROCESSOR</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x185</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_EDITOR</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x186</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SPREADSHEET</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x187</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_GRAPHICSEDITOR</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x188</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_PRESENTATION</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x189</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_DATABASE</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x18a</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_MAIL</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x18b</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_NEWS</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x18c</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_VOICEMAIL</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x18d</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_ADDRESSBOOK</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x18e</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_CALENDAR</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x191</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_FINANCE</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x192</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_CALC</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x193</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_PLAYER</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x194</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_FILE</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x196</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_WWW</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x199</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_CHAT</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x19c</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_LOGOFF</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x19e</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_COFFEE</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1a6</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_HELP</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1a7</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_DOCUMENTS</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1ab</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SPELLCHECK</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1ae</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_KEYBOARD</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1b6</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_IMAGES</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1b7</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_AUDIO</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1b8</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_VIDEO</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1bc</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_MESSENGER</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1bd</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_INFO</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x201</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_NEW</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x202</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_OPEN</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x203</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_CLOSE</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x204</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_EXIT</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x207</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SAVE</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x208</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_PRINT</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x209</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_PROPS</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x21a</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_UNDO</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x21b</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_COPY</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x21c</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_CUT</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x21d</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_PASTE</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x21f</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_FIND</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x221</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SEARCH</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x222</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_GOTO</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x223</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_HOMEPAGE</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x224</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_BACK</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x225</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_FORWARD</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x226</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_STOP</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x227</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_REFRESH</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x22a</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_BOOKMARKS</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x22d</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_ZOOMIN</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x22e</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_ZOOMOUT</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x22f</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_ZOOMRESET</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x233</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SCROLLUP</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x234</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SCROLLDOWN</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x238</span>: <span class="n">map_rel</span><span class="p">(</span><span class="n">REL_HWHEEL</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x23d</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_EDIT</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x25f</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_CANCEL</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x269</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_INSERT</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x26a</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_DELETE</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x279</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_REDO</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x289</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_REPLY</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x28b</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_FORWARDMAIL</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x28c</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SEND</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>    <span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HID_UP_GENDEVCTRLS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hidinput_setup_battery</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">HID_INPUT_REPORT</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">unknown</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HID_UP_HPVENDOR</span>:	<span class="cm">/* Reported on a Dutch layout HP5308 */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">EV_REP</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="n">HID_USAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x021</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_PRINT</span><span class="p">);</span>           <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x070</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_HP</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x071</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_CAMERA</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x072</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SOUND</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x073</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_QUESTION</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x080</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_EMAIL</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x081</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_CHAT</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x082</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SEARCH</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x083</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_CONNECT</span><span class="p">);</span>	        <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x084</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_FINANCE</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x085</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SPORT</span><span class="p">);</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x086</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">KEY_SHOP</span><span class="p">);</span>	        <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>    <span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HID_UP_MSVENDOR</span>:
		<span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HID_UP_CUSTOM</span>: <span class="cm">/* Reported on Logitech and Apple USB keyboards */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">EV_REP</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HID_UP_LOGIVENDOR</span>:
		<span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HID_UP_PID</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">&amp;</span> <span class="n">HID_USAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0xa4</span>: <span class="n">map_key_clear</span><span class="p">(</span><span class="n">BTN_DEAD</span><span class="p">);</span>	<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
	<span class="nl">unknown:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">report_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">HID_OUTPUT_REPORT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">map_led</span><span class="p">(</span><span class="n">LED_MISC</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">map_key</span><span class="p">(</span><span class="n">BTN_MISC</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HID_MAIN_ITEM_RELATIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">map_rel</span><span class="p">(</span><span class="n">REL_MISC</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">map_abs</span><span class="p">(</span><span class="n">ABS_MISC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">mapped:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">input_mapped</span> <span class="o">&amp;&amp;</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">input_mapped</span><span class="p">(</span><span class="n">device</span><span class="p">,</span>
				<span class="n">hidinput</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">usage</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">&lt;=</span> <span class="n">max</span> <span class="o">&amp;&amp;</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">bit</span><span class="p">))</span>
		<span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">find_next_zero_bit</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span> <span class="n">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ignore</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_ABS</span><span class="p">)</span> <span class="p">{</span>

		<span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_minimum</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_maximum</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">HID_QUIRK_BADPAD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">ABS_X</span> <span class="o">||</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">ABS_Y</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">b</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_maximum</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">application</span> <span class="o">==</span> <span class="n">HID_GD_GAMEPAD</span> <span class="o">||</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">application</span> <span class="o">==</span> <span class="n">HID_GD_JOYSTICK</span><span class="p">)</span>
			<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">else</span>	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">input_abs_set_res</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span>
				  <span class="n">hidinput_calc_abs_res</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">));</span>

		<span class="cm">/* use a larger default input buffer for MT devices */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">ABS_MT_POSITION_X</span> <span class="o">&amp;&amp;</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">hint_events_per_packet</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">input_set_events_per_packet</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_ABS</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_min</span> <span class="o">&lt;</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_max</span> <span class="o">||</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_dir</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_dir</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">dpad</span><span class="p">)</span>
			<span class="n">field</span><span class="o">-&gt;</span><span class="n">dpad</span> <span class="o">=</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for those devices which produce Consumer volume usage as relative,</span>
<span class="cm">	 * we emulate pressing volumeup/volumedown appropriate number of times</span>
<span class="cm">	 * in hidinput_hid_event()</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_ABS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HID_MAIN_ITEM_RELATIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">ABS_VOLUME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_VOLUMEUP</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_VOLUMEDOWN</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">EV_MSC</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">MSC_SCAN</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">mscbit</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">ignore:</span>
	<span class="k">return</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hidinput_hid_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">field</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_usage</span> <span class="o">*</span><span class="n">usage</span><span class="p">,</span> <span class="n">__s32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="o">*</span><span class="n">quirks</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">quirks</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">hidinput</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">input</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">hidinput</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_min</span> <span class="o">&lt;</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_max</span> <span class="o">||</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">hat_dir</span> <span class="o">=</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_dir</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hat_dir</span><span class="p">)</span>
			<span class="n">hat_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_min</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_max</span> <span class="o">-</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">hat_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hat_dir</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hat_dir</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="n">hat_dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">input_event</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span>    <span class="p">,</span> <span class="n">hid_hat_to_axis</span><span class="p">[</span><span class="n">hat_dir</span><span class="p">].</span><span class="n">x</span><span class="p">);</span>
		<span class="n">input_event</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hid_hat_to_axis</span><span class="p">[</span><span class="n">hat_dir</span><span class="p">].</span><span class="n">y</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">==</span> <span class="p">(</span><span class="n">HID_UP_DIGITIZER</span> <span class="o">|</span> <span class="mh">0x003c</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Invert */</span>
		<span class="o">*</span><span class="n">quirks</span> <span class="o">=</span> <span class="n">value</span> <span class="o">?</span> <span class="p">(</span><span class="o">*</span><span class="n">quirks</span> <span class="o">|</span> <span class="n">HID_QUIRK_INVERT</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="o">*</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HID_QUIRK_INVERT</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">==</span> <span class="p">(</span><span class="n">HID_UP_DIGITIZER</span> <span class="o">|</span> <span class="mh">0x0032</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* InRange */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_event</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">HID_QUIRK_INVERT</span><span class="p">)</span> <span class="o">?</span> <span class="n">BTN_TOOL_RUBBER</span> <span class="o">:</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">input_event</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_event</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">BTN_TOOL_RUBBER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">==</span> <span class="p">(</span><span class="n">HID_UP_DIGITIZER</span> <span class="o">|</span> <span class="mh">0x0030</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">HID_QUIRK_NOTOUCH</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Pressure */</span>
		<span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_minimum</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_maximum</span><span class="p">;</span>
		<span class="n">input_event</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">a</span> <span class="o">+</span> <span class="p">((</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">==</span> <span class="p">(</span><span class="n">HID_UP_PID</span> <span class="o">|</span> <span class="mh">0x83UL</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Simultaneous Effects Max */</span>
		<span class="n">dbg_hid</span><span class="p">(</span><span class="s">&quot;Maximum Effects - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span> <span class="o">==</span> <span class="p">(</span><span class="n">HID_UP_PID</span> <span class="o">|</span> <span class="mh">0x7fUL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg_hid</span><span class="p">(</span><span class="s">&quot;PID Pool Report</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_KEY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="cm">/* Key 0 is &quot;unassigned&quot;, not KEY_UNKNOWN */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_ABS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HID_MAIN_ITEM_RELATIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">ABS_VOLUME</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">KEY_VOLUMEUP</span> <span class="o">:</span> <span class="n">KEY_VOLUMEDOWN</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_event</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
			<span class="n">input_event</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ignore out-of-range values as per HID specification,</span>
<span class="cm">	 * section 5.10 and 6.2.25</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HID_MAIN_ITEM_VARIABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_minimum</span> <span class="o">||</span>
	     <span class="n">value</span> <span class="o">&gt;</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">logical_maximum</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg_hid</span><span class="p">(</span><span class="s">&quot;Ignoring out-of-range value %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* report the usage code as scancode if the key status has changed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_KEY</span> <span class="o">&amp;&amp;</span> <span class="o">!!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="n">value</span><span class="p">)</span>
		<span class="n">input_event</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">EV_MSC</span><span class="p">,</span> <span class="n">MSC_SCAN</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">);</span>

	<span class="n">input_event</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HID_MAIN_ITEM_RELATIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_KEY</span><span class="p">))</span>
		<span class="n">input_event</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">usage</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hidinput_report_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_input</span> <span class="o">*</span><span class="n">hidinput</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">HID_QUIRK_NO_INPUT_SYNC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">hidinput</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">hidinput</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">hidinput_report_event</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">hidinput_find_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hid_field</span> <span class="o">**</span><span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">report_enum</span><span class="p">[</span><span class="n">HID_OUTPUT_REPORT</span><span class="p">].</span><span class="n">report_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">field</span> <span class="o">=</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">field</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">maxusage</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">field</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">field</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">code</span> <span class="o">==</span> <span class="n">code</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">j</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">hidinput_find_field</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="nf">hidinput_get_led_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">report</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">report_enum</span><span class="p">[</span><span class="n">HID_OUTPUT_REPORT</span><span class="p">].</span><span class="n">report_list</span><span class="p">,</span>
			    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">field</span> <span class="o">=</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">maxusage</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_LED</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">field</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">hidinput_get_led_field</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">hidinput_count_leds</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hid_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">report</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">report_enum</span><span class="p">[</span><span class="n">HID_OUTPUT_REPORT</span><span class="p">].</span><span class="n">report_list</span><span class="p">,</span>
			    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">field</span> <span class="o">=</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">maxusage</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_LED</span> <span class="o">&amp;&amp;</span>
				    <span class="n">field</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
					<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">hidinput_count_leds</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hidinput_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hid_hw_open</span><span class="p">(</span><span class="n">hid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hidinput_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hid_hw_close</span><span class="p">(</span><span class="n">hid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">report_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hid_report_enum</span> <span class="o">*</span><span class="n">rep_enum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">rep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">rep_enum</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">report_enum</span><span class="p">[</span><span class="n">HID_FEATURE_REPORT</span><span class="p">];</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">rep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rep_enum</span><span class="o">-&gt;</span><span class="n">report_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">maxfield</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">maxusage</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Verify if Battery Strength feature is available */</span>
				<span class="n">hidinput_setup_battery</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">HID_FEATURE_REPORT</span><span class="p">,</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">feature_mapping</span><span class="p">)</span>
					<span class="n">drv</span><span class="o">-&gt;</span><span class="n">feature_mapping</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							     <span class="n">rep</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">usage</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>
			<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register the input device; print a message.</span>
<span class="cm"> * Configure the input layer interface</span>
<span class="cm"> * Read all reports and initialize the absolute field values.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">hidinput_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_report</span> <span class="o">*</span><span class="n">report</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hid_input</span> <span class="o">*</span><span class="n">hidinput</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">maxcollection</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">hid_collection</span> <span class="o">*</span><span class="n">col</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">collection</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">col</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">HID_COLLECTION_APPLICATION</span> <span class="o">||</span>
					<span class="n">col</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">HID_COLLECTION_PHYSICAL</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">IS_INPUT_APPLICATION</span><span class="p">(</span><span class="n">col</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">maxcollection</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">report_features</span><span class="p">(</span><span class="n">hid</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">HID_INPUT_REPORT</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">HID_OUTPUT_REPORT</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">HID_OUTPUT_REPORT</span> <span class="o">&amp;&amp;</span>
			<span class="n">hid</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">HID_QUIRK_SKIP_OUTPUT_REPORTS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">report_enum</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">report_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hidinput</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hidinput</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hidinput</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hidinput</span> <span class="o">||</span> <span class="o">!</span><span class="n">input_dev</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">hidinput</span><span class="p">);</span>
					<span class="n">input_free_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
					<span class="n">hid_err</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="s">&quot;Out of memory during hid input probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">out_unwind</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">hid</span><span class="p">);</span>
				<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span>
					<span class="n">hid</span><span class="o">-&gt;</span><span class="n">ll_driver</span><span class="o">-&gt;</span><span class="n">hidinput_input_event</span><span class="p">;</span>
				<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">hidinput_open</span><span class="p">;</span>
				<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">hidinput_close</span><span class="p">;</span>
				<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">setkeycode</span> <span class="o">=</span> <span class="n">hidinput_setkeycode</span><span class="p">;</span>
				<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">getkeycode</span> <span class="o">=</span> <span class="n">hidinput_getkeycode</span><span class="p">;</span>

				<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
				<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
				<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">uniq</span> <span class="o">=</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">uniq</span><span class="p">;</span>
				<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
				<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span>  <span class="o">=</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
				<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">;</span>
				<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
				<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
				<span class="n">hidinput</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input_dev</span><span class="p">;</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hidinput</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">maxfield</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">maxusage</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
					<span class="n">hidinput_configure_usage</span><span class="p">(</span><span class="n">hidinput</span><span class="p">,</span> <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
								 <span class="n">report</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">usage</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">HID_QUIRK_MULTI_INPUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* This will leave hidinput NULL, so that it</span>
<span class="cm">				 * allocates another one if we have more inputs on</span>
<span class="cm">				 * the same interface. Some devices (e.g. Happ&#39;s</span>
<span class="cm">				 * UGCI) cram a lot of unrelated inputs into the</span>
<span class="cm">				 * same interface. */</span>
				<span class="n">hidinput</span><span class="o">-&gt;</span><span class="n">report</span> <span class="o">=</span> <span class="n">report</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">input_register_device</span><span class="p">(</span><span class="n">hidinput</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">out_cleanup</span><span class="p">;</span>
				<span class="n">hidinput</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hidinput</span> <span class="o">&amp;&amp;</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">hidinput</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_cleanup</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_cleanup:</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hidinput</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">hidinput</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hidinput</span><span class="p">);</span>
<span class="nl">out_unwind:</span>
	<span class="cm">/* unwind the ones we already registered */</span>
	<span class="n">hidinput_disconnect</span><span class="p">(</span><span class="n">hid</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">hidinput_connect</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">hidinput_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">hid_device</span> <span class="o">*</span><span class="n">hid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hid_input</span> <span class="o">*</span><span class="n">hidinput</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">hidinput_cleanup_battery</span><span class="p">(</span><span class="n">hid</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">hidinput</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">inputs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hidinput</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">hidinput</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hidinput</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">hidinput_disconnect</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
