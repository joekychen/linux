<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › parisc › superio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>superio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*      National Semiconductor NS87560UBD Super I/O controller used in</span>
<span class="cm"> *      HP [BCJ]x000 workstations.</span>
<span class="cm"> *</span>
<span class="cm"> *      This chip is a horrid piece of engineering, and National</span>
<span class="cm"> *      denies any knowledge of its existence. Thus no datasheet is</span>
<span class="cm"> *      available off www.national.com. </span>
<span class="cm"> *</span>
<span class="cm"> *	(C) Copyright 2000 Linuxcare, Inc.</span>
<span class="cm"> * 	(C) Copyright 2000 Linuxcare Canada, Inc.</span>
<span class="cm"> *	(C) Copyright 2000 Martin K. Petersen &lt;mkp@linuxcare.com&gt;</span>
<span class="cm"> * 	(C) Copyright 2000 Alex deVries &lt;alex@onefishtwo.ca&gt;</span>
<span class="cm"> *      (C) Copyright 2001 John Marvin &lt;jsm fc hp com&gt;</span>
<span class="cm"> *      (C) Copyright 2003 Grant Grundler &lt;grundler parisc-linux org&gt;</span>
<span class="cm"> *	(C) Copyright 2005 Kyle McMartin &lt;kyle@parisc-linux.org&gt;</span>
<span class="cm"> *	(C) Copyright 2006 Helge Deller &lt;deller@gmx.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *	published by the Free Software Foundation; either version 2 of</span>
<span class="cm"> *	the License, or (at your option) any later version.  </span>
<span class="cm"> *</span>
<span class="cm"> *	The initial version of this is by Martin Peterson.  Alex deVries</span>
<span class="cm"> *	has spent a bit of time trying to coax it into working.</span>
<span class="cm"> *</span>
<span class="cm"> *      Major changes to get basic interrupt infrastructure working to</span>
<span class="cm"> *      hopefully be able to support all SuperIO devices. Currently</span>
<span class="cm"> *      works with serial. -- John Marvin &lt;jsm@fc.hp.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	Converted superio_init() to be a PCI_FIXUP_FINAL callee.</span>
<span class="cm"> *         -- Kyle McMartin &lt;kyle@parisc-linux.org&gt;</span>
<span class="cm"> */</span>


<span class="cm">/* NOTES:</span>
<span class="cm"> * </span>
<span class="cm"> * Function 0 is an IDE controller. It is identical to a PC87415 IDE</span>
<span class="cm"> * controller (and identifies itself as such).</span>
<span class="cm"> *</span>
<span class="cm"> * Function 1 is a &quot;Legacy I/O&quot; controller. Under this function is a</span>
<span class="cm"> * whole mess of legacy I/O peripherals. Of course, HP hasn&#39;t enabled</span>
<span class="cm"> * all the functionality in hardware, but the following is available:</span>
<span class="cm"> *</span>
<span class="cm"> *      Two 16550A compatible serial controllers</span>
<span class="cm"> *      An IEEE 1284 compatible parallel port</span>
<span class="cm"> *      A floppy disk controller</span>
<span class="cm"> *</span>
<span class="cm"> * Function 2 is a USB controller.</span>
<span class="cm"> *</span>
<span class="cm"> * We must be incredibly careful during initialization.  Since all</span>
<span class="cm"> * interrupts are routed through function 1 (which is not allowed by</span>
<span class="cm"> * the PCI spec), we need to program the PICs on the legacy I/O port</span>
<span class="cm"> * *before* we attempt to set up IDE and USB.  @#$!&amp;</span>
<span class="cm"> *</span>
<span class="cm"> * According to HP, devices are only enabled by firmware if they have</span>
<span class="cm"> * a physical device connected.</span>
<span class="cm"> *</span>
<span class="cm"> * Configuration register bits:</span>
<span class="cm"> *     0x5A: FDC, SP1, IDE1, SP2, IDE2, PAR, Reserved, P92</span>
<span class="cm"> *     0x5B: RTC, 8259, 8254, DMA1, DMA2, KBC, P61, APM</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/parport.h&gt;</span>
<span class="cp">#include &lt;linux/parport_pc.h&gt;</span>
<span class="cp">#include &lt;linux/termios.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/serial_core.h&gt;</span>
<span class="cp">#include &lt;linux/serial_8250.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/hardware.h&gt;</span>
<span class="cp">#include &lt;asm/superio.h&gt;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">superio_device</span> <span class="n">sio_dev</span><span class="p">;</span>


<span class="cp">#undef DEBUG_SUPERIO_INIT</span>

<span class="cp">#ifdef DEBUG_SUPERIO_INIT</span>
<span class="cp">#define DBG_INIT(x...)  printk(x)</span>
<span class="cp">#else</span>
<span class="cp">#define DBG_INIT(x...)</span>
<span class="cp">#endif</span>

<span class="cp">#define SUPERIO	&quot;SuperIO&quot;</span>
<span class="cp">#define PFX	SUPERIO &quot;: &quot;</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">superio_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">parent_irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">results</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">local_irq</span><span class="p">;</span>

	<span class="cm">/* Poll the 8259 to see if there&#39;s an interrupt. */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="n">OCW3_POLL</span><span class="p">,</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">results</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bit    7:	1 = active Interrupt; 0 = no Interrupt pending</span>
<span class="cm">	 * Bits 6-3:	zero</span>
<span class="cm">	 * Bits 2-0:	highest priority, active requesting interrupt ID (0-7)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">results</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* I suspect &quot;spurious&quot; interrupts are from unmasking an IRQ.</span>
<span class="cm">		 * We don&#39;t know if an interrupt was/is pending and thus</span>
<span class="cm">		 * just call the handler for that IRQ as if it were pending.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check to see which device is interrupting */</span>
	<span class="n">local_irq</span> <span class="o">=</span> <span class="n">results</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local_irq</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">local_irq</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;slave interrupted!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local_irq</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Could be spurious. Check in service bits */</span>

		<span class="n">outb</span><span class="p">(</span><span class="n">OCW3_ISR</span><span class="p">,</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">results</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">results</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* if ISR7 not set: spurious */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PFX</span> <span class="s">&quot;spurious interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Call the appropriate device&#39;s interrupt */</span>
	<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">local_irq</span><span class="p">);</span>

	<span class="cm">/* set EOI - forces a new interrupt if a lower priority device</span>
<span class="cm">	 * still needs service.</span>
<span class="cm">	 */</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">OCW2_SEOI</span><span class="o">|</span><span class="n">local_irq</span><span class="p">),</span><span class="n">IC_PIC1</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize Super I/O device */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">superio_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">superio_device</span> <span class="o">*</span><span class="n">sio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sio_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">sio</span><span class="o">-&gt;</span><span class="n">lio_pdev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">word</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sio</span><span class="o">-&gt;</span><span class="n">suckyio_irq_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sio</span><span class="o">-&gt;</span><span class="n">usb_pdev</span><span class="p">);</span>

	<span class="cm">/* use the IRQ iosapic found for USB INT D... */</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">sio</span><span class="o">-&gt;</span><span class="n">usb_pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* ...then properly fixup the USB to point at suckyio PIC */</span>
	<span class="n">sio</span><span class="o">-&gt;</span><span class="n">usb_pdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">superio_fixup_irq</span><span class="p">(</span><span class="n">sio</span><span class="o">-&gt;</span><span class="n">usb_pdev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Found NS87560 Legacy I/O device at %s (IRQ %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">SIO_SP1BAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sio</span><span class="o">-&gt;</span><span class="n">sp1_base</span><span class="p">);</span>
	<span class="n">sio</span><span class="o">-&gt;</span><span class="n">sp1_base</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Serial port 1 at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sio</span><span class="o">-&gt;</span><span class="n">sp1_base</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">SIO_SP2BAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sio</span><span class="o">-&gt;</span><span class="n">sp2_base</span><span class="p">);</span>
	<span class="n">sio</span><span class="o">-&gt;</span><span class="n">sp2_base</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Serial port 2 at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sio</span><span class="o">-&gt;</span><span class="n">sp2_base</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">SIO_PPBAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sio</span><span class="o">-&gt;</span><span class="n">pp_base</span><span class="p">);</span>
	<span class="n">sio</span><span class="o">-&gt;</span><span class="n">pp_base</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Parallel port at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sio</span><span class="o">-&gt;</span><span class="n">pp_base</span><span class="p">);</span>

	<span class="n">pci_read_config_dword</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">SIO_FDCBAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sio</span><span class="o">-&gt;</span><span class="n">fdc_base</span><span class="p">);</span>
	<span class="n">sio</span><span class="o">-&gt;</span><span class="n">fdc_base</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Floppy controller at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sio</span><span class="o">-&gt;</span><span class="n">fdc_base</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">SIO_ACPIBAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sio</span><span class="o">-&gt;</span><span class="n">acpi_base</span><span class="p">);</span>
	<span class="n">sio</span><span class="o">-&gt;</span><span class="n">acpi_base</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;ACPI at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sio</span><span class="o">-&gt;</span><span class="n">acpi_base</span><span class="p">);</span>

	<span class="n">request_region</span> <span class="p">(</span><span class="n">IC_PIC1</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="s">&quot;pic1&quot;</span><span class="p">);</span>
	<span class="n">request_region</span> <span class="p">(</span><span class="n">IC_PIC2</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="s">&quot;pic2&quot;</span><span class="p">);</span>
	<span class="n">request_region</span> <span class="p">(</span><span class="n">sio</span><span class="o">-&gt;</span><span class="n">acpi_base</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="s">&quot;acpi&quot;</span><span class="p">);</span>

	<span class="cm">/* Enable the legacy I/O function */</span>
	<span class="n">pci_read_config_word</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="n">word</span> <span class="o">|=</span> <span class="n">PCI_COMMAND_SERR</span> <span class="o">|</span> <span class="n">PCI_COMMAND_PARITY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_IO</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>

	<span class="n">pci_set_master</span> <span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* not too much we can do about this... */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Next project is programming the onboard interrupt controllers.</span>
<span class="cm">	 * PDC hasn&#39;t done this for us, since it&#39;s using polled I/O.</span>
<span class="cm">	 *</span>
<span class="cm">	 * XXX Use dword writes to avoid bugs in Elroy or Suckyio Config</span>
<span class="cm">	 *     space access.  PCI is by nature a 32-bit bus and config</span>
<span class="cm">	 *     space can be sensitive to that.</span>
<span class="cm">	 */</span>

	<span class="cm">/* 0x64 - 0x67 :</span>
<span class="cm">		DMA Rtg 2</span>
<span class="cm">		DMA Rtg 3</span>
<span class="cm">		DMA Chan Ctl</span>
<span class="cm">		TRIGGER_1    == 0x82   USB &amp; IDE level triggered, rest to edge</span>
<span class="cm">	*/</span>
	<span class="n">pci_write_config_dword</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span>         <span class="mh">0x82000000U</span><span class="p">);</span>

	<span class="cm">/* 0x68 - 0x6b :</span>
<span class="cm">		TRIGGER_2    == 0x00   all edge triggered (not used)</span>
<span class="cm">		CFG_IR_SER   == 0x43   SerPort1 = IRQ3, SerPort2 = IRQ4</span>
<span class="cm">		CFG_IR_PF    == 0x65   ParPort  = IRQ5, FloppyCtlr = IRQ6</span>
<span class="cm">		CFG_IR_IDE   == 0x07   IDE1 = IRQ7, reserved</span>
<span class="cm">	*/</span>
	<span class="n">pci_write_config_dword</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TRIGGER_2</span><span class="p">,</span>    <span class="mh">0x07654300U</span><span class="p">);</span>

	<span class="cm">/* 0x6c - 0x6f :</span>
<span class="cm">		CFG_IR_INTAB == 0x00</span>
<span class="cm">		CFG_IR_INTCD == 0x10   USB = IRQ1</span>
<span class="cm">		CFG_IR_PS2   == 0x00</span>
<span class="cm">		CFG_IR_FXBUS == 0x00</span>
<span class="cm">	*/</span>
	<span class="n">pci_write_config_dword</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">CFG_IR_INTAB</span><span class="p">,</span> <span class="mh">0x00001000U</span><span class="p">);</span>

	<span class="cm">/* 0x70 - 0x73 :</span>
<span class="cm">		CFG_IR_USB   == 0x00  not used. USB is connected to INTD.</span>
<span class="cm">		CFG_IR_ACPI  == 0x00  not used.</span>
<span class="cm">		DMA Priority == 0x4c88  Power on default value. NFC.</span>
<span class="cm">	*/</span>
	<span class="n">pci_write_config_dword</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">CFG_IR_USB</span><span class="p">,</span> <span class="mh">0x4c880000U</span><span class="p">);</span>

	<span class="cm">/* PIC1 Initialization Command Word register programming */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="mh">0x11</span><span class="p">,</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ICW1: ICW4 write req | ICW1 */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* ICW2: interrupt vector table - not used */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="mh">0x04</span><span class="p">,</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* ICW3: Cascade */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="mh">0x01</span><span class="p">,</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* ICW4: x86 mode */</span>

	<span class="cm">/* PIC1 Program Operational Control Words */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="mh">0xff</span><span class="p">,</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* OCW1: Mask all interrupts */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="mh">0xc2</span><span class="p">,</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span>  <span class="cm">/* OCW2: priority (3-7,0-2) */</span>

	<span class="cm">/* PIC2 Initialization Command Word register programming */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="mh">0x11</span><span class="p">,</span><span class="n">IC_PIC2</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span>	<span class="cm">/* ICW1: ICW4 write req | ICW1 */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="n">IC_PIC2</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* ICW2: N/A */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="mh">0x02</span><span class="p">,</span><span class="n">IC_PIC2</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* ICW3: Slave ID code */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="mh">0x01</span><span class="p">,</span><span class="n">IC_PIC2</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* ICW4: x86 mode */</span>
		
	<span class="cm">/* Program Operational Control Words */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="mh">0xff</span><span class="p">,</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* OCW1: Mask all interrupts */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span>	<span class="cm">/* OCW3: OCW3 select | ESMM | SMM */</span>

	<span class="cm">/* Write master mask reg */</span>
	<span class="n">outb</span> <span class="p">(</span><span class="mh">0xff</span><span class="p">,</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Setup USB power regulation */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">sio</span><span class="o">-&gt;</span><span class="n">acpi_base</span> <span class="o">+</span> <span class="n">USB_REG_CR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">sio</span><span class="o">-&gt;</span><span class="n">acpi_base</span> <span class="o">+</span> <span class="n">USB_REG_CR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;USB regulator enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;USB regulator not initialized!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">superio_interrupt</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span>
			<span class="n">SUPERIO</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sio</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;could not get irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sio</span><span class="o">-&gt;</span><span class="n">suckyio_irq_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DECLARE_PCI_FIXUP_FINAL</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_NS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NS_87560_LIO</span><span class="p">,</span> <span class="n">superio_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">superio_mask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">r8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Illegal irq number.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Mask interrupt */</span>

	<span class="n">r8</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">r8</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irq</span><span class="p">);</span>
	<span class="n">outb</span> <span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">superio_unmask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">r8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Illegal irq number (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Unmask interrupt */</span>
	<span class="n">r8</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">r8</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irq</span><span class="p">);</span>
	<span class="n">outb</span> <span class="p">(</span><span class="n">r8</span><span class="p">,</span><span class="n">IC_PIC1</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">superio_interrupt_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span>	<span class="n">SUPERIO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span>	<span class="n">superio_unmask_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span>	<span class="n">superio_mask_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef DEBUG_SUPERIO_INIT</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">expected_device</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCI_DEVICE_ID_NS_87415</span><span class="p">,</span>
	<span class="n">PCI_DEVICE_ID_NS_87560_LIO</span><span class="p">,</span>
	<span class="n">PCI_DEVICE_ID_NS_87560_USB</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">superio_fixup_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">local_irq</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_SUPERIO_INIT</span>
	<span class="kt">int</span> <span class="n">fn</span><span class="p">;</span>
	<span class="n">fn</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

	<span class="cm">/* Verify the function number matches the expected device id. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">expected_device</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;superio_fixup_irq(%s) ven 0x%x dev 0x%x from %pf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pci_name</span><span class="p">(</span><span class="n">pcidev</span><span class="p">),</span>
		<span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		<span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">superio_interrupt_type</span><span class="p">,</span>
					 <span class="n">handle_simple_irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t allocate a SuperIO irq for the legacy IO function,</span>
<span class="cm">	 * since it is a &quot;bridge&quot;. Instead, we will allocate irq&#39;s for</span>
<span class="cm">	 * each legacy device as they are initialized.</span>
<span class="cm">	 */</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_NS_87415</span>:		<span class="cm">/* Function 0 */</span>
		<span class="n">local_irq</span> <span class="o">=</span> <span class="n">IDE_IRQ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_NS_87560_LIO</span>:	<span class="cm">/* Function 1 */</span>
		<span class="n">sio_dev</span><span class="p">.</span><span class="n">lio_pdev</span> <span class="o">=</span> <span class="n">pcidev</span><span class="p">;</span>	<span class="cm">/* save for superio_init() */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_NS_87560_USB</span>:	<span class="cm">/* Function 2 */</span>
		<span class="n">sio_dev</span><span class="p">.</span><span class="n">usb_pdev</span> <span class="o">=</span> <span class="n">pcidev</span><span class="p">;</span>	<span class="cm">/* save for superio_init() */</span>
		<span class="n">local_irq</span> <span class="o">=</span> <span class="n">USB_IRQ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">local_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">local_irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">superio_serial_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SERIAL_8250</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uart_port</span> <span class="n">serial_port</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serial_port</span><span class="p">));</span>
	<span class="n">serial_port</span><span class="p">.</span><span class="n">iotype</span>	<span class="o">=</span> <span class="n">UPIO_PORT</span><span class="p">;</span>
	<span class="n">serial_port</span><span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">PORT_16550A</span><span class="p">;</span>
	<span class="n">serial_port</span><span class="p">.</span><span class="n">uartclk</span>	<span class="o">=</span> <span class="mi">115200</span><span class="o">*</span><span class="mi">16</span><span class="p">;</span>
	<span class="n">serial_port</span><span class="p">.</span><span class="n">fifosize</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* serial port #1 */</span>
	<span class="n">serial_port</span><span class="p">.</span><span class="n">iobase</span>	<span class="o">=</span> <span class="n">sio_dev</span><span class="p">.</span><span class="n">sp1_base</span><span class="p">;</span>
	<span class="n">serial_port</span><span class="p">.</span><span class="n">irq</span>		<span class="o">=</span> <span class="n">SP1_IRQ</span><span class="p">;</span>
	<span class="n">serial_port</span><span class="p">.</span><span class="n">line</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">early_serial_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PFX</span> <span class="s">&quot;Register Serial #0 failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* serial port #2 */</span>
	<span class="n">serial_port</span><span class="p">.</span><span class="n">iobase</span>	<span class="o">=</span> <span class="n">sio_dev</span><span class="p">.</span><span class="n">sp2_base</span><span class="p">;</span>
	<span class="n">serial_port</span><span class="p">.</span><span class="n">irq</span>		<span class="o">=</span> <span class="n">SP2_IRQ</span><span class="p">;</span>
	<span class="n">serial_port</span><span class="p">.</span><span class="n">line</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">early_serial_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serial_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PFX</span> <span class="s">&quot;Register Serial #1 failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SERIAL_8250 */</span><span class="cp"></span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">superio_parport_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PARPORT_PC</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parport_pc_probe_port</span><span class="p">(</span><span class="n">sio_dev</span><span class="p">.</span><span class="n">pp_base</span><span class="p">,</span>
			<span class="mi">0</span> <span class="cm">/*base_hi*/</span><span class="p">,</span>
			<span class="n">PAR_IRQ</span><span class="p">,</span> 
			<span class="n">PARPORT_DMA_NONE</span> <span class="cm">/* dma */</span><span class="p">,</span>
			<span class="nb">NULL</span> <span class="cm">/*struct pci_dev* */</span><span class="p">,</span>
			<span class="mi">0</span> <span class="cm">/* shared irq flags */</span><span class="p">))</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PFX</span> <span class="s">&quot;Probing parallel port failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_PARPORT_PC */</span><span class="cp"></span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">superio_fixup_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">prog</span><span class="p">;</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">|=</span> <span class="mh">0x5</span><span class="p">;</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CLASS_PROG</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">);</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CLASS_PROG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prog</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PCI: Enabled native mode for NS87415 (pif=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prog</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">DECLARE_PCI_FIXUP_EARLY</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_NS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NS_87415</span><span class="p">,</span> <span class="n">superio_fixup_pci</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">superio_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">superio_device</span> <span class="o">*</span><span class="n">sio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sio_dev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	** superio_probe(00:0e.0) ven 0x100b dev 0x2 sv 0x0 sd 0x0 class 0x1018a</span>
<span class="cm">	** superio_probe(00:0e.1) ven 0x100b dev 0xe sv 0x0 sd 0x0 class 0x68000</span>
<span class="cm">	** superio_probe(00:0e.2) ven 0x100b dev 0x12 sv 0x0 sd 0x0 class 0xc0310</span>
<span class="cm">	*/</span>
	<span class="n">DBG_INIT</span><span class="p">(</span><span class="s">&quot;superio_probe(%s) ven 0x%x dev 0x%x sv 0x%x sd 0x%x class 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sio</span><span class="o">-&gt;</span><span class="n">suckyio_irq_enabled</span><span class="p">);</span>	<span class="cm">/* Enabled by PCI_FIXUP_FINAL */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_NS_87560_LIO</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Function 1 */</span>
		<span class="n">superio_parport_init</span><span class="p">();</span>
		<span class="n">superio_serial_init</span><span class="p">();</span>
		<span class="cm">/* REVISIT XXX : superio_fdc_init() ? */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_NS_87415</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Function 0 */</span>
		<span class="n">DBG_INIT</span><span class="p">(</span><span class="s">&quot;superio_probe: ignoring IDE 87415</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_NS_87560_USB</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Function 2 */</span>
		<span class="n">DBG_INIT</span><span class="p">(</span><span class="s">&quot;superio_probe: ignoring USB OHCI controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DBG_INIT</span><span class="p">(</span><span class="s">&quot;superio_probe: WTF? Fire Extinguisher?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Let appropriate other driver claim this device. */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">superio_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_NS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NS_87560_LIO</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_NS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NS_87560_USB</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_NS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NS_87415</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">superio_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="n">SUPERIO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>     <span class="n">superio_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>        <span class="n">superio_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">superio_modinit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">superio_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">superio_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">superio_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">superio_modinit</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">superio_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
