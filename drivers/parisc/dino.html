<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › parisc › dino.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dino.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">**	DINO manager</span>
<span class="cm">**</span>
<span class="cm">**	(c) Copyright 1999 Red Hat Software</span>
<span class="cm">**	(c) Copyright 1999 SuSE GmbH</span>
<span class="cm">**	(c) Copyright 1999,2000 Hewlett-Packard Company</span>
<span class="cm">**	(c) Copyright 2000 Grant Grundler</span>
<span class="cm">**	(c) Copyright 2006 Helge Deller</span>
<span class="cm">**</span>
<span class="cm">**	This program is free software; you can redistribute it and/or modify</span>
<span class="cm">**	it under the terms of the GNU General Public License as published by</span>
<span class="cm">**      the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">**      (at your option) any later version.</span>
<span class="cm">**</span>
<span class="cm">**	This module provides access to Dino PCI bus (config/IOport spaces)</span>
<span class="cm">**	and helps manage Dino IRQ lines.</span>
<span class="cm">**</span>
<span class="cm">**	Dino interrupt handling is a bit complicated.</span>
<span class="cm">**	Dino always writes to the broadcast EIR via irr0 for now.</span>
<span class="cm">**	(BIG WARNING: using broadcast EIR is a really bad thing for SMP!)</span>
<span class="cm">**	Only one processor interrupt is used for the 11 IRQ line </span>
<span class="cm">**	inputs to dino.</span>
<span class="cm">**</span>
<span class="cm">**	The different between Built-in Dino and Card-Mode</span>
<span class="cm">**	dino is in chip initialization and pci device initialization.</span>
<span class="cm">**</span>
<span class="cm">**	Linux drivers can only use Card-Mode Dino if pci devices I/O port</span>
<span class="cm">**	BARs are configured and used by the driver. Programming MMIO address </span>
<span class="cm">**	requires substantial knowledge of available Host I/O address ranges</span>
<span class="cm">**	is currently not supported.  Port/Config accessor functions are the</span>
<span class="cm">**	same. &quot;BIOS&quot; differences are handled within the existing routines.</span>
<span class="cm">*/</span>

<span class="cm">/*	Changes :</span>
<span class="cm">**	2001-06-14 : Clement Moyroud (moyroudc@esiee.fr)</span>
<span class="cm">**		- added support for the integrated RS232. 	</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">** TODO: create a virtual address for each Dino HPA.</span>
<span class="cm">**       GSC code might be able to do this since IODC data tells us</span>
<span class="cm">**       how many pages are used. PCI subsystem could (must?) do this</span>
<span class="cm">**       for PCI drivers devices which implement/use MMIO registers.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;	</span><span class="cm">/* for struct irqaction */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/spinlock.h&gt;	</span><span class="cm">/* for spinlock_t and prototypes */</span><span class="cp"></span>

<span class="cp">#include &lt;asm/pdc.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/hardware.h&gt;</span>

<span class="cp">#include &quot;gsc.h&quot;</span>

<span class="cp">#undef DINO_DEBUG</span>

<span class="cp">#ifdef DINO_DEBUG</span>
<span class="cp">#define DBG(x...) printk(x)</span>
<span class="cp">#else</span>
<span class="cp">#define DBG(x...)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">** Config accessor functions only pass in the 8-bit bus number</span>
<span class="cm">** and not the 8-bit &quot;PCI Segment&quot; number. Each Dino will be</span>
<span class="cm">** assigned a PCI bus number based on &quot;when&quot; it&#39;s discovered.</span>
<span class="cm">**</span>
<span class="cm">** The &quot;secondary&quot; bus number is set to this before calling</span>
<span class="cm">** pci_scan_bus(). If any PPB&#39;s are present, the scan will</span>
<span class="cm">** discover them and update the &quot;secondary&quot; and &quot;subordinate&quot;</span>
<span class="cm">** fields in Dino&#39;s pci_bus structure.</span>
<span class="cm">**</span>
<span class="cm">** Changes in the configuration *will* result in a different</span>
<span class="cm">** bus number for each dino.</span>
<span class="cm">*/</span>

<span class="cp">#define is_card_dino(id)	((id)-&gt;hw_type == HPHW_A_DMA)</span>
<span class="cp">#define is_cujo(id)		((id)-&gt;hversion == 0x682)</span>

<span class="cp">#define DINO_IAR0		0x004</span>
<span class="cp">#define DINO_IODC_ADDR		0x008</span>
<span class="cp">#define DINO_IODC_DATA_0	0x008</span>
<span class="cp">#define DINO_IODC_DATA_1	0x008</span>
<span class="cp">#define DINO_IRR0		0x00C</span>
<span class="cp">#define DINO_IAR1		0x010</span>
<span class="cp">#define DINO_IRR1		0x014</span>
<span class="cp">#define DINO_IMR		0x018</span>
<span class="cp">#define DINO_IPR		0x01C</span>
<span class="cp">#define DINO_TOC_ADDR		0x020</span>
<span class="cp">#define DINO_ICR		0x024</span>
<span class="cp">#define DINO_ILR		0x028</span>
<span class="cp">#define DINO_IO_COMMAND		0x030</span>
<span class="cp">#define DINO_IO_STATUS		0x034</span>
<span class="cp">#define DINO_IO_CONTROL		0x038</span>
<span class="cp">#define DINO_IO_GSC_ERR_RESP	0x040</span>
<span class="cp">#define DINO_IO_ERR_INFO	0x044</span>
<span class="cp">#define DINO_IO_PCI_ERR_RESP	0x048</span>
<span class="cp">#define DINO_IO_FBB_EN		0x05c</span>
<span class="cp">#define DINO_IO_ADDR_EN		0x060</span>
<span class="cp">#define DINO_PCI_ADDR		0x064</span>
<span class="cp">#define DINO_CONFIG_DATA	0x068</span>
<span class="cp">#define DINO_IO_DATA		0x06c</span>
<span class="cp">#define DINO_MEM_DATA		0x070	</span><span class="cm">/* Dino 3.x only */</span><span class="cp"></span>
<span class="cp">#define DINO_GSC2X_CONFIG	0x7b4</span>
<span class="cp">#define DINO_GMASK		0x800</span>
<span class="cp">#define DINO_PAMR		0x804</span>
<span class="cp">#define DINO_PAPR		0x808</span>
<span class="cp">#define DINO_DAMODE		0x80c</span>
<span class="cp">#define DINO_PCICMD		0x810</span>
<span class="cp">#define DINO_PCISTS		0x814</span>
<span class="cp">#define DINO_MLTIM		0x81c</span>
<span class="cp">#define DINO_BRDG_FEAT		0x820</span>
<span class="cp">#define DINO_PCIROR		0x824</span>
<span class="cp">#define DINO_PCIWOR		0x828</span>
<span class="cp">#define DINO_TLTIM		0x830</span>

<span class="cp">#define DINO_IRQS 11		</span><span class="cm">/* bits 0-10 are architected */</span><span class="cp"></span>
<span class="cp">#define DINO_IRR_MASK	0x5ff	</span><span class="cm">/* only 10 bits are implemented */</span><span class="cp"></span>
<span class="cp">#define DINO_LOCAL_IRQS (DINO_IRQS+1)</span>

<span class="cp">#define DINO_MASK_IRQ(x)	(1&lt;&lt;(x))</span>

<span class="cp">#define PCIINTA   0x001</span>
<span class="cp">#define PCIINTB   0x002</span>
<span class="cp">#define PCIINTC   0x004</span>
<span class="cp">#define PCIINTD   0x008</span>
<span class="cp">#define PCIINTE   0x010</span>
<span class="cp">#define PCIINTF   0x020</span>
<span class="cp">#define GSCEXTINT 0x040</span>
<span class="cm">/* #define xxx       0x080 - bit 7 is &quot;default&quot; */</span>
<span class="cm">/* #define xxx    0x100 - bit 8 not used */</span>
<span class="cm">/* #define xxx    0x200 - bit 9 not used */</span>
<span class="cp">#define RS232INT  0x400</span>

<span class="k">struct</span> <span class="n">dino_device</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_hba_data</span>	<span class="n">hba</span><span class="p">;</span>	<span class="cm">/* &#39;C&#39; inheritance - must be first */</span>
	<span class="n">spinlock_t</span>		<span class="n">dinosaur_pen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">txn_addr</span><span class="p">;</span> <span class="cm">/* EIR addr to generate interrupt */</span> 
	<span class="n">u32</span>			<span class="n">txn_data</span><span class="p">;</span> <span class="cm">/* EIR data assign to each dino */</span> 
	<span class="n">u32</span> 			<span class="n">imr</span><span class="p">;</span>	  <span class="cm">/* IRQ&#39;s which are enabled */</span> 
	<span class="kt">int</span>			<span class="n">global_irq</span><span class="p">[</span><span class="n">DINO_LOCAL_IRQS</span><span class="p">];</span> <span class="cm">/* map IMR bit to global irq */</span>
<span class="cp">#ifdef DINO_DEBUG</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">dino_irr0</span><span class="p">;</span> <span class="cm">/* save most recent IRQ line stat */</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* Looks nice and keeps the compiler happy */</span>
<span class="cp">#define DINO_DEV(d) ((struct dino_device *) d)</span>


<span class="cm">/*</span>
<span class="cm"> * Dino Configuration Space Accessor Functions</span>
<span class="cm"> */</span>

<span class="cp">#define DINO_CFG_TOK(bus,dfn,pos) ((u32) ((bus)&lt;&lt;16 | (dfn)&lt;&lt;8 | (pos)))</span>

<span class="cm">/*</span>
<span class="cm"> * keep the current highest bus count to assist in allocating busses.  This</span>
<span class="cm"> * tries to keep a global bus count total so that when we discover an </span>
<span class="cm"> * entirely new bus, it can be given a unique bus number.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dino_current_bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dino_cfg_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dino_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">DINO_DEV</span><span class="p">(</span><span class="n">parisc_walk_tree</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">local_bus</span> <span class="o">=</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">secondary</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v</span> <span class="o">=</span> <span class="n">DINO_CFG_TOK</span><span class="p">(</span><span class="n">local_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: %p, %d, %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">base_addr</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span>
									<span class="n">size</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dinosaur_pen</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* tell HW which CFG address */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">DINO_PCI_ADDR</span><span class="p">);</span>

	<span class="cm">/* generate cfg read cycle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">DINO_CONFIG_DATA</span> <span class="o">+</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">DINO_CONFIG_DATA</span> <span class="o">+</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">DINO_CONFIG_DATA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dinosaur_pen</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Dino address stepping &quot;feature&quot;:</span>
<span class="cm"> * When address stepping, Dino attempts to drive the bus one cycle too soon</span>
<span class="cm"> * even though the type of cycle (config vs. MMIO) might be different. </span>
<span class="cm"> * The read of Ven/Prod ID is harmless and avoids Dino&#39;s address stepping.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dino_cfg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dino_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">DINO_DEV</span><span class="p">(</span><span class="n">parisc_walk_tree</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">local_bus</span> <span class="o">=</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">secondary</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v</span> <span class="o">=</span> <span class="n">DINO_CFG_TOK</span><span class="p">(</span><span class="n">local_bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: %p, %d, %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">base_addr</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span>
									<span class="n">size</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dinosaur_pen</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* avoid address stepping feature */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">DINO_PCI_ADDR</span><span class="p">);</span>
	<span class="n">__raw_readl</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">DINO_CONFIG_DATA</span><span class="p">);</span>

	<span class="cm">/* tell HW which CFG address */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">DINO_PCI_ADDR</span><span class="p">);</span>
	<span class="cm">/* generate cfg read cycle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">DINO_CONFIG_DATA</span> <span class="o">+</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">DINO_CONFIG_DATA</span> <span class="o">+</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">DINO_CONFIG_DATA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dinosaur_pen</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_ops</span> <span class="n">dino_cfg_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>		<span class="n">dino_cfg_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">dino_cfg_write</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Dino &quot;I/O Port&quot; Space Accessor Functions</span>
<span class="cm"> *</span>
<span class="cm"> * Many PCI devices don&#39;t require use of I/O port space (eg Tulip,</span>
<span class="cm"> * NCR720) since they export the same registers to both MMIO and</span>
<span class="cm"> * I/O port space.  Performance is going to stink if drivers use</span>
<span class="cm"> * I/O port instead of MMIO.</span>
<span class="cm"> */</span>

<span class="cp">#define DINO_PORT_IN(type, size, mask) \</span>
<span class="cp">static u##size dino_in##size (struct pci_hba_data *d, u16 addr) \</span>
<span class="cp">{ \</span>
<span class="cp">	u##size v; \</span>
<span class="cp">	unsigned long flags; \</span>
<span class="cp">	spin_lock_irqsave(&amp;(DINO_DEV(d)-&gt;dinosaur_pen), flags); \</span>
<span class="cp">	</span><span class="cm">/* tell HW which IO Port address */</span><span class="cp"> \</span>
<span class="cp">	__raw_writel((u32) addr, d-&gt;base_addr + DINO_PCI_ADDR); \</span>
<span class="cp">	</span><span class="cm">/* generate I/O PORT read cycle */</span><span class="cp"> \</span>
<span class="cp">	v = read##type(d-&gt;base_addr+DINO_IO_DATA+(addr&amp;mask)); \</span>
<span class="cp">	spin_unlock_irqrestore(&amp;(DINO_DEV(d)-&gt;dinosaur_pen), flags); \</span>
<span class="cp">	return v; \</span>
<span class="cp">}</span>

<span class="n">DINO_PORT_IN</span><span class="p">(</span><span class="n">b</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">DINO_PORT_IN</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">DINO_PORT_IN</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="cp">#define DINO_PORT_OUT(type, size, mask) \</span>
<span class="cp">static void dino_out##size (struct pci_hba_data *d, u16 addr, u##size val) \</span>
<span class="cp">{ \</span>
<span class="cp">	unsigned long flags; \</span>
<span class="cp">	spin_lock_irqsave(&amp;(DINO_DEV(d)-&gt;dinosaur_pen), flags); \</span>
<span class="cp">	</span><span class="cm">/* tell HW which IO port address */</span><span class="cp"> \</span>
<span class="cp">	__raw_writel((u32) addr, d-&gt;base_addr + DINO_PCI_ADDR); \</span>
<span class="cp">	</span><span class="cm">/* generate cfg write cycle */</span><span class="cp"> \</span>
<span class="cp">	write##type(val, d-&gt;base_addr+DINO_IO_DATA+(addr&amp;mask)); \</span>
<span class="cp">	spin_unlock_irqrestore(&amp;(DINO_DEV(d)-&gt;dinosaur_pen), flags); \</span>
<span class="cp">}</span>

<span class="n">DINO_PORT_OUT</span><span class="p">(</span><span class="n">b</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">DINO_PORT_OUT</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">DINO_PORT_OUT</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_port_ops</span> <span class="n">dino_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inb</span>	<span class="o">=</span> <span class="n">dino_in8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inw</span>	<span class="o">=</span> <span class="n">dino_in16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">inl</span>	<span class="o">=</span> <span class="n">dino_in32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">outb</span>	<span class="o">=</span> <span class="n">dino_out8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">outw</span>	<span class="o">=</span> <span class="n">dino_out16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">outl</span>	<span class="o">=</span> <span class="n">dino_out32</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dino_mask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dino_device</span> <span class="o">*</span><span class="n">dino_dev</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">local_irq</span> <span class="o">=</span> <span class="n">gsc_find_local_irq</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">global_irq</span><span class="p">,</span> <span class="n">DINO_LOCAL_IRQS</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s(0x%p, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dino_dev</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* Clear the matching bit in the IMR register */</span>
	<span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">imr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DINO_MASK_IRQ</span><span class="p">(</span><span class="n">local_irq</span><span class="p">));</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">imr</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_IMR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dino_unmask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dino_device</span> <span class="o">*</span><span class="n">dino_dev</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">local_irq</span> <span class="o">=</span> <span class="n">gsc_find_local_irq</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">global_irq</span><span class="p">,</span> <span class="n">DINO_LOCAL_IRQS</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s(0x%p, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dino_dev</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	** clear pending IRQ bits</span>
<span class="cm">	**</span>
<span class="cm">	** This does NOT change ILR state!</span>
<span class="cm">	** See comment below for ILR usage.</span>
<span class="cm">	*/</span>
	<span class="n">__raw_readl</span><span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_IPR</span><span class="p">);</span>

	<span class="cm">/* set the matching bit in the IMR register */</span>
	<span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">imr</span> <span class="o">|=</span> <span class="n">DINO_MASK_IRQ</span><span class="p">(</span><span class="n">local_irq</span><span class="p">);</span>	<span class="cm">/* used in dino_isr() */</span>
	<span class="n">__raw_writel</span><span class="p">(</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">imr</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_IMR</span><span class="p">);</span>

	<span class="cm">/* Emulate &quot;Level Triggered&quot; Interrupt</span>
<span class="cm">	** Basically, a driver is blowing it if the IRQ line is asserted</span>
<span class="cm">	** while the IRQ is disabled.  But tulip.c seems to do that....</span>
<span class="cm">	** Give &#39;em a kluge award and a nice round of applause!</span>
<span class="cm">	**</span>
<span class="cm">	** The gsc_write will generate an interrupt which invokes dino_isr().</span>
<span class="cm">	** dino_isr() will read IPR and find nothing. But then catch this</span>
<span class="cm">	** when it also checks ILR.</span>
<span class="cm">	*/</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_ILR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">DINO_MASK_IRQ</span><span class="p">(</span><span class="n">local_irq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s(): IRQ asserted! (ILR 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">gsc_writel</span><span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">txn_data</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">txn_addr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">dino_interrupt_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;GSC-PCI&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">dino_unmask_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">dino_mask_irq</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Handle a Processor interrupt generated by Dino.</span>
<span class="cm"> *</span>
<span class="cm"> * ilr_loop counter is a kluge to prevent a &quot;stuck&quot; IRQ line from</span>
<span class="cm"> * wedging the CPU. Could be removed or made optional at some point.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">dino_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">intr_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dino_device</span> <span class="o">*</span><span class="n">dino_dev</span> <span class="o">=</span> <span class="n">intr_dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ilr_loop</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/* read and acknowledge pending interrupts */</span>
<span class="cp">#ifdef DINO_DEBUG</span>
	<span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">dino_irr0</span> <span class="o">=</span>
<span class="cp">#endif</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_IRR0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DINO_IRR_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

<span class="nl">ilr_again:</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">local_irq</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">global_irq</span><span class="p">[</span><span class="n">local_irq</span><span class="p">];</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s(%d, %p) mask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">intr_dev</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">local_irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">mask</span><span class="p">);</span>

	<span class="cm">/* Support for level triggered IRQ lines.</span>
<span class="cm">	** </span>
<span class="cm">	** Dropping this support would make this routine *much* faster.</span>
<span class="cm">	** But since PCI requires level triggered IRQ line to share lines...</span>
<span class="cm">	** device drivers may assume lines are level triggered (and not</span>
<span class="cm">	** edge triggered like EISA/ISA can be).</span>
<span class="cm">	*/</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_ILR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">imr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">ilr_loop</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ilr_again</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Dino 0x%p: stuck interrupt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dino_assign_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dino_device</span> <span class="o">*</span><span class="n">dino</span><span class="p">,</span> <span class="kt">int</span> <span class="n">local_irq</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">irqp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">gsc_assign_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dino_interrupt_type</span><span class="p">,</span> <span class="n">dino</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="o">*</span><span class="n">irqp</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">dino</span><span class="o">-&gt;</span><span class="n">global_irq</span><span class="p">[</span><span class="n">local_irq</span><span class="p">]</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dino_choose_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">parisc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dino_device</span> <span class="o">*</span><span class="n">dino</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">sversion</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00084</span>:	<span class="n">irq</span> <span class="o">=</span>  <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* PS/2 */</span>
		<span class="k">case</span> <span class="mh">0x0008c</span>:	<span class="n">irq</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* RS232 */</span>
		<span class="k">case</span> <span class="mh">0x00096</span>:	<span class="n">irq</span> <span class="o">=</span>  <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* PS/2 */</span>
		<span class="nl">default:</span>	<span class="k">return</span><span class="p">;</span>		 <span class="cm">/* Unknown */</span>
	<span class="p">}</span>

	<span class="n">dino_assign_irq</span><span class="p">(</span><span class="n">dino</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Cirrus 6832 Cardbus reports wrong irq on RDI Tadpole PARISC Laptop (deller@gmx.de)</span>
<span class="cm"> * (the irqs are off-by-one, not sure yet if this is a cirrus, dino-hardware or dino-driver problem...)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">quirk_cirrus_cardbus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">new_irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCI: Cirrus Cardbus IRQ fixup for %s, from %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">new_irq</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">new_irq</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">DECLARE_PCI_FIXUP_ENABLE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CIRRUS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_CIRRUS_6832</span><span class="p">,</span> <span class="n">quirk_cirrus_cardbus</span> <span class="p">);</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">dino_bios_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;dino_bios_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * dino_card_setup - Set up the memory space for a Dino in card mode.</span>
<span class="cm"> * @bus: the bus under this dino</span>
<span class="cm"> *</span>
<span class="cm"> * Claim an 8MB chunk of unused IO space and call the generic PCI routines</span>
<span class="cm"> * to set up the addresses of the devices on this bus.</span>
<span class="cm"> */</span>
<span class="cp">#define _8MB 0x00800000UL</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">dino_card_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dino_device</span> <span class="o">*</span><span class="n">dino_dev</span> <span class="o">=</span> <span class="n">DINO_DEV</span><span class="p">(</span><span class="n">parisc_walk_tree</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">lmmio_space</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;Dino LMMIO (%s)&quot;</span><span class="p">,</span> 
			 <span class="n">dev_name</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">));</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">lmmio_space</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
	

	<span class="k">if</span> <span class="p">(</span><span class="n">ccio_allocate_resource</span><span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">_8MB</span><span class="p">,</span>
				<span class="n">F_EXTEND</span><span class="p">(</span><span class="mh">0xf0000000UL</span><span class="p">)</span> <span class="o">|</span> <span class="n">_8MB</span><span class="p">,</span>
				<span class="n">F_EXTEND</span><span class="p">(</span><span class="mh">0xffffffffUL</span><span class="p">)</span> <span class="o">&amp;~</span> <span class="n">_8MB</span><span class="p">,</span> <span class="n">_8MB</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ln</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_ln</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Dino: cannot attach bus %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_name</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">));</span>
		<span class="cm">/* kill the bus, we can&#39;t do anything with it */</span>
		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">tmp_ln</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_dev_b</span><span class="p">(</span><span class="n">ln</span><span class="p">);</span>

			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_list</span><span class="p">);</span>
		<span class="p">}</span>
			
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">io_space</span><span class="p">);</span>

	<span class="cm">/* Now tell dino what range it has */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">31</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="n">F_EXTEND</span><span class="p">(</span><span class="mh">0xf0000000UL</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">_8MB</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;DINO GSC WRITE i=%d, start=%lx, dino addr = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">i</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">DINO_IO_ADDR_EN</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">DINO_IO_ADDR_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">dino_card_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">irq_pin</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	** REVISIT: card-mode PCI-PCI expansion chassis do exist.</span>
<span class="cm">	**         Not sure they were ever productized.</span>
<span class="cm">	**         Die here since we&#39;ll die later in dino_inb() anyway.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_CLASS_BRIDGE_PCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Card-Mode Dino: PCI-PCI Bridge not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	** Set Latency Timer to 0xff (not a shared bus)</span>
<span class="cm">	** Set CACHELINE_SIZE.</span>
<span class="cm">	*/</span>
	<span class="n">dino_cfg_write</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">,</span> 
		       <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xff00</span> <span class="o">|</span> <span class="n">L1_CACHE_BYTES</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span> 

	<span class="cm">/*</span>
<span class="cm">	** Program INT_LINE for card-mode devices.</span>
<span class="cm">	** The cards are hardwired according to this algorithm.</span>
<span class="cm">	** And it doesn&#39;t matter if PPB&#39;s are present or not since</span>
<span class="cm">	** the IRQ lines bypass the PPB.</span>
<span class="cm">	**</span>
<span class="cm">	** &quot;-1&quot; converts INTA-D (1-4) to PCIINTA-D (0-3) range.</span>
<span class="cm">	** The additional &quot;-1&quot; adjusts for skewing the IRQ&lt;-&gt;slot.</span>
<span class="cm">	*/</span>
	<span class="n">dino_cfg_read</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_PIN</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_pin</span><span class="p">);</span> 
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci_swizzle_interrupt_pin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">irq_pin</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Shouldn&#39;t really need to do this but it&#39;s in case someone tries</span>
<span class="cm">	** to bypass PCI services and look at the card themselves.</span>
<span class="cm">	*/</span>
	<span class="n">dino_cfg_write</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span> 
<span class="p">}</span>

<span class="cm">/* The alignment contraints for PCI bridges under dino */</span>
<span class="cp">#define DINO_BRIDGE_ALIGN 0x100000</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">dino_fixup_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ln</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">dino_device</span> <span class="o">*</span><span class="n">dino_dev</span> <span class="o">=</span> <span class="n">DINO_DEV</span><span class="p">(</span><span class="n">parisc_walk_tree</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">));</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s(0x%p) bus %d platform_data 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">secondary</span><span class="p">,</span>
	    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">);</span>

	<span class="cm">/* Firmware doesn&#39;t set up card-mode dino, so we have to */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_card_dino</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dino_card_setup</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">pci_read_bridge_bases</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>


		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">PCI_BRIDGE_RESOURCES</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCI_NUM_RESOURCES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> 
			    <span class="p">(</span><span class="n">IORESOURCE_IO</span> <span class="o">|</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			
			<span class="k">if</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* There&#39;s a quirk to alignment of</span>
<span class="cm">				 * bridge memory resources: the start</span>
<span class="cm">				 * is the alignment and start-end is</span>
<span class="cm">				 * the size.  However, firmware will</span>
<span class="cm">				 * have assigned start and end, so we</span>
<span class="cm">				 * need to take this into account */</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="n">DINO_BRIDGE_ALIGN</span><span class="p">;</span>
				<span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">DINO_BRIDGE_ALIGN</span><span class="p">;</span>
				
			<span class="p">}</span>
					
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;DEBUG %s assigning %d [0x%lx,0x%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span>
			    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
			    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end</span><span class="p">);</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">pci_assign_resource</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;DEBUG %s after assign %d [0x%lx,0x%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span>
			    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
			    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="n">list_for_each</span><span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_dev_b</span><span class="p">(</span><span class="n">ln</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_card_dino</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
			<span class="n">dino_card_fixup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		** P2PB&#39;s only have 2 BARs, no IRQs.</span>
<span class="cm">		** I&#39;d like to just ignore them for now.</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_CLASS_BRIDGE_PCI</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* null out the ROM resource if there is one (we don&#39;t</span>
<span class="cm">		 * care about an expansion rom on parisc, since it</span>
<span class="cm">		 * usually contains (x86) bios code) */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">PCI_ROM_RESOURCE</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				
		<span class="k">if</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>

<span class="cp">#define DINO_FIX_UNASSIGNED_INTERRUPTS</span>
<span class="cp">#ifdef DINO_FIX_UNASSIGNED_INTERRUPTS</span>

			<span class="cm">/* This code tries to assign an unassigned</span>
<span class="cm">			 * interrupt.  Leave it disabled unless you</span>
<span class="cm">			 * *really* know what you&#39;re doing since the</span>
<span class="cm">			 * pin&lt;-&gt;interrupt line mapping varies by bus</span>
<span class="cm">			 * and machine */</span>

			<span class="n">u32</span> <span class="n">irq_pin</span><span class="p">;</span>
			
			<span class="n">dino_cfg_read</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">,</span> 
				      <span class="n">PCI_INTERRUPT_PIN</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_pin</span><span class="p">);</span>
			<span class="n">irq_pin</span> <span class="o">=</span> <span class="n">pci_swizzle_interrupt_pin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">irq_pin</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Device %s has undefined IRQ, &quot;</span>
					<span class="s">&quot;setting to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">irq_pin</span><span class="p">);</span>
			<span class="n">dino_cfg_write</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">,</span> 
				       <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">irq_pin</span><span class="p">);</span>
			<span class="n">dino_assign_irq</span><span class="p">(</span><span class="n">dino_dev</span><span class="p">,</span> <span class="n">irq_pin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Device %s has unassigned IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Adjust INT_LINE for that busses region */</span>
			<span class="n">dino_assign_irq</span><span class="p">(</span><span class="n">dino_dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_bios_ops</span> <span class="n">dino_bios_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">dino_bios_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fixup_bus</span>	<span class="o">=</span> <span class="n">dino_fixup_bus</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> *	Initialise a DINO controller chip</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">dino_card_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dino_device</span> <span class="o">*</span><span class="n">dino_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">brdg_feat</span> <span class="o">=</span> <span class="mh">0x00784e05</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_IO_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0000ff80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00000005</span><span class="p">,</span>
				<span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_IO_COMMAND</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_GMASK</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_IO_FBB_EN</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_ICR</span><span class="p">);</span>

<span class="cp">#if 1</span>
<span class="cm">/* REVISIT - should be a runtime check (eg if (CPU_IS_PCX_L) ...) */</span>
	<span class="cm">/*</span>
<span class="cm">	** PCX-L processors don&#39;t support XQL like Dino wants it.</span>
<span class="cm">	** PCX-L2 ignore XQL signal and it doesn&#39;t matter.</span>
<span class="cm">	*/</span>
	<span class="n">brdg_feat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x4</span><span class="p">;</span>	<span class="cm">/* UXQL */</span>
<span class="cp">#endif</span>
	<span class="n">__raw_writel</span><span class="p">(</span> <span class="n">brdg_feat</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_BRDG_FEAT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	** Don&#39;t enable address decoding until we know which I/O range</span>
<span class="cm">	** currently is available from the host. Only affects MMIO</span>
<span class="cm">	** and not I/O port space.</span>
<span class="cm">	*/</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_IO_ADDR_EN</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_DAMODE</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00222222</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_PCIROR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00222222</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_PCIWOR</span><span class="p">);</span>

	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00000040</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_MLTIM</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00000080</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_IO_CONTROL</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0000008c</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_TLTIM</span><span class="p">);</span>

	<span class="cm">/* Disable PAMR before writing PAPR */</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0000007e</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_PAMR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0000007f</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_PAPR</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_PAMR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	** Dino ERS encourages enabling FBB (0x6f).</span>
<span class="cm">	** We can&#39;t until we know *all* devices below us can support it.</span>
<span class="cm">	** (Something in device configuration header tells us).</span>
<span class="cm">	*/</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="mh">0x0000004f</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_PCICMD</span><span class="p">);</span>

	<span class="cm">/* Somewhere, the PCI spec says give devices 1 second</span>
<span class="cm">	** to recover from the #RESET being de-asserted.</span>
<span class="cm">	** Experience shows most devices only need 10ms.</span>
<span class="cm">	** This short-cut speeds up booting significantly.</span>
<span class="cm">	*/</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">pci_post_reset_delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">dino_bridge_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dino_device</span> <span class="o">*</span><span class="n">dino_dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="o">*</span><span class="n">prevres</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Decoding IO_ADDR_EN only works for Built-in Dino</span>
<span class="cm">	 * since PDC has already initialized this.</span>
<span class="cm">	 */</span>

	<span class="n">io_addr</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">DINO_IO_ADDR_EN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: No PCI devices enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">lmmio_space</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>

		<span class="k">if</span><span class="p">((</span><span class="n">io_addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">F_EXTEND</span><span class="p">(</span><span class="mh">0xf0000000UL</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;DINO RANGE %d is at 0x%lx-0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
		    <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">prevres</span> <span class="o">&amp;&amp;</span> <span class="n">prevres</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prevres</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">DINO_MAX_LMMIO_RESOURCES</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s is out of resource windows for range %d (0x%lx-0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">prevres</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
				<span class="n">snprintf</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="s">&quot;%s LMMIO %d&quot;</span><span class="p">,</span>
					 <span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="n">res</span><span class="o">++</span><span class="p">;</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">lmmio_space</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DINO_MAX_LMMIO_RESOURCES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">ccio_request_resource</span><span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: failed to claim PCI Bus address &quot;</span>
			       <span class="s">&quot;space %d (0x%lx-0x%lx)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dino_common_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">parisc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">dino_device</span> <span class="o">*</span><span class="n">dino_dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">eim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gsc_irq</span> <span class="n">gsc_irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">pcibios_register_hba</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">);</span>

	<span class="n">pci_bios</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dino_bios_ops</span><span class="p">;</span>   <span class="cm">/* used by pci_scan_bus() */</span>
	<span class="n">pci_port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dino_port_ops</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	** Note: SMP systems can make use of IRR1/IAR1 registers</span>
<span class="cm">	**   But it won&#39;t buy much performance except in very</span>
<span class="cm">	**   specific applications/configurations. Note Dino</span>
<span class="cm">	**   still only has 11 IRQ input lines - just map some of them</span>
<span class="cm">	**   to a different processor.</span>
<span class="cm">	*/</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">gsc_alloc_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gsc_irq</span><span class="p">);</span>
	<span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">txn_addr</span> <span class="o">=</span> <span class="n">gsc_irq</span><span class="p">.</span><span class="n">txn_addr</span><span class="p">;</span>
	<span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">txn_data</span> <span class="o">=</span> <span class="n">gsc_irq</span><span class="p">.</span><span class="n">txn_data</span><span class="p">;</span>
	<span class="n">eim</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">gsc_irq</span><span class="p">.</span><span class="n">txn_addr</span><span class="p">)</span> <span class="o">|</span> <span class="n">gsc_irq</span><span class="p">.</span><span class="n">txn_data</span><span class="p">;</span>

	<span class="cm">/* </span>
<span class="cm">	** Dino needs a PA &quot;IRQ&quot; to get a processor&#39;s attention.</span>
<span class="cm">	** arch/parisc/kernel/irq.c returns an EIRR bit.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: gsc_alloc_irq() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dino_isr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dino_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: request_irq() failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			<span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Support the serial port which is sometimes attached on built-in</span>
<span class="cm">	 * Dino / Cujo chips.</span>
<span class="cm">	 */</span>

	<span class="n">gsc_fixup_irqs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dino_dev</span><span class="p">,</span> <span class="n">dino_choose_irq</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	** This enables DINO to generate interrupts when it sees</span>
<span class="cm">	** any of its inputs *change*. Just asserting an IRQ</span>
<span class="cm">	** before it&#39;s enabled (ie unmasked) isn&#39;t good enough.</span>
<span class="cm">	*/</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">eim</span><span class="p">,</span> <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_IAR0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	** Some platforms don&#39;t clear Dino&#39;s IRR0 register at boot time.</span>
<span class="cm">	** Reading will clear it now.</span>
<span class="cm">	*/</span>
	<span class="n">__raw_readl</span><span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DINO_IRR0</span><span class="p">);</span>

	<span class="cm">/* allocate I/O Port resource region */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">io_space</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cujo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dino I/O Port&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Cujo I/O Port&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">HBA_PORT_BASE</span><span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">hba_num</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">HBA_PORT_SPACE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IO</span><span class="p">;</span> <span class="cm">/* do not mark it busy ! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: request I/O Port region failed &quot;</span>
		       <span class="s">&quot;0x%lx/%lx (hpa 0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span>
		       <span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CUJO_RAVEN_ADDR		F_EXTEND(0xf1000000UL)</span>
<span class="cp">#define CUJO_FIREHAWK_ADDR	F_EXTEND(0xf1604000UL)</span>
<span class="cp">#define CUJO_RAVEN_BADPAGE	0x01003000UL</span>
<span class="cp">#define CUJO_FIREHAWK_BADPAGE	0x01607000UL</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dino_vers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;2.0&quot;</span><span class="p">,</span>
	<span class="s">&quot;2.1&quot;</span><span class="p">,</span>
	<span class="s">&quot;3.0&quot;</span><span class="p">,</span>
	<span class="s">&quot;3.1&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cujo_vers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;1.0&quot;</span><span class="p">,</span>
	<span class="s">&quot;2.0&quot;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">ccio_cujo20_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">parisc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">iovp</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">** Determine if dino should claim this chip (return 0) or not (return 1).</span>
<span class="cm">** If so, initialize the chip appropriately (card-mode vs bridge mode).</span>
<span class="cm">** Much of the initialization is common though.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dino_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">parisc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dino_device</span> <span class="o">*</span><span class="n">dino_dev</span><span class="p">;</span>	<span class="c1">// Dino specific control struct</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_cujo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">resources</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hpa</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hpa</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>

	<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dino&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_card_dino</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">version</span> <span class="o">=</span> <span class="s">&quot;3.x (card mode)&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cujo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">hversion_rev</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">version</span> <span class="o">=</span> <span class="n">dino_vers</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">hversion_rev</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Cujo&quot;</span><span class="p">;</span>
			<span class="n">is_cujo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">hversion_rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">version</span> <span class="o">=</span> <span class="n">cujo_vers</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">hversion_rev</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s version %s found at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">hpa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">hpa</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DINO: Hey! Someone took my MMIO space (0x%ld)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hpa</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for bugs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_cujo</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">hversion_rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IOMMU_CCIO</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Enabling Cujo 2.0 bug workaround</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpa</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">CUJO_RAVEN_ADDR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccio_cujo20_fixup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CUJO_RAVEN_BADPAGE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hpa</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">CUJO_FIREHAWK_ADDR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccio_cujo20_fixup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CUJO_FIREHAWK_BADPAGE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Don&#39;t recognise Cujo at address 0x%lx, not enabling workaround</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hpa</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cujo</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_card_dino</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">hversion_rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
<span class="s">&quot;The GSCtoPCI (Dino hrev %d) bus converter found may exhibit</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;data corruption.  See Service Note Numbers: A4190A-01, A4191A-01.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Systems shipped after Aug 20, 1997 will not exhibit this problem.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;Models affected: C180, C160, C160L, B160L, and B132L workstations.</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">hversion_rev</span><span class="p">);</span>
<span class="cm">/* REVISIT: why are C200/C240 listed in the README table but not</span>
<span class="cm">**   &quot;Models affected&quot;? Could be an omission in the original literature.</span>
<span class="cm">*/</span>
	<span class="p">}</span>

	<span class="n">dino_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dino_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dino_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dino_init_chip - couldn&#39;t alloc dino_device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">hpa</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">lmmio_space_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* CPU addrs == bus addrs */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">dinosaur_pen</span><span class="p">);</span>
	<span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">iommu</span> <span class="o">=</span> <span class="n">ccio_get_iommu</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_card_dino</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dino_card_init</span><span class="p">(</span><span class="n">dino_dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dino_bridge_init</span><span class="p">(</span><span class="n">dino_dev</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dino_common_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dino_dev</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">dino_dev</span><span class="p">;</span>

	<span class="n">pci_add_resource_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resources</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">io_space</span><span class="p">,</span>
				<span class="n">HBA_PORT_BASE</span><span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">hba_num</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">lmmio_space</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span>
		<span class="n">pci_add_resource_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resources</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">lmmio_space</span><span class="p">,</span>
					<span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">lmmio_space_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">elmmio_space</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span>
		<span class="n">pci_add_resource_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resources</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">elmmio_space</span><span class="p">,</span>
					<span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">lmmio_space_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">gmmio_space</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span>
		<span class="n">pci_add_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resources</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">gmmio_space</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	** It&#39;s not used to avoid chicken/egg problems</span>
<span class="cm">	** with configuration accessor functions.</span>
<span class="cm">	*/</span>
	<span class="n">dino_dev</span><span class="o">-&gt;</span><span class="n">hba</span><span class="p">.</span><span class="n">hba_bus</span> <span class="o">=</span> <span class="n">bus</span> <span class="o">=</span> <span class="n">pci_create_root_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="n">dino_current_bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dino_cfg_ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resources</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ERROR: failed to scan PCI bus on %s (duplicate bus number %d?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">dino_current_bus</span><span class="p">);</span>
		<span class="n">pci_free_resource_list</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resources</span><span class="p">);</span>
		<span class="cm">/* increment the bus number in case of duplicates */</span>
		<span class="n">dino_current_bus</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">=</span> <span class="n">pci_scan_child_bus</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="cm">/* This code *depends* on scanning being single threaded</span>
<span class="cm">	 * if it isn&#39;t, this global bus number count will fail</span>
<span class="cm">	 */</span>
	<span class="n">dino_current_bus</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pci_bus_assign_resources</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">pci_bus_add_devices</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Normally, we would just test sversion.  But the Elroy PCI adapter has</span>
<span class="cm"> * the same sversion as Dino, so we have to check hversion as well.</span>
<span class="cm"> * Unfortunately, the J2240 PDC reports the wrong hversion for the first</span>
<span class="cm"> * Dino, so we have to test for Dino, Cujo and Dino-in-a-J2240.</span>
<span class="cm"> * For card-mode Dino, most machines report an sversion of 9D.  But 715</span>
<span class="cm"> * and 725 firmware misreport it as 0x08080 for no adequately explained</span>
<span class="cm"> * reason.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">parisc_device_id</span> <span class="n">dino_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">HPHW_A_DMA</span><span class="p">,</span> <span class="n">HVERSION_REV_ANY_ID</span><span class="p">,</span> <span class="mh">0x004</span><span class="p">,</span> <span class="mh">0x0009D</span> <span class="p">},</span><span class="cm">/* Card-mode Dino */</span>
	<span class="p">{</span> <span class="n">HPHW_A_DMA</span><span class="p">,</span> <span class="n">HVERSION_REV_ANY_ID</span><span class="p">,</span> <span class="n">HVERSION_ANY_ID</span><span class="p">,</span> <span class="mh">0x08080</span> <span class="p">},</span> <span class="cm">/* XXX */</span>
	<span class="p">{</span> <span class="n">HPHW_BRIDGE</span><span class="p">,</span> <span class="n">HVERSION_REV_ANY_ID</span><span class="p">,</span> <span class="mh">0x680</span><span class="p">,</span> <span class="mh">0xa</span> <span class="p">},</span> <span class="cm">/* Bridge-mode Dino */</span>
	<span class="p">{</span> <span class="n">HPHW_BRIDGE</span><span class="p">,</span> <span class="n">HVERSION_REV_ANY_ID</span><span class="p">,</span> <span class="mh">0x682</span><span class="p">,</span> <span class="mh">0xa</span> <span class="p">},</span> <span class="cm">/* Bridge-mode Cujo */</span>
	<span class="p">{</span> <span class="n">HPHW_BRIDGE</span><span class="p">,</span> <span class="n">HVERSION_REV_ANY_ID</span><span class="p">,</span> <span class="mh">0x05d</span><span class="p">,</span> <span class="mh">0xa</span> <span class="p">},</span> <span class="cm">/* Dino in a J2240 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">parisc_driver</span> <span class="n">dino_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;dino&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">dino_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">dino_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * One time initialization to let the world know Dino is here.</span>
<span class="cm"> * This is the only routine which is NOT static.</span>
<span class="cm"> * Must be called exactly once before pci_init().</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">dino_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">register_parisc_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dino_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
