<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › parisc › led.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>led.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *    Chassis LCD/LED driver for HP-PARISC workstations</span>
<span class="cm"> *</span>
<span class="cm"> *      (c) Copyright 2000 Red Hat Software</span>
<span class="cm"> *      (c) Copyright 2000 Helge Deller &lt;hdeller@redhat.com&gt;</span>
<span class="cm"> *      (c) Copyright 2001-2009 Helge Deller &lt;deller@gmx.de&gt;</span>
<span class="cm"> *      (c) Copyright 2001 Randolph Chung &lt;tausq@debian.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *      This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *      it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *      the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *      (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> *	- speed-up calculations with inlined assembler</span>
<span class="cm"> *	- interface to write to second row of LCD from /proc (if technically possible)</span>
<span class="cm"> *</span>
<span class="cm"> * Changes:</span>
<span class="cm"> *      - Audit copy_from_user in led_proc_write.</span>
<span class="cm"> *                                Daniele Bellucci &lt;bellucda@tiscali.it&gt;</span>
<span class="cm"> *	- Switch from using a tasklet to a work queue, so the led_LCD_driver</span>
<span class="cm"> *	  	can sleep.</span>
<span class="cm"> *	  			  David Pye &lt;dmp@davidmpye.dyndns.org&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;	</span><span class="cm">/* for offsetof() */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/utsname.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/kernel_stat.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/rcupdate.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/hardware.h&gt;</span>
<span class="cp">#include &lt;asm/param.h&gt;		</span><span class="cm">/* HZ */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/led.h&gt;</span>
<span class="cp">#include &lt;asm/pdc.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cm">/* The control of the LEDs and LCDs on PARISC-machines have to be done </span>
<span class="cm">   completely in software. The necessary calculations are done in a work queue</span>
<span class="cm">   task which is scheduled regularly, and since the calculations may consume a </span>
<span class="cm">   relatively large amount of CPU time, some of the calculations can be </span>
<span class="cm">   turned off with the following variables (controlled via procfs) */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">led_type</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lastleds</span><span class="p">;</span>	<span class="cm">/* LED state from most recent update */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">led_heartbeat</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">led_diskio</span>    <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">led_lanrxtx</span>   <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">lcd_text</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span>          <span class="n">__read_mostly</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">lcd_text_default</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span>  <span class="n">__read_mostly</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">lcd_no_led_support</span>    <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* KittyHawk doesn&#39;t support LED on its LCD */</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">led_wq</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">led_work_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_DELAYED_WORK</span><span class="p">(</span><span class="n">led_task</span><span class="p">,</span> <span class="n">led_work_func</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define DPRINTK(x)	printk x</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTK(x)</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">lcd_block</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">command</span><span class="p">;</span>	<span class="cm">/* stores the command byte      */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">on</span><span class="p">;</span>	<span class="cm">/* value for turning LED on     */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">off</span><span class="p">;</span>	<span class="cm">/* value for turning LED off    */</span>
<span class="p">};</span>

<span class="cm">/* Structure returned by PDC_RETURN_CHASSIS_INFO */</span>
<span class="cm">/* NOTE: we use unsigned long:16 two times, since the following member </span>
<span class="cm">   lcd_cmd_reg_addr needs to be 64bit aligned on 64bit PA2.0-machines */</span>
<span class="k">struct</span> <span class="n">pdc_chassis_lcd_info_ret_block</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">model</span><span class="o">:</span><span class="mi">16</span><span class="p">;</span>		<span class="cm">/* DISPLAY_MODEL_XXXX */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lcd_width</span><span class="o">:</span><span class="mi">16</span><span class="p">;</span>	<span class="cm">/* width of the LCD in chars (DISPLAY_MODEL_LCD only) */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lcd_cmd_reg_addr</span><span class="p">;</span>	<span class="cm">/* ptr to LCD cmd-register &amp; data ptr for LED */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lcd_data_reg_addr</span><span class="p">;</span> <span class="cm">/* ptr to LCD data-register (LCD only) */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_cmd_delay</span><span class="p">;</span>	<span class="cm">/* delay in uS after cmd-write (LCD only) */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reset_cmd1</span><span class="p">;</span>	<span class="cm">/* command #1 for writing LCD string (LCD only) */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reset_cmd2</span><span class="p">;</span>	<span class="cm">/* command #2 for writing LCD string (LCD only) */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">act_enable</span><span class="p">;</span>	<span class="cm">/* 0 = no activity (LCD only) */</span>
	<span class="k">struct</span> <span class="n">lcd_block</span> <span class="n">heartbeat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcd_block</span> <span class="n">disk_io</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcd_block</span> <span class="n">lan_rcv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lcd_block</span> <span class="n">lan_tx</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">_pad</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/* LCD_CMD and LCD_DATA for KittyHawk machines */</span>
<span class="cp">#define KITTYHAWK_LCD_CMD  F_EXTEND(0xf0190000UL) </span><span class="cm">/* 64bit-ready */</span><span class="cp"></span>
<span class="cp">#define KITTYHAWK_LCD_DATA (KITTYHAWK_LCD_CMD+1)</span>

<span class="cm">/* lcd_info is pre-initialized to the values needed to program KittyHawk LCD&#39;s </span>
<span class="cm"> * HP seems to have used Sharp/Hitachi HD44780 LCDs most of the time. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pdc_chassis_lcd_info_ret_block</span>
<span class="n">lcd_info</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">8</span><span class="p">)))</span> <span class="n">__read_mostly</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">model</span> <span class="o">=</span>		<span class="n">DISPLAY_MODEL_LCD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lcd_width</span> <span class="o">=</span>		<span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lcd_cmd_reg_addr</span> <span class="o">=</span>	<span class="n">KITTYHAWK_LCD_CMD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lcd_data_reg_addr</span> <span class="o">=</span>	<span class="n">KITTYHAWK_LCD_DATA</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_cmd_delay</span> <span class="o">=</span>	<span class="mi">80</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_cmd1</span> <span class="o">=</span>		<span class="mh">0x80</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_cmd2</span> <span class="o">=</span>		<span class="mh">0xc0</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* direct access to some of the lcd_info variables */</span>
<span class="cp">#define LCD_CMD_REG	lcd_info.lcd_cmd_reg_addr	 </span>
<span class="cp">#define LCD_DATA_REG	lcd_info.lcd_data_reg_addr	 </span>
<span class="cp">#define LED_DATA_REG	lcd_info.lcd_cmd_reg_addr	</span><span class="cm">/* LASI &amp; ASP only */</span><span class="cp"></span>

<span class="cp">#define LED_HASLCD 1</span>
<span class="cp">#define LED_NOLCD  0</span>

<span class="cm">/* The workqueue must be created at init-time */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">start_task</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> 
<span class="p">{</span>	
	<span class="cm">/* Display the default text now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">led_type</span> <span class="o">==</span> <span class="n">LED_HASLCD</span><span class="p">)</span> <span class="n">lcd_print</span><span class="p">(</span> <span class="n">lcd_text_default</span> <span class="p">);</span>

	<span class="cm">/* KittyHawk has no LED support on its LCD */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_no_led_support</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Create the work queue and queue the LED task */</span>
	<span class="n">led_wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;led_wq&quot;</span><span class="p">);</span>	
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">led_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led_task</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">device_initcall</span><span class="p">(</span><span class="n">start_task</span><span class="p">);</span>

<span class="cm">/* ptr to LCD/LED-specific function */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">led_func_ptr</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">led_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">LED_NOLCD</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Heartbeat: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">led_heartbeat</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Disk IO: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">led_diskio</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;LAN Rx/Tx: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">led_lanrxtx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_HASLCD</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lcd_text</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">led_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">led_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">led_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cur</span><span class="p">,</span> <span class="n">lbuf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lbuf</span><span class="p">))</span>
		<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lbuf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">lbuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">lbuf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cur</span> <span class="o">=</span> <span class="n">lbuf</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">data</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">LED_NOLCD</span>:
		<span class="n">d</span> <span class="o">=</span> <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">d</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">parse_error</span><span class="p">;</span>
		<span class="n">led_heartbeat</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="k">goto</span> <span class="n">parse_error</span><span class="p">;</span>

		<span class="n">d</span> <span class="o">=</span> <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">d</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">parse_error</span><span class="p">;</span>
		<span class="n">led_diskio</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="k">goto</span> <span class="n">parse_error</span><span class="p">;</span>

		<span class="n">d</span> <span class="o">=</span> <span class="o">*</span><span class="n">cur</span><span class="o">++</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">d</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">parse_error</span><span class="p">;</span>
		<span class="n">led_lanrxtx</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LED_HASLCD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cur</span> <span class="o">&amp;&amp;</span> <span class="n">cur</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="n">cur</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cur</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> 
			<span class="n">cur</span> <span class="o">=</span> <span class="n">lcd_text_default</span><span class="p">;</span>
		<span class="n">lcd_print</span><span class="p">(</span><span class="n">cur</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

<span class="nl">parse_error:</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">data</span> <span class="o">==</span> <span class="n">LED_NOLCD</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;Parse error: expect </span><span class="se">\&quot;</span><span class="s">n n n</span><span class="se">\&quot;</span><span class="s"> (n == 0 or 1) for heartbeat,</span><span class="se">\n</span><span class="s">disk io and lan tx/rx indicators</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">led_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">led_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">led_proc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">led_create_procfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">proc_pdc_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">led_type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">proc_pdc_root</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;pdc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc_pdc_root</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lcd_no_led_support</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">ent</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;led&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">proc_pdc_root</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">led_proc_fops</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">LED_NOLCD</span><span class="p">);</span> <span class="cm">/* LED */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">led_type</span> <span class="o">==</span> <span class="n">LED_HASLCD</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">ent</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;lcd&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">proc_pdc_root</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">led_proc_fops</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">LED_HASLCD</span><span class="p">);</span> <span class="cm">/* LCD */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">   ** </span>
<span class="cm">   ** led_ASP_driver()</span>
<span class="cm">   ** </span>
<span class="cm"> */</span>
<span class="cp">#define	LED_DATA	0x01	</span><span class="cm">/* data to shift (0:on 1:off) */</span><span class="cp"></span>
<span class="cp">#define	LED_STROBE	0x02	</span><span class="cm">/* strobe to clock data */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">led_ASP_driver</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">leds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">leds</span> <span class="o">=</span> <span class="o">~</span><span class="n">leds</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">leds</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">gsc_writeb</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span>		 <span class="n">LED_DATA_REG</span> <span class="p">);</span>
		<span class="n">gsc_writeb</span><span class="p">(</span> <span class="n">value</span> <span class="o">|</span> <span class="n">LED_STROBE</span><span class="p">,</span>	 <span class="n">LED_DATA_REG</span> <span class="p">);</span>
		<span class="n">leds</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">   ** </span>
<span class="cm">   ** led_LASI_driver()</span>
<span class="cm">   ** </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">led_LASI_driver</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">leds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">leds</span> <span class="o">=</span> <span class="o">~</span><span class="n">leds</span><span class="p">;</span>
	<span class="n">gsc_writeb</span><span class="p">(</span> <span class="n">leds</span><span class="p">,</span> <span class="n">LED_DATA_REG</span> <span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">   ** </span>
<span class="cm">   ** led_LCD_driver()</span>
<span class="cm">   **   </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">led_LCD_driver</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">leds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">LED_HEARTBEAT</span><span class="p">,</span> <span class="n">LED_DISK_IO</span><span class="p">,</span>
		<span class="n">LED_LAN_RCV</span><span class="p">,</span> <span class="n">LED_LAN_TX</span> <span class="p">};</span>
	
	<span class="k">static</span> <span class="k">struct</span> <span class="n">lcd_block</span> <span class="o">*</span> <span class="n">blockp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="o">&amp;</span><span class="n">lcd_info</span><span class="p">.</span><span class="n">heartbeat</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">lcd_info</span><span class="p">.</span><span class="n">disk_io</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">lcd_info</span><span class="p">.</span><span class="n">lan_rcv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">lcd_info</span><span class="p">.</span><span class="n">lan_tx</span>
	<span class="p">};</span>

	<span class="cm">/* Convert min_cmd_delay to milliseconds */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msec_cmd_delay</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">lcd_info</span><span class="p">.</span><span class="n">min_cmd_delay</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">leds</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="p">(</span><span class="n">lastleds</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> 
		<span class="p">{</span>
			<span class="n">gsc_writeb</span><span class="p">(</span> <span class="n">blockp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">LCD_CMD_REG</span> <span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">msec_cmd_delay</span><span class="p">);</span>
			
			<span class="n">gsc_writeb</span><span class="p">(</span> <span class="n">leds</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">blockp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">on</span> <span class="o">:</span> 
					<span class="n">blockp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">off</span><span class="p">,</span> <span class="n">LCD_DATA_REG</span> <span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">msec_cmd_delay</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">   ** </span>
<span class="cm">   ** led_get_net_activity()</span>
<span class="cm">   ** </span>
<span class="cm">   ** calculate if there was TX- or RX-throughput on the network interfaces</span>
<span class="cm">   ** (analog to dev_get_info() from net/core/dev.c)</span>
<span class="cm">   **   </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">led_get_net_activity</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span> 
<span class="cp">#ifndef CONFIG_NET</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">static</span> <span class="n">u64</span> <span class="n">rx_total_last</span><span class="p">,</span> <span class="n">tx_total_last</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rx_total</span><span class="p">,</span> <span class="n">tx_total</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">rx_total</span> <span class="o">=</span> <span class="n">tx_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="cm">/* we are running as a workqueue task, so we can use an RCU lookup */</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">for_each_netdev_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">const</span> <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	    <span class="k">struct</span> <span class="n">rtnl_link_stats64</span> <span class="n">temp</span><span class="p">;</span>
	    <span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">__in_dev_get_rcu</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">)</span>
		<span class="k">continue</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">ipv4_is_loopback</span><span class="p">(</span><span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">))</span>
		<span class="k">continue</span><span class="p">;</span>
	    <span class="n">stats</span> <span class="o">=</span> <span class="n">dev_get_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	    <span class="n">rx_total</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">;</span>
	    <span class="n">tx_total</span> <span class="o">+=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_total</span> <span class="o">!=</span> <span class="n">rx_total_last</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_total_last</span> <span class="o">=</span> <span class="n">rx_total</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">LED_LAN_RCV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_total</span> <span class="o">!=</span> <span class="n">tx_total_last</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_total_last</span> <span class="o">=</span> <span class="n">tx_total</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">LED_LAN_TX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">   ** </span>
<span class="cm">   ** led_get_diskio_activity()</span>
<span class="cm">   ** </span>
<span class="cm">   ** calculate if there was disk-io in the system</span>
<span class="cm">   **   </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">led_get_diskio_activity</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>	
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_pgpgin</span><span class="p">,</span> <span class="n">last_pgpgout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">events</span><span class="p">[</span><span class="n">NR_VM_EVENT_ITEMS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">changed</span><span class="p">;</span>

	<span class="n">all_vm_events</span><span class="p">(</span><span class="n">events</span><span class="p">);</span>

	<span class="cm">/* Just use a very simple calculation here. Do not care about overflow,</span>
<span class="cm">	   since we only want to know if there was activity or not. */</span>
	<span class="n">changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">PGPGIN</span><span class="p">]</span> <span class="o">!=</span> <span class="n">last_pgpgin</span><span class="p">)</span> <span class="o">||</span>
		  <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">PGPGOUT</span><span class="p">]</span> <span class="o">!=</span> <span class="n">last_pgpgout</span><span class="p">);</span>
	<span class="n">last_pgpgin</span>  <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">PGPGIN</span><span class="p">];</span>
	<span class="n">last_pgpgout</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">PGPGOUT</span><span class="p">];</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">changed</span> <span class="o">?</span> <span class="n">LED_DISK_IO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm">   ** led_work_func()</span>
<span class="cm">   ** </span>
<span class="cm">   ** manages when and which chassis LCD/LED gets updated</span>

<span class="cm">    TODO:</span>
<span class="cm">    - display load average (older machines like 715/64 have 4 &quot;free&quot; LED&#39;s for that)</span>
<span class="cm">    - optimizations</span>
<span class="cm"> */</span>

<span class="cp">#define HEARTBEAT_LEN (HZ*10/100)</span>
<span class="cp">#define HEARTBEAT_2ND_RANGE_START (HZ*28/100)</span>
<span class="cp">#define HEARTBEAT_2ND_RANGE_END   (HEARTBEAT_2ND_RANGE_START + HEARTBEAT_LEN)</span>

<span class="cp">#define LED_UPDATE_INTERVAL (1 + (HZ*19/1000))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">led_work_func</span> <span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_jiffies</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count_HZ</span><span class="p">;</span> <span class="cm">/* counter in range 0..HZ */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">currentleds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* stores current value of the LEDs */</span>

	<span class="cm">/* exit if not initialized */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">led_func_ptr</span><span class="p">)</span>
	    <span class="k">return</span><span class="p">;</span>

	<span class="cm">/* increment the heartbeat timekeeper */</span>
	<span class="n">count_HZ</span> <span class="o">+=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">last_jiffies</span><span class="p">;</span>
	<span class="n">last_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count_HZ</span> <span class="o">&gt;=</span> <span class="n">HZ</span><span class="p">)</span>
	    <span class="n">count_HZ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">led_heartbeat</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="cm">/* flash heartbeat-LED like a real heart</span>
<span class="cm">		 * (2 x short then a long delay)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count_HZ</span> <span class="o">&lt;</span> <span class="n">HEARTBEAT_LEN</span> <span class="o">||</span> 
				<span class="p">(</span><span class="n">count_HZ</span> <span class="o">&gt;=</span> <span class="n">HEARTBEAT_2ND_RANGE_START</span> <span class="o">&amp;&amp;</span>
				<span class="n">count_HZ</span> <span class="o">&lt;</span> <span class="n">HEARTBEAT_2ND_RANGE_END</span><span class="p">))</span> 
			<span class="n">currentleds</span> <span class="o">|=</span> <span class="n">LED_HEARTBEAT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">led_lanrxtx</span><span class="p">))</span>  <span class="n">currentleds</span> <span class="o">|=</span> <span class="n">led_get_net_activity</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">led_diskio</span><span class="p">))</span>   <span class="n">currentleds</span> <span class="o">|=</span> <span class="n">led_get_diskio_activity</span><span class="p">();</span>

	<span class="cm">/* blink LEDs if we got an Oops (HPMC) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">oops_in_progress</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">&gt;=</span> <span class="n">pcxl2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* newer machines don&#39;t have loadavg. LEDs, so we</span>
<span class="cm">			 * let all LEDs blink twice per second instead */</span>
			<span class="n">currentleds</span> <span class="o">=</span> <span class="p">(</span><span class="n">count_HZ</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* old machines: blink loadavg. LEDs twice per second */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count_HZ</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
				<span class="n">currentleds</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LED4</span><span class="o">|</span><span class="n">LED5</span><span class="o">|</span><span class="n">LED6</span><span class="o">|</span><span class="n">LED7</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">currentleds</span> <span class="o">|=</span> <span class="p">(</span><span class="n">LED4</span><span class="o">|</span><span class="n">LED5</span><span class="o">|</span><span class="n">LED6</span><span class="o">|</span><span class="n">LED7</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currentleds</span> <span class="o">!=</span> <span class="n">lastleds</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">led_func_ptr</span><span class="p">(</span><span class="n">currentleds</span><span class="p">);</span>	<span class="cm">/* Update the LCD/LEDs */</span>
		<span class="n">lastleds</span> <span class="o">=</span> <span class="n">currentleds</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">led_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led_task</span><span class="p">,</span> <span class="n">LED_UPDATE_INTERVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   ** led_halt()</span>
<span class="cm">   ** </span>
<span class="cm">   ** called by the reboot notifier chain at shutdown and stops all</span>
<span class="cm">   ** LED/LCD activities.</span>
<span class="cm">   ** </span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">led_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">led_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">led_halt</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">notifier_disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">led_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">txt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notifier_disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>

	<span class="n">notifier_disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SYS_RESTART</span>:	<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;SYSTEM RESTART&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_HALT</span>:		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;SYSTEM HALT&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYS_POWER_OFF</span>:	<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;SYSTEM POWER OFF&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* Cancel the work item and delete the queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">led_wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led_task</span><span class="p">);</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">led_wq</span><span class="p">);</span>
		<span class="n">led_wq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
 
	<span class="k">if</span> <span class="p">(</span><span class="n">lcd_info</span><span class="p">.</span><span class="n">model</span> <span class="o">==</span> <span class="n">DISPLAY_MODEL_LCD</span><span class="p">)</span>
		<span class="n">lcd_print</span><span class="p">(</span><span class="n">txt</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">led_func_ptr</span><span class="p">)</span>
			<span class="n">led_func_ptr</span><span class="p">(</span><span class="mh">0xff</span><span class="p">);</span> <span class="cm">/* turn all LEDs ON */</span>
	
	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   ** register_led_driver()</span>
<span class="cm">   ** </span>
<span class="cm">   ** registers an external LED or LCD for usage by this driver.</span>
<span class="cm">   ** currently only LCD-, LASI- and ASP-style LCD/LED&#39;s are supported.</span>
<span class="cm">   ** </span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">register_led_driver</span><span class="p">(</span><span class="kt">int</span> <span class="n">model</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmd_reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data_reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">initialized</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">initialized</span> <span class="o">||</span> <span class="o">!</span><span class="n">data_reg</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	
	<span class="n">lcd_info</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">;</span>		<span class="cm">/* store the values */</span>
	<span class="n">LCD_CMD_REG</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd_reg</span> <span class="o">==</span> <span class="n">LED_CMD_REG_NONE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">cmd_reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">lcd_info</span><span class="p">.</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DISPLAY_MODEL_LCD</span>:
		<span class="n">LCD_DATA_REG</span> <span class="o">=</span> <span class="n">data_reg</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;LCD display at %lx,%lx registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			<span class="n">LCD_CMD_REG</span> <span class="p">,</span> <span class="n">LCD_DATA_REG</span><span class="p">);</span>
		<span class="n">led_func_ptr</span> <span class="o">=</span> <span class="n">led_LCD_driver</span><span class="p">;</span>
		<span class="n">led_type</span> <span class="o">=</span> <span class="n">LED_HASLCD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DISPLAY_MODEL_LASI</span>:
		<span class="n">LED_DATA_REG</span> <span class="o">=</span> <span class="n">data_reg</span><span class="p">;</span>
		<span class="n">led_func_ptr</span> <span class="o">=</span> <span class="n">led_LASI_driver</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;LED display at %lx registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LED_DATA_REG</span><span class="p">);</span>
		<span class="n">led_type</span> <span class="o">=</span> <span class="n">LED_NOLCD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DISPLAY_MODEL_OLD_ASP</span>:
		<span class="n">LED_DATA_REG</span> <span class="o">=</span> <span class="n">data_reg</span><span class="p">;</span>
		<span class="n">led_func_ptr</span> <span class="o">=</span> <span class="n">led_ASP_driver</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;LED (ASP-style) display at %lx registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		    <span class="n">LED_DATA_REG</span><span class="p">);</span>
		<span class="n">led_type</span> <span class="o">=</span> <span class="n">LED_NOLCD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Wrong LCD/LED model %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">lcd_info</span><span class="p">.</span><span class="n">model</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* mark the LCD/LED driver now as initialized and </span>
<span class="cm">	 * register to the reboot notifier chain */</span>
	<span class="n">initialized</span><span class="o">++</span><span class="p">;</span>
	<span class="n">register_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led_notifier</span><span class="p">);</span>

	<span class="cm">/* Ensure the work is queued */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">led_wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">led_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led_task</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   ** register_led_regions()</span>
<span class="cm">   ** </span>
<span class="cm">   ** register_led_regions() registers the LCD/LED regions for /procfs.</span>
<span class="cm">   ** At bootup - where the initialisation of the LCD/LED normally happens - </span>
<span class="cm">   ** not all internal structures of request_region() are properly set up,</span>
<span class="cm">   ** so that we delay the led-registration until after busdevices_init() </span>
<span class="cm">   ** has been executed.</span>
<span class="cm">   **</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">register_led_regions</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">lcd_info</span><span class="p">.</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DISPLAY_MODEL_LCD</span>:
		<span class="n">request_mem_region</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">LCD_CMD_REG</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;lcd_cmd&quot;</span><span class="p">);</span>
		<span class="n">request_mem_region</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">LCD_DATA_REG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;lcd_data&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISPLAY_MODEL_LASI</span>:
	<span class="k">case</span> <span class="n">DISPLAY_MODEL_OLD_ASP</span>:
		<span class="n">request_mem_region</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">LED_DATA_REG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;led_data&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">   ** </span>
<span class="cm">   ** lcd_print()</span>
<span class="cm">   ** </span>
<span class="cm">   ** Displays the given string on the LCD-Display of newer machines.</span>
<span class="cm">   ** lcd_print() disables/enables the timer-based led work queue to</span>
<span class="cm">   ** avoid a race condition while writing the CMD/DATA register pair.</span>
<span class="cm">   **</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">lcd_print</span><span class="p">(</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">led_func_ptr</span> <span class="o">||</span> <span class="n">lcd_info</span><span class="p">.</span><span class="n">model</span> <span class="o">!=</span> <span class="n">DISPLAY_MODEL_LCD</span><span class="p">)</span>
	    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="cm">/* temporarily disable the led work task */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">led_wq</span><span class="p">)</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led_task</span><span class="p">);</span>

	<span class="cm">/* copy display string to buffer for procfs */</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">lcd_text</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lcd_text</span><span class="p">));</span>

	<span class="cm">/* Set LCD Cursor to 1st character */</span>
	<span class="n">gsc_writeb</span><span class="p">(</span><span class="n">lcd_info</span><span class="p">.</span><span class="n">reset_cmd1</span><span class="p">,</span> <span class="n">LCD_CMD_REG</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">lcd_info</span><span class="p">.</span><span class="n">min_cmd_delay</span><span class="p">);</span>

	<span class="cm">/* Print the string */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lcd_info</span><span class="p">.</span><span class="n">lcd_width</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
		<span class="n">gsc_writeb</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">,</span> <span class="n">LCD_DATA_REG</span><span class="p">);</span>
	    <span class="k">else</span>
		<span class="n">gsc_writeb</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">,</span> <span class="n">LCD_DATA_REG</span><span class="p">);</span>
	    <span class="n">udelay</span><span class="p">(</span><span class="n">lcd_info</span><span class="p">.</span><span class="n">min_cmd_delay</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="cm">/* re-queue the work */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">led_wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">led_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led_task</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">lcd_info</span><span class="p">.</span><span class="n">lcd_width</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   ** led_init()</span>
<span class="cm">   ** </span>
<span class="cm">   ** led_init() is called very early in the bootup-process from setup.c </span>
<span class="cm">   ** and asks the PDC for an usable chassis LCD or LED.</span>
<span class="cm">   ** If the PDC doesn&#39;t return any info, then the LED</span>
<span class="cm">   ** is detected by lasi.c or asp.c and registered with the</span>
<span class="cm">   ** above functions lasi_led_init() or asp_led_init().</span>
<span class="cm">   ** KittyHawk machines have often a buggy PDC, so that</span>
<span class="cm">   ** we explicitly check for those machines here.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">led_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pdc_chassis_info</span> <span class="n">chassis_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">lcd_text_default</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lcd_text_default</span><span class="p">),</span>
		<span class="s">&quot;Linux %s&quot;</span><span class="p">,</span> <span class="n">init_utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">);</span>

	<span class="cm">/* Work around the buggy PDC of KittyHawk-machines */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">CPU_HVERSION</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x580</span>:		<span class="cm">/* KittyHawk DC2-100 (K100) */</span>
	<span class="k">case</span> <span class="mh">0x581</span>:		<span class="cm">/* KittyHawk DC3-120 (K210) */</span>
	<span class="k">case</span> <span class="mh">0x582</span>:		<span class="cm">/* KittyHawk DC3 100 (K400) */</span>
	<span class="k">case</span> <span class="mh">0x583</span>:		<span class="cm">/* KittyHawk DC3 120 (K410) */</span>
	<span class="k">case</span> <span class="mh">0x58B</span>:		<span class="cm">/* KittyHawk DC2 100 (K200) */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: KittyHawk-Machine (hversion 0x%x) found, &quot;</span>
				<span class="s">&quot;LED detection skipped.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">CPU_HVERSION</span><span class="p">);</span>
		<span class="n">lcd_no_led_support</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>	<span class="cm">/* use the preinitialized values of lcd_info */</span>
	<span class="p">}</span>

	<span class="cm">/* initialize the struct, so that we can check for valid return values */</span>
	<span class="n">lcd_info</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">DISPLAY_MODEL_NONE</span><span class="p">;</span>
	<span class="n">chassis_info</span><span class="p">.</span><span class="n">actcnt</span> <span class="o">=</span> <span class="n">chassis_info</span><span class="p">.</span><span class="n">maxcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pdc_chassis_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chassis_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lcd_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lcd_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">PDC_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">((</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: chassis info: model=%d (%s), &quot;</span>
			 <span class="s">&quot;lcd_width=%d, cmd_delay=%u,</span><span class="se">\n</span><span class="s">&quot;</span>
			 <span class="s">&quot;%s: sizecnt=%d, actcnt=%ld, maxcnt=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		         <span class="n">__FILE__</span><span class="p">,</span> <span class="n">lcd_info</span><span class="p">.</span><span class="n">model</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">lcd_info</span><span class="p">.</span><span class="n">model</span><span class="o">==</span><span class="n">DISPLAY_MODEL_LCD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;LCD&quot;</span> <span class="o">:</span>
			  <span class="p">(</span><span class="n">lcd_info</span><span class="p">.</span><span class="n">model</span><span class="o">==</span><span class="n">DISPLAY_MODEL_LASI</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;LED&quot;</span> <span class="o">:</span> <span class="s">&quot;unknown&quot;</span><span class="p">,</span>
			 <span class="n">lcd_info</span><span class="p">.</span><span class="n">lcd_width</span><span class="p">,</span> <span class="n">lcd_info</span><span class="p">.</span><span class="n">min_cmd_delay</span><span class="p">,</span>
			 <span class="n">__FILE__</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lcd_info</span><span class="p">),</span> 
			 <span class="n">chassis_info</span><span class="p">.</span><span class="n">actcnt</span><span class="p">,</span> <span class="n">chassis_info</span><span class="p">.</span><span class="n">maxcnt</span><span class="p">));</span>
		<span class="n">DPRINTK</span><span class="p">((</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: cmd=%p, data=%p, reset1=%x, reset2=%x, act_enable=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span> <span class="n">lcd_info</span><span class="p">.</span><span class="n">lcd_cmd_reg_addr</span><span class="p">,</span> 
			<span class="n">lcd_info</span><span class="p">.</span><span class="n">lcd_data_reg_addr</span><span class="p">,</span> <span class="n">lcd_info</span><span class="p">.</span><span class="n">reset_cmd1</span><span class="p">,</span>  
			<span class="n">lcd_info</span><span class="p">.</span><span class="n">reset_cmd2</span><span class="p">,</span> <span class="n">lcd_info</span><span class="p">.</span><span class="n">act_enable</span> <span class="p">));</span>
	
		<span class="cm">/* check the results. Some machines have a buggy PDC */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chassis_info</span><span class="p">.</span><span class="n">actcnt</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">chassis_info</span><span class="p">.</span><span class="n">actcnt</span> <span class="o">!=</span> <span class="n">chassis_info</span><span class="p">.</span><span class="n">maxcnt</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">lcd_info</span><span class="p">.</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DISPLAY_MODEL_LCD</span>:		<span class="cm">/* LCD display */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chassis_info</span><span class="p">.</span><span class="n">actcnt</span> <span class="o">&lt;</span> 
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pdc_chassis_lcd_info_ret_block</span><span class="p">,</span> <span class="n">_pad</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lcd_info</span><span class="p">.</span><span class="n">act_enable</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">((</span><span class="n">KERN_INFO</span> <span class="s">&quot;PDC prohibited usage of the LCD.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
				<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DISPLAY_MODEL_NONE</span>:	<span class="cm">/* no LED or LCD available */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PDC reported no LCD or LED.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DISPLAY_MODEL_LASI</span>:	<span class="cm">/* Lasi style 8 bit LED display */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chassis_info</span><span class="p">.</span><span class="n">actcnt</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">chassis_info</span><span class="p">.</span><span class="n">actcnt</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;PDC reported unknown LCD/LED model %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">lcd_info</span><span class="p">.</span><span class="n">model</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">not_found</span><span class="p">;</span>
		<span class="p">}</span> <span class="cm">/* switch() */</span>

<span class="nl">found:</span>
		<span class="cm">/* register the LCD/LED driver */</span>
		<span class="n">register_led_driver</span><span class="p">(</span><span class="n">lcd_info</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">LCD_CMD_REG</span><span class="p">,</span> <span class="n">LCD_DATA_REG</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* if() */</span>
		<span class="n">DPRINTK</span><span class="p">((</span><span class="n">KERN_INFO</span> <span class="s">&quot;pdc_chassis_info call failed with retval = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>
	<span class="p">}</span>

<span class="nl">not_found:</span>
	<span class="n">lcd_info</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">DISPLAY_MODEL_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">led_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led_notifier</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">led_create_procfs</span><span class="p">)</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
