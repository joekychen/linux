<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ssb › main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Sonics Silicon Backplane</span>
<span class="cm"> * Subsystem core</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2005, Broadcom Corporation</span>
<span class="cm"> * Copyright 2006, 2007, Michael Buesch &lt;m@bues.ch&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the GNU/GPL. See COPYING for details.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;ssb_private.h&quot;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/ssb/ssb.h&gt;</span>
<span class="cp">#include &lt;linux/ssb/ssb_regs.h&gt;</span>
<span class="cp">#include &lt;linux/ssb/ssb_driver_gige.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sdio_func.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;pcmcia/cistpl.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ds.h&gt;</span>


<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Sonics Silicon Backplane driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>


<span class="cm">/* Temporary list of yet-to-be-attached buses */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">attach_queue</span><span class="p">);</span>
<span class="cm">/* List if running buses */</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">buses</span><span class="p">);</span>
<span class="cm">/* Software ID counter */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next_busnumber</span><span class="p">;</span>
<span class="cm">/* buses_mutes locks the two buslists and the next_busnumber.</span>
<span class="cm"> * Don&#39;t lock this directly, but use ssb_buses_[un]lock() below. */</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">buses_mutex</span><span class="p">);</span>

<span class="cm">/* There are differences in the codeflow, if the bus is</span>
<span class="cm"> * initialized from early boot, as various needed services</span>
<span class="cm"> * are not available early. This is a mechanism to delay</span>
<span class="cm"> * these initializations to after early boot has finished.</span>
<span class="cm"> * It&#39;s also used to avoid mutex locking, as that&#39;s not</span>
<span class="cm"> * available and needed early. */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">ssb_is_early_boot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ssb_buses_lock</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ssb_buses_unlock</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>


<span class="cp">#ifdef CONFIG_SSB_PCIHOST</span>
<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="nf">ssb_pci_dev_to_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">ssb_buses_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buses</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">SSB_BUSTYPE_PCI</span> <span class="o">&amp;&amp;</span>
		    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pci</span> <span class="o">==</span> <span class="n">pdev</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">found:</span>
	<span class="n">ssb_buses_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">bus</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SSB_PCIHOST */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_SSB_PCMCIAHOST</span>
<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="nf">ssb_pcmcia_dev_to_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">ssb_buses_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buses</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">SSB_BUSTYPE_PCMCIA</span> <span class="o">&amp;&amp;</span>
		    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pcmcia</span> <span class="o">==</span> <span class="n">pdev</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">found:</span>
	<span class="n">ssb_buses_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">bus</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SSB_PCMCIAHOST */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_SSB_SDIOHOST</span>
<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="nf">ssb_sdio_func_to_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_func</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">ssb_buses_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buses</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">SSB_BUSTYPE_SDIO</span> <span class="o">&amp;&amp;</span>
		    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_sdio</span> <span class="o">==</span> <span class="n">func</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">found:</span>
	<span class="n">ssb_buses_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">bus</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SSB_SDIOHOST */</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">ssb_for_each_bus_call</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">ssb_buses_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buses</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ssb_buses_unlock</span><span class="p">();</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ssb_buses_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="nf">ssb_device_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ssb_device_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ssb_device_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">ssb_dev</span> <span class="o">=</span> <span class="n">dev_to_ssb_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssb_driver</span> <span class="o">*</span><span class="n">ssb_drv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssb_drv</span> <span class="o">=</span> <span class="n">drv_to_ssb_drv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssb_drv</span> <span class="o">&amp;&amp;</span> <span class="n">ssb_drv</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_drv</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">ssb_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ssb_device_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">ssb_dev</span> <span class="o">=</span> <span class="n">dev_to_ssb_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssb_driver</span> <span class="o">*</span><span class="n">ssb_drv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssb_drv</span> <span class="o">=</span> <span class="n">drv_to_ssb_drv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssb_drv</span> <span class="o">&amp;&amp;</span> <span class="n">ssb_drv</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_drv</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">ssb_dev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ssb_bus_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Reset HW state information in memory, so that HW is</span>
<span class="cm">	 * completely reinitialized. */</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">mapped_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SSB_DRIVER_PCICORE</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">pcicore</span><span class="p">.</span><span class="n">setup_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_bus_powerup</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_pcmcia_hardware_setup</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssb_bus_may_powerdown</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ssb_chipco_resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">);</span>
	<span class="n">ssb_bus_may_powerdown</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_bus_resume</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ssb_bus_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ssb_chipco_suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">);</span>
	<span class="n">ssb_pci_xtal</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">SSB_GPIO_XTAL</span> <span class="o">|</span> <span class="n">SSB_GPIO_PLL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_bus_suspend</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SSB_SPROM</span>
<span class="cm">/** ssb_devices_freeze - Freeze all devices on the bus.</span>
<span class="cm"> *</span>
<span class="cm"> * After freezing no device driver will be handling a device</span>
<span class="cm"> * on this bus anymore. ssb_devices_thaw() must be called after</span>
<span class="cm"> * a successful freeze to reactivate the devices.</span>
<span class="cm"> *</span>
<span class="cm"> * @bus: The bus.</span>
<span class="cm"> * @ctx: Context structure. Pass this to ssb_devices_thaw().</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ssb_devices_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ssb_freeze_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_driver</span> <span class="o">*</span><span class="n">sdrv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ctx</span><span class="p">));</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
	<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">nr_devices</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device_frozen</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">nr_devices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev</span> <span class="o">=</span> <span class="n">ssb_device_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">device_is_registered</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ssb_device_put</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sdrv</span> <span class="o">=</span> <span class="n">drv_to_ssb_drv</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sdrv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sdrv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device_frozen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** ssb_devices_thaw - Unfreeze all devices on the bus.</span>
<span class="cm"> *</span>
<span class="cm"> * This will re-attach the device drivers and re-init the devices.</span>
<span class="cm"> *</span>
<span class="cm"> * @ctx: The context structure from ssb_devices_freeze()</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ssb_devices_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_freeze_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_driver</span> <span class="o">*</span><span class="n">sdrv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">nr_devices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">device_frozen</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">sdrv</span> <span class="o">=</span> <span class="n">drv_to_ssb_drv</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sdrv</span> <span class="o">||</span> <span class="o">!</span><span class="n">sdrv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">sdrv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ssb_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Failed to thaw device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">dev_name</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ssb_device_put</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SSB_SPROM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ssb_device_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">ssb_dev</span> <span class="o">=</span> <span class="n">dev_to_ssb_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssb_driver</span> <span class="o">*</span><span class="n">ssb_drv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ssb_drv</span> <span class="o">=</span> <span class="n">drv_to_ssb_drv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssb_drv</span> <span class="o">&amp;&amp;</span> <span class="n">ssb_drv</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span>
		<span class="n">ssb_drv</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">(</span><span class="n">ssb_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ssb_device_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">ssb_dev</span> <span class="o">=</span> <span class="n">dev_to_ssb_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssb_driver</span> <span class="o">*</span><span class="n">ssb_drv</span> <span class="o">=</span> <span class="n">drv_to_ssb_drv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssb_drv</span> <span class="o">&amp;&amp;</span> <span class="n">ssb_drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span>
		<span class="n">ssb_drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">ssb_dev</span><span class="p">);</span>
	<span class="n">ssb_device_put</span><span class="p">(</span><span class="n">ssb_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ssb_device_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">ssb_dev</span> <span class="o">=</span> <span class="n">dev_to_ssb_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssb_driver</span> <span class="o">*</span><span class="n">ssb_drv</span> <span class="o">=</span> <span class="n">drv_to_ssb_drv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ssb_device_get</span><span class="p">(</span><span class="n">ssb_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssb_drv</span> <span class="o">&amp;&amp;</span> <span class="n">ssb_drv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_drv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">ssb_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssb_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">ssb_device_put</span><span class="p">(</span><span class="n">ssb_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ssb_match_devid</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ssb_device_id</span> <span class="o">*</span><span class="n">tabid</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">ssb_device_id</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tabid</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">devid</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tabid</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">SSB_ANY_VENDOR</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tabid</span><span class="o">-&gt;</span><span class="n">coreid</span> <span class="o">!=</span> <span class="n">devid</span><span class="o">-&gt;</span><span class="n">coreid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tabid</span><span class="o">-&gt;</span><span class="n">coreid</span> <span class="o">!=</span> <span class="n">SSB_ANY_ID</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tabid</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="n">devid</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tabid</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">!=</span> <span class="n">SSB_ANY_REV</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ssb_bus_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">ssb_dev</span> <span class="o">=</span> <span class="n">dev_to_ssb_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ssb_driver</span> <span class="o">*</span><span class="n">ssb_drv</span> <span class="o">=</span> <span class="n">drv_to_ssb_drv</span><span class="p">(</span><span class="n">drv</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ssb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="n">ssb_drv</span><span class="o">-&gt;</span><span class="n">id_table</span><span class="p">;</span>
	     <span class="n">id</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">||</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">coreid</span> <span class="o">||</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	     <span class="n">id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssb_match_devid</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssb_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* found */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ssb_device_uevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobj_uevent_env</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">ssb_dev</span> <span class="o">=</span> <span class="n">dev_to_ssb_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span>
			     <span class="s">&quot;MODALIAS=ssb:v%04Xid%04Xrev%02X&quot;</span><span class="p">,</span>
			     <span class="n">ssb_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span><span class="p">,</span> <span class="n">ssb_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">coreid</span><span class="p">,</span>
			     <span class="n">ssb_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define ssb_config_attr(attrib, field, format_string) \</span>
<span class="cp">static ssize_t \</span>
<span class="cp">attrib##_show(struct device *dev, struct device_attribute *attr, char *buf) \</span>
<span class="cp">{ \</span>
<span class="cp">	return sprintf(buf, format_string, dev_to_ssb_dev(dev)-&gt;field); \</span>
<span class="cp">}</span>

<span class="n">ssb_config_attr</span><span class="p">(</span><span class="n">core_num</span><span class="p">,</span> <span class="n">core_index</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="n">ssb_config_attr</span><span class="p">(</span><span class="n">coreid</span><span class="p">,</span> <span class="n">id</span><span class="p">.</span><span class="n">coreid</span><span class="p">,</span> <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="n">ssb_config_attr</span><span class="p">(</span><span class="n">vendor</span><span class="p">,</span> <span class="n">id</span><span class="p">.</span><span class="n">vendor</span><span class="p">,</span> <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="n">ssb_config_attr</span><span class="p">(</span><span class="n">revision</span><span class="p">,</span> <span class="n">id</span><span class="p">.</span><span class="n">revision</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="n">ssb_config_attr</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="n">name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ssb_core_name</span><span class="p">(</span><span class="n">dev_to_ssb_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">coreid</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">ssb_device_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">core_num</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">coreid</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">vendor</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">revision</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">irq</span><span class="p">),</span>
	<span class="n">__ATTR_NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_type</span> <span class="n">ssb_bustype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ssb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span>		<span class="o">=</span> <span class="n">ssb_bus_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ssb_device_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">ssb_device_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">ssb_device_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">ssb_device_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">ssb_device_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uevent</span>		<span class="o">=</span> <span class="n">ssb_device_uevent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_attrs</span>	<span class="o">=</span> <span class="n">ssb_device_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ssb_buses_lock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* See the comment at the ssb_is_early_boot definition */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssb_is_early_boot</span><span class="p">)</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buses_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ssb_buses_unlock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* See the comment at the ssb_is_early_boot definition */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssb_is_early_boot</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buses_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ssb_devices_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">nr_devices</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">device_unregister</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ssb_bus_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ssb_buses_lock</span><span class="p">();</span>
	<span class="n">ssb_devices_unregister</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">ssb_buses_unlock</span><span class="p">();</span>

	<span class="n">ssb_pcmcia_exit</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">ssb_pci_exit</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">ssb_iounmap</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_bus_unregister</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ssb_release_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">__ssb_dev_wrapper</span> <span class="o">*</span><span class="n">devwrap</span><span class="p">;</span>

	<span class="n">devwrap</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">__ssb_dev_wrapper</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">devwrap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ssb_devices_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">__ssb_dev_wrapper</span> <span class="o">*</span><span class="n">devwrap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">nr_devices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="cm">/* We don&#39;t register SSB-system devices to the kernel,</span>
<span class="cm">		 * as the drivers for them are built into SSB. */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">coreid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SSB_DEV_CHIPCOMMON</span>:
		<span class="k">case</span> <span class="n">SSB_DEV_PCI</span>:
		<span class="k">case</span> <span class="n">SSB_DEV_PCIE</span>:
		<span class="k">case</span> <span class="n">SSB_DEV_PCMCIA</span>:
		<span class="k">case</span> <span class="n">SSB_DEV_MIPS</span>:
		<span class="k">case</span> <span class="n">SSB_DEV_MIPS_3302</span>:
		<span class="k">case</span> <span class="n">SSB_DEV_EXTIF</span>:
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">devwrap</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">devwrap</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devwrap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ssb_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
				   <span class="s">&quot;Could not allocate device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">devwrap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">devwrap</span><span class="o">-&gt;</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">sdev</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">ssb_release_dev</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssb_bustype</span><span class="p">;</span>
		<span class="n">dev_set_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ssb%u:%d&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">busnumber</span><span class="p">,</span> <span class="n">dev_idx</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SSB_BUSTYPE_PCI</span>:
<span class="cp">#ifdef CONFIG_SSB_PCIHOST</span>
			<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
			<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SSB_BUSTYPE_PCMCIA</span>:
<span class="cp">#ifdef CONFIG_SSB_PCMCIAHOST</span>
			<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pcmcia</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pcmcia</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SSB_BUSTYPE_SDIO</span>:
<span class="cp">#ifdef CONFIG_SSB_SDIOHOST</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_sdio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SSB_BUSTYPE_SSB</span>:
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">coherent_dma_mask</span><span class="p">;</span>
			<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dma_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ssb_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
				   <span class="s">&quot;Could not register %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
			<span class="cm">/* Set dev to NULL to not unregister</span>
<span class="cm">			 * dev on error unwinding. */</span>
			<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">devwrap</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="cm">/* Unwind the already registered devices. */</span>
	<span class="n">ssb_devices_unregister</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Needs ssb_buses_lock() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ssb_attach_queued_buses</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drop_them_all</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attach_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drop_them_all</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Can&#39;t init the PCIcore in ssb_bus_register(), as that</span>
<span class="cm">		 * is too early in boot for embedded systems</span>
<span class="cm">		 * (no udelay() available). So do it here in attach stage.</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_bus_powerup</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">ssb_pcicore_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pcicore</span><span class="p">);</span>
		<span class="n">ssb_bus_may_powerdown</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_devices_register</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
<span class="nl">error:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drop_them_all</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buses</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ssb_ssb_read8</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_index</span> <span class="o">*</span> <span class="n">SSB_CORE_SIZE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">ssb_ssb_read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_index</span> <span class="o">*</span> <span class="n">SSB_CORE_SIZE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readw</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ssb_ssb_read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_index</span> <span class="o">*</span> <span class="n">SSB_CORE_SIZE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SSB_BLOCKIO</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ssb_ssb_block_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg_width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_index</span> <span class="o">*</span> <span class="n">SSB_CORE_SIZE</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg_width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span>: <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span>: <span class="p">{</span>
		<span class="n">__le16</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">__le16</span><span class="p">)</span><span class="n">__raw_readw</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span>: <span class="p">{</span>
		<span class="n">__le32</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">__le32</span><span class="p">)</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SSB_BLOCKIO */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ssb_ssb_write8</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_index</span> <span class="o">*</span> <span class="n">SSB_CORE_SIZE</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ssb_ssb_write16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_index</span> <span class="o">*</span> <span class="n">SSB_CORE_SIZE</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ssb_ssb_write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_index</span> <span class="o">*</span> <span class="n">SSB_CORE_SIZE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SSB_BLOCKIO</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ssb_ssb_block_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg_width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_index</span> <span class="o">*</span> <span class="n">SSB_CORE_SIZE</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg_width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">)</span>: <span class="p">{</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__raw_writeb</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span>: <span class="p">{</span>
		<span class="k">const</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__raw_writew</span><span class="p">((</span><span class="n">__force</span> <span class="n">u16</span><span class="p">)(</span><span class="o">*</span><span class="n">buf</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
			<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span>: <span class="p">{</span>
		<span class="k">const</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__raw_writel</span><span class="p">((</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)(</span><span class="o">*</span><span class="n">buf</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
			<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SSB_BLOCKIO */</span><span class="cp"></span>

<span class="cm">/* Ops for the plain SSB bus without a host-device (no PCI or PCMCIA). */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ssb_bus_ops</span> <span class="n">ssb_ssb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read8</span>		<span class="o">=</span> <span class="n">ssb_ssb_read8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read16</span>		<span class="o">=</span> <span class="n">ssb_ssb_read16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read32</span>		<span class="o">=</span> <span class="n">ssb_ssb_read32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write8</span>		<span class="o">=</span> <span class="n">ssb_ssb_write8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write16</span>	<span class="o">=</span> <span class="n">ssb_ssb_write16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write32</span>	<span class="o">=</span> <span class="n">ssb_ssb_write32</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_SSB_BLOCKIO</span>
	<span class="p">.</span><span class="n">block_read</span>	<span class="o">=</span> <span class="n">ssb_ssb_block_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">block_write</span>	<span class="o">=</span> <span class="n">ssb_ssb_block_write</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ssb_fetch_invariants</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
				<span class="n">ssb_invariants_func_t</span> <span class="n">get_invariants</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_init_invariants</span> <span class="n">iv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iv</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">get_invariants</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">boardinfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iv</span><span class="p">.</span><span class="n">boardinfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iv</span><span class="p">.</span><span class="n">boardinfo</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iv</span><span class="p">.</span><span class="n">sprom</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iv</span><span class="p">.</span><span class="n">sprom</span><span class="p">));</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">has_cardbus_slot</span> <span class="o">=</span> <span class="n">iv</span><span class="p">.</span><span class="n">has_cardbus_slot</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ssb_bus_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
				      <span class="n">ssb_invariants_func_t</span> <span class="n">get_invariants</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bar_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SSB_EMBEDDED</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Powerup the bus */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_pci_xtal</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">SSB_GPIO_XTAL</span> <span class="o">|</span> <span class="n">SSB_GPIO_PLL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Init SDIO-host device (if any), before the scan */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_sdio_init</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_disable_xtal</span><span class="p">;</span>

	<span class="n">ssb_buses_lock</span><span class="p">();</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">busnumber</span> <span class="o">=</span> <span class="n">next_busnumber</span><span class="p">;</span>
	<span class="cm">/* Scan for devices (cores) */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_bus_scan</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">baseaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_sdio_exit</span><span class="p">;</span>

	<span class="cm">/* Init PCI-host device (if any) */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_pci_init</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unmap</span><span class="p">;</span>
	<span class="cm">/* Init PCMCIA-host device (if any) */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_pcmcia_init</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pci_exit</span><span class="p">;</span>

	<span class="cm">/* Initialize basic system devices (if available) */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_bus_powerup</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pcmcia_exit</span><span class="p">;</span>
	<span class="n">ssb_chipcommon_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">);</span>
	<span class="n">ssb_mipscore_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">mipscore</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_fetch_invariants</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">get_invariants</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssb_bus_may_powerdown</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_pcmcia_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ssb_bus_may_powerdown</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="cm">/* Queue it for attach.</span>
<span class="cm">	 * See the comment at the ssb_is_early_boot definition. */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attach_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssb_is_early_boot</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This is not early boot, so we must attach the bus now */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_attach_queued_buses</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_dequeue</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">next_busnumber</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ssb_buses_unlock</span><span class="p">();</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err_dequeue:</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
<span class="nl">err_pcmcia_exit:</span>
	<span class="n">ssb_pcmcia_exit</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
<span class="nl">err_pci_exit:</span>
	<span class="n">ssb_pci_exit</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
<span class="nl">err_unmap:</span>
	<span class="n">ssb_iounmap</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
<span class="nl">err_sdio_exit:</span>
	<span class="n">ssb_sdio_exit</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
<span class="nl">err_disable_xtal:</span>
	<span class="n">ssb_buses_unlock</span><span class="p">();</span>
	<span class="n">ssb_pci_xtal</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">SSB_GPIO_XTAL</span> <span class="o">|</span> <span class="n">SSB_GPIO_PLL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SSB_PCIHOST</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ssb_bus_pcibus_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">host_pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">SSB_BUSTYPE_PCI</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pci</span> <span class="o">=</span> <span class="n">host_pci</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssb_pci_ops</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_bus_register</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">ssb_pci_get_invariants</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssb_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Sonics Silicon Backplane found on &quot;</span>
			   <span class="s">&quot;PCI device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host_pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ssb_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Failed to register PCI version&quot;</span>
			   <span class="s">&quot; of SSB with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_bus_pcibus_register</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SSB_PCIHOST */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_SSB_PCMCIAHOST</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ssb_bus_pcmciabus_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">pcmcia_dev</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">SSB_BUSTYPE_PCMCIA</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pcmcia</span> <span class="o">=</span> <span class="n">pcmcia_dev</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssb_pcmcia_ops</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_bus_register</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">ssb_pcmcia_get_invariants</span><span class="p">,</span> <span class="n">baseaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssb_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Sonics Silicon Backplane found on &quot;</span>
			   <span class="s">&quot;PCMCIA device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcmcia_dev</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_bus_pcmciabus_register</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SSB_PCMCIAHOST */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_SSB_SDIOHOST</span>
<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ssb_bus_sdiobus_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sdio_func</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">quirks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">SSB_BUSTYPE_SDIO</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_sdio</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssb_sdio_ops</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">=</span> <span class="n">quirks</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_bus_register</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">ssb_sdio_get_invariants</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssb_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Sonics Silicon Backplane found on &quot;</span>
			   <span class="s">&quot;SDIO device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sdio_func_id</span><span class="p">(</span><span class="n">func</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_bus_sdiobus_register</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SSB_PCMCIAHOST */</span><span class="cp"></span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ssb_bus_ssbbus_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseaddr</span><span class="p">,</span>
				      <span class="n">ssb_invariants_func_t</span> <span class="n">get_invariants</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">SSB_BUSTYPE_SSB</span><span class="p">;</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssb_ssb_ops</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_bus_register</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">get_invariants</span><span class="p">,</span> <span class="n">baseaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssb_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Sonics Silicon Backplane found at &quot;</span>
			   <span class="s">&quot;address 0x%08lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">baseaddr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__ssb_driver_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssb_bustype</span><span class="p">;</span>
	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__ssb_driver_register</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ssb_driver_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_driver_unregister</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ssb_set_devtypedata</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">nr_devices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">coreid</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">coreid</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ent</span><span class="o">-&gt;</span><span class="n">devtypedata</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_set_devtypedata</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">clkfactor_f6_resolve</span><span class="p">(</span><span class="n">u32</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* map the magic values */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSB_CHIPCO_CLK_F6_2</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_CHIPCO_CLK_F6_3</span>:
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_CHIPCO_CLK_F6_4</span>:
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_CHIPCO_CLK_F6_5</span>:
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_CHIPCO_CLK_F6_6</span>:
		<span class="k">return</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_CHIPCO_CLK_F6_7</span>:
		<span class="k">return</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Calculate the speed the backplane would run at a given set of clockcontrol values */</span>
<span class="n">u32</span> <span class="nf">ssb_calc_clock_rate</span><span class="p">(</span><span class="n">u32</span> <span class="n">plltype</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">,</span> <span class="n">u32</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">m3</span><span class="p">,</span> <span class="n">mc</span><span class="p">;</span>

	<span class="n">n1</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CLK_N1</span><span class="p">);</span>
	<span class="n">n2</span> <span class="o">=</span> <span class="p">((</span><span class="n">n</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CLK_N2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SSB_CHIPCO_CLK_N2_SHIFT</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">plltype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_6</span>: <span class="cm">/* 100/200 or 120/240 only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CLK_T6_MMASK</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SSB_CHIPCO_CLK_T6_M1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">SSB_CHIPCO_CLK_T6_M0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_1</span>: <span class="cm">/* 48Mhz base, 3 dividers */</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_3</span>: <span class="cm">/* 25Mhz, 2 dividers */</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_4</span>: <span class="cm">/* 48Mhz, 4 dividers */</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_7</span>: <span class="cm">/* 25Mhz, 4 dividers */</span>
		<span class="n">n1</span> <span class="o">=</span> <span class="n">clkfactor_f6_resolve</span><span class="p">(</span><span class="n">n1</span><span class="p">);</span>
		<span class="n">n2</span> <span class="o">+=</span> <span class="n">SSB_CHIPCO_CLK_F5_BIAS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_2</span>: <span class="cm">/* 48Mhz, 4 dividers */</span>
		<span class="n">n1</span> <span class="o">+=</span> <span class="n">SSB_CHIPCO_CLK_T2_BIAS</span><span class="p">;</span>
		<span class="n">n2</span> <span class="o">+=</span> <span class="n">SSB_CHIPCO_CLK_T2_BIAS</span><span class="p">;</span>
		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">n1</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n1</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)));</span>
		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">n2</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n2</span> <span class="o">&lt;=</span> <span class="mi">23</span><span class="p">)));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_5</span>: <span class="cm">/* 25Mhz, 4 dividers */</span>
		<span class="k">return</span> <span class="mi">100000000</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">plltype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_3</span>: <span class="cm">/* 25Mhz, 2 dividers */</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_7</span>: <span class="cm">/* 25Mhz, 4 dividers */</span>
		<span class="n">clock</span> <span class="o">=</span> <span class="n">SSB_CHIPCO_CLK_BASE2</span> <span class="o">*</span> <span class="n">n1</span> <span class="o">*</span> <span class="n">n2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">clock</span> <span class="o">=</span> <span class="n">SSB_CHIPCO_CLK_BASE1</span> <span class="o">*</span> <span class="n">n1</span> <span class="o">*</span> <span class="n">n2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clock</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">m1</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CLK_M1</span><span class="p">);</span>
	<span class="n">m2</span> <span class="o">=</span> <span class="p">((</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CLK_M2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SSB_CHIPCO_CLK_M2_SHIFT</span><span class="p">);</span>
	<span class="n">m3</span> <span class="o">=</span> <span class="p">((</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CLK_M3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SSB_CHIPCO_CLK_M3_SHIFT</span><span class="p">);</span>
	<span class="n">mc</span> <span class="o">=</span> <span class="p">((</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CLK_MC</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SSB_CHIPCO_CLK_MC_SHIFT</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">plltype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_1</span>: <span class="cm">/* 48Mhz base, 3 dividers */</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_3</span>: <span class="cm">/* 25Mhz, 2 dividers */</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_4</span>: <span class="cm">/* 48Mhz, 4 dividers */</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_7</span>: <span class="cm">/* 25Mhz, 4 dividers */</span>
		<span class="n">m1</span> <span class="o">=</span> <span class="n">clkfactor_f6_resolve</span><span class="p">(</span><span class="n">m1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">plltype</span> <span class="o">==</span> <span class="n">SSB_PLLTYPE_1</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">plltype</span> <span class="o">==</span> <span class="n">SSB_PLLTYPE_3</span><span class="p">))</span>
			<span class="n">m2</span> <span class="o">+=</span> <span class="n">SSB_CHIPCO_CLK_F5_BIAS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">m2</span> <span class="o">=</span> <span class="n">clkfactor_f6_resolve</span><span class="p">(</span><span class="n">m2</span><span class="p">);</span>
		<span class="n">m3</span> <span class="o">=</span> <span class="n">clkfactor_f6_resolve</span><span class="p">(</span><span class="n">m3</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">mc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SSB_CHIPCO_CLK_MC_BYPASS</span>:
			<span class="k">return</span> <span class="n">clock</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SSB_CHIPCO_CLK_MC_M1</span>:
			<span class="k">return</span> <span class="p">(</span><span class="n">clock</span> <span class="o">/</span> <span class="n">m1</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">SSB_CHIPCO_CLK_MC_M1M2</span>:
			<span class="k">return</span> <span class="p">(</span><span class="n">clock</span> <span class="o">/</span> <span class="p">(</span><span class="n">m1</span> <span class="o">*</span> <span class="n">m2</span><span class="p">));</span>
		<span class="k">case</span> <span class="n">SSB_CHIPCO_CLK_MC_M1M2M3</span>:
			<span class="k">return</span> <span class="p">(</span><span class="n">clock</span> <span class="o">/</span> <span class="p">(</span><span class="n">m1</span> <span class="o">*</span> <span class="n">m2</span> <span class="o">*</span> <span class="n">m3</span><span class="p">));</span>
		<span class="k">case</span> <span class="n">SSB_CHIPCO_CLK_MC_M1M3</span>:
			<span class="k">return</span> <span class="p">(</span><span class="n">clock</span> <span class="o">/</span> <span class="p">(</span><span class="n">m1</span> <span class="o">*</span> <span class="n">m3</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_2</span>:
		<span class="n">m1</span> <span class="o">+=</span> <span class="n">SSB_CHIPCO_CLK_T2_BIAS</span><span class="p">;</span>
		<span class="n">m2</span> <span class="o">+=</span> <span class="n">SSB_CHIPCO_CLK_T2M2_BIAS</span><span class="p">;</span>
		<span class="n">m3</span> <span class="o">+=</span> <span class="n">SSB_CHIPCO_CLK_T2_BIAS</span><span class="p">;</span>
		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">m1</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m1</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)));</span>
		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">m2</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m2</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)));</span>
		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">m3</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">m3</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CLK_T2MC_M1BYP</span><span class="p">))</span>
			<span class="n">clock</span> <span class="o">/=</span> <span class="n">m1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CLK_T2MC_M2BYP</span><span class="p">))</span>
			<span class="n">clock</span> <span class="o">/=</span> <span class="n">m2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mc</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CLK_T2MC_M3BYP</span><span class="p">))</span>
			<span class="n">clock</span> <span class="o">/=</span> <span class="n">m3</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">clock</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get the current speed the backplane is running at */</span>
<span class="n">u32</span> <span class="nf">ssb_clockspeed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">plltype</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clkctl_n</span><span class="p">,</span> <span class="n">clkctl_m</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CAP_PMU</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ssb_pmu_get_controlclock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssb_extif_available</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">extif</span><span class="p">))</span>
		<span class="n">ssb_extif_get_clockcontrol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">extif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plltype</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">clkctl_n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clkctl_m</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">ssb_chipco_get_clockcontrol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plltype</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">clkctl_n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clkctl_m</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x5365</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">100000000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">ssb_calc_clock_rate</span><span class="p">(</span><span class="n">plltype</span><span class="p">,</span> <span class="n">clkctl_n</span><span class="p">,</span> <span class="n">clkctl_m</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plltype</span> <span class="o">==</span> <span class="n">SSB_PLLTYPE_3</span><span class="p">)</span> <span class="cm">/* 25Mhz, 2 dividers */</span>
			<span class="n">rate</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_clockspeed</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ssb_tmslow_reject_bitmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rev</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_IDLOW</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SSB_IDLOW_SSBREV</span><span class="p">;</span>

	<span class="cm">/* The REJECT bit seems to be different for Backplane rev 2.3 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSB_IDLOW_SSBREV_22</span>:
	<span class="k">case</span> <span class="n">SSB_IDLOW_SSBREV_24</span>:
	<span class="k">case</span> <span class="n">SSB_IDLOW_SSBREV_26</span>:
		<span class="k">return</span> <span class="n">SSB_TMSLOW_REJECT</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_IDLOW_SSBREV_23</span>:
		<span class="k">return</span> <span class="n">SSB_TMSLOW_REJECT_23</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_IDLOW_SSBREV_25</span>:     <span class="cm">/* TODO - find the proper REJECT bit */</span>
	<span class="k">case</span> <span class="n">SSB_IDLOW_SSBREV_27</span>:     <span class="cm">/* same here */</span>
		<span class="k">return</span> <span class="n">SSB_TMSLOW_REJECT</span><span class="p">;</span>	<span class="cm">/* this is a guess */</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ssb: Backplane Revision 0x%.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">SSB_TMSLOW_REJECT</span> <span class="o">|</span> <span class="n">SSB_TMSLOW_REJECT_23</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ssb_device_is_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reject</span><span class="p">;</span>

	<span class="n">reject</span> <span class="o">=</span> <span class="n">ssb_tmslow_reject_bitmask</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">SSB_TMSLOW_CLOCK</span> <span class="o">|</span> <span class="n">SSB_TMSLOW_RESET</span> <span class="o">|</span> <span class="n">reject</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">SSB_TMSLOW_CLOCK</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_device_is_enabled</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ssb_flush_tmslow</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Make _really_ sure the device has finished the TMSLOW</span>
<span class="cm">	 * register write transaction, as we risk running into</span>
<span class="cm">	 * a machine check exception otherwise.</span>
<span class="cm">	 * Do this by reading the register back to commit the</span>
<span class="cm">	 * PCI write and delay an additional usec for the device</span>
<span class="cm">	 * to react to the change. */</span>
	<span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ssb_device_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">core_specific_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ssb_device_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">core_specific_flags</span><span class="p">);</span>
	<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span>
		    <span class="n">SSB_TMSLOW_RESET</span> <span class="o">|</span> <span class="n">SSB_TMSLOW_CLOCK</span> <span class="o">|</span>
		    <span class="n">SSB_TMSLOW_FGC</span> <span class="o">|</span> <span class="n">core_specific_flags</span><span class="p">);</span>
	<span class="n">ssb_flush_tmslow</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Clear SERR if set. This is a hw bug workaround. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSHIGH</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SSB_TMSHIGH_SERR</span><span class="p">)</span>
		<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSHIGH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_IMSTATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SSB_IMSTATE_IBE</span> <span class="o">|</span> <span class="n">SSB_IMSTATE_TO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SSB_IMSTATE_IBE</span> <span class="o">|</span> <span class="n">SSB_IMSTATE_TO</span><span class="p">);</span>
		<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_IMSTATE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span>
		    <span class="n">SSB_TMSLOW_CLOCK</span> <span class="o">|</span> <span class="n">SSB_TMSLOW_FGC</span> <span class="o">|</span>
		    <span class="n">core_specific_flags</span><span class="p">);</span>
	<span class="n">ssb_flush_tmslow</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span> <span class="n">SSB_TMSLOW_CLOCK</span> <span class="o">|</span>
		    <span class="n">core_specific_flags</span><span class="p">);</span>
	<span class="n">ssb_flush_tmslow</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_device_enable</span><span class="p">);</span>

<span class="cm">/* Wait for bitmask in a register to get set or cleared.</span>
<span class="cm"> * timeout is in units of ten-microseconds */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ssb_wait_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bitmask</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">bitmask</span><span class="p">)</span> <span class="o">==</span> <span class="n">bitmask</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">bitmask</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Timeout waiting for bitmask %08X on &quot;</span>
			    <span class="s">&quot;register %04X to %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">bitmask</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">set</span> <span class="o">?</span> <span class="s">&quot;set&quot;</span> <span class="o">:</span> <span class="s">&quot;clear&quot;</span><span class="p">));</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ssb_device_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">core_specific_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reject</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SSB_TMSLOW_RESET</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">reject</span> <span class="o">=</span> <span class="n">ssb_tmslow_reject_bitmask</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SSB_TMSLOW_CLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span> <span class="n">reject</span> <span class="o">|</span> <span class="n">SSB_TMSLOW_CLOCK</span><span class="p">);</span>
		<span class="n">ssb_wait_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span> <span class="n">reject</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ssb_wait_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSHIGH</span><span class="p">,</span> <span class="n">SSB_TMSHIGH_BUSY</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_IDLOW</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SSB_IDLOW_INITIATOR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_IMSTATE</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">SSB_IMSTATE_REJECT</span><span class="p">;</span>
			<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_IMSTATE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">ssb_wait_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_IMSTATE</span><span class="p">,</span> <span class="n">SSB_IMSTATE_BUSY</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span>
				      <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span>
			<span class="n">SSB_TMSLOW_FGC</span> <span class="o">|</span> <span class="n">SSB_TMSLOW_CLOCK</span> <span class="o">|</span>
			<span class="n">reject</span> <span class="o">|</span> <span class="n">SSB_TMSLOW_RESET</span> <span class="o">|</span>
			<span class="n">core_specific_flags</span><span class="p">);</span>
		<span class="n">ssb_flush_tmslow</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_IDLOW</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SSB_IDLOW_INITIATOR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_IMSTATE</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSB_IMSTATE_REJECT</span><span class="p">;</span>
			<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_IMSTATE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span>
		    <span class="n">reject</span> <span class="o">|</span> <span class="n">SSB_TMSLOW_RESET</span> <span class="o">|</span>
		    <span class="n">core_specific_flags</span><span class="p">);</span>
	<span class="n">ssb_flush_tmslow</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_device_disable</span><span class="p">);</span>

<span class="cm">/* Some chipsets need routing known for PCIe and 64-bit DMA */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ssb_dma_translation_special_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">chip_id</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">coreid</span> <span class="o">==</span> <span class="n">SSB_DEV_80211</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4322</span> <span class="o">||</span> <span class="n">chip_id</span> <span class="o">==</span> <span class="mi">43221</span> <span class="o">||</span>
			<span class="n">chip_id</span> <span class="o">==</span> <span class="mi">43231</span> <span class="o">||</span> <span class="n">chip_id</span> <span class="o">==</span> <span class="mi">43222</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">ssb_dma_translation</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSB_BUSTYPE_SSB</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_BUSTYPE_PCI</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_is_pcie</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pci</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSHIGH</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SSB_TMSHIGH_DMA64</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">SSB_PCIE_DMA_H32</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ssb_dma_translation_special_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">SSB_PCIE_DMA_H32</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="n">SSB_PCI_DMA</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">__ssb_dma_not_implemented</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_dma_translation</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ssb_bus_may_powerdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* On buses where more than one core may be working</span>
<span class="cm">	 * at a time, we must not powerdown stuff if there are</span>
<span class="cm">	 * still cores that may want to run. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">SSB_BUSTYPE_SSB</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">cc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ssb_chipco_set_clockmode</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CLKMODE_SLOW</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_pci_xtal</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">SSB_GPIO_XTAL</span> <span class="o">|</span> <span class="n">SSB_GPIO_PLL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
<span class="nl">out:</span>
<span class="cp">#ifdef CONFIG_SSB_DEBUG</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">powered_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">ssb_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Bus powerdown failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_bus_may_powerdown</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ssb_bus_powerup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">bool</span> <span class="n">dynamic_pctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ssb_clkmode</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_pci_xtal</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">SSB_GPIO_XTAL</span> <span class="o">|</span> <span class="n">SSB_GPIO_PLL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SSB_DEBUG</span>
	<span class="n">bus</span><span class="o">-&gt;</span><span class="n">powered_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">dynamic_pctl</span> <span class="o">?</span> <span class="n">SSB_CLKMODE_DYNAMIC</span> <span class="o">:</span> <span class="n">SSB_CLKMODE_FAST</span><span class="p">;</span>
	<span class="n">ssb_chipco_set_clockmode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">ssb_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Bus powerup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_bus_powerup</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ssb_broadcast_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SSB_DRIVER_PCICORE</span>
	<span class="cm">/* This is used for both, PCI and ChipCommon core, so be careful. */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">SSB_PCICORE_BCAST_ADDR</span> <span class="o">!=</span> <span class="n">SSB_CHIPCO_BCAST_ADDR</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">SSB_PCICORE_BCAST_DATA</span> <span class="o">!=</span> <span class="n">SSB_CHIPCO_BCAST_DATA</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_CHIPCO_BCAST_ADDR</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_CHIPCO_BCAST_ADDR</span><span class="p">);</span> <span class="cm">/* flush */</span>
	<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_CHIPCO_BCAST_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_CHIPCO_BCAST_DATA</span><span class="p">);</span> <span class="cm">/* flush */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ssb_commit_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SSB_DRIVER_PCICORE</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">.</span><span class="n">dev</span> <span class="o">?</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">.</span><span class="n">dev</span> <span class="o">:</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">pcicore</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* This forces an update of the cached registers. */</span>
	<span class="n">ssb_broadcast_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xFD8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_commit_settings</span><span class="p">);</span>

<span class="n">u32</span> <span class="nf">ssb_admatch_base</span><span class="p">(</span><span class="n">u32</span> <span class="n">adm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">adm</span> <span class="o">&amp;</span> <span class="n">SSB_ADM_TYPE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSB_ADM_TYPE0</span>:
		<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">adm</span> <span class="o">&amp;</span> <span class="n">SSB_ADM_BASE0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_ADM_TYPE1</span>:
		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="n">adm</span> <span class="o">&amp;</span> <span class="n">SSB_ADM_NEG</span><span class="p">);</span> <span class="cm">/* unsupported */</span>
		<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">adm</span> <span class="o">&amp;</span> <span class="n">SSB_ADM_BASE1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_ADM_TYPE2</span>:
		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="n">adm</span> <span class="o">&amp;</span> <span class="n">SSB_ADM_NEG</span><span class="p">);</span> <span class="cm">/* unsupported */</span>
		<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">adm</span> <span class="o">&amp;</span> <span class="n">SSB_ADM_BASE2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">base</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_admatch_base</span><span class="p">);</span>

<span class="n">u32</span> <span class="nf">ssb_admatch_size</span><span class="p">(</span><span class="n">u32</span> <span class="n">adm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">adm</span> <span class="o">&amp;</span> <span class="n">SSB_ADM_TYPE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSB_ADM_TYPE0</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="n">adm</span> <span class="o">&amp;</span> <span class="n">SSB_ADM_SZ0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SSB_ADM_SZ0_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_ADM_TYPE1</span>:
		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="n">adm</span> <span class="o">&amp;</span> <span class="n">SSB_ADM_NEG</span><span class="p">);</span> <span class="cm">/* unsupported */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="n">adm</span> <span class="o">&amp;</span> <span class="n">SSB_ADM_SZ1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SSB_ADM_SZ1_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_ADM_TYPE2</span>:
		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="n">adm</span> <span class="o">&amp;</span> <span class="n">SSB_ADM_NEG</span><span class="p">);</span> <span class="cm">/* unsupported */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="n">adm</span> <span class="o">&amp;</span> <span class="n">SSB_ADM_SZ2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SSB_ADM_SZ2_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_admatch_size</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ssb_modinit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* See the comment at the ssb_is_early_boot definition */</span>
	<span class="n">ssb_is_early_boot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssb_bustype</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Maybe we already registered some buses at early boot.</span>
<span class="cm">	 * Check for this and attach them</span>
<span class="cm">	 */</span>
	<span class="n">ssb_buses_lock</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_attach_queued_buses</span><span class="p">();</span>
	<span class="n">ssb_buses_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssb_bustype</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_pci_ssb_bridge_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssb_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Broadcom 43xx PCI-SSB-bridge &quot;</span>
			   <span class="s">&quot;initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* don&#39;t fail SSB init because of this */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_gige_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssb_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SSB Broadcom Gigabit Ethernet &quot;</span>
			   <span class="s">&quot;driver initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* don&#39;t fail SSB init because of this */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* ssb must be initialized after PCI but before the ssb drivers.</span>
<span class="cm"> * That means we must use some initcall between subsys_initcall</span>
<span class="cm"> * and device_initcall. */</span>
<span class="n">fs_initcall</span><span class="p">(</span><span class="n">ssb_modinit</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ssb_modexit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ssb_gige_exit</span><span class="p">();</span>
	<span class="n">b43_pci_ssb_bridge_exit</span><span class="p">();</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssb_bustype</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ssb_modexit</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
