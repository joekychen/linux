<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ssb › driver_chipcommon.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>driver_chipcommon.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Sonics Silicon Backplane</span>
<span class="cm"> * Broadcom ChipCommon core driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2005, Broadcom Corporation</span>
<span class="cm"> * Copyright 2006, 2007, Michael Buesch &lt;m@bues.ch&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the GNU/GPL. See COPYING for details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/ssb/ssb.h&gt;</span>
<span class="cp">#include &lt;linux/ssb/ssb_regs.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>

<span class="cp">#include &quot;ssb_private.h&quot;</span>


<span class="cm">/* Clock sources */</span>
<span class="k">enum</span> <span class="n">ssb_clksrc</span> <span class="p">{</span>
	<span class="cm">/* PCI clock */</span>
	<span class="n">SSB_CHIPCO_CLKSRC_PCI</span><span class="p">,</span>
	<span class="cm">/* Crystal slow clock oscillator */</span>
	<span class="n">SSB_CHIPCO_CLKSRC_XTALOS</span><span class="p">,</span>
	<span class="cm">/* Low power oscillator */</span>
	<span class="n">SSB_CHIPCO_CLKSRC_LOPWROS</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">chipco_write32_masked</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">value</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ssb_chipco_set_clockmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">ssb_clkmode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">ccdev</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ccdev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">bus</span> <span class="o">=</span> <span class="n">ccdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="cm">/* We support SLOW only on 6..9 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">SSB_CLKMODE_SLOW</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">SSB_CLKMODE_DYNAMIC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CAP_PMU</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* PMU controls clockmode, separated function needed */</span>
	<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="n">ccdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* chipcommon cores prior to rev6 don&#39;t support dynamic clock control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* ChipCommon cores rev10+ need testing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CAP_PCTL</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSB_CLKMODE_SLOW</span>: <span class="cm">/* For revs 6..9 only */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_SLOWCLKCTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SSB_CHIPCO_SLOWCLKCTL_FSLOW</span><span class="p">;</span>
		<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_SLOWCLKCTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_CLKMODE_FAST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ccdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ssb_pci_xtal</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">SSB_GPIO_XTAL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* Force crystal on */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_SLOWCLKCTL</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSB_CHIPCO_SLOWCLKCTL_FSLOW</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SSB_CHIPCO_SLOWCLKCTL_IPLL</span><span class="p">;</span>
			<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_SLOWCLKCTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_SYSCLKCTL</span><span class="p">,</span>
				<span class="p">(</span><span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_SYSCLKCTL</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">SSB_CHIPCO_SYSCLKCTL_FORCEHT</span><span class="p">));</span>
			<span class="cm">/* udelay(150); TODO: not available in early init */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_CLKMODE_DYNAMIC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ccdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_SLOWCLKCTL</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSB_CHIPCO_SLOWCLKCTL_FSLOW</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSB_CHIPCO_SLOWCLKCTL_IPLL</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSB_CHIPCO_SLOWCLKCTL_ENXTAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_SLOWCLKCTL_SRC</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="n">SSB_CHIPCO_SLOWCLKCTL_SRC_XTAL</span><span class="p">)</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SSB_CHIPCO_SLOWCLKCTL_ENXTAL</span><span class="p">;</span>
			<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_SLOWCLKCTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

			<span class="cm">/* For dynamic control, we have to release our xtal_pu</span>
<span class="cm">			 * &quot;force on&quot; */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_SLOWCLKCTL_ENXTAL</span><span class="p">)</span>
				<span class="n">ssb_pci_xtal</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">SSB_GPIO_XTAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_SYSCLKCTL</span><span class="p">,</span>
				<span class="p">(</span><span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_SYSCLKCTL</span><span class="p">)</span> <span class="o">&amp;</span>
				 <span class="o">~</span><span class="n">SSB_CHIPCO_SYSCLKCTL_FORCEHT</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Get the Slow Clock Source */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">ssb_clksrc</span> <span class="nf">chipco_pctl_get_slowclksrc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">SSB_BUSTYPE_SSB</span> <span class="o">||</span>
		    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">SSB_BUSTYPE_PCMCIA</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SSB_CHIPCO_CLKSRC_XTALOS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">SSB_BUSTYPE_PCI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pci</span><span class="p">,</span> <span class="n">SSB_GPIO_OUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">SSB_CHIPCO_CLKSRC_PCI</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">SSB_CHIPCO_CLKSRC_XTALOS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_SLOWCLKCTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SSB_CHIPCO_CLKSRC_LOPWROS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SSB_CHIPCO_CLKSRC_XTALOS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SSB_CHIPCO_CLKSRC_PCI</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SSB_CHIPCO_CLKSRC_XTALOS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get maximum or minimum (depending on get_max flag) slowclock frequency. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">chipco_pctl_clockfreqlimit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">get_max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">limit</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">ssb_clksrc</span> <span class="n">clocksrc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">clocksrc</span> <span class="o">=</span> <span class="n">chipco_pctl_get_slowclksrc</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">clocksrc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SSB_CHIPCO_CLKSRC_PCI</span>:
			<span class="n">divisor</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SSB_CHIPCO_CLKSRC_XTALOS</span>:
			<span class="n">divisor</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">clocksrc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SSB_CHIPCO_CLKSRC_LOPWROS</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SSB_CHIPCO_CLKSRC_XTALOS</span>:
		<span class="k">case</span> <span class="n">SSB_CHIPCO_CLKSRC_PCI</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_SLOWCLKCTL</span><span class="p">);</span>
			<span class="n">divisor</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">divisor</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_SYSCLKCTL</span><span class="p">);</span>
		<span class="n">divisor</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">divisor</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">clocksrc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSB_CHIPCO_CLKSRC_LOPWROS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_max</span><span class="p">)</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="mi">43000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_CHIPCO_CLKSRC_XTALOS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_max</span><span class="p">)</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="mi">20200000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="mi">19800000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_CHIPCO_CLKSRC_PCI</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_max</span><span class="p">)</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="mi">34000000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="mi">25000000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">limit</span> <span class="o">/=</span> <span class="n">divisor</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">limit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">chipco_powercontrol_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4321</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CHIPCTL</span><span class="p">,</span> <span class="mh">0x3A4</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CHIPCTL</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CAP_PCTL</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set Idle Power clock rate to 1Mhz */</span>
		<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_SYSCLKCTL</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_SYSCLKCTL</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="mh">0x0000FFFF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x00040000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">maxfreq</span><span class="p">;</span>

		<span class="n">maxfreq</span> <span class="o">=</span> <span class="n">chipco_pctl_clockfreqlimit</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_PLLONDELAY</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">maxfreq</span> <span class="o">*</span> <span class="mi">150</span> <span class="o">+</span> <span class="mi">999999</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">);</span>
		<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_FREFSELDELAY</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">maxfreq</span> <span class="o">*</span> <span class="mi">15</span> <span class="o">+</span> <span class="mi">999999</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PmuFastPwrupDelay */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">pmu_fast_powerup_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x4312</span>:
	<span class="k">case</span> <span class="mh">0x4322</span>:
	<span class="k">case</span> <span class="mh">0x4328</span>:
		<span class="k">return</span> <span class="mi">7000</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4325</span>:
		<span class="cm">/* TODO: */</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">15000</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/ClkctlFastPwrupDelay */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">calc_fast_powerup_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">minfreq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pll_on_delay</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">!=</span> <span class="n">SSB_BUSTYPE_PCI</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CAP_PMU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cc</span><span class="o">-&gt;</span><span class="n">fast_pwrup_delay</span> <span class="o">=</span> <span class="n">pmu_fast_powerup_delay</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CAP_PCTL</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">minfreq</span> <span class="o">=</span> <span class="n">chipco_pctl_clockfreqlimit</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pll_on_delay</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_PLLONDELAY</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(((</span><span class="n">pll_on_delay</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">minfreq</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">minfreq</span><span class="p">;</span>
	<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFFFF</span><span class="p">);</span>

	<span class="n">cc</span><span class="o">-&gt;</span><span class="n">fast_pwrup_delay</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ssb_chipcommon_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* We don&#39;t have a ChipCommon */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span>
		<span class="n">cc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CHIPSTAT</span><span class="p">);</span>
	<span class="n">ssb_dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;chipcommon status is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_GPIOPULLUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_GPIOPULLDOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ssb_pmu_init</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
	<span class="n">chipco_powercontrol_init</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
	<span class="n">ssb_chipco_set_clockmode</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CLKMODE_FAST</span><span class="p">);</span>
	<span class="n">calc_fast_powerup_delay</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ssb_chipco_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ssb_chipco_set_clockmode</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CLKMODE_SLOW</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ssb_chipco_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">chipco_powercontrol_init</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
	<span class="n">ssb_chipco_set_clockmode</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CLKMODE_FAST</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Get the processor clock */</span>
<span class="kt">void</span> <span class="nf">ssb_chipco_get_clockcpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span>
                             <span class="n">u32</span> <span class="o">*</span><span class="n">plltype</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CLOCK_N</span><span class="p">);</span>
	<span class="o">*</span><span class="n">plltype</span> <span class="o">=</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CAP_PLLT</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">plltype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_2</span>:
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_4</span>:
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_6</span>:
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_7</span>:
		<span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CLOCK_MIPS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_3</span>:
		<span class="cm">/* 5350 uses m2 to control mips */</span>
		<span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CLOCK_M2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CLOCK_SB</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Get the bus clock */</span>
<span class="kt">void</span> <span class="nf">ssb_chipco_get_clockcontrol</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="o">*</span><span class="n">plltype</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CLOCK_N</span><span class="p">);</span>
	<span class="o">*</span><span class="n">plltype</span> <span class="o">=</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CAP_PLLT</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">plltype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_6</span>: <span class="cm">/* 100/200 or 120/240 only */</span>
		<span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CLOCK_MIPS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSB_PLLTYPE_3</span>: <span class="cm">/* 25Mhz, 2 dividers */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">!=</span> <span class="mh">0x5365</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CLOCK_M2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Fallthough */</span>
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CLOCK_SB</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ssb_chipco_timing_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* set register for external IO to control LED. */</span>
	<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_PROG_CFG</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SSB_PROG_WCNT_3_SHIFT</span><span class="p">;</span>		<span class="cm">/* Waitcount-3 = 10ns */</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SSB_PROG_WCNT_1_SHIFT</span><span class="p">;</span>	<span class="cm">/* Waitcount-1 = 40ns */</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>				<span class="cm">/* Waitcount-0 = 240ns */</span>
	<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_PROG_WAITCNT</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>	<span class="cm">/* 0x01020a0c for a 100Mhz clock */</span>

	<span class="cm">/* Set timing for the flash */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SSB_FLASH_WCNT_3_SHIFT</span><span class="p">;</span>	<span class="cm">/* Waitcount-3 = 10nS */</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SSB_FLASH_WCNT_1_SHIFT</span><span class="p">;</span>	<span class="cm">/* Waitcount-1 = 10nS */</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>				<span class="cm">/* Waitcount-0 = 120nS */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x5365</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">))</span>
		<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_FLASH_WAITCNT</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x5365</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x5350</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_PCMCIA_MEMWAIT</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x5350</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable EXTIF */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SSB_PROG_WCNT_3_SHIFT</span><span class="p">;</span>	  <span class="cm">/* Waitcount-3 = 10ns */</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SSB_PROG_WCNT_2_SHIFT</span><span class="p">;</span>  <span class="cm">/* Waitcount-2 = 20ns */</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SSB_PROG_WCNT_1_SHIFT</span><span class="p">;</span> <span class="cm">/* Waitcount-1 = 100ns */</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>			  <span class="cm">/* Waitcount-0 = 120ns */</span>
		<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_PROG_WAITCNT</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span> <span class="cm">/* 0x01020a0c for a 100Mhz clock */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Set chip watchdog reset timer to fire in &#39;ticks&#39; backplane cycles */</span>
<span class="kt">void</span> <span class="nf">ssb_chipco_watchdog_timer_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ticks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* instant NMI */</span>
	<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_WATCHDOG</span><span class="p">,</span> <span class="n">ticks</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ssb_chipco_irq_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chipco_write32_masked</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_IRQMASK</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">ssb_chipco_irq_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_IRQSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">ssb_chipco_gpio_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_GPIOIN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">ssb_chipco_gpio_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">chipco_write32_masked</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_GPIOOUT</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">ssb_chipco_gpio_outen</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">chipco_write32_masked</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_GPIOOUTEN</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">ssb_chipco_gpio_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">chipco_write32_masked</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_GPIOCTL</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ssb_chipco_gpio_control</span><span class="p">);</span>

<span class="n">u32</span> <span class="nf">ssb_chipco_gpio_intmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">chipco_write32_masked</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_GPIOIRQ</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">ssb_chipco_gpio_polarity</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">chipco_write32_masked</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_GPIOPOL</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SSB_SERIAL</span>
<span class="kt">int</span> <span class="nf">ssb_chipco_serial_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_chipcommon</span> <span class="o">*</span><span class="n">cc</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ssb_serial_port</span> <span class="o">*</span><span class="n">ports</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_ports</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">plltype</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">baud_base</span><span class="p">,</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ccrev</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span><span class="p">;</span>

	<span class="n">plltype</span> <span class="o">=</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CAP_PLLT</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">ssb_mips_irq</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plltype</span> <span class="o">==</span> <span class="n">SSB_PLLTYPE_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* PLL clock */</span>
		<span class="n">baud_base</span> <span class="o">=</span> <span class="n">ssb_calc_clock_rate</span><span class="p">(</span><span class="n">plltype</span><span class="p">,</span>
						<span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CLOCK_N</span><span class="p">),</span>
						<span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CLOCK_M2</span><span class="p">));</span>
		<span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ccrev</span> <span class="o">==</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* BCM5354 uses constant 25MHz clock */</span>
			<span class="n">baud_base</span> <span class="o">=</span> <span class="mi">25000000</span><span class="p">;</span>
			<span class="n">div</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
			<span class="cm">/* Set the override bit so we don&#39;t divide it */</span>
			<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CORECTL</span><span class="p">,</span>
				       <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CORECTL</span><span class="p">)</span>
				       <span class="o">|</span> <span class="n">SSB_CHIPCO_CORECTL_UARTCLK0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ccrev</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ccrev</span> <span class="o">!=</span> <span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Fixed ALP clock */</span>
			<span class="n">baud_base</span> <span class="o">=</span> <span class="mi">20000000</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CAP_PMU</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* FIXME: baud_base is different for devices with a PMU */</span>
				<span class="n">SSB_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ccrev</span> <span class="o">&gt;=</span> <span class="mi">21</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Turn off UART clock before switching clocksource. */</span>
				<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CORECTL</span><span class="p">,</span>
					       <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CORECTL</span><span class="p">)</span>
					       <span class="o">&amp;</span> <span class="o">~</span><span class="n">SSB_CHIPCO_CORECTL_UARTCLKEN</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* Set the override bit so we don&#39;t divide it */</span>
			<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CORECTL</span><span class="p">,</span>
				       <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CORECTL</span><span class="p">)</span>
				       <span class="o">|</span> <span class="n">SSB_CHIPCO_CORECTL_UARTCLK0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ccrev</span> <span class="o">&gt;=</span> <span class="mi">21</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Re-enable the UART clock. */</span>
				<span class="n">chipco_write32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CORECTL</span><span class="p">,</span>
					       <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CORECTL</span><span class="p">)</span>
					       <span class="o">|</span> <span class="n">SSB_CHIPCO_CORECTL_UARTCLKEN</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ccrev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Internal backplane clock */</span>
			<span class="n">baud_base</span> <span class="o">=</span> <span class="n">ssb_clockspeed</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
			<span class="n">div</span> <span class="o">=</span> <span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CLKDIV</span><span class="p">)</span>
			      <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CLKDIV_UART</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Fixed internal backplane clock */</span>
			<span class="n">baud_base</span> <span class="o">=</span> <span class="mi">88000000</span><span class="p">;</span>
			<span class="n">div</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Clock source depends on strapping if UartClkOverride is unset */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ccrev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">chipco_read32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">SSB_CHIPCO_CORECTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CORECTL_UARTCLK0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CAP_UARTCLK</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">SSB_CHIPCO_CAP_UARTCLK_INT</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Internal divided backplane clock */</span>
				<span class="n">baud_base</span> <span class="o">/=</span> <span class="n">div</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Assume external clock of 1.8432 MHz */</span>
				<span class="n">baud_base</span> <span class="o">=</span> <span class="mi">1843200</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Determine the registers of the UARTs */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">SSB_CHIPCO_CAP_NRUART</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cc_mmio</span><span class="p">;</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">uart_regs</span><span class="p">;</span>

		<span class="n">cc_mmio</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">+</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_index</span> <span class="o">*</span> <span class="n">SSB_CORE_SIZE</span><span class="p">);</span>
		<span class="n">uart_regs</span> <span class="o">=</span> <span class="n">cc_mmio</span> <span class="o">+</span> <span class="n">SSB_CHIPCO_UART0_DATA</span><span class="p">;</span>
		<span class="cm">/* Offset changed at after rev 0 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ccrev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">uart_regs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">uart_regs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">256</span><span class="p">);</span>

		<span class="n">nr_ports</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">regs</span> <span class="o">=</span> <span class="n">uart_regs</span><span class="p">;</span>
		<span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
		<span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">baud_base</span> <span class="o">=</span> <span class="n">baud_base</span><span class="p">;</span>
		<span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">nr_ports</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SSB_SERIAL */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
