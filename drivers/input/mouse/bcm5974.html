<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › mouse › bcm5974.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bcm5974.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Apple USB BCM5974 (Macbook Air and Penryn Macbook Pro) multitouch driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008	   Henrik Rydberg (rydberg@euromail.se)</span>
<span class="cm"> *</span>
<span class="cm"> * The USB initialization and package decoding was made by</span>
<span class="cm"> * Scott Shawcroft as part of the touchd user-space driver project:</span>
<span class="cm"> * Copyright (C) 2008	   Scott Shawcroft (scott.shawcroft@gmail.com)</span>
<span class="cm"> *</span>
<span class="cm"> * The BCM5974 driver is based on the appletouch driver:</span>
<span class="cm"> * Copyright (C) 2001-2004 Greg Kroah-Hartman (greg@kroah.com)</span>
<span class="cm"> * Copyright (C) 2005      Johannes Berg (johannes@sipsolutions.net)</span>
<span class="cm"> * Copyright (C) 2005	   Stelian Pop (stelian@popies.net)</span>
<span class="cm"> * Copyright (C) 2005	   Frank Arnold (frank@scirocco-5v-turbo.de)</span>
<span class="cm"> * Copyright (C) 2005	   Peter Osterlund (petero2@telia.com)</span>
<span class="cm"> * Copyright (C) 2005	   Michael Hanselmann (linux-kernel@hansmi.ch)</span>
<span class="cm"> * Copyright (C) 2006	   Nicolas Boichat (nicolas@boichat.ch)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	 See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/usb/input.h&gt;</span>
<span class="cp">#include &lt;linux/hid.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#define USB_VENDOR_ID_APPLE		0x05ac</span>

<span class="cm">/* MacbookAir, aka wellspring */</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING_ANSI	0x0223</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING_ISO	0x0224</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING_JIS	0x0225</span>
<span class="cm">/* MacbookProPenryn, aka wellspring2 */</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING2_ANSI	0x0230</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING2_ISO	0x0231</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING2_JIS	0x0232</span>
<span class="cm">/* Macbook5,1 (unibody), aka wellspring3 */</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING3_ANSI	0x0236</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING3_ISO	0x0237</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING3_JIS	0x0238</span>
<span class="cm">/* MacbookAir3,2 (unibody), aka wellspring5 */</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING4_ANSI	0x023f</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING4_ISO	0x0240</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING4_JIS	0x0241</span>
<span class="cm">/* MacbookAir3,1 (unibody), aka wellspring4 */</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING4A_ANSI	0x0242</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING4A_ISO	0x0243</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING4A_JIS	0x0244</span>
<span class="cm">/* Macbook8 (unibody, March 2011) */</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING5_ANSI	0x0245</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING5_ISO	0x0246</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING5_JIS	0x0247</span>
<span class="cm">/* MacbookAir4,1 (unibody, July 2011) */</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING6A_ANSI	0x0249</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING6A_ISO	0x024a</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING6A_JIS	0x024b</span>
<span class="cm">/* MacbookAir4,2 (unibody, July 2011) */</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING6_ANSI	0x024c</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING6_ISO	0x024d</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING6_JIS	0x024e</span>
<span class="cm">/* Macbook8,2 (unibody) */</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING5A_ANSI	0x0252</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING5A_ISO	0x0253</span>
<span class="cp">#define USB_DEVICE_ID_APPLE_WELLSPRING5A_JIS	0x0254</span>

<span class="cp">#define BCM5974_DEVICE(prod) {					\</span>
<span class="cp">	.match_flags = (USB_DEVICE_ID_MATCH_DEVICE |		\</span>
<span class="cp">			USB_DEVICE_ID_MATCH_INT_CLASS |		\</span>
<span class="cp">			USB_DEVICE_ID_MATCH_INT_PROTOCOL),	\</span>
<span class="cp">	.idVendor = USB_VENDOR_ID_APPLE,			\</span>
<span class="cp">	.idProduct = (prod),					\</span>
<span class="cp">	.bInterfaceClass = USB_INTERFACE_CLASS_HID,		\</span>
<span class="cp">	.bInterfaceProtocol = USB_INTERFACE_PROTOCOL_MOUSE	\</span>
<span class="cp">}</span>

<span class="cm">/* table of devices that work with this driver */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">bcm5974_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* MacbookAir1.1 */</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING_ANSI</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING_ISO</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING_JIS</span><span class="p">),</span>
	<span class="cm">/* MacbookProPenryn */</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING2_ANSI</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING2_ISO</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING2_JIS</span><span class="p">),</span>
	<span class="cm">/* Macbook5,1 */</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING3_ANSI</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING3_ISO</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING3_JIS</span><span class="p">),</span>
	<span class="cm">/* MacbookAir3,2 */</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING4_ANSI</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING4_ISO</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING4_JIS</span><span class="p">),</span>
	<span class="cm">/* MacbookAir3,1 */</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING4A_ANSI</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING4A_ISO</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING4A_JIS</span><span class="p">),</span>
	<span class="cm">/* MacbookPro8 */</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING5_ANSI</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING5_ISO</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING5_JIS</span><span class="p">),</span>
	<span class="cm">/* MacbookAir4,1 */</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING6A_ANSI</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING6A_ISO</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING6A_JIS</span><span class="p">),</span>
	<span class="cm">/* MacbookAir4,2 */</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING6_ANSI</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING6_ISO</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING6_JIS</span><span class="p">),</span>
	<span class="cm">/* MacbookPro8,2 */</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING5A_ANSI</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING5A_ISO</span><span class="p">),</span>
	<span class="n">BCM5974_DEVICE</span><span class="p">(</span><span class="n">USB_DEVICE_ID_APPLE_WELLSPRING5A_JIS</span><span class="p">),</span>
	<span class="cm">/* Terminating entry */</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">bcm5974_table</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Henrik Rydberg&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Apple USB BCM5974 multitouch driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(level, format, a...)\</span>
<span class="cp">	{ if (debug &gt;= level) printk(KERN_DEBUG format, ##a); }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Activate debugging output&quot;</span><span class="p">);</span>

<span class="cm">/* button data structure */</span>
<span class="k">struct</span> <span class="n">bt_data</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">unknown1</span><span class="p">;</span>		<span class="cm">/* constant */</span>
	<span class="n">u8</span> <span class="n">button</span><span class="p">;</span>		<span class="cm">/* left button */</span>
	<span class="n">u8</span> <span class="n">rel_x</span><span class="p">;</span>		<span class="cm">/* relative x coordinate */</span>
	<span class="n">u8</span> <span class="n">rel_y</span><span class="p">;</span>		<span class="cm">/* relative y coordinate */</span>
<span class="p">};</span>

<span class="cm">/* trackpad header types */</span>
<span class="k">enum</span> <span class="n">tp_type</span> <span class="p">{</span>
	<span class="n">TYPE1</span><span class="p">,</span>			<span class="cm">/* plain trackpad */</span>
	<span class="n">TYPE2</span>			<span class="cm">/* button integrated in trackpad */</span>
<span class="p">};</span>

<span class="cm">/* trackpad finger data offsets, le16-aligned */</span>
<span class="cp">#define FINGER_TYPE1		(13 * sizeof(__le16))</span>
<span class="cp">#define FINGER_TYPE2		(15 * sizeof(__le16))</span>

<span class="cm">/* trackpad button data offsets */</span>
<span class="cp">#define BUTTON_TYPE2		15</span>

<span class="cm">/* list of device capability bits */</span>
<span class="cp">#define HAS_INTEGRATED_BUTTON	1</span>

<span class="cm">/* trackpad finger structure, le16-aligned */</span>
<span class="k">struct</span> <span class="n">tp_finger</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">origin</span><span class="p">;</span>		<span class="cm">/* zero when switching track finger */</span>
	<span class="n">__le16</span> <span class="n">abs_x</span><span class="p">;</span>		<span class="cm">/* absolute x coodinate */</span>
	<span class="n">__le16</span> <span class="n">abs_y</span><span class="p">;</span>		<span class="cm">/* absolute y coodinate */</span>
	<span class="n">__le16</span> <span class="n">rel_x</span><span class="p">;</span>		<span class="cm">/* relative x coodinate */</span>
	<span class="n">__le16</span> <span class="n">rel_y</span><span class="p">;</span>		<span class="cm">/* relative y coodinate */</span>
	<span class="n">__le16</span> <span class="n">size_major</span><span class="p">;</span>	<span class="cm">/* finger size, major axis? */</span>
	<span class="n">__le16</span> <span class="n">size_minor</span><span class="p">;</span>	<span class="cm">/* finger size, minor axis? */</span>
	<span class="n">__le16</span> <span class="n">orientation</span><span class="p">;</span>	<span class="cm">/* 16384 when point, else 15 bit angle */</span>
	<span class="n">__le16</span> <span class="n">force_major</span><span class="p">;</span>	<span class="cm">/* trackpad force, major axis? */</span>
	<span class="n">__le16</span> <span class="n">force_minor</span><span class="p">;</span>	<span class="cm">/* trackpad force, minor axis? */</span>
	<span class="n">__le16</span> <span class="n">unused</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* zeros */</span>
	<span class="n">__le16</span> <span class="n">multi</span><span class="p">;</span>		<span class="cm">/* one finger: varies, more fingers: constant */</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">,</span><span class="n">aligned</span><span class="p">(</span><span class="mi">2</span><span class="p">)));</span>

<span class="cm">/* trackpad finger data size, empirically at least ten fingers */</span>
<span class="cp">#define SIZEOF_FINGER		sizeof(struct tp_finger)</span>
<span class="cp">#define SIZEOF_ALL_FINGERS	(16 * SIZEOF_FINGER)</span>
<span class="cp">#define MAX_FINGER_ORIENTATION	16384</span>

<span class="cm">/* device-specific parameters */</span>
<span class="k">struct</span> <span class="n">bcm5974_param</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">dim</span><span class="p">;</span>		<span class="cm">/* logical dimension */</span>
	<span class="kt">int</span> <span class="n">fuzz</span><span class="p">;</span>		<span class="cm">/* logical noise value */</span>
	<span class="kt">int</span> <span class="n">devmin</span><span class="p">;</span>		<span class="cm">/* device minimum reading */</span>
	<span class="kt">int</span> <span class="n">devmax</span><span class="p">;</span>		<span class="cm">/* device maximum reading */</span>
<span class="p">};</span>

<span class="cm">/* device-specific configuration */</span>
<span class="k">struct</span> <span class="n">bcm5974_config</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">ansi</span><span class="p">,</span> <span class="n">iso</span><span class="p">,</span> <span class="n">jis</span><span class="p">;</span>	<span class="cm">/* the product id of this device */</span>
	<span class="kt">int</span> <span class="n">caps</span><span class="p">;</span>		<span class="cm">/* device capability bitmask */</span>
	<span class="kt">int</span> <span class="n">bt_ep</span><span class="p">;</span>		<span class="cm">/* the endpoint of the button interface */</span>
	<span class="kt">int</span> <span class="n">bt_datalen</span><span class="p">;</span>		<span class="cm">/* data length of the button interface */</span>
	<span class="kt">int</span> <span class="n">tp_ep</span><span class="p">;</span>		<span class="cm">/* the endpoint of the trackpad interface */</span>
	<span class="k">enum</span> <span class="n">tp_type</span> <span class="n">tp_type</span><span class="p">;</span>	<span class="cm">/* type of trackpad interface */</span>
	<span class="kt">int</span> <span class="n">tp_offset</span><span class="p">;</span>		<span class="cm">/* offset to trackpad finger data */</span>
	<span class="kt">int</span> <span class="n">tp_datalen</span><span class="p">;</span>		<span class="cm">/* data length of the trackpad interface */</span>
	<span class="k">struct</span> <span class="n">bcm5974_param</span> <span class="n">p</span><span class="p">;</span>	<span class="cm">/* finger pressure limits */</span>
	<span class="k">struct</span> <span class="n">bcm5974_param</span> <span class="n">w</span><span class="p">;</span>	<span class="cm">/* finger width limits */</span>
	<span class="k">struct</span> <span class="n">bcm5974_param</span> <span class="n">x</span><span class="p">;</span>	<span class="cm">/* horizontal limits */</span>
	<span class="k">struct</span> <span class="n">bcm5974_param</span> <span class="n">y</span><span class="p">;</span>	<span class="cm">/* vertical limits */</span>
<span class="p">};</span>

<span class="cm">/* logical device structure */</span>
<span class="k">struct</span> <span class="n">bcm5974</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">;</span>	<span class="cm">/* usb device */</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">;</span>	<span class="cm">/* our interface */</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>	<span class="cm">/* input dev */</span>
	<span class="k">struct</span> <span class="n">bcm5974_config</span> <span class="n">cfg</span><span class="p">;</span>	<span class="cm">/* device configuration */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">pm_mutex</span><span class="p">;</span>		<span class="cm">/* serialize access to open/suspend */</span>
	<span class="kt">int</span> <span class="n">opened</span><span class="p">;</span>			<span class="cm">/* 1: opened, 0: closed */</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">bt_urb</span><span class="p">;</span>		<span class="cm">/* button usb request block */</span>
	<span class="k">struct</span> <span class="n">bt_data</span> <span class="o">*</span><span class="n">bt_data</span><span class="p">;</span>	<span class="cm">/* button transferred data */</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">tp_urb</span><span class="p">;</span>		<span class="cm">/* trackpad usb request block */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tp_data</span><span class="p">;</span>			<span class="cm">/* trackpad transferred data */</span>
	<span class="kt">int</span> <span class="n">fingers</span><span class="p">;</span>			<span class="cm">/* number of fingers on trackpad */</span>
<span class="p">};</span>

<span class="cm">/* logical dimensions */</span>
<span class="cp">#define DIM_PRESSURE	256		</span><span class="cm">/* maximum finger pressure */</span><span class="cp"></span>
<span class="cp">#define DIM_WIDTH	16		</span><span class="cm">/* maximum finger width */</span><span class="cp"></span>
<span class="cp">#define DIM_X		1280		</span><span class="cm">/* maximum trackpad x value */</span><span class="cp"></span>
<span class="cp">#define DIM_Y		800		</span><span class="cm">/* maximum trackpad y value */</span><span class="cp"></span>

<span class="cm">/* logical signal quality */</span>
<span class="cp">#define SN_PRESSURE	45		</span><span class="cm">/* pressure signal-to-noise ratio */</span><span class="cp"></span>
<span class="cp">#define SN_WIDTH	100		</span><span class="cm">/* width signal-to-noise ratio */</span><span class="cp"></span>
<span class="cp">#define SN_COORD	250		</span><span class="cm">/* coordinate signal-to-noise ratio */</span><span class="cp"></span>

<span class="cm">/* pressure thresholds */</span>
<span class="cp">#define PRESSURE_LOW	(2 * DIM_PRESSURE / SN_PRESSURE)</span>
<span class="cp">#define PRESSURE_HIGH	(3 * PRESSURE_LOW)</span>

<span class="cm">/* device constants */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">bcm5974_config</span> <span class="n">bcm5974_config_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING_ANSI</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING_ISO</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING_JIS</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mh">0x84</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bt_data</span><span class="p">),</span>
		<span class="mh">0x81</span><span class="p">,</span> <span class="n">TYPE1</span><span class="p">,</span> <span class="n">FINGER_TYPE1</span><span class="p">,</span> <span class="n">FINGER_TYPE1</span> <span class="o">+</span> <span class="n">SIZEOF_ALL_FINGERS</span><span class="p">,</span>
		<span class="p">{</span> <span class="n">DIM_PRESSURE</span><span class="p">,</span> <span class="n">DIM_PRESSURE</span> <span class="o">/</span> <span class="n">SN_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_WIDTH</span><span class="p">,</span> <span class="n">DIM_WIDTH</span> <span class="o">/</span> <span class="n">SN_WIDTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2048</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_X</span><span class="p">,</span> <span class="n">DIM_X</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">4824</span><span class="p">,</span> <span class="mi">5342</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_Y</span><span class="p">,</span> <span class="n">DIM_Y</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">172</span><span class="p">,</span> <span class="mi">5820</span> <span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING2_ANSI</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING2_ISO</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING2_JIS</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mh">0x84</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bt_data</span><span class="p">),</span>
		<span class="mh">0x81</span><span class="p">,</span> <span class="n">TYPE1</span><span class="p">,</span> <span class="n">FINGER_TYPE1</span><span class="p">,</span> <span class="n">FINGER_TYPE1</span> <span class="o">+</span> <span class="n">SIZEOF_ALL_FINGERS</span><span class="p">,</span>
		<span class="p">{</span> <span class="n">DIM_PRESSURE</span><span class="p">,</span> <span class="n">DIM_PRESSURE</span> <span class="o">/</span> <span class="n">SN_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_WIDTH</span><span class="p">,</span> <span class="n">DIM_WIDTH</span> <span class="o">/</span> <span class="n">SN_WIDTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2048</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_X</span><span class="p">,</span> <span class="n">DIM_X</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">4824</span><span class="p">,</span> <span class="mi">4824</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_Y</span><span class="p">,</span> <span class="n">DIM_Y</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">172</span><span class="p">,</span> <span class="mi">4290</span> <span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING3_ANSI</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING3_ISO</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING3_JIS</span><span class="p">,</span>
		<span class="n">HAS_INTEGRATED_BUTTON</span><span class="p">,</span>
		<span class="mh">0x84</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bt_data</span><span class="p">),</span>
		<span class="mh">0x81</span><span class="p">,</span> <span class="n">TYPE2</span><span class="p">,</span> <span class="n">FINGER_TYPE2</span><span class="p">,</span> <span class="n">FINGER_TYPE2</span> <span class="o">+</span> <span class="n">SIZEOF_ALL_FINGERS</span><span class="p">,</span>
		<span class="p">{</span> <span class="n">DIM_PRESSURE</span><span class="p">,</span> <span class="n">DIM_PRESSURE</span> <span class="o">/</span> <span class="n">SN_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">300</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_WIDTH</span><span class="p">,</span> <span class="n">DIM_WIDTH</span> <span class="o">/</span> <span class="n">SN_WIDTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2048</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_X</span><span class="p">,</span> <span class="n">DIM_X</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">4460</span><span class="p">,</span> <span class="mi">5166</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_Y</span><span class="p">,</span> <span class="n">DIM_Y</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="mi">6700</span> <span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING4_ANSI</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING4_ISO</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING4_JIS</span><span class="p">,</span>
		<span class="n">HAS_INTEGRATED_BUTTON</span><span class="p">,</span>
		<span class="mh">0x84</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bt_data</span><span class="p">),</span>
		<span class="mh">0x81</span><span class="p">,</span> <span class="n">TYPE2</span><span class="p">,</span> <span class="n">FINGER_TYPE2</span><span class="p">,</span> <span class="n">FINGER_TYPE2</span> <span class="o">+</span> <span class="n">SIZEOF_ALL_FINGERS</span><span class="p">,</span>
		<span class="p">{</span> <span class="n">DIM_PRESSURE</span><span class="p">,</span> <span class="n">DIM_PRESSURE</span> <span class="o">/</span> <span class="n">SN_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">300</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_WIDTH</span><span class="p">,</span> <span class="n">DIM_WIDTH</span> <span class="o">/</span> <span class="n">SN_WIDTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2048</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_X</span><span class="p">,</span> <span class="n">DIM_X</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">4620</span><span class="p">,</span> <span class="mi">5140</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_Y</span><span class="p">,</span> <span class="n">DIM_Y</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">6600</span> <span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING4A_ANSI</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING4A_ISO</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING4A_JIS</span><span class="p">,</span>
		<span class="n">HAS_INTEGRATED_BUTTON</span><span class="p">,</span>
		<span class="mh">0x84</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bt_data</span><span class="p">),</span>
		<span class="mh">0x81</span><span class="p">,</span> <span class="n">TYPE2</span><span class="p">,</span> <span class="n">FINGER_TYPE2</span><span class="p">,</span> <span class="n">FINGER_TYPE2</span> <span class="o">+</span> <span class="n">SIZEOF_ALL_FINGERS</span><span class="p">,</span>
		<span class="p">{</span> <span class="n">DIM_PRESSURE</span><span class="p">,</span> <span class="n">DIM_PRESSURE</span> <span class="o">/</span> <span class="n">SN_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">300</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_WIDTH</span><span class="p">,</span> <span class="n">DIM_WIDTH</span> <span class="o">/</span> <span class="n">SN_WIDTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2048</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_X</span><span class="p">,</span> <span class="n">DIM_X</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">4616</span><span class="p">,</span> <span class="mi">5112</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_Y</span><span class="p">,</span> <span class="n">DIM_Y</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">142</span><span class="p">,</span> <span class="mi">5234</span> <span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING5_ANSI</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING5_ISO</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING5_JIS</span><span class="p">,</span>
		<span class="n">HAS_INTEGRATED_BUTTON</span><span class="p">,</span>
		<span class="mh">0x84</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bt_data</span><span class="p">),</span>
		<span class="mh">0x81</span><span class="p">,</span> <span class="n">TYPE2</span><span class="p">,</span> <span class="n">FINGER_TYPE2</span><span class="p">,</span> <span class="n">FINGER_TYPE2</span> <span class="o">+</span> <span class="n">SIZEOF_ALL_FINGERS</span><span class="p">,</span>
		<span class="p">{</span> <span class="n">DIM_PRESSURE</span><span class="p">,</span> <span class="n">DIM_PRESSURE</span> <span class="o">/</span> <span class="n">SN_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">300</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_WIDTH</span><span class="p">,</span> <span class="n">DIM_WIDTH</span> <span class="o">/</span> <span class="n">SN_WIDTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2048</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_X</span><span class="p">,</span> <span class="n">DIM_X</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">4415</span><span class="p">,</span> <span class="mi">5050</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_Y</span><span class="p">,</span> <span class="n">DIM_Y</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">55</span><span class="p">,</span> <span class="mi">6680</span> <span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING6_ANSI</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING6_ISO</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING6_JIS</span><span class="p">,</span>
		<span class="n">HAS_INTEGRATED_BUTTON</span><span class="p">,</span>
		<span class="mh">0x84</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bt_data</span><span class="p">),</span>
		<span class="mh">0x81</span><span class="p">,</span> <span class="n">TYPE2</span><span class="p">,</span> <span class="n">FINGER_TYPE2</span><span class="p">,</span> <span class="n">FINGER_TYPE2</span> <span class="o">+</span> <span class="n">SIZEOF_ALL_FINGERS</span><span class="p">,</span>
		<span class="p">{</span> <span class="n">DIM_PRESSURE</span><span class="p">,</span> <span class="n">DIM_PRESSURE</span> <span class="o">/</span> <span class="n">SN_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">300</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_WIDTH</span><span class="p">,</span> <span class="n">DIM_WIDTH</span> <span class="o">/</span> <span class="n">SN_WIDTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2048</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_X</span><span class="p">,</span> <span class="n">DIM_X</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">4620</span><span class="p">,</span> <span class="mi">5140</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_Y</span><span class="p">,</span> <span class="n">DIM_Y</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">6600</span> <span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING5A_ANSI</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING5A_ISO</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING5A_JIS</span><span class="p">,</span>
		<span class="n">HAS_INTEGRATED_BUTTON</span><span class="p">,</span>
		<span class="mh">0x84</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bt_data</span><span class="p">),</span>
		<span class="mh">0x81</span><span class="p">,</span> <span class="n">TYPE2</span><span class="p">,</span> <span class="n">FINGER_TYPE2</span><span class="p">,</span> <span class="n">FINGER_TYPE2</span> <span class="o">+</span> <span class="n">SIZEOF_ALL_FINGERS</span><span class="p">,</span>
		<span class="p">{</span> <span class="n">DIM_PRESSURE</span><span class="p">,</span> <span class="n">DIM_PRESSURE</span> <span class="o">/</span> <span class="n">SN_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">300</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_WIDTH</span><span class="p">,</span> <span class="n">DIM_WIDTH</span> <span class="o">/</span> <span class="n">SN_WIDTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2048</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_X</span><span class="p">,</span> <span class="n">DIM_X</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">4750</span><span class="p">,</span> <span class="mi">5280</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_Y</span><span class="p">,</span> <span class="n">DIM_Y</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">6730</span> <span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING6A_ANSI</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING6A_ISO</span><span class="p">,</span>
		<span class="n">USB_DEVICE_ID_APPLE_WELLSPRING6A_JIS</span><span class="p">,</span>
		<span class="n">HAS_INTEGRATED_BUTTON</span><span class="p">,</span>
		<span class="mh">0x84</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bt_data</span><span class="p">),</span>
		<span class="mh">0x81</span><span class="p">,</span> <span class="n">TYPE2</span><span class="p">,</span> <span class="n">FINGER_TYPE2</span><span class="p">,</span> <span class="n">FINGER_TYPE2</span> <span class="o">+</span> <span class="n">SIZEOF_ALL_FINGERS</span><span class="p">,</span>
		<span class="p">{</span> <span class="n">DIM_PRESSURE</span><span class="p">,</span> <span class="n">DIM_PRESSURE</span> <span class="o">/</span> <span class="n">SN_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">300</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_WIDTH</span><span class="p">,</span> <span class="n">DIM_WIDTH</span> <span class="o">/</span> <span class="n">SN_WIDTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2048</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_X</span><span class="p">,</span> <span class="n">DIM_X</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">4620</span><span class="p">,</span> <span class="mi">5140</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">DIM_Y</span><span class="p">,</span> <span class="n">DIM_Y</span> <span class="o">/</span> <span class="n">SN_COORD</span><span class="p">,</span> <span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">6600</span> <span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="cm">/* return the device-specific configuration by device */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">bcm5974_config</span> <span class="o">*</span><span class="nf">bcm5974_get_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">bcm5974_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">bcm5974_config_table</span><span class="p">;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ansi</span><span class="p">;</span> <span class="o">++</span><span class="n">cfg</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ansi</span> <span class="o">==</span> <span class="n">id</span> <span class="o">||</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">iso</span> <span class="o">==</span> <span class="n">id</span> <span class="o">||</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">jis</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bcm5974_config_table</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* convert 16-bit little endian to signed integer */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">raw2int</span><span class="p">(</span><span class="n">__le16</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">short</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* scale device data to logical dimensions (asserts devmin &lt; devmax) */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">int2scale</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">bcm5974_param</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dim</span> <span class="o">/</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">devmax</span> <span class="o">-</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">devmin</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* all logical value ranges are [0,dim). */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">int2bound</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">bcm5974_param</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">int2scale</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* setup which logical events to report */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_events_to_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">bcm5974_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>

	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">fuzz</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_TOOL_WIDTH</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">fuzz</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="n">fuzz</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">.</span><span class="n">fuzz</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* finger touch area */</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_MT_TOUCH_MAJOR</span><span class="p">,</span>
			     <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">devmin</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">devmax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_MT_TOUCH_MINOR</span><span class="p">,</span>
			     <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">devmin</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">devmax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* finger approach area */</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_MT_WIDTH_MAJOR</span><span class="p">,</span>
			     <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">devmin</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">devmax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_MT_WIDTH_MINOR</span><span class="p">,</span>
			     <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">devmin</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">devmax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* finger orientation */</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_MT_ORIENTATION</span><span class="p">,</span>
			     <span class="o">-</span><span class="n">MAX_FINGER_ORIENTATION</span><span class="p">,</span>
			     <span class="n">MAX_FINGER_ORIENTATION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* finger position */</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_MT_POSITION_X</span><span class="p">,</span>
			     <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="n">devmin</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="n">devmax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_MT_POSITION_Y</span><span class="p">,</span>
			     <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">.</span><span class="n">devmin</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">.</span><span class="n">devmax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOOL_FINGER</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOOL_DOUBLETAP</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOOL_TRIPLETAP</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOOL_QUADTAP</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">INPUT_PROP_POINTER</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">propbit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">HAS_INTEGRATED_BUTTON</span><span class="p">)</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">INPUT_PROP_BUTTONPAD</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">propbit</span><span class="p">);</span>

	<span class="n">input_set_events_per_packet</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* report button data as logical button state */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">report_bt_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm5974</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bt_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span>
		<span class="s">&quot;bcm5974: button data: %x %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_data</span><span class="o">-&gt;</span><span class="n">unknown1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_data</span><span class="o">-&gt;</span><span class="n">button</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_data</span><span class="o">-&gt;</span><span class="n">rel_x</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_data</span><span class="o">-&gt;</span><span class="n">rel_y</span><span class="p">);</span>

	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_data</span><span class="o">-&gt;</span><span class="n">button</span><span class="p">);</span>
	<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">report_finger_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">bcm5974_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">tp_finger</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_MT_TOUCH_MAJOR</span><span class="p">,</span>
			 <span class="n">raw2int</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">force_major</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_MT_TOUCH_MINOR</span><span class="p">,</span>
			 <span class="n">raw2int</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">force_minor</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_MT_WIDTH_MAJOR</span><span class="p">,</span>
			 <span class="n">raw2int</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">size_major</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_MT_WIDTH_MINOR</span><span class="p">,</span>
			 <span class="n">raw2int</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">size_minor</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_MT_ORIENTATION</span><span class="p">,</span>
			 <span class="n">MAX_FINGER_ORIENTATION</span> <span class="o">-</span> <span class="n">raw2int</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">orientation</span><span class="p">));</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_MT_POSITION_X</span><span class="p">,</span> <span class="n">raw2int</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">abs_x</span><span class="p">));</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_MT_POSITION_Y</span><span class="p">,</span>
			 <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">.</span><span class="n">devmin</span> <span class="o">+</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">.</span><span class="n">devmax</span> <span class="o">-</span> <span class="n">raw2int</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">abs_y</span><span class="p">));</span>
	<span class="n">input_mt_sync</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* report trackpad data as logical trackpad state */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">report_tp_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm5974</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">bcm5974_config</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tp_finger</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">raw_p</span><span class="p">,</span> <span class="n">raw_w</span><span class="p">,</span> <span class="n">raw_x</span><span class="p">,</span> <span class="n">raw_y</span><span class="p">,</span> <span class="n">raw_n</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ptest</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">ibt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">abs_p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">abs_w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">abs_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">abs_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">tp_offset</span> <span class="o">||</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">tp_offset</span><span class="p">)</span> <span class="o">%</span> <span class="n">SIZEOF_FINGER</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* finger data, le16-aligned */</span>
	<span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tp_finger</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_data</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">tp_offset</span><span class="p">);</span>
	<span class="n">raw_n</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">tp_offset</span><span class="p">)</span> <span class="o">/</span> <span class="n">SIZEOF_FINGER</span><span class="p">;</span>

	<span class="cm">/* always track the first finger; when detached, start over */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raw_n</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* report raw trackpad data */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">raw_n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">report_finger_data</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">raw_p</span> <span class="o">=</span> <span class="n">raw2int</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">force_major</span><span class="p">);</span>
		<span class="n">raw_w</span> <span class="o">=</span> <span class="n">raw2int</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">size_major</span><span class="p">);</span>
		<span class="n">raw_x</span> <span class="o">=</span> <span class="n">raw2int</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">abs_x</span><span class="p">);</span>
		<span class="n">raw_y</span> <span class="o">=</span> <span class="n">raw2int</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">abs_y</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span>
			<span class="s">&quot;bcm5974: &quot;</span>
			<span class="s">&quot;raw: p: %+05d w: %+05d x: %+05d y: %+05d n: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">raw_p</span><span class="p">,</span> <span class="n">raw_w</span><span class="p">,</span> <span class="n">raw_x</span><span class="p">,</span> <span class="n">raw_y</span><span class="p">,</span> <span class="n">raw_n</span><span class="p">);</span>

		<span class="n">ptest</span> <span class="o">=</span> <span class="n">int2bound</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">,</span> <span class="n">raw_p</span><span class="p">);</span>
		<span class="n">origin</span> <span class="o">=</span> <span class="n">raw2int</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">origin</span><span class="p">);</span>

		<span class="cm">/* while tracking finger still valid, count all fingers */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptest</span> <span class="o">&gt;</span> <span class="n">PRESSURE_LOW</span> <span class="o">&amp;&amp;</span> <span class="n">origin</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">abs_p</span> <span class="o">=</span> <span class="n">ptest</span><span class="p">;</span>
			<span class="n">abs_w</span> <span class="o">=</span> <span class="n">int2bound</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="n">raw_w</span><span class="p">);</span>
			<span class="n">abs_x</span> <span class="o">=</span> <span class="n">int2bound</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">raw_x</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="n">devmin</span><span class="p">);</span>
			<span class="n">abs_y</span> <span class="o">=</span> <span class="n">int2bound</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">.</span><span class="n">devmax</span> <span class="o">-</span> <span class="n">raw_y</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">raw_n</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ptest</span> <span class="o">=</span> <span class="n">int2bound</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">,</span>
						  <span class="n">raw2int</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">force_major</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ptest</span> <span class="o">&gt;</span> <span class="n">PRESSURE_LOW</span><span class="p">)</span>
					<span class="n">nmax</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ptest</span> <span class="o">&gt;</span> <span class="n">PRESSURE_HIGH</span><span class="p">)</span>
					<span class="n">nmin</span><span class="o">++</span><span class="p">;</span>
				<span class="n">f</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* set the integrated button if applicable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">tp_type</span> <span class="o">==</span> <span class="n">TYPE2</span><span class="p">)</span>
		<span class="n">ibt</span> <span class="o">=</span> <span class="n">raw2int</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_data</span><span class="p">[</span><span class="n">BUTTON_TYPE2</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fingers</span> <span class="o">&lt;</span> <span class="n">nmin</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fingers</span> <span class="o">=</span> <span class="n">nmin</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fingers</span> <span class="o">&gt;</span> <span class="n">nmax</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fingers</span> <span class="o">=</span> <span class="n">nmax</span><span class="p">;</span>

	<span class="n">input_report_key</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fingers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_TOOL_FINGER</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fingers</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_TOOL_DOUBLETAP</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fingers</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_TOOL_TRIPLETAP</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fingers</span> <span class="o">==</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_TOOL_QUADTAP</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fingers</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="n">abs_p</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_TOOL_WIDTH</span><span class="p">,</span> <span class="n">abs_w</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">abs_p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">abs_x</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">abs_y</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span>
			<span class="s">&quot;bcm5974: abs: p: %+05d w: %+05d x: %+05d y: %+05d &quot;</span>
			<span class="s">&quot;nmin: %d nmax: %d n: %d ibt: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">abs_p</span><span class="p">,</span> <span class="n">abs_w</span><span class="p">,</span>
			<span class="n">abs_x</span><span class="p">,</span> <span class="n">abs_y</span><span class="p">,</span> <span class="n">nmin</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fingers</span><span class="p">,</span> <span class="n">ibt</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="cm">/* type 2 reports button events via ibt only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">tp_type</span> <span class="o">==</span> <span class="n">TYPE2</span><span class="p">)</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">ibt</span><span class="p">);</span>

	<span class="n">input_sync</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Wellspring initialization constants */</span>
<span class="cp">#define BCM5974_WELLSPRING_MODE_READ_REQUEST_ID		1</span>
<span class="cp">#define BCM5974_WELLSPRING_MODE_WRITE_REQUEST_ID	9</span>
<span class="cp">#define BCM5974_WELLSPRING_MODE_REQUEST_VALUE		0x300</span>
<span class="cp">#define BCM5974_WELLSPRING_MODE_REQUEST_INDEX		0</span>
<span class="cp">#define BCM5974_WELLSPRING_MODE_VENDOR_VALUE		0x01</span>
<span class="cp">#define BCM5974_WELLSPRING_MODE_NORMAL_VALUE		0x08</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm5974_wellspring_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm5974</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read configuration */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">BCM5974_WELLSPRING_MODE_READ_REQUEST_ID</span><span class="p">,</span>
			<span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
			<span class="n">BCM5974_WELLSPRING_MODE_REQUEST_VALUE</span><span class="p">,</span>
			<span class="n">BCM5974_WELLSPRING_MODE_REQUEST_INDEX</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not read from device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* apply the mode switch */</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span>
		<span class="n">BCM5974_WELLSPRING_MODE_VENDOR_VALUE</span> <span class="o">:</span>
		<span class="n">BCM5974_WELLSPRING_MODE_NORMAL_VALUE</span><span class="p">;</span>

	<span class="cm">/* write configuration */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			<span class="n">BCM5974_WELLSPRING_MODE_WRITE_REQUEST_ID</span><span class="p">,</span>
			<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
			<span class="n">BCM5974_WELLSPRING_MODE_REQUEST_VALUE</span><span class="p">,</span>
			<span class="n">BCM5974_WELLSPRING_MODE_REQUEST_INDEX</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not write to device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;bcm5974: switched to %s mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">on</span> <span class="o">?</span> <span class="s">&quot;wellspring&quot;</span> <span class="o">:</span> <span class="s">&quot;normal&quot;</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm5974_irq_button</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm5974</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EOVERFLOW</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;button urb shutting down: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;button urb status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">report_bt_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">))</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;bcm5974: bad button package, length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;button urb failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm5974_irq_trackpad</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm5974</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EOVERFLOW</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;trackpad urb shutting down: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;trackpad urb status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* control response ignored */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">report_tp_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">))</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;bcm5974: bad trackpad package, length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;trackpad urb failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The Wellspring trackpad, like many recent Apple trackpads, share</span>
<span class="cm"> * the usb device with the keyboard. Since keyboards are usually</span>
<span class="cm"> * handled by the HID system, the device ends up being handled by two</span>
<span class="cm"> * modules. Setting up the device therefore becomes slightly</span>
<span class="cm"> * complicated. To enable multitouch features, a mode switch is</span>
<span class="cm"> * required, which is usually applied via the control interface of the</span>
<span class="cm"> * device.  It can be argued where this switch should take place. In</span>
<span class="cm"> * some drivers, like appletouch, the switch is made during</span>
<span class="cm"> * probe. However, the hid module may also alter the state of the</span>
<span class="cm"> * device, resulting in trackpad malfunction under certain</span>
<span class="cm"> * circumstances. To get around this problem, there is at least one</span>
<span class="cm"> * example that utilizes the USB_QUIRK_RESET_RESUME quirk in order to</span>
<span class="cm"> * receive a reset_resume request rather than the normal resume.</span>
<span class="cm"> * Since the implementation of reset_resume is equal to mode switch</span>
<span class="cm"> * plus start_traffic, it seems easier to always do the switch when</span>
<span class="cm"> * starting traffic on the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm5974_start_traffic</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm5974</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">bcm5974_wellspring_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;bcm5974: mode switch failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_reset_mode</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_kill_bt</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_kill_bt:</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_urb</span><span class="p">);</span>
<span class="nl">err_reset_mode:</span>
	<span class="n">bcm5974_wellspring_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm5974_pause_traffic</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm5974</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_urb</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_urb</span><span class="p">);</span>
	<span class="n">bcm5974_wellspring_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The code below implements open/close and manual suspend/resume.</span>
<span class="cm"> * All functions may be called in random order.</span>
<span class="cm"> *</span>
<span class="cm"> * Opening a suspended device fails with EACCES - permission denied.</span>
<span class="cm"> *</span>
<span class="cm"> * Failing a resume leaves the device resumed but closed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm5974_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm5974</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">usb_autopm_get_interface</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_mutex</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">bcm5974_start_traffic</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">usb_autopm_put_interface</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm5974_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm5974</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_mutex</span><span class="p">);</span>

	<span class="n">bcm5974_pause_traffic</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">opened</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_mutex</span><span class="p">);</span>

	<span class="n">usb_autopm_put_interface</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm5974_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm5974</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">)</span>
		<span class="n">bcm5974_pause_traffic</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm5974_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm5974</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">opened</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">bcm5974_start_traffic</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm5974_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">bcm5974_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcm5974</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* find the product index */</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">bcm5974_get_config</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>

	<span class="cm">/* allocate memory for our device state and initialize it */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcm5974</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">input_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_devs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">udev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span> <span class="o">=</span> <span class="n">iface</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input_dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">*</span><span class="n">cfg</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_mutex</span><span class="p">);</span>

	<span class="cm">/* setup urbs */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_urb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_devs</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_urb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_bt_urb</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_data</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
					  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">bt_datalen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_urb</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_data</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
					  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">tp_datalen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_bt_buffer</span><span class="p">;</span>

	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_urb</span><span class="p">,</span> <span class="n">udev</span><span class="p">,</span>
			 <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_ep</span><span class="p">),</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">bt_datalen</span><span class="p">,</span>
			 <span class="n">bcm5974_irq_button</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_urb</span><span class="p">,</span> <span class="n">udev</span><span class="p">,</span>
			 <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">tp_ep</span><span class="p">),</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">tp_datalen</span><span class="p">,</span>
			 <span class="n">bcm5974_irq_trackpad</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* create bcm5974 device */</span>
	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="s">&quot;/input0&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bcm5974&quot;</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">usb_to_input_id</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="cm">/* report driver capabilities via the version field */</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">bcm5974_open</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">bcm5974_close</span><span class="p">;</span>

	<span class="n">setup_events_to_report</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_buffer</span><span class="p">;</span>

	<span class="cm">/* save our data pointer in this interface device */</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_buffer:</span>
	<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">tp_datalen</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
<span class="nl">err_free_bt_buffer:</span>
	<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">bt_datalen</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
<span class="nl">err_free_urb:</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_urb</span><span class="p">);</span>
<span class="nl">err_free_bt_urb:</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_urb</span><span class="p">);</span>
<span class="nl">err_free_devs:</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bcm5974_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcm5974</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">iface</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
	<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">tp_datalen</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
	<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">.</span><span class="n">bt_datalen</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tp_urb</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bt_urb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">bcm5974_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;bcm5974&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>			<span class="o">=</span> <span class="n">bcm5974_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>		<span class="o">=</span> <span class="n">bcm5974_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>		<span class="o">=</span> <span class="n">bcm5974_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>			<span class="o">=</span> <span class="n">bcm5974_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>		<span class="o">=</span> <span class="n">bcm5974_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supports_autosuspend</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">bcm5974_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
