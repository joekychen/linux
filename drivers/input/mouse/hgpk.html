<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › mouse › hgpk.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hgpk.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * OLPC HGPK (XO-1) touchpad PS/2 mouse driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2006-2008 One Laptop Per Child</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *   Zephaniah E. Hull</span>
<span class="cm"> *   Andres Salomon &lt;dilinger@debian.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is partly based on the ALPS driver, which is:</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2003 Neil Brown &lt;neilb@cse.unsw.edu.au&gt;</span>
<span class="cm"> * Copyright (c) 2003-2005 Peter Osterlund &lt;petero2@telia.com&gt;</span>
<span class="cm"> * Copyright (c) 2004 Dmitry Torokhov &lt;dtor@mail.ru&gt;</span>
<span class="cm"> * Copyright (c) 2005 Vojtech Pavlik &lt;vojtech@suse.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The spec from ALPS is available from</span>
<span class="cm"> * &lt;http://wiki.laptop.org/go/Touch_Pad/Tablet&gt;.  It refers to this</span>
<span class="cm"> * device as HGPK (Hybrid GS, PT, and Keymatrix).</span>
<span class="cm"> *</span>
<span class="cm"> * The earliest versions of the device had simultaneous reporting; that</span>
<span class="cm"> * was removed.  After that, the device used the Advanced Mode GS/PT streaming</span>
<span class="cm"> * stuff.  That turned out to be too buggy to support, so we&#39;ve finally</span>
<span class="cm"> * switched to Mouse Mode (which utilizes only the center 1/3 of the touchpad).</span>
<span class="cm"> */</span>

<span class="cp">#define DEBUG</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/serio.h&gt;</span>
<span class="cp">#include &lt;linux/libps2.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;asm/olpc.h&gt;</span>

<span class="cp">#include &quot;psmouse.h&quot;</span>
<span class="cp">#include &quot;hgpk.h&quot;</span>

<span class="cp">#define ILLEGAL_XY 999999</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">tpdebug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tpdebug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tpdebug</span><span class="p">,</span> <span class="s">&quot;enable debugging, dumping packets to KERN_DEBUG.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">recalib_delta</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">recalib_delta</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">recalib_delta</span><span class="p">,</span>
	<span class="s">&quot;packets containing a delta this large will be discarded, and a &quot;</span>
	<span class="s">&quot;recalibration may be scheduled.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">jumpy_delay</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">jumpy_delay</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">jumpy_delay</span><span class="p">,</span>
	<span class="s">&quot;delay (ms) before recal after jumpiness detected&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">spew_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">spew_delay</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">spew_delay</span><span class="p">,</span>
	<span class="s">&quot;delay (ms) before recal after packet spew detected&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">recal_guard_time</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">recal_guard_time</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">recal_guard_time</span><span class="p">,</span>
	<span class="s">&quot;interval (ms) during which recal will be restarted if packet received&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">post_interrupt_delay</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">post_interrupt_delay</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">post_interrupt_delay</span><span class="p">,</span>
	<span class="s">&quot;delay (ms) before recal after recal interrupt detected&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">autorecal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">autorecal</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">autorecal</span><span class="p">,</span> <span class="s">&quot;enable recalibration in the driver&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">hgpk_mode_name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">hgpk_mode</span><span class="p">,</span> <span class="n">hgpk_mode_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hgpk_mode_name</span><span class="p">),</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hgpk_mode</span><span class="p">,</span>
	<span class="s">&quot;default hgpk mode: mouse, glidesensor or pentablet&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">hgpk_default_mode</span> <span class="o">=</span> <span class="n">HGPK_MODE_MOUSE</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">hgpk_mode_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">HGPK_MODE_MOUSE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Mouse&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">HGPK_MODE_GLIDESENSOR</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;GlideSensor&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">HGPK_MODE_PENTABLET</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;PenTablet&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hgpk_mode_from_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hgpk_mode_names</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">hgpk_mode_names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncasecmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">HGPK_MODE_INVALID</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * see if new value is within 20% of half of old value</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">approx_half</span><span class="p">(</span><span class="kt">int</span> <span class="n">curr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">belowhalf</span><span class="p">,</span> <span class="n">abovehalf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">prev</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">belowhalf</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">abovehalf</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)</span> <span class="o">/</span> <span class="mi">20</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">belowhalf</span> <span class="o">&lt;</span> <span class="n">curr</span> <span class="o">&amp;&amp;</span> <span class="n">curr</span> <span class="o">&lt;=</span> <span class="n">abovehalf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Throw out oddly large delta packets, and any that immediately follow whose</span>
<span class="cm"> * values are each approximately half of the previous.  It seems that the ALPS</span>
<span class="cm"> * firmware emits errant packets, and they get averaged out slowly.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hgpk_discard_decay_hack</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">avx</span><span class="p">,</span> <span class="n">avy</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">do_recal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">avx</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="n">avy</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>

	<span class="cm">/* discard if too big, or half that but &gt; 4 times the prev delta */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avx</span> <span class="o">&gt;</span> <span class="n">recalib_delta</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">avx</span> <span class="o">&gt;</span> <span class="n">recalib_delta</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">avx</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">xlast</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;detected %dpx jump in x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">xbigj</span> <span class="o">=</span> <span class="n">avx</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">approx_half</span><span class="p">(</span><span class="n">avx</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">xbigj</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;detected secondary %dpx jump in x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">xbigj</span> <span class="o">=</span> <span class="n">avx</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">xsaw_secondary</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">xbigj</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">xsaw_secondary</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">do_recal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">xbigj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">xsaw_secondary</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">avy</span> <span class="o">&gt;</span> <span class="n">recalib_delta</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">avy</span> <span class="o">&gt;</span> <span class="n">recalib_delta</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">avy</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ylast</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;detected %dpx jump in y</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ybigj</span> <span class="o">=</span> <span class="n">avy</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">approx_half</span><span class="p">(</span><span class="n">avy</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ybigj</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;detected secondary %dpx jump in y</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ybigj</span> <span class="o">=</span> <span class="n">avy</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ysaw_secondary</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ybigj</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ysaw_secondary</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">do_recal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ybigj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ysaw_secondary</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">xlast</span> <span class="o">=</span> <span class="n">avx</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ylast</span> <span class="o">=</span> <span class="n">avy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_recal</span> <span class="o">&amp;&amp;</span> <span class="n">jumpy_delay</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;scheduling recalibration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">psmouse_queue_work</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">recalib_wq</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">jumpy_delay</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">xbigj</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ybigj</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hgpk_reset_spew_detection</span><span class="p">(</span><span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">spew_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dupe_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">x_tally</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">y_tally</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">spew_flag</span> <span class="o">=</span> <span class="n">NO_SPEW</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hgpk_reset_hack_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">abs_x</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">abs_y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">xlast</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ylast</span> <span class="o">=</span> <span class="n">ILLEGAL_XY</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">xbigj</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ybigj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">xsaw_secondary</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ysaw_secondary</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hgpk_reset_spew_detection</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We have no idea why this particular hardware bug occurs.  The touchpad</span>
<span class="cm"> * will randomly start spewing packets without anything touching the</span>
<span class="cm"> * pad.  This wouldn&#39;t necessarily be bad, but it&#39;s indicative of a</span>
<span class="cm"> * severely miscalibrated pad; attempting to use the touchpad while it&#39;s</span>
<span class="cm"> * spewing means the cursor will jump all over the place, and act &quot;drunk&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * The packets that are spewed tend to all have deltas between -2 and 2, and</span>
<span class="cm"> * the cursor will move around without really going very far.  It will</span>
<span class="cm"> * tend to end up in the same location; if we tally up the changes over</span>
<span class="cm"> * 100 packets, we end up w/ a final delta of close to 0.  This happens</span>
<span class="cm"> * pretty regularly when the touchpad is spewing, and is pretty hard to</span>
<span class="cm"> * manually trigger (at least for *my* fingers).  So, it makes a perfect</span>
<span class="cm"> * scheme for detecting spews.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hgpk_spewing_hack</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="cm">/* ignore button press packets; many in a row could trigger</span>
<span class="cm">	 * a false-positive! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">||</span> <span class="n">r</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* don&#39;t track spew if the workaround feature has been turned off */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spew_delay</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no spew, or spew ended */</span>
		<span class="n">hgpk_reset_spew_detection</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Keep a tally of the overall delta to the cursor position caused by</span>
<span class="cm">	 * the spew */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">x_tally</span> <span class="o">+=</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">y_tally</span> <span class="o">+=</span> <span class="n">y</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">spew_flag</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NO_SPEW</span>:
		<span class="cm">/* we&#39;re not spewing, but this packet might be the start */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">spew_flag</span> <span class="o">=</span> <span class="n">MAYBE_SPEWING</span><span class="p">;</span>

		<span class="cm">/* fall-through */</span>

	<span class="k">case</span> <span class="n">MAYBE_SPEWING</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">spew_count</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">spew_count</span> <span class="o">&lt;</span> <span class="n">SPEW_WATCH_COUNT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* excessive spew detected, request recalibration */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">spew_flag</span> <span class="o">=</span> <span class="n">SPEW_DETECTED</span><span class="p">;</span>

		<span class="cm">/* fall-through */</span>

	<span class="k">case</span> <span class="n">SPEW_DETECTED</span>:
		<span class="cm">/* only recalibrate when the overall delta to the cursor</span>
<span class="cm">		 * is really small. if the spew is causing significant cursor</span>
<span class="cm">		 * movement, it is probably a case of the user moving the</span>
<span class="cm">		 * cursor very slowly across the screen. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">x_tally</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">abs</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">y_tally</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;packet spew detected (%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">x_tally</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">y_tally</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">spew_flag</span> <span class="o">=</span> <span class="n">RECALIBRATING</span><span class="p">;</span>
			<span class="n">psmouse_queue_work</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">recalib_wq</span><span class="p">,</span>
					   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">spew_delay</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RECALIBRATING</span>:
		<span class="cm">/* we already detected a spew and requested a recalibration,</span>
<span class="cm">		 * just wait for the queue to kick into action. */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * HGPK Mouse Mode format (standard mouse format, sans middle button)</span>
<span class="cm"> *</span>
<span class="cm"> * byte 0:	y-over	x-over	y-neg	x-neg	1	0	swr	swl</span>
<span class="cm"> * byte 1:	x7	x6	x5	x4	x3	x2	x1	x0</span>
<span class="cm"> * byte 2:	y7	y6	y5	y4	y3	y2	y1	y0</span>
<span class="cm"> *</span>
<span class="cm"> * swr/swl are the left/right buttons.</span>
<span class="cm"> * x-neg/y-neg are the x and y delta negative bits</span>
<span class="cm"> * x-over/y-over are the x and y overflow bits</span>
<span class="cm"> *</span>
<span class="cm"> * ---</span>
<span class="cm"> *</span>
<span class="cm"> * HGPK Advanced Mode - single-mode format</span>
<span class="cm"> *</span>
<span class="cm"> * byte 0(PT):  1    1    0    0    1    1     1     1</span>
<span class="cm"> * byte 0(GS):  1    1    1    1    1    1     1     1</span>
<span class="cm"> * byte 1:      0   x6   x5   x4   x3   x2    x1    x0</span>
<span class="cm"> * byte 2(PT):  0    0   x9   x8   x7    ? pt-dsw    0</span>
<span class="cm"> * byte 2(GS):  0  x10   x9   x8   x7    ? gs-dsw pt-dsw</span>
<span class="cm"> * byte 3:      0   y9   y8   y7    1    0   swr   swl</span>
<span class="cm"> * byte 4:      0   y6   y5   y4   y3   y2    y1    y0</span>
<span class="cm"> * byte 5:      0   z6   z5   z4   z3   z2    z1    z0</span>
<span class="cm"> *</span>
<span class="cm"> * ?&#39;s are not defined in the protocol spec, may vary between models.</span>
<span class="cm"> *</span>
<span class="cm"> * swr/swl are the left/right buttons.</span>
<span class="cm"> *</span>
<span class="cm"> * pt-dsw/gs-dsw indicate that the pt/gs sensor is detecting a</span>
<span class="cm"> * pen/finger</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">hgpk_is_byte_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pktcnt</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">valid</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HGPK_MODE_MOUSE</span>:
		<span class="n">valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HGPK_MODE_GLIDESENSOR</span>:
		<span class="n">valid</span> <span class="o">=</span> <span class="n">pktcnt</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span>
			<span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">HGPK_GS</span> <span class="o">:</span> <span class="o">!</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="n">pktcnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HGPK_MODE_PENTABLET</span>:
		<span class="n">valid</span> <span class="o">=</span> <span class="n">pktcnt</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span>
			<span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">HGPK_PT</span> <span class="o">:</span> <span class="o">!</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="n">pktcnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid</span><span class="p">)</span>
		<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
			    <span class="s">&quot;bad data, mode %d (%d) %02x %02x %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="n">pktcnt</span><span class="p">,</span>
			    <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			    <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			    <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">valid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hgpk_process_advanced_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">down</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">right</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x78</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">HGPK_MODE_GLIDESENSOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pt_down</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">finger_down</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">z</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpdebug</span><span class="p">)</span>
			<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;pd=%d fd=%d z=%d&quot;</span><span class="p">,</span>
				    <span class="n">pt_down</span><span class="p">,</span> <span class="n">finger_down</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * PenTablet mode does not report pressure, so we don&#39;t</span>
<span class="cm">		 * report it here</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpdebug</span><span class="p">)</span>
			<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;pd=%d &quot;</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpdebug</span><span class="p">)</span>
		<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;l=%d r=%d x=%d y=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>

	<span class="n">input_report_key</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this packet says that the finger was removed, reset our position</span>
<span class="cm">	 * tracking so that we don&#39;t erroneously detect a jump on next press.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">down</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hgpk_reset_hack_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Weed out duplicate packets (we get quite a few, and they mess up</span>
<span class="cm">	 * our jump detection)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">abs_x</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">abs_y</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dupe_count</span> <span class="o">&gt;</span> <span class="n">SPEW_WATCH_COUNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tpdebug</span><span class="p">)</span>
				<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;hard spew detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">spew_flag</span> <span class="o">=</span> <span class="n">RECALIBRATING</span><span class="p">;</span>
			<span class="n">psmouse_queue_work</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">recalib_wq</span><span class="p">,</span>
					   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">spew_delay</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* not a duplicate, continue with position reporting */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dupe_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t apply hacks in PT mode, it seems reliable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">HGPK_MODE_PENTABLET</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">abs_x</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">x_diff</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">abs_x</span> <span class="o">-</span> <span class="n">x</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">y_diff</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">abs_y</span> <span class="o">-</span> <span class="n">y</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hgpk_discard_decay_hack</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">x_diff</span><span class="p">,</span> <span class="n">y_diff</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tpdebug</span><span class="p">)</span>
				<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;discarding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hgpk_spewing_hack</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">x_diff</span><span class="p">,</span> <span class="n">y_diff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">abs_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">abs_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">input_sync</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hgpk_process_simple_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">-</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span>
		<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
			    <span class="s">&quot;overflow -- 0x%02x 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hgpk_discard_decay_hack</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpdebug</span><span class="p">)</span>
			<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;discarding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hgpk_spewing_hack</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpdebug</span><span class="p">)</span>
		<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;l=%d r=%d x=%d y=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>

	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>

	<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_X</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_Y</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>

	<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">psmouse_ret_t</span> <span class="nf">hgpk_process_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hgpk_is_byte_valid</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PSMOUSE_BAD_DATA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">&gt;=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">HGPK_MODE_MOUSE</span><span class="p">)</span>
			<span class="n">hgpk_process_simple_packet</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">hgpk_process_advanced_packet</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PSMOUSE_FULL_PACKET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">recalib_window</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">recalib_window</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * ugh, got a packet inside our recalibration</span>
<span class="cm">			 * window, schedule another recalibration.</span>
<span class="cm">			 */</span>
			<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
				    <span class="s">&quot;packet inside calibration window, queueing another recalibration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">psmouse_queue_work</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">recalib_wq</span><span class="p">,</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">post_interrupt_delay</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">recalib_window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">PSMOUSE_GOOD_DATA</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hgpk_select_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 4 disables to enable advanced mode</span>
<span class="cm">	 * then 3 0xf2 bytes as the preamble for GS/PT selection</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">advanced_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">,</span>
		<span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">,</span>
		<span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HGPK_MODE_MOUSE</span>:
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HGPK_MODE_GLIDESENSOR</span>:
	<span class="k">case</span> <span class="n">HGPK_MODE_PENTABLET</span>:
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

		<span class="cm">/* Switch to &#39;Advanced mode.&#39;, four disables in a row. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">advanced_init</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">advanced_init</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="cm">/* select between GlideSensor (mouse) or PenTablet */</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">HGPK_MODE_GLIDESENSOR</span> <span class="o">?</span>
			<span class="n">PSMOUSE_CMD_SETSCALE11</span> <span class="o">:</span> <span class="n">PSMOUSE_CMD_SETSCALE21</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hgpk_setup_input_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">old_input</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">hgpk_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">old_input</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
		<span class="n">input</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">old_input</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
		<span class="n">input</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">old_input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">input</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">old_input</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">));</span>

	<span class="cm">/* All modes report left and right buttons */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HGPK_MODE_MOUSE</span>:
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_REL</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">REL_X</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">REL_Y</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HGPK_MODE_GLIDESENSOR</span>:
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOOL_FINGER</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

		<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>

		<span class="cm">/* GlideSensor has pressure sensor, PenTablet does not */</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* From device specs */</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">399</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">290</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Calculated by hand based on usable size (52mm x 38mm) */</span>
		<span class="n">input_abs_set_res</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">input_abs_set_res</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HGPK_MODE_PENTABLET</span>:
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOOL_FINGER</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

		<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>

		<span class="cm">/* From device specs */</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">999</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Calculated by hand based on usable size (156mm x 38mm) */</span>
		<span class="n">input_abs_set_res</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">input_abs_set_res</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hgpk_reset_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">bool</span> <span class="n">recalibrate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">psmouse_reset</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">recalibrate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>

		<span class="cm">/* send the recalibrate request */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* according to ALPS, 150mS is required for recalibration */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hgpk_select_mode</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;failed to select mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hgpk_reset_hack_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hgpk_force_recalibrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* C-series touchpads added the recalibrate command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&lt;</span> <span class="n">HGPK_MODEL_C</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">autorecal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;recalibration disabled, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;recalibrating touchpad..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* we don&#39;t want to race with the irq handler, nor with resyncs */</span>
	<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_INITIALIZING</span><span class="p">);</span>

	<span class="cm">/* start by resetting the device */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hgpk_reset_device</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX: If a finger is down during this delay, recalibration will</span>
<span class="cm">	 * detect capacitance incorrectly.  This is a hardware bug, and</span>
<span class="cm">	 * we don&#39;t have a good way to deal with it.  The 2s window stuff</span>
<span class="cm">	 * (below) is our best option for now.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_activate</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpdebug</span><span class="p">)</span>
		<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;touchpad reactivated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we get packets right away after recalibrating, it&#39;s likely</span>
<span class="cm">	 * that a finger was on the touchpad.  If so, it&#39;s probably</span>
<span class="cm">	 * miscalibrated, so we optionally schedule another.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recal_guard_time</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">recalib_window</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">recal_guard_time</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This puts the touchpad in a power saving mode; according to ALPS, current</span>
<span class="cm"> * consumption goes down to 50uA after running this.  To turn power back on,</span>
<span class="cm"> * we drive MS-DAT low.  Measuring with a 1mA resolution ammeter says that</span>
<span class="cm"> * the current on the SUS_3.3V rail drops from 3mA or 4mA to 0 when we do this.</span>
<span class="cm"> *</span>
<span class="cm"> * We have no formal spec that details this operation -- the low-power</span>
<span class="cm"> * sequence came from a long-lost email trail.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hgpk_toggle_powersave</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Added on D-series touchpads */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&lt;</span> <span class="n">HGPK_MODEL_D</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_INITIALIZING</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Sending a byte will drive MS-DAT low; this will wake up</span>
<span class="cm">		 * the controller.  Once we get an ACK back from it, it</span>
<span class="cm">		 * means we can continue with the touchpad re-init.  ALPS</span>
<span class="cm">		 * tells us that 1s should be long enough, so set that as</span>
<span class="cm">		 * the upper bound. (in practice, it takes about 3 loops.)</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">timeo</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="n">timeo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">timeo</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ps2_sendbyte</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span>
					<span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hgpk_reset_device</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Failed to reset device!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* should be all set, enable the touchpad */</span>
		<span class="n">psmouse_activate</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
		<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Touchpad powered up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Powering off touchpad.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_IGNORE</span><span class="p">);</span>

		<span class="cm">/* probably won&#39;t see an ACK, the touchpad will be off */</span>
		<span class="n">ps2_sendbyte</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hgpk_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We can&#39;t poll, so always return failure. */</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hgpk_reconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * During suspend/resume the ps2 rails remain powered.  We don&#39;t want</span>
<span class="cm">	 * to do a reset because it&#39;s flush data out of buffers; however,</span>
<span class="cm">	 * earlier prototypes (B1) had some brokenness that required a reset.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">olpc_board_at_least</span><span class="p">(</span><span class="n">olpc_board</span><span class="p">(</span><span class="mh">0xb2</span><span class="p">)))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span> <span class="o">!=</span>
				<span class="n">PM_EVENT_ON</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">powered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">hgpk_reset_device</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hgpk_show_powered</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">powered</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hgpk_set_powered</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">powered</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * hgpk_toggle_power will deal w/ state so</span>
<span class="cm">		 * we&#39;re not racing w/ irq</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hgpk_toggle_powersave</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">powered</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__PSMOUSE_DEFINE_ATTR</span><span class="p">(</span><span class="n">powered</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		      <span class="n">hgpk_show_powered</span><span class="p">,</span> <span class="n">hgpk_set_powered</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">attr_show_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hgpk_mode_names</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">attr_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">hgpk_mode</span> <span class="n">old_mode</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">hgpk_mode</span> <span class="n">new_mode</span> <span class="o">=</span> <span class="n">hgpk_mode_from_name</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">old_dev</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">new_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">HGPK_MODE_INVALID</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_mode</span> <span class="o">==</span> <span class="n">new_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">new_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_INITIALIZING</span><span class="p">);</span>

	<span class="cm">/* Switch device into the new mode */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">new_mode</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hgpk_reset_device</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_try_restore</span><span class="p">;</span>

	<span class="n">hgpk_setup_input_device</span><span class="p">(</span><span class="n">new_dev</span><span class="p">,</span> <span class="n">old_dev</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">);</span>

	<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_MODE</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">new_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_try_restore</span><span class="p">;</span>

	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">new_dev</span><span class="p">;</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">old_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

<span class="nl">err_try_restore:</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">new_dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">old_mode</span><span class="p">;</span>
	<span class="n">hgpk_reset_device</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">PSMOUSE_DEFINE_ATTR</span><span class="p">(</span><span class="n">hgpk_mode</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		    <span class="n">attr_show_mode</span><span class="p">,</span> <span class="n">attr_set_mode</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hgpk_trigger_recal_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hgpk_trigger_recal</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We queue work instead of doing recalibration right here</span>
<span class="cm">	 * to avoid adding locking to to hgpk_force_recalibrate()</span>
<span class="cm">	 * since workqueue provides serialization.</span>
<span class="cm">	 */</span>
	<span class="n">psmouse_queue_work</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">recalib_wq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__PSMOUSE_DEFINE_ATTR</span><span class="p">(</span><span class="n">recalibrate</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		      <span class="n">hgpk_trigger_recal_show</span><span class="p">,</span> <span class="n">hgpk_trigger_recal</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hgpk_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">psmouse_attr_powered</span><span class="p">.</span><span class="n">dattr</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">psmouse_attr_hgpk_mode</span><span class="p">.</span><span class="n">dattr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&gt;=</span> <span class="n">HGPK_MODEL_C</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">psmouse_attr_recalibrate</span><span class="p">.</span><span class="n">dattr</span><span class="p">);</span>

	<span class="n">psmouse_reset</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hgpk_recalib_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hgpk_data</span><span class="p">,</span> <span class="n">recalib_wq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">psmouse</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hgpk_force_recalibrate</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;recalibration failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hgpk_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* register handlers */</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">protocol_handler</span> <span class="o">=</span> <span class="n">hgpk_process_byte</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="n">hgpk_poll</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">hgpk_disconnect</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">reconnect</span> <span class="o">=</span> <span class="n">hgpk_reconnect</span><span class="p">;</span>

	<span class="cm">/* Disable the idle resync. */</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resync_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Reset after a lot of bad bytes. */</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resetafter</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>

	<span class="n">hgpk_setup_input_device</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">psmouse_attr_powered</span><span class="p">.</span><span class="n">dattr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Failed creating &#39;powered&#39; sysfs node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">psmouse_attr_hgpk_mode</span><span class="p">.</span><span class="n">dattr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
			    <span class="s">&quot;Failed creating &#39;hgpk_mode&#39; sysfs node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_remove_powered</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* C-series touchpads added the recalibrate command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&gt;=</span> <span class="n">HGPK_MODEL_C</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">psmouse_attr_recalibrate</span><span class="p">.</span><span class="n">dattr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
				    <span class="s">&quot;Failed creating &#39;recalibrate&#39; sysfs node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_remove_mode</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_remove_mode:</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">psmouse_attr_hgpk_mode</span><span class="p">.</span><span class="n">dattr</span><span class="p">);</span>
<span class="nl">err_remove_powered:</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">psmouse_attr_powered</span><span class="p">.</span><span class="n">dattr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hgpk_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hgpk_data</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hgpk_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">alloc_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">psmouse</span> <span class="o">=</span> <span class="n">psmouse</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">powered</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">hgpk_default_mode</span><span class="p">;</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">recalib_wq</span><span class="p">,</span> <span class="n">hgpk_recalib_work</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hgpk_reset_device</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_fail</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hgpk_register</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_fail</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">init_fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">alloc_fail:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">hgpk_model_t</span> <span class="nf">hgpk_get_model</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* E7, E7, E7, E9 gets us a 3 byte identifier */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE21</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE21</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE21</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_GETINFO</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;ID: %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="cm">/* HGPK signature: 0x67, 0x00, 0x&lt;model&gt; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x67</span> <span class="o">||</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">psmouse_info</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;OLPC touchpad revision 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hgpk_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set_properties</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">version</span><span class="p">;</span>

	<span class="n">version</span> <span class="o">=</span> <span class="n">hgpk_get_model</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">version</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_properties</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="s">&quot;ALPS&quot;</span><span class="p">;</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HGPK&quot;</span><span class="p">;</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">version</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hgpk_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hgpk_default_mode</span> <span class="o">=</span> <span class="n">hgpk_mode_from_name</span><span class="p">(</span><span class="n">hgpk_mode_name</span><span class="p">,</span>
						<span class="n">strlen</span><span class="p">(</span><span class="n">hgpk_mode_name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hgpk_default_mode</span> <span class="o">==</span> <span class="n">HGPK_MODE_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hgpk_default_mode</span> <span class="o">=</span> <span class="n">HGPK_MODE_MOUSE</span><span class="p">;</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">hgpk_mode_name</span><span class="p">,</span> <span class="n">hgpk_mode_names</span><span class="p">[</span><span class="n">HGPK_MODE_MOUSE</span><span class="p">],</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">hgpk_mode_name</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
