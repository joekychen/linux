<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › mouse › alps.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>alps.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ALPS touchpad PS/2 mouse driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2003 Neil Brown &lt;neilb@cse.unsw.edu.au&gt;</span>
<span class="cm"> * Copyright (c) 2003-2005 Peter Osterlund &lt;petero2@telia.com&gt;</span>
<span class="cm"> * Copyright (c) 2004 Dmitry Torokhov &lt;dtor@mail.ru&gt;</span>
<span class="cm"> * Copyright (c) 2005 Vojtech Pavlik &lt;vojtech@suse.cz&gt;</span>
<span class="cm"> * Copyright (c) 2009 Sebastian Kapfer &lt;sebastian_kapfer@gmx.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * ALPS detection, tap switching and status querying info is taken from</span>
<span class="cm"> * tpconfig utility (by C. Scott Ananian and Bruce Kall).</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/input/mt.h&gt;</span>
<span class="cp">#include &lt;linux/serio.h&gt;</span>
<span class="cp">#include &lt;linux/libps2.h&gt;</span>

<span class="cp">#include &quot;psmouse.h&quot;</span>
<span class="cp">#include &quot;alps.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Definitions for ALPS version 3 and 4 command mode protocol</span>
<span class="cm"> */</span>
<span class="cp">#define ALPS_V3_X_MAX	2000</span>
<span class="cp">#define ALPS_V3_Y_MAX	1400</span>

<span class="cp">#define ALPS_BITMAP_X_BITS	15</span>
<span class="cp">#define ALPS_BITMAP_Y_BITS	11</span>

<span class="cp">#define ALPS_CMD_NIBBLE_10	0x01f2</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">alps_nibble_commands</span> <span class="n">alps_v3_nibble_commands</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETPOLL</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span> <span class="cm">/* 0 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_RESET_DIS</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span> <span class="cm">/* 1 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETSCALE21</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span> <span class="cm">/* 2 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">,</span>		<span class="mh">0x0a</span> <span class="p">},</span> <span class="cm">/* 3 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">,</span>		<span class="mh">0x14</span> <span class="p">},</span> <span class="cm">/* 4 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">,</span>		<span class="mh">0x28</span> <span class="p">},</span> <span class="cm">/* 5 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">,</span>		<span class="mh">0x3c</span> <span class="p">},</span> <span class="cm">/* 6 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">,</span>		<span class="mh">0x50</span> <span class="p">},</span> <span class="cm">/* 7 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">,</span>		<span class="mh">0x64</span> <span class="p">},</span> <span class="cm">/* 8 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">,</span>		<span class="mh">0xc8</span> <span class="p">},</span> <span class="cm">/* 9 */</span>
	<span class="p">{</span> <span class="n">ALPS_CMD_NIBBLE_10</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span> <span class="cm">/* a */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span> <span class="cm">/* b */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">,</span>		<span class="mh">0x01</span> <span class="p">},</span> <span class="cm">/* c */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">,</span>		<span class="mh">0x02</span> <span class="p">},</span> <span class="cm">/* d */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">,</span>		<span class="mh">0x03</span> <span class="p">},</span> <span class="cm">/* e */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETSCALE11</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span> <span class="cm">/* f */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">alps_nibble_commands</span> <span class="n">alps_v4_nibble_commands</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_ENABLE</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span> <span class="cm">/* 0 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_RESET_DIS</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span> <span class="cm">/* 1 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETSCALE21</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span> <span class="cm">/* 2 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">,</span>		<span class="mh">0x0a</span> <span class="p">},</span> <span class="cm">/* 3 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">,</span>		<span class="mh">0x14</span> <span class="p">},</span> <span class="cm">/* 4 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">,</span>		<span class="mh">0x28</span> <span class="p">},</span> <span class="cm">/* 5 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">,</span>		<span class="mh">0x3c</span> <span class="p">},</span> <span class="cm">/* 6 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">,</span>		<span class="mh">0x50</span> <span class="p">},</span> <span class="cm">/* 7 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">,</span>		<span class="mh">0x64</span> <span class="p">},</span> <span class="cm">/* 8 */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">,</span>		<span class="mh">0xc8</span> <span class="p">},</span> <span class="cm">/* 9 */</span>
	<span class="p">{</span> <span class="n">ALPS_CMD_NIBBLE_10</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span> <span class="cm">/* a */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">,</span>		<span class="mh">0x00</span> <span class="p">},</span> <span class="cm">/* b */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">,</span>		<span class="mh">0x01</span> <span class="p">},</span> <span class="cm">/* c */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">,</span>		<span class="mh">0x02</span> <span class="p">},</span> <span class="cm">/* d */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">,</span>		<span class="mh">0x03</span> <span class="p">},</span> <span class="cm">/* e */</span>
	<span class="p">{</span> <span class="n">PSMOUSE_CMD_SETSCALE11</span><span class="p">,</span>	<span class="mh">0x00</span> <span class="p">},</span> <span class="cm">/* f */</span>
<span class="p">};</span>


<span class="cp">#define ALPS_DUALPOINT		0x02	</span><span class="cm">/* touchpad has trackstick */</span><span class="cp"></span>
<span class="cp">#define ALPS_PASS		0x04	</span><span class="cm">/* device has a pass-through port */</span><span class="cp"></span>

<span class="cp">#define ALPS_WHEEL		0x08	</span><span class="cm">/* hardware wheel present */</span><span class="cp"></span>
<span class="cp">#define ALPS_FW_BK_1		0x10	</span><span class="cm">/* front &amp; back buttons present */</span><span class="cp"></span>
<span class="cp">#define ALPS_FW_BK_2		0x20	</span><span class="cm">/* front &amp; back buttons present */</span><span class="cp"></span>
<span class="cp">#define ALPS_FOUR_BUTTONS	0x40	</span><span class="cm">/* 4 direction button present */</span><span class="cp"></span>
<span class="cp">#define ALPS_PS2_INTERLEAVED	0x80	</span><span class="cm">/* 3-byte PS/2 packet interleaved with</span>
<span class="cm">					   6-byte ALPS packet */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">alps_model_info</span> <span class="n">alps_model_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x14</span> <span class="p">},</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="n">ALPS_PASS</span> <span class="o">|</span> <span class="n">ALPS_DUALPOINT</span> <span class="p">},</span>	<span class="cm">/* Toshiba Salellite Pro M10 */</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V1</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>				<span class="cm">/* UMAX-530T */</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x14</span> <span class="p">},</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xc8</span> <span class="p">},</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>				<span class="cm">/* HP ze1115 */</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x14</span> <span class="p">},</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x28</span> <span class="p">},</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="n">ALPS_FW_BK_2</span> <span class="p">},</span>		<span class="cm">/* Fujitsu Siemens S6010 */</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x3c</span> <span class="p">},</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="n">ALPS_WHEEL</span> <span class="p">},</span>			<span class="cm">/* Toshiba Satellite S2400-103 */</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x50</span> <span class="p">},</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="n">ALPS_FW_BK_1</span> <span class="p">},</span>		<span class="cm">/* NEC Versa L320 */</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x64</span> <span class="p">},</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xc8</span> <span class="p">},</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="n">ALPS_PASS</span> <span class="o">|</span> <span class="n">ALPS_DUALPOINT</span> <span class="p">},</span>	<span class="cm">/* Dell Latitude D800 */</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="n">ALPS_DUALPOINT</span> <span class="p">},</span>		<span class="cm">/* ThinkPad R61 8918-5QG */</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x14</span> <span class="p">},</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="n">ALPS_FW_BK_2</span> <span class="p">},</span>		<span class="cm">/* Ahtec Laptop */</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0e</span> <span class="p">},</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="n">ALPS_PASS</span> <span class="o">|</span> <span class="n">ALPS_DUALPOINT</span> <span class="p">},</span>	<span class="cm">/* XXX */</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span>	<span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="n">ALPS_PASS</span> <span class="o">|</span> <span class="n">ALPS_DUALPOINT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x14</span> <span class="p">},</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ALPS_PASS</span> <span class="o">|</span> <span class="n">ALPS_DUALPOINT</span> <span class="p">},</span>	<span class="cm">/* Dell Latitude D600 */</span>
	<span class="cm">/* Dell Latitude E5500, E6400, E6500, Precision M4400 */</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x14</span> <span class="p">},</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span>
		<span class="n">ALPS_PASS</span> <span class="o">|</span> <span class="n">ALPS_DUALPOINT</span> <span class="o">|</span> <span class="n">ALPS_PS2_INTERLEAVED</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x50</span> <span class="p">},</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="n">ALPS_FOUR_BUTTONS</span> <span class="p">},</span>		<span class="cm">/* Dell Vostro 1400 */</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x14</span> <span class="p">},</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">ALPS_PROTO_V2</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">ALPS_PASS</span> <span class="o">|</span> <span class="n">ALPS_DUALPOINT</span> <span class="o">|</span> <span class="n">ALPS_PS2_INTERLEAVED</span> <span class="p">},</span>				<span class="cm">/* Toshiba Tecra A11-11L */</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x64</span> <span class="p">},</span>	<span class="mh">0x9b</span><span class="p">,</span> <span class="n">ALPS_PROTO_V3</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="n">ALPS_DUALPOINT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x64</span> <span class="p">},</span>	<span class="mh">0x9d</span><span class="p">,</span> <span class="n">ALPS_PROTO_V3</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="n">ALPS_DUALPOINT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">{</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x64</span> <span class="p">},</span>	<span class="mh">0x8a</span><span class="p">,</span> <span class="n">ALPS_PROTO_V4</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * XXX - this entry is suspicious. First byte has zero lower nibble,</span>
<span class="cm"> * which is what a normal mouse would report. Also, the value 0x0e</span>
<span class="cm"> * isn&#39;t valid per PS/2 spec.</span>
<span class="cm"> */</span>

<span class="cm">/* Packet formats are described in Documentation/input/alps.txt */</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">alps_is_valid_first_byte</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">alps_model_info</span> <span class="o">*</span><span class="n">model</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">mask0</span><span class="p">)</span> <span class="o">==</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">byte0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alps_report_buttons</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev2</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="kt">int</span> <span class="n">right</span><span class="p">,</span> <span class="kt">int</span> <span class="n">middle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If shared button has already been reported on the</span>
<span class="cm">	 * other device (dev2) then this event should be also</span>
<span class="cm">	 * sent through that device.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">dev2</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="o">?</span> <span class="n">dev2</span> <span class="o">:</span> <span class="n">dev1</span><span class="p">;</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">dev2</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="o">?</span> <span class="n">dev2</span> <span class="o">:</span> <span class="n">dev1</span><span class="p">;</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">dev2</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="o">?</span> <span class="n">dev2</span> <span class="o">:</span> <span class="n">dev1</span><span class="p">;</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">middle</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sync the _other_ device now, we&#39;ll do the first</span>
<span class="cm">	 * device later once we report the rest of the events.</span>
<span class="cm">	 */</span>
	<span class="n">input_sync</span><span class="p">(</span><span class="n">dev2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alps_process_packet_v1_v2</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">alps_model_info</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev2</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">ges</span><span class="p">,</span> <span class="n">fin</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">middle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">back</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">forward</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">proto_version</span> <span class="o">==</span> <span class="n">ALPS_PROTO_V1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="n">middle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">z</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">middle</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x78</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="mi">3</span><span class="p">));</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">z</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ALPS_FW_BK_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">back</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">forward</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ALPS_FW_BK_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">back</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">forward</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">middle</span> <span class="o">=</span> <span class="n">forward</span> <span class="o">&amp;&amp;</span> <span class="n">back</span><span class="p">))</span>
			<span class="n">forward</span> <span class="o">=</span> <span class="n">back</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ges</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fin</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ALPS_DUALPOINT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">z</span> <span class="o">==</span> <span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev2</span><span class="p">,</span> <span class="n">REL_X</span><span class="p">,</span>  <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">383</span> <span class="o">?</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">768</span><span class="p">)</span> <span class="o">:</span> <span class="n">x</span><span class="p">));</span>
		<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev2</span><span class="p">,</span> <span class="n">REL_Y</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="o">?</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="mi">512</span><span class="p">)</span> <span class="o">:</span> <span class="n">y</span><span class="p">));</span>

		<span class="n">alps_report_buttons</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">dev2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">middle</span><span class="p">);</span>

		<span class="n">input_sync</span><span class="p">(</span><span class="n">dev2</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">alps_report_buttons</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dev2</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">middle</span><span class="p">);</span>

	<span class="cm">/* Convert hardware tap to a reasonable Z value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ges</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fin</span><span class="p">)</span>
		<span class="n">z</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * A &quot;tap and drag&quot; operation is reported by the hardware as a transition</span>
<span class="cm">	 * from (!fin &amp;&amp; ges) to (fin &amp;&amp; ges). This should be translated to the</span>
<span class="cm">	 * sequence Z&gt;0, Z==0, Z&gt;0, so the Z==0 event has to be generated manually.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ges</span> <span class="o">&amp;&amp;</span> <span class="n">fin</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prev_fin</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TOOL_FINGER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">prev_fin</span> <span class="o">=</span> <span class="n">fin</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">)</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TOOL_FINGER</span><span class="p">,</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ALPS_WHEEL</span><span class="p">)</span>
		<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_WHEEL</span><span class="p">,</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ALPS_FW_BK_1</span> <span class="o">|</span> <span class="n">ALPS_FW_BK_2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_FORWARD</span><span class="p">,</span> <span class="n">forward</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_BACK</span><span class="p">,</span> <span class="n">back</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ALPS_FOUR_BUTTONS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_0</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_1</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_2</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_3</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process bitmap data from v3 and v4 protocols. Returns the number of</span>
<span class="cm"> * fingers detected. A return value of 0 means at least one of the</span>
<span class="cm"> * bitmaps was empty.</span>
<span class="cm"> *</span>
<span class="cm"> * The bitmaps don&#39;t have enough data to track fingers, so this function</span>
<span class="cm"> * only generates points representing a bounding box of all contacts.</span>
<span class="cm"> * These points are returned in x1, y1, x2, and y2 when the return value</span>
<span class="cm"> * is greater than 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_process_bitmap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x_map</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">y_map</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="o">*</span><span class="n">x1</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y1</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x2</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">alps_bitmap_point</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">start_bit</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">num_bits</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="kt">int</span> <span class="n">fingers_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fingers_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fingers</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">prev_bit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">alps_bitmap_point</span> <span class="n">x_low</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,},</span> <span class="n">x_high</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,};</span>
	<span class="k">struct</span> <span class="n">alps_bitmap_point</span> <span class="n">y_low</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,},</span> <span class="n">y_high</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,};</span>
	<span class="k">struct</span> <span class="n">alps_bitmap_point</span> <span class="o">*</span><span class="n">point</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x_map</span> <span class="o">||</span> <span class="o">!</span><span class="n">y_map</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">x1</span> <span class="o">=</span> <span class="o">*</span><span class="n">y1</span> <span class="o">=</span> <span class="o">*</span><span class="n">x2</span> <span class="o">=</span> <span class="o">*</span><span class="n">y2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">prev_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">point</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">x_low</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x_map</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">x_map</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="n">x_map</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prev_bit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">point</span><span class="o">-&gt;</span><span class="n">start_bit</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">fingers_x</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">point</span><span class="o">-&gt;</span><span class="n">num_bits</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev_bit</span><span class="p">)</span>
				<span class="n">point</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">x_high</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">point</span><span class="o">-&gt;</span><span class="n">num_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">prev_bit</span> <span class="o">=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * y bitmap is reversed for what we need (lower positions are in</span>
<span class="cm">	 * higher bits), so we process from the top end.</span>
<span class="cm">	 */</span>
	<span class="n">y_map</span> <span class="o">=</span> <span class="n">y_map</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">y_map</span><span class="p">)</span> <span class="o">*</span> <span class="n">BITS_PER_BYTE</span> <span class="o">-</span> <span class="n">ALPS_BITMAP_Y_BITS</span><span class="p">);</span>
	<span class="n">prev_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">point</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">y_low</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y_map</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">y_map</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="n">y_map</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">y_map</span><span class="p">)</span> <span class="o">*</span> <span class="n">BITS_PER_BYTE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prev_bit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">point</span><span class="o">-&gt;</span><span class="n">start_bit</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">fingers_y</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">point</span><span class="o">-&gt;</span><span class="n">num_bits</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev_bit</span><span class="p">)</span>
				<span class="n">point</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">y_high</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">point</span><span class="o">-&gt;</span><span class="n">num_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">prev_bit</span> <span class="o">=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fingers can overlap, so we use the maximum count of fingers</span>
<span class="cm">	 * on either axis as the finger count.</span>
<span class="cm">	 */</span>
	<span class="n">fingers</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">fingers_x</span><span class="p">,</span> <span class="n">fingers_y</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If total fingers is &gt; 1 but either axis reports only a single</span>
<span class="cm">	 * contact, we have overlapping or adjacent fingers. For the</span>
<span class="cm">	 * purposes of creating a bounding box, divide the single contact</span>
<span class="cm">	 * (roughly) equally between the two points.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fingers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fingers_x</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">x_low</span><span class="p">.</span><span class="n">num_bits</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">x_low</span><span class="p">.</span><span class="n">num_bits</span> <span class="o">=</span> <span class="n">x_low</span><span class="p">.</span><span class="n">num_bits</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">x_high</span><span class="p">.</span><span class="n">start_bit</span> <span class="o">=</span> <span class="n">x_low</span><span class="p">.</span><span class="n">start_bit</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">x_high</span><span class="p">.</span><span class="n">num_bits</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fingers_y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">y_low</span><span class="p">.</span><span class="n">num_bits</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">y_low</span><span class="p">.</span><span class="n">num_bits</span> <span class="o">=</span> <span class="n">y_low</span><span class="p">.</span><span class="n">num_bits</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">y_high</span><span class="p">.</span><span class="n">start_bit</span> <span class="o">=</span> <span class="n">y_low</span><span class="p">.</span><span class="n">start_bit</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">y_high</span><span class="p">.</span><span class="n">num_bits</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">ALPS_V3_X_MAX</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x_low</span><span class="p">.</span><span class="n">start_bit</span> <span class="o">+</span> <span class="n">x_low</span><span class="p">.</span><span class="n">num_bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span>
	      <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ALPS_BITMAP_X_BITS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="o">*</span><span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="n">ALPS_V3_Y_MAX</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">y_low</span><span class="p">.</span><span class="n">start_bit</span> <span class="o">+</span> <span class="n">y_low</span><span class="p">.</span><span class="n">num_bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span>
	      <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ALPS_BITMAP_Y_BITS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fingers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ALPS_V3_X_MAX</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x_high</span><span class="p">.</span><span class="n">start_bit</span> <span class="o">+</span> <span class="n">x_high</span><span class="p">.</span><span class="n">num_bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span>
		      <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ALPS_BITMAP_X_BITS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="o">*</span><span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ALPS_V3_Y_MAX</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">y_high</span><span class="p">.</span><span class="n">start_bit</span> <span class="o">+</span> <span class="n">y_high</span><span class="p">.</span><span class="n">num_bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span>
		      <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ALPS_BITMAP_Y_BITS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fingers</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alps_set_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">bool</span> <span class="n">active</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">input_mt_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="n">input_mt_report_slot_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MT_TOOL_FINGER</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_MT_POSITION_X</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_MT_POSITION_Y</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alps_report_semi_mt_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_fingers</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">x1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">alps_set_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_fingers</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">);</span>
	<span class="n">alps_set_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_fingers</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alps_process_trackstick_packet_v3</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">middle</span><span class="p">;</span>

	<span class="cm">/* Sanity check packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Bad trackstick packet, discarding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * There&#39;s a special packet that seems to indicate the end</span>
<span class="cm">	 * of a stream of trackstick data. Filter these out.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7f</span> <span class="o">&amp;&amp;</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7f</span> <span class="o">&amp;&amp;</span> <span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7f</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)(((</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">));</span>
	<span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)(((</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">));</span>
	<span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The x and y values tend to be quite large, and when used</span>
<span class="cm">	 * alone the trackstick is difficult to use. Scale them down</span>
<span class="cm">	 * to compensate.</span>
<span class="cm">	 */</span>
	<span class="n">x</span> <span class="o">/=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">y</span> <span class="o">/=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_X</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_Y</span><span class="p">,</span> <span class="o">-</span><span class="n">y</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Most ALPS models report the trackstick buttons in the touchpad</span>
<span class="cm">	 * packets, but a few report them here. No reliable way has been</span>
<span class="cm">	 * found to differentiate between the models upfront, so we enable</span>
<span class="cm">	 * the quirk in response to seeing a button press in the trackstick</span>
<span class="cm">	 * packet.</span>
<span class="cm">	 */</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">right</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">middle</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">ALPS_QUIRK_TRACKSTICK_BUTTONS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">left</span> <span class="o">||</span> <span class="n">right</span> <span class="o">||</span> <span class="n">middle</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">|=</span> <span class="n">ALPS_QUIRK_TRACKSTICK_BUTTONS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">ALPS_QUIRK_TRACKSTICK_BUTTONS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">middle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alps_process_touchpad_packet_v3</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev2</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">middle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fingers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bmap_fingers</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x_bitmap</span><span class="p">,</span> <span class="n">y_bitmap</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * There&#39;s no single feature of touchpad position and bitmap packets</span>
<span class="cm">	 * that can be used to distinguish between them. We rely on the fact</span>
<span class="cm">	 * that a bitmap packet should always follow a position packet with</span>
<span class="cm">	 * bit 6 of packet[4] set.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_packet</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Sometimes a position packet will indicate a multi-packet</span>
<span class="cm">		 * sequence, but then what follows is another position</span>
<span class="cm">		 * packet. Check for this, and when it happens process the</span>
<span class="cm">		 * position packet as usual.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fingers</span> <span class="o">=</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">x_bitmap</span> <span class="o">=</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7e</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">y_bitmap</span> <span class="o">=</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				   <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>

			<span class="n">bmap_fingers</span> <span class="o">=</span> <span class="n">alps_process_bitmap</span><span class="p">(</span><span class="n">x_bitmap</span><span class="p">,</span> <span class="n">y_bitmap</span><span class="p">,</span>
							   <span class="o">&amp;</span><span class="n">x1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y2</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * We shouldn&#39;t report more than one finger if</span>
<span class="cm">			 * we don&#39;t have two coordinates.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fingers</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">bmap_fingers</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">fingers</span> <span class="o">=</span> <span class="n">bmap_fingers</span><span class="p">;</span>

			<span class="cm">/* Now process position packet */</span>
			<span class="n">packet</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_data</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_packet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bit 6 of byte 0 is not usually set in position packets. The only</span>
<span class="cm">	 * times it seems to be set is in situations where the data is</span>
<span class="cm">	 * suspect anyway, e.g. a palm resting flat on the touchpad. Given</span>
<span class="cm">	 * this combined with the fact that this bit is useful for filtering</span>
<span class="cm">	 * out misidentified bitmap packets, we reject anything with this</span>
<span class="cm">	 * bit set.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_packet</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_packet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_data</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_data</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_packet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">left</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">right</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">middle</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="n">z</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sometimes the hardware sends a single packet with z = 0</span>
<span class="cm">	 * in the middle of a stream. Real releases generate packets</span>
<span class="cm">	 * with x, y, and z all zero, so these seem to be flukes.</span>
<span class="cm">	 * Ignore them.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">z</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we don&#39;t have MT data or the bitmaps were empty, we have</span>
<span class="cm">	 * to rely on ST data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fingers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x1</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
		<span class="n">y1</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
		<span class="n">fingers</span> <span class="o">=</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">alps_report_semi_mt_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fingers</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">);</span>

	<span class="n">input_mt_report_finger_count</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fingers</span><span class="p">);</span>

	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">middle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>

	<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">ALPS_QUIRK_TRACKSTICK_BUTTONS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">middle</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">;</span>

		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev2</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev2</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev2</span><span class="p">,</span> <span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">middle</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">dev2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alps_process_packet_v3</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * v3 protocol packets come in three types, two representing</span>
<span class="cm">	 * touchpad data and one representing trackstick data.</span>
<span class="cm">	 * Trackstick packets seem to be distinguished by always</span>
<span class="cm">	 * having 0x3f in the last byte. This value has never been</span>
<span class="cm">	 * observed in the last byte of either of the other types</span>
<span class="cm">	 * of packets.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">alps_process_trackstick_packet_v3</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">alps_process_touchpad_packet_v3</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alps_process_packet_v4</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fingers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x_bitmap</span><span class="p">,</span> <span class="n">y_bitmap</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * v4 has a 6-byte encoding for bitmap data, but this data is</span>
<span class="cm">	 * broken up between 3 normal packets. Use priv-&gt;multi_packet to</span>
<span class="cm">	 * track our position in the bitmap packet.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* sync, reset position */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_packet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_packet</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_packet</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_data</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_data</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_packet</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_packet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">x_bitmap</span> <span class="o">=</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">y_bitmap</span> <span class="o">=</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">multi_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>

		<span class="n">fingers</span> <span class="o">=</span> <span class="n">alps_process_bitmap</span><span class="p">(</span><span class="n">x_bitmap</span><span class="p">,</span> <span class="n">y_bitmap</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">x1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y2</span><span class="p">);</span>

		<span class="cm">/* Store MT data.*/</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fingers</span> <span class="o">=</span> <span class="n">fingers</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">x2</span> <span class="o">=</span> <span class="n">x2</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">=</span> <span class="n">y1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">y2</span> <span class="o">=</span> <span class="n">y2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">left</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">right</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="n">z</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there were no contacts in the bitmap, use ST</span>
<span class="cm">	 * points in MT reports.</span>
<span class="cm">	 * If there were two contacts or more, report MT data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fingers</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x1</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
		<span class="n">y1</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
		<span class="n">fingers</span> <span class="o">=</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fingers</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fingers</span><span class="p">;</span>
		<span class="n">x1</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">;</span>
		<span class="n">x2</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">x2</span><span class="p">;</span>
		<span class="n">y1</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">y1</span><span class="p">;</span>
		<span class="n">y2</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">y2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">alps_report_semi_mt_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fingers</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">);</span>

	<span class="n">input_mt_report_finger_count</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fingers</span><span class="p">);</span>

	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>

	<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alps_process_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">alps_model_info</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ALPS_PROTO_V1</span>:
	<span class="k">case</span> <span class="n">ALPS_PROTO_V2</span>:
		<span class="n">alps_process_packet_v1_v2</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALPS_PROTO_V3</span>:
		<span class="n">alps_process_packet_v3</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALPS_PROTO_V4</span>:
		<span class="n">alps_process_packet_v4</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alps_report_bare_ps2_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">packet</span><span class="p">[],</span>
					<span class="n">bool</span> <span class="n">report_buttons</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev2</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">report_buttons</span><span class="p">)</span>
		<span class="n">alps_report_buttons</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">dev2</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev2</span><span class="p">,</span> <span class="n">REL_X</span><span class="p">,</span>
		<span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">?</span> <span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev2</span><span class="p">,</span> <span class="n">REL_Y</span><span class="p">,</span>
		<span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">?</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">-</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">input_sync</span><span class="p">(</span><span class="n">dev2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">psmouse_ret_t</span> <span class="nf">alps_handle_interleaved_ps2</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PSMOUSE_GOOD_DATA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Start a timer to flush the packet if it ends up last</span>
<span class="cm">		 * 6-byte packet in the stream. Timer needs to fire</span>
<span class="cm">		 * psmouse core times out itself. 20 ms should be enough</span>
<span class="cm">		 * to decide if we are getting more data or not.</span>
<span class="cm">		 */</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">PSMOUSE_GOOD_DATA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Highest bit is set - that means we either had</span>
<span class="cm">		 * complete ALPS packet and this is start of the</span>
<span class="cm">		 * next packet or we got garbage.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span>
		      <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span>
		      <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">alps_is_valid_first_byte</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">6</span><span class="p">])))</span> <span class="p">{</span>
			<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
				    <span class="s">&quot;refusing packet %x %x %x %x (suspected interleaved ps/2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
				    <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
			<span class="k">return</span> <span class="n">PSMOUSE_BAD_DATA</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">alps_process_packet</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

		<span class="cm">/* Continue with the next packet */</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * High bit is 0 - that means that we indeed got a PS/2</span>
<span class="cm">		 * packet in the middle of ALPS packet.</span>
<span class="cm">		 *</span>
<span class="cm">		 * There is also possibility that we got 6-byte ALPS</span>
<span class="cm">		 * packet followed  by 3-byte packet from trackpoint. We</span>
<span class="cm">		 * can not distinguish between these 2 scenarios but</span>
<span class="cm">		 * because the latter is unlikely to happen in course of</span>
<span class="cm">		 * normal operation (user would need to press all</span>
<span class="cm">		 * buttons on the pad and start moving trackpoint</span>
<span class="cm">		 * without touching the pad surface) we assume former.</span>
<span class="cm">		 * Even if we are wrong the wost thing that would happen</span>
<span class="cm">		 * the cursor would jump but we should not get protocol</span>
<span class="cm">		 * de-synchronization.</span>
<span class="cm">		 */</span>

		<span class="n">alps_report_bare_ps2_packet</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
					    <span class="nb">false</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Continue with the standard ALPS protocol handling,</span>
<span class="cm">		 * but make sure we won&#39;t process it as an interleaved</span>
<span class="cm">		 * packet again, which may happen if all buttons are</span>
<span class="cm">		 * pressed. To avoid this let&#39;s reset the 4th bit which</span>
<span class="cm">		 * is normally 1.</span>
<span class="cm">		 */</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf7</span><span class="p">;</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">PSMOUSE_GOOD_DATA</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alps_flush_packet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">serio_pause_rx</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">==</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * We did not any more data in reasonable amount of time.</span>
<span class="cm">		 * Validate the last 3 bytes and process as a standard</span>
<span class="cm">		 * ALPS packet.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span>
		     <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span>
		     <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
				    <span class="s">&quot;refusing packet %x %x %x (suspected interleaved ps/2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
				    <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">alps_process_packet</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">serio_continue_rx</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">psmouse_ret_t</span> <span class="nf">alps_process_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">alps_model_info</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* PS/2 packet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">alps_report_bare_ps2_packet</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">,</span>
						    <span class="nb">true</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">PSMOUSE_FULL_PACKET</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">PSMOUSE_GOOD_DATA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for PS/2 packet stuffed in the middle of ALPS packet. */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ALPS_PS2_INTERLEAVED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">alps_handle_interleaved_ps2</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alps_is_valid_first_byte</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
			    <span class="s">&quot;refusing packet[0] = %x (mask0 = %x, byte0 = %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">mask0</span><span class="p">,</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">byte0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PSMOUSE_BAD_DATA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Bytes 2 - pktsize should have 0 in the highest bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">&lt;=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;refusing packet[%i] = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			    <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">PSMOUSE_BAD_DATA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">==</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">alps_process_packet</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PSMOUSE_FULL_PACKET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">PSMOUSE_GOOD_DATA</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_command_mode_send_nibble</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nibble</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">command</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dummy</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">nibble</span> <span class="o">&gt;</span> <span class="mh">0xf</span><span class="p">);</span>

	<span class="n">command</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nibble_commands</span><span class="p">[</span><span class="n">nibble</span><span class="p">].</span><span class="n">command</span><span class="p">;</span>
	<span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="mh">0x0f00</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">dummy</span> <span class="o">:</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nibble_commands</span><span class="p">[</span><span class="n">nibble</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">command</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_command_mode_set_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nibble</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">addr_command</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nibble</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_send_nibble</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">nibble</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__alps_command_mode_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_GETINFO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The address being read is returned in the first two bytes</span>
<span class="cm">	 * of the result. Check that this address matches the expected</span>
<span class="cm">	 * address.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">!=</span> <span class="p">((</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_command_mode_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_set_addr</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__alps_command_mode_read_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__alps_command_mode_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_send_nibble</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_send_nibble</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_command_mode_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_set_addr</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_enter_command_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_RESET_WRAP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_RESET_WRAP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_RESET_WRAP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_GETINFO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;failed to enter command mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x88</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
			    <span class="s">&quot;unknown response while entering command mode: %2.2x %2.2x %2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">resp</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">alps_exit_command_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSTREAM</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">alps_model_info</span> <span class="o">*</span><span class="nf">alps_get_model</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">alps_model_info</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * First try &quot;E6 report&quot;.</span>
<span class="cm">	 * ALPS should return 0,0,10 or 0,0,100 if no buttons are pressed.</span>
<span class="cm">	 * The bits 0-2 of the first byte will be 1s if some buttons are</span>
<span class="cm">	 * pressed.</span>
<span class="cm">	 */</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE11</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE11</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE11</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_GETINFO</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;E6 report: %2.2x %2.2x %2.2x&quot;</span><span class="p">,</span>
		    <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">100</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now try &quot;E7 report&quot;. Allowed responses are in</span>
<span class="cm">	 * alps_model_data[].signature</span>
<span class="cm">	 */</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE21</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE21</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE21</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_GETINFO</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;E7 report: %2.2x %2.2x %2.2x&quot;</span><span class="p">,</span>
		    <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="cm">/* empty */</span><span class="p">;</span>
		<span class="o">*</span><span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">alps_model_data</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">alps_model_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">signature</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">alps_model_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">signature</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">model</span> <span class="o">=</span> <span class="n">alps_model_data</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">model</span> <span class="o">&amp;&amp;</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">proto_version</span> <span class="o">&gt;</span> <span class="n">ALPS_PROTO_V2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Need to check command mode response to identify</span>
<span class="cm">		 * model</span>
<span class="cm">		 */</span>
		<span class="n">model</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alps_enter_command_mode</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">param</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
				     <span class="s">&quot;touchpad failed to enter command mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">alps_model_data</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">alps_model_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">proto_version</span> <span class="o">&gt;</span> <span class="n">ALPS_PROTO_V2</span> <span class="o">&amp;&amp;</span>
				    <span class="n">alps_model_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">command_mode_resp</span> <span class="o">==</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">model</span> <span class="o">=</span> <span class="n">alps_model_data</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">alps_exit_command_mode</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">model</span><span class="p">)</span>
				<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
					    <span class="s">&quot;Unknown command mode response %2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">model</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * For DualPoint devices select the device that should respond to</span>
<span class="cm"> * subsequent commands. It looks like glidepad is behind stickpointer,</span>
<span class="cm"> * I&#39;d thought it would be other way around...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_passthrough_mode_v2</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">PSMOUSE_CMD_SETSCALE21</span> <span class="o">:</span> <span class="n">PSMOUSE_CMD_SETSCALE11</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* we may get 3 more bytes, just ignore them */</span>
	<span class="n">ps2_drain</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_absolute_mode_v1_v2</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>

	<span class="cm">/* Try ALPS magic knock - 4 disable before enable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_ENABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Switch mouse to poll (remote) mode so motion data will not</span>
<span class="cm">	 * get in our way</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETPOLL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>

	<span class="cm">/* Get status: 0xF5 0xF5 0xF5 0xE9 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_GETINFO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Status: %2.2x %2.2x %2.2x&quot;</span><span class="p">,</span>
		    <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Turn touchpad tapping on or off. The sequences are:</span>
<span class="cm"> * 0xE9 0xF5 0xF5 0xF3 0x0A to enable,</span>
<span class="cm"> * 0xE9 0xF5 0xF5 0xE8 0x00 to disable.</span>
<span class="cm"> * My guess that 0xE9 (GetInfo) is here as a sync point.</span>
<span class="cm"> * For models that also have stickpointer (DualPoints) its tapping</span>
<span class="cm"> * is controlled separately (0xE6 0xE6 0xE6 0xF3 0x14|0x0A) but</span>
<span class="cm"> * we don&#39;t fiddle with it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_tap_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">PSMOUSE_CMD_SETRATE</span> <span class="o">:</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tap_arg</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="mh">0x0A</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_GETINFO</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tap_arg</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_get_status</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">param</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * alps_poll() - poll the touchpad for current motion packet.</span>
<span class="cm"> * Used in resync.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">)];</span>
	<span class="n">bool</span> <span class="n">poll_failed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ALPS_PASS</span><span class="p">)</span>
		<span class="n">alps_passthrough_mode_v2</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">poll_failed</span> <span class="o">=</span> <span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
				  <span class="n">PSMOUSE_CMD_POLL</span> <span class="o">|</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ALPS_PASS</span><span class="p">)</span>
		<span class="n">alps_passthrough_mode_v2</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">poll_failed</span> <span class="o">||</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">mask0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">byte0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">badbyte</span> <span class="o">&amp;</span> <span class="mh">0xc8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm"> * Poll the track stick ...</span>
<span class="cm"> */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_POLL</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_hw_init_v1_v2</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">alps_model_info</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ALPS_PASS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">alps_passthrough_mode_v2</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_tap_mode</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Failed to enable hardware tapping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_absolute_mode_v1_v2</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Failed to enable absolute mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ALPS_PASS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">alps_passthrough_mode_v2</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ALPS needs stream mode, otherwise it won&#39;t report any data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSTREAM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Failed to enable stream mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enable or disable passthrough mode to the trackstick. Must be in</span>
<span class="cm"> * command mode when calling this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_passthrough_mode_v3</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">alps_command_mode_read_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">reg_val</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Must be in command mode when calling this function */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_absolute_mode_v3</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">alps_command_mode_read_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">reg_val</span> <span class="o">|=</span> <span class="mh">0x06</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_hw_init_v3</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg_val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nibble_commands</span> <span class="o">=</span> <span class="n">alps_v3_nibble_commands</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">addr_command</span> <span class="o">=</span> <span class="n">PSMOUSE_CMD_RESET_WRAP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_enter_command_mode</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Check for trackstick */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">alps_command_mode_read_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alps_passthrough_mode_v3</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alps_exit_command_mode</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * E7 report for the trackstick</span>
<span class="cm">		 *</span>
<span class="cm">		 * There have been reports of failures to seem to trace back</span>
<span class="cm">		 * to the above trackstick check failing. When these occur</span>
<span class="cm">		 * this E7 report fails, so when that happens we continue</span>
<span class="cm">		 * with the assumption that there isn&#39;t a trackstick after</span>
<span class="cm">		 * all.</span>
<span class="cm">		 */</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x64</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE21</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE21</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE21</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_GETINFO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;trackstick E7 report failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
				    <span class="s">&quot;trackstick E7 report: %2.2x %2.2x %2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Not sure what this does, but it is absolutely</span>
<span class="cm">			 * essential. Without it, the touchpad does not</span>
<span class="cm">			 * work at all and the trackstick just emits normal</span>
<span class="cm">			 * PS/2 packets.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE11</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE11</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE11</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">alps_command_mode_send_nibble</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">alps_command_mode_send_nibble</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
					    <span class="s">&quot;Error sending magic E6 sequence</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">error_passthrough</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">alps_enter_command_mode</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error_passthrough</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alps_passthrough_mode_v3</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_absolute_mode_v3</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Failed to enter absolute mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">alps_command_mode_read_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">reg_val</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">alps_command_mode_read_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">reg_val</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_read_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0144</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_read_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0159</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_read_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0163</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0163</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_read_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0162</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0162</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This ensures the trackstick packets are in the format</span>
<span class="cm">	 * supported by this driver. If bit 1 isn&#39;t set the packet</span>
<span class="cm">	 * format is different.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">alps_exit_command_mode</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="cm">/* Set rate and enable data reporting */</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x64</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_ENABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Failed to enable data reporting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_passthrough:</span>
	<span class="cm">/* Something failed while in passthrough mode, so try to get out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alps_enter_command_mode</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">alps_passthrough_mode_v3</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Leaving the touchpad in command mode will essentially render</span>
<span class="cm">	 * it unusable until the machine reboots, so exit it here just</span>
<span class="cm">	 * to be safe</span>
<span class="cm">	 */</span>
	<span class="n">alps_exit_command_mode</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Must be in command mode when calling this function */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_absolute_mode_v4</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">alps_command_mode_read_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_val</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">reg_val</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">reg_val</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_hw_init_v4</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nibble_commands</span> <span class="o">=</span> <span class="n">alps_v4_nibble_commands</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">addr_command</span> <span class="o">=</span> <span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_enter_command_mode</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_absolute_mode_v4</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Failed to enter absolute mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0149</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0160</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x017f</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0151</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0168</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x014a</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_command_mode_write_reg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mh">0x0161</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">alps_exit_command_mode</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This sequence changes the output from a 9-byte to an</span>
<span class="cm">	 * 8-byte format. All the same data seems to be present,</span>
<span class="cm">	 * just in a more compact format.</span>
<span class="cm">	 */</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xc8</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x64</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_GETID</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Set rate and enable data reporting */</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x64</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_ENABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Failed to enable data reporting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Leaving the touchpad in command mode will essentially render</span>
<span class="cm">	 * it unusable until the machine reboots, so exit it here just</span>
<span class="cm">	 * to be safe</span>
<span class="cm">	 */</span>
	<span class="n">alps_exit_command_mode</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">alps_model_info</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ALPS_PROTO_V1</span>:
	<span class="k">case</span> <span class="n">ALPS_PROTO_V2</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">alps_hw_init_v1_v2</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALPS_PROTO_V3</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">alps_hw_init_v3</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALPS_PROTO_V4</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">alps_hw_init_v4</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alps_reconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">alps_model_info</span> <span class="o">*</span><span class="n">model</span><span class="p">;</span>

	<span class="n">psmouse_reset</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="n">model</span> <span class="o">=</span> <span class="n">alps_get_model</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">model</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">alps_hw_init</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">alps_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">psmouse_reset</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev2</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">alps_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">alps_data</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">alps_model_info</span> <span class="o">*</span><span class="n">model</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev1</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">dev2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">version</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">alps_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">dev2</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_fail</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev2</span> <span class="o">=</span> <span class="n">dev2</span><span class="p">;</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">alps_flush_packet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">psmouse_reset</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="n">model</span> <span class="o">=</span> <span class="n">alps_get_model</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">version</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">model</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">init_fail</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">i</span> <span class="o">=</span> <span class="n">model</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alps_hw_init</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">init_fail</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Undo part of setup done for us by psmouse core since touchpad</span>
<span class="cm">	 * is not a relative device.</span>
<span class="cm">	 */</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">EV_REL</span><span class="p">,</span> <span class="n">dev1</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">REL_X</span><span class="p">,</span> <span class="n">dev1</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">REL_Y</span><span class="p">,</span> <span class="n">dev1</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now set up our capabilities.</span>
<span class="cm">	 */</span>
	<span class="n">dev1</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">);</span>
	<span class="n">dev1</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">)]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">);</span>
	<span class="n">dev1</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_TOOL_FINGER</span><span class="p">)]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_TOOL_FINGER</span><span class="p">);</span>
	<span class="n">dev1</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_LEFT</span><span class="p">)]</span> <span class="o">|=</span>
		<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_LEFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_RIGHT</span><span class="p">);</span>

	<span class="n">dev1</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">)]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">proto_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ALPS_PROTO_V1</span>:
	<span class="k">case</span> <span class="n">ALPS_PROTO_V2</span>:
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">dev1</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1023</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">dev1</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">767</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALPS_PROTO_V3</span>:
	<span class="k">case</span> <span class="n">ALPS_PROTO_V4</span>:
		<span class="n">set_bit</span><span class="p">(</span><span class="n">INPUT_PROP_SEMI_MT</span><span class="p">,</span> <span class="n">dev1</span><span class="o">-&gt;</span><span class="n">propbit</span><span class="p">);</span>
		<span class="n">input_mt_init_slots</span><span class="p">(</span><span class="n">dev1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">dev1</span><span class="p">,</span> <span class="n">ABS_MT_POSITION_X</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ALPS_V3_X_MAX</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">dev1</span><span class="p">,</span> <span class="n">ABS_MT_POSITION_Y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ALPS_V3_Y_MAX</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">BTN_TOOL_DOUBLETAP</span><span class="p">,</span> <span class="n">dev1</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BTN_TOOL_TRIPLETAP</span><span class="p">,</span> <span class="n">dev1</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">BTN_TOOL_QUADTAP</span><span class="p">,</span> <span class="n">dev1</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">dev1</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ALPS_V3_X_MAX</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">dev1</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ALPS_V3_Y_MAX</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">dev1</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ALPS_WHEEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev1</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">EV_REL</span><span class="p">)]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_REL</span><span class="p">);</span>
		<span class="n">dev1</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">REL_WHEEL</span><span class="p">)]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">REL_WHEEL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ALPS_FW_BK_1</span> <span class="o">|</span> <span class="n">ALPS_FW_BK_2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev1</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_FORWARD</span><span class="p">)]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_FORWARD</span><span class="p">);</span>
		<span class="n">dev1</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_BACK</span><span class="p">)]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_BACK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ALPS_FOUR_BUTTONS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev1</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_0</span><span class="p">)]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_0</span><span class="p">);</span>
		<span class="n">dev1</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_1</span><span class="p">)]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_1</span><span class="p">);</span>
		<span class="n">dev1</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_2</span><span class="p">)]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_2</span><span class="p">);</span>
		<span class="n">dev1</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_3</span><span class="p">)]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev1</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_MIDDLE</span><span class="p">)]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_MIDDLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">),</span> <span class="s">&quot;%s/input1&quot;</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">dev2</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">dev2</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ALPS_DUALPOINT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;DualPoint Stick&quot;</span> <span class="o">:</span> <span class="s">&quot;PS/2 Mouse&quot;</span><span class="p">;</span>
	<span class="n">dev2</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_I8042</span><span class="p">;</span>
	<span class="n">dev2</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span>  <span class="o">=</span> <span class="mh">0x0002</span><span class="p">;</span>
	<span class="n">dev2</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">PSMOUSE_ALPS</span><span class="p">;</span>
	<span class="n">dev2</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">dev2</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev2</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_REL</span><span class="p">);</span>
	<span class="n">dev2</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">REL_X</span><span class="p">)]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">REL_X</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">REL_Y</span><span class="p">);</span>
	<span class="n">dev2</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_LEFT</span><span class="p">)]</span> <span class="o">=</span>
		<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_LEFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_MIDDLE</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_RIGHT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">input_register_device</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev2</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">init_fail</span><span class="p">;</span>

	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">protocol_handler</span> <span class="o">=</span> <span class="n">alps_process_byte</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="n">alps_poll</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">alps_disconnect</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">reconnect</span> <span class="o">=</span> <span class="n">alps_reconnect</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span> <span class="o">=</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">proto_version</span> <span class="o">==</span> <span class="n">ALPS_PROTO_V4</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>

	<span class="cm">/* We are having trouble resyncing ALPS touchpads so disable it for now */</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resync_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">init_fail:</span>
	<span class="n">psmouse_reset</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">dev2</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">alps_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set_properties</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">version</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">alps_model_info</span> <span class="o">*</span><span class="n">model</span><span class="p">;</span>

	<span class="n">model</span> <span class="o">=</span> <span class="n">alps_get_model</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">version</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">model</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_properties</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="s">&quot;ALPS&quot;</span><span class="p">;</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ALPS_DUALPOINT</span> <span class="o">?</span>
				<span class="s">&quot;DualPoint TouchPad&quot;</span> <span class="o">:</span> <span class="s">&quot;GlidePoint&quot;</span><span class="p">;</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">version</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
