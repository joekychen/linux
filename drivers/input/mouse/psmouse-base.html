<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › mouse › psmouse-base.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>psmouse-base.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * PS/2 mouse driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 1999-2002 Vojtech Pavlik</span>
<span class="cm"> * Copyright (c) 2003-2004 Dmitry Torokhov</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt)		KBUILD_MODNAME &quot;: &quot; fmt</span>
<span class="cp">#define psmouse_fmt(fmt)	fmt</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/serio.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/libps2.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &quot;psmouse.h&quot;</span>
<span class="cp">#include &quot;synaptics.h&quot;</span>
<span class="cp">#include &quot;logips2pp.h&quot;</span>
<span class="cp">#include &quot;alps.h&quot;</span>
<span class="cp">#include &quot;hgpk.h&quot;</span>
<span class="cp">#include &quot;lifebook.h&quot;</span>
<span class="cp">#include &quot;trackpoint.h&quot;</span>
<span class="cp">#include &quot;touchkit_ps2.h&quot;</span>
<span class="cp">#include &quot;elantech.h&quot;</span>
<span class="cp">#include &quot;sentelic.h&quot;</span>

<span class="cp">#define DRIVER_DESC	&quot;PS/2 mouse driver&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Vojtech Pavlik &lt;vojtech@suse.cz&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">psmouse_max_proto</span> <span class="o">=</span> <span class="n">PSMOUSE_AUTO</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">psmouse_set_maxproto</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">psmouse_get_maxproto</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kernel_param_ops</span> <span class="n">param_ops_proto_abbrev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="n">psmouse_set_maxproto</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">psmouse_get_maxproto</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#define param_check_proto_abbrev(name, p)	__param_check(name, p, unsigned int)</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">psmouse_max_proto</span><span class="p">,</span> <span class="n">proto_abbrev</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="s">&quot;Highest protocol extension to probe (bare, imps, exps, any). Useful for KVM switches.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">psmouse_resolution</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">psmouse_resolution</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="s">&quot;Resolution, in dpi.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">psmouse_rate</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">psmouse_rate</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="s">&quot;Report rate, in reports per second.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">psmouse_smartscroll</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">smartscroll</span><span class="p">,</span> <span class="n">psmouse_smartscroll</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">smartscroll</span><span class="p">,</span> <span class="s">&quot;Logitech Smartscroll autorepeat, 1 = enabled (default), 0 = disabled.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">psmouse_resetafter</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">resetafter</span><span class="p">,</span> <span class="n">psmouse_resetafter</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">resetafter</span><span class="p">,</span> <span class="s">&quot;Reset device after so many bad packets (0 = never).&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">psmouse_resync_time</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">resync_time</span><span class="p">,</span> <span class="n">psmouse_resync_time</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">resync_time</span><span class="p">,</span> <span class="s">&quot;How long can mouse stay idle before forcing resync (in seconds, 0 = never).&quot;</span><span class="p">);</span>

<span class="n">PSMOUSE_DEFINE_ATTR</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span>
			<span class="n">psmouse_attr_show_protocol</span><span class="p">,</span> <span class="n">psmouse_attr_set_protocol</span><span class="p">);</span>
<span class="n">PSMOUSE_DEFINE_ATTR</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span><span class="p">,</span> <span class="n">rate</span><span class="p">),</span>
			<span class="n">psmouse_show_int_attr</span><span class="p">,</span> <span class="n">psmouse_attr_set_rate</span><span class="p">);</span>
<span class="n">PSMOUSE_DEFINE_ATTR</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span><span class="p">,</span> <span class="n">resolution</span><span class="p">),</span>
			<span class="n">psmouse_show_int_attr</span><span class="p">,</span> <span class="n">psmouse_attr_set_resolution</span><span class="p">);</span>
<span class="n">PSMOUSE_DEFINE_ATTR</span><span class="p">(</span><span class="n">resetafter</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span><span class="p">,</span> <span class="n">resetafter</span><span class="p">),</span>
			<span class="n">psmouse_show_int_attr</span><span class="p">,</span> <span class="n">psmouse_set_int_attr</span><span class="p">);</span>
<span class="n">PSMOUSE_DEFINE_ATTR</span><span class="p">(</span><span class="n">resync_time</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span><span class="p">,</span> <span class="n">resync_time</span><span class="p">),</span>
			<span class="n">psmouse_show_int_attr</span><span class="p">,</span> <span class="n">psmouse_set_int_attr</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">psmouse_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">psmouse_attr_protocol</span><span class="p">.</span><span class="n">dattr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">psmouse_attr_rate</span><span class="p">.</span><span class="n">dattr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">psmouse_attr_resolution</span><span class="p">.</span><span class="n">dattr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">psmouse_attr_resetafter</span><span class="p">.</span><span class="n">dattr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">psmouse_attr_resync_time</span><span class="p">.</span><span class="n">dattr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">psmouse_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span>	<span class="o">=</span> <span class="n">psmouse_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * psmouse_mutex protects all operations changing state of mouse</span>
<span class="cm"> * (connecting, disconnecting, changing rate or resolution via</span>
<span class="cm"> * sysfs). We could use a per-device semaphore but since there</span>
<span class="cm"> * rarely more than one PS/2 mouse connected and since semaphore</span>
<span class="cm"> * is taken in &quot;slow&quot; paths it is not worth it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">psmouse_mutex</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">kpsmoused_wq</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">psmouse_protocol</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">psmouse_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">maxproto</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ignore_parity</span><span class="p">;</span> <span class="cm">/* Protocol should ignore parity errors from KBC */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">detect</span><span class="p">)(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="p">,</span> <span class="n">bool</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * psmouse_process_byte() analyzes the PS/2 data stream and reports</span>
<span class="cm"> * relevant events to the input module once full packet has arrived.</span>
<span class="cm"> */</span>

<span class="n">psmouse_ret_t</span> <span class="nf">psmouse_process_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">&lt;</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PSMOUSE_GOOD_DATA</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Full packet accumulated, process it</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Scroll wheel on IntelliMice, scroll buttons on NetMice</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PSMOUSE_IMPS</span> <span class="o">||</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PSMOUSE_GENPS</span><span class="p">)</span>
		<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_WHEEL</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="kt">signed</span> <span class="kt">char</span><span class="p">)</span> <span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

<span class="cm">/*</span>
<span class="cm"> * Scroll wheel and buttons on IntelliMouse Explorer</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PSMOUSE_IMEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x80</span>: <span class="cm">/* vertical scroll on IntelliMouse Explorer 4.0 */</span>
			<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_WHEEL</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x40</span>: <span class="cm">/* horizontal scroll on IntelliMouse Explorer 4.0 */</span>
			<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_HWHEEL</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
		<span class="k">case</span> <span class="mh">0xC0</span>:
			<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_WHEEL</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_SIDE</span><span class="p">,</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_EXTRA</span><span class="p">,</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Extra buttons on Genius NewNet 3D</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PSMOUSE_GENPS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_SIDE</span><span class="p">,</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_EXTRA</span><span class="p">,</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Extra button on ThinkingMouse</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PSMOUSE_THINKPS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_EXTRA</span><span class="p">,</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Without this bit of weirdness moving up gives wildly high Y changes. */</span>
		<span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cortron PS2 Trackball reports SIDE button on the 4th bit of the first</span>
<span class="cm"> * byte.</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PSMOUSE_CORTRON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_SIDE</span><span class="p">,</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Generic PS/2 Mouse</span>
<span class="cm"> */</span>

	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span>    <span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>       <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span>  <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_X</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">?</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_Y</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">?</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PSMOUSE_FULL_PACKET</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">psmouse_queue_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">work</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">kpsmoused_wq</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * __psmouse_set_state() sets new psmouse state and resets all flags.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__psmouse_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="k">enum</span> <span class="n">psmouse_state</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">out_of_sync_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * psmouse_set_state() sets new psmouse state and resets all flags and</span>
<span class="cm"> * counters while holding serio lock so fighting with interrupt handler</span>
<span class="cm"> * is not a concern.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">psmouse_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="k">enum</span> <span class="n">psmouse_state</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">serio_pause_rx</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">);</span>
	<span class="n">__psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">new_state</span><span class="p">);</span>
	<span class="n">serio_continue_rx</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * psmouse_handle_byte() processes one byte of the input data stream</span>
<span class="cm"> * by calling corresponding protocol handler.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">psmouse_handle_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">psmouse_ret_t</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">protocol_handler</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PSMOUSE_BAD_DATA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">PSMOUSE_ACTIVATED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
				     <span class="s">&quot;%s at %s lost sync at byte %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span>
				     <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">out_of_sync_cnt</span> <span class="o">==</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resetafter</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">__psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_IGNORE</span><span class="p">);</span>
				<span class="n">psmouse_notice</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
						<span class="s">&quot;issuing reconnect request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">serio_reconnect</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PSMOUSE_FULL_PACKET</span>:
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">out_of_sync_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">out_of_sync_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">psmouse_notice</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
					<span class="s">&quot;%s at %s - driver resynced.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PSMOUSE_GOOD_DATA</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * psmouse_interrupt() handles incoming characters, either passing them</span>
<span class="cm"> * for normal processing or gathering them as command response.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">psmouse_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">PSMOUSE_IGNORE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SERIO_TIMEOUT</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SERIO_PARITY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ignore_parity</span><span class="p">)))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">PSMOUSE_ACTIVATED</span><span class="p">)</span>
			<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
				     <span class="s">&quot;bad data from KBC -%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SERIO_TIMEOUT</span> <span class="o">?</span> <span class="s">&quot; timeout&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				     <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SERIO_PARITY</span> <span class="o">?</span> <span class="s">&quot; bad parity&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">ps2_cmd_aborted</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PS2_FLAG_ACK</span><span class="p">))</span>
		<span class="k">if</span>  <span class="p">(</span><span class="n">ps2_handle_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PS2_FLAG_CMD</span><span class="p">))</span>
		<span class="k">if</span>  <span class="p">(</span><span class="n">ps2_handle_response</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;=</span> <span class="n">PSMOUSE_RESYNCING</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">PSMOUSE_ACTIVATED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_info</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;%s at %s lost synchronization, throwing %d bytes away.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span><span class="p">);</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">badbyte</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">__psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_RESYNCING</span><span class="p">);</span>
		<span class="n">psmouse_queue_work</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resync_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Check if this is a new device announcement (0xAA 0x00)</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">PSMOUSE_RET_BAT</span> <span class="o">&amp;&amp;</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">PSMOUSE_RET_ID</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PSMOUSE_HGPK</span> <span class="o">&amp;&amp;</span>
		     <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">PSMOUSE_RET_BAT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">__psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_IGNORE</span><span class="p">);</span>
			<span class="n">serio_reconnect</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Not a new device, try processing first byte normally</span>
<span class="cm"> */</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_handle_byte</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * See if we need to force resync because mouse was idle for too long</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">PSMOUSE_ACTIVATED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resync_time</span> <span class="o">&amp;&amp;</span>
	    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">+</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resync_time</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">badbyte</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">__psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_RESYNCING</span><span class="p">);</span>
		<span class="n">psmouse_queue_work</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resync_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">psmouse_handle_byte</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * psmouse_sliced_command() sends an extended PS/2 command to the mouse</span>
<span class="cm"> * using sliced syntax, understood by advanced devices, such as Logitech</span>
<span class="cm"> * or Synaptics touchpads. The command is encoded as:</span>
<span class="cm"> * 0xE6 0xE8 rr 0xE8 ss 0xE8 tt 0xE8 uu where (rr*64)+(ss*16)+(tt*4)+uu</span>
<span class="cm"> * is the command.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">psmouse_sliced_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE11</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">command</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * psmouse_reset() resets the mouse into power-on state.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">psmouse_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_RESET_BAT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">PSMOUSE_RET_BAT</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">PSMOUSE_RET_ID</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Here we set the mouse resolution.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">psmouse_set_resolution</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">resolution</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">params</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resolution</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">resolution</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">)</span>
		<span class="n">resolution</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">resolution</span> <span class="o">/</span> <span class="mi">50</span><span class="p">];</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">);</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resolution</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">&lt;&lt;</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Here we set the mouse report rate.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psmouse_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rate</span><span class="p">)</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">);</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * psmouse_poll() - default poll handler. Everyone except for ALPS uses it.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">psmouse_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">,</span>
			   <span class="n">PSMOUSE_CMD_POLL</span> <span class="o">|</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Genius NetMouse magic init.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">genius_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set_properties</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">);</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE11</span><span class="p">);</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE11</span><span class="p">);</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE11</span><span class="p">);</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_GETINFO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span> <span class="o">||</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x33</span> <span class="o">||</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x55</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_properties</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_EXTRA</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_SIDE</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">REL_WHEEL</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>

		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="s">&quot;Genius&quot;</span><span class="p">;</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Mouse&quot;</span><span class="p">;</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IntelliMouse magic init.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">intellimouse_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set_properties</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">);</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">);</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">80</span><span class="p">;</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">);</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_GETID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_properties</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">REL_WHEEL</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">)</span>
			<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="s">&quot;Generic&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
			<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Wheel Mouse&quot;</span><span class="p">;</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try IntelliMouse/Explorer magic init.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">im_explorer_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set_properties</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">intellimouse_detect</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">);</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">);</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">80</span><span class="p">;</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">);</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_GETID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/* Magic to enable horizontal scrolling on IntelliMouse 4.0 */</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">);</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">80</span><span class="p">;</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">);</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">40</span><span class="p">;</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_properties</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">REL_WHEEL</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">REL_HWHEEL</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_SIDE</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_EXTRA</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">)</span>
			<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="s">&quot;Generic&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
			<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Explorer Mouse&quot;</span><span class="p">;</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Kensington ThinkingMouse / ExpertMouse magic init.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">thinking_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set_properties</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">seq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">);</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_GETID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_properties</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_EXTRA</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="s">&quot;Kensington&quot;</span><span class="p">;</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ThinkingMouse&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Bare PS/2 protocol &quot;detection&quot;. Always succeeds.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps2bare_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set_properties</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_properties</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">)</span>
			<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="s">&quot;Generic&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
			<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Mouse&quot;</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * We have no way of figuring true number of buttons so let&#39;s</span>
<span class="cm"> * assume that the device has 3.</span>
<span class="cm"> */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cortron PS/2 protocol detection. There&#39;s no special way to detect it, so it</span>
<span class="cm"> * must be forced by sysfs protocol writing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cortron_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set_properties</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_properties</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="s">&quot;Cortron&quot;</span><span class="p">;</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PS/2 Trackball&quot;</span><span class="p">;</span>

		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_SIDE</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Apply default settings to the psmouse structure. Most of them will</span>
<span class="cm"> * be overridden by individual protocol initialization routines.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psmouse_apply_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">mscbit</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">mscbit</span><span class="p">));</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_REL</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">REL_X</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">REL_Y</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>

	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">set_rate</span> <span class="o">=</span> <span class="n">psmouse_set_rate</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">set_resolution</span> <span class="o">=</span> <span class="n">psmouse_set_resolution</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="n">psmouse_poll</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">protocol_handler</span> <span class="o">=</span> <span class="n">psmouse_process_byte</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">reconnect</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">disconnect</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">cleanup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pt_activate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pt_deactivate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Apply default settings to the psmouse structure and call specified</span>
<span class="cm"> * protocol detection or initialization routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">psmouse_do_detect</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">detect</span><span class="p">)(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span>
					   <span class="n">bool</span> <span class="n">set_properties</span><span class="p">),</span>
			     <span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set_properties</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_properties</span><span class="p">)</span>
		<span class="n">psmouse_apply_defaults</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">detect</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">set_properties</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * psmouse_extensions() probes for any extensions to the basic PS/2 protocol</span>
<span class="cm"> * the mouse may have.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">psmouse_extensions</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_proto</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set_properties</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">synaptics_hardware</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * We always check for lifebook because it does not disturb mouse</span>
<span class="cm"> * (it only checks DMI information).</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_do_detect</span><span class="p">(</span><span class="n">lifebook_detect</span><span class="p">,</span> <span class="n">psmouse</span><span class="p">,</span> <span class="n">set_properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_proto</span> <span class="o">&gt;</span> <span class="n">PSMOUSE_IMEX</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_properties</span> <span class="o">||</span> <span class="n">lifebook_init</span><span class="p">(</span><span class="n">psmouse</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">PSMOUSE_LIFEBOOK</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try Kensington ThinkingMouse (we try first, because synaptics probe</span>
<span class="cm"> * upsets the thinkingmouse).</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_proto</span> <span class="o">&gt;</span> <span class="n">PSMOUSE_IMEX</span> <span class="o">&amp;&amp;</span>
	    <span class="n">psmouse_do_detect</span><span class="p">(</span><span class="n">thinking_detect</span><span class="p">,</span> <span class="n">psmouse</span><span class="p">,</span> <span class="n">set_properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">PSMOUSE_THINKPS</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try Synaptics TouchPad. Note that probing is done even if Synaptics protocol</span>
<span class="cm"> * support is disabled in config - we need to know if it is synaptics so we</span>
<span class="cm"> * can reset it properly after probing for intellimouse.</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_proto</span> <span class="o">&gt;</span> <span class="n">PSMOUSE_PS2</span> <span class="o">&amp;&amp;</span>
	    <span class="n">psmouse_do_detect</span><span class="p">(</span><span class="n">synaptics_detect</span><span class="p">,</span> <span class="n">psmouse</span><span class="p">,</span> <span class="n">set_properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synaptics_hardware</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max_proto</span> <span class="o">&gt;</span> <span class="n">PSMOUSE_IMEX</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm"> * Try activating protocol, but check if support is enabled first, since</span>
<span class="cm"> * we try detecting Synaptics even when protocol is disabled.</span>
<span class="cm"> */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_supported</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="o">!</span><span class="n">set_properties</span> <span class="o">||</span> <span class="n">synaptics_init</span><span class="p">(</span><span class="n">psmouse</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="n">PSMOUSE_SYNAPTICS</span><span class="p">;</span>
			<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Some Synaptics touchpads can emulate extended protocols (like IMPS/2).</span>
<span class="cm"> * Unfortunately Logitech/Genius probes confuse some firmware versions so</span>
<span class="cm"> * we&#39;ll have to skip them.</span>
<span class="cm"> */</span>
			<span class="n">max_proto</span> <span class="o">=</span> <span class="n">PSMOUSE_IMEX</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Make sure that touchpad is in relative mode, gestures (taps) are enabled</span>
<span class="cm"> */</span>
		<span class="n">synaptics_reset</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try ALPS TouchPad</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_proto</span> <span class="o">&gt;</span> <span class="n">PSMOUSE_IMEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_RESET_DIS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_do_detect</span><span class="p">(</span><span class="n">alps_detect</span><span class="p">,</span>
				      <span class="n">psmouse</span><span class="p">,</span> <span class="n">set_properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_properties</span> <span class="o">||</span> <span class="n">alps_init</span><span class="p">(</span><span class="n">psmouse</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">PSMOUSE_ALPS</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Init failed, try basic relative protocols</span>
<span class="cm"> */</span>
			<span class="n">max_proto</span> <span class="o">=</span> <span class="n">PSMOUSE_IMEX</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try OLPC HGPK touchpad.</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_proto</span> <span class="o">&gt;</span> <span class="n">PSMOUSE_IMEX</span> <span class="o">&amp;&amp;</span>
	    <span class="n">psmouse_do_detect</span><span class="p">(</span><span class="n">hgpk_detect</span><span class="p">,</span> <span class="n">psmouse</span><span class="p">,</span> <span class="n">set_properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_properties</span> <span class="o">||</span> <span class="n">hgpk_init</span><span class="p">(</span><span class="n">psmouse</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">PSMOUSE_HGPK</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Init failed, try basic relative protocols</span>
<span class="cm"> */</span>
		<span class="n">max_proto</span> <span class="o">=</span> <span class="n">PSMOUSE_IMEX</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try Elantech touchpad.</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_proto</span> <span class="o">&gt;</span> <span class="n">PSMOUSE_IMEX</span> <span class="o">&amp;&amp;</span>
	    <span class="n">psmouse_do_detect</span><span class="p">(</span><span class="n">elantech_detect</span><span class="p">,</span> <span class="n">psmouse</span><span class="p">,</span> <span class="n">set_properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_properties</span> <span class="o">||</span> <span class="n">elantech_init</span><span class="p">(</span><span class="n">psmouse</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">PSMOUSE_ELANTECH</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Init failed, try basic relative protocols</span>
<span class="cm"> */</span>
		<span class="n">max_proto</span> <span class="o">=</span> <span class="n">PSMOUSE_IMEX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_proto</span> <span class="o">&gt;</span> <span class="n">PSMOUSE_IMEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_do_detect</span><span class="p">(</span><span class="n">genius_detect</span><span class="p">,</span>
				      <span class="n">psmouse</span><span class="p">,</span> <span class="n">set_properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">PSMOUSE_GENPS</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_do_detect</span><span class="p">(</span><span class="n">ps2pp_init</span><span class="p">,</span>
				      <span class="n">psmouse</span><span class="p">,</span> <span class="n">set_properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">PSMOUSE_PS2PP</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_do_detect</span><span class="p">(</span><span class="n">trackpoint_detect</span><span class="p">,</span>
				      <span class="n">psmouse</span><span class="p">,</span> <span class="n">set_properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">PSMOUSE_TRACKPOINT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_do_detect</span><span class="p">(</span><span class="n">touchkit_ps2_detect</span><span class="p">,</span>
				      <span class="n">psmouse</span><span class="p">,</span> <span class="n">set_properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">PSMOUSE_TOUCHKIT_PS2</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try Finger Sensing Pad. We do it here because its probe upsets</span>
<span class="cm"> * Trackpoint devices (causing TP_READ_ID command to time out).</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_proto</span> <span class="o">&gt;</span> <span class="n">PSMOUSE_IMEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_do_detect</span><span class="p">(</span><span class="n">fsp_detect</span><span class="p">,</span>
				      <span class="n">psmouse</span><span class="p">,</span> <span class="n">set_properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_properties</span> <span class="o">||</span> <span class="n">fsp_init</span><span class="p">(</span><span class="n">psmouse</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">PSMOUSE_FSP</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Init failed, try basic relative protocols</span>
<span class="cm"> */</span>
			<span class="n">max_proto</span> <span class="o">=</span> <span class="n">PSMOUSE_IMEX</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset to defaults in case the device got confused by extended</span>
<span class="cm"> * protocol probes. Note that we follow up with full reset because</span>
<span class="cm"> * some mice put themselves to sleep when they see PSMOUSE_RESET_DIS.</span>
<span class="cm"> */</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_RESET_DIS</span><span class="p">);</span>
	<span class="n">psmouse_reset</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_proto</span> <span class="o">&gt;=</span> <span class="n">PSMOUSE_IMEX</span> <span class="o">&amp;&amp;</span>
	    <span class="n">psmouse_do_detect</span><span class="p">(</span><span class="n">im_explorer_detect</span><span class="p">,</span>
			      <span class="n">psmouse</span><span class="p">,</span> <span class="n">set_properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">PSMOUSE_IMEX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_proto</span> <span class="o">&gt;=</span> <span class="n">PSMOUSE_IMPS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">psmouse_do_detect</span><span class="p">(</span><span class="n">intellimouse_detect</span><span class="p">,</span>
			      <span class="n">psmouse</span><span class="p">,</span> <span class="n">set_properties</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">PSMOUSE_IMPS</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Okay, all failed, we have a standard mouse here. The number of the buttons</span>
<span class="cm"> * is still a question, though. We assume 3.</span>
<span class="cm"> */</span>
	<span class="n">psmouse_do_detect</span><span class="p">(</span><span class="n">ps2bare_detect</span><span class="p">,</span> <span class="n">psmouse</span><span class="p">,</span> <span class="n">set_properties</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_hardware</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm"> * We detected Synaptics hardware but it did not respond to IMPS/2 probes.</span>
<span class="cm"> * We need to reset the touchpad because if there is a track point on the</span>
<span class="cm"> * pass through port it could get disabled while probing for protocol</span>
<span class="cm"> * extensions.</span>
<span class="cm"> */</span>
		<span class="n">psmouse_reset</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">PSMOUSE_PS2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">psmouse_protocol</span> <span class="n">psmouse_protocols</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_PS2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;PS/2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;bare&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxproto</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ignore_parity</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">ps2bare_detect</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#ifdef CONFIG_MOUSE_PS2_LOGIPS2PP</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_PS2PP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;PS2++&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;logitech&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">ps2pp_init</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_THINKPS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ThinkPS/2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;thinkps&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">thinking_detect</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_GENPS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;GenPS/2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;genius&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">genius_detect</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_IMPS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ImPS/2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;imps&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxproto</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ignore_parity</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">intellimouse_detect</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_IMEX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ImExPS/2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;exps&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxproto</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ignore_parity</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">im_explorer_detect</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#ifdef CONFIG_MOUSE_PS2_SYNAPTICS</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_SYNAPTICS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;SynPS/2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;synaptics&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">synaptics_detect</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">synaptics_init</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_SYNAPTICS_RELATIVE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;SynRelPS/2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;synaptics-relative&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">synaptics_detect</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">synaptics_init_relative</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MOUSE_PS2_ALPS</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_ALPS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;AlpsPS/2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;alps&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">alps_detect</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">alps_init</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MOUSE_PS2_LIFEBOOK</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_LIFEBOOK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;LBPS/2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;lifebook&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">lifebook_init</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MOUSE_PS2_TRACKPOINT</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_TRACKPOINT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;TPPS/2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;trackpoint&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">trackpoint_detect</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MOUSE_PS2_TOUCHKIT</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_TOUCHKIT_PS2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;touchkitPS/2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;touchkit&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">touchkit_ps2_detect</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MOUSE_PS2_OLPC</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_HGPK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;OLPC HGPK&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;hgpk&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">hgpk_detect</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MOUSE_PS2_ELANTECH</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_ELANTECH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ETPS/2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;elantech&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">elantech_detect</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">elantech_init</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MOUSE_PS2_SENTELIC</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_FSP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;FSPPS/2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;fsp&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">fsp_detect</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">fsp_init</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_CORTRON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;CortronPS/2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;cortps&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">detect</span>		<span class="o">=</span> <span class="n">cortron_detect</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">PSMOUSE_AUTO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;auto&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alias</span>		<span class="o">=</span> <span class="s">&quot;any&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maxproto</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">psmouse_protocol</span> <span class="o">*</span><span class="nf">psmouse_protocol_by_type</span><span class="p">(</span><span class="k">enum</span> <span class="n">psmouse_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">psmouse_protocols</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_protocols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">psmouse_protocols</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">psmouse_protocols</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">psmouse_protocol</span> <span class="o">*</span><span class="nf">psmouse_protocol_by_name</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psmouse_protocol</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">psmouse_protocols</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse_protocols</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">alias</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">alias</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">psmouse_protocols</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * psmouse_probe() probes for a PS/2 mouse.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">psmouse_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * First, we check if it&#39;s a mouse. It should send 0x00 or 0x03</span>
<span class="cm"> * in case of an IntelliMouse in 4-byte mode or 0x04 for IM Explorer.</span>
<span class="cm"> * Sunrex K8561 IR Keyboard/Mouse reports 0xff on second and subsequent</span>
<span class="cm"> * ID queries, probably due to a firmware bug.</span>
<span class="cm"> */</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_GETID</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x03</span> <span class="o">&amp;&amp;</span>
	    <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x04</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Then we reset and disable the mouse so that it doesn&#39;t generate events.</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_RESET_DIS</span><span class="p">))</span>
		<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Failed to reset mouse on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">ps2dev</span><span class="o">-&gt;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * psmouse_initialize() initializes the mouse to a sane state.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psmouse_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*</span>
<span class="cm"> * We set the mouse report rate, resolution and scaling.</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_max_proto</span> <span class="o">!=</span> <span class="n">PSMOUSE_PS2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">set_rate</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">set_resolution</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resolution</span><span class="p">);</span>
		<span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETSCALE11</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * psmouse_activate() enables the mouse so that we get motion reports from it.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">psmouse_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_ENABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Failed to enable mouse on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_ACTIVATED</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * psmouse_deactivate() puts the mouse into poll mode so that we don&#39;t get motion</span>
<span class="cm"> * reports from it unless we explicitly request it.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">psmouse_deactivate</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Failed to deactivate mouse on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_MODE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * psmouse_resync() attempts to re-validate current protocol.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psmouse_resync</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">psmouse</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">psmouse</span><span class="p">,</span> <span class="n">resync_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">;</span>
	<span class="n">psmouse_ret_t</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">PSMOUSE_GOOD_DATA</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">failed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">PSMOUSE_RESYNCING</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SERIO_PS_PSTHRU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
		<span class="n">psmouse_deactivate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Some mice don&#39;t ACK commands sent while they are in the middle of</span>
<span class="cm"> * transmitting motion packet. To avoid delay we use ps2_sendbyte()</span>
<span class="cm"> * instead of ps2_command() which would wait for 200ms for an ACK</span>
<span class="cm"> * that may never come.</span>
<span class="cm"> * As an additional quirk ALPS touchpads may not only forget to ACK</span>
<span class="cm"> * disable command but will stop reporting taps, so if we see that</span>
<span class="cm"> * mouse at least once ACKs disable we will do full reconnect if ACK</span>
<span class="cm"> * is missing.</span>
<span class="cm"> */</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">num_resyncs</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_sendbyte</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">num_resyncs</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">acks_disable_command</span><span class="p">)</span>
			<span class="n">failed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">acks_disable_command</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Poll the mouse. If it was reset the packet will be shorter than</span>
<span class="cm"> * psmouse-&gt;pktsize and ps2_command will fail. We do not expect and</span>
<span class="cm"> * do not handle scenario when mouse &quot;upgrades&quot; its protocol while</span>
<span class="cm"> * disconnected since it would require additional delay. If we ever</span>
<span class="cm"> * see a mouse that does it we&#39;ll adjust the code.</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">failed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span>
			<span class="n">failed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_MODE</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span><span class="o">++</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">protocol_handler</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">PSMOUSE_GOOD_DATA</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">PSMOUSE_FULL_PACKET</span><span class="p">)</span>
				<span class="n">failed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_RESYNCING</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Now try to enable mouse. We try to do that even if poll failed and also</span>
<span class="cm"> * repeat our attempts 5 times, otherwise we may be left out with disabled</span>
<span class="cm"> * mouse.</span>
<span class="cm"> */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_ENABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;failed to re-enable mouse on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">failed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">failed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_IGNORE</span><span class="p">);</span>
		<span class="n">psmouse_info</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
			     <span class="s">&quot;resync failed, issuing reconnect request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">serio_reconnect</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_ACTIVATED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">psmouse_activate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * psmouse_cleanup() resets the mouse into power-on state.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psmouse_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SERIO_PS_PSTHRU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
		<span class="n">psmouse_deactivate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_INITIALIZING</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable stream mode so cleanup routine can proceed undisturbed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_DISABLE</span><span class="p">))</span>
		<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Failed to disable mouse on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">)</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the mouse to defaults (bare PS/2 protocol).</span>
<span class="cm"> */</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_RESET_DIS</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Some boxes, such as HP nx7400, get terribly confused if mouse</span>
<span class="cm"> * is not fully enabled before suspending/shutting down.</span>
<span class="cm"> */</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_ENABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">pt_deactivate</span><span class="p">)</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">pt_deactivate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

		<span class="n">psmouse_activate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * psmouse_disconnect() closes and frees.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psmouse_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">psmouse</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>

	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psmouse_attribute_group</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_mutex</span><span class="p">);</span>

	<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_MODE</span><span class="p">);</span>

	<span class="cm">/* make sure we don&#39;t have a resync in progress */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_mutex</span><span class="p">);</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">kpsmoused_wq</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SERIO_PS_PSTHRU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
		<span class="n">psmouse_deactivate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">)</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">pt_deactivate</span><span class="p">)</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">pt_deactivate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

	<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_IGNORE</span><span class="p">);</span>

	<span class="n">serio_close</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>
	<span class="n">serio_set_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">psmouse_activate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">psmouse_switch_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">psmouse_protocol</span> <span class="o">*</span><span class="n">proto</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psmouse_protocol</span> <span class="o">*</span><span class="n">selected_proto</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">proto</span><span class="o">-&gt;</span><span class="n">detect</span> <span class="o">||</span> <span class="n">proto</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_apply_defaults</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span><span class="o">-&gt;</span><span class="n">detect</span> <span class="o">&amp;&amp;</span> <span class="n">proto</span><span class="o">-&gt;</span><span class="n">detect</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">&amp;&amp;</span> <span class="n">proto</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">psmouse</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">proto</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="n">selected_proto</span> <span class="o">=</span> <span class="n">proto</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">psmouse_extensions</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
						   <span class="n">psmouse_max_proto</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">selected_proto</span> <span class="o">=</span> <span class="n">psmouse_protocol_by_type</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ignore_parity</span> <span class="o">=</span> <span class="n">selected_proto</span><span class="o">-&gt;</span><span class="n">ignore_parity</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If mouse&#39;s packet size is 3 there is no point in polling the</span>
<span class="cm">	 * device in hopes to detect protocol reset - we won&#39;t get less</span>
<span class="cm">	 * than 3 bytes response anyhow.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resync_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some smart KVMs fake response to POLL command returning just</span>
<span class="cm">	 * 3 bytes and messing up our resync logic, so if initial poll</span>
<span class="cm">	 * fails we won&#39;t try polling the device anymore. Hopefully</span>
<span class="cm">	 * such KVM will maintain initially selected protocol.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resync_time</span> <span class="o">&amp;&amp;</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resync_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">),</span> <span class="s">&quot;%s %s %s&quot;</span><span class="p">,</span>
		 <span class="n">selected_proto</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_I8042</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x0002</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * psmouse_connect() is a callback from the serio module when</span>
<span class="cm"> * an unhandled serio port is found.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">psmouse_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serio_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this is a pass-through port deactivate parent so the device</span>
<span class="cm">	 * connected to this port can be successfully identified</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SERIO_PS_PSTHRU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
		<span class="n">psmouse_deactivate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">psmouse</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psmouse</span> <span class="o">||</span> <span class="o">!</span><span class="n">input_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>

	<span class="n">ps2_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">serio</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resync_work</span><span class="p">,</span> <span class="n">psmouse_resync</span><span class="p">);</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">input_dev</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">),</span> <span class="s">&quot;%s/input0&quot;</span><span class="p">,</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>

	<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_INITIALIZING</span><span class="p">);</span>

	<span class="n">serio_set_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">psmouse</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">serio_open</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">drv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_clear_drvdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_probe</span><span class="p">(</span><span class="n">psmouse</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_close_serio</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">psmouse_rate</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">psmouse_resolution</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resetafter</span> <span class="o">=</span> <span class="n">psmouse_resetafter</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resync_time</span> <span class="o">=</span> <span class="n">parent</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">psmouse_resync_time</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">smartscroll</span> <span class="o">=</span> <span class="n">psmouse_smartscroll</span><span class="p">;</span>

	<span class="n">psmouse_switch_protocol</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_MODE</span><span class="p">);</span>
	<span class="n">psmouse_initialize</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_protocol_disconnect</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">pt_activate</span><span class="p">)</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">pt_activate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psmouse_attribute_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pt_deactivate</span><span class="p">;</span>

	<span class="n">psmouse_activate</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="cm">/* If this is a pass-through port the parent needs to be re-activated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">psmouse_activate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

 <span class="nl">err_pt_deactivate:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">pt_deactivate</span><span class="p">)</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">pt_deactivate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">input_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* so we don&#39;t try to free it below */</span>
 <span class="nl">err_protocol_disconnect:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">)</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
	<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_IGNORE</span><span class="p">);</span>
 <span class="nl">err_close_serio:</span>
	<span class="n">serio_close</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>
 <span class="nl">err_clear_drvdata:</span>
	<span class="n">serio_set_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
 <span class="nl">err_free:</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">psmouse_reconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serio_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drv</span> <span class="o">||</span> <span class="o">!</span><span class="n">psmouse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
			    <span class="s">&quot;reconnect request, but serio is disconnected, ignoring...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SERIO_PS_PSTHRU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
		<span class="n">psmouse_deactivate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_INITIALIZING</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">reconnect</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">reconnect</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">psmouse_reset</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_probe</span><span class="p">(</span><span class="n">psmouse</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">type</span> <span class="o">=</span> <span class="n">psmouse_extensions</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">psmouse_max_proto</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * OK, the device type (and capabilities) match the old one,</span>
<span class="cm">	 * we can continue using it, complete initialization</span>
<span class="cm">	 */</span>
	<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_MODE</span><span class="p">);</span>

	<span class="n">psmouse_initialize</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">pt_activate</span><span class="p">)</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">pt_activate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

	<span class="n">psmouse_activate</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="cm">/* If this is a pass-through port the parent waits to be activated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">psmouse_activate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">serio_device_id</span> <span class="n">psmouse_serio_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">SERIO_8042</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proto</span>	<span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra</span>	<span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">SERIO_PS_PSTHRU</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proto</span>	<span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra</span>	<span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">psmouse_serio_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">serio_driver</span> <span class="n">psmouse_drv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;psmouse&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">description</span>	<span class="o">=</span> <span class="n">DRIVER_DESC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">psmouse_serio_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">interrupt</span>	<span class="o">=</span> <span class="n">psmouse_interrupt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span>	<span class="o">=</span> <span class="n">psmouse_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reconnect</span>	<span class="o">=</span> <span class="n">psmouse_reconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">psmouse_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span>	<span class="o">=</span> <span class="n">psmouse_cleanup</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">ssize_t</span> <span class="nf">psmouse_attr_show_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span> <span class="o">=</span> <span class="n">to_serio_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psmouse_attribute</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_psmouse_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">;</span>

	<span class="n">psmouse</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">ssize_t</span> <span class="nf">psmouse_attr_set_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">devattr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span> <span class="o">=</span> <span class="n">to_serio_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psmouse_attribute</span> <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">to_psmouse_attr</span><span class="p">(</span><span class="n">devattr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">psmouse</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">protect</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">PSMOUSE_IGNORE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SERIO_PS_PSTHRU</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">parent</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
			<span class="n">psmouse_deactivate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">psmouse_deactivate</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">protect</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">psmouse_activate</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span>
			<span class="n">psmouse_activate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_mutex</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">psmouse_show_int_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">field</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">psmouse</span> <span class="o">+</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">field</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">psmouse_set_int_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">field</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">psmouse</span> <span class="o">+</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">offset</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="o">*</span><span class="n">field</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">psmouse_attr_show_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">psmouse_protocol_by_type</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">psmouse_attr_set_protocol</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">old_dev</span><span class="p">,</span> <span class="o">*</span><span class="n">new_dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psmouse_protocol</span> <span class="o">*</span><span class="n">proto</span><span class="p">,</span> <span class="o">*</span><span class="n">old_proto</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">proto</span> <span class="o">=</span> <span class="n">psmouse_protocol_by_name</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proto</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">proto</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">new_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">retry</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
				     <span class="s">&quot;failed to destroy children ports, protocol change aborted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">input_free_device</span><span class="p">(</span><span class="n">new_dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_mutex</span><span class="p">);</span>
		<span class="n">serio_unregister_child_port</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">drv</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">psmouse_drv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_free_device</span><span class="p">(</span><span class="n">new_dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">proto</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_free_device</span><span class="p">(</span><span class="n">new_dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">count</span><span class="p">;</span> <span class="cm">/* switched by other thread */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SERIO_PS_PSTHRU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">pt_deactivate</span><span class="p">)</span>
			<span class="n">parent</span><span class="o">-&gt;</span><span class="n">pt_deactivate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">old_dev</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">old_proto</span> <span class="o">=</span> <span class="n">psmouse_protocol_by_type</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">)</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_IGNORE</span><span class="p">);</span>

	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">new_dev</span><span class="p">;</span>
	<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_INITIALIZING</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_switch_protocol</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse_reset</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
		<span class="cm">/* default to PSMOUSE_PS2 */</span>
		<span class="n">psmouse_switch_protocol</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psmouse_protocols</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">psmouse_initialize</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
	<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_MODE</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">)</span>
			<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

		<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_IGNORE</span><span class="p">);</span>
		<span class="n">input_free_device</span><span class="p">(</span><span class="n">new_dev</span><span class="p">);</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">old_dev</span><span class="p">;</span>
		<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_INITIALIZING</span><span class="p">);</span>
		<span class="n">psmouse_switch_protocol</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">old_proto</span><span class="p">);</span>
		<span class="n">psmouse_initialize</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
		<span class="n">psmouse_set_state</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_MODE</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">old_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">pt_activate</span><span class="p">)</span>
		<span class="n">parent</span><span class="o">-&gt;</span><span class="n">pt_activate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">psmouse_attr_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">set_rate</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">psmouse_attr_set_resolution</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">set_resolution</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">psmouse_set_maxproto</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psmouse_protocol</span> <span class="o">*</span><span class="n">proto</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">proto</span> <span class="o">=</span> <span class="n">psmouse_protocol_by_name</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proto</span> <span class="o">||</span> <span class="o">!</span><span class="n">proto</span><span class="o">-&gt;</span><span class="n">maxproto</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">)</span> <span class="o">=</span> <span class="n">proto</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">psmouse_get_maxproto</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">psmouse_protocol_by_type</span><span class="p">(</span><span class="n">type</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">psmouse_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">lifebook_module_init</span><span class="p">();</span>
	<span class="n">synaptics_module_init</span><span class="p">();</span>
	<span class="n">hgpk_module_init</span><span class="p">();</span>

	<span class="n">kpsmoused_wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;kpsmoused&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kpsmoused_wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to create kpsmoused workqueue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">serio_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_drv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">kpsmoused_wq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">psmouse_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">serio_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse_drv</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">kpsmoused_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">psmouse_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">psmouse_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
