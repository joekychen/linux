<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › mouse › synaptics.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>synaptics.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Synaptics TouchPad PS/2 mouse driver</span>
<span class="cm"> *</span>
<span class="cm"> *   2003 Dmitry Torokhov &lt;dtor@mail.ru&gt;</span>
<span class="cm"> *     Added support for pass-through port. Special thanks to Peter Berg Larsen</span>
<span class="cm"> *     for explaining various Synaptics quirks.</span>
<span class="cm"> *</span>
<span class="cm"> *   2003 Peter Osterlund &lt;petero2@telia.com&gt;</span>
<span class="cm"> *     Ported to 2.5 input device infrastructure.</span>
<span class="cm"> *</span>
<span class="cm"> *   Copyright (C) 2001 Stefan Gmeiner &lt;riddlebox@freesurf.ch&gt;</span>
<span class="cm"> *     start merging tpconfig and gpm code to a xfree-input module</span>
<span class="cm"> *     adding some changes and extensions (ex. 3rd and 4th button)</span>
<span class="cm"> *</span>
<span class="cm"> *   Copyright (c) 1997 C. Scott Ananian &lt;cananian@alumni.priceton.edu&gt;</span>
<span class="cm"> *   Copyright (c) 1998-2000 Bruce Kalk &lt;kall@compass.com&gt;</span>
<span class="cm"> *     code for the special synaptics commands (from the tpconfig-source)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Trademarks are the property of their respective owners.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/input/mt.h&gt;</span>
<span class="cp">#include &lt;linux/serio.h&gt;</span>
<span class="cp">#include &lt;linux/libps2.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;psmouse.h&quot;</span>
<span class="cp">#include &quot;synaptics.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * The x/y limits are taken from the Synaptics TouchPad interfacing Guide,</span>
<span class="cm"> * section 2.3.2, which says that they should be valid regardless of the</span>
<span class="cm"> * actual size of the sensor.</span>
<span class="cm"> * Note that newer firmware allows querying device for maximum useable</span>
<span class="cm"> * coordinates.</span>
<span class="cm"> */</span>
<span class="cp">#define XMIN_NOMINAL 1472</span>
<span class="cp">#define XMAX_NOMINAL 5472</span>
<span class="cp">#define YMIN_NOMINAL 1408</span>
<span class="cp">#define YMAX_NOMINAL 4448</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> *	Stuff we need even when we do not want native Synaptics support</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Set the synaptics touchpad mode byte by special commands</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">synaptics_mode_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_sliced_command</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SYN_PS_SET_MODE2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">synaptics_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set_properties</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">);</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">);</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">);</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRES</span><span class="p">);</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_GETINFO</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x47</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_properties</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="s">&quot;Synaptics&quot;</span><span class="p">;</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;TouchPad&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">synaptics_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reset touchpad back to relative mode, gestures enabled */</span>
	<span class="n">synaptics_mode_cmd</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MOUSE_PS2_SYNAPTICS</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *	Synaptics communications functions</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Synaptics touchpads report the y coordinate from bottom to top, which is</span>
<span class="cm"> * opposite from what userspace expects.</span>
<span class="cm"> * This function is used to invert y before reporting.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">synaptics_invert_y</span><span class="p">(</span><span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">YMAX_NOMINAL</span> <span class="o">+</span> <span class="n">YMIN_NOMINAL</span> <span class="o">-</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send a command to the synpatics touchpad by special commands</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">synaptics_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_sliced_command</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_GETINFO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the model-id bytes from the touchpad</span>
<span class="cm"> * see also SYN_MODEL_* macros</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">synaptics_model_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mi</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_send_cmd</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">SYN_QUE_MODEL</span><span class="p">,</span> <span class="n">mi</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">model_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">mi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">mi</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the capability-bits from the touchpad</span>
<span class="cm"> * see also the SYN_CAP_* macros</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">synaptics_capability</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cap</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_send_cmd</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">SYN_QUE_CAPABILITIES</span><span class="p">,</span> <span class="n">cap</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="p">(</span><span class="n">cap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">cap</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap_0c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Older firmwares had submodel ID fixed to 0x47</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_ID_FULL</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x705</span> <span class="o">&amp;&amp;</span>
	    <span class="n">SYN_CAP_SUBMODEL_ID</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x47</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Unless capExtended is set the rest of the flags should be ignored</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SYN_CAP_EXTENDED</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_EXT_CAP_REQUESTS</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_send_cmd</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">SYN_QUE_EXT_CAPAB</span><span class="p">,</span> <span class="n">cap</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
				     <span class="s">&quot;device claims to have extended capabilities, but I&#39;m not able to read them.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap</span> <span class="o">=</span> <span class="p">(</span><span class="n">cap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">cap</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

			<span class="cm">/*</span>
<span class="cm">			 * if nExtBtn is greater than 8 it should be considered</span>
<span class="cm">			 * invalid and treated as 0</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_MULTI_BUTTON_NO</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap</span> <span class="o">&amp;=</span> <span class="mh">0xff0fff</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_EXT_CAP_REQUESTS</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_send_cmd</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">SYN_QUE_EXT_CAPAB_0C</span><span class="p">,</span> <span class="n">cap</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
				     <span class="s">&quot;device claims to have extended capability 0x0c, but I&#39;m not able to read it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap_0c</span> <span class="o">=</span> <span class="p">(</span><span class="n">cap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">cap</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Identify Touchpad</span>
<span class="cm"> * See also the SYN_ID_* macros</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">synaptics_identify</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_send_cmd</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">SYN_QUE_IDENTIFY</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">identity</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_ID_IS_SYNAPTICS</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read touchpad resolution and maximum reported coordinates</span>
<span class="cm"> * Resolution is left zero if touchpad does not support the query</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">synaptics_resolution</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">resp</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_ID_MAJOR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_send_cmd</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">SYN_QUE_RESOLUTION</span><span class="p">,</span> <span class="n">resp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">resp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">x_res</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* x resolution in units/mm */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">y_res</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* y resolution in units/mm */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_EXT_CAP_REQUESTS</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span>
	    <span class="n">SYN_CAP_MAX_DIMENSIONS</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap_0c</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_send_cmd</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">SYN_QUE_EXT_MAX_COORDS</span><span class="p">,</span> <span class="n">resp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
				     <span class="s">&quot;device claims to have max coordinates query, but I&#39;m not able to read it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">x_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">y_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_EXT_CAP_REQUESTS</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span>
	    <span class="n">SYN_CAP_MIN_DIMENSIONS</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap_0c</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_send_cmd</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">SYN_QUE_EXT_MIN_COORDS</span><span class="p">,</span> <span class="n">resp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
				     <span class="s">&quot;device claims to have min coordinates query, but I&#39;m not able to read it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">x_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">y_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">resp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">synaptics_query_hardware</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_identify</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_model_id</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_capability</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_resolution</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">synaptics_set_advanced_gesture_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span> <span class="o">=</span> <span class="mh">0xc8</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SYN_CAP_ADV_GESTURE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap_0c</span><span class="p">)</span> <span class="o">||</span>
	      <span class="n">SYN_CAP_IMAGE_SENSOR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap_0c</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_sliced_command</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">SYN_QUE_MODEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Advanced gesture mode also sends multi finger data */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">synaptics_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">absolute_mode</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">SYN_BIT_ABSOLUTE_MODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">disable_gesture</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">SYN_BIT_DISABLE_GESTURE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="mi">80</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">SYN_BIT_HIGH_RATE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_EXTENDED</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">SYN_BIT_W_MODE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_mode_cmd</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">absolute_mode</span> <span class="o">&amp;&amp;</span>
	    <span class="n">synaptics_set_advanced_gesture_mode</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Advanced gesture mode init failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">SYN_BIT_HIGH_RATE</span><span class="p">;</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYN_BIT_HIGH_RATE</span><span class="p">;</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">synaptics_mode_cmd</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *	Synaptics pass-through PS/2 port support</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">synaptics_pt_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">rate_param</span> <span class="o">=</span> <span class="n">SYN_PS_CLIENT_CMD</span><span class="p">;</span> <span class="cm">/* indicates that we want pass-through port */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse_sliced_command</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rate_param</span><span class="p">,</span> <span class="n">PSMOUSE_CMD_SETRATE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">synaptics_pt_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">serio_pause_rx</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pt_port</span> <span class="o">=</span> <span class="n">serio</span><span class="p">;</span>
	<span class="n">serio_continue_rx</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_pt_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">serio_pause_rx</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pt_port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">serio_continue_rx</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">synaptics_is_pt_packet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x84</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xCC</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xC4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_pass_pt_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">ptport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">child</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">ptport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">&amp;&amp;</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">PSMOUSE_ACTIVATED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">serio_interrupt</span><span class="p">(</span><span class="n">ptport</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">serio_interrupt</span><span class="p">(</span><span class="n">ptport</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">serio_interrupt</span><span class="p">(</span><span class="n">ptport</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">pktsize</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">serio_interrupt</span><span class="p">(</span><span class="n">ptport</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">serio_interrupt</span><span class="p">(</span><span class="n">ptport</span><span class="p">,</span> <span class="n">packet</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_pt_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">child</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pt_port</span><span class="p">);</span>

	<span class="cm">/* adjust the touchpad to child&#39;s choice of protocol */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">pktsize</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">SYN_BIT_FOUR_BYTE_CLIENT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYN_BIT_FOUR_BYTE_CLIENT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_mode_cmd</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">))</span>
			<span class="n">psmouse_warn</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
				     <span class="s">&quot;failed to switch guest protocol</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_pt_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">;</span>

	<span class="n">serio</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
			    <span class="s">&quot;not enough memory for pass-through port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">serio</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SERIO_PS_PSTHRU</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Synaptics pass-through&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="s">&quot;synaptics-pt/serio0&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">serio</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">synaptics_pt_write</span><span class="p">;</span>
	<span class="n">serio</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">synaptics_pt_start</span><span class="p">;</span>
	<span class="n">serio</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="n">synaptics_pt_stop</span><span class="p">;</span>
	<span class="n">serio</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">;</span>

	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pt_activate</span> <span class="o">=</span> <span class="n">synaptics_pt_activate</span><span class="p">;</span>

	<span class="n">psmouse_info</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;serio: %s port at %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">serio</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">serio_register_port</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *	Functions to interpret the absolute mode packets</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_mt_state_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">synaptics_mt_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">sgm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">agm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">sgm</span> <span class="o">=</span> <span class="n">sgm</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">agm</span> <span class="o">=</span> <span class="n">agm</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_parse_agm</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[],</span>
				<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">synaptics_hw_state</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_hw_state</span> <span class="o">*</span><span class="n">agm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">agm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">agm_packet_type</span><span class="p">;</span>

	<span class="n">agm_packet_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">agm_packet_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* Gesture packet: (x, y, z) half resolution */</span>
		<span class="n">agm</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">;</span>
		<span class="n">agm</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">(((</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">agm</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">(((</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">agm</span><span class="o">-&gt;</span><span class="n">z</span> <span class="o">=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/* AGM-CONTACT packet: (count, sgm, agm) */</span>
		<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agm</span><span class="o">-&gt;</span><span class="n">mt_state</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Record that at least one AGM has been received since last SGM */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">agm_pending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">synaptics_parse_hw_state</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[],</span>
				    <span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">synaptics_hw_state</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">synaptics_hw_state</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_MODEL_NEWABS</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">model_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">=</span> <span class="p">(((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">left</span>  <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_CLICKPAD</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap_0c</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Clickpad&#39;s button is transmitted as middle button,</span>
<span class="cm">			 * however, since it is primary button, we will report</span>
<span class="cm">			 * it as BTN_LEFT.</span>
<span class="cm">			 */</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_MIDDLE_BUTTON</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">middle</span> <span class="o">=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">scroll</span> <span class="o">=</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">char</span><span class="p">)(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_FOUR_BUTTON</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">up</span>   <span class="o">=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">down</span> <span class="o">=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">SYN_CAP_ADV_GESTURE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap_0c</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">SYN_CAP_IMAGE_SENSOR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap_0c</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">hw</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">synaptics_parse_agm</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">(((</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">(((</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">z</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_MULTI_BUTTON_NO</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">SYN_CAP_MULTI_BUTTON_NO</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="nl">default:</span>
				<span class="cm">/*</span>
<span class="cm">				 * if nExtBtn is greater than 8 it should be</span>
<span class="cm">				 * considered invalid and treated as 0</span>
<span class="cm">				 */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">8</span>:
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ext_buttons</span> <span class="o">|=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ext_buttons</span> <span class="o">|=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0x40</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">6</span>:
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ext_buttons</span> <span class="o">|=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0x20</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ext_buttons</span> <span class="o">|=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ext_buttons</span> <span class="o">|=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0x08</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ext_buttons</span> <span class="o">|=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0x04</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ext_buttons</span> <span class="o">|=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0x02</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ext_buttons</span> <span class="o">|=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">(((</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">(((</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">z</span> <span class="o">=</span> <span class="p">(((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">));</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">=</span> <span class="p">(((</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">left</span>  <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_report_semi_mt_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span>
					  <span class="n">bool</span> <span class="n">active</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">input_mt_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="n">input_mt_report_slot_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MT_TOOL_FINGER</span><span class="p">,</span> <span class="n">active</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_MT_POSITION_X</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_MT_POSITION_Y</span><span class="p">,</span> <span class="n">synaptics_invert_y</span><span class="p">(</span><span class="n">y</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_report_semi_mt_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">const</span> <span class="k">struct</span> <span class="n">synaptics_hw_state</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
					  <span class="k">const</span> <span class="k">struct</span> <span class="n">synaptics_hw_state</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">num_fingers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_fingers</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synaptics_report_semi_mt_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">),</span>
					      <span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">));</span>
		<span class="n">synaptics_report_semi_mt_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">max</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">),</span>
					      <span class="n">max</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">num_fingers</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synaptics_report_semi_mt_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
		<span class="n">synaptics_report_semi_mt_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">synaptics_report_semi_mt_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">synaptics_report_semi_mt_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_report_buttons</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">synaptics_hw_state</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_MIDDLE_BUTTON</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">))</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">middle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_FOUR_BUTTON</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_FORWARD</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_BACK</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SYN_CAP_MULTI_BUTTON_NO</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ext_buttons</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_report_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">synaptics_hw_state</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">input_mt_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="n">input_mt_report_slot_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MT_TOOL_FINGER</span><span class="p">,</span> <span class="p">(</span><span class="n">hw</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_MT_POSITION_X</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_MT_POSITION_Y</span><span class="p">,</span> <span class="n">synaptics_invert_y</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">));</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_MT_PRESSURE</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">z</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_report_mt_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">synaptics_mt_state</span> <span class="o">*</span><span class="n">mt_state</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">synaptics_hw_state</span> <span class="o">*</span><span class="n">sgm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">synaptics_hw_state</span> <span class="o">*</span><span class="n">agm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">agm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">synaptics_mt_state</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mt_state</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mt_state</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">synaptics_report_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">synaptics_report_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mt_state</span><span class="o">-&gt;</span><span class="n">sgm</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">synaptics_report_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">synaptics_report_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mt_state</span><span class="o">-&gt;</span><span class="n">sgm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">synaptics_report_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sgm</span><span class="p">);</span>
			<span class="n">synaptics_report_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">synaptics_report_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">synaptics_report_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sgm</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the finger slot contained in SGM is valid, and either</span>
<span class="cm">		 * hasn&#39;t changed, or is new, then report SGM in MTB slot 0.</span>
<span class="cm">		 * Otherwise, empty MTB slot 0.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mt_state</span><span class="o">-&gt;</span><span class="n">sgm</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">mt_state</span><span class="o">-&gt;</span><span class="n">sgm</span> <span class="o">==</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">sgm</span> <span class="o">||</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">sgm</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			<span class="n">synaptics_report_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sgm</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">synaptics_report_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If the finger slot contained in AGM is valid, and either</span>
<span class="cm">		 * hasn&#39;t changed, or is new, then report AGM in MTB slot 1.</span>
<span class="cm">		 * Otherwise, empty MTB slot 1.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mt_state</span><span class="o">-&gt;</span><span class="n">agm</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">mt_state</span><span class="o">-&gt;</span><span class="n">agm</span> <span class="o">==</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">agm</span> <span class="o">||</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">agm</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			<span class="n">synaptics_report_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">agm</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">synaptics_report_slot</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Don&#39;t use active slot count to generate BTN_TOOL events. */</span>
	<span class="n">input_mt_report_pointer_emulation</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* Send the number of fingers reported by touchpad itself. */</span>
	<span class="n">input_mt_report_finger_count</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mt_state</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="n">synaptics_report_buttons</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">sgm</span><span class="p">);</span>

	<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Handle case where mt_state-&gt;count = 0 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_image_sensor_0f</span><span class="p">(</span><span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">synaptics_mt_state</span> <span class="o">*</span><span class="n">mt_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mt_state_lost</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Handle case where mt_state-&gt;count = 1 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_image_sensor_1f</span><span class="p">(</span><span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">synaptics_mt_state</span> <span class="o">*</span><span class="n">mt_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_hw_state</span> <span class="o">*</span><span class="n">agm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">agm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">synaptics_mt_state</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mt_state</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the last AGM was (0,0,0), and there is only one finger left,</span>
<span class="cm">	 * then we absolutely know that SGM contains slot 0, and all other</span>
<span class="cm">	 * fingers have been removed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">agm_pending</span> <span class="o">&amp;&amp;</span> <span class="n">agm</span><span class="o">-&gt;</span><span class="n">z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mt_state_lost</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If mt_state_lost, then the previous transition was 3-&gt;1,</span>
<span class="cm">		 * and SGM now contains either slot 0 or 1, but we don&#39;t know</span>
<span class="cm">		 * which.  So, we just assume that the SGM now contains slot 1.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If pending AGM and either:</span>
<span class="cm">		 *   (a) the previous SGM slot contains slot 0, or</span>
<span class="cm">		 *   (b) there was no SGM slot</span>
<span class="cm">		 * then, the SGM now contains slot 1</span>
<span class="cm">		 *</span>
<span class="cm">		 * Case (a) happens with very rapid &quot;drum roll&quot; gestures, where</span>
<span class="cm">		 * slot 0 finger is lifted and a new slot 1 finger touches</span>
<span class="cm">		 * within one reporting interval.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Case (b) happens if initially two or more fingers tap</span>
<span class="cm">		 * briefly, and all but one lift before the end of the first</span>
<span class="cm">		 * reporting interval.</span>
<span class="cm">		 *</span>
<span class="cm">		 * (In both these cases, slot 0 will becomes empty, so SGM</span>
<span class="cm">		 * contains slot 1 with the new finger)</span>
<span class="cm">		 *</span>
<span class="cm">		 * Else, if there was no previous SGM, it now contains slot 0.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Otherwise, SGM still contains the same slot.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mt_state_lost</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">agm_pending</span> <span class="o">&amp;&amp;</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">sgm</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">sgm</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If mt_state_lost, we don&#39;t know which finger SGM contains.</span>
<span class="cm">		 *</span>
<span class="cm">		 * So, report 1 finger, but with both slots empty.</span>
<span class="cm">		 * We will use slot 1 on subsequent 1-&gt;1</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mt_state_lost</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Since the last AGM was NOT (0,0,0), it was the finger in</span>
<span class="cm">		 * slot 0 that has been removed.</span>
<span class="cm">		 * So, SGM now contains previous AGM&#39;s slot, and AGM is now</span>
<span class="cm">		 * empty.</span>
<span class="cm">		 */</span>
		<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">agm</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Since last AGM was not (0,0,0), we don&#39;t know which finger</span>
<span class="cm">		 * is left.</span>
<span class="cm">		 *</span>
<span class="cm">		 * So, report 1 finger, but with both slots empty.</span>
<span class="cm">		 * We will use slot 1 on subsequent 1-&gt;1</span>
<span class="cm">		 */</span>
		<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mt_state_lost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="cm">/* mt_state was updated by AGM-CONTACT packet */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Handle case where mt_state-&gt;count = 2 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_image_sensor_2f</span><span class="p">(</span><span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">synaptics_mt_state</span> <span class="o">*</span><span class="n">mt_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_mt_state</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mt_state</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If previous SGM contained slot 1 or higher, SGM now contains</span>
<span class="cm">		 * slot 0 (the newly touching finger) and AGM contains SGM&#39;s</span>
<span class="cm">		 * previous slot.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Otherwise, SGM still contains slot 0 and AGM now contains</span>
<span class="cm">		 * slot 1.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">sgm</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">sgm</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If mt_state_lost, SGM now contains either finger 1 or 2, but</span>
<span class="cm">		 * we don&#39;t know which.</span>
<span class="cm">		 * So, we just assume that the SGM contains slot 0 and AGM 1.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mt_state_lost</span><span class="p">)</span>
			<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Otherwise, use the same mt_state, since it either hasn&#39;t</span>
<span class="cm">		 * changed, or was updated by a recently received AGM-CONTACT</span>
<span class="cm">		 * packet.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/*</span>
<span class="cm">		 * 3-&gt;2 transitions have two unsolvable problems:</span>
<span class="cm">		 *  1) no indication is given which finger was removed</span>
<span class="cm">		 *  2) no way to tell if agm packet was for finger 3</span>
<span class="cm">		 *     before 3-&gt;2, or finger 2 after 3-&gt;2.</span>
<span class="cm">		 *</span>
<span class="cm">		 * So, report 2 fingers, but empty all slots.</span>
<span class="cm">		 * We will guess slots [0,1] on subsequent 2-&gt;2.</span>
<span class="cm">		 */</span>
		<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mt_state_lost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="cm">/* mt_state was updated by AGM-CONTACT packet */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Handle case where mt_state-&gt;count = 3 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_image_sensor_3f</span><span class="p">(</span><span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">synaptics_mt_state</span> <span class="o">*</span><span class="n">mt_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_mt_state</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mt_state</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If previous SGM contained slot 2 or higher, SGM now contains</span>
<span class="cm">		 * slot 0 (one of the newly touching fingers) and AGM contains</span>
<span class="cm">		 * SGM&#39;s previous slot.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Otherwise, SGM now contains slot 0 and AGM contains slot 2.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">sgm</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">sgm</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If the AGM previously contained slot 3 or higher, then the</span>
<span class="cm">		 * newly touching finger is in the lowest available slot.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If SGM was previously 1 or higher, then the new SGM is</span>
<span class="cm">		 * now slot 0 (with a new finger), otherwise, the new finger</span>
<span class="cm">		 * is now in a hidden slot between 0 and AGM&#39;s slot.</span>
<span class="cm">		 *</span>
<span class="cm">		 * In all such cases, the SGM now contains slot 0, and the AGM</span>
<span class="cm">		 * continues to contain the same slot as before.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">agm</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">agm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * After some 3-&gt;1 and all 3-&gt;2 transitions, we lose track</span>
<span class="cm">		 * of which slot is reported by SGM and AGM.</span>
<span class="cm">		 *</span>
<span class="cm">		 * For 2-&gt;3 in this state, report 3 fingers, but empty all</span>
<span class="cm">		 * slots, and we will guess (0,2) on a subsequent 0-&gt;3.</span>
<span class="cm">		 *</span>
<span class="cm">		 * To userspace, the resulting transition will look like:</span>
<span class="cm">		 *    2:[0,1] -&gt; 3:[-1,-1] -&gt; 3:[0,2]</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mt_state_lost</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If the (SGM,AGM) really previously contained slots (0, 1),</span>
<span class="cm">		 * then we cannot know what slot was just reported by the AGM,</span>
<span class="cm">		 * because the 2-&gt;3 transition can occur either before or after</span>
<span class="cm">		 * the AGM packet. Thus, this most recent AGM could contain</span>
<span class="cm">		 * either the same old slot 1 or the new slot 2.</span>
<span class="cm">		 * Subsequent AGMs will be reporting slot 2.</span>
<span class="cm">		 *</span>
<span class="cm">		 * To userspace, the resulting transition will look like:</span>
<span class="cm">		 *    2:[0,1] -&gt; 3:[0,-1] -&gt; 3:[0,2]</span>
<span class="cm">		 */</span>
		<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/*</span>
<span class="cm">		 * If, for whatever reason, the previous agm was invalid,</span>
<span class="cm">		 * Assume SGM now contains slot 0, AGM now contains slot 2.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">agm</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">synaptics_mt_state_set</span><span class="p">(</span><span class="n">mt_state</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * mt_state either hasn&#39;t changed, or was updated by a recently</span>
<span class="cm">		 * received AGM-CONTACT packet.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="cm">/* mt_state was updated by AGM-CONTACT packet */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Handle case where mt_state-&gt;count = 4, or = 5 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_image_sensor_45f</span><span class="p">(</span><span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">synaptics_mt_state</span> <span class="o">*</span><span class="n">mt_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* mt_state was updated correctly by AGM-CONTACT packet */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mt_state_lost</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_image_sensor_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">synaptics_hw_state</span> <span class="o">*</span><span class="n">sgm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">synaptics_hw_state</span> <span class="o">*</span><span class="n">agm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">agm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">synaptics_mt_state</span> <span class="n">mt_state</span><span class="p">;</span>

	<span class="cm">/* Initialize using current mt_state (as updated by last agm) */</span>
	<span class="n">mt_state</span> <span class="o">=</span> <span class="n">agm</span><span class="o">-&gt;</span><span class="n">mt_state</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update mt_state using the new finger count and current mt_state.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sgm</span><span class="o">-&gt;</span><span class="n">z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">synaptics_image_sensor_0f</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mt_state</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sgm</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">synaptics_image_sensor_1f</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mt_state</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sgm</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">synaptics_image_sensor_2f</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mt_state</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sgm</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">mt_state</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">synaptics_image_sensor_3f</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mt_state</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">synaptics_image_sensor_45f</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mt_state</span><span class="p">);</span>

	<span class="cm">/* Send resulting input events to user space */</span>
	<span class="n">synaptics_report_mt_data</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mt_state</span><span class="p">,</span> <span class="n">sgm</span><span class="p">);</span>

	<span class="cm">/* Store updated mt_state */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mt_state</span> <span class="o">=</span> <span class="n">agm</span><span class="o">-&gt;</span><span class="n">mt_state</span> <span class="o">=</span> <span class="n">mt_state</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">agm_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  called for each full received packet from the touchpad</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_process_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">synaptics_hw_state</span> <span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_fingers</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">finger_width</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_parse_hw_state</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_IMAGE_SENSOR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap_0c</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">synaptics_image_sensor_process</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="p">.</span><span class="n">scroll</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scroll</span> <span class="o">+=</span> <span class="n">hw</span><span class="p">.</span><span class="n">scroll</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scroll</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_BACK</span><span class="p">,</span> <span class="o">!</span><span class="n">hw</span><span class="p">.</span><span class="n">down</span><span class="p">);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_BACK</span><span class="p">,</span> <span class="n">hw</span><span class="p">.</span><span class="n">down</span><span class="p">);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scroll</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scroll</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_FORWARD</span><span class="p">,</span> <span class="o">!</span><span class="n">hw</span><span class="p">.</span><span class="n">up</span><span class="p">);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_FORWARD</span><span class="p">,</span> <span class="n">hw</span><span class="p">.</span><span class="n">up</span><span class="p">);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scroll</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="p">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_fingers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">finger_width</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_EXTENDED</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="p">.</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span> <span class="p">...</span> <span class="mi">1</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_MULTIFINGER</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">))</span>
					<span class="n">num_fingers</span> <span class="o">=</span> <span class="n">hw</span><span class="p">.</span><span class="n">w</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">SYN_MODEL_PEN</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">model_id</span><span class="p">))</span>
					<span class="p">;</span>   <span class="cm">/* Nothing, treat a pen as a single finger */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span> <span class="p">...</span> <span class="mi">15</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_PALMDETECT</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">))</span>
					<span class="n">finger_width</span> <span class="o">=</span> <span class="n">hw</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">num_fingers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">finger_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_ADV_GESTURE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap_0c</span><span class="p">))</span>
		<span class="n">synaptics_report_semi_mt_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">agm</span><span class="p">,</span>
					      <span class="n">num_fingers</span><span class="p">);</span>

	<span class="cm">/* Post events</span>
<span class="cm">	 * BTN_TOUCH has to be first as mousedev relies on it when doing</span>
<span class="cm">	 * absolute -&gt; relative conversion</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="p">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="p">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">)</span> <span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_fingers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">hw</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">synaptics_invert_y</span><span class="p">(</span><span class="n">hw</span><span class="p">.</span><span class="n">y</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="n">hw</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_PALMDETECT</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">))</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_TOOL_WIDTH</span><span class="p">,</span> <span class="n">finger_width</span><span class="p">);</span>

	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TOOL_FINGER</span><span class="p">,</span> <span class="n">num_fingers</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_MULTIFINGER</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TOOL_DOUBLETAP</span><span class="p">,</span> <span class="n">num_fingers</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TOOL_TRIPLETAP</span><span class="p">,</span> <span class="n">num_fingers</span> <span class="o">==</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">synaptics_report_buttons</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">synaptics_validate_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pkt_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">newabs_mask</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">newabs_rel_mask</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">newabs_rslt</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">oldabs_mask</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x60</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">oldabs_rslt</span><span class="p">[]</span>	<span class="o">=</span> <span class="p">{</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pkt_type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">SYN_NEWABS</span>:
	<span class="k">case</span> <span class="n">SYN_NEWABS_RELAXED</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">newabs_rel_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">==</span> <span class="n">newabs_rslt</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="k">case</span> <span class="n">SYN_NEWABS_STRICT</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">newabs_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">==</span> <span class="n">newabs_rslt</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="k">case</span> <span class="n">SYN_OLDABS</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">oldabs_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">==</span> <span class="n">oldabs_rslt</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="nl">default:</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;unknown packet type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">synaptics_detect_pkt_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">synaptics_validate_byte</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">SYN_NEWABS_STRICT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">psmouse_info</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;using relaxed packet validation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">SYN_NEWABS_RELAXED</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">return</span> <span class="n">SYN_NEWABS_STRICT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">psmouse_ret_t</span> <span class="nf">synaptics_process_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Full packet received */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">SYN_NEWABS</span><span class="p">))</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">synaptics_detect_pkt_type</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_PASS_THROUGH</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">synaptics_is_pt_packet</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pt_port</span><span class="p">)</span>
				<span class="n">synaptics_pass_pt_packet</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pt_port</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">synaptics_process_packet</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">PSMOUSE_FULL_PACKET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">synaptics_validate_byte</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktcnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">PSMOUSE_GOOD_DATA</span> <span class="o">:</span> <span class="n">PSMOUSE_BAD_DATA</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *	Driver initialization/cleanup functions</span>
<span class="cm"> ****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_abs_position_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x_code</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">y_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x_min</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">x_min</span> <span class="o">?:</span> <span class="n">XMIN_NOMINAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">x_max</span> <span class="o">?:</span> <span class="n">XMAX_NOMINAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y_min</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">y_min</span> <span class="o">?:</span> <span class="n">YMIN_NOMINAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">y_max</span> <span class="o">?:</span> <span class="n">YMAX_NOMINAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fuzz</span> <span class="o">=</span> <span class="n">SYN_CAP_REDUCED_FILTERING</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap_0c</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">SYN_REDUCED_FILTER_FUZZ</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">x_code</span><span class="p">,</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">fuzz</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">y_code</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">fuzz</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_abs_set_res</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">x_code</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">x_res</span><span class="p">);</span>
	<span class="n">input_abs_set_res</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">y_code</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">y_res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_input_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Things that apply to both modes */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">INPUT_PROP_POINTER</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">propbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_MIDDLE_BUTTON</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">))</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">absolute_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Relative mode */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_REL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">REL_X</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">REL_Y</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Absolute mode */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">set_abs_position_params</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_IMAGE_SENSOR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap_0c</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">input_mt_init_slots</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">set_abs_position_params</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="n">ABS_MT_POSITION_X</span><span class="p">,</span>
					<span class="n">ABS_MT_POSITION_Y</span><span class="p">);</span>
		<span class="cm">/* Image sensors can report per-contact pressure */</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_MT_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Image sensors can signal 4 and 5 finger clicks */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOOL_QUADTAP</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOOL_QUINTTAP</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_ADV_GESTURE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap_0c</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Non-image sensors with AGM use semi-mt */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">INPUT_PROP_SEMI_MT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">propbit</span><span class="p">);</span>
		<span class="n">input_mt_init_slots</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">set_abs_position_params</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="n">ABS_MT_POSITION_X</span><span class="p">,</span>
					<span class="n">ABS_MT_POSITION_Y</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_PALMDETECT</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">))</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_TOOL_WIDTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOOL_FINGER</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_MULTIFINGER</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOOL_DOUBLETAP</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOOL_TRIPLETAP</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_FOUR_BUTTON</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">SYN_CAP_MIDDLE_BUTTON</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_FORWARD</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_BACK</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SYN_CAP_MULTI_BUTTON_NO</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">EV_REL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">REL_X</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">REL_Y</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_CLICKPAD</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap_0c</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">INPUT_PROP_BUTTONPAD</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">propbit</span><span class="p">);</span>
		<span class="cm">/* Clickpads report only left button */</span>
		<span class="n">__clear_bit</span><span class="p">(</span><span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">__clear_bit</span><span class="p">(</span><span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">synaptics_show_disable_gesture</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span>
					      <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">disable_gesture</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">synaptics_set_disable_gesture</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span>
					     <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
					     <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">disable_gesture</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">disable_gesture</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">SYN_BIT_DISABLE_GESTURE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SYN_BIT_DISABLE_GESTURE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_mode_cmd</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">PSMOUSE_DEFINE_ATTR</span><span class="p">(</span><span class="n">disable_gesture</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		    <span class="n">synaptics_show_disable_gesture</span><span class="p">,</span>
		    <span class="n">synaptics_set_disable_gesture</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">synaptics_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">absolute_mode</span> <span class="o">&amp;&amp;</span> <span class="n">SYN_ID_DISGEST_SUPPORTED</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">))</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">psmouse_attr_disable_gesture</span><span class="p">.</span><span class="n">dattr</span><span class="p">);</span>

	<span class="n">synaptics_reset</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">synaptics_reconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="n">old_priv</span> <span class="o">=</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">psmouse_reset</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retry</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * On some boxes, right after resuming, the touchpad</span>
<span class="cm">			 * needs some time to finish initializing (I assume</span>
<span class="cm">			 * it needs time to calibrate) and start responding</span>
<span class="cm">			 * to Synaptics-specific queries, so let&#39;s wait a</span>
<span class="cm">			 * bit.</span>
<span class="cm">			 */</span>
			<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">synaptics_detect</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="o">++</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">psmouse_dbg</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;reconnected after %d tries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retry</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_query_hardware</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Unable to query device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_set_mode</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Unable to initialize device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_priv</span><span class="p">.</span><span class="n">identity</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">identity</span> <span class="o">||</span>
	    <span class="n">old_priv</span><span class="p">.</span><span class="n">model_id</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">model_id</span> <span class="o">||</span>
	    <span class="n">old_priv</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">||</span>
	    <span class="n">old_priv</span><span class="p">.</span><span class="n">ext_cap</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
			    <span class="s">&quot;hardware appears to be different: id(%ld-%ld), model(%ld-%ld), caps(%lx-%lx), ext(%lx-%lx).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">old_priv</span><span class="p">.</span><span class="n">identity</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">,</span>
			    <span class="n">old_priv</span><span class="p">.</span><span class="n">model_id</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">model_id</span><span class="p">,</span>
			    <span class="n">old_priv</span><span class="p">.</span><span class="n">capabilities</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">,</span>
			    <span class="n">old_priv</span><span class="p">.</span><span class="n">ext_cap</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">impaired_toshiba_kbc</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">__initconst</span> <span class="n">toshiba_dmi_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#if defined(CONFIG_DMI) &amp;&amp; defined(CONFIG_X86)</span>
	<span class="p">{</span>
		<span class="cm">/* Toshiba Satellite */</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Satellite&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* Toshiba Dynabook */</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;dynabook&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* Toshiba Portege M300 */</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;PORTEGE M300&quot;</span><span class="p">),</span>
		<span class="p">},</span>

	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* Toshiba Portege M300 */</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Portable PC&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_VERSION</span><span class="p">,</span> <span class="s">&quot;Version 1.0&quot;</span><span class="p">),</span>
		<span class="p">},</span>

	<span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">broken_olpc_ec</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">__initconst</span> <span class="n">olpc_dmi_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#if defined(CONFIG_DMI) &amp;&amp; defined(CONFIG_OLPC)</span>
	<span class="p">{</span>
		<span class="cm">/* OLPC XO-1 or XO-1.5 */</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;OLPC&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;XO&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">synaptics_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">impaired_toshiba_kbc</span> <span class="o">=</span> <span class="n">dmi_check_system</span><span class="p">(</span><span class="n">toshiba_dmi_table</span><span class="p">);</span>
	<span class="n">broken_olpc_ec</span> <span class="o">=</span> <span class="n">dmi_check_system</span><span class="p">(</span><span class="n">olpc_dmi_table</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__synaptics_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">,</span> <span class="n">bool</span> <span class="n">absolute_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">synaptics_data</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The OLPC XO has issues with Synaptics&#39; absolute mode; the constant</span>
<span class="cm">	 * packet spew overloads the EC such that key presses on the keyboard</span>
<span class="cm">	 * are missed.  Given that, don&#39;t even attempt to use Absolute mode.</span>
<span class="cm">	 * Relative mode seems to work just fine.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">absolute_mode</span> <span class="o">&amp;&amp;</span> <span class="n">broken_olpc_ec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse_info</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
			     <span class="s">&quot;OLPC XO detected, not enabling Synaptics protocol.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">synaptics_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">psmouse_reset</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_query_hardware</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Unable to query device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">init_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">absolute_mode</span> <span class="o">=</span> <span class="n">absolute_mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_ID_DISGEST_SUPPORTED</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">disable_gesture</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">synaptics_set_mode</span><span class="p">(</span><span class="n">psmouse</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="s">&quot;Unable to initialize device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">init_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">SYN_MODEL_NEWABS</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">model_id</span><span class="p">)</span> <span class="o">?</span> <span class="n">SYN_NEWABS</span> <span class="o">:</span> <span class="n">SYN_OLDABS</span><span class="p">;</span>

	<span class="n">psmouse_info</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
		     <span class="s">&quot;Touchpad model: %ld, fw: %ld.%ld, id: %#lx, caps: %#lx/%#lx/%#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">SYN_ID_MODEL</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">),</span>
		     <span class="n">SYN_ID_MAJOR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">),</span> <span class="n">SYN_ID_MINOR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">),</span>
		     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">model_id</span><span class="p">,</span>
		     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ext_cap_0c</span><span class="p">);</span>

	<span class="n">set_input_params</span><span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Encode touchpad model so that it can be used to set</span>
<span class="cm">	 * input device-&gt;id.version and be visible to userspace.</span>
<span class="cm">	 * Because version is __u16 we have to drop something.</span>
<span class="cm">	 * Hardware info bits seem to be good candidates as they</span>
<span class="cm">	 * are documented to be for Synaptics corp. internal use.</span>
<span class="cm">	 */</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">model_id</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">model_id</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">absolute_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">protocol_handler</span> <span class="o">=</span> <span class="n">synaptics_process_byte</span><span class="p">;</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Relative mode follows standard PS/2 mouse protocol */</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">protocol_handler</span> <span class="o">=</span> <span class="n">psmouse_process_byte</span><span class="p">;</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">pktsize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">set_rate</span> <span class="o">=</span> <span class="n">synaptics_set_rate</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">synaptics_disconnect</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">reconnect</span> <span class="o">=</span> <span class="n">synaptics_reconnect</span><span class="p">;</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">synaptics_reset</span><span class="p">;</span>
	<span class="cm">/* Synaptics can usually stay in sync without extra help */</span>
	<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">resync_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SYN_CAP_PASS_THROUGH</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">))</span>
		<span class="n">synaptics_pt_create</span><span class="p">(</span><span class="n">psmouse</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Toshiba&#39;s KBC seems to have trouble handling data from</span>
<span class="cm">	 * Synaptics at full rate.  Switch to a lower rate (roughly</span>
<span class="cm">	 * the same rate as a standard PS/2 mouse).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="mi">80</span> <span class="o">&amp;&amp;</span> <span class="n">impaired_toshiba_kbc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmouse_info</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
			     <span class="s">&quot;Toshiba %s detected, limiting rate to 40pps.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">dmi_get_system_info</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">));</span>
		<span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">absolute_mode</span> <span class="o">&amp;&amp;</span> <span class="n">SYN_ID_DISGEST_SUPPORTED</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">identity</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psmouse</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">psmouse_attr_disable_gesture</span><span class="p">.</span><span class="n">dattr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psmouse_err</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span>
				    <span class="s">&quot;Failed to create disable_gesture attribute (%d)&quot;</span><span class="p">,</span>
				    <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">init_fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">init_fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">synaptics_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__synaptics_init</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">synaptics_init_relative</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__synaptics_init</span><span class="p">(</span><span class="n">psmouse</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">synaptics_supported</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_MOUSE_PS2_SYNAPTICS */</span><span class="cp"></span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">synaptics_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">synaptics_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">psmouse</span> <span class="o">*</span><span class="n">psmouse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">synaptics_supported</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_MOUSE_PS2_SYNAPTICS */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
