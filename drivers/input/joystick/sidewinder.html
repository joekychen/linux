<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › joystick › sidewinder.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sidewinder.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (c) 1998-2005 Vojtech Pavlik</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Microsoft SideWinder joystick family driver for Linux</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> * Should you need to contact me, the author, you can do so either by</span>
<span class="cm"> * e-mail - mail your message to &lt;vojtech@ucw.cz&gt;, or by paper mail:</span>
<span class="cm"> * Vojtech Pavlik, Simunkova 1594, Prague 8, 182 00 Czech Republic</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/gameport.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>

<span class="cp">#define DRIVER_DESC	&quot;Microsoft SideWinder joystick family driver&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Vojtech Pavlik &lt;vojtech@ucw.cz&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * These are really magic values. Changing them can make a problem go away,</span>
<span class="cm"> * as well as break everything.</span>
<span class="cm"> */</span>

<span class="cp">#undef SW_DEBUG</span>
<span class="cp">#undef SW_DEBUG_DATA</span>

<span class="cp">#define SW_START	600	</span><span class="cm">/* The time we wait for the first bit [600 us] */</span><span class="cp"></span>
<span class="cp">#define SW_STROBE	60	</span><span class="cm">/* Max time per bit [60 us] */</span><span class="cp"></span>
<span class="cp">#define SW_TIMEOUT	6	</span><span class="cm">/* Wait for everything to settle [6 ms] */</span><span class="cp"></span>
<span class="cp">#define SW_KICK		45	</span><span class="cm">/* Wait after A0 fall till kick [45 us] */</span><span class="cp"></span>
<span class="cp">#define SW_END		8	</span><span class="cm">/* Number of bits before end of packet to kick */</span><span class="cp"></span>
<span class="cp">#define SW_FAIL		16	</span><span class="cm">/* Number of packet read errors to fail and reinitialize */</span><span class="cp"></span>
<span class="cp">#define SW_BAD		2	</span><span class="cm">/* Number of packet read errors to switch off 3d Pro optimization */</span><span class="cp"></span>
<span class="cp">#define SW_OK		64	</span><span class="cm">/* Number of packet read successes to switch optimization back on */</span><span class="cp"></span>
<span class="cp">#define SW_LENGTH	512	</span><span class="cm">/* Max number of bits in a packet */</span><span class="cp"></span>

<span class="cp">#ifdef SW_DEBUG</span>
<span class="cp">#define dbg(format, arg...) printk(KERN_DEBUG __FILE__ &quot;: &quot; format &quot;\n&quot; , ## arg)</span>
<span class="cp">#else</span>
<span class="cp">#define dbg(format, arg...) do {} while (0)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * SideWinder joystick types ...</span>
<span class="cm"> */</span>

<span class="cp">#define SW_ID_3DP	0</span>
<span class="cp">#define SW_ID_GP	1</span>
<span class="cp">#define SW_ID_PP	2</span>
<span class="cp">#define SW_ID_FFP	3</span>
<span class="cp">#define SW_ID_FSP	4</span>
<span class="cp">#define SW_ID_FFW	5</span>

<span class="cm">/*</span>
<span class="cm"> * Names, buttons, axes ...</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sw_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>	<span class="s">&quot;3D Pro&quot;</span><span class="p">,</span> <span class="s">&quot;GamePad&quot;</span><span class="p">,</span> <span class="s">&quot;Precision Pro&quot;</span><span class="p">,</span> <span class="s">&quot;Force Feedback Pro&quot;</span><span class="p">,</span> <span class="s">&quot;FreeStyle Pro&quot;</span><span class="p">,</span>
				<span class="s">&quot;Force Feedback Wheel&quot;</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">sw_abs</span><span class="p">[][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">ABS_RZ</span><span class="p">,</span> <span class="n">ABS_THROTTLE</span><span class="p">,</span> <span class="n">ABS_HAT0X</span><span class="p">,</span> <span class="n">ABS_HAT0Y</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">ABS_Y</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">ABS_RZ</span><span class="p">,</span> <span class="n">ABS_THROTTLE</span><span class="p">,</span> <span class="n">ABS_HAT0X</span><span class="p">,</span> <span class="n">ABS_HAT0Y</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">ABS_RZ</span><span class="p">,</span> <span class="n">ABS_THROTTLE</span><span class="p">,</span> <span class="n">ABS_HAT0X</span><span class="p">,</span> <span class="n">ABS_HAT0Y</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span>         <span class="n">ABS_THROTTLE</span><span class="p">,</span> <span class="n">ABS_HAT0X</span><span class="p">,</span> <span class="n">ABS_HAT0Y</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ABS_RX</span><span class="p">,</span> <span class="n">ABS_RUDDER</span><span class="p">,</span>   <span class="n">ABS_THROTTLE</span> <span class="p">}};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">sw_bit</span><span class="p">[][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span>                 <span class="p">},</span>
	<span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span>     <span class="p">}};</span>

<span class="k">static</span> <span class="kt">short</span> <span class="n">sw_btn</span><span class="p">[][</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">BTN_TRIGGER</span><span class="p">,</span> <span class="n">BTN_TOP</span><span class="p">,</span> <span class="n">BTN_THUMB</span><span class="p">,</span> <span class="n">BTN_THUMB2</span><span class="p">,</span> <span class="n">BTN_BASE</span><span class="p">,</span> <span class="n">BTN_BASE2</span><span class="p">,</span> <span class="n">BTN_BASE3</span><span class="p">,</span> <span class="n">BTN_BASE4</span><span class="p">,</span> <span class="n">BTN_MODE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BTN_A</span><span class="p">,</span> <span class="n">BTN_B</span><span class="p">,</span> <span class="n">BTN_C</span><span class="p">,</span> <span class="n">BTN_X</span><span class="p">,</span> <span class="n">BTN_Y</span><span class="p">,</span> <span class="n">BTN_Z</span><span class="p">,</span> <span class="n">BTN_TL</span><span class="p">,</span> <span class="n">BTN_TR</span><span class="p">,</span> <span class="n">BTN_START</span><span class="p">,</span> <span class="n">BTN_MODE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BTN_TRIGGER</span><span class="p">,</span> <span class="n">BTN_THUMB</span><span class="p">,</span> <span class="n">BTN_TOP</span><span class="p">,</span> <span class="n">BTN_TOP2</span><span class="p">,</span> <span class="n">BTN_BASE</span><span class="p">,</span> <span class="n">BTN_BASE2</span><span class="p">,</span> <span class="n">BTN_BASE3</span><span class="p">,</span> <span class="n">BTN_BASE4</span><span class="p">,</span> <span class="n">BTN_SELECT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BTN_TRIGGER</span><span class="p">,</span> <span class="n">BTN_THUMB</span><span class="p">,</span> <span class="n">BTN_TOP</span><span class="p">,</span> <span class="n">BTN_TOP2</span><span class="p">,</span> <span class="n">BTN_BASE</span><span class="p">,</span> <span class="n">BTN_BASE2</span><span class="p">,</span> <span class="n">BTN_BASE3</span><span class="p">,</span> <span class="n">BTN_BASE4</span><span class="p">,</span> <span class="n">BTN_SELECT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BTN_A</span><span class="p">,</span> <span class="n">BTN_B</span><span class="p">,</span> <span class="n">BTN_C</span><span class="p">,</span> <span class="n">BTN_X</span><span class="p">,</span> <span class="n">BTN_Y</span><span class="p">,</span> <span class="n">BTN_Z</span><span class="p">,</span> <span class="n">BTN_TL</span><span class="p">,</span> <span class="n">BTN_TR</span><span class="p">,</span> <span class="n">BTN_START</span><span class="p">,</span> <span class="n">BTN_MODE</span><span class="p">,</span> <span class="n">BTN_SELECT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">BTN_TRIGGER</span><span class="p">,</span> <span class="n">BTN_TOP</span><span class="p">,</span> <span class="n">BTN_THUMB</span><span class="p">,</span> <span class="n">BTN_THUMB2</span><span class="p">,</span> <span class="n">BTN_BASE</span><span class="p">,</span> <span class="n">BTN_BASE2</span><span class="p">,</span> <span class="n">BTN_BASE3</span><span class="p">,</span> <span class="n">BTN_BASE4</span> <span class="p">}};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span> <span class="n">sw_hat_to_axis</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">}};</span>

<span class="k">struct</span> <span class="n">sw</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">number</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reads</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bads</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * sw_read_packet() is a function which reads either a data packet, or an</span>
<span class="cm"> * identification packet from a SideWinder joystick. The protocol is very,</span>
<span class="cm"> * very, very braindamaged. Microsoft patented it in US patent #5628686.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sw_read_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">bitout</span><span class="p">,</span> <span class="n">sched</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">kick</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">strobe</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pending</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="n">id</span><span class="p">;</span>						<span class="cm">/* Don&#39;t care about data, only want ID */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">id</span> <span class="o">?</span> <span class="n">gameport_time</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="n">SW_TIMEOUT</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Set up global timeout for ID packet */</span>
	<span class="n">kick</span> <span class="o">=</span> <span class="n">id</span> <span class="o">?</span> <span class="n">gameport_time</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="n">SW_KICK</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Set up kick timeout for ID packet */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">gameport_time</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="n">SW_START</span><span class="p">);</span>
	<span class="n">strobe</span> <span class="o">=</span> <span class="n">gameport_time</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="n">SW_STROBE</span><span class="p">);</span>
	<span class="n">bitout</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sched</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>					<span class="cm">/* Quiet, please */</span>

	<span class="n">gameport_trigger</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>				<span class="cm">/* Trigger */</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">gameport_read</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">bitout</span><span class="o">--</span><span class="p">;</span>
		<span class="n">u</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">gameport_read</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">~</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">u</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bitout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">));</span>		<span class="cm">/* Wait for first falling edge on clock */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bitout</span> <span class="o">=</span> <span class="n">strobe</span><span class="p">;</span>				<span class="cm">/* Extend time if not timed out */</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">bitout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="n">bitout</span><span class="o">--</span><span class="p">;</span>					<span class="cm">/* Decrement timers */</span>
		<span class="n">sched</span><span class="o">--</span><span class="p">;</span>

		<span class="n">u</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">gameport_read</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">~</span><span class="n">u</span> <span class="o">&amp;</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bitout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>		<span class="cm">/* Rising edge on clock - data bit */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>				<span class="cm">/* Want this data */</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>		<span class="cm">/* Store it */</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>					<span class="cm">/* Advance index */</span>
			<span class="n">bitout</span> <span class="o">=</span> <span class="n">strobe</span><span class="p">;</span>			<span class="cm">/* Extend timeout for next bit */</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kick</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">u</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>			<span class="cm">/* Falling edge on axis 0 */</span>
			<span class="n">sched</span> <span class="o">=</span> <span class="n">kick</span><span class="p">;</span>				<span class="cm">/* Schedule second trigger */</span>
			<span class="n">kick</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>				<span class="cm">/* Don&#39;t schedule next time on falling edge */</span>
			<span class="n">pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>				<span class="cm">/* Mark schedule */</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&amp;&amp;</span> <span class="n">sched</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">SW_END</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* Second trigger time */</span>
			<span class="n">gameport_trigger</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>		<span class="cm">/* Trigger */</span>
			<span class="n">bitout</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>				<span class="cm">/* Long bit timeout */</span>
			<span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>				<span class="cm">/* Unmark schedule */</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>				<span class="cm">/* Switch from global to bit timeouts */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>					<span class="cm">/* Done - relax */</span>

<span class="cp">#ifdef SW_DEBUG_DATA</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sidewinder.c: Read %d triplets. [&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sw_get_bits() and GB() compose bits from the triplet buffer into a __u64.</span>
<span class="cm"> * Parameter &#39;pos&#39; is bit number inside packet where to start at, &#39;num&#39; is number</span>
<span class="cm"> * of bits to be read, &#39;shift&#39; is offset in the resulting __u64 to start at, bits</span>
<span class="cm"> * is number of bits per triplet.</span>
<span class="cm"> */</span>

<span class="cp">#define GB(pos,num) sw_get_bits(buf, pos, num, sw-&gt;bits)</span>

<span class="k">static</span> <span class="n">__u64</span> <span class="nf">sw_get_bits</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">char</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u64</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tri</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">%</span> <span class="n">bits</span><span class="p">;</span>						<span class="cm">/* Start position */</span>
	<span class="kt">int</span> <span class="n">i</span>   <span class="o">=</span> <span class="n">pos</span> <span class="o">/</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)((</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">tri</span><span class="o">++</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* Transfer bit */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tri</span> <span class="o">==</span> <span class="n">bits</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>						<span class="cm">/* Next triplet */</span>
			<span class="n">tri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sw_init_digital() initializes a SideWinder 3D Pro joystick</span>
<span class="cm"> * into digital mode.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sw_init_digital</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">seq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">140</span><span class="o">+</span><span class="mi">725</span><span class="p">,</span> <span class="mi">140</span><span class="o">+</span><span class="mi">300</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>

        <span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
                <span class="n">gameport_trigger</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>			<span class="cm">/* Trigger */</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">gameport_time</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="n">SW_TIMEOUT</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">gameport_read</span><span class="p">(</span><span class="n">gameport</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">t</span><span class="p">)</span> <span class="n">t</span><span class="o">--</span><span class="p">;</span>	<span class="cm">/* Wait for axis to fall back to 0 */</span>
                <span class="n">udelay</span><span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>					<span class="cm">/* Delay magic time */</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">gameport_trigger</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>				<span class="cm">/* Last trigger */</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sw_parity() computes parity of __u64</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sw_parity</span><span class="p">(</span><span class="n">__u64</span> <span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">t</span> <span class="o">^</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">x</span> <span class="o">^=</span> <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">x</span> <span class="o">^=</span> <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">x</span> <span class="o">^=</span> <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">x</span> <span class="o">^=</span> <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">x</span> <span class="o">^=</span> <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">x</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sw_ccheck() checks synchronization bits and computes checksum of nibbles.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sw_check</span><span class="p">(</span><span class="n">__u64</span> <span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">t</span> <span class="o">&amp;</span> <span class="mh">0x8080808080808080ULL</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x80</span><span class="p">)</span>			<span class="cm">/* Sync */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>						<span class="cm">/* Sum */</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">t</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">t</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sum</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sw_parse() analyzes SideWinder joystick data, and writes the results into</span>
<span class="cm"> * the axes and buttons arrays.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sw_parse</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sw</span> <span class="o">*</span><span class="n">sw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hat</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">SW_ID_3DP</span>:

			<span class="k">if</span> <span class="p">(</span><span class="n">sw_check</span><span class="p">(</span><span class="n">GB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">64</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">hat</span> <span class="o">=</span> <span class="p">(</span><span class="n">GB</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">GB</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

			<span class="n">dev</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span>        <span class="p">(</span><span class="n">GB</span><span class="p">(</span> <span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">GB</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">7</span><span class="p">));</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span>        <span class="p">(</span><span class="n">GB</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">GB</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="mi">7</span><span class="p">));</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_RZ</span><span class="p">,</span>       <span class="p">(</span><span class="n">GB</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">GB</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="mi">7</span><span class="p">));</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_THROTTLE</span><span class="p">,</span> <span class="p">(</span><span class="n">GB</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">GB</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span><span class="mi">7</span><span class="p">));</span>

			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_HAT0X</span><span class="p">,</span> <span class="n">sw_hat_to_axis</span><span class="p">[</span><span class="n">hat</span><span class="p">].</span><span class="n">x</span><span class="p">);</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_HAT0Y</span><span class="p">,</span> <span class="n">sw_hat_to_axis</span><span class="p">[</span><span class="n">hat</span><span class="p">].</span><span class="n">y</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sw_btn</span><span class="p">[</span><span class="n">SW_ID_3DP</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="o">!</span><span class="n">GB</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>

			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_BASE4</span><span class="p">,</span> <span class="o">!</span><span class="n">GB</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_BASE5</span><span class="p">,</span> <span class="o">!</span><span class="n">GB</span><span class="p">(</span><span class="mi">37</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>

			<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SW_ID_GP</span>:

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">sw_parity</span><span class="p">(</span><span class="n">GB</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

				<span class="n">input_report_abs</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">GB</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">15</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">GB</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">15</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
				<span class="n">input_report_abs</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">GB</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">15</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">GB</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">15</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
					<span class="n">input_report_key</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sw_btn</span><span class="p">[</span><span class="n">SW_ID_GP</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="o">!</span><span class="n">GB</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">15</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>

				<span class="n">input_sync</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SW_ID_PP</span>:
		<span class="k">case</span> <span class="n">SW_ID_FFP</span>:

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sw_parity</span><span class="p">(</span><span class="n">GB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">48</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">hat</span> <span class="o">=</span> <span class="n">GB</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

			<span class="n">dev</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span>        <span class="n">GB</span><span class="p">(</span> <span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">));</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span>        <span class="n">GB</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span><span class="mi">10</span><span class="p">));</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_RZ</span><span class="p">,</span>       <span class="n">GB</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_THROTTLE</span><span class="p">,</span> <span class="n">GB</span><span class="p">(</span><span class="mi">29</span><span class="p">,</span> <span class="mi">7</span><span class="p">));</span>

			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_HAT0X</span><span class="p">,</span> <span class="n">sw_hat_to_axis</span><span class="p">[</span><span class="n">hat</span><span class="p">].</span><span class="n">x</span><span class="p">);</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_HAT0Y</span><span class="p">,</span> <span class="n">sw_hat_to_axis</span><span class="p">[</span><span class="n">hat</span><span class="p">].</span><span class="n">y</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sw_btn</span><span class="p">[</span><span class="n">SW_ID_PP</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="o">!</span><span class="n">GB</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>

			<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SW_ID_FSP</span>:

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sw_parity</span><span class="p">(</span><span class="n">GB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">43</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">hat</span> <span class="o">=</span> <span class="n">GB</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

			<span class="n">dev</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span>        <span class="n">GB</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">));</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span>        <span class="n">GB</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">10</span><span class="p">));</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_THROTTLE</span><span class="p">,</span> <span class="n">GB</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>

			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_HAT0X</span><span class="p">,</span> <span class="n">sw_hat_to_axis</span><span class="p">[</span><span class="n">hat</span><span class="p">].</span><span class="n">x</span><span class="p">);</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_HAT0Y</span><span class="p">,</span> <span class="n">sw_hat_to_axis</span><span class="p">[</span><span class="n">hat</span><span class="p">].</span><span class="n">y</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sw_btn</span><span class="p">[</span><span class="n">SW_ID_FSP</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="o">!</span><span class="n">GB</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>

			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TR</span><span class="p">,</span>     <span class="o">!</span><span class="n">GB</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_START</span><span class="p">,</span>  <span class="o">!</span><span class="n">GB</span><span class="p">(</span><span class="mi">27</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_MODE</span><span class="p">,</span>   <span class="o">!</span><span class="n">GB</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_SELECT</span><span class="p">,</span> <span class="o">!</span><span class="n">GB</span><span class="p">(</span><span class="mi">39</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>

			<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SW_ID_FFW</span>:

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sw_parity</span><span class="p">(</span><span class="n">GB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">33</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

			<span class="n">dev</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_RX</span><span class="p">,</span>       <span class="n">GB</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">));</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_RUDDER</span><span class="p">,</span>   <span class="n">GB</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_THROTTLE</span><span class="p">,</span> <span class="n">GB</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sw_btn</span><span class="p">[</span><span class="n">SW_ID_FFW</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="o">!</span><span class="n">GB</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">22</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>

			<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sw_read() reads SideWinder joystick data, and reinitializes</span>
<span class="cm"> * the joystick in case of persistent problems. This is the function that is</span>
<span class="cm"> * called from the generic code to poll the joystick.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sw_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">sw</span> <span class="o">*</span><span class="n">sw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">SW_LENGTH</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">sw_read_packet</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SW_ID_3DP</span> <span class="o">&amp;&amp;</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">66</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">66</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* Broken packet, try to fix */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">64</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sw_check</span><span class="p">(</span><span class="n">sw_get_bits</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>		<span class="cm">/* Last init failed, 1 bit mode */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;sidewinder.c: Joystick in wrong mode on %s&quot;</span>
				<span class="s">&quot; - going to reinitialize.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">fail</span> <span class="o">=</span> <span class="n">SW_FAIL</span><span class="p">;</span>					<span class="cm">/* Reinitialize */</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>						<span class="cm">/* Bogus value */</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">66</span> <span class="o">&amp;&amp;</span> <span class="n">GB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">64</span><span class="p">)</span> <span class="o">==</span> <span class="n">GB</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">-</span><span class="mi">66</span><span class="p">,</span><span class="mi">64</span><span class="p">))</span>			<span class="cm">/* 1 == 3 */</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">66</span><span class="p">;</span>							<span class="cm">/* Everything is fine */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">66</span> <span class="o">&amp;&amp;</span> <span class="n">GB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">64</span><span class="p">)</span> <span class="o">==</span> <span class="n">GB</span><span class="p">(</span><span class="mi">66</span><span class="p">,</span><span class="mi">64</span><span class="p">))</span>				<span class="cm">/* 1 == 2 */</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">66</span><span class="p">;</span>							<span class="cm">/* Everything is fine */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">66</span> <span class="o">&amp;&amp;</span> <span class="n">GB</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">-</span><span class="mi">132</span><span class="p">,</span><span class="mi">64</span><span class="p">)</span> <span class="o">==</span> <span class="n">GB</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">-</span><span class="mi">66</span><span class="p">,</span><span class="mi">64</span><span class="p">))</span> <span class="p">{</span>		<span class="cm">/* 2 == 3 */</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">);</span>				<span class="cm">/* Move data */</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">66</span><span class="p">;</span>							<span class="cm">/* Carry on */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sw_parse</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">sw</span><span class="p">))</span> <span class="p">{</span>				<span class="cm">/* Parse data */</span>

		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">ok</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SW_ID_3DP</span> <span class="o">&amp;&amp;</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">66</span>			<span class="cm">/* Many packets OK */</span>
			<span class="o">&amp;&amp;</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">ok</span> <span class="o">&gt;</span> <span class="n">SW_OK</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sidewinder.c: No more trouble on %s&quot;</span>
				<span class="s">&quot; - enabling optimization again.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">fail</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SW_ID_3DP</span> <span class="o">&amp;&amp;</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">22</span> <span class="o">&amp;&amp;</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">fail</span> <span class="o">&gt;</span> <span class="n">SW_BAD</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Consecutive bad packets */</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sidewinder.c: Many bit errors on %s&quot;</span>
			<span class="s">&quot; - disabling optimization.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">66</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">fail</span> <span class="o">&lt;</span> <span class="n">SW_FAIL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>							<span class="cm">/* Not enough, don&#39;t reinitialize yet */</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;sidewinder.c: Too many bit errors on %s&quot;</span>
		<span class="s">&quot; - reinitializing joystick.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SW_ID_3DP</span><span class="p">)</span> <span class="p">{</span>					<span class="cm">/* 3D Pro can be in analog mode */</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">SW_TIMEOUT</span><span class="p">);</span>
		<span class="n">sw_init_digital</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="n">SW_TIMEOUT</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">sw_read_packet</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">SW_LENGTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>			<span class="cm">/* Read normal data packet */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">SW_TIMEOUT</span><span class="p">);</span>
	<span class="n">sw_read_packet</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">SW_LENGTH</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>			<span class="cm">/* Read ID packet, this initializes the stick */</span>

	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">fail</span> <span class="o">=</span> <span class="n">SW_FAIL</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sw_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sw</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">gameport_get_drvdata</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>

	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">reads</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sw_read</span><span class="p">(</span><span class="n">sw</span><span class="p">))</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">bads</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sw_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sw</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">gameport_start_polling</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sw_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sw</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">gameport_stop_polling</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">gameport</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sw_print_packet() prints the contents of a SideWinder packet.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sw_print_packet</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sidewinder.c: %s packet, %d bits. [&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(((</span><span class="n">length</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sw_get_bits</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">bits</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sw_3dp_id() translates the 3DP id into a human legible string.</span>
<span class="cm"> * Unfortunately I don&#39;t know how to do this for the other SW types.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sw_3dp_id</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">comment</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">pnp</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">rev</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>						<span class="cm">/* ASCII PnP ID */</span>
		<span class="n">pnp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sw_get_bits</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">24</span><span class="o">+</span><span class="mi">8</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>						<span class="cm">/* ASCII firmware revision */</span>
		<span class="n">rev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sw_get_bits</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">88</span><span class="o">+</span><span class="mi">8</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pnp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">rev</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot; [PnP %d.%02d id %s rev %s]&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="n">sw_get_bits</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>		<span class="cm">/* Two 6-bit values */</span>
			<span class="n">sw_get_bits</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="n">sw_get_bits</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">sw_get_bits</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">%</span> <span class="mi">100</span><span class="p">,</span>
		 <span class="n">pnp</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sw_guess_mode() checks the upper two button bits for toggling -</span>
<span class="cm"> * indication of that the joystick is in 3-bit mode. This is documented</span>
<span class="cm"> * behavior for 3DP ID packet, and for example the FSP does this in</span>
<span class="cm"> * normal packets instead. Fun ...</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sw_guess_mode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">xor</span> <span class="o">|=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mi">6</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">!!</span><span class="n">xor</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sw_connect() probes for SideWinder type joysticks.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sw_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gameport_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sw</span> <span class="o">*</span><span class="n">sw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* [SW_LENGTH] */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">idbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* [SW_LENGTH] */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">comment</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>

	<span class="n">comment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sw</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sw</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">SW_LENGTH</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">idbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">SW_LENGTH</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sw</span> <span class="o">||</span> <span class="o">!</span><span class="n">buf</span> <span class="o">||</span> <span class="o">!</span><span class="n">idbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">gameport</span> <span class="o">=</span> <span class="n">gameport</span><span class="p">;</span>

	<span class="n">gameport_set_drvdata</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="n">sw</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">gameport_open</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="n">drv</span><span class="p">,</span> <span class="n">GAMEPORT_MODE_RAW</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Init 0: Opened %s, io %#x, speed %d&quot;</span><span class="p">,</span>
		<span class="n">gameport</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="n">gameport</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">,</span> <span class="n">gameport</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">sw_read_packet</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">SW_LENGTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* Read normal packet */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">SW_TIMEOUT</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Init 1: Mode %d. Length %d.&quot;</span><span class="p">,</span> <span class="n">m</span> <span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>							<span class="cm">/* No data. 3d Pro analog mode? */</span>
		<span class="n">sw_init_digital</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>				<span class="cm">/* Switch to digital */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">SW_TIMEOUT</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">sw_read_packet</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">SW_LENGTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Retry reading packet */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">SW_TIMEOUT</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Init 1b: Length %d.&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>						<span class="cm">/* No data -&gt; FAIL */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">j</span> <span class="o">=</span> <span class="n">sw_read_packet</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="n">idbuf</span><span class="p">,</span> <span class="n">SW_LENGTH</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>		<span class="cm">/* Read ID. This initializes the stick */</span>
	<span class="n">m</span> <span class="o">|=</span> <span class="n">sw_guess_mode</span><span class="p">(</span><span class="n">idbuf</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>					<span class="cm">/* ID packet should carry mode info [3DP] */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Init 2: Mode %d. ID Length %d.&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>							<span class="cm">/* Read ID failed. Happens in 1-bit mode on PP */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">SW_TIMEOUT</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">sw_read_packet</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">SW_LENGTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Retry reading packet */</span>
		<span class="n">m</span> <span class="o">|=</span> <span class="n">sw_guess_mode</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Init 2b: Mode %d. Length %d.&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">SW_TIMEOUT</span><span class="p">);</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">sw_read_packet</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="n">idbuf</span><span class="p">,</span> <span class="n">SW_LENGTH</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>	<span class="cm">/* Retry reading ID */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Init 2c: ID Length %d.&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">k</span> <span class="o">=</span> <span class="n">SW_FAIL</span><span class="p">;</span>							<span class="cm">/* Try SW_FAIL times */</span>
	<span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">k</span><span class="o">--</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">SW_TIMEOUT</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">sw_read_packet</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">SW_LENGTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Read data packet */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Init 3: Mode %d. Length %d. Last %d. Tries %d.&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">l</span><span class="p">)</span> <span class="p">{</span>						<span class="cm">/* Longer? As we can only lose bits, it makes */</span>
									<span class="cm">/* no sense to try detection for a packet shorter */</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>						<span class="cm">/* than the previous one */</span>

			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">gameport</span> <span class="o">=</span> <span class="n">gameport</span><span class="p">;</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>

			<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Init 3a: Case %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">m</span><span class="p">);</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">60</span>:
					<span class="n">sw</span><span class="o">-&gt;</span><span class="n">number</span><span class="o">++</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">45</span>:				<span class="cm">/* Ambiguous packet length */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">40</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* ID length less or eq 40 -&gt; FSP */</span>
				<span class="k">case</span> <span class="mi">43</span>:
						<span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SW_ID_FSP</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">sw</span><span class="o">-&gt;</span><span class="n">number</span><span class="o">++</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">30</span>:
					<span class="n">sw</span><span class="o">-&gt;</span><span class="n">number</span><span class="o">++</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">15</span>:
					<span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SW_ID_GP</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">33</span>:
				<span class="k">case</span> <span class="mi">31</span>:
					<span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SW_ID_FFW</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">48</span>:				<span class="cm">/* Ambiguous */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* ID length 14*3 -&gt; FFP */</span>
						<span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SW_ID_FFP</span><span class="p">;</span>
						<span class="n">sprintf</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="s">&quot; [AC %s]&quot;</span><span class="p">,</span> <span class="n">sw_get_bits</span><span class="p">(</span><span class="n">idbuf</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;off&quot;</span> <span class="o">:</span> <span class="s">&quot;on&quot;</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SW_ID_PP</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">66</span>:
					<span class="n">sw</span><span class="o">-&gt;</span><span class="n">bits</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">198</span>:
					<span class="n">sw</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">64</span>:
					<span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SW_ID_3DP</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">160</span><span class="p">)</span>
						<span class="n">sw_3dp_id</span><span class="p">(</span><span class="n">idbuf</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">comment</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">k</span> <span class="o">&amp;&amp;</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;sidewinder.c: unknown joystick device detected &quot;</span>
			<span class="s">&quot;on %s, contact &lt;vojtech@ucw.cz&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gameport</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">sw_print_packet</span><span class="p">(</span><span class="s">&quot;ID&quot;</span><span class="p">,</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">idbuf</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">sw_print_packet</span><span class="p">(</span><span class="s">&quot;Data&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">m</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef SW_DEBUG</span>
	<span class="n">sw_print_packet</span><span class="p">(</span><span class="s">&quot;ID&quot;</span><span class="p">,</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">idbuf</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">sw_print_packet</span><span class="p">(</span><span class="s">&quot;Data&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">m</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">gameport_set_poll_handler</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="n">sw_poll</span><span class="p">);</span>
	<span class="n">gameport_set_poll_interval</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>

	<span class="n">k</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bits</span><span class="p">,</span> <span class="n">code</span><span class="p">;</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
			 <span class="s">&quot;Microsoft SideWinder %s&quot;</span><span class="p">,</span> <span class="n">sw_name</span><span class="p">[</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">]);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
			 <span class="s">&quot;%s/input%d&quot;</span><span class="p">,</span> <span class="n">gameport</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_GAMEPORT</span><span class="p">;</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">GAMEPORT_ID_VENDOR_MICROSOFT</span><span class="p">;</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">;</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gameport</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

		<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">sw</span><span class="p">);</span>

		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">sw_open</span><span class="p">;</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">sw_close</span><span class="p">;</span>

		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">bits</span> <span class="o">=</span> <span class="n">sw_bit</span><span class="p">[</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">fuzz</span><span class="p">,</span> <span class="n">flat</span><span class="p">;</span>

			<span class="n">code</span> <span class="o">=</span> <span class="n">sw_abs</span><span class="p">[</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
			<span class="n">min</span> <span class="o">=</span> <span class="n">bits</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">fuzz</span> <span class="o">=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">bits</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">flat</span> <span class="o">=</span> <span class="n">code</span> <span class="o">==</span> <span class="n">ABS_THROTTLE</span> <span class="o">||</span> <span class="n">bits</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">?</span>
				<span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">5</span><span class="p">);</span>

			<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span>
					     <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">fuzz</span><span class="p">,</span> <span class="n">flat</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">code</span> <span class="o">=</span> <span class="n">sw_btn</span><span class="p">[</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;%s%s [%d-bit id %d data %d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail4</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">idbuf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

 <span class="nl">fail4:</span>	<span class="n">input_free_device</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
 <span class="nl">fail3:</span>	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
 <span class="nl">fail2:</span>	<span class="n">gameport_close</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>
 <span class="nl">fail1:</span>	<span class="n">gameport_set_drvdata</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sw</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sw_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sw</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">gameport_get_drvdata</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">gameport_close</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>
	<span class="n">gameport_set_drvdata</span><span class="p">(</span><span class="n">gameport</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gameport_driver</span> <span class="n">sw_drv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;sidewinder&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">description</span>	<span class="o">=</span> <span class="n">DRIVER_DESC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span>	<span class="o">=</span> <span class="n">sw_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">sw_disconnect</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_gameport_driver</span><span class="p">(</span><span class="n">sw_drv</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
