<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › joystick › xpad.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>xpad.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * X-Box gamepad driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2002 Marko Friedemann &lt;mfr@bmx-chemnitz.de&gt;</span>
<span class="cm"> *               2004 Oliver Schwartz &lt;Oliver.Schwartz@gmx.de&gt;,</span>
<span class="cm"> *                    Steven Toth &lt;steve@toth.demon.co.uk&gt;,</span>
<span class="cm"> *                    Franz Lehner &lt;franz@caos.at&gt;,</span>
<span class="cm"> *                    Ivan Hawkes &lt;blackhawk@ivanhawkes.com&gt;</span>
<span class="cm"> *               2005 Dominic Cerquetti &lt;binary1230@yahoo.com&gt;</span>
<span class="cm"> *               2006 Adam Buchbinder &lt;adam.buchbinder@gmail.com&gt;</span>
<span class="cm"> *               2007 Jan Kratochvil &lt;honza@jikos.cz&gt;</span>
<span class="cm"> *               2010 Christoph Fritz &lt;chf.fritz@googlemail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; either version 2 of</span>
<span class="cm"> * the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is based on:</span>
<span class="cm"> *  - information from     http://euc.jp/periphs/xbox-controller.ja.html</span>
<span class="cm"> *  - the iForce driver    drivers/char/joystick/iforce.c</span>
<span class="cm"> *  - the skeleton-driver  drivers/usb/usb-skeleton.c</span>
<span class="cm"> *  - Xbox 360 information http://www.free60.org/wiki/Gamepad</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to:</span>
<span class="cm"> *  - ITO Takayuki for providing essential xpad information on his website</span>
<span class="cm"> *  - Vojtech Pavlik     - iforce driver / input subsystem</span>
<span class="cm"> *  - Greg Kroah-Hartman - usb-skeleton driver</span>
<span class="cm"> *  - XBOX Linux project - extra USB id&#39;s</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> *  - fine tune axes (especially trigger axes)</span>
<span class="cm"> *  - fix &quot;analog&quot; buttons (reported as digital now)</span>
<span class="cm"> *  - get rumble working</span>
<span class="cm"> *  - need USB IDs for other dance pads</span>
<span class="cm"> *</span>
<span class="cm"> * History:</span>
<span class="cm"> *</span>
<span class="cm"> * 2002-06-27 - 0.0.1 : first version, just said &quot;XBOX HID controller&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * 2002-07-02 - 0.0.2 : basic working version</span>
<span class="cm"> *  - all axes and 9 of the 10 buttons work (german InterAct device)</span>
<span class="cm"> *  - the black button does not work</span>
<span class="cm"> *</span>
<span class="cm"> * 2002-07-14 - 0.0.3 : rework by Vojtech Pavlik</span>
<span class="cm"> *  - indentation fixes</span>
<span class="cm"> *  - usb + input init sequence fixes</span>
<span class="cm"> *</span>
<span class="cm"> * 2002-07-16 - 0.0.4 : minor changes, merge with Vojtech&#39;s v0.0.3</span>
<span class="cm"> *  - verified the lack of HID and report descriptors</span>
<span class="cm"> *  - verified that ALL buttons WORK</span>
<span class="cm"> *  - fixed d-pad to axes mapping</span>
<span class="cm"> *</span>
<span class="cm"> * 2002-07-17 - 0.0.5 : simplified d-pad handling</span>
<span class="cm"> *</span>
<span class="cm"> * 2004-10-02 - 0.0.6 : DDR pad support</span>
<span class="cm"> *  - borrowed from the XBOX linux kernel</span>
<span class="cm"> *  - USB id&#39;s for commonly used dance pads are present</span>
<span class="cm"> *  - dance pads will map D-PAD to buttons, not axes</span>
<span class="cm"> *  - pass the module paramater &#39;dpad_to_buttons&#39; to force</span>
<span class="cm"> *    the D-PAD to map to buttons if your pad is not detected</span>
<span class="cm"> *</span>
<span class="cm"> * Later changes can be tracked in SCM.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/usb/input.h&gt;</span>

<span class="cp">#define DRIVER_AUTHOR &quot;Marko Friedemann &lt;mfr@bmx-chemnitz.de&gt;&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;X-Box pad driver&quot;</span>

<span class="cp">#define XPAD_PKT_LEN 32</span>

<span class="cm">/* xbox d-pads should map to buttons, as is required for DDR pads</span>
<span class="cm">   but we map them to axes when possible to simplify things */</span>
<span class="cp">#define MAP_DPAD_TO_BUTTONS		(1 &lt;&lt; 0)</span>
<span class="cp">#define MAP_TRIGGERS_TO_BUTTONS		(1 &lt;&lt; 1)</span>
<span class="cp">#define MAP_STICKS_TO_NULL		(1 &lt;&lt; 2)</span>
<span class="cp">#define DANCEPAD_MAP_CONFIG	(MAP_DPAD_TO_BUTTONS |			\</span>
<span class="cp">				MAP_TRIGGERS_TO_BUTTONS | MAP_STICKS_TO_NULL)</span>

<span class="cp">#define XTYPE_XBOX        0</span>
<span class="cp">#define XTYPE_XBOX360     1</span>
<span class="cp">#define XTYPE_XBOX360W    2</span>
<span class="cp">#define XTYPE_UNKNOWN     3</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">dpad_to_buttons</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dpad_to_buttons</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dpad_to_buttons</span><span class="p">,</span> <span class="s">&quot;Map D-PAD to buttons rather than axes for unknown pads&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">triggers_to_buttons</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">triggers_to_buttons</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">triggers_to_buttons</span><span class="p">,</span> <span class="s">&quot;Map triggers to buttons rather than axes for unknown pads&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">sticks_to_null</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">sticks_to_null</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sticks_to_null</span><span class="p">,</span> <span class="s">&quot;Do not map sticks at all for unknown pads&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">xpad_device</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">idVendor</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">idProduct</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">xtype</span><span class="p">;</span>
<span class="p">}</span> <span class="n">xpad_device</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x045e</span><span class="p">,</span> <span class="mh">0x0202</span><span class="p">,</span> <span class="s">&quot;Microsoft X-Box pad v1 (US)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x045e</span><span class="p">,</span> <span class="mh">0x0289</span><span class="p">,</span> <span class="s">&quot;Microsoft X-Box pad v2 (US)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x045e</span><span class="p">,</span> <span class="mh">0x0285</span><span class="p">,</span> <span class="s">&quot;Microsoft X-Box pad (Japan)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x045e</span><span class="p">,</span> <span class="mh">0x0287</span><span class="p">,</span> <span class="s">&quot;Microsoft Xbox Controller S&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x045e</span><span class="p">,</span> <span class="mh">0x0719</span><span class="p">,</span> <span class="s">&quot;Xbox 360 Wireless Receiver&quot;</span><span class="p">,</span> <span class="n">MAP_DPAD_TO_BUTTONS</span><span class="p">,</span> <span class="n">XTYPE_XBOX360W</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0c12</span><span class="p">,</span> <span class="mh">0x8809</span><span class="p">,</span> <span class="s">&quot;RedOctane Xbox Dance Pad&quot;</span><span class="p">,</span> <span class="n">DANCEPAD_MAP_CONFIG</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x044f</span><span class="p">,</span> <span class="mh">0x0f07</span><span class="p">,</span> <span class="s">&quot;Thrustmaster, Inc. Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x046d</span><span class="p">,</span> <span class="mh">0xc242</span><span class="p">,</span> <span class="s">&quot;Logitech Chillstream Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x046d</span><span class="p">,</span> <span class="mh">0xca84</span><span class="p">,</span> <span class="s">&quot;Logitech Xbox Cordless Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x046d</span><span class="p">,</span> <span class="mh">0xca88</span><span class="p">,</span> <span class="s">&quot;Logitech Compact Controller for Xbox&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x05fd</span><span class="p">,</span> <span class="mh">0x1007</span><span class="p">,</span> <span class="s">&quot;Mad Catz Controller (unverified)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x05fd</span><span class="p">,</span> <span class="mh">0x107a</span><span class="p">,</span> <span class="s">&quot;InterAct &#39;PowerPad Pro&#39; X-Box pad (Germany)&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0738</span><span class="p">,</span> <span class="mh">0x4516</span><span class="p">,</span> <span class="s">&quot;Mad Catz Control Pad&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0738</span><span class="p">,</span> <span class="mh">0x4522</span><span class="p">,</span> <span class="s">&quot;Mad Catz LumiCON&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0738</span><span class="p">,</span> <span class="mh">0x4526</span><span class="p">,</span> <span class="s">&quot;Mad Catz Control Pad Pro&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0738</span><span class="p">,</span> <span class="mh">0x4536</span><span class="p">,</span> <span class="s">&quot;Mad Catz MicroCON&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0738</span><span class="p">,</span> <span class="mh">0x4540</span><span class="p">,</span> <span class="s">&quot;Mad Catz Beat Pad&quot;</span><span class="p">,</span> <span class="n">MAP_DPAD_TO_BUTTONS</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0738</span><span class="p">,</span> <span class="mh">0x4556</span><span class="p">,</span> <span class="s">&quot;Mad Catz Lynx Wireless Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0738</span><span class="p">,</span> <span class="mh">0x4716</span><span class="p">,</span> <span class="s">&quot;Mad Catz Wired Xbox 360 Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0738</span><span class="p">,</span> <span class="mh">0x4738</span><span class="p">,</span> <span class="s">&quot;Mad Catz Wired Xbox 360 Controller (SFIV)&quot;</span><span class="p">,</span> <span class="n">MAP_TRIGGERS_TO_BUTTONS</span><span class="p">,</span> <span class="n">XTYPE_XBOX360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0738</span><span class="p">,</span> <span class="mh">0x6040</span><span class="p">,</span> <span class="s">&quot;Mad Catz Beat Pad Pro&quot;</span><span class="p">,</span> <span class="n">MAP_DPAD_TO_BUTTONS</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0c12</span><span class="p">,</span> <span class="mh">0x8802</span><span class="p">,</span> <span class="s">&quot;Zeroplus Xbox Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0c12</span><span class="p">,</span> <span class="mh">0x880a</span><span class="p">,</span> <span class="s">&quot;Pelican Eclipse PL-2023&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0c12</span><span class="p">,</span> <span class="mh">0x8810</span><span class="p">,</span> <span class="s">&quot;Zeroplus Xbox Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0c12</span><span class="p">,</span> <span class="mh">0x9902</span><span class="p">,</span> <span class="s">&quot;HAMA VibraX - *FAULTY HARDWARE*&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0e4c</span><span class="p">,</span> <span class="mh">0x1097</span><span class="p">,</span> <span class="s">&quot;Radica Gamester Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0e4c</span><span class="p">,</span> <span class="mh">0x2390</span><span class="p">,</span> <span class="s">&quot;Radica Games Jtech Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0e6f</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="s">&quot;Logic3 Freebird wireless Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0e6f</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="s">&quot;Eclipse wireless Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0e6f</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="s">&quot;Edge wireless Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0e6f</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="s">&quot;Pelican &#39;TSZ&#39; Wired Xbox 360 Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0e6f</span><span class="p">,</span> <span class="mh">0x0201</span><span class="p">,</span> <span class="s">&quot;Pelican PL-3601 &#39;TSZ&#39; Wired Xbox 360 Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0e8f</span><span class="p">,</span> <span class="mh">0x0201</span><span class="p">,</span> <span class="s">&quot;SmartJoy Frag Xpad/PS2 adaptor&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0f30</span><span class="p">,</span> <span class="mh">0x0202</span><span class="p">,</span> <span class="s">&quot;Joytech Advanced Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0f30</span><span class="p">,</span> <span class="mh">0x8888</span><span class="p">,</span> <span class="s">&quot;BigBen XBMiniPad Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x102c</span><span class="p">,</span> <span class="mh">0xff0c</span><span class="p">,</span> <span class="s">&quot;Joytech Wireless Advanced Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x12ab</span><span class="p">,</span> <span class="mh">0x8809</span><span class="p">,</span> <span class="s">&quot;Xbox DDR dancepad&quot;</span><span class="p">,</span> <span class="n">MAP_DPAD_TO_BUTTONS</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x12ab</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="s">&quot;Honey Bee Xbox360 dancepad&quot;</span><span class="p">,</span> <span class="n">MAP_DPAD_TO_BUTTONS</span><span class="p">,</span> <span class="n">XTYPE_XBOX360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0e6f</span><span class="p">,</span> <span class="mh">0x0105</span><span class="p">,</span> <span class="s">&quot;HSM3 Xbox360 dancepad&quot;</span><span class="p">,</span> <span class="n">MAP_DPAD_TO_BUTTONS</span><span class="p">,</span> <span class="n">XTYPE_XBOX360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1430</span><span class="p">,</span> <span class="mh">0x4748</span><span class="p">,</span> <span class="s">&quot;RedOctane Guitar Hero X-plorer&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1430</span><span class="p">,</span> <span class="mh">0x8888</span><span class="p">,</span> <span class="s">&quot;TX6500+ Dance Pad (first generation)&quot;</span><span class="p">,</span> <span class="n">MAP_DPAD_TO_BUTTONS</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x146b</span><span class="p">,</span> <span class="mh">0x0601</span><span class="p">,</span> <span class="s">&quot;BigBen Interactive XBOX 360 Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x045e</span><span class="p">,</span> <span class="mh">0x028e</span><span class="p">,</span> <span class="s">&quot;Microsoft X-Box 360 pad&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1bad</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="s">&quot;Harmonix Rock Band Guitar&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1bad</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="s">&quot;Harmonix Rock Band Drumkit&quot;</span><span class="p">,</span> <span class="n">MAP_DPAD_TO_BUTTONS</span><span class="p">,</span> <span class="n">XTYPE_XBOX360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0f0d</span><span class="p">,</span> <span class="mh">0x0016</span><span class="p">,</span> <span class="s">&quot;Hori Real Arcade Pro.EX&quot;</span><span class="p">,</span> <span class="n">MAP_TRIGGERS_TO_BUTTONS</span><span class="p">,</span> <span class="n">XTYPE_XBOX360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0f0d</span><span class="p">,</span> <span class="mh">0x000d</span><span class="p">,</span> <span class="s">&quot;Hori Fighting Stick EX2&quot;</span><span class="p">,</span> <span class="n">MAP_TRIGGERS_TO_BUTTONS</span><span class="p">,</span> <span class="n">XTYPE_XBOX360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="s">&quot;Chinese-made Xbox Controller&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_XBOX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="s">&quot;Generic X-Box pad&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_UNKNOWN</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* buttons shared with xbox and xbox360 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">signed</span> <span class="kt">short</span> <span class="n">xpad_common_btn</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BTN_A</span><span class="p">,</span> <span class="n">BTN_B</span><span class="p">,</span> <span class="n">BTN_X</span><span class="p">,</span> <span class="n">BTN_Y</span><span class="p">,</span>			<span class="cm">/* &quot;analog&quot; buttons */</span>
	<span class="n">BTN_START</span><span class="p">,</span> <span class="n">BTN_SELECT</span><span class="p">,</span> <span class="n">BTN_THUMBL</span><span class="p">,</span> <span class="n">BTN_THUMBR</span><span class="p">,</span>	<span class="cm">/* start/back/sticks */</span>
	<span class="o">-</span><span class="mi">1</span>						<span class="cm">/* terminating entry */</span>
<span class="p">};</span>

<span class="cm">/* original xbox controllers only */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">signed</span> <span class="kt">short</span> <span class="n">xpad_btn</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BTN_C</span><span class="p">,</span> <span class="n">BTN_Z</span><span class="p">,</span>		<span class="cm">/* &quot;analog&quot; buttons */</span>
	<span class="o">-</span><span class="mi">1</span>			<span class="cm">/* terminating entry */</span>
<span class="p">};</span>

<span class="cm">/* used when dpad is mapped to buttons */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">signed</span> <span class="kt">short</span> <span class="n">xpad_btn_pad</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BTN_TRIGGER_HAPPY1</span><span class="p">,</span> <span class="n">BTN_TRIGGER_HAPPY2</span><span class="p">,</span>		<span class="cm">/* d-pad left, right */</span>
	<span class="n">BTN_TRIGGER_HAPPY3</span><span class="p">,</span> <span class="n">BTN_TRIGGER_HAPPY4</span><span class="p">,</span>		<span class="cm">/* d-pad up, down */</span>
	<span class="o">-</span><span class="mi">1</span>				<span class="cm">/* terminating entry */</span>
<span class="p">};</span>

<span class="cm">/* used when triggers are mapped to buttons */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">signed</span> <span class="kt">short</span> <span class="n">xpad_btn_triggers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BTN_TL2</span><span class="p">,</span> <span class="n">BTN_TR2</span><span class="p">,</span>		<span class="cm">/* triggers left/right */</span>
	<span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">signed</span> <span class="kt">short</span> <span class="n">xpad360_btn</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>  <span class="cm">/* buttons for x360 controller */</span>
	<span class="n">BTN_TL</span><span class="p">,</span> <span class="n">BTN_TR</span><span class="p">,</span>		<span class="cm">/* Button LB/RB */</span>
	<span class="n">BTN_MODE</span><span class="p">,</span>		<span class="cm">/* The big X button */</span>
	<span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">signed</span> <span class="kt">short</span> <span class="n">xpad_abs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ABS_X</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span>		<span class="cm">/* left stick */</span>
	<span class="n">ABS_RX</span><span class="p">,</span> <span class="n">ABS_RY</span><span class="p">,</span>		<span class="cm">/* right stick */</span>
	<span class="o">-</span><span class="mi">1</span>			<span class="cm">/* terminating entry */</span>
<span class="p">};</span>

<span class="cm">/* used when dpad is mapped to axes */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">signed</span> <span class="kt">short</span> <span class="n">xpad_abs_pad</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ABS_HAT0X</span><span class="p">,</span> <span class="n">ABS_HAT0Y</span><span class="p">,</span>	<span class="cm">/* d-pad axes */</span>
	<span class="o">-</span><span class="mi">1</span>			<span class="cm">/* terminating entry */</span>
<span class="p">};</span>

<span class="cm">/* used when triggers are mapped to axes */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">signed</span> <span class="kt">short</span> <span class="n">xpad_abs_triggers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ABS_Z</span><span class="p">,</span> <span class="n">ABS_RZ</span><span class="p">,</span>		<span class="cm">/* triggers left/right */</span>
	<span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="cm">/* Xbox 360 has a vendor-specific class, so we cannot match it with only</span>
<span class="cm"> * USB_INTERFACE_INFO (also specifically refused by USB subsystem), so we</span>
<span class="cm"> * match against vendor id as well. Wired Xbox 360 devices have protocol 1,</span>
<span class="cm"> * wireless controllers have protocol 129. */</span>
<span class="cp">#define XPAD_XBOX360_VENDOR_PROTOCOL(vend,pr) \</span>
<span class="cp">	.match_flags = USB_DEVICE_ID_MATCH_VENDOR | USB_DEVICE_ID_MATCH_INT_INFO, \</span>
<span class="cp">	.idVendor = (vend), \</span>
<span class="cp">	.bInterfaceClass = USB_CLASS_VENDOR_SPEC, \</span>
<span class="cp">	.bInterfaceSubClass = 93, \</span>
<span class="cp">	.bInterfaceProtocol = (pr)</span>
<span class="cp">#define XPAD_XBOX360_VENDOR(vend) \</span>
<span class="cp">	{ XPAD_XBOX360_VENDOR_PROTOCOL(vend,1) }, \</span>
<span class="cp">	{ XPAD_XBOX360_VENDOR_PROTOCOL(vend,129) }</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">xpad_table</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="sc">&#39;X&#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>	<span class="cm">/* X-Box USB-IF not approved class */</span>
	<span class="n">XPAD_XBOX360_VENDOR</span><span class="p">(</span><span class="mh">0x045e</span><span class="p">),</span>		<span class="cm">/* Microsoft X-Box 360 controllers */</span>
	<span class="n">XPAD_XBOX360_VENDOR</span><span class="p">(</span><span class="mh">0x046d</span><span class="p">),</span>		<span class="cm">/* Logitech X-Box 360 style controllers */</span>
	<span class="n">XPAD_XBOX360_VENDOR</span><span class="p">(</span><span class="mh">0x0738</span><span class="p">),</span>		<span class="cm">/* Mad Catz X-Box 360 controllers */</span>
	<span class="n">XPAD_XBOX360_VENDOR</span><span class="p">(</span><span class="mh">0x0e6f</span><span class="p">),</span>		<span class="cm">/* 0x0e6f X-Box 360 controllers */</span>
	<span class="n">XPAD_XBOX360_VENDOR</span><span class="p">(</span><span class="mh">0x12ab</span><span class="p">),</span>		<span class="cm">/* X-Box 360 dance pads */</span>
	<span class="n">XPAD_XBOX360_VENDOR</span><span class="p">(</span><span class="mh">0x1430</span><span class="p">),</span>		<span class="cm">/* RedOctane X-Box 360 controllers */</span>
	<span class="n">XPAD_XBOX360_VENDOR</span><span class="p">(</span><span class="mh">0x146b</span><span class="p">),</span>		<span class="cm">/* BigBen Interactive Controllers */</span>
	<span class="n">XPAD_XBOX360_VENDOR</span><span class="p">(</span><span class="mh">0x1bad</span><span class="p">),</span>		<span class="cm">/* Harminix Rock Band Guitar and Drums */</span>
	<span class="n">XPAD_XBOX360_VENDOR</span><span class="p">(</span><span class="mh">0x0f0d</span><span class="p">),</span>            <span class="cm">/* Hori Controllers */</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span> <span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">xpad_table</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">usb_xpad</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>		<span class="cm">/* input device interface */</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">;</span>	<span class="cm">/* usb device */</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">;</span>	<span class="cm">/* usb interface */</span>

	<span class="kt">int</span> <span class="n">pad_present</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">irq_in</span><span class="p">;</span>		<span class="cm">/* urb for interrupt in report */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">idata</span><span class="p">;</span>		<span class="cm">/* input data */</span>
	<span class="n">dma_addr_t</span> <span class="n">idata_dma</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">bulk_out</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bdata</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_JOYSTICK_XPAD_FF) || defined(CONFIG_JOYSTICK_XPAD_LEDS)</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">irq_out</span><span class="p">;</span>		<span class="cm">/* urb for interrupt out report */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">odata</span><span class="p">;</span>		<span class="cm">/* output data */</span>
	<span class="n">dma_addr_t</span> <span class="n">odata_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">odata_mutex</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_JOYSTICK_XPAD_LEDS)</span>
	<span class="k">struct</span> <span class="n">xpad_led</span> <span class="o">*</span><span class="n">led</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>			<span class="cm">/* physical device path */</span>

	<span class="kt">int</span> <span class="n">mapping</span><span class="p">;</span>			<span class="cm">/* map d-pad to buttons or to axes */</span>
	<span class="kt">int</span> <span class="n">xtype</span><span class="p">;</span>			<span class="cm">/* type of xbox device */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	xpad_process_packet</span>
<span class="cm"> *</span>
<span class="cm"> *	Completes a request by converting the data into events for the</span>
<span class="cm"> *	input subsystem.</span>
<span class="cm"> *</span>
<span class="cm"> *	The used report descriptor was taken from ITO Takayukis website:</span>
<span class="cm"> *	 http://euc.jp/periphs/xbox-controller.ja.html</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad_process_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">&amp;</span> <span class="n">MAP_STICKS_TO_NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* left stick */</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">__s16</span><span class="p">)</span> <span class="n">le16_to_cpup</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)));</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span>
				 <span class="o">~</span><span class="p">(</span><span class="n">__s16</span><span class="p">)</span> <span class="n">le16_to_cpup</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)));</span>

		<span class="cm">/* right stick */</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_RX</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">__s16</span><span class="p">)</span> <span class="n">le16_to_cpup</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)));</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_RY</span><span class="p">,</span>
				 <span class="o">~</span><span class="p">(</span><span class="n">__s16</span><span class="p">)</span> <span class="n">le16_to_cpup</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">18</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="cm">/* triggers left/right */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">&amp;</span> <span class="n">MAP_TRIGGERS_TO_BUTTONS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TL2</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TR2</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Z</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_RZ</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* digital pad */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">&amp;</span> <span class="n">MAP_DPAD_TO_BUTTONS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* dpad as buttons (left, right, up, down) */</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TRIGGER_HAPPY1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TRIGGER_HAPPY2</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TRIGGER_HAPPY3</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TRIGGER_HAPPY4</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_HAT0X</span><span class="p">,</span>
				 <span class="o">!!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">-</span> <span class="o">!!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">));</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_HAT0Y</span><span class="p">,</span>
				 <span class="o">!!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">-</span> <span class="o">!!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* start/back buttons and stick press left/right */</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_START</span><span class="p">,</span>  <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_SELECT</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_THUMBL</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_THUMBR</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="cm">/* &quot;analog&quot; buttons A, B, X, Y */</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_A</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_B</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_X</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_Y</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

	<span class="cm">/* &quot;analog&quot; buttons black, white */</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_C</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_Z</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>

	<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	xpad360_process_packet</span>
<span class="cm"> *</span>
<span class="cm"> *	Completes a request by converting the data into events for the</span>
<span class="cm"> *	input subsystem. It is version for xbox 360 controller</span>
<span class="cm"> *</span>
<span class="cm"> *	The used report descriptor was taken from:</span>
<span class="cm"> *		http://www.free60.org/wiki/Gamepad</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad360_process_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* digital pad */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">&amp;</span> <span class="n">MAP_DPAD_TO_BUTTONS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* dpad as buttons (left, right, up, down) */</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TRIGGER_HAPPY1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TRIGGER_HAPPY2</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TRIGGER_HAPPY3</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TRIGGER_HAPPY4</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_HAT0X</span><span class="p">,</span>
				 <span class="o">!!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">-</span> <span class="o">!!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">));</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_HAT0Y</span><span class="p">,</span>
				 <span class="o">!!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">-</span> <span class="o">!!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* start/back buttons */</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_START</span><span class="p">,</span>  <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_SELECT</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="cm">/* stick press left/right */</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_THUMBL</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_THUMBR</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="cm">/* buttons A,B,X,Y,TL,TR and MODE */</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_A</span><span class="p">,</span>	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_B</span><span class="p">,</span>	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_X</span><span class="p">,</span>	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_Y</span><span class="p">,</span>	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TL</span><span class="p">,</span>	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TR</span><span class="p">,</span>	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_MODE</span><span class="p">,</span>	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">&amp;</span> <span class="n">MAP_STICKS_TO_NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* left stick */</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">__s16</span><span class="p">)</span> <span class="n">le16_to_cpup</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)));</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span>
				 <span class="o">~</span><span class="p">(</span><span class="n">__s16</span><span class="p">)</span> <span class="n">le16_to_cpup</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)));</span>

		<span class="cm">/* right stick */</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_RX</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">__s16</span><span class="p">)</span> <span class="n">le16_to_cpup</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)));</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_RY</span><span class="p">,</span>
				 <span class="o">~</span><span class="p">(</span><span class="n">__s16</span><span class="p">)</span> <span class="n">le16_to_cpup</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)));</span>
	<span class="p">}</span>

	<span class="cm">/* triggers left/right */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">&amp;</span> <span class="n">MAP_TRIGGERS_TO_BUTTONS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TL2</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TR2</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Z</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_RZ</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * xpad360w_process_packet</span>
<span class="cm"> *</span>
<span class="cm"> * Completes a request by converting the data into events for the</span>
<span class="cm"> * input subsystem. It is version for xbox 360 wireless controller.</span>
<span class="cm"> *</span>
<span class="cm"> * Byte.Bit</span>
<span class="cm"> * 00.1 - Status change: The controller or headset has connected/disconnected</span>
<span class="cm"> *                       Bits 01.7 and 01.6 are valid</span>
<span class="cm"> * 01.7 - Controller present</span>
<span class="cm"> * 01.6 - Headset present</span>
<span class="cm"> * 01.1 - Pad state (Bytes 4+) valid</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad360w_process_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Presence change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">pad_present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bulk_out</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">pad_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Valid pad data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">xpad360_process_packet</span><span class="p">(</span><span class="n">xpad</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad_irq_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* success */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* this urb is terminated, clean up */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - urb shutting down with status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - nonzero urb status received: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XTYPE_XBOX360</span>:
		<span class="n">xpad360_process_packet</span><span class="p">(</span><span class="n">xpad</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">idata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XTYPE_XBOX360W</span>:
		<span class="n">xpad360w_process_packet</span><span class="p">(</span><span class="n">xpad</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">idata</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">xpad_process_packet</span><span class="p">(</span><span class="n">xpad</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">idata</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - usb_submit_urb failed with result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad_bulk_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* success */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* this urb is terminated, clean up */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - urb shutting down with status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - nonzero urb status received: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_JOYSTICK_XPAD_FF) || defined(CONFIG_JOYSTICK_XPAD_LEDS)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad_irq_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* success */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* this urb is terminated, clean up */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - urb shutting down with status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - nonzero urb status received: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - usb_submit_urb failed with result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xpad_init_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep_irq_out</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span> <span class="o">==</span> <span class="n">XTYPE_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">XPAD_PKT_LEN</span><span class="p">,</span>
					 <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata_mutex</span><span class="p">);</span>

	<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_out</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep_irq_out</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_out</span><span class="p">,</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			 <span class="n">usb_sndintpipe</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">ep_irq_out</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">),</span>
			 <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">,</span> <span class="n">XPAD_PKT_LEN</span><span class="p">,</span>
			 <span class="n">xpad_irq_out</span><span class="p">,</span> <span class="n">xpad</span><span class="p">,</span> <span class="n">ep_irq_out</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>
	<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_out</span><span class="o">-&gt;</span><span class="n">transfer_dma</span> <span class="o">=</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata_dma</span><span class="p">;</span>
	<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_out</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail2:</span>	<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">XPAD_PKT_LEN</span><span class="p">,</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">,</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata_dma</span><span class="p">);</span>
 <span class="nl">fail1:</span>	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad_stop_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span> <span class="o">!=</span> <span class="n">XTYPE_UNKNOWN</span><span class="p">)</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_out</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad_deinit_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span> <span class="o">!=</span> <span class="n">XTYPE_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_out</span><span class="p">);</span>
		<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">XPAD_PKT_LEN</span><span class="p">,</span>
				<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">,</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata_dma</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xpad_init_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad_deinit_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">)</span> <span class="p">{}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad_stop_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_JOYSTICK_XPAD_FF</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xpad_play_effect</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">effect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FF_RUMBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u16</span> <span class="n">strong</span> <span class="o">=</span> <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rumble</span><span class="p">.</span><span class="n">strong_magnitude</span><span class="p">;</span>
		<span class="n">__u16</span> <span class="n">weak</span> <span class="o">=</span> <span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rumble</span><span class="p">.</span><span class="n">weak_magnitude</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">XTYPE_XBOX</span>:
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">strong</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>	<span class="cm">/* left actuator */</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">weak</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>	<span class="cm">/* right actuator */</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_out</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_out</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">XTYPE_XBOX360</span>:
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">strong</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>  <span class="cm">/* left actuator? */</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">weak</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>	<span class="cm">/* right actuator? */</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_out</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_out</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">XTYPE_XBOX360W</span>:
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">strong</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">weak</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_out</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_out</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

		<span class="nl">default:</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - rumble command sent to unsupported xpad type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xpad_init_ff</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span> <span class="o">==</span> <span class="n">XTYPE_UNKNOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">input_set_capability</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">EV_FF</span><span class="p">,</span> <span class="n">FF_RUMBLE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">input_ff_create_memless</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">xpad_play_effect</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xpad_init_ff</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_JOYSTICK_XPAD_LEDS)</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>

<span class="k">struct</span> <span class="n">xpad_led</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">led_classdev</span> <span class="n">led_cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad_send_led_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">command</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata_mutex</span><span class="p">);</span>
		<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
		<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_out</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_out</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">odata_mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad_led_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpad_led</span> <span class="o">*</span><span class="n">xpad_led</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">xpad_led</span><span class="p">,</span> <span class="n">led_cdev</span><span class="p">);</span>

	<span class="n">xpad_send_led_command</span><span class="p">(</span><span class="n">xpad_led</span><span class="o">-&gt;</span><span class="n">xpad</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xpad_led_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">led_seq</span>	<span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">led_no</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpad_led</span> <span class="o">*</span><span class="n">led</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span> <span class="o">!=</span> <span class="n">XTYPE_XBOX360</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">led</span> <span class="o">=</span> <span class="n">led</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpad_led</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">led</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">led_no</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led_seq</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;xpad%ld&quot;</span><span class="p">,</span> <span class="n">led_no</span><span class="p">);</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">xpad</span> <span class="o">=</span> <span class="n">xpad</span><span class="p">;</span>

	<span class="n">led_cdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">;</span>
	<span class="n">led_cdev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">led_cdev</span><span class="o">-&gt;</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">xpad_led_set</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">led_cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
		<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">led</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Light up the segment corresponding to controller number</span>
<span class="cm">	 */</span>
	<span class="n">xpad_send_led_command</span><span class="p">(</span><span class="n">xpad</span><span class="p">,</span> <span class="p">(</span><span class="n">led_no</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad_led_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpad_led</span> <span class="o">*</span><span class="n">xpad_led</span> <span class="o">=</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpad_led</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpad_led</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">xpad_led</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">xpad_led_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad_led_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">xpad_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* URB was submitted in probe */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span> <span class="o">==</span> <span class="n">XTYPE_XBOX360W</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_in</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_in</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span> <span class="o">!=</span> <span class="n">XTYPE_XBOX360W</span><span class="p">)</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_in</span><span class="p">);</span>

	<span class="n">xpad_stop_output</span><span class="p">(</span><span class="n">xpad</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad_set_up_abs</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">,</span> <span class="kt">signed</span> <span class="kt">short</span> <span class="n">abs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">abs</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">abs</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ABS_X</span>:
	<span class="k">case</span> <span class="n">ABS_Y</span>:
	<span class="k">case</span> <span class="n">ABS_RX</span>:
	<span class="k">case</span> <span class="n">ABS_RY</span>:	<span class="cm">/* the two sticks */</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">abs</span><span class="p">,</span> <span class="o">-</span><span class="mi">32768</span><span class="p">,</span> <span class="mi">32767</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ABS_Z</span>:
	<span class="k">case</span> <span class="n">ABS_RZ</span>:	<span class="cm">/* the triggers (if mapped to axes) */</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">abs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ABS_HAT0X</span>:
	<span class="k">case</span> <span class="n">ABS_HAT0Y</span>:	<span class="cm">/* the d-pad (only if dpad is mapped to axes */</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">abs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xpad_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">ep_irq_in</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xpad_device</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idVendor</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">)</span> <span class="o">==</span> <span class="n">xpad_device</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idVendor</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">)</span> <span class="o">==</span> <span class="n">xpad_device</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idProduct</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xpad</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_xpad</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xpad</span> <span class="o">||</span> <span class="o">!</span><span class="n">input_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">idata</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">XPAD_PKT_LEN</span><span class="p">,</span>
					 <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">idata_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">idata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_in</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">udev</span><span class="p">;</span>
	<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">intf</span> <span class="o">=</span> <span class="n">intf</span><span class="p">;</span>
	<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">xpad_device</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapping</span><span class="p">;</span>
	<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span> <span class="o">=</span> <span class="n">xpad_device</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xtype</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span> <span class="o">==</span> <span class="n">XTYPE_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceClass</span> <span class="o">==</span> <span class="n">USB_CLASS_VENDOR_SPEC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceProtocol</span> <span class="o">==</span> <span class="mi">129</span><span class="p">)</span>
				<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span> <span class="o">=</span> <span class="n">XTYPE_XBOX360W</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span> <span class="o">=</span> <span class="n">XTYPE_XBOX360</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span> <span class="o">=</span> <span class="n">XTYPE_XBOX</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dpad_to_buttons</span><span class="p">)</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">|=</span> <span class="n">MAP_DPAD_TO_BUTTONS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">triggers_to_buttons</span><span class="p">)</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">|=</span> <span class="n">MAP_TRIGGERS_TO_BUTTONS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sticks_to_null</span><span class="p">)</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">|=</span> <span class="n">MAP_STICKS_TO_NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">input_dev</span><span class="p">;</span>
	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="s">&quot;/input0&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">xpad_device</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">usb_to_input_id</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">xpad</span><span class="p">);</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">xpad_open</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">xpad_close</span><span class="p">;</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">&amp;</span> <span class="n">MAP_STICKS_TO_NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">);</span>
		<span class="cm">/* set up axes */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xpad_abs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">xpad_set_up_abs</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">xpad_abs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* set up standard buttons */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xpad_common_btn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">xpad_common_btn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="cm">/* set up model-specific ones */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span> <span class="o">==</span> <span class="n">XTYPE_XBOX360</span> <span class="o">||</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span> <span class="o">==</span> <span class="n">XTYPE_XBOX360W</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xpad360_btn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">xpad360_btn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xpad_btn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">xpad_btn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">&amp;</span> <span class="n">MAP_DPAD_TO_BUTTONS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xpad_btn_pad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">xpad_btn_pad</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xpad_abs_pad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		    <span class="n">xpad_set_up_abs</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">xpad_abs_pad</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">&amp;</span> <span class="n">MAP_TRIGGERS_TO_BUTTONS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xpad_btn_triggers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">xpad_btn_triggers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xpad_abs_triggers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">xpad_set_up_abs</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">xpad_abs_triggers</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xpad_init_output</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">xpad</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xpad_init_ff</span><span class="p">(</span><span class="n">xpad</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail4</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">xpad_led_probe</span><span class="p">(</span><span class="n">xpad</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail5</span><span class="p">;</span>

	<span class="n">ep_irq_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_in</span><span class="p">,</span> <span class="n">udev</span><span class="p">,</span>
			 <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">ep_irq_in</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">),</span>
			 <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">idata</span><span class="p">,</span> <span class="n">XPAD_PKT_LEN</span><span class="p">,</span> <span class="n">xpad_irq_in</span><span class="p">,</span>
			 <span class="n">xpad</span><span class="p">,</span> <span class="n">ep_irq_in</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>
	<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_in</span><span class="o">-&gt;</span><span class="n">transfer_dma</span> <span class="o">=</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">idata_dma</span><span class="p">;</span>
	<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_in</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail6</span><span class="p">;</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">xpad</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span> <span class="o">==</span> <span class="n">XTYPE_XBOX360W</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Setup the message to set the LEDs on the</span>
<span class="cm">		 * controller when it shows up</span>
<span class="cm">		 */</span>
		<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bulk_out</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bulk_out</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail7</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bdata</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">XPAD_PKT_LEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bdata</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail8</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bdata</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bdata</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x42</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bdata</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x43</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bdata</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bdata</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x45</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ep_irq_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>
		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bulk_out</span><span class="p">,</span> <span class="n">udev</span><span class="p">,</span>
				<span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">ep_irq_in</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">),</span>
				<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bdata</span><span class="p">,</span> <span class="n">XPAD_PKT_LEN</span><span class="p">,</span> <span class="n">xpad_bulk_out</span><span class="p">,</span> <span class="n">xpad</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Submit the int URB immediately rather than waiting for open</span>
<span class="cm">		 * because we get status messages from the device whether</span>
<span class="cm">		 * or not any controllers are attached.  In fact, it&#39;s</span>
<span class="cm">		 * exactly the message that a controller has arrived that</span>
<span class="cm">		 * we&#39;re waiting for.</span>
<span class="cm">		 */</span>
		<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_in</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_in</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail9</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail9:</span>	<span class="n">kfree</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bdata</span><span class="p">);</span>
 <span class="nl">fail8:</span>	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bulk_out</span><span class="p">);</span>
 <span class="nl">fail7:</span>	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="n">input_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="nl">fail6:</span>	<span class="n">xpad_led_disconnect</span><span class="p">(</span><span class="n">xpad</span><span class="p">);</span>
 <span class="nl">fail5:</span>	<span class="k">if</span> <span class="p">(</span><span class="n">input_dev</span><span class="p">)</span>
		<span class="n">input_ff_destroy</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
 <span class="nl">fail4:</span>	<span class="n">xpad_deinit_output</span><span class="p">(</span><span class="n">xpad</span><span class="p">);</span>
 <span class="nl">fail3:</span>	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_in</span><span class="p">);</span>
 <span class="nl">fail2:</span>	<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">XPAD_PKT_LEN</span><span class="p">,</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">idata</span><span class="p">,</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">idata_dma</span><span class="p">);</span>
 <span class="nl">fail1:</span>	<span class="n">input_free_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">xpad</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xpad_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_xpad</span> <span class="o">*</span><span class="n">xpad</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span> <span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="n">xpad_led_disconnect</span><span class="p">(</span><span class="n">xpad</span><span class="p">);</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">xpad_deinit_output</span><span class="p">(</span><span class="n">xpad</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">xtype</span> <span class="o">==</span> <span class="n">XTYPE_XBOX360W</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bulk_out</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bulk_out</span><span class="p">);</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_in</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">irq_in</span><span class="p">);</span>
	<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">XPAD_PKT_LEN</span><span class="p">,</span>
			<span class="n">xpad</span><span class="o">-&gt;</span><span class="n">idata</span><span class="p">,</span> <span class="n">xpad</span><span class="o">-&gt;</span><span class="n">idata_dma</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">xpad</span><span class="o">-&gt;</span><span class="n">bdata</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">xpad</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">xpad_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;xpad&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">xpad_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">xpad_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">xpad_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">xpad_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
