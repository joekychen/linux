<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › joystick › iforce › iforce.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>iforce.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (c) 2000-2002 Vojtech Pavlik &lt;vojtech@ucw.cz&gt;</span>
<span class="cm"> *  Copyright (c) 2001-2002, 2007 Johann Deneux &lt;johann.deneux@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  USB/RS232 I-Force joysticks and wheels.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> * Should you need to contact me, the author, you can do so either by</span>
<span class="cm"> * e-mail - mail your message to &lt;vojtech@ucw.cz&gt;, or by paper mail:</span>
<span class="cm"> * Vojtech Pavlik, Simunkova 1594, Prague 8, 182 00 Czech Republic</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/serio.h&gt;</span>
<span class="cp">#include &lt;linux/circ_buf.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cm">/* This module provides arbitrary resource management routines.</span>
<span class="cm"> * I use it to manage the device&#39;s memory.</span>
<span class="cm"> * Despite the name of this module, I am *not* going to access the ioports.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>


<span class="cp">#define IFORCE_MAX_LENGTH	16</span>

<span class="cm">/* iforce::bus */</span>
<span class="cp">#define IFORCE_232	1</span>
<span class="cp">#define IFORCE_USB	2</span>

<span class="cp">#define IFORCE_EFFECTS_MAX	32</span>

<span class="cm">/* Each force feedback effect is made of one core effect, which can be</span>
<span class="cm"> * associated to at most to effect modifiers</span>
<span class="cm"> */</span>
<span class="cp">#define FF_MOD1_IS_USED		0</span>
<span class="cp">#define FF_MOD2_IS_USED		1</span>
<span class="cp">#define FF_CORE_IS_USED		2</span>
<span class="cp">#define FF_CORE_IS_PLAYED	3	</span><span class="cm">/* Effect is currently being played */</span><span class="cp"></span>
<span class="cp">#define FF_CORE_SHOULD_PLAY	4	</span><span class="cm">/* User wants the effect to be played */</span><span class="cp"></span>
<span class="cp">#define FF_CORE_UPDATE		5	</span><span class="cm">/* Effect is being updated */</span><span class="cp"></span>
<span class="cp">#define FF_MODCORE_CNT		6</span>

<span class="k">struct</span> <span class="n">iforce_core_effect</span> <span class="p">{</span>
	<span class="cm">/* Information about where modifiers are stored in the device&#39;s memory */</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">mod1_chunk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">mod2_chunk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">FF_MODCORE_CNT</span><span class="p">)];</span>
<span class="p">};</span>

<span class="cp">#define FF_CMD_EFFECT		0x010e</span>
<span class="cp">#define FF_CMD_ENVELOPE		0x0208</span>
<span class="cp">#define FF_CMD_MAGNITUDE	0x0303</span>
<span class="cp">#define FF_CMD_PERIOD		0x0407</span>
<span class="cp">#define FF_CMD_CONDITION	0x050a</span>

<span class="cp">#define FF_CMD_AUTOCENTER	0x4002</span>
<span class="cp">#define FF_CMD_PLAY		0x4103</span>
<span class="cp">#define FF_CMD_ENABLE		0x4201</span>
<span class="cp">#define FF_CMD_GAIN		0x4301</span>

<span class="cp">#define FF_CMD_QUERY		0xff01</span>

<span class="cm">/* Buffer for async write */</span>
<span class="cp">#define XMIT_SIZE		256</span>
<span class="cp">#define XMIT_INC(var, n)	(var)+=n; (var)&amp;= XMIT_SIZE -1</span>
<span class="cm">/* iforce::xmit_flags */</span>
<span class="cp">#define IFORCE_XMIT_RUNNING	0</span>
<span class="cp">#define IFORCE_XMIT_AGAIN	1</span>

<span class="k">struct</span> <span class="n">iforce_device</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">idvendor</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">idproduct</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">signed</span> <span class="kt">short</span> <span class="o">*</span><span class="n">btn</span><span class="p">;</span>
	<span class="kt">signed</span> <span class="kt">short</span> <span class="o">*</span><span class="n">abs</span><span class="p">;</span>
	<span class="kt">signed</span> <span class="kt">short</span> <span class="o">*</span><span class="n">ff</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iforce</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>		<span class="cm">/* Input device interface */</span>
	<span class="k">struct</span> <span class="n">iforce_device</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bus</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="n">IFORCE_MAX_LENGTH</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">edata</span><span class="p">[</span><span class="n">IFORCE_MAX_LENGTH</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">ecmd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">expect_packet</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_JOYSTICK_IFORCE_232</span>
	<span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">;</span>		<span class="cm">/* RS232 transfer */</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">csum</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_JOYSTICK_IFORCE_USB</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">;</span>	<span class="cm">/* USB transfer */</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">irq</span><span class="p">,</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_ctrlrequest</span> <span class="n">cr</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">spinlock_t</span> <span class="n">xmit_lock</span><span class="p">;</span>
	<span class="cm">/* Buffer used for asynchronous sending of bytes to the device */</span>
	<span class="k">struct</span> <span class="n">circ_buf</span> <span class="n">xmit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xmit_data</span><span class="p">[</span><span class="n">XMIT_SIZE</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">xmit_flags</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

					<span class="cm">/* Force Feedback */</span>
	<span class="n">wait_queue_head_t</span> <span class="n">wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">device_memory</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iforce_core_effect</span> <span class="n">core_effects</span><span class="p">[</span><span class="n">IFORCE_EFFECTS_MAX</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mem_mutex</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Get hi and low bytes of a 16-bits int */</span>
<span class="cp">#define HI(a)	((unsigned char)((a) &gt;&gt; 8))</span>
<span class="cp">#define LO(a)	((unsigned char)((a) &amp; 0xff))</span>

<span class="cm">/* For many parameters, it seems that 0x80 is a special value that should</span>
<span class="cm"> * be avoided. Instead, we replace this value by 0x7f</span>
<span class="cm"> */</span>
<span class="cp">#define HIFIX80(a) ((unsigned char)(((a)&lt;0? (a)+255 : (a))&gt;&gt;8))</span>

<span class="cm">/* Encode a time value */</span>
<span class="cp">#define TIME_SCALE(a)	(a)</span>


<span class="cm">/* Public functions */</span>
<span class="cm">/* iforce-serio.c */</span>
<span class="kt">void</span> <span class="n">iforce_serial_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">iforce</span> <span class="o">*</span><span class="n">iforce</span><span class="p">);</span>

<span class="cm">/* iforce-usb.c */</span>
<span class="kt">void</span> <span class="n">iforce_usb_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">iforce</span> <span class="o">*</span><span class="n">iforce</span><span class="p">);</span>

<span class="cm">/* iforce-main.c */</span>
<span class="kt">int</span> <span class="n">iforce_init_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">iforce</span> <span class="o">*</span><span class="n">iforce</span><span class="p">);</span>

<span class="cm">/* iforce-packets.c */</span>
<span class="kt">int</span> <span class="n">iforce_control_playback</span><span class="p">(</span><span class="k">struct</span> <span class="n">iforce</span><span class="o">*</span><span class="p">,</span> <span class="n">u16</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">iforce_process_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">iforce</span> <span class="o">*</span><span class="n">iforce</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">iforce_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">iforce</span> <span class="o">*</span><span class="n">iforce</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">iforce_dump_packet</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">;</span>
<span class="kt">int</span> <span class="n">iforce_get_id_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">iforce</span> <span class="o">*</span><span class="n">iforce</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">packet</span><span class="p">);</span>

<span class="cm">/* iforce-ff.c */</span>
<span class="kt">int</span> <span class="n">iforce_upload_periodic</span><span class="p">(</span><span class="k">struct</span> <span class="n">iforce</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">iforce_upload_constant</span><span class="p">(</span><span class="k">struct</span> <span class="n">iforce</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">iforce_upload_condition</span><span class="p">(</span><span class="k">struct</span> <span class="n">iforce</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* Public variables */</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">serio_driver</span> <span class="n">iforce_serio_drv</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">iforce_usb_driver</span><span class="p">;</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
