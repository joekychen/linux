<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › joystick › gamecon.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>gamecon.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * NES, SNES, N64, MultiSystem, PSX gamepad driver for Linux</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 1999-2004	Vojtech Pavlik &lt;vojtech@suse.cz&gt;</span>
<span class="cm"> *  Copyright (c) 2004		Peter Nelson &lt;rufus-kernel@hackish.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Based on the work of:</span>
<span class="cm"> *	Andree Borrmann		John Dahlstrom</span>
<span class="cm"> *	David Kuder		Nathan Hand</span>
<span class="cm"> *	Raphael Assenat</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> * Should you need to contact me, the author, you can do so either by</span>
<span class="cm"> * e-mail - mail your message to &lt;vojtech@ucw.cz&gt;, or by paper mail:</span>
<span class="cm"> * Vojtech Pavlik, Simunkova 1594, Prague 8, 182 00 Czech Republic</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/parport.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Vojtech Pavlik &lt;vojtech@ucw.cz&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;NES, SNES, N64, MultiSystem, PSX gamepad driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#define GC_MAX_PORTS		3</span>
<span class="cp">#define GC_MAX_DEVICES		5</span>

<span class="k">struct</span> <span class="n">gc_config</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">args</span><span class="p">[</span><span class="n">GC_MAX_DEVICES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nargs</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gc_config</span> <span class="n">gc_cfg</span><span class="p">[</span><span class="n">GC_MAX_PORTS</span><span class="p">]</span> <span class="n">__initdata</span><span class="p">;</span>

<span class="n">module_param_array_named</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">gc_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">nargs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="s">&quot;Describes first set of devices (&lt;parport#&gt;,&lt;pad1&gt;,&lt;pad2&gt;,..&lt;pad5&gt;)&quot;</span><span class="p">);</span>
<span class="n">module_param_array_named</span><span class="p">(</span><span class="n">map2</span><span class="p">,</span> <span class="n">gc_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">nargs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">map2</span><span class="p">,</span> <span class="s">&quot;Describes second set of devices&quot;</span><span class="p">);</span>
<span class="n">module_param_array_named</span><span class="p">(</span><span class="n">map3</span><span class="p">,</span> <span class="n">gc_cfg</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc_cfg</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">nargs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">map3</span><span class="p">,</span> <span class="s">&quot;Describes third set of devices&quot;</span><span class="p">);</span>

<span class="cm">/* see also gs_psx_delay parameter in PSX support section */</span>

<span class="k">enum</span> <span class="n">gc_type</span> <span class="p">{</span>
	<span class="n">GC_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">GC_SNES</span><span class="p">,</span>
	<span class="n">GC_NES</span><span class="p">,</span>
	<span class="n">GC_NES4</span><span class="p">,</span>
	<span class="n">GC_MULTI</span><span class="p">,</span>
	<span class="n">GC_MULTI2</span><span class="p">,</span>
	<span class="n">GC_N64</span><span class="p">,</span>
	<span class="n">GC_PSX</span><span class="p">,</span>
	<span class="n">GC_DDR</span><span class="p">,</span>
	<span class="n">GC_SNESMOUSE</span><span class="p">,</span>
	<span class="n">GC_MAX</span>
<span class="p">};</span>

<span class="cp">#define GC_REFRESH_TIME	HZ/100</span>

<span class="k">struct</span> <span class="n">gc_pad</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">gc_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">gc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pardevice</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gc_pad</span> <span class="n">pads</span><span class="p">[</span><span class="n">GC_MAX_DEVICES</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pad_count</span><span class="p">[</span><span class="n">GC_MAX</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">used</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">gc_subdev</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc_base</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">gc_status_bit</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">gc_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;SNES pad&quot;</span><span class="p">,</span> <span class="s">&quot;NES pad&quot;</span><span class="p">,</span> <span class="s">&quot;NES FourPort&quot;</span><span class="p">,</span> <span class="s">&quot;Multisystem joystick&quot;</span><span class="p">,</span>
	<span class="s">&quot;Multisystem 2-button joystick&quot;</span><span class="p">,</span> <span class="s">&quot;N64 controller&quot;</span><span class="p">,</span> <span class="s">&quot;PSX controller&quot;</span><span class="p">,</span>
	<span class="s">&quot;PSX DDR controller&quot;</span><span class="p">,</span> <span class="s">&quot;SNES mouse&quot;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * N64 support.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">gc_n64_bytes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">gc_n64_btn</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BTN_A</span><span class="p">,</span> <span class="n">BTN_B</span><span class="p">,</span> <span class="n">BTN_C</span><span class="p">,</span> <span class="n">BTN_X</span><span class="p">,</span> <span class="n">BTN_Y</span><span class="p">,</span> <span class="n">BTN_Z</span><span class="p">,</span>
	<span class="n">BTN_TL</span><span class="p">,</span> <span class="n">BTN_TR</span><span class="p">,</span> <span class="n">BTN_TRIGGER</span><span class="p">,</span> <span class="n">BTN_START</span>
<span class="p">};</span>

<span class="cp">#define GC_N64_LENGTH		32		</span><span class="cm">/* N64 bit length, not including stop bit */</span><span class="cp"></span>
<span class="cp">#define GC_N64_STOP_LENGTH	5		</span><span class="cm">/* Length of encoded stop bit */</span><span class="cp"></span>
<span class="cp">#define GC_N64_CMD_00		0x11111111UL</span>
<span class="cp">#define GC_N64_CMD_01		0xd1111111UL</span>
<span class="cp">#define GC_N64_CMD_03		0xdd111111UL</span>
<span class="cp">#define GC_N64_CMD_1b		0xdd1dd111UL</span>
<span class="cp">#define GC_N64_CMD_c0		0x111111ddUL</span>
<span class="cp">#define GC_N64_CMD_80		0x1111111dUL</span>
<span class="cp">#define GC_N64_STOP_BIT		0x1d		</span><span class="cm">/* Encoded stop bit */</span><span class="cp"></span>
<span class="cp">#define GC_N64_REQUEST_DATA	GC_N64_CMD_01	</span><span class="cm">/* the request data command */</span><span class="cp"></span>
<span class="cp">#define GC_N64_DELAY		133		</span><span class="cm">/* delay between transmit request, and response ready (us) */</span><span class="cp"></span>
<span class="cp">#define GC_N64_DWS		3		</span><span class="cm">/* delay between write segments (required for sound playback because of ISA DMA) */</span><span class="cp"></span>
						<span class="cm">/* GC_N64_DWS &gt; 24 is known to fail */</span>
<span class="cp">#define GC_N64_POWER_W		0xe2		</span><span class="cm">/* power during write (transmit request) */</span><span class="cp"></span>
<span class="cp">#define GC_N64_POWER_R		0xfd		</span><span class="cm">/* power during read */</span><span class="cp"></span>
<span class="cp">#define GC_N64_OUT		0x1d		</span><span class="cm">/* output bits to the 4 pads */</span><span class="cp"></span>
						<span class="cm">/* Reading the main axes of any N64 pad is known to fail if the corresponding bit */</span>
						<span class="cm">/* in GC_N64_OUT is pulled low on the output port (by any routine) for more */</span>
						<span class="cm">/* than 123 us */</span>
<span class="cp">#define GC_N64_CLOCK		0x02		</span><span class="cm">/* clock bits for read */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Used for rumble code.</span>
<span class="cm"> */</span>

<span class="cm">/* Send encoded command */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gc_n64_send_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmd</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GC_N64_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">target</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">parport_write_data</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GC_N64_POWER_W</span> <span class="o">|</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">GC_N64_DWS</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Send stop bit */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gc_n64_send_stop_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GC_N64_STOP_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">GC_N64_STOP_BIT</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">target</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">parport_write_data</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">GC_N64_POWER_W</span> <span class="o">|</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">GC_N64_DWS</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * gc_n64_read_packet() reads an N64 packet.</span>
<span class="cm"> * Each pad uses one bit per byte. So all pads connected to this port</span>
<span class="cm"> * are read in parallel.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gc_n64_read_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Request the pad to transmit data</span>
<span class="cm"> */</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">gc_n64_send_command</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">GC_N64_REQUEST_DATA</span><span class="p">,</span> <span class="n">GC_N64_OUT</span><span class="p">);</span>
	<span class="n">gc_n64_send_stop_bit</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">GC_N64_OUT</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for the pad response to be loaded into the 33-bit register</span>
<span class="cm"> * of the adapter.</span>
<span class="cm"> */</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">GC_N64_DELAY</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Grab data (ignoring the last bit, which is a stop bit)</span>
<span class="cm"> */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GC_N64_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parport_write_data</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">GC_N64_POWER_R</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parport_read_status</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">parport_write_data</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">GC_N64_POWER_R</span> <span class="o">|</span> <span class="n">GC_N64_CLOCK</span><span class="p">);</span>
	 <span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We must wait 200 ms here for the controller to reinitialize before</span>
<span class="cm"> * the next read request. No worries as long as gc_read is polled less</span>
<span class="cm"> * frequently than this.</span>
<span class="cm"> */</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gc_n64_process_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="n">GC_N64_LENGTH</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">signed</span> <span class="kt">char</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>

	<span class="n">gc_n64_read_packet</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GC_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">GC_N64</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev</span> <span class="o">=</span> <span class="n">gc</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">gc_status_bit</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]))</span> <span class="p">{</span>

			<span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">23</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span>
					<span class="n">x</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">31</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span>
					<span class="n">y</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span>  <span class="n">x</span><span class="p">);</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="o">-</span><span class="n">y</span><span class="p">);</span>

			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_HAT0X</span><span class="p">,</span>
					 <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">-</span> <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]));</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_HAT0Y</span><span class="p">,</span>
					 <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]));</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gc_n64_btn</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
						 <span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="n">gc_n64_bytes</span><span class="p">[</span><span class="n">j</span><span class="p">]]);</span>

			<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gc_n64_play_effect</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ff_effect</span> <span class="o">*</span><span class="n">effect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gc_subdev</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">target</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span> <span class="cm">/* select desired pin */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FF_RUMBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ff_rumble_effect</span> <span class="o">*</span><span class="n">rumble</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rumble</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span> <span class="o">=</span>
			<span class="n">rumble</span><span class="o">-&gt;</span><span class="n">strong_magnitude</span> <span class="o">||</span> <span class="n">rumble</span><span class="o">-&gt;</span><span class="n">weak_magnitude</span> <span class="o">?</span>
			<span class="n">GC_N64_CMD_01</span> <span class="o">:</span> <span class="n">GC_N64_CMD_00</span><span class="p">;</span>

		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Init Rumble - 0x03, 0x80, 0x01, (34)0x80 */</span>
		<span class="n">gc_n64_send_command</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">GC_N64_CMD_03</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">gc_n64_send_command</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">GC_N64_CMD_80</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">gc_n64_send_command</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">GC_N64_CMD_01</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">gc_n64_send_command</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">GC_N64_CMD_80</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">gc_n64_send_stop_bit</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

		<span class="n">udelay</span><span class="p">(</span><span class="n">GC_N64_DELAY</span><span class="p">);</span>

		<span class="cm">/* Now start or stop it - 0x03, 0xc0, 0zx1b, (32)0x01/0x00 */</span>
		<span class="n">gc_n64_send_command</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">GC_N64_CMD_03</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">gc_n64_send_command</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">GC_N64_CMD_c0</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">gc_n64_send_command</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">GC_N64_CMD_1b</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">gc_n64_send_command</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">gc_n64_send_stop_bit</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>

		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">gc_n64_init_ff</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gc_subdev</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sdev</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sdev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">input_set_capability</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EV_FF</span><span class="p">,</span> <span class="n">FF_RUMBLE</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">input_ff_create_memless</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="n">gc_n64_play_effect</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NES/SNES support.</span>
<span class="cm"> */</span>

<span class="cp">#define GC_NES_DELAY		6	</span><span class="cm">/* Delay between bits - 6us */</span><span class="cp"></span>
<span class="cp">#define GC_NES_LENGTH		8	</span><span class="cm">/* The NES pads use 8 bits of data */</span><span class="cp"></span>
<span class="cp">#define GC_SNES_LENGTH		12	</span><span class="cm">/* The SNES true length is 16, but the</span>
<span class="cm">					   last 4 bits are unused */</span><span class="cp"></span>
<span class="cp">#define GC_SNESMOUSE_LENGTH	32	</span><span class="cm">/* The SNES mouse uses 32 bits, the first</span>
<span class="cm">					   16 bits are equivalent to a gamepad */</span><span class="cp"></span>

<span class="cp">#define GC_NES_POWER	0xfc</span>
<span class="cp">#define GC_NES_CLOCK	0x01</span>
<span class="cp">#define GC_NES_LATCH	0x02</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">gc_nes_bytes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">gc_snes_bytes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">gc_snes_btn</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BTN_A</span><span class="p">,</span> <span class="n">BTN_B</span><span class="p">,</span> <span class="n">BTN_SELECT</span><span class="p">,</span> <span class="n">BTN_START</span><span class="p">,</span> <span class="n">BTN_X</span><span class="p">,</span> <span class="n">BTN_Y</span><span class="p">,</span> <span class="n">BTN_TL</span><span class="p">,</span> <span class="n">BTN_TR</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * gc_nes_read_packet() reads a NES/SNES packet.</span>
<span class="cm"> * Each pad uses one bit per byte. So all pads connected to</span>
<span class="cm"> * this port are read in parallel.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gc_nes_read_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">parport_write_data</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">GC_NES_POWER</span> <span class="o">|</span> <span class="n">GC_NES_CLOCK</span> <span class="o">|</span> <span class="n">GC_NES_LATCH</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">GC_NES_DELAY</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">parport_write_data</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">GC_NES_POWER</span> <span class="o">|</span> <span class="n">GC_NES_CLOCK</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">GC_NES_DELAY</span><span class="p">);</span>
		<span class="n">parport_write_data</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">GC_NES_POWER</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parport_read_status</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">GC_NES_DELAY</span><span class="p">);</span>
		<span class="n">parport_write_data</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">GC_NES_POWER</span> <span class="o">|</span> <span class="n">GC_NES_CLOCK</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gc_nes_process_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="n">GC_SNESMOUSE_LENGTH</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">gc_pad</span> <span class="o">*</span><span class="n">pad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">x_rel</span><span class="p">,</span> <span class="n">y_rel</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">gc</span><span class="o">-&gt;</span><span class="n">pad_count</span><span class="p">[</span><span class="n">GC_SNESMOUSE</span><span class="p">]</span> <span class="o">?</span> <span class="n">GC_SNESMOUSE_LENGTH</span> <span class="o">:</span>
			<span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pad_count</span><span class="p">[</span><span class="n">GC_SNES</span><span class="p">]</span> <span class="o">?</span> <span class="n">GC_SNES_LENGTH</span> <span class="o">:</span> <span class="n">GC_NES_LENGTH</span><span class="p">);</span>

	<span class="n">gc_nes_read_packet</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GC_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">pad</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">gc_status_bit</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">GC_NES</span>:

			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">-</span> <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]));</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]));</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gc_snes_btn</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
						 <span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="n">gc_nes_bytes</span><span class="p">[</span><span class="n">j</span><span class="p">]]);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">GC_SNES</span>:

			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">-</span> <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]));</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]));</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gc_snes_btn</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
						 <span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="n">gc_snes_bytes</span><span class="p">[</span><span class="n">j</span><span class="p">]]);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">GC_SNESMOUSE</span>:
			<span class="cm">/*</span>
<span class="cm">			 * The 4 unused bits from SNES controllers appear</span>
<span class="cm">			 * to be ID bits so use them to make sure we are</span>
<span class="cm">			 * dealing with a mouse.</span>
<span class="cm">			 * gamepad is connected. This is important since</span>
<span class="cm">			 * my SNES gamepad sends 1&#39;s for bits 16-31, which</span>
<span class="cm">			 * cause the mouse pointer to quickly move to the</span>
<span class="cm">			 * upper left corner of the screen.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">14</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">15</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>

				<span class="n">x_rel</span> <span class="o">=</span> <span class="n">y_rel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">x_rel</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">25</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span>
						<span class="n">x_rel</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>

					<span class="n">y_rel</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">17</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span>
						<span class="n">y_rel</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">x_rel</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span>
						<span class="n">x_rel</span> <span class="o">=</span> <span class="o">-</span><span class="n">x_rel</span><span class="p">;</span>
					<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_X</span><span class="p">,</span> <span class="n">x_rel</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">y_rel</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span>
						<span class="n">y_rel</span> <span class="o">=</span> <span class="o">-</span><span class="n">y_rel</span><span class="p">;</span>
					<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_Y</span><span class="p">,</span> <span class="n">y_rel</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Multisystem joystick support</span>
<span class="cm"> */</span>

<span class="cp">#define GC_MULTI_LENGTH		5	</span><span class="cm">/* Multi system joystick packet length is 5 */</span><span class="cp"></span>
<span class="cp">#define GC_MULTI2_LENGTH	6	</span><span class="cm">/* One more bit for one more button */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * gc_multi_read_packet() reads a Multisystem joystick packet.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gc_multi_read_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parport_write_data</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">));</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parport_read_status</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gc_multi_process_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="n">GC_MULTI2_LENGTH</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">data_len</span> <span class="o">=</span> <span class="n">gc</span><span class="o">-&gt;</span><span class="n">pad_count</span><span class="p">[</span><span class="n">GC_MULTI2</span><span class="p">]</span> <span class="o">?</span> <span class="n">GC_MULTI2_LENGTH</span> <span class="o">:</span> <span class="n">GC_MULTI_LENGTH</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gc_pad</span> <span class="o">*</span><span class="n">pad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">;</span>

	<span class="n">gc_multi_read_packet</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GC_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">pad</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">gc_status_bit</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GC_MULTI2</span>:
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_THUMB</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="cm">/* fall through */</span>

		<span class="k">case</span> <span class="n">GC_MULTI</span>:
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span>
					 <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span>
					 <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_TRIGGER</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PSX support</span>
<span class="cm"> *</span>
<span class="cm"> * See documentation at:</span>
<span class="cm"> *	http://www.geocities.co.jp/Playtown/2004/psx/ps_eng.txt	</span>
<span class="cm"> *	http://www.gamesx.com/controldata/psxcont/psxcont.htm</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define GC_PSX_DELAY	25		</span><span class="cm">/* 25 usec */</span><span class="cp"></span>
<span class="cp">#define GC_PSX_LENGTH	8		</span><span class="cm">/* talk to the controller in bits */</span><span class="cp"></span>
<span class="cp">#define GC_PSX_BYTES	6		</span><span class="cm">/* the maximum number of bytes to read off the controller */</span><span class="cp"></span>

<span class="cp">#define GC_PSX_MOUSE	1		</span><span class="cm">/* Mouse */</span><span class="cp"></span>
<span class="cp">#define GC_PSX_NEGCON	2		</span><span class="cm">/* NegCon */</span><span class="cp"></span>
<span class="cp">#define GC_PSX_NORMAL	4		</span><span class="cm">/* Digital / Analog or Rumble in Digital mode  */</span><span class="cp"></span>
<span class="cp">#define GC_PSX_ANALOG	5		</span><span class="cm">/* Analog in Analog mode / Rumble in Green mode */</span><span class="cp"></span>
<span class="cp">#define GC_PSX_RUMBLE	7		</span><span class="cm">/* Rumble in Red mode */</span><span class="cp"></span>

<span class="cp">#define GC_PSX_CLOCK	0x04		</span><span class="cm">/* Pin 4 */</span><span class="cp"></span>
<span class="cp">#define GC_PSX_COMMAND	0x01		</span><span class="cm">/* Pin 2 */</span><span class="cp"></span>
<span class="cp">#define GC_PSX_POWER	0xf8		</span><span class="cm">/* Pins 5-9 */</span><span class="cp"></span>
<span class="cp">#define GC_PSX_SELECT	0x02		</span><span class="cm">/* Pin 3 */</span><span class="cp"></span>

<span class="cp">#define GC_PSX_ID(x)	((x) &gt;&gt; 4)	</span><span class="cm">/* High nibble is device type */</span><span class="cp"></span>
<span class="cp">#define GC_PSX_LEN(x)	(((x) &amp; 0xf) &lt;&lt; 1)	</span><span class="cm">/* Low nibble is length in bytes/2 */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">gc_psx_delay</span> <span class="o">=</span> <span class="n">GC_PSX_DELAY</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">psx_delay</span><span class="p">,</span> <span class="n">gc_psx_delay</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">psx_delay</span><span class="p">,</span> <span class="s">&quot;Delay when accessing Sony PSX controller (usecs)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">gc_psx_abs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ABS_X</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">ABS_RX</span><span class="p">,</span> <span class="n">ABS_RY</span><span class="p">,</span> <span class="n">ABS_HAT0X</span><span class="p">,</span> <span class="n">ABS_HAT0Y</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">gc_psx_btn</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BTN_TL</span><span class="p">,</span> <span class="n">BTN_TR</span><span class="p">,</span> <span class="n">BTN_TL2</span><span class="p">,</span> <span class="n">BTN_TR2</span><span class="p">,</span> <span class="n">BTN_A</span><span class="p">,</span> <span class="n">BTN_B</span><span class="p">,</span> <span class="n">BTN_X</span><span class="p">,</span> <span class="n">BTN_Y</span><span class="p">,</span>
	<span class="n">BTN_START</span><span class="p">,</span> <span class="n">BTN_SELECT</span><span class="p">,</span> <span class="n">BTN_THUMBL</span><span class="p">,</span> <span class="n">BTN_THUMBR</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">gc_psx_ddr_btn</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">BTN_0</span><span class="p">,</span> <span class="n">BTN_1</span><span class="p">,</span> <span class="n">BTN_2</span><span class="p">,</span> <span class="n">BTN_3</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * gc_psx_command() writes 8bit command and reads 8bit data from</span>
<span class="cm"> * the psx pad.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gc_psx_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">read</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GC_MAX_DEVICES</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GC_PSX_LENGTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">b</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">GC_PSX_COMMAND</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">parport_write_data</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">|</span> <span class="n">GC_PSX_POWER</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">gc_psx_delay</span><span class="p">);</span>

		<span class="n">read</span> <span class="o">=</span> <span class="n">parport_read_status</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x80</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">GC_MAX_DEVICES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">gc_pad</span> <span class="o">*</span><span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GC_PSX</span> <span class="o">||</span> <span class="n">pad</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GC_DDR</span><span class="p">)</span>
				<span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">read</span> <span class="o">&amp;</span> <span class="n">gc_status_bit</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">parport_write_data</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">|</span> <span class="n">GC_PSX_CLOCK</span> <span class="o">|</span> <span class="n">GC_PSX_POWER</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">gc_psx_delay</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * gc_psx_read_packet() reads a whole psx packet and returns</span>
<span class="cm"> * device identifier code.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gc_psx_read_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="n">GC_MAX_DEVICES</span><span class="p">][</span><span class="n">GC_PSX_BYTES</span><span class="p">],</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">[</span><span class="n">GC_MAX_DEVICES</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">max_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data2</span><span class="p">[</span><span class="n">GC_MAX_DEVICES</span><span class="p">];</span>

	<span class="cm">/* Select pad */</span>
	<span class="n">parport_write_data</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">GC_PSX_CLOCK</span> <span class="o">|</span> <span class="n">GC_PSX_SELECT</span> <span class="o">|</span> <span class="n">GC_PSX_POWER</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">gc_psx_delay</span><span class="p">);</span>
	<span class="cm">/* Deselect, begin command */</span>
	<span class="n">parport_write_data</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">GC_PSX_CLOCK</span> <span class="o">|</span> <span class="n">GC_PSX_POWER</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">gc_psx_delay</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">gc_psx_command</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">data2</span><span class="p">);</span>	<span class="cm">/* Access pad */</span>
	<span class="n">gc_psx_command</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>		<span class="cm">/* Get device ids */</span>
	<span class="n">gc_psx_command</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data2</span><span class="p">);</span>		<span class="cm">/* Dump status */</span>

	<span class="cm">/* Find the longest pad */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GC_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">gc_pad</span> <span class="o">*</span><span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GC_PSX</span> <span class="o">||</span> <span class="n">pad</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GC_DDR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">GC_PSX_LEN</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">max_len</span> <span class="o">&amp;&amp;</span>
		    <span class="n">GC_PSX_LEN</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">GC_PSX_BYTES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_len</span> <span class="o">=</span> <span class="n">GC_PSX_LEN</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Read in all the data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gc_psx_command</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data2</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">GC_MAX_DEVICES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data2</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">parport_write_data</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">GC_PSX_CLOCK</span> <span class="o">|</span> <span class="n">GC_PSX_SELECT</span> <span class="o">|</span> <span class="n">GC_PSX_POWER</span><span class="p">);</span>

	<span class="cm">/* Set id&#39;s to the real value */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GC_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">GC_PSX_ID</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gc_psx_report_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc_pad</span> <span class="o">*</span><span class="n">pad</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">psx_type</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pad</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">psx_type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">GC_PSX_RUMBLE</span>:

		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_THUMBL</span><span class="p">,</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_THUMBR</span><span class="p">,</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">GC_PSX_NEGCON</span>:
	<span class="k">case</span> <span class="n">GC_PSX_ANALOG</span>:

		<span class="k">if</span> <span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GC_DDR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gc_psx_ddr_btn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						 <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gc_psx_abs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span>
						 <span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>

			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span>
				<span class="o">!!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">*</span> <span class="mi">128</span> <span class="o">+</span> <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">*</span> <span class="mi">127</span><span class="p">);</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span>
				<span class="o">!!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">128</span> <span class="o">+</span> <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">*</span> <span class="mi">127</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gc_psx_btn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">));</span>

		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_START</span><span class="p">,</span>  <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_SELECT</span><span class="p">,</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>

		<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GC_PSX_NORMAL</span>:

		<span class="k">if</span> <span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GC_DDR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gc_psx_ddr_btn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						 <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span>
				<span class="o">!!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">*</span> <span class="mi">128</span> <span class="o">+</span> <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">*</span> <span class="mi">127</span><span class="p">);</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span>
				<span class="o">!!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">128</span> <span class="o">+</span> <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">*</span> <span class="mi">127</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * For some reason if the extra axes are left unset</span>
<span class="cm">			 * they drift.</span>
<span class="cm">			 * for (i = 0; i &lt; 4; i++)</span>
<span class="cm">				input_report_abs(dev, gc_psx_abs[i + 2], 128);</span>
<span class="cm">			 * This needs to be debugged properly,</span>
<span class="cm">			 * maybe fuzz processing needs to be done</span>
<span class="cm">			 * in input_sync()</span>
<span class="cm">			 *				 --vojtech</span>
<span class="cm">			 */</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gc_psx_btn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">));</span>

		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_START</span><span class="p">,</span>  <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_SELECT</span><span class="p">,</span> <span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>

		<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span> <span class="cm">/* not a pad, ignore */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gc_psx_process_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="n">GC_MAX_DEVICES</span><span class="p">][</span><span class="n">GC_PSX_BYTES</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">[</span><span class="n">GC_MAX_DEVICES</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">gc_pad</span> <span class="o">*</span><span class="n">pad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">gc_psx_read_packet</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GC_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GC_PSX</span> <span class="o">||</span> <span class="n">pad</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">GC_DDR</span><span class="p">)</span>
			<span class="n">gc_psx_report_one</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * gc_timer() initiates reads of console pads data.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gc_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">private</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">private</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * N64 pads - must be read first, any read confuses them for 200 us</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pad_count</span><span class="p">[</span><span class="n">GC_N64</span><span class="p">])</span>
		<span class="n">gc_n64_process_packet</span><span class="p">(</span><span class="n">gc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * NES and SNES pads or mouse</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pad_count</span><span class="p">[</span><span class="n">GC_NES</span><span class="p">]</span> <span class="o">||</span>
	    <span class="n">gc</span><span class="o">-&gt;</span><span class="n">pad_count</span><span class="p">[</span><span class="n">GC_SNES</span><span class="p">]</span> <span class="o">||</span>
	    <span class="n">gc</span><span class="o">-&gt;</span><span class="n">pad_count</span><span class="p">[</span><span class="n">GC_SNESMOUSE</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">gc_nes_process_packet</span><span class="p">(</span><span class="n">gc</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Multi and Multi2 joysticks</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pad_count</span><span class="p">[</span><span class="n">GC_MULTI</span><span class="p">]</span> <span class="o">||</span> <span class="n">gc</span><span class="o">-&gt;</span><span class="n">pad_count</span><span class="p">[</span><span class="n">GC_MULTI2</span><span class="p">])</span>
		<span class="n">gc_multi_process_packet</span><span class="p">(</span><span class="n">gc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * PSX controllers</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pad_count</span><span class="p">[</span><span class="n">GC_PSX</span><span class="p">]</span> <span class="o">||</span> <span class="n">gc</span><span class="o">-&gt;</span><span class="n">pad_count</span><span class="p">[</span><span class="n">GC_DDR</span><span class="p">])</span>
		<span class="n">gc_psx_process_packet</span><span class="p">(</span><span class="n">gc</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">GC_REFRESH_TIME</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">used</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parport_claim</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">);</span>
		<span class="n">parport_write_control</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">GC_REFRESH_TIME</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gc_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">parport_write_control</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">parport_release</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">gc_setup_pad</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pad_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gc_pad</span> <span class="o">*</span><span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pad_type</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">pad_type</span> <span class="o">&gt;=</span> <span class="n">GC_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Pad type %d unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pad_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pad</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Not enough memory for input device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pad</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">pad_type</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">),</span>
		 <span class="s">&quot;%s/input%d&quot;</span><span class="p">,</span> <span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">gc_names</span><span class="p">[</span><span class="n">pad_type</span><span class="p">];</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">pad</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_PARPORT</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">pad_type</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">;</span>

	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">gc</span><span class="p">);</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">gc_open</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">gc_close</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pad_type</span> <span class="o">!=</span> <span class="n">GC_SNESMOUSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_X</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_REL</span><span class="p">);</span>

	<span class="n">gc</span><span class="o">-&gt;</span><span class="n">pad_count</span><span class="p">[</span><span class="n">pad_type</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pad_type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">GC_N64</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">gc_n64_btn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_X</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">127</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_HAT0X</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">gc_n64_init_ff</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Failed to initiate rumble for N64 device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GC_SNESMOUSE</span>:
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">REL_X</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">REL_Y</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GC_SNES</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">gc_snes_btn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">GC_NES</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">gc_snes_btn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GC_MULTI2</span>:
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_THUMB</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">GC_MULTI</span>:
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TRIGGER</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GC_PSX</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span>
					     <span class="n">gc_psx_abs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">gc_psx_btn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GC_DDR</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">gc_psx_ddr_btn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">gc_psx_btn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_dev:</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pad</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gc</span> <span class="n">__init</span> <span class="o">*</span><span class="nf">gc_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">parport</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pads</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_pads</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pardevice</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pp</span> <span class="o">=</span> <span class="n">parport_find_number</span><span class="p">(</span><span class="n">parport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no such parport %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">parport</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pd</span> <span class="o">=</span> <span class="n">parport_register_device</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="s">&quot;gamecon&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">PARPORT_DEV_EXCL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;parport busy already - lp.o loaded?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_put_pp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Not enough memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unreg_pardev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span> <span class="o">=</span> <span class="n">pd</span><span class="p">;</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">gc_timer</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">gc</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_pads</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GC_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pads</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">gc_setup_pad</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pads</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_unreg_devs</span><span class="p">;</span>

		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No valid devices specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_gc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">parport_put_port</span><span class="p">(</span><span class="n">pp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">gc</span><span class="p">;</span>

 <span class="nl">err_unreg_devs:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">err_free_gc:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gc</span><span class="p">);</span>
 <span class="nl">err_unreg_pardev:</span>
	<span class="n">parport_unregister_device</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
 <span class="nl">err_put_pp:</span>
	<span class="n">parport_put_port</span><span class="p">(</span><span class="n">pp</span><span class="p">);</span>
 <span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">gc</span> <span class="o">*</span><span class="n">gc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GC_MAX_DEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">parport_unregister_device</span><span class="p">(</span><span class="n">gc</span><span class="o">-&gt;</span><span class="n">pd</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">gc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">have_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GC_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gc_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nargs</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">gc_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gc_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nargs</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;at least one device must be specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">gc_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gc_probe</span><span class="p">(</span><span class="n">gc_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				      <span class="n">gc_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">args</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gc_cfg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nargs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">gc_base</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gc_base</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">have_dev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gc_base</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">gc_remove</span><span class="p">(</span><span class="n">gc_base</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">have_dev</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">gc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GC_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gc_base</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">gc_remove</span><span class="p">(</span><span class="n">gc_base</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">gc_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">gc_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
