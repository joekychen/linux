<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › touchscreen › wm9712.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>wm9712.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * wm9712.c  --  Codec driver for Wolfson WM9712 AC97 Codecs.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2003, 2004, 2005, 2006, 2007 Wolfson Microelectronics PLC.</span>
<span class="cm"> * Author: Liam Girdwood &lt;lrg@slimlogic.co.uk&gt;</span>
<span class="cm"> * Parts Copyright : Ian Molton &lt;spyro@f2s.com&gt;</span>
<span class="cm"> *                   Andrew Zabolotny &lt;zap@homelink.ru&gt;</span>
<span class="cm"> *                   Russell King &lt;rmk@arm.linux.org.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> *  under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> *  Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> *  option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/wm97xx.h&gt;</span>

<span class="cp">#define TS_NAME			&quot;wm97xx&quot;</span>
<span class="cp">#define WM9712_VERSION		&quot;1.00&quot;</span>
<span class="cp">#define DEFAULT_PRESSURE	0xb0c0</span>

<span class="cm">/*</span>
<span class="cm"> * Module parameters</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Set internal pull up for pen detect.</span>
<span class="cm"> *</span>
<span class="cm"> * Pull up is in the range 1.02k (least sensitive) to 64k (most sensitive)</span>
<span class="cm"> * i.e. pull up resistance = 64k Ohms / rpu.</span>
<span class="cm"> *</span>
<span class="cm"> * Adjust this value if you are having problems with pen detect not</span>
<span class="cm"> * detecting any down event.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rpu</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rpu</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rpu</span><span class="p">,</span> <span class="s">&quot;Set internal pull up resitor for pen detect.&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Set current used for pressure measurement.</span>
<span class="cm"> *</span>
<span class="cm"> * Set pil = 2 to use 400uA</span>
<span class="cm"> *     pil = 1 to use 200uA and</span>
<span class="cm"> *     pil = 0 to disable pressure measurement.</span>
<span class="cm"> *</span>
<span class="cm"> * This is used to increase the range of values returned by the adc</span>
<span class="cm"> * when measureing touchpanel pressure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pil</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pil</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pil</span><span class="p">,</span> <span class="s">&quot;Set current used for pressure measurement.&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Set threshold for pressure measurement.</span>
<span class="cm"> *</span>
<span class="cm"> * Pen down pressure below threshold is ignored.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pressure</span> <span class="o">=</span> <span class="n">DEFAULT_PRESSURE</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="s">&quot;Set threshold for pressure measurement.&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Set adc sample delay.</span>
<span class="cm"> *</span>
<span class="cm"> * For accurate touchpanel measurements, some settling time may be</span>
<span class="cm"> * required between the switch matrix applying a voltage across the</span>
<span class="cm"> * touchpanel plate and the ADC sampling the signal.</span>
<span class="cm"> *</span>
<span class="cm"> * This delay can be set by setting delay = n, where n is the array</span>
<span class="cm"> * position of the delay in the array delay_table below.</span>
<span class="cm"> * Long delays &gt; 1ms are supported for completeness, but are not</span>
<span class="cm"> * recommended.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="s">&quot;Set adc sample delay.&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Set five_wire = 1 to use a 5 wire touchscreen.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: Five wire mode does not allow for readback of pressure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">five_wire</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">five_wire</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">five_wire</span><span class="p">,</span> <span class="s">&quot;Set to &#39;1&#39; to use 5-wire touchscreen.&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Set adc mask function.</span>
<span class="cm"> *</span>
<span class="cm"> * Sources of glitch noise, such as signals driving an LCD display, may feed</span>
<span class="cm"> * through to the touch screen plates and affect measurement accuracy. In</span>
<span class="cm"> * order to minimise this, a signal may be applied to the MASK pin to delay or</span>
<span class="cm"> * synchronise the sampling.</span>
<span class="cm"> *</span>
<span class="cm"> * 0 = No delay or sync</span>
<span class="cm"> * 1 = High on pin stops conversions</span>
<span class="cm"> * 2 = Edge triggered, edge on pin delays conversion by delay param (above)</span>
<span class="cm"> * 3 = Edge triggered, edge on pin starts conversion after delay param</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s">&quot;Set adc mask function.&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Coordinate Polling Enable.</span>
<span class="cm"> *</span>
<span class="cm"> * Set to 1 to enable coordinate polling. e.g. x,y[,p] is sampled together</span>
<span class="cm"> * for every poll.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">coord</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="s">&quot;Polling coordinate mode&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * ADC sample delay times in uS</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">delay_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">21</span><span class="p">,</span>    <span class="cm">/* 1 AC97 Link frames */</span>
	<span class="mi">42</span><span class="p">,</span>    <span class="cm">/* 2 */</span>
	<span class="mi">84</span><span class="p">,</span>    <span class="cm">/* 4 */</span>
	<span class="mi">167</span><span class="p">,</span>   <span class="cm">/* 8 */</span>
	<span class="mi">333</span><span class="p">,</span>   <span class="cm">/* 16 */</span>
	<span class="mi">667</span><span class="p">,</span>   <span class="cm">/* 32 */</span>
	<span class="mi">1000</span><span class="p">,</span>  <span class="cm">/* 48 */</span>
	<span class="mi">1333</span><span class="p">,</span>  <span class="cm">/* 64 */</span>
	<span class="mi">2000</span><span class="p">,</span>  <span class="cm">/* 96 */</span>
	<span class="mi">2667</span><span class="p">,</span>  <span class="cm">/* 128 */</span>
	<span class="mi">3333</span><span class="p">,</span>  <span class="cm">/* 160 */</span>
	<span class="mi">4000</span><span class="p">,</span>  <span class="cm">/* 192 */</span>
	<span class="mi">4667</span><span class="p">,</span>  <span class="cm">/* 224 */</span>
	<span class="mi">5333</span><span class="p">,</span>  <span class="cm">/* 256 */</span>
	<span class="mi">6000</span><span class="p">,</span>  <span class="cm">/* 288 */</span>
	<span class="mi">0</span>      <span class="cm">/* No delay, switch matrix always on */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Delay after issuing a POLL command.</span>
<span class="cm"> *</span>
<span class="cm"> * The delay is 3 AC97 link frames + the touchpanel settling delay</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">poll_delay</span><span class="p">(</span><span class="kt">int</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">AC97_LINK_FRAME</span> <span class="o">+</span> <span class="n">delay_table</span><span class="p">[</span><span class="n">d</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set up the physical settings of the WM9712</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wm9712_phy_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dig1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dig2</span> <span class="o">=</span> <span class="n">WM97XX_RPR</span> <span class="o">|</span> <span class="n">WM9712_RPU</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* WM9712 rpu */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dig2</span> <span class="o">&amp;=</span> <span class="mh">0xffc0</span><span class="p">;</span>
		<span class="n">dig2</span> <span class="o">|=</span> <span class="n">WM9712_RPU</span><span class="p">(</span><span class="n">rpu</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setting pen detect pull-up to %d Ohms&quot;</span><span class="p">,</span>
			<span class="mi">64000</span> <span class="o">/</span> <span class="n">rpu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* WM9712 five wire */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">five_wire</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dig2</span> <span class="o">|=</span> <span class="n">WM9712_45W</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setting 5-wire touchscreen mode.&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pil</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pressure measurement is not &quot;</span>
				 <span class="s">&quot;supported in 5-wire mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pil</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* touchpanel pressure current*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pil</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dig2</span> <span class="o">|=</span> <span class="n">WM9712_PIL</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;setting pressure measurement current to 400uA.&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pil</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;setting pressure measurement current to 200uA.&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pil</span><span class="p">)</span>
		<span class="n">pressure</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* polling mode sample settling delay */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">delay</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;supplied delay out of range.&quot;</span><span class="p">);</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dig1</span> <span class="o">&amp;=</span> <span class="mh">0xff0f</span><span class="p">;</span>
	<span class="n">dig1</span> <span class="o">|=</span> <span class="n">WM97XX_DELAY</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setting adc sample delay to %d u Secs.&quot;</span><span class="p">,</span>
		<span class="n">delay_table</span><span class="p">[</span><span class="n">delay</span><span class="p">]);</span>

	<span class="cm">/* mask */</span>
	<span class="n">dig2</span> <span class="o">|=</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
		<span class="cm">/* Set GPIO4 as Mask Pin*/</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_MISC_AFE</span><span class="p">);</span>
		<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_MISC_AFE</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="n">WM97XX_GPIO_4</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_CFG</span><span class="p">);</span>
		<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_CFG</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="n">WM97XX_GPIO_4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* wait - coord mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">coord</span><span class="p">)</span>
		<span class="n">dig2</span> <span class="o">|=</span> <span class="n">WM9712_WAIT</span><span class="p">;</span>

	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER1</span><span class="p">,</span> <span class="n">dig1</span><span class="p">);</span>
	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER2</span><span class="p">,</span> <span class="n">dig2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wm9712_dig_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dig2</span> <span class="o">=</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">dig</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER2</span><span class="p">,</span>
				 <span class="n">dig2</span> <span class="o">|</span> <span class="n">WM97XX_PRP_DET_DIG</span><span class="p">);</span>
		<span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER_RD</span><span class="p">);</span> <span class="cm">/* dummy read */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER2</span><span class="p">,</span>
				 <span class="n">dig2</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">WM97XX_PRP_DET_DIG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wm9712_aux_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dig_save</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">dig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dig</span><span class="p">));</span>
	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER2</span><span class="p">,</span> <span class="n">WM97XX_PRP_DET_DIG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wm9712_dig_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER1</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">dig_save</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER2</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">dig_save</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_pden</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">dig</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">WM9712_PDEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read a sample from the WM9712 adc in polling mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm9712_poll_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adcsel</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">sample</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">delay</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">wants_pen</span> <span class="o">=</span> <span class="n">adcsel</span> <span class="o">&amp;</span> <span class="n">WM97XX_PEN_DOWN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wants_pen</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_probably_down</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER_RD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">WM97XX_PEN_DOWN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">RC_PENUP</span><span class="p">;</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_probably_down</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set up digitiser */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span> <span class="o">&amp;&amp;</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">pre_sample</span><span class="p">)</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">pre_sample</span><span class="p">(</span><span class="n">adcsel</span><span class="p">);</span>
	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER1</span><span class="p">,</span> <span class="p">(</span><span class="n">adcsel</span> <span class="o">&amp;</span> <span class="n">WM97XX_ADCSEL_MASK</span><span class="p">)</span>
				<span class="o">|</span> <span class="n">WM97XX_POLL</span> <span class="o">|</span> <span class="n">WM97XX_DELAY</span><span class="p">(</span><span class="n">delay</span><span class="p">));</span>

	<span class="cm">/* wait 3 AC97 time slots + delay for conversion */</span>
	<span class="n">poll_delay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>

	<span class="cm">/* wait for POLL to go low */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WM97XX_POLL</span><span class="p">)</span>
	       <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">AC97_LINK_FRAME</span><span class="p">);</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If PDEN is set, we can get a timeout when pen goes up */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_pden</span><span class="p">(</span><span class="n">wm</span><span class="p">))</span>
			<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_probably_down</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adc sample timeout&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RC_PENUP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">sample</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER_RD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span> <span class="o">&amp;&amp;</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">post_sample</span><span class="p">)</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">post_sample</span><span class="p">(</span><span class="n">adcsel</span><span class="p">);</span>

	<span class="cm">/* check we have correct sample */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">sample</span> <span class="o">^</span> <span class="n">adcsel</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WM97XX_ADCSEL_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adc wrong sample, wanted %x got %x&quot;</span><span class="p">,</span>
			<span class="n">adcsel</span> <span class="o">&amp;</span> <span class="n">WM97XX_ADCSEL_MASK</span><span class="p">,</span>
			<span class="o">*</span><span class="n">sample</span> <span class="o">&amp;</span> <span class="n">WM97XX_ADCSEL_MASK</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RC_PENUP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wants_pen</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">sample</span> <span class="o">&amp;</span> <span class="n">WM97XX_PEN_DOWN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_probably_down</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">RC_PENUP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">RC_VALID</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read a coord from the WM9712 adc in polling mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm9712_poll_coord</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wm97xx_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">delay</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_probably_down</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">data_rd</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER_RD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data_rd</span> <span class="o">&amp;</span> <span class="n">WM97XX_PEN_DOWN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">RC_PENUP</span><span class="p">;</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_probably_down</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set up digitiser */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span> <span class="o">&amp;&amp;</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">pre_sample</span><span class="p">)</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">pre_sample</span><span class="p">(</span><span class="n">WM97XX_ADCSEL_X</span> <span class="o">|</span> <span class="n">WM97XX_ADCSEL_Y</span><span class="p">);</span>

	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER1</span><span class="p">,</span>
		<span class="n">WM97XX_COO</span> <span class="o">|</span> <span class="n">WM97XX_POLL</span> <span class="o">|</span> <span class="n">WM97XX_DELAY</span><span class="p">(</span><span class="n">delay</span><span class="p">));</span>

	<span class="cm">/* wait 3 AC97 time slots + delay for conversion and read x */</span>
	<span class="n">poll_delay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER_RD</span><span class="p">);</span>
	<span class="cm">/* wait for POLL to go low */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WM97XX_POLL</span><span class="p">)</span>
	       <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">AC97_LINK_FRAME</span><span class="p">);</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If PDEN is set, we can get a timeout when pen goes up */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_pden</span><span class="p">(</span><span class="n">wm</span><span class="p">))</span>
			<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_probably_down</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adc sample timeout&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RC_PENUP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read back y data */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER_RD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pil</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER_RD</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">DEFAULT_PRESSURE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span> <span class="o">&amp;&amp;</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">post_sample</span><span class="p">)</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">post_sample</span><span class="p">(</span><span class="n">WM97XX_ADCSEL_X</span> <span class="o">|</span> <span class="n">WM97XX_ADCSEL_Y</span><span class="p">);</span>

	<span class="cm">/* check we have correct sample */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">WM97XX_ADCSEL_X</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">&amp;</span> <span class="n">WM97XX_ADCSEL_Y</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pil</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">WM97XX_ADCSEL_PRES</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">WM97XX_PEN_DOWN</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">&amp;</span> <span class="n">WM97XX_PEN_DOWN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_probably_down</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">RC_PENUP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">RC_VALID</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sample the WM9712 touchscreen in polling mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm9712_poll_touch</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wm97xx_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">wm9712_poll_coord</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">RC_VALID</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">wm9712_poll_sample</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">WM97XX_ADCSEL_X</span> <span class="o">|</span> <span class="n">WM97XX_PEN_DOWN</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">RC_VALID</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">wm9712_poll_sample</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">WM97XX_ADCSEL_Y</span> <span class="o">|</span> <span class="n">WM97XX_PEN_DOWN</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">RC_VALID</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pil</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">five_wire</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">wm9712_poll_sample</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">WM97XX_ADCSEL_PRES</span> <span class="o">|</span> <span class="n">WM97XX_PEN_DOWN</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">RC_VALID</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">DEFAULT_PRESSURE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">RC_VALID</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enable WM9712 continuous mode, i.e. touch data is streamed across</span>
<span class="cm"> * an AC97 slot</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm9712_acc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dig1</span><span class="p">,</span> <span class="n">dig2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dig1</span> <span class="o">=</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">dig</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">dig2</span> <span class="o">=</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">dig</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* continuous mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">acc_startup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">acc_startup</span><span class="p">(</span><span class="n">wm</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dig1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">WM97XX_CM_RATE_MASK</span> <span class="o">|</span> <span class="n">WM97XX_ADCSEL_MASK</span> <span class="o">|</span>
			<span class="n">WM97XX_DELAY_MASK</span> <span class="o">|</span> <span class="n">WM97XX_SLT_MASK</span><span class="p">);</span>
		<span class="n">dig1</span> <span class="o">|=</span> <span class="n">WM97XX_CTC</span> <span class="o">|</span> <span class="n">WM97XX_COO</span> <span class="o">|</span> <span class="n">WM97XX_SLEN</span> <span class="o">|</span>
			<span class="n">WM97XX_DELAY</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">WM97XX_SLT</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">acc_slot</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">WM97XX_RATE</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">acc_rate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pil</span><span class="p">)</span>
			<span class="n">dig1</span> <span class="o">|=</span> <span class="n">WM97XX_ADCSEL_PRES</span><span class="p">;</span>
		<span class="n">dig2</span> <span class="o">|=</span> <span class="n">WM9712_PDEN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dig1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">WM97XX_CTC</span> <span class="o">|</span> <span class="n">WM97XX_COO</span> <span class="o">|</span> <span class="n">WM97XX_SLEN</span><span class="p">);</span>
		<span class="n">dig2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WM9712_PDEN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">acc_shutdown</span><span class="p">)</span>
			<span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">acc_shutdown</span><span class="p">(</span><span class="n">wm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER1</span><span class="p">,</span> <span class="n">dig1</span><span class="p">);</span>
	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER2</span><span class="p">,</span> <span class="n">dig2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">wm97xx_codec_drv</span> <span class="n">wm9712_codec</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">WM9712_ID2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;wm9712&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll_sample</span> <span class="o">=</span> <span class="n">wm9712_poll_sample</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll_touch</span> <span class="o">=</span> <span class="n">wm9712_poll_touch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">acc_enable</span> <span class="o">=</span> <span class="n">wm9712_acc_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_init</span> <span class="o">=</span> <span class="n">wm9712_phy_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dig_enable</span> <span class="o">=</span> <span class="n">wm9712_dig_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dig_restore</span> <span class="o">=</span> <span class="n">wm9712_dig_restore</span><span class="p">,</span>
	<span class="p">.</span><span class="n">aux_prepare</span> <span class="o">=</span> <span class="n">wm9712_aux_prepare</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wm9712_codec</span><span class="p">);</span>

<span class="cm">/* Module information */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Liam Girdwood &lt;lrg@slimlogic.co.uk&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;WM9712 Touch Screen Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
