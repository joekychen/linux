<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › touchscreen › usbtouchscreen.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>usbtouchscreen.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> * usbtouchscreen.c</span>
<span class="cm"> * Driver for USB Touchscreens, supporting those devices:</span>
<span class="cm"> *  - eGalax Touchkit</span>
<span class="cm"> *    includes eTurboTouch CT-410/510/700</span>
<span class="cm"> *  - 3M/Microtouch  EX II series</span>
<span class="cm"> *  - ITM</span>
<span class="cm"> *  - PanJit TouchSet</span>
<span class="cm"> *  - eTurboTouch</span>
<span class="cm"> *  - Gunze AHL61</span>
<span class="cm"> *  - DMC TSC-10/25</span>
<span class="cm"> *  - IRTOUCHSYSTEMS/UNITOP</span>
<span class="cm"> *  - IdealTEK URTC1000</span>
<span class="cm"> *  - General Touch</span>
<span class="cm"> *  - GoTop Super_Q2/GogoPen/PenPower tablets</span>
<span class="cm"> *  - JASTEC USB touch controller/DigiTech DTR-02U</span>
<span class="cm"> *  - Zytronic capacitive touchscreen</span>
<span class="cm"> *  - NEXIO/iNexio</span>
<span class="cm"> *  - Elo TouchSystems 2700 IntelliTouch</span>
<span class="cm"> *  - EasyTouch USB Dual/Multi touch controller from Data Modul</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004-2007 by Daniel Ritz &lt;daniel.ritz@gmx.ch&gt;</span>
<span class="cm"> * Copyright (C) by Todd E. Johnson (mtouchusb.c)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; either version 2 of the</span>
<span class="cm"> * License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Driver is based on touchkitusb.c</span>
<span class="cm"> * - ITM parts are from itmtouch.c</span>
<span class="cm"> * - 3M parts are from mtouchusb.c</span>
<span class="cm"> * - PanJit parts are from an unmerged driver by Lanslott Gish</span>
<span class="cm"> * - DMC TSC 10/25 are from Holger Schurig, with ideas from an unmerged</span>
<span class="cm"> *   driver from Marius Vollmer</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define DEBUG</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/input.h&gt;</span>
<span class="cp">#include &lt;linux/hid.h&gt;</span>


<span class="cp">#define DRIVER_VERSION		&quot;v0.6&quot;</span>
<span class="cp">#define DRIVER_AUTHOR		&quot;Daniel Ritz &lt;daniel.ritz@gmx.ch&gt;&quot;</span>
<span class="cp">#define DRIVER_DESC		&quot;USB Touchscreen Driver&quot;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">swap_xy</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">swap_xy</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">swap_xy</span><span class="p">,</span> <span class="s">&quot;If set X and Y axes are swapped.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">hwcalib_xy</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">hwcalib_xy</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hwcalib_xy</span><span class="p">,</span> <span class="s">&quot;If set hw-calibrated X/Y are used if available&quot;</span><span class="p">);</span>

<span class="cm">/* device specifc data/functions */</span>
<span class="k">struct</span> <span class="n">usbtouch_usb</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">usbtouch_device_info</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">min_xc</span><span class="p">,</span> <span class="n">max_xc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_yc</span><span class="p">,</span> <span class="n">max_yc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_press</span><span class="p">,</span> <span class="n">max_press</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rept_size</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Always service the USB devices irq not just when the input device is</span>
<span class="cm">	 * open. This is useful when devices have a watchdog which prevents us</span>
<span class="cm">	 * from periodically polling the device. Leave this unset unless your</span>
<span class="cm">	 * touchscreen device requires it, as it does consume more of the USB</span>
<span class="cm">	 * bandwidth.</span>
<span class="cm">	 */</span>
	<span class="n">bool</span> <span class="n">irq_always</span><span class="p">;</span>

	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">process_pkt</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * used to get the packet len. possible return values:</span>
<span class="cm">	 * &gt; 0: packet len</span>
<span class="cm">	 * = 0: skip one byte</span>
<span class="cm">	 * &lt; 0: -return value more bytes needed</span>
<span class="cm">	 */</span>
	<span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">get_pkt_len</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>

	<span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">read_data</span><span class="p">)</span>   <span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">);</span>
	<span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">alloc</span><span class="p">)</span>       <span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">);</span>
	<span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)</span>        <span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">exit</span><span class="p">)</span>	    <span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/* a usbtouch device */</span>
<span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">data_dma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbtouch_device_info</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">touch</span><span class="p">,</span> <span class="n">press</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/* device types */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">DEVTYPE_IGNORE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">DEVTYPE_EGALAX</span><span class="p">,</span>
	<span class="n">DEVTYPE_PANJIT</span><span class="p">,</span>
	<span class="n">DEVTYPE_3M</span><span class="p">,</span>
	<span class="n">DEVTYPE_ITM</span><span class="p">,</span>
	<span class="n">DEVTYPE_ETURBO</span><span class="p">,</span>
	<span class="n">DEVTYPE_GUNZE</span><span class="p">,</span>
	<span class="n">DEVTYPE_DMC_TSC10</span><span class="p">,</span>
	<span class="n">DEVTYPE_IRTOUCH</span><span class="p">,</span>
	<span class="n">DEVTYPE_IDEALTEK</span><span class="p">,</span>
	<span class="n">DEVTYPE_GENERAL_TOUCH</span><span class="p">,</span>
	<span class="n">DEVTYPE_GOTOP</span><span class="p">,</span>
	<span class="n">DEVTYPE_JASTEC</span><span class="p">,</span>
	<span class="n">DEVTYPE_E2I</span><span class="p">,</span>
	<span class="n">DEVTYPE_ZYTRONIC</span><span class="p">,</span>
	<span class="n">DEVTYPE_TC45USB</span><span class="p">,</span>
	<span class="n">DEVTYPE_NEXIO</span><span class="p">,</span>
	<span class="n">DEVTYPE_ELO</span><span class="p">,</span>
	<span class="n">DEVTYPE_ETOUCH</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define USB_DEVICE_HID_CLASS(vend, prod) \</span>
<span class="cp">	.match_flags = USB_DEVICE_ID_MATCH_INT_CLASS \</span>
<span class="cp">		| USB_DEVICE_ID_MATCH_INT_PROTOCOL \</span>
<span class="cp">		| USB_DEVICE_ID_MATCH_DEVICE, \</span>
<span class="cp">	.idVendor = (vend), \</span>
<span class="cp">	.idProduct = (prod), \</span>
<span class="cp">	.bInterfaceClass = USB_INTERFACE_CLASS_HID, \</span>
<span class="cp">	.bInterfaceProtocol = USB_INTERFACE_PROTOCOL_MOUSE</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">usbtouch_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_EGALAX</span>
	<span class="cm">/* ignore the HID capable devices, handled by usbhid */</span>
	<span class="p">{</span><span class="n">USB_DEVICE_HID_CLASS</span><span class="p">(</span><span class="mh">0x0eef</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_IGNORE</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE_HID_CLASS</span><span class="p">(</span><span class="mh">0x0eef</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_IGNORE</span><span class="p">},</span>

	<span class="cm">/* normal device IDs */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x3823</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_EGALAX</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x3823</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_EGALAX</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0123</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_EGALAX</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0eef</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_EGALAX</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0eef</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_EGALAX</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1234</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_EGALAX</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1234</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_EGALAX</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_PANJIT</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x134c</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_PANJIT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x134c</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_PANJIT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x134c</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_PANJIT</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x134c</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_PANJIT</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_3M</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0596</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_3M</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_ITM</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0403</span><span class="p">,</span> <span class="mh">0xf9e9</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_ITM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x16e3</span><span class="p">,</span> <span class="mh">0xf9e9</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_ITM</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_ETURBO</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1234</span><span class="p">,</span> <span class="mh">0x5678</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_ETURBO</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_GUNZE</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0637</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_GUNZE</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_DMC_TSC10</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0afa</span><span class="p">,</span> <span class="mh">0x03e8</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_DMC_TSC10</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_IRTOUCH</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x595a</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_IRTOUCH</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x6615</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_IRTOUCH</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_IDEALTEK</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1391</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_IDEALTEK</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_GENERAL_TOUCH</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0dfc</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_GENERAL_TOUCH</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_GOTOP</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x08f2</span><span class="p">,</span> <span class="mh">0x007f</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_GOTOP</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x08f2</span><span class="p">,</span> <span class="mh">0x00ce</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_GOTOP</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x08f2</span><span class="p">,</span> <span class="mh">0x00f4</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_GOTOP</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_JASTEC</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0f92</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_JASTEC</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_E2I</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1ac7</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_E2I</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_ZYTRONIC</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x14c8</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_ZYTRONIC</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_ETT_TC45USB</span>
	<span class="cm">/* TC5UH */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0664</span><span class="p">,</span> <span class="mh">0x0309</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_TC45USB</span><span class="p">},</span>
	<span class="cm">/* TC4UM */</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0664</span><span class="p">,</span> <span class="mh">0x0306</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_TC45USB</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_NEXIO</span>
	<span class="cm">/* data interface only */</span>
	<span class="p">{</span><span class="n">USB_DEVICE_AND_INTERFACE_INFO</span><span class="p">(</span><span class="mh">0x10f0</span><span class="p">,</span> <span class="mh">0x2002</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_NEXIO</span><span class="p">},</span>
	<span class="p">{</span><span class="n">USB_DEVICE_AND_INTERFACE_INFO</span><span class="p">(</span><span class="mh">0x1870</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_NEXIO</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_ELO</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x04e7</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_ELO</span><span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_EASYTOUCH</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x7374</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">DEVTYPE_ETOUCH</span><span class="p">},</span>
<span class="cp">#endif</span>

	<span class="p">{}</span>
<span class="p">};</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * e2i Part</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_E2I</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">e2i_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	                      <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0081</span><span class="p">,</span>
	                      <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">USB_CTRL_SET_TIMEOUT</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s - usb_control_msg - E2I_RESET - bytes|err: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e2i_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span>  <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span>  <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="mh">0xA000</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">press</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">tmp</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * eGalax part</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_EGALAX</span>

<span class="cp">#ifndef MULTI_PACKET</span>
<span class="cp">#define MULTI_PACKET</span>
<span class="cp">#endif</span>

<span class="cp">#define EGALAX_PKT_TYPE_MASK		0xFE</span>
<span class="cp">#define EGALAX_PKT_TYPE_REPT		0x80</span>
<span class="cp">#define EGALAX_PKT_TYPE_DIAG		0x0A</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">egalax_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">EGALAX_PKT_TYPE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EGALAX_PKT_TYPE_REPT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">egalax_get_pkt_len</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">EGALAX_PKT_TYPE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EGALAX_PKT_TYPE_REPT</span>:
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EGALAX_PKT_TYPE_DIAG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * EasyTouch part</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_EASYTOUCH</span>

<span class="cp">#ifndef MULTI_PACKET</span>
<span class="cp">#define MULTI_PACKET</span>
<span class="cp">#endif</span>

<span class="cp">#define ETOUCH_PKT_TYPE_MASK		0xFE</span>
<span class="cp">#define ETOUCH_PKT_TYPE_REPT		0x80</span>
<span class="cp">#define ETOUCH_PKT_TYPE_REPT2		0xB0</span>
<span class="cp">#define ETOUCH_PKT_TYPE_DIAG		0x0A</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">etouch_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ETOUCH_PKT_TYPE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ETOUCH_PKT_TYPE_REPT</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ETOUCH_PKT_TYPE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ETOUCH_PKT_TYPE_REPT2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">etouch_get_pkt_len</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ETOUCH_PKT_TYPE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETOUCH_PKT_TYPE_REPT</span>:
	<span class="k">case</span> <span class="n">ETOUCH_PKT_TYPE_REPT2</span>:
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ETOUCH_PKT_TYPE_DIAG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * PanJit Part</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_PANJIT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">panjit_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * 3M/Microtouch Part</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_3M</span>

<span class="cp">#define MTOUCHUSB_ASYNC_REPORT          1</span>
<span class="cp">#define MTOUCHUSB_RESET                 7</span>
<span class="cp">#define MTOUCHUSB_REQ_CTRLLR_ID         10</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mtouch_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwcalib_xy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="mh">0xffff</span> <span class="o">-</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mtouch_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	                      <span class="n">MTOUCHUSB_RESET</span><span class="p">,</span>
	                      <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
	                      <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">USB_CTRL_SET_TIMEOUT</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s - usb_control_msg - MTOUCHUSB_RESET - bytes|err: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				      <span class="n">MTOUCHUSB_ASYNC_REPORT</span><span class="p">,</span>
				      <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
				      <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">USB_CTRL_SET_TIMEOUT</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - usb_control_msg - MTOUCHUSB_ASYNC_REPORT - bytes|err: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Default min/max xy are the raw values, override if using hw-calib */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwcalib_xy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * ITM Part</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_ITM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">itm_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">touch</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * ITM devices report invalid x/y data if not touched.</span>
<span class="cm">	 * if the screen was touched before but is not touched any more</span>
<span class="cm">	 * report touch as 0 with the last valid x/y data once. then stop</span>
<span class="cm">	 * reporting data until touched again.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">press</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">);</span>

	<span class="n">touch</span> <span class="o">=</span> <span class="o">~</span><span class="n">pkt</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">touch</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="n">touch</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * eTurboTouch part</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_ETURBO</span>
<span class="cp">#ifndef MULTI_PACKET</span>
<span class="cp">#define MULTI_PACKET</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">eturbo_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>

	<span class="cm">/* packets should start with sync */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span> <span class="o">-</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eturbo_get_pkt_len</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Gunze part</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_GUNZE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gunze_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * DMC TSC-10/25 Part</span>
<span class="cm"> *</span>
<span class="cm"> * Documentation about the controller and it&#39;s protocol can be found at</span>
<span class="cm"> *   http://www.dmccoltd.com/files/controler/tsc10usb_pi_e.pdf</span>
<span class="cm"> *   http://www.dmccoltd.com/files/controler/tsc25_usb_e.pdf</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_DMC_TSC10</span>

<span class="cm">/* supported data rates. currently using 130 */</span>
<span class="cp">#define TSC10_RATE_POINT	0x50</span>
<span class="cp">#define TSC10_RATE_30		0x40</span>
<span class="cp">#define TSC10_RATE_50		0x41</span>
<span class="cp">#define TSC10_RATE_80		0x42</span>
<span class="cp">#define TSC10_RATE_100		0x43</span>
<span class="cp">#define TSC10_RATE_130		0x44</span>
<span class="cp">#define TSC10_RATE_150		0x45</span>

<span class="cm">/* commands */</span>
<span class="cp">#define TSC10_CMD_RESET		0x55</span>
<span class="cp">#define TSC10_CMD_RATE		0x05</span>
<span class="cp">#define TSC10_CMD_DATA1		0x01</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmc_tsc10_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_nobuf</span><span class="p">;</span>
	<span class="cm">/* reset */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	                      <span class="n">TSC10_CMD_RESET</span><span class="p">,</span>
	                      <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
	                      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">USB_CTRL_SET_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x06</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set coordinate output rate */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	                      <span class="n">TSC10_CMD_RATE</span><span class="p">,</span>
	                      <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
	                      <span class="n">TSC10_RATE_150</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">USB_CTRL_SET_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x06</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x15</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* start sending data */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	                      <span class="n">TSC10_CMD_DATA1</span><span class="p">,</span>
	                      <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
	                      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">USB_CTRL_SET_TIMEOUT</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="nl">err_nobuf:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmc_tsc10_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * IRTOUCH Part</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_IRTOUCH</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">irtouch_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * ET&amp;T TC5UH/TC4UM part</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_ETT_TC45USB</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc45usb_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * IdealTEK URTC1000 Part</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_IDEALTEK</span>
<span class="cp">#ifndef MULTI_PACKET</span>
<span class="cp">#define MULTI_PACKET</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">idealtek_get_pkt_len</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">idealtek_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x98</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x88</span>:
		<span class="cm">/* touch data in IdealTEK mode */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x98</span>:
		<span class="cm">/* touch data in MT emulation mode */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * General Touch Part</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_GENERAL_TOUCH</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">general_touch_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">press</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * GoTop Part</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_GOTOP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gotop_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * JASTEC Part</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_JASTEC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">jastec_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Zytronic Part</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_ZYTRONIC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">zytronic_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x3A</span>: <span class="cm">/* command response */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Command response %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0xC0</span>: <span class="cm">/* down */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: down %d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x80</span>: <span class="cm">/* up */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: up %d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Unknown return %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * NEXIO Part</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_NEXIO</span>

<span class="cp">#define NEXIO_TIMEOUT	5000</span>
<span class="cp">#define NEXIO_BUFSIZE	1024</span>
<span class="cp">#define NEXIO_THRESHOLD	50</span>

<span class="k">struct</span> <span class="n">nexio_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">ack</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ack_buf</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">nexio_touch_packet</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">flags</span><span class="p">;</span>		<span class="cm">/* 0xe1 = touch, 0xe1 = release */</span>
	<span class="n">__be16</span>	<span class="n">data_len</span><span class="p">;</span>	<span class="cm">/* total bytes of touch data */</span>
	<span class="n">__be16</span>	<span class="n">x_len</span><span class="p">;</span>		<span class="cm">/* bytes for X axis */</span>
	<span class="n">__be16</span>	<span class="n">y_len</span><span class="p">;</span>		<span class="cm">/* bytes for Y axis */</span>
	<span class="n">u8</span>	<span class="n">data</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nexio_ack_pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nexio_init_pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0f</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nexio_ack_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nexio_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nexio_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nexio_priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_buf</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ack_buf</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">nexio_ack_pkt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nexio_ack_pkt</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ack_buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_priv</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - usb_alloc_urb failed: usbtouch-&gt;ack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_ack_buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_ack_buf:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ack_buf</span><span class="p">);</span>
<span class="nl">err_priv:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">out_buf:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nexio_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">interface</span> <span class="o">=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nexio_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">actual_len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">firmware_ver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">device_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">input_ep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">output_ep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* find first input and output endpoint */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input_ep</span> <span class="o">&amp;&amp;</span>
		    <span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">))</span>
			<span class="n">input_ep</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">output_ep</span> <span class="o">&amp;&amp;</span>
		    <span class="n">usb_endpoint_dir_out</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">))</span>
			<span class="n">output_ep</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input_ep</span> <span class="o">||</span> <span class="o">!</span><span class="n">output_ep</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">NEXIO_BUFSIZE</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_buf</span><span class="p">;</span>

	<span class="cm">/* two empty reads */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">input_ep</span><span class="p">),</span>
				   <span class="n">buf</span><span class="p">,</span> <span class="n">NEXIO_BUFSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">actual_len</span><span class="p">,</span>
				   <span class="n">NEXIO_TIMEOUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* send init command */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nexio_init_pkt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nexio_init_pkt</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">output_ep</span><span class="p">),</span>
			   <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nexio_init_pkt</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">actual_len</span><span class="p">,</span>
			   <span class="n">NEXIO_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_buf</span><span class="p">;</span>

	<span class="cm">/* read replies */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NEXIO_BUFSIZE</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">input_ep</span><span class="p">),</span>
				   <span class="n">buf</span><span class="p">,</span> <span class="n">NEXIO_BUFSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">actual_len</span><span class="p">,</span>
				   <span class="n">NEXIO_TIMEOUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">actual_len</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">actual_len</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x83</span>:	<span class="cm">/* firmware version */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">firmware_ver</span><span class="p">)</span>
				<span class="n">firmware_ver</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x84</span>:	<span class="cm">/* device name */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device_name</span><span class="p">)</span>
				<span class="n">device_name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Nexio device: %s, firmware version: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">device_name</span><span class="p">,</span> <span class="n">firmware_ver</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">firmware_ver</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">device_name</span><span class="p">);</span>

	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">output_ep</span><span class="p">),</span>
			  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ack_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nexio_ack_pkt</span><span class="p">),</span>
			  <span class="n">nexio_ack_complete</span><span class="p">,</span> <span class="n">usbtouch</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_buf:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nexio_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nexio_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ack_buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nexio_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nexio_touch_packet</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nexio_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x_len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">x_len</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">y_len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">y_len</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">begin_x</span><span class="p">,</span> <span class="n">begin_y</span><span class="p">,</span> <span class="n">end_x</span><span class="p">,</span> <span class="n">end_y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* got touch data? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xe0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">data_len</span> <span class="o">-=</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x_len</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">x_len</span> <span class="o">-=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="cm">/* send ACK */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">max_xc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">max_xc</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x_len</span><span class="p">;</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span>
				     <span class="mi">0</span><span class="p">,</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">max_xc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">max_yc</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y_len</span><span class="p">;</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span>
				     <span class="mi">0</span><span class="p">,</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">max_yc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * The device reports state of IR sensors on X and Y axes.</span>
<span class="cm">	 * Each byte represents &quot;darkness&quot; percentage (0-100) of one element.</span>
<span class="cm">	 * 17&quot; touchscreen reports only 64 x 52 bytes so the resolution is low.</span>
<span class="cm">	 * This also means that there&#39;s a limited multi-touch capability but</span>
<span class="cm">	 * it&#39;s disabled (and untested) here as there&#39;s no X driver for that.</span>
<span class="cm">	 */</span>
	<span class="n">begin_x</span> <span class="o">=</span> <span class="n">end_x</span> <span class="o">=</span> <span class="n">begin_y</span> <span class="o">=</span> <span class="n">end_y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">x_len</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">begin_x</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">NEXIO_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">begin_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end_x</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">begin_x</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">NEXIO_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">end_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="n">x_len</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">begin_y</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">NEXIO_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">begin_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">x_len</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">end_y</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
				    <span class="n">begin_y</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">NEXIO_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">end_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x_len</span><span class="p">;</span>
					<span class="n">w</span> <span class="o">=</span> <span class="n">end_x</span> <span class="o">-</span> <span class="n">begin_x</span><span class="p">;</span>
					<span class="n">h</span> <span class="o">=</span> <span class="n">end_y</span> <span class="o">-</span> <span class="n">begin_y</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">					/* multi-touch */</span>
<span class="c">					input_report_abs(usbtouch-&gt;input,</span>
<span class="c">						    ABS_MT_TOUCH_MAJOR, max(w,h));</span>
<span class="c">					input_report_abs(usbtouch-&gt;input,</span>
<span class="c">						    ABS_MT_TOUCH_MINOR, min(x,h));</span>
<span class="c">					input_report_abs(usbtouch-&gt;input,</span>
<span class="c">						    ABS_MT_POSITION_X, 2*begin_x+w);</span>
<span class="c">					input_report_abs(usbtouch-&gt;input,</span>
<span class="c">						    ABS_MT_POSITION_Y, 2*begin_y+h);</span>
<span class="c">					input_report_abs(usbtouch-&gt;input,</span>
<span class="c">						    ABS_MT_ORIENTATION, w &gt; h);</span>
<span class="c">					input_mt_sync(usbtouch-&gt;input);</span>
<span class="cp">#endif</span>
					<span class="cm">/* single touch */</span>
					<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">begin_x</span> <span class="o">+</span> <span class="n">w</span><span class="p">;</span>
					<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">begin_y</span> <span class="o">+</span> <span class="n">h</span><span class="p">;</span>
					<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
					<span class="n">begin_y</span> <span class="o">=</span> <span class="n">end_y</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">begin_x</span> <span class="o">=</span> <span class="n">end_x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * ELO part</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_ELO</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">elo_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">touch</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">press</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * the different device descriptors</span>
<span class="cm"> */</span>
<span class="cp">#ifdef MULTI_PACKET</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">usbtouch_process_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usbtouch_device_info</span> <span class="n">usbtouch_dev_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_ELO</span>
	<span class="p">[</span><span class="n">DEVTYPE_ELO</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_press</span>	<span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">elo_read_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_EGALAX</span>
	<span class="p">[</span><span class="n">DEVTYPE_EGALAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x07ff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x07ff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">process_pkt</span>	<span class="o">=</span> <span class="n">usbtouch_process_multi</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_pkt_len</span>	<span class="o">=</span> <span class="n">egalax_get_pkt_len</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">egalax_read_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_PANJIT</span>
	<span class="p">[</span><span class="n">DEVTYPE_PANJIT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">panjit_read_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_3M</span>
	<span class="p">[</span><span class="n">DEVTYPE_3M</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">mtouch_read_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">mtouch_init</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_ITM</span>
	<span class="p">[</span><span class="n">DEVTYPE_ITM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_press</span>	<span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">itm_read_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_ETURBO</span>
	<span class="p">[</span><span class="n">DEVTYPE_ETURBO</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x07ff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x07ff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">process_pkt</span>	<span class="o">=</span> <span class="n">usbtouch_process_multi</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_pkt_len</span>	<span class="o">=</span> <span class="n">eturbo_get_pkt_len</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">eturbo_read_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_GUNZE</span>
	<span class="p">[</span><span class="n">DEVTYPE_GUNZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">gunze_read_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_DMC_TSC10</span>
	<span class="p">[</span><span class="n">DEVTYPE_DMC_TSC10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x03ff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x03ff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">dmc_tsc10_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">dmc_tsc10_read_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_IRTOUCH</span>
	<span class="p">[</span><span class="n">DEVTYPE_IRTOUCH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">irtouch_read_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_IDEALTEK</span>
	<span class="p">[</span><span class="n">DEVTYPE_IDEALTEK</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">process_pkt</span>	<span class="o">=</span> <span class="n">usbtouch_process_multi</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_pkt_len</span>	<span class="o">=</span> <span class="n">idealtek_get_pkt_len</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">idealtek_read_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_GENERAL_TOUCH</span>
	<span class="p">[</span><span class="n">DEVTYPE_GENERAL_TOUCH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x7fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x7fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">general_touch_read_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_GOTOP</span>
	<span class="p">[</span><span class="n">DEVTYPE_GOTOP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x03ff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x03ff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">gotop_read_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_JASTEC</span>
	<span class="p">[</span><span class="n">DEVTYPE_JASTEC</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">jastec_read_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_E2I</span>
	<span class="p">[</span><span class="n">DEVTYPE_E2I</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x7fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x7fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">e2i_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">e2i_read_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_ZYTRONIC</span>
	<span class="p">[</span><span class="n">DEVTYPE_ZYTRONIC</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x03ff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x03ff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">zytronic_read_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq_always</span>     <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_ETT_TC45USB</span>
	<span class="p">[</span><span class="n">DEVTYPE_TC45USB</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x0fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">tc45usb_read_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_NEXIO</span>
	<span class="p">[</span><span class="n">DEVTYPE_NEXIO</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq_always</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">nexio_read_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">alloc</span>		<span class="o">=</span> <span class="n">nexio_alloc</span><span class="p">,</span>
		<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">nexio_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">exit</span>		<span class="o">=</span> <span class="n">nexio_exit</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_USB_EASYTOUCH</span>
	<span class="p">[</span><span class="n">DEVTYPE_ETOUCH</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_xc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_xc</span>		<span class="o">=</span> <span class="mh">0x07ff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_yc</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_yc</span>		<span class="o">=</span> <span class="mh">0x07ff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rept_size</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">process_pkt</span>	<span class="o">=</span> <span class="n">usbtouch_process_multi</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_pkt_len</span>	<span class="o">=</span> <span class="n">etouch_get_pkt_len</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">etouch_read_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
<span class="p">};</span>


<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Generic Part</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbtouch_process_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">,</span>
                                 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbtouch_device_info</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">read_data</span><span class="p">(</span><span class="n">usbtouch</span><span class="p">,</span> <span class="n">pkt</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

	<span class="n">input_report_key</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">touch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">swap_xy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">max_press</span><span class="p">)</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">press</span><span class="p">);</span>
	<span class="n">input_sync</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#ifdef MULTI_PACKET</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbtouch_process_multi</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">,</span>
                                   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pkt_len</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* process buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* try to get size */</span>
		<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">get_pkt_len</span><span class="p">(</span>
				<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">);</span>

		<span class="cm">/* drop? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">pkt_len</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_flush_buf</span><span class="p">;</span>

		<span class="cm">/* need to append -pkt_len bytes before able to get size */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">append</span> <span class="o">=</span> <span class="o">-</span><span class="n">pkt_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">append</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">))</span>
			       <span class="n">append</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buf_len</span> <span class="o">+</span> <span class="n">append</span> <span class="o">&gt;=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">rept_size</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_flush_buf</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">append</span><span class="p">);</span>
			<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buf_len</span> <span class="o">+=</span> <span class="n">append</span><span class="p">;</span>

			<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">get_pkt_len</span><span class="p">(</span>
					<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* append */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">pkt_len</span> <span class="o">-</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buf_len</span> <span class="o">+</span> <span class="n">tmp</span> <span class="o">&gt;=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">rept_size</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_flush_buf</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">usbtouch_process_pkt</span><span class="p">(</span><span class="n">usbtouch</span><span class="p">,</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>

		<span class="n">buffer</span> <span class="o">=</span> <span class="n">pkt</span> <span class="o">+</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">buf_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">;</span>
		<span class="n">buf_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* loop over the received packet, process */</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* get packet len */</span>
		<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">get_pkt_len</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span>
							<span class="n">buf_len</span> <span class="o">-</span> <span class="n">pos</span><span class="p">);</span>

		<span class="cm">/* unknown packet: skip one byte */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">pkt_len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* full packet: process */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">((</span><span class="n">pkt_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;=</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">usbtouch_process_pkt</span><span class="p">(</span><span class="n">usbtouch</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* incomplete packet: save in buffer */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">pos</span><span class="p">);</span>
			<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buf_len</span> <span class="o">=</span> <span class="n">buf_len</span> <span class="o">-</span> <span class="n">pos</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_flush_buf:</span>
	<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbtouch_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* success */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ETIME</span>:
		<span class="cm">/* this urb is timing out */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - urb timed out - was the device unplugged?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">EPIPE</span>:
		<span class="cm">/* this urb is terminated, clean up */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - urb shutting down with status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - nonzero urb status received: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">process_pkt</span><span class="p">(</span><span class="n">usbtouch</span><span class="p">,</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="n">usb_mark_last_busy</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">));</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - usb_submit_urb failed with result: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbtouch_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">irq</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">usb_autopm_get_interface</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">irq_always</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">needs_remote_wakeup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">out_put:</span>
	<span class="n">usb_autopm_put_interface</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbtouch_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">irq_always</span><span class="p">)</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">usb_autopm_get_interface</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">needs_remote_wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
		<span class="n">usb_autopm_put_interface</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbtouch_suspend</span>
<span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbtouch_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">||</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">irq_always</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbtouch_reset_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* reinit the device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">usbtouch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - type-&gt;init() failed, err: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* restart IO if needed */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbtouch_free_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">rept_size</span><span class="p">,</span>
			  <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">data_dma</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span>
<span class="nf">usbtouch_get_input_endpoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbtouch_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbtouch_device_info</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* some devices are ignored */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span> <span class="o">==</span> <span class="n">DEVTYPE_IGNORE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">endpoint</span> <span class="o">=</span> <span class="n">usbtouch_get_input_endpoint</span><span class="p">(</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">endpoint</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">usbtouch</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbtouch_usb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbtouch</span> <span class="o">||</span> <span class="o">!</span><span class="n">input_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usbtouch_dev_info</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">];</span>
	<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">process_pkt</span><span class="p">)</span>
		<span class="n">type</span><span class="o">-&gt;</span><span class="n">process_pkt</span> <span class="o">=</span> <span class="n">usbtouch_process_pkt</span><span class="p">;</span>

	<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">rept_size</span><span class="p">,</span>
					    <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">data_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">get_pkt_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">rept_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_buffers</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - usb_alloc_urb failed: usbtouch-&gt;irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_buffers</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">=</span> <span class="n">intf</span><span class="p">;</span>
	<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">)</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">manufacturer</span><span class="p">)</span>
			<span class="n">strlcat</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">strlcat</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
			<span class="s">&quot;USB Touchscreen %04x:%04x&quot;</span><span class="p">,</span>
			 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">),</span>
			 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">));</span>

	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="s">&quot;/input0&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">));</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">usb_to_input_id</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">usbtouch</span><span class="p">);</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">usbtouch_open</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">usbtouch_close</span><span class="p">;</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">);</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">)]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">min_xc</span><span class="p">,</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">max_xc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">min_yc</span><span class="p">,</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">max_yc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">max_press</span><span class="p">)</span>
		<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">min_press</span><span class="p">,</span>
		                     <span class="n">type</span><span class="o">-&gt;</span><span class="n">max_press</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_type</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span> <span class="o">==</span> <span class="n">USB_ENDPOINT_XFER_INT</span><span class="p">)</span>
		<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">udev</span><span class="p">,</span>
			 <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">),</span>
			 <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">rept_size</span><span class="p">,</span>
			 <span class="n">usbtouch_irq</span><span class="p">,</span> <span class="n">usbtouch</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">udev</span><span class="p">,</span>
			 <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">),</span>
			 <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">rept_size</span><span class="p">,</span>
			 <span class="n">usbtouch_irq</span><span class="p">,</span> <span class="n">usbtouch</span><span class="p">);</span>

	<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">irq</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">udev</span><span class="p">;</span>
	<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">irq</span><span class="o">-&gt;</span><span class="n">transfer_dma</span> <span class="o">=</span> <span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">data_dma</span><span class="p">;</span>
	<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">irq</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>

	<span class="cm">/* device specific allocations */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">(</span><span class="n">usbtouch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - type-&gt;alloc() failed, err: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free_urb</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* device specific initialisation*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">type</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">usbtouch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - type-&gt;init() failed, err: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_do_exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - input_register_device failed, err: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_do_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">usbtouch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">irq_always</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* this can&#39;t fail */</span>
		<span class="n">usb_autopm_get_interface</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usb_autopm_put_interface</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s - usb_submit_urb failed with result: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_unregister_input</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_unregister_input:</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="n">input_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out_do_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">)</span>
		<span class="n">type</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="n">usbtouch</span><span class="p">);</span>
<span class="nl">out_free_urb:</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="nl">out_free_buffers:</span>
	<span class="n">usbtouch_free_buffers</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usbtouch</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">usbtouch</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbtouch_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbtouch_usb</span> <span class="o">*</span><span class="n">usbtouch</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbtouch</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s - usbtouch is initialized, cleaning up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* this will stop IO via close */</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">)</span>
		<span class="n">usbtouch</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="n">usbtouch</span><span class="p">);</span>
	<span class="n">usbtouch_free_buffers</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">),</span> <span class="n">usbtouch</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">usbtouch</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">usbtouch_devices</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">usbtouch_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;usbtouchscreen&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">usbtouch_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">usbtouch_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">usbtouch_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">usbtouch_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_resume</span>	<span class="o">=</span> <span class="n">usbtouch_reset_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">usbtouch_devices</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supports_autosuspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">usbtouch_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;touchkitusb&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;itmtouch&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;mtouchusb&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
