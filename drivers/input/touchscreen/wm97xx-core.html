<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › touchscreen › wm97xx-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>wm97xx-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * wm97xx-core.c  --  Touch screen driver core for Wolfson WM9705, WM9712</span>
<span class="cm"> *                    and WM9713 AC97 Codecs.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2003, 2004, 2005, 2006, 2007, 2008 Wolfson Microelectronics PLC.</span>
<span class="cm"> * Author: Liam Girdwood &lt;lrg@slimlogic.co.uk&gt;</span>
<span class="cm"> * Parts Copyright : Ian Molton &lt;spyro@f2s.com&gt;</span>
<span class="cm"> *                   Andrew Zabolotny &lt;zap@homelink.ru&gt;</span>
<span class="cm"> *                   Russell King &lt;rmk@arm.linux.org.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> *  under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> *  Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> *  option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> *</span>
<span class="cm"> *  Features:</span>
<span class="cm"> *       - supports WM9705, WM9712, WM9713</span>
<span class="cm"> *       - polling mode</span>
<span class="cm"> *       - continuous mode (arch-dependent)</span>
<span class="cm"> *       - adjustable rpu/dpp settings</span>
<span class="cm"> *       - adjustable pressure current</span>
<span class="cm"> *       - adjustable sample settle delay</span>
<span class="cm"> *       - 4 and 5 wire touchscreens (5 wire is WM9712 only)</span>
<span class="cm"> *       - pen down detection</span>
<span class="cm"> *       - battery monitor</span>
<span class="cm"> *       - sample AUX adcs</span>
<span class="cm"> *       - power management</span>
<span class="cm"> *       - codec GPIO</span>
<span class="cm"> *       - codec event notification</span>
<span class="cm"> * Todo</span>
<span class="cm"> *       - Support for async sampling control for noisy LCDs.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/wm97xx.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#define TS_NAME			&quot;wm97xx&quot;</span>
<span class="cp">#define WM_CORE_VERSION		&quot;1.00&quot;</span>
<span class="cp">#define DEFAULT_PRESSURE	0xb0c0</span>


<span class="cm">/*</span>
<span class="cm"> * Touchscreen absolute values</span>
<span class="cm"> *</span>
<span class="cm"> * These parameters are used to help the input layer discard out of</span>
<span class="cm"> * range readings and reduce jitter etc.</span>
<span class="cm"> *</span>
<span class="cm"> *   o min, max:- indicate the min and max values your touch screen returns</span>
<span class="cm"> *   o fuzz:- use a higher number to reduce jitter</span>
<span class="cm"> *</span>
<span class="cm"> * The default values correspond to Mainstone II in QVGA mode</span>
<span class="cm"> *</span>
<span class="cm"> * Please read</span>
<span class="cm"> * Documentation/input/input-programming.txt for more details.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">abs_x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">350</span><span class="p">,</span> <span class="mi">3900</span><span class="p">,</span> <span class="mi">5</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">abs_x</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">abs_x</span><span class="p">,</span> <span class="s">&quot;Touchscreen absolute X min, max, fuzz&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">abs_y</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">320</span><span class="p">,</span> <span class="mi">3750</span><span class="p">,</span> <span class="mi">40</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">abs_y</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">abs_y</span><span class="p">,</span> <span class="s">&quot;Touchscreen absolute Y min, max, fuzz&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">abs_p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">4</span><span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">abs_p</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">abs_p</span><span class="p">,</span> <span class="s">&quot;Touchscreen absolute Pressure min, max, fuzz&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * wm97xx IO access, all IO locking done by AC97 layer</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">wm97xx_reg_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wm97xx_reg_read</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">wm97xx_reg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* cache digitiser registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">AC97_WM9713_DIG1</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="n">AC97_WM9713_DIG3</span><span class="p">)</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">dig</span><span class="p">[(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">AC97_WM9713_DIG1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* cache gpio regs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">AC97_GPIO_CFG</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="n">AC97_MISC_AFE</span><span class="p">)</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">AC97_GPIO_CFG</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* wm9713 irq reg */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mh">0x5a</span><span class="p">)</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">)</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wm97xx_reg_write</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * wm97xx_read_aux_adc - Read the aux adc.</span>
<span class="cm"> * @wm: wm97xx device.</span>
<span class="cm"> * @adcsel: codec ADC to be read</span>
<span class="cm"> *</span>
<span class="cm"> * Reads the selected AUX ADC.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">wm97xx_read_aux_adc</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">,</span> <span class="n">u16</span> <span class="n">adcsel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">power_adc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">auxval</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">power</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* get codec */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>

	<span class="cm">/* When the touchscreen is not in use, we may have to power up</span>
<span class="cm">	 * the AUX ADC before we can use sample the AUX inputs-&gt;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">WM9713_ID2</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">power</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">power_adc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">,</span> <span class="n">power</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Prepare the codec for AUX reading */</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">aux_prepare</span><span class="p">(</span><span class="n">wm</span><span class="p">);</span>

	<span class="cm">/* Turn polling mode on to read AUX ADC */</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_probably_down</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">RC_VALID</span> <span class="o">&amp;&amp;</span> <span class="n">timeout</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">poll_sample</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">adcsel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">auxval</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">power_adc</span><span class="p">)</span>
		<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">,</span> <span class="n">power</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span>

	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dig_restore</span><span class="p">(</span><span class="n">wm</span><span class="p">);</span>

	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_probably_down</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;timeout reading auxadc %d, disabling digitiser</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adcsel</span><span class="p">);</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dig_enable</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">RC_VALID</span> <span class="o">?</span> <span class="n">auxval</span> <span class="o">&amp;</span> <span class="mh">0xfff</span> <span class="o">:</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wm97xx_read_aux_adc</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * wm97xx_get_gpio - Get the status of a codec GPIO.</span>
<span class="cm"> * @wm: wm97xx device.</span>
<span class="cm"> * @gpio: gpio</span>
<span class="cm"> *</span>
<span class="cm"> * Get the status of a codec GPIO pin</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="n">wm97xx_gpio_status</span> <span class="nf">wm97xx_get_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">wm97xx_gpio_status</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">gpio</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">WM97XX_GPIO_HIGH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">WM97XX_GPIO_LOW</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wm97xx_get_gpio</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * wm97xx_set_gpio - Set the status of a codec GPIO.</span>
<span class="cm"> * @wm: wm97xx device.</span>
<span class="cm"> * @gpio: gpio</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Set the status of a codec GPIO pin</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">wm97xx_set_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gpio</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">wm97xx_gpio_status</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">WM97XX_GPIO_HIGH</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">gpio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">WM9712_ID2</span> <span class="o">&amp;&amp;</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">!=</span> <span class="n">WM97xx_WM1613</span><span class="p">)</span>
		<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_STATUS</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_STATUS</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wm97xx_set_gpio</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Codec GPIO pin configuration, this sets pin direction, polarity,</span>
<span class="cm"> * stickyness and wake up.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">wm97xx_config_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gpio</span><span class="p">,</span> <span class="k">enum</span> <span class="n">wm97xx_gpio_dir</span> <span class="n">dir</span><span class="p">,</span>
		   <span class="k">enum</span> <span class="n">wm97xx_gpio_pol</span> <span class="n">pol</span><span class="p">,</span> <span class="k">enum</span> <span class="n">wm97xx_gpio_sticky</span> <span class="n">sticky</span><span class="p">,</span>
		   <span class="k">enum</span> <span class="n">wm97xx_gpio_wake</span> <span class="n">wake</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_POLARITY</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pol</span> <span class="o">==</span> <span class="n">WM97XX_GPIO_POL_HIGH</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">gpio</span><span class="p">;</span>

	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_POLARITY</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_STICKY</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sticky</span> <span class="o">==</span> <span class="n">WM97XX_GPIO_STICKY</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">gpio</span><span class="p">;</span>

	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_STICKY</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_WAKEUP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wake</span> <span class="o">==</span> <span class="n">WM97XX_GPIO_WAKE</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">gpio</span><span class="p">;</span>

	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_WAKEUP</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_CFG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">WM97XX_GPIO_IN</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">gpio</span><span class="p">;</span>

	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wm97xx_config_gpio</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Configure the WM97XX_PRP value to use while system is suspended.</span>
<span class="cm"> * If a value other than 0 is set then WM97xx pen detection will be</span>
<span class="cm"> * left enabled in the configured mode while the system is in suspend,</span>
<span class="cm"> * the device has users and suspend has not been disabled via the</span>
<span class="cm"> * wakeup sysfs entries.</span>
<span class="cm"> *</span>
<span class="cm"> * @wm:   WM97xx device to configure</span>
<span class="cm"> * @mode: WM97XX_PRP value to configure while suspended</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">wm97xx_set_suspend_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">suspend_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">device_init_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wm97xx_set_suspend_mode</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Handle a pen down interrupt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wm97xx_pen_irq_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wm97xx</span><span class="p">,</span> <span class="n">pen_event_work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pen_was_down</span> <span class="o">=</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_is_down</span><span class="p">;</span>

	<span class="cm">/* do we need to enable the touch panel reader */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">WM9705_ID2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER_RD</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">WM97XX_PEN_DOWN</span><span class="p">)</span>
			<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_is_down</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_is_down</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">status</span><span class="p">,</span> <span class="n">pol</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_STATUS</span><span class="p">);</span>
		<span class="n">pol</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_POLARITY</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">WM97XX_GPIO_13</span> <span class="o">&amp;</span> <span class="n">pol</span> <span class="o">&amp;</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_is_down</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_POLARITY</span><span class="p">,</span> <span class="n">pol</span> <span class="o">&amp;</span>
						<span class="o">~</span><span class="n">WM97XX_GPIO_13</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_is_down</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_POLARITY</span><span class="p">,</span> <span class="n">pol</span> <span class="o">|</span>
					 <span class="n">WM97XX_GPIO_13</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">WM9712_ID2</span> <span class="o">&amp;&amp;</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">!=</span> <span class="n">WM97xx_WM1613</span><span class="p">)</span>
			<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_STATUS</span><span class="p">,</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span>
						<span class="o">~</span><span class="n">WM97XX_GPIO_13</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_STATUS</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span>
						<span class="o">~</span><span class="n">WM97XX_GPIO_13</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If the system is not using continuous mode or it provides a</span>
<span class="cm">	 * pen down operation then we need to schedule polls while the</span>
<span class="cm">	 * pen is down.  Otherwise the machine driver is responsible</span>
<span class="cm">	 * for scheduling reads.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">acc_enabled</span> <span class="o">||</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">acc_pen_down</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_is_down</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pen_was_down</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Data is not available immediately on pen down */</span>
			<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_workq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Let ts_reader report the pen up for debounce. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_is_down</span> <span class="o">&amp;&amp;</span> <span class="n">pen_was_down</span><span class="p">)</span>
			<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_is_down</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_is_down</span> <span class="o">&amp;&amp;</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">acc_enabled</span><span class="p">)</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">acc_pen_up</span><span class="p">(</span><span class="n">wm</span><span class="p">);</span>

	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Codec PENDOWN irq handler</span>
<span class="cm"> *</span>
<span class="cm"> * We have to disable the codec interrupt in the handler because it</span>
<span class="cm"> * can take up to 1ms to clear the interrupt source. We schedule a task</span>
<span class="cm"> * in a work queue to do the actual interaction with the chip.  The</span>
<span class="cm"> * interrupt is then enabled again in the slow handler when the source</span>
<span class="cm"> * has been cleared.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">wm97xx_pen_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_event_work</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_workq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_event_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initialise pen IRQ handler and workqueue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm97xx_init_pen_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* If an interrupt is supplied an IRQ enable operation must also be</span>
<span class="cm">	 * provided. */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_irq</span><span class="p">,</span> <span class="n">wm97xx_pen_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="s">&quot;wm97xx-pen&quot;</span><span class="p">,</span> <span class="n">wm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to register pen down interrupt, polling&quot;</span><span class="p">);</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Configure GPIO as interrupt source on WM971x */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">WM9705_ID2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">irq_gpio</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_MISC_AFE</span><span class="p">);</span>
		<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_MISC_AFE</span><span class="p">,</span>
				<span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">irq_gpio</span><span class="p">));</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">);</span>
		<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0001</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm97xx_read_samples</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm97xx_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span> <span class="o">&amp;&amp;</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">acc_enabled</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">acc_pen_down</span><span class="p">(</span><span class="n">wm</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">poll_touch</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;</span> <span class="n">RC_PENUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_is_down</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_is_down</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pen up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rc</span> <span class="o">&amp;</span> <span class="n">RC_AGAIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* We need high frequency updates only while</span>
<span class="cm">			* pen is down, the user never will be able to</span>
<span class="cm">			* touch screen faster than a few times per</span>
<span class="cm">			* second... On the other hand, when the user</span>
<span class="cm">			* is actively working with the touchscreen we</span>
<span class="cm">			* don&#39;t want to lose the quick response. So we</span>
<span class="cm">			* will slowly increase sleep time after the</span>
<span class="cm">			* pen is up and quicky restore it to ~one task</span>
<span class="cm">			* switch when pen is down again.</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader_interval</span> <span class="o">&lt;</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
				<span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader_interval</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;</span> <span class="n">RC_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;pen down: x=%x:%d, y=%x:%d, pressure=%x:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">data</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span>
			<span class="n">data</span><span class="p">.</span><span class="n">y</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">p</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">y</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_is_down</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader_interval</span> <span class="o">=</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader_min_interval</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;</span> <span class="n">RC_PENDOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pen down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_is_down</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader_interval</span> <span class="o">=</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader_min_interval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* The touchscreen sample reader.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wm97xx_ts_reader</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wm97xx</span><span class="p">,</span> <span class="n">ts_reader</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">wm97xx_read_samples</span><span class="p">(</span><span class="n">wm</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;</span> <span class="n">RC_AGAIN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_is_down</span> <span class="o">||</span> <span class="o">!</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_irq</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_workq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader</span><span class="p">,</span>
				   <span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader_interval</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wm97xx_ts_input_open - Open the touch screen input device.</span>
<span class="cm"> * @idev:	Input device to be opened.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the input sub system to open a wm97xx touchscreen device.</span>
<span class="cm"> * Starts the touchscreen thread and touch digitiser.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm97xx_ts_input_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>

	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_workq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;kwm97xx&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_workq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to create workqueue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* start digitiser */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span> <span class="o">&amp;&amp;</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">acc_enabled</span><span class="p">)</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">acc_enable</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dig_enable</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader</span><span class="p">,</span> <span class="n">wm97xx_ts_reader</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_event_work</span><span class="p">,</span> <span class="n">wm97xx_pen_irq_worker</span><span class="p">);</span>

	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader_min_interval</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">&gt;=</span> <span class="mi">100</span> <span class="o">?</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader_min_interval</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader_min_interval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader_interval</span> <span class="o">=</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader_min_interval</span><span class="p">;</span>

	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_is_down</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_irq</span><span class="p">)</span>
		<span class="n">wm97xx_init_pen_irq</span><span class="p">(</span><span class="n">wm</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No IRQ specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* If we either don&#39;t have an interrupt for pen down events or</span>
<span class="cm">	 * failed to acquire it then we need to poll.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_workq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader</span><span class="p">,</span>
				   <span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader_interval</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wm97xx_ts_input_close - Close the touch screen input device.</span>
<span class="cm"> * @idev:	Input device to be closed.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the input sub system to close a wm97xx touchscreen</span>
<span class="cm"> * device.  Kills the touchscreen thread and stops the touch</span>
<span class="cm"> * digitiser.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wm97xx_ts_input_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Return the interrupt to GPIO usage (disabling it) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">WM9705_ID2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">irq_gpio</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_MISC_AFE</span><span class="p">);</span>
			<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_MISC_AFE</span><span class="p">,</span>
					 <span class="n">reg</span> <span class="o">|</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">irq_gpio</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">free_irq</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_irq</span><span class="p">,</span> <span class="n">wm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_is_down</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Balance out interrupt disables/enables */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_event_work</span><span class="p">))</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* ts_reader rearms itself so we need to explicitly stop it</span>
<span class="cm">	 * before we destroy the workqueue.</span>
<span class="cm">	 */</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader</span><span class="p">);</span>

	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_workq</span><span class="p">);</span>

	<span class="cm">/* stop digitiser */</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">dig_enable</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span> <span class="o">&amp;&amp;</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="o">-&gt;</span><span class="n">acc_enabled</span><span class="p">)</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">acc_enable</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm97xx_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wm97xx_pdata</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wm</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>

	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wm</span><span class="p">);</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">ac97</span> <span class="o">=</span> <span class="n">to_ac97_t</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* check that we have a supported codec */</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="n">WM97XX_ID1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device with vendor %04x is not a wm97xx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">alloc_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID2</span><span class="p">);</span>

	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">=</span> <span class="n">WM97xx_GENERIC</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;detected a wm97%02x codec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_WM9705</span>
	<span class="k">case</span> <span class="mh">0x05</span>:
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wm9705_codec</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_WM9712</span>
	<span class="k">case</span> <span class="mh">0x12</span>:
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wm9712_codec</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_TOUCHSCREEN_WM9713</span>
	<span class="k">case</span> <span class="mh">0x13</span>:
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wm9713_codec</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Support for wm97%02x not compiled in.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">wm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">alloc_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set up physical characteristics */</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">phy_init</span><span class="p">(</span><span class="n">wm</span><span class="p">);</span>

	<span class="cm">/* load gpio cache */</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_CFG</span><span class="p">);</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_POLARITY</span><span class="p">);</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_STICKY</span><span class="p">);</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_WAKEUP</span><span class="p">);</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_STATUS</span><span class="p">);</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_MISC_AFE</span><span class="p">);</span>

	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">alloc_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set up touch configuration */</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;wm97xx touchscreen&quot;</span><span class="p">;</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="s">&quot;wm97xx&quot;</span><span class="p">;</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">wm97xx_ts_input_open</span><span class="p">;</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">wm97xx_ts_input_close</span><span class="p">;</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">abs_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">abs_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			     <span class="n">abs_x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">abs_y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">abs_y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			     <span class="n">abs_y</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="n">abs_p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">abs_p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			     <span class="n">abs_p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">wm</span><span class="p">);</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">dev_alloc_err</span><span class="p">;</span>

	<span class="cm">/* register our battery device */</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">battery_dev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;wm97xx-battery&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">battery_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">batt_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">battery_dev</span><span class="p">,</span> <span class="n">wm</span><span class="p">);</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">battery_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">battery_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">battery_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">batt_reg_err</span><span class="p">;</span>

	<span class="cm">/* register our extended touch device (for machine specific</span>
<span class="cm">	 * extensions) */</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">touch_dev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;wm97xx-touch&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">touch_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">touch_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">touch_dev</span><span class="p">,</span> <span class="n">wm</span><span class="p">);</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">touch_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">touch_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">touch_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">touch_reg_err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

 <span class="nl">touch_reg_err:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">touch_dev</span><span class="p">);</span>
 <span class="nl">touch_err:</span>
	<span class="n">platform_device_del</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">battery_dev</span><span class="p">);</span>
 <span class="nl">batt_reg_err:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">battery_dev</span><span class="p">);</span>
 <span class="nl">batt_err:</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="nl">dev_alloc_err:</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
 <span class="nl">alloc_err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wm</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm97xx_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">battery_dev</span><span class="p">);</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">touch_dev</span><span class="p">);</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm97xx_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">suspend_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_may_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">suspend_mode</span> <span class="o">=</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">suspend_mode</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">suspend_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader</span><span class="p">);</span>

	<span class="cm">/* Power down the digitiser (bypassing the cache for resume) */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER2</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WM97XX_PRP_DET_DIG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">suspend_mode</span><span class="p">;</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_WM97XX_DIGITISER2</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* WM9713 has an additional power bit - turn it off if there</span>
<span class="cm">	 * are no users or if suspend mode is zero. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">WM9713_ID2</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">||</span> <span class="o">!</span><span class="n">suspend_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wm97xx_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* restore digitiser and gpios */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">WM9713_ID2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM9713_DIG1</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">dig</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">misc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">wm97xx_reg_read</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>
			<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_EXTENDED_MID</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM9713_DIG2</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">dig</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_WM9713_DIG3</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">dig</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_CFG</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_POLARITY</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_STICKY</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_WAKEUP</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_GPIO_STATUS</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">wm97xx_reg_write</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">AC97_MISC_AFE</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">pen_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader_interval</span> <span class="o">=</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader_min_interval</span><span class="p">;</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_workq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader</span><span class="p">,</span>
				   <span class="n">wm</span><span class="o">-&gt;</span><span class="n">ts_reader_interval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define wm97xx_suspend		NULL</span>
<span class="cp">#define wm97xx_resume		NULL</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Machine specific operations</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">wm97xx_register_mach_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">wm97xx_mach_ops</span> <span class="o">*</span><span class="n">mach_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span> <span class="o">=</span> <span class="n">mach_ops</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wm97xx_register_mach_ops</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">wm97xx_unregister_mach_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">wm97xx</span> <span class="o">*</span><span class="n">wm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>
	<span class="n">wm</span><span class="o">-&gt;</span><span class="n">mach_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">codec_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wm97xx_unregister_mach_ops</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_driver</span> <span class="n">wm97xx_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;wm97xx-ts&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus</span> <span class="o">=</span>		<span class="o">&amp;</span><span class="n">ac97_bus_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">wm97xx_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>	<span class="n">wm97xx_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span>	<span class="n">wm97xx_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span>	<span class="n">wm97xx_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">wm97xx_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm97xx_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">wm97xx_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wm97xx_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">wm97xx_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">wm97xx_exit</span><span class="p">);</span>

<span class="cm">/* Module information */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Liam Girdwood &lt;lrg@slimlogic.co.uk&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;WM97xx Core - Touch Screen / AUX ADC / GPIO Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
