<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › keyboard › pmic8xxx-keypad.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pmic8xxx-keypad.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Copyright (c) 2009-2011, Code Aurora Forum. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 and</span>
<span class="cm"> * only version 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &lt;linux/mfd/pm8xxx/core.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/pm8xxx/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/input/pmic8xxx-keypad.h&gt;</span>

<span class="cp">#define PM8XXX_MAX_ROWS		18</span>
<span class="cp">#define PM8XXX_MAX_COLS		8</span>
<span class="cp">#define PM8XXX_ROW_SHIFT	3</span>
<span class="cp">#define PM8XXX_MATRIX_MAX_SIZE	(PM8XXX_MAX_ROWS * PM8XXX_MAX_COLS)</span>

<span class="cp">#define PM8XXX_MIN_ROWS		5</span>
<span class="cp">#define PM8XXX_MIN_COLS		5</span>

<span class="cp">#define MAX_SCAN_DELAY		128</span>
<span class="cp">#define MIN_SCAN_DELAY		1</span>

<span class="cm">/* in nanoseconds */</span>
<span class="cp">#define MAX_ROW_HOLD_DELAY	122000</span>
<span class="cp">#define MIN_ROW_HOLD_DELAY	30500</span>

<span class="cp">#define MAX_DEBOUNCE_TIME	20</span>
<span class="cp">#define MIN_DEBOUNCE_TIME	5</span>

<span class="cp">#define KEYP_CTRL			0x148</span>

<span class="cp">#define KEYP_CTRL_EVNTS			BIT(0)</span>
<span class="cp">#define KEYP_CTRL_EVNTS_MASK		0x3</span>

<span class="cp">#define KEYP_CTRL_SCAN_COLS_SHIFT	5</span>
<span class="cp">#define KEYP_CTRL_SCAN_COLS_MIN		5</span>
<span class="cp">#define KEYP_CTRL_SCAN_COLS_BITS	0x3</span>

<span class="cp">#define KEYP_CTRL_SCAN_ROWS_SHIFT	2</span>
<span class="cp">#define KEYP_CTRL_SCAN_ROWS_MIN		5</span>
<span class="cp">#define KEYP_CTRL_SCAN_ROWS_BITS	0x7</span>

<span class="cp">#define KEYP_CTRL_KEYP_EN		BIT(7)</span>

<span class="cp">#define KEYP_SCAN			0x149</span>

<span class="cp">#define KEYP_SCAN_READ_STATE		BIT(0)</span>
<span class="cp">#define KEYP_SCAN_DBOUNCE_SHIFT		1</span>
<span class="cp">#define KEYP_SCAN_PAUSE_SHIFT		3</span>
<span class="cp">#define KEYP_SCAN_ROW_HOLD_SHIFT	6</span>

<span class="cp">#define KEYP_TEST			0x14A</span>

<span class="cp">#define KEYP_TEST_CLEAR_RECENT_SCAN	BIT(6)</span>
<span class="cp">#define KEYP_TEST_CLEAR_OLD_SCAN	BIT(5)</span>
<span class="cp">#define KEYP_TEST_READ_RESET		BIT(4)</span>
<span class="cp">#define KEYP_TEST_DTEST_EN		BIT(3)</span>
<span class="cp">#define KEYP_TEST_ABORT_READ		BIT(0)</span>

<span class="cp">#define KEYP_TEST_DBG_SELECT_SHIFT	1</span>

<span class="cm">/* bits of these registers represent</span>
<span class="cm"> * &#39;0&#39; for key press</span>
<span class="cm"> * &#39;1&#39; for key release</span>
<span class="cm"> */</span>
<span class="cp">#define KEYP_RECENT_DATA		0x14B</span>
<span class="cp">#define KEYP_OLD_DATA			0x14C</span>

<span class="cp">#define KEYP_CLOCK_FREQ			32768</span>

<span class="cm">/**</span>
<span class="cm"> * struct pmic8xxx_kp - internal keypad data structure</span>
<span class="cm"> * @pdata - keypad platform data pointer</span>
<span class="cm"> * @input - input device pointer for keypad</span>
<span class="cm"> * @key_sense_irq - key press/release irq number</span>
<span class="cm"> * @key_stuck_irq - key stuck notification irq number</span>
<span class="cm"> * @keycodes - array to hold the key codes</span>
<span class="cm"> * @dev - parent device pointer</span>
<span class="cm"> * @keystate - present key press/release state</span>
<span class="cm"> * @stuckstate - present state when key stuck irq</span>
<span class="cm"> * @ctrl_reg - control register value</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pm8xxx_keypad_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">key_sense_irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">key_stuck_irq</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">keycodes</span><span class="p">[</span><span class="n">PM8XXX_MATRIX_MAX_SIZE</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">keystate</span><span class="p">[</span><span class="n">PM8XXX_MAX_ROWS</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">stuckstate</span><span class="p">[</span><span class="n">PM8XXX_MAX_ROWS</span><span class="p">];</span>

	<span class="n">u8</span> <span class="n">ctrl_reg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmic8xxx_kp_write_u8</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pm8xxx_writeb</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmic8xxx_kp_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">num_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pm8xxx_read_buf</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">num_bytes</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmic8xxx_kp_read_u8</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_read</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">pmic8xxx_col_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">col</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* all keys pressed on that particular row? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_cols</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">col</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_cols</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Synchronous read protocol for RevB0 onwards:</span>
<span class="cm"> *</span>
<span class="cm"> * 1. Write &#39;1&#39; to ReadState bit in KEYP_SCAN register</span>
<span class="cm"> * 2. Wait 2*32KHz clocks, so that HW can successfully enter read mode</span>
<span class="cm"> *    synchronously</span>
<span class="cm"> * 3. Read rows in old array first if events are more than one</span>
<span class="cm"> * 4. Read rows in recent array</span>
<span class="cm"> * 5. Wait 4*32KHz clocks</span>
<span class="cm"> * 6. Write &#39;0&#39; to ReadState bit of KEYP_SCAN register so that hw can</span>
<span class="cm"> *    synchronously exit read mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmic8xxx_chk_sync_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scan_val</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_read_u8</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_val</span><span class="p">,</span> <span class="n">KEYP_SCAN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error reading KEYP_SCAN reg, rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scan_val</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_write_u8</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">scan_val</span><span class="p">,</span> <span class="n">KEYP_SCAN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error writing KEYP_SCAN reg, rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 2 * 32KHz clocks */</span>
	<span class="n">udelay</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">USEC_PER_SEC</span><span class="p">,</span> <span class="n">KEYP_CLOCK_FREQ</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmic8xxx_kp_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">data_reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">read_rows</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">row</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">new_data</span><span class="p">[</span><span class="n">PM8XXX_MAX_ROWS</span><span class="p">];</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_read</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">new_data</span><span class="p">,</span> <span class="n">data_reg</span><span class="p">,</span> <span class="n">read_rows</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_rows</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;new_data[%d] = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>
					<span class="n">new_data</span><span class="p">[</span><span class="n">row</span><span class="p">]);</span>
		<span class="n">state</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmic8xxx_col_state</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">new_data</span><span class="p">[</span><span class="n">row</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmic8xxx_kp_read_matrix</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">new_state</span><span class="p">,</span>
					 <span class="n">u16</span> <span class="o">*</span><span class="n">old_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">read_rows</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scan_val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_rows</span> <span class="o">&lt;</span> <span class="n">PM8XXX_MIN_ROWS</span><span class="p">)</span>
		<span class="n">read_rows</span> <span class="o">=</span> <span class="n">PM8XXX_MIN_ROWS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">read_rows</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_rows</span><span class="p">;</span>

	<span class="n">pmic8xxx_chk_sync_read</span><span class="p">(</span><span class="n">kp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_read_data</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">KEYP_OLD_DATA</span><span class="p">,</span>
						<span class="n">read_rows</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Error reading KEYP_OLD_DATA, rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_read_data</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">KEYP_RECENT_DATA</span><span class="p">,</span>
					 <span class="n">read_rows</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Error reading KEYP_RECENT_DATA, rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 4 * 32KHz clocks */</span>
	<span class="n">udelay</span><span class="p">((</span><span class="mi">4</span> <span class="o">*</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">USEC_PER_SEC</span><span class="p">,</span> <span class="n">KEYP_CLOCK_FREQ</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_read_u8</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_val</span><span class="p">,</span> <span class="n">KEYP_SCAN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error reading KEYP_SCAN reg, rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scan_val</span> <span class="o">&amp;=</span> <span class="mh">0xFE</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_write_u8</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">scan_val</span><span class="p">,</span> <span class="n">KEYP_SCAN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error writing KEYP_SCAN reg, rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__pmic8xxx_kp_scan_matrix</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">new_state</span><span class="p">,</span>
					 <span class="n">u16</span> <span class="o">*</span><span class="n">old_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">code</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_rows</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bits_changed</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">^</span> <span class="n">old_state</span><span class="p">[</span><span class="n">row</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bits_changed</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_cols</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bits_changed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">col</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;key [%d:%d] %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span>
					<span class="o">!</span><span class="p">(</span><span class="n">new_state</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">col</span><span class="p">))</span> <span class="o">?</span>
					<span class="s">&quot;pressed&quot;</span> <span class="o">:</span> <span class="s">&quot;released&quot;</span><span class="p">);</span>

			<span class="n">code</span> <span class="o">=</span> <span class="n">MATRIX_SCAN_CODE</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">PM8XXX_ROW_SHIFT</span><span class="p">);</span>

			<span class="n">input_event</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">EV_MSC</span><span class="p">,</span> <span class="n">MSC_SCAN</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span>
					<span class="n">kp</span><span class="o">-&gt;</span><span class="n">keycodes</span><span class="p">[</span><span class="n">code</span><span class="p">],</span>
					<span class="o">!</span><span class="p">(</span><span class="n">new_state</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">col</span><span class="p">)));</span>

			<span class="n">input_sync</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">pmic8xxx_detect_ghost_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">found_first</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">check</span><span class="p">,</span> <span class="n">row_state</span><span class="p">;</span>

	<span class="n">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_rows</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">row_state</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">new_state</span><span class="p">[</span><span class="n">row</span><span class="p">])</span> <span class="o">&amp;</span>
				 <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_cols</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hweight16</span><span class="p">(</span><span class="n">row_state</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">found_first</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">found_first</span> <span class="o">=</span> <span class="n">row</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check</span> <span class="o">&amp;</span> <span class="n">row_state</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;detected ghost key on row[%d]&quot;</span>
					 <span class="s">&quot; and row[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">found_first</span><span class="p">,</span> <span class="n">row</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">check</span> <span class="o">|=</span> <span class="n">row_state</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmic8xxx_kp_scan_matrix</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">events</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">new_state</span><span class="p">[</span><span class="n">PM8XXX_MAX_ROWS</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">old_state</span><span class="p">[</span><span class="n">PM8XXX_MAX_ROWS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x1</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_read_matrix</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="cm">/* detecting ghost key is not an error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmic8xxx_detect_ghost_keys</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">new_state</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">__pmic8xxx_kp_scan_matrix</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">keystate</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">keystate</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_state</span><span class="p">));</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3</span>: <span class="cm">/* two events - eventcounter is gray-coded */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_read_matrix</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">old_state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">__pmic8xxx_kp_scan_matrix</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">keystate</span><span class="p">);</span>
		<span class="n">__pmic8xxx_kp_scan_matrix</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">old_state</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">keystate</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_state</span><span class="p">));</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Some key events were lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_read_matrix</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">old_state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">__pmic8xxx_kp_scan_matrix</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">keystate</span><span class="p">);</span>
		<span class="n">__pmic8xxx_kp_scan_matrix</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">old_state</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">keystate</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_state</span><span class="p">));</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NOTE: We are reading recent and old data registers blindly</span>
<span class="cm"> * whenever key-stuck interrupt happens, because events counter doesn&#39;t</span>
<span class="cm"> * get updated when this interrupt happens due to key stuck doesn&#39;t get</span>
<span class="cm"> * considered as key state change.</span>
<span class="cm"> *</span>
<span class="cm"> * We are not using old data register contents after they are being read</span>
<span class="cm"> * because it might report the key which was pressed before the key being stuck</span>
<span class="cm"> * as stuck key because it&#39;s pressed status is stored in the old data</span>
<span class="cm"> * register.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">pmic8xxx_kp_stuck_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">new_state</span><span class="p">[</span><span class="n">PM8XXX_MAX_ROWS</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">old_state</span><span class="p">[</span><span class="n">PM8XXX_MAX_ROWS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_read_matrix</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">old_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to read keypad matrix</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__pmic8xxx_kp_scan_matrix</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">stuckstate</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">pmic8xxx_kp_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl_val</span><span class="p">,</span> <span class="n">events</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_read</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl_val</span><span class="p">,</span> <span class="n">KEYP_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to read keyp_ctrl register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">events</span> <span class="o">=</span> <span class="n">ctrl_val</span> <span class="o">&amp;</span> <span class="n">KEYP_CTRL_EVNTS_MASK</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_scan_matrix</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">events</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to scan matrix</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pmic8xxx_kpd_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bits</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">cycles</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scan_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ctrl_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">row_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="cm">/* Find column bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_cols</span> <span class="o">&lt;</span> <span class="n">KEYP_CTRL_SCAN_COLS_MIN</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_cols</span> <span class="o">-</span> <span class="n">KEYP_CTRL_SCAN_COLS_MIN</span><span class="p">;</span>
	<span class="n">ctrl_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">KEYP_CTRL_SCAN_COLS_BITS</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">KEYP_CTRL_SCAN_COLS_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Find row bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_rows</span> <span class="o">&lt;</span> <span class="n">KEYP_CTRL_SCAN_ROWS_MIN</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="n">row_bits</span><span class="p">[</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_rows</span> <span class="o">-</span> <span class="n">KEYP_CTRL_SCAN_ROWS_MIN</span><span class="p">];</span>

	<span class="n">ctrl_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&lt;&lt;</span> <span class="n">KEYP_CTRL_SCAN_ROWS_SHIFT</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_write_u8</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">ctrl_val</span><span class="p">,</span> <span class="n">KEYP_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error writing KEYP_CTRL reg, rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">debounce_ms</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">scan_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&lt;&lt;</span> <span class="n">KEYP_SCAN_DBOUNCE_SHIFT</span><span class="p">);</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">scan_delay_ms</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">scan_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&lt;&lt;</span> <span class="n">KEYP_SCAN_PAUSE_SHIFT</span><span class="p">);</span>

	<span class="cm">/* Row hold time is a multiple of 32KHz cycles. */</span>
	<span class="n">cycles</span> <span class="o">=</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">row_hold_ns</span> <span class="o">*</span> <span class="n">KEYP_CLOCK_FREQ</span><span class="p">)</span> <span class="o">/</span> <span class="n">NSEC_PER_SEC</span><span class="p">;</span>

	<span class="n">scan_val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cycles</span> <span class="o">&lt;&lt;</span> <span class="n">KEYP_SCAN_ROW_HOLD_SHIFT</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_write_u8</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">scan_val</span><span class="p">,</span> <span class="n">KEYP_SCAN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error writing KEYP_SCAN reg, rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">__devinit</span> <span class="nf">pmic8xxx_kp_config_gpio</span><span class="p">(</span><span class="kt">int</span> <span class="n">gpio_start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_gpios</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pm_gpio</span> <span class="o">*</span><span class="n">gpio_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_start</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">num_gpios</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_gpios</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pm8xxx_gpio_config</span><span class="p">(</span><span class="n">gpio_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">gpio_config</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: FAIL pm8xxx_gpio_config():&quot;</span>
					<span class="s">&quot;for PM GPIO [%d] rc=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">gpio_start</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	 <span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmic8xxx_kp_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">ctrl_reg</span> <span class="o">|=</span> <span class="n">KEYP_CTRL_KEYP_EN</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_write_u8</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">ctrl_reg</span><span class="p">,</span> <span class="n">KEYP_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error writing KEYP_CTRL reg, rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmic8xxx_kp_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">ctrl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">KEYP_CTRL_KEYP_EN</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_write_u8</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">ctrl_reg</span><span class="p">,</span> <span class="n">KEYP_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmic8xxx_kp_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pmic8xxx_kp_enable</span><span class="p">(</span><span class="n">kp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmic8xxx_kp_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pmic8xxx_kp_disable</span><span class="p">(</span><span class="n">kp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * keypad controller should be initialized in the following sequence</span>
<span class="cm"> * only, otherwise it might get into FSM stuck state.</span>
<span class="cm"> *</span>
<span class="cm"> * - Initialize keypad control parameters, like no. of rows, columns,</span>
<span class="cm"> *   timing values etc.,</span>
<span class="cm"> * - configure rows and column gpios pull up/down.</span>
<span class="cm"> * - set irq edge type.</span>
<span class="cm"> * - enable the keypad controller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pmic8xxx_kp_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pm8xxx_keypad_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span>
					<span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">matrix_keymap_data</span> <span class="o">*</span><span class="n">keymap_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl_val</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pm_gpio</span> <span class="n">kypd_drv</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">direction</span>	<span class="o">=</span> <span class="n">PM_GPIO_DIR_OUT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">output_buffer</span>	<span class="o">=</span> <span class="n">PM_GPIO_OUT_BUF_OPEN_DRAIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">output_value</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pull</span>		<span class="o">=</span> <span class="n">PM_GPIO_PULL_NO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vin_sel</span>	<span class="o">=</span> <span class="n">PM_GPIO_VIN_S3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">out_strength</span>	<span class="o">=</span> <span class="n">PM_GPIO_STRENGTH_LOW</span><span class="p">,</span>
		<span class="p">.</span><span class="n">function</span>	<span class="o">=</span> <span class="n">PM_GPIO_FUNC_1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">inv_int_pol</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">pm_gpio</span> <span class="n">kypd_sns</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">direction</span>	<span class="o">=</span> <span class="n">PM_GPIO_DIR_IN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pull</span>		<span class="o">=</span> <span class="n">PM_GPIO_PULL_UP_31P5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vin_sel</span>	<span class="o">=</span> <span class="n">PM_GPIO_VIN_S3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">out_strength</span>	<span class="o">=</span> <span class="n">PM_GPIO_STRENGTH_NO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">function</span>	<span class="o">=</span> <span class="n">PM_GPIO_FUNC_NORMAL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">inv_int_pol</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">};</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span> <span class="o">||</span> <span class="o">!</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_cols</span> <span class="o">||</span> <span class="o">!</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_rows</span> <span class="o">||</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_cols</span> <span class="o">&gt;</span> <span class="n">PM8XXX_MAX_COLS</span> <span class="o">||</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_rows</span> <span class="o">&gt;</span> <span class="n">PM8XXX_MAX_ROWS</span> <span class="o">||</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_cols</span> <span class="o">&lt;</span> <span class="n">PM8XXX_MIN_COLS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">scan_delay_ms</span> <span class="o">||</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">scan_delay_ms</span> <span class="o">&gt;</span> <span class="n">MAX_SCAN_DELAY</span> <span class="o">||</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">scan_delay_ms</span> <span class="o">&lt;</span> <span class="n">MIN_SCAN_DELAY</span> <span class="o">||</span>
		<span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">scan_delay_ms</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid keypad scan time supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">row_hold_ns</span> <span class="o">||</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">row_hold_ns</span> <span class="o">&gt;</span> <span class="n">MAX_ROW_HOLD_DELAY</span> <span class="o">||</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">row_hold_ns</span> <span class="o">&lt;</span> <span class="n">MIN_ROW_HOLD_DELAY</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">row_hold_ns</span> <span class="o">%</span> <span class="n">MIN_ROW_HOLD_DELAY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid keypad row hold time supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">debounce_ms</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">debounce_ms</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">debounce_ms</span> <span class="o">&gt;</span> <span class="n">MAX_DEBOUNCE_TIME</span> <span class="o">||</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">debounce_ms</span> <span class="o">&lt;</span> <span class="n">MIN_DEBOUNCE_TIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid debounce time supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">keymap_data</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">keymap_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">keymap_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no keymap data supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">kp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">kp</span><span class="p">);</span>

	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">pdata</span>	<span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to allocate input device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_alloc_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">key_sense_irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">key_sense_irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to get keypad sense irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_get_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">key_stuck_irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">key_stuck_irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to get keypad stuck irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_get_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">input_name</span> <span class="o">?</span> <span class="o">:</span> <span class="s">&quot;PMIC8XXX keypad&quot;</span><span class="p">;</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">input_phys_device</span> <span class="o">?</span> <span class="o">:</span> <span class="s">&quot;pmic8xxx_keypad/input0&quot;</span><span class="p">;</span>

	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span>	<span class="o">=</span> <span class="n">BUS_I2C</span><span class="p">;</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span>	<span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span>	<span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>

	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">open</span>		<span class="o">=</span> <span class="n">pmic8xxx_kp_open</span><span class="p">;</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">close</span>	<span class="o">=</span> <span class="n">pmic8xxx_kp_close</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">matrix_keypad_build_keymap</span><span class="p">(</span><span class="n">keymap_data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					<span class="n">PM8XXX_MAX_ROWS</span><span class="p">,</span> <span class="n">PM8XXX_MAX_COLS</span><span class="p">,</span>
					<span class="n">kp</span><span class="o">-&gt;</span><span class="n">keycodes</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to build keymap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_get_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">)</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_REP</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">input_set_capability</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">EV_MSC</span><span class="p">,</span> <span class="n">MSC_SCAN</span><span class="p">);</span>

	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">kp</span><span class="p">);</span>

	<span class="cm">/* initialize keypad state */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">keystate</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">keystate</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">stuckstate</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">stuckstate</span><span class="p">));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kpd_init</span><span class="p">(</span><span class="n">kp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to initialize keypad controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_get_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_config_gpio</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">cols_gpio_start</span><span class="p">,</span>
					<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_cols</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kypd_sns</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to configure keypad sense lines</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_gpio_config</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_config_gpio</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">rows_gpio_start</span><span class="p">,</span>
					<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kypd_drv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to configure keypad drive lines</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_gpio_config</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_any_context_irq</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">key_sense_irq</span><span class="p">,</span> <span class="n">pmic8xxx_kp_irq</span><span class="p">,</span>
				 <span class="n">IRQF_TRIGGER_RISING</span><span class="p">,</span> <span class="s">&quot;pmic-keypad&quot;</span><span class="p">,</span> <span class="n">kp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request keypad sense irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_get_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_any_context_irq</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">key_stuck_irq</span><span class="p">,</span> <span class="n">pmic8xxx_kp_stuck_irq</span><span class="p">,</span>
				 <span class="n">IRQF_TRIGGER_RISING</span><span class="p">,</span> <span class="s">&quot;pmic-keypad-stuck&quot;</span><span class="p">,</span> <span class="n">kp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request keypad stuck irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_req_stuck_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmic8xxx_kp_read_u8</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl_val</span><span class="p">,</span> <span class="n">KEYP_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to read KEYP_CTRL register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_pmic_reg_read</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">ctrl_reg</span> <span class="o">=</span> <span class="n">ctrl_val</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to register keypad input device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_pmic_reg_read</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device_init_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">wakeup</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_pmic_reg_read:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">key_stuck_irq</span><span class="p">,</span> <span class="n">kp</span><span class="p">);</span>
<span class="nl">err_req_stuck_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">key_sense_irq</span><span class="p">,</span> <span class="n">kp</span><span class="p">);</span>
<span class="nl">err_gpio_config:</span>
<span class="nl">err_get_irq:</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
<span class="nl">err_alloc_device:</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">kp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">pmic8xxx_kp_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">device_init_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">key_stuck_irq</span><span class="p">,</span> <span class="n">kp</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">key_sense_irq</span><span class="p">,</span> <span class="n">kp</span><span class="p">);</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">kp</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM_SLEEP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmic8xxx_kp_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_may_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">enable_irq_wake</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">key_sense_irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span>
			<span class="n">pmic8xxx_kp_disable</span><span class="p">(</span><span class="n">kp</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmic8xxx_kp_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmic8xxx_kp</span> <span class="o">*</span><span class="n">kp</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_may_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">disable_irq_wake</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">key_sense_irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span>
			<span class="n">pmic8xxx_kp_enable</span><span class="p">(</span><span class="n">kp</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">SIMPLE_DEV_PM_OPS</span><span class="p">(</span><span class="n">pm8xxx_kp_pm_ops</span><span class="p">,</span>
			 <span class="n">pmic8xxx_kp_suspend</span><span class="p">,</span> <span class="n">pmic8xxx_kp_resume</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">pmic8xxx_kp_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">pmic8xxx_kp_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">pmic8xxx_kp_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">PM8XXX_KEYPAD_DEV_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm8xxx_kp_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">pmic8xxx_kp_driver</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;PMIC8XXX keypad driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;1.0&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:pmic8xxx_keypad&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Trilok Soni &lt;tsoni@codeaurora.org&gt;&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
