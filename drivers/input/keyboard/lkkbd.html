<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › keyboard › lkkbd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>lkkbd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 2004 by Jan-Benedict Glaw &lt;jbglaw@lug-owl.de&gt;</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * LK keyboard driver for Linux, based on sunkbd.c (C) by Vojtech Pavlik</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * DEC LK201 and LK401 keyboard driver for Linux (primary for DECstations</span>
<span class="cm"> * and VAXstations, but can also be used on any standard RS232 with an</span>
<span class="cm"> * adaptor).</span>
<span class="cm"> *</span>
<span class="cm"> * DISCLAIMER: This works for _me_. If you break anything by using the</span>
<span class="cm"> * information given below, I will _not_ be liable!</span>
<span class="cm"> *</span>
<span class="cm"> * RJ10 pinout:		To DE9:		Or DB25:</span>
<span class="cm"> *	1 - RxD &lt;----&gt;	Pin 3 (TxD) &lt;-&gt;	Pin 2 (TxD)</span>
<span class="cm"> *	2 - GND &lt;----&gt;	Pin 5 (GND) &lt;-&gt;	Pin 7 (GND)</span>
<span class="cm"> *	4 - TxD &lt;----&gt;	Pin 2 (RxD) &lt;-&gt;	Pin 3 (RxD)</span>
<span class="cm"> *	3 - +12V (from HDD drive connector), DON&#39;T connect to DE9 or DB25!!!</span>
<span class="cm"> *</span>
<span class="cm"> * Pin numbers for DE9 and DB25 are noted on the plug (quite small:). For</span>
<span class="cm"> * RJ10, it&#39;s like this:</span>
<span class="cm"> *</span>
<span class="cm"> *      __=__	Hold the plug in front of you, cable downwards,</span>
<span class="cm"> *     /___/|	nose is hidden behind the plug. Now, pin 1 is at</span>
<span class="cm"> *    |1234||	the left side, pin 4 at the right and 2 and 3 are</span>
<span class="cm"> *    |IIII||	in between, of course:)</span>
<span class="cm"> *    |    ||</span>
<span class="cm"> *    |____|/</span>
<span class="cm"> *      ||	So the adaptor consists of three connected cables</span>
<span class="cm"> *      ||	for data transmission (RxD and TxD) and signal ground.</span>
<span class="cm"> *		Additionally, you have to get +12V from somewhere.</span>
<span class="cm"> * Most easily, you&#39;ll get that from a floppy or HDD power connector.</span>
<span class="cm"> * It&#39;s the yellow cable there (black is ground and red is +5V).</span>
<span class="cm"> *</span>
<span class="cm"> * The keyboard and all the commands it understands are documented in</span>
<span class="cm"> * &quot;VCB02 Video Subsystem - Technical Manual&quot;, EK-104AA-TM-001. This</span>
<span class="cm"> * document is LK201 specific, but LK401 is mostly compatible. It comes</span>
<span class="cm"> * up in LK201 mode and doesn&#39;t report any of the additional keys it</span>
<span class="cm"> * has. These need to be switched on with the LK_CMD_ENABLE_LK401</span>
<span class="cm"> * command. You&#39;ll find this document (scanned .pdf file) on MANX,</span>
<span class="cm"> * a search engine specific to DEC documentation. Try</span>
<span class="cm"> * http://www.vt100.net/manx/details?pn=EK-104AA-TM-001;id=21;cp=1</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/serio.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="cp">#define DRIVER_DESC	&quot;LK keyboard driver&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jan-Benedict Glaw &lt;jbglaw@lug-owl.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Known parameters:</span>
<span class="cm"> *	bell_volume</span>
<span class="cm"> *	keyclick_volume</span>
<span class="cm"> *	ctrlclick_volume</span>
<span class="cm"> *</span>
<span class="cm"> * Please notice that there&#39;s not yet an API to set these at runtime.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bell_volume</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="cm">/* % */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">bell_volume</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bell_volume</span><span class="p">,</span> <span class="s">&quot;Bell volume (in %). default is 100%&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">keyclick_volume</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="cm">/* % */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">keyclick_volume</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">keyclick_volume</span><span class="p">,</span> <span class="s">&quot;Keyclick volume (in %), default is 100%&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ctrlclick_volume</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="cm">/* % */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ctrlclick_volume</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ctrlclick_volume</span><span class="p">,</span> <span class="s">&quot;Ctrlclick volume (in %), default is 100%&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">lk201_compose_is_alt</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">lk201_compose_is_alt</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">lk201_compose_is_alt</span><span class="p">,</span>
		 <span class="s">&quot;If set non-zero, LK201&#39; Compose key will act as an Alt key&quot;</span><span class="p">);</span>



<span class="cp">#undef LKKBD_DEBUG</span>
<span class="cp">#ifdef LKKBD_DEBUG</span>
<span class="cp">#define DBG(x...) printk(x)</span>
<span class="cp">#else</span>
<span class="cp">#define DBG(x...) do {} while (0)</span>
<span class="cp">#endif</span>

<span class="cm">/* LED control */</span>
<span class="cp">#define LK_LED_WAIT		0x81</span>
<span class="cp">#define LK_LED_COMPOSE		0x82</span>
<span class="cp">#define LK_LED_SHIFTLOCK	0x84</span>
<span class="cp">#define LK_LED_SCROLLLOCK	0x88</span>
<span class="cp">#define LK_CMD_LED_ON		0x13</span>
<span class="cp">#define LK_CMD_LED_OFF		0x11</span>

<span class="cm">/* Mode control */</span>
<span class="cp">#define LK_MODE_DOWN		0x80</span>
<span class="cp">#define LK_MODE_AUTODOWN	0x82</span>
<span class="cp">#define LK_MODE_UPDOWN		0x86</span>
<span class="cp">#define LK_CMD_SET_MODE(mode, div)	((mode) | ((div) &lt;&lt; 3))</span>

<span class="cm">/* Misc commands */</span>
<span class="cp">#define LK_CMD_ENABLE_KEYCLICK	0x1b</span>
<span class="cp">#define LK_CMD_DISABLE_KEYCLICK	0x99</span>
<span class="cp">#define LK_CMD_DISABLE_BELL	0xa1</span>
<span class="cp">#define LK_CMD_SOUND_BELL	0xa7</span>
<span class="cp">#define LK_CMD_ENABLE_BELL	0x23</span>
<span class="cp">#define LK_CMD_DISABLE_CTRCLICK	0xb9</span>
<span class="cp">#define LK_CMD_ENABLE_CTRCLICK	0xbb</span>
<span class="cp">#define LK_CMD_SET_DEFAULTS	0xd3</span>
<span class="cp">#define LK_CMD_POWERCYCLE_RESET	0xfd</span>
<span class="cp">#define LK_CMD_ENABLE_LK401	0xe9</span>
<span class="cp">#define LK_CMD_REQUEST_ID	0xab</span>

<span class="cm">/* Misc responses from keyboard */</span>
<span class="cp">#define LK_STUCK_KEY		0x3d</span>
<span class="cp">#define LK_SELFTEST_FAILED	0x3e</span>
<span class="cp">#define LK_ALL_KEYS_UP		0xb3</span>
<span class="cp">#define LK_METRONOME		0xb4</span>
<span class="cp">#define LK_OUTPUT_ERROR		0xb5</span>
<span class="cp">#define LK_INPUT_ERROR		0xb6</span>
<span class="cp">#define LK_KBD_LOCKED		0xb7</span>
<span class="cp">#define LK_KBD_TEST_MODE_ACK	0xb8</span>
<span class="cp">#define LK_PREFIX_KEY_DOWN	0xb9</span>
<span class="cp">#define LK_MODE_CHANGE_ACK	0xba</span>
<span class="cp">#define LK_RESPONSE_RESERVED	0xbb</span>

<span class="cp">#define LK_NUM_KEYCODES		256</span>
<span class="cp">#define LK_NUM_IGNORE_BYTES	6</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">lkkbd_keycode</span><span class="p">[</span><span class="n">LK_NUM_KEYCODES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mh">0x56</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F1</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x57</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F2</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x58</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F3</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x59</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F4</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x5a</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F5</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x64</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F6</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x65</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F7</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x66</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F8</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x67</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F9</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x68</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F10</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x71</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F11</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x72</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F12</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x73</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F13</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x74</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F14</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x7c</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F15</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x7d</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F16</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x80</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F17</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x81</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F18</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x82</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F19</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x83</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F20</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x8a</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_FIND</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x8b</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_INSERT</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x8c</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_DELETE</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x8d</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_SELECT</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x8e</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_PAGEUP</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x8f</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_PAGEDOWN</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x92</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_KP0</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x94</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_KPDOT</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x95</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_KPENTER</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x96</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_KP1</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x97</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_KP2</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x98</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_KP3</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x99</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_KP4</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x9a</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_KP5</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x9b</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_KP6</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x9c</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_KPCOMMA</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x9d</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_KP7</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x9e</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_KP8</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x9f</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_KP9</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa0</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_KPMINUS</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa1</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_PROG1</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa2</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_PROG2</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa3</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_PROG3</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa4</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_PROG4</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa7</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_LEFT</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa8</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_RIGHT</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xa9</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_DOWN</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xaa</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_UP</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xab</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_RIGHTSHIFT</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xac</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_LEFTALT</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xad</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_COMPOSE</span><span class="p">,</span> <span class="cm">/* Right Compose, that is. */</span>
	<span class="p">[</span><span class="mh">0xae</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_LEFTSHIFT</span><span class="p">,</span> <span class="cm">/* Same as KEY_RIGHTSHIFT on LK201 */</span>
	<span class="p">[</span><span class="mh">0xaf</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_LEFTCTRL</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xb0</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_CAPSLOCK</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xb1</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_COMPOSE</span><span class="p">,</span> <span class="cm">/* Left Compose, that is. */</span>
	<span class="p">[</span><span class="mh">0xb2</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_RIGHTALT</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xbc</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_BACKSPACE</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xbd</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_ENTER</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xbe</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_TAB</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xbf</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_ESC</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xc0</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_1</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xc1</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_Q</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xc2</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_A</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xc3</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_Z</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xc5</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_2</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xc6</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_W</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xc7</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_S</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xc8</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_X</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xc9</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_102ND</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xcb</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_3</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xcc</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_E</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xcd</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_D</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xce</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_C</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xd0</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_4</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xd1</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_R</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xd2</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_F</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xd3</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_V</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xd4</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_SPACE</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xd6</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_5</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xd7</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_T</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xd8</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_G</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xd9</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_B</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xdb</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_6</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xdc</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_Y</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xdd</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_H</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xde</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_N</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xe0</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_7</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xe1</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_U</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xe2</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_J</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xe3</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_M</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xe5</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_8</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xe6</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_I</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xe7</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_K</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xe8</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_COMMA</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xea</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_9</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xeb</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_O</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xec</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_L</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xed</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_DOT</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xef</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_0</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xf0</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_P</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xf2</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_SEMICOLON</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xf3</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_SLASH</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xf5</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_EQUAL</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xf6</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_RIGHTBRACE</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xf7</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_BACKSLASH</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xf9</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_MINUS</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xfa</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_LEFTBRACE</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0xfb</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_APOSTROPHE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define CHECK_LED(LK, VAR_ON, VAR_OFF, LED, BITS) do {		\</span>
<span class="cp">	if (test_bit(LED, (LK)-&gt;dev-&gt;led))			\</span>
<span class="cp">		VAR_ON |= BITS;					\</span>
<span class="cp">	else							\</span>
<span class="cp">		VAR_OFF |= BITS;				\</span>
<span class="cp">	} while (0)</span>

<span class="cm">/*</span>
<span class="cm"> * Per-keyboard data</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">lkkbd</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">keycode</span><span class="p">[</span><span class="n">LK_NUM_KEYCODES</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ignore_bytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">[</span><span class="n">LK_NUM_IGNORE_BYTES</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">tq</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bell_volume</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">keyclick_volume</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ctrlclick_volume</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#ifdef LKKBD_DEBUG</span>
<span class="cm">/*</span>
<span class="cm"> * Responses from the keyboard and mapping back to their names.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span> <span class="n">lk_response</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#define RESPONSE(x) { .value = (x), .name = #x, }</span>
	<span class="n">RESPONSE</span><span class="p">(</span><span class="n">LK_STUCK_KEY</span><span class="p">),</span>
	<span class="n">RESPONSE</span><span class="p">(</span><span class="n">LK_SELFTEST_FAILED</span><span class="p">),</span>
	<span class="n">RESPONSE</span><span class="p">(</span><span class="n">LK_ALL_KEYS_UP</span><span class="p">),</span>
	<span class="n">RESPONSE</span><span class="p">(</span><span class="n">LK_METRONOME</span><span class="p">),</span>
	<span class="n">RESPONSE</span><span class="p">(</span><span class="n">LK_OUTPUT_ERROR</span><span class="p">),</span>
	<span class="n">RESPONSE</span><span class="p">(</span><span class="n">LK_INPUT_ERROR</span><span class="p">),</span>
	<span class="n">RESPONSE</span><span class="p">(</span><span class="n">LK_KBD_LOCKED</span><span class="p">),</span>
	<span class="n">RESPONSE</span><span class="p">(</span><span class="n">LK_KBD_TEST_MODE_ACK</span><span class="p">),</span>
	<span class="n">RESPONSE</span><span class="p">(</span><span class="n">LK_PREFIX_KEY_DOWN</span><span class="p">),</span>
	<span class="n">RESPONSE</span><span class="p">(</span><span class="n">LK_MODE_CHANGE_ACK</span><span class="p">),</span>
	<span class="n">RESPONSE</span><span class="p">(</span><span class="n">LK_RESPONSE_RESERVED</span><span class="p">),</span>
<span class="cp">#undef RESPONSE</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">response_name</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lk_response</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lk_response</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">lk_response</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>

	<span class="k">return</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* LKKBD_DEBUG */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Calculate volume parameter byte for a given volume.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">volume_to_hw</span><span class="p">(</span><span class="kt">int</span> <span class="n">volume_percent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">volume_percent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">volume_percent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">volume_percent</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">volume_percent</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">volume_percent</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">volume_percent</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">)</span>	<span class="cm">/* 12.5 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">volume_percent</span> <span class="o">&gt;=</span> <span class="mi">25</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">volume_percent</span> <span class="o">&gt;=</span> <span class="mi">38</span><span class="p">)</span>	<span class="cm">/* 37.5 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">volume_percent</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">volume_percent</span> <span class="o">&gt;=</span> <span class="mi">63</span><span class="p">)</span>	<span class="cm">/* 62.5 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/* This is the default volume */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">volume_percent</span> <span class="o">&gt;=</span> <span class="mi">75</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">volume_percent</span> <span class="o">&gt;=</span> <span class="mi">88</span><span class="p">)</span>	<span class="cm">/* 87.5 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lkkbd_detection_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">lkkbd</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset setting for Compose key. Let Compose be KEY_COMPOSE.</span>
<span class="cm">	 */</span>
	<span class="n">lk</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="mh">0xb1</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_COMPOSE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Print keyboard name and modify Compose=Alt on user&#39;s request.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;DEC LK201 keyboard&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lk201_compose_is_alt</span><span class="p">)</span>
			<span class="n">lk</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="mh">0xb1</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_LEFTALT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;DEC LK401 keyboard&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Unknown DEC keyboard&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;lkkbd: keyboard on %s is unknown, please report to &quot;</span>
			<span class="s">&quot;Jan-Benedict Glaw &lt;jbglaw@lug-owl.de&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;lkkbd: keyboard ID&#39;ed as:&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LK_NUM_IGNORE_BYTES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; 0x%02x&quot;</span><span class="p">,</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;lkkbd: keyboard on %s identified as: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">lk</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Report errors during keyboard boot-up.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>:
		<span class="cm">/* All okay */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LK_STUCK_KEY</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;lkkbd: Stuck key on keyboard at %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">lk</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LK_SELFTEST_FAILED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;lkkbd: Selftest failed on keyboard at %s, &quot;</span>
			<span class="s">&quot;keyboard may not work properly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;lkkbd: Unknown error %02x on keyboard at %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">lk</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to hint user if there&#39;s a stuck key.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">LK_STUCK_KEY</span> <span class="o">&amp;&amp;</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;Scancode of stuck key is 0x%02x, keycode is 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">lk</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">3</span><span class="p">]]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * lkkbd_interrupt() is called by the low level driver when a character</span>
<span class="cm"> * is received.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">lkkbd_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lkkbd</span> <span class="o">*</span><span class="n">lk</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span> <span class="o">=</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keycode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Got byte 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">ignore_bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Ignoring a byte on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">lk</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">LK_NUM_IGNORE_BYTES</span> <span class="o">-</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">ignore_bytes</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">ignore_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">lkkbd_detection_done</span><span class="p">(</span><span class="n">lk</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LK_ALL_KEYS_UP</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lkkbd_keycode</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x01</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Got 0x01, scheduling re-initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lk</span><span class="o">-&gt;</span><span class="n">ignore_bytes</span> <span class="o">=</span> <span class="n">LK_NUM_IGNORE_BYTES</span><span class="p">;</span>
		<span class="n">lk</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">LK_NUM_IGNORE_BYTES</span> <span class="o">-</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">ignore_bytes</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">tq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">LK_METRONOME</span>:
	<span class="k">case</span> <span class="n">LK_OUTPUT_ERROR</span>:
	<span class="k">case</span> <span class="n">LK_INPUT_ERROR</span>:
	<span class="k">case</span> <span class="n">LK_KBD_LOCKED</span>:
	<span class="k">case</span> <span class="n">LK_KBD_TEST_MODE_ACK</span>:
	<span class="k">case</span> <span class="n">LK_PREFIX_KEY_DOWN</span>:
	<span class="k">case</span> <span class="n">LK_MODE_CHANGE_ACK</span>:
	<span class="k">case</span> <span class="n">LK_RESPONSE_RESERVED</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Got %s and don&#39;t know how to handle...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">response_name</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">keycode</span> <span class="o">=</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">data</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">!=</span> <span class="n">KEY_RESERVED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">keycode</span><span class="p">,</span>
					 <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">keycode</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">));</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				<span class="s">&quot;%s: Unknown key with scancode 0x%02x on %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lkkbd_toggle_leds</span><span class="p">(</span><span class="k">struct</span> <span class="n">lkkbd</span> <span class="o">*</span><span class="n">lk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span> <span class="o">=</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">leds_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">leds_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">CHECK_LED</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span> <span class="n">leds_on</span><span class="p">,</span> <span class="n">leds_off</span><span class="p">,</span> <span class="n">LED_CAPSL</span><span class="p">,</span> <span class="n">LK_LED_SHIFTLOCK</span><span class="p">);</span>
	<span class="n">CHECK_LED</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span> <span class="n">leds_on</span><span class="p">,</span> <span class="n">leds_off</span><span class="p">,</span> <span class="n">LED_COMPOSE</span><span class="p">,</span> <span class="n">LK_LED_COMPOSE</span><span class="p">);</span>
	<span class="n">CHECK_LED</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span> <span class="n">leds_on</span><span class="p">,</span> <span class="n">leds_off</span><span class="p">,</span> <span class="n">LED_SCROLLL</span><span class="p">,</span> <span class="n">LK_LED_SCROLLLOCK</span><span class="p">);</span>
	<span class="n">CHECK_LED</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span> <span class="n">leds_on</span><span class="p">,</span> <span class="n">leds_off</span><span class="p">,</span> <span class="n">LED_SLEEP</span><span class="p">,</span> <span class="n">LK_LED_WAIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">leds_on</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">serio_write</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">LK_CMD_LED_ON</span><span class="p">);</span>
		<span class="n">serio_write</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">leds_on</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">leds_off</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">serio_write</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">LK_CMD_LED_OFF</span><span class="p">);</span>
		<span class="n">serio_write</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">leds_off</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lkkbd_toggle_keyclick</span><span class="p">(</span><span class="k">struct</span> <span class="n">lkkbd</span> <span class="o">*</span><span class="n">lk</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span> <span class="o">=</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: Activating key clicks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">serio_write</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">LK_CMD_ENABLE_KEYCLICK</span><span class="p">);</span>
		<span class="n">serio_write</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">volume_to_hw</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">keyclick_volume</span><span class="p">));</span>
		<span class="n">serio_write</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">LK_CMD_ENABLE_CTRCLICK</span><span class="p">);</span>
		<span class="n">serio_write</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">volume_to_hw</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">ctrlclick_volume</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: Deactivating key clicks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">serio_write</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">LK_CMD_DISABLE_KEYCLICK</span><span class="p">);</span>
		<span class="n">serio_write</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">LK_CMD_DISABLE_CTRCLICK</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * lkkbd_event() handles events from the input module.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lkkbd_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lkkbd</span> <span class="o">*</span><span class="n">lk</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EV_LED</span>:
		<span class="n">lkkbd_toggle_leds</span><span class="p">(</span><span class="n">lk</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EV_SND</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SND_CLICK</span>:
			<span class="n">lkkbd_toggle_keyclick</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SND_BELL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">serio_write</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">,</span> <span class="n">LK_CMD_SOUND_BELL</span><span class="p">);</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s(): Got unknown type %d, code %d, value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * lkkbd_reinit() sets leds and beeps to a state the computer remembers they</span>
<span class="cm"> * were in.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lkkbd_reinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lkkbd</span> <span class="o">*</span><span class="n">lk</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lkkbd</span><span class="p">,</span> <span class="n">tq</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">division</span><span class="p">;</span>

	<span class="cm">/* Ask for ID */</span>
	<span class="n">serio_write</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">,</span> <span class="n">LK_CMD_REQUEST_ID</span><span class="p">);</span>

	<span class="cm">/* Reset parameters */</span>
	<span class="n">serio_write</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">,</span> <span class="n">LK_CMD_SET_DEFAULTS</span><span class="p">);</span>

	<span class="cm">/* Set LEDs */</span>
	<span class="n">lkkbd_toggle_leds</span><span class="p">(</span><span class="n">lk</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to activate extended LK401 mode. This command will</span>
<span class="cm">	 * only work with a LK401 keyboard and grants access to</span>
<span class="cm">	 * LAlt, RAlt, RCompose and RShift.</span>
<span class="cm">	 */</span>
	<span class="n">serio_write</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">,</span> <span class="n">LK_CMD_ENABLE_LK401</span><span class="p">);</span>

	<span class="cm">/* Set all keys to UPDOWN mode */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">division</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">division</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">;</span> <span class="n">division</span><span class="o">++</span><span class="p">)</span>
		<span class="n">serio_write</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">,</span>
			    <span class="n">LK_CMD_SET_MODE</span><span class="p">(</span><span class="n">LK_MODE_UPDOWN</span><span class="p">,</span> <span class="n">division</span><span class="p">));</span>

	<span class="cm">/* Enable bell and set volume */</span>
	<span class="n">serio_write</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">,</span> <span class="n">LK_CMD_ENABLE_BELL</span><span class="p">);</span>
	<span class="n">serio_write</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">,</span> <span class="n">volume_to_hw</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">bell_volume</span><span class="p">));</span>

	<span class="cm">/* Enable/disable keyclick (and possibly set volume) */</span>
	<span class="n">lkkbd_toggle_keyclick</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">SND_CLICK</span><span class="p">,</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">snd</span><span class="p">));</span>

	<span class="cm">/* Sound the bell if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">SND_BELL</span><span class="p">,</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">snd</span><span class="p">))</span>
		<span class="n">serio_write</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">,</span> <span class="n">LK_CMD_SOUND_BELL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * lkkbd_connect() probes for a LK keyboard and fills the necessary structures.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lkkbd_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serio_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lkkbd</span> <span class="o">*</span><span class="n">lk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">lk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lkkbd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lk</span> <span class="o">||</span> <span class="o">!</span><span class="n">input_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lk</span><span class="o">-&gt;</span><span class="n">serio</span> <span class="o">=</span> <span class="n">serio</span><span class="p">;</span>
	<span class="n">lk</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">input_dev</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">tq</span><span class="p">,</span> <span class="n">lkkbd_reinit</span><span class="p">);</span>
	<span class="n">lk</span><span class="o">-&gt;</span><span class="n">bell_volume</span> <span class="o">=</span> <span class="n">bell_volume</span><span class="p">;</span>
	<span class="n">lk</span><span class="o">-&gt;</span><span class="n">keyclick_volume</span> <span class="o">=</span> <span class="n">keyclick_volume</span><span class="p">;</span>
	<span class="n">lk</span><span class="o">-&gt;</span><span class="n">ctrlclick_volume</span> <span class="o">=</span> <span class="n">ctrlclick_volume</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">,</span> <span class="n">lkkbd_keycode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">));</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;DEC LK keyboard&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">),</span> <span class="s">&quot;%s/input0&quot;</span><span class="p">,</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_RS232</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">SERIO_LKKBD</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">lkkbd_event</span><span class="p">;</span>

	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">lk</span><span class="p">);</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_LED</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_SND</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_REP</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">LED_CAPSL</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">ledbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">LED_SLEEP</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">ledbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">LED_COMPOSE</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">ledbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">LED_SCROLLL</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">ledbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">SND_BELL</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">sndbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">SND_CLICK</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">sndbit</span><span class="p">);</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keycode</span> <span class="o">=</span> <span class="n">lk</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keycodesize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keycodemax</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LK_NUM_KEYCODES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">KEY_RESERVED</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="n">serio_set_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">lk</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">serio_open</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">drv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>

	<span class="n">serio_write</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">,</span> <span class="n">LK_CMD_POWERCYCLE_RESET</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail3:</span>	<span class="n">serio_close</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>
 <span class="nl">fail2:</span>	<span class="n">serio_set_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
 <span class="nl">fail1:</span>	<span class="n">input_free_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * lkkbd_disconnect() unregisters and closes behind us.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lkkbd_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lkkbd</span> <span class="o">*</span><span class="n">lk</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>

	<span class="n">input_get_device</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">serio_close</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>
	<span class="n">serio_set_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">input_put_device</span><span class="p">(</span><span class="n">lk</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">serio_device_id</span> <span class="n">lkkbd_serio_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">SERIO_RS232</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proto</span>	<span class="o">=</span> <span class="n">SERIO_LKKBD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra</span>	<span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">lkkbd_serio_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">serio_driver</span> <span class="n">lkkbd_drv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;lkkbd&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">description</span>	<span class="o">=</span> <span class="n">DRIVER_DESC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">lkkbd_serio_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span>	<span class="o">=</span> <span class="n">lkkbd_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">lkkbd_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">interrupt</span>	<span class="o">=</span> <span class="n">lkkbd_interrupt</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_serio_driver</span><span class="p">(</span><span class="n">lkkbd_drv</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
