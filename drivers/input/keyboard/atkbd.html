<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › keyboard › atkbd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>atkbd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * AT and PS/2 keyboard driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 1999-2002 Vojtech Pavlik</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This driver can handle standard AT keyboards and PS/2 keyboards in</span>
<span class="cm"> * Translated and Raw Set 2 and Set 3, as well as AT keyboards on dumb</span>
<span class="cm"> * input-only controllers and AT keyboards connected over a one way RS232</span>
<span class="cm"> * converter.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/serio.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/libps2.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>

<span class="cp">#define DRIVER_DESC	&quot;AT and PS/2 keyboard driver&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Vojtech Pavlik &lt;vojtech@suse.cz&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atkbd_set</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">atkbd_set</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="s">&quot;Select keyboard code set (2 = default, 3 = PS/2 native)&quot;</span><span class="p">);</span>

<span class="cp">#if defined(__i386__) || defined(__x86_64__) || defined(__hppa__)</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">atkbd_reset</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">atkbd_reset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span> <span class="n">atkbd_reset</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span> <span class="s">&quot;Reset keyboard during initialization&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">atkbd_softrepeat</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">softrepeat</span><span class="p">,</span> <span class="n">atkbd_softrepeat</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">softrepeat</span><span class="p">,</span> <span class="s">&quot;Use software keyboard repeat&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">atkbd_softraw</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">softraw</span><span class="p">,</span> <span class="n">atkbd_softraw</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">softraw</span><span class="p">,</span> <span class="s">&quot;Use software generated rawmode&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">atkbd_scroll</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">scroll</span><span class="p">,</span> <span class="n">atkbd_scroll</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">scroll</span><span class="p">,</span> <span class="s">&quot;Enable scroll-wheel on MS Office and similar keyboards&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">atkbd_extra</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">atkbd_extra</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="s">&quot;Enable extra LEDs and keys on IBM RapidAcces, EzKey and similar keyboards&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">atkbd_terminal</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">terminal</span><span class="p">,</span> <span class="n">atkbd_terminal</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">terminal</span><span class="p">,</span> <span class="s">&quot;Enable break codes on an IBM Terminal keyboard connected via AT/PS2&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Scancode to keycode tables. These are just the default setting, and</span>
<span class="cm"> * are loadable via a userland utility.</span>
<span class="cm"> */</span>

<span class="cp">#define ATKBD_KEYMAP_SIZE	512</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">atkbd_set2_keycode</span><span class="p">[</span><span class="n">ATKBD_KEYMAP_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>

<span class="cp">#ifdef CONFIG_KEYBOARD_ATKBD_HP_KEYCODES</span>

<span class="cm">/* XXX: need a more general approach */</span>

<span class="cp">#include &quot;hpps2atkbd.h&quot;	</span><span class="cm">/* include the keyboard scancodes */</span><span class="cp"></span>

<span class="cp">#else</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span><span class="mi">117</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span><span class="mi">183</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span><span class="mi">184</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span><span class="mi">124</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
	 <span class="mi">82</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span>

	  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
	<span class="mi">217</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span><span class="mi">165</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">156</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">125</span><span class="p">,</span>
	<span class="mi">173</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">113</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">126</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">140</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span>
	<span class="mi">159</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">164</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mi">158</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">172</span><span class="p">,</span><span class="mi">166</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">142</span><span class="p">,</span>
	<span class="mi">157</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">155</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">163</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
	<span class="mi">226</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">143</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">107</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span>
	<span class="mi">110</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">103</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">118</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>

	  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">atkbd_set3_keycode</span><span class="p">[</span><span class="n">ATKBD_KEYMAP_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>

	  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">129</span><span class="p">,</span><span class="mi">130</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span>
	<span class="mi">131</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span><span class="mi">133</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span>
	<span class="mi">134</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span>
	<span class="mi">136</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span><span class="mi">137</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span>
	<span class="mi">125</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span><span class="mi">126</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span>
	<span class="mi">113</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span>
	<span class="mi">108</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span><span class="mi">103</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">107</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span>
	 <span class="mi">82</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span><span class="mi">183</span><span class="p">,</span>

	<span class="mi">184</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">186</span><span class="p">,</span><span class="mi">187</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span><span class="mi">125</span><span class="p">,</span><span class="mi">126</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span><span class="mi">139</span><span class="p">,</span><span class="mi">172</span><span class="p">,</span><span class="mi">163</span><span class="p">,</span><span class="mi">165</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">152</span><span class="p">,</span><span class="mi">172</span><span class="p">,</span><span class="mi">166</span><span class="p">,</span><span class="mi">140</span><span class="p">,</span><span class="mi">160</span><span class="p">,</span><span class="mi">154</span><span class="p">,</span><span class="mi">113</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">167</span><span class="p">,</span><span class="mi">168</span><span class="p">,</span>
	<span class="mi">148</span><span class="p">,</span><span class="mi">149</span><span class="p">,</span><span class="mi">147</span><span class="p">,</span><span class="mi">140</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">atkbd_unxlate_table</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
          <span class="mi">0</span><span class="p">,</span><span class="mi">118</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span><span class="mi">102</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span>
         <span class="mi">21</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span>
         <span class="mi">35</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span>
         <span class="mi">50</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span><span class="mi">124</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>
         <span class="mi">11</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span><span class="mi">119</span><span class="p">,</span><span class="mi">126</span><span class="p">,</span><span class="mi">108</span><span class="p">,</span><span class="mi">117</span><span class="p">,</span><span class="mi">125</span><span class="p">,</span><span class="mi">123</span><span class="p">,</span><span class="mi">107</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">116</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span>
        <span class="mi">114</span><span class="p">,</span><span class="mi">122</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">113</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span>  <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span>
         <span class="mi">71</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span>
         <span class="mi">19</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">103</span><span class="p">,</span><span class="mi">104</span><span class="p">,</span><span class="mi">106</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">110</span>
<span class="p">};</span>

<span class="cp">#define ATKBD_CMD_SETLEDS	0x10ed</span>
<span class="cp">#define ATKBD_CMD_GSCANSET	0x11f0</span>
<span class="cp">#define ATKBD_CMD_SSCANSET	0x10f0</span>
<span class="cp">#define ATKBD_CMD_GETID		0x02f2</span>
<span class="cp">#define ATKBD_CMD_SETREP	0x10f3</span>
<span class="cp">#define ATKBD_CMD_ENABLE	0x00f4</span>
<span class="cp">#define ATKBD_CMD_RESET_DIS	0x00f5	</span><span class="cm">/* Reset to defaults and disable */</span><span class="cp"></span>
<span class="cp">#define ATKBD_CMD_RESET_DEF	0x00f6	</span><span class="cm">/* Reset to defaults */</span><span class="cp"></span>
<span class="cp">#define ATKBD_CMD_SETALL_MB	0x00f8	</span><span class="cm">/* Set all keys to give break codes */</span><span class="cp"></span>
<span class="cp">#define ATKBD_CMD_SETALL_MBR	0x00fa  </span><span class="cm">/* ... and repeat */</span><span class="cp"></span>
<span class="cp">#define ATKBD_CMD_RESET_BAT	0x02ff</span>
<span class="cp">#define ATKBD_CMD_RESEND	0x00fe</span>
<span class="cp">#define ATKBD_CMD_EX_ENABLE	0x10ea</span>
<span class="cp">#define ATKBD_CMD_EX_SETLEDS	0x20eb</span>
<span class="cp">#define ATKBD_CMD_OK_GETID	0x02e8</span>

<span class="cp">#define ATKBD_RET_ACK		0xfa</span>
<span class="cp">#define ATKBD_RET_NAK		0xfe</span>
<span class="cp">#define ATKBD_RET_BAT		0xaa</span>
<span class="cp">#define ATKBD_RET_EMUL0		0xe0</span>
<span class="cp">#define ATKBD_RET_EMUL1		0xe1</span>
<span class="cp">#define ATKBD_RET_RELEASE	0xf0</span>
<span class="cp">#define ATKBD_RET_HANJA		0xf1</span>
<span class="cp">#define ATKBD_RET_HANGEUL	0xf2</span>
<span class="cp">#define ATKBD_RET_ERR		0xff</span>

<span class="cp">#define ATKBD_KEY_UNKNOWN	0</span>
<span class="cp">#define ATKBD_KEY_NULL		255</span>

<span class="cp">#define ATKBD_SCR_1		0xfffe</span>
<span class="cp">#define ATKBD_SCR_2		0xfffd</span>
<span class="cp">#define ATKBD_SCR_4		0xfffc</span>
<span class="cp">#define ATKBD_SCR_8		0xfffb</span>
<span class="cp">#define ATKBD_SCR_CLICK		0xfffa</span>
<span class="cp">#define ATKBD_SCR_LEFT		0xfff9</span>
<span class="cp">#define ATKBD_SCR_RIGHT		0xfff8</span>

<span class="cp">#define ATKBD_SPECIAL		ATKBD_SCR_RIGHT</span>

<span class="cp">#define ATKBD_LED_EVENT_BIT	0</span>
<span class="cp">#define ATKBD_REP_EVENT_BIT	1</span>

<span class="cp">#define ATKBD_XL_ERR		0x01</span>
<span class="cp">#define ATKBD_XL_BAT		0x02</span>
<span class="cp">#define ATKBD_XL_ACK		0x04</span>
<span class="cp">#define ATKBD_XL_NAK		0x08</span>
<span class="cp">#define ATKBD_XL_HANGEUL	0x10</span>
<span class="cp">#define ATKBD_XL_HANJA		0x20</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">keycode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">set2</span><span class="p">;</span>
<span class="p">}</span> <span class="n">atkbd_scroll_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">ATKBD_SCR_1</span><span class="p">,</span>     <span class="mh">0xc5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ATKBD_SCR_2</span><span class="p">,</span>     <span class="mh">0x9d</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ATKBD_SCR_4</span><span class="p">,</span>     <span class="mh">0xa4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ATKBD_SCR_8</span><span class="p">,</span>     <span class="mh">0x9b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ATKBD_SCR_CLICK</span><span class="p">,</span> <span class="mh">0xe0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ATKBD_SCR_LEFT</span><span class="p">,</span>  <span class="mh">0xcb</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ATKBD_SCR_RIGHT</span><span class="p">,</span> <span class="mh">0xd2</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The atkbd control structure</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">atkbd</span> <span class="p">{</span>

	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="n">ps2dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Written only during init */</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">keycode</span><span class="p">[</span><span class="n">ATKBD_KEYMAP_SIZE</span><span class="p">];</span>
	<span class="n">DECLARE_BITMAP</span><span class="p">(</span><span class="n">force_release_mask</span><span class="p">,</span> <span class="n">ATKBD_KEYMAP_SIZE</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">set</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">translated</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">extra</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">write</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">softrepeat</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">softraw</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">scroll</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">enabled</span><span class="p">;</span>

	<span class="cm">/* Accessed only from interrupt */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">emul</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">resend</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">release</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">xl_bit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">err_count</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">event_work</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event_jiffies</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event_mask</span><span class="p">;</span>

	<span class="cm">/* Serializes reconnect(), attr-&gt;set() and event work */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * System-specific keymap fixup routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">atkbd_platform_fixup</span><span class="p">)(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">atkbd_platform_fixup_data</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">atkbd_platform_scancode_fixup</span><span class="p">)(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">atkbd_attr_show_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">atkbd_attr_set_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
				<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">));</span>
<span class="cp">#define ATKBD_DEFINE_ATTR(_name)						\</span>
<span class="cp">static ssize_t atkbd_show_##_name(struct atkbd *, char *);			\</span>
<span class="cp">static ssize_t atkbd_set_##_name(struct atkbd *, const char *, size_t);		\</span>
<span class="cp">static ssize_t atkbd_do_show_##_name(struct device *d,				\</span>
<span class="cp">				struct device_attribute *attr, char *b)		\</span>
<span class="cp">{										\</span>
<span class="cp">	return atkbd_attr_show_helper(d, b, atkbd_show_##_name);		\</span>
<span class="cp">}										\</span>
<span class="cp">static ssize_t atkbd_do_set_##_name(struct device *d,				\</span>
<span class="cp">			struct device_attribute *attr, const char *b, size_t s)	\</span>
<span class="cp">{										\</span>
<span class="cp">	return atkbd_attr_set_helper(d, b, s, atkbd_set_##_name);		\</span>
<span class="cp">}										\</span>
<span class="cp">static struct device_attribute atkbd_attr_##_name =				\</span>
<span class="cp">	__ATTR(_name, S_IWUSR | S_IRUGO, atkbd_do_show_##_name, atkbd_do_set_##_name);</span>

<span class="n">ATKBD_DEFINE_ATTR</span><span class="p">(</span><span class="n">extra</span><span class="p">);</span>
<span class="n">ATKBD_DEFINE_ATTR</span><span class="p">(</span><span class="n">force_release</span><span class="p">);</span>
<span class="n">ATKBD_DEFINE_ATTR</span><span class="p">(</span><span class="n">scroll</span><span class="p">);</span>
<span class="n">ATKBD_DEFINE_ATTR</span><span class="p">(</span><span class="n">set</span><span class="p">);</span>
<span class="n">ATKBD_DEFINE_ATTR</span><span class="p">(</span><span class="n">softrepeat</span><span class="p">);</span>
<span class="n">ATKBD_DEFINE_ATTR</span><span class="p">(</span><span class="n">softraw</span><span class="p">);</span>

<span class="cp">#define ATKBD_DEFINE_RO_ATTR(_name)						\</span>
<span class="cp">static ssize_t atkbd_show_##_name(struct atkbd *, char *);			\</span>
<span class="cp">static ssize_t atkbd_do_show_##_name(struct device *d,				\</span>
<span class="cp">				struct device_attribute *attr, char *b)		\</span>
<span class="cp">{										\</span>
<span class="cp">	return atkbd_attr_show_helper(d, b, atkbd_show_##_name);		\</span>
<span class="cp">}										\</span>
<span class="cp">static struct device_attribute atkbd_attr_##_name =				\</span>
<span class="cp">	__ATTR(_name, S_IRUGO, atkbd_do_show_##_name, NULL);</span>

<span class="n">ATKBD_DEFINE_RO_ATTR</span><span class="p">(</span><span class="n">err_count</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">atkbd_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">atkbd_attr_extra</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atkbd_attr_force_release</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atkbd_attr_scroll</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atkbd_attr_set</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atkbd_attr_softrepeat</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atkbd_attr_softraw</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atkbd_attr_err_count</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">atkbd_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span>	<span class="o">=</span> <span class="n">atkbd_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xl_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATKBD_RET_BAT</span><span class="p">,</span> <span class="n">ATKBD_RET_ERR</span><span class="p">,</span> <span class="n">ATKBD_RET_ACK</span><span class="p">,</span>
	<span class="n">ATKBD_RET_NAK</span><span class="p">,</span> <span class="n">ATKBD_RET_HANJA</span><span class="p">,</span> <span class="n">ATKBD_RET_HANGEUL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Checks if we should mangle the scancode to extract &#39;release&#39; bit</span>
<span class="cm"> * in translated mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">atkbd_need_xlate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">xl_bit</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">ATKBD_RET_EMUL0</span> <span class="o">||</span> <span class="n">code</span> <span class="o">==</span> <span class="n">ATKBD_RET_EMUL1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">xl_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">xl_table</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xl_bit</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculates new value of xl_bit so the driver can distinguish</span>
<span class="cm"> * between make/break pair of scancodes for select keys and PS/2</span>
<span class="cm"> * protocol responses.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atkbd_calculate_xl_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">xl_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">code</span> <span class="o">^</span> <span class="n">xl_table</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="n">__clear_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">xl_bit</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">__set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">xl_bit</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Encode the scancode, 0xe0 prefix, and high bit into a single integer,</span>
<span class="cm"> * keeping kernel 2.4 compatibility for set 2</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">atkbd_compat_scancode</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">emul</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">code</span> <span class="o">|=</span> <span class="mh">0x100</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">emul</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">code</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">code</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atkbd_interrupt(). Here takes place processing of data received from</span>
<span class="cm"> * the keyboard into events.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">atkbd_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scroll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hscroll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">click</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">keycode</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Received %02x flags %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="cp">#if !defined(__i386__) &amp;&amp; !defined (__x86_64__)</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SERIO_FRAME</span> <span class="o">|</span> <span class="n">SERIO_PARITY</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SERIO_TIMEOUT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">resend</span> <span class="o">&amp;&amp;</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Frame/parity error: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">serio_write</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">ATKBD_CMD_RESEND</span><span class="p">);</span>
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">resend</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flags</span> <span class="o">&amp;&amp;</span> <span class="n">data</span> <span class="o">==</span> <span class="n">ATKBD_RET_ACK</span><span class="p">)</span>
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">resend</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PS2_FLAG_ACK</span><span class="p">))</span>
		<span class="k">if</span>  <span class="p">(</span><span class="n">ps2_handle_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PS2_FLAG_CMD</span><span class="p">))</span>
		<span class="k">if</span>  <span class="p">(</span><span class="n">ps2_handle_response</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">input_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EV_MSC</span><span class="p">,</span> <span class="n">MSC_RAW</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd_platform_scancode_fixup</span><span class="p">)</span>
		<span class="n">code</span> <span class="o">=</span> <span class="n">atkbd_platform_scancode_fixup</span><span class="p">(</span><span class="n">atkbd</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">translated</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">emul</span> <span class="o">||</span> <span class="n">atkbd_need_xlate</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">xl_bit</span><span class="p">,</span> <span class="n">code</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">code</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">code</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">emul</span><span class="p">)</span>
			<span class="n">atkbd_calculate_xl_bit</span><span class="p">(</span><span class="n">atkbd</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATKBD_RET_BAT</span>:
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">serio_reconnect</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATKBD_RET_EMUL0</span>:
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">emul</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATKBD_RET_EMUL1</span>:
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">emul</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATKBD_RET_RELEASE</span>:
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATKBD_RET_ACK</span>:
	<span class="k">case</span> <span class="n">ATKBD_RET_NAK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Spurious %s on %s. &quot;</span>
				 <span class="s">&quot;Some program might be trying to access hardware directly.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">data</span> <span class="o">==</span> <span class="n">ATKBD_RET_ACK</span> <span class="o">?</span> <span class="s">&quot;ACK&quot;</span> <span class="o">:</span> <span class="s">&quot;NAK&quot;</span><span class="p">,</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATKBD_RET_ERR</span>:
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">err_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Keyboard on %s reports too many keys pressed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">code</span> <span class="o">=</span> <span class="n">atkbd_compat_scancode</span><span class="p">(</span><span class="n">atkbd</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">emul</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">emul</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">keycode</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">code</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">!=</span> <span class="n">ATKBD_KEY_NULL</span><span class="p">)</span>
		<span class="n">input_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EV_MSC</span><span class="p">,</span> <span class="n">MSC_SCAN</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">keycode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATKBD_KEY_NULL</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATKBD_KEY_UNKNOWN</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;Unknown key %s (%s set %d, code %#x on %s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">?</span> <span class="s">&quot;released&quot;</span> <span class="o">:</span> <span class="s">&quot;pressed&quot;</span><span class="p">,</span>
			 <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">translated</span> <span class="o">?</span> <span class="s">&quot;translated&quot;</span> <span class="o">:</span> <span class="s">&quot;raw&quot;</span><span class="p">,</span>
			 <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;Use &#39;setkeycodes %s%02x &lt;keycode&gt;&#39; to make it known.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0x80</span> <span class="o">?</span> <span class="s">&quot;e0&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATKBD_SCR_1</span>:
		<span class="n">scroll</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATKBD_SCR_2</span>:
		<span class="n">scroll</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATKBD_SCR_4</span>:
		<span class="n">scroll</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATKBD_SCR_8</span>:
		<span class="n">scroll</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATKBD_SCR_CLICK</span>:
		<span class="n">click</span> <span class="o">=</span> <span class="o">!</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATKBD_SCR_LEFT</span>:
		<span class="n">hscroll</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATKBD_SCR_RIGHT</span>:
		<span class="n">hscroll</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softrepeat</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">keycode</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Workaround Toshiba laptop multiple keypress */</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">==</span> <span class="n">code</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_DELAY</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">input_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">keycode</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">force_release_mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">keycode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">scroll</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">click</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">click</span><span class="p">);</span>
		<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_WHEEL</span><span class="p">,</span>
				 <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">?</span> <span class="o">-</span><span class="n">scroll</span> <span class="o">:</span> <span class="n">scroll</span><span class="p">);</span>
		<span class="n">input_report_rel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">REL_HWHEEL</span><span class="p">,</span> <span class="n">hscroll</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atkbd_set_repeat_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">short</span> <span class="n">period</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="mi">33</span><span class="p">,</span>  <span class="mi">37</span><span class="p">,</span>  <span class="mi">42</span><span class="p">,</span>  <span class="mi">46</span><span class="p">,</span>  <span class="mi">50</span><span class="p">,</span>  <span class="mi">54</span><span class="p">,</span>  <span class="mi">58</span><span class="p">,</span>  <span class="mi">63</span><span class="p">,</span>  <span class="mi">67</span><span class="p">,</span>  <span class="mi">75</span><span class="p">,</span>  <span class="mi">83</span><span class="p">,</span>  <span class="mi">92</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span>
		 <span class="mi">133</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">167</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">217</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">303</span><span class="p">,</span> <span class="mi">333</span><span class="p">,</span> <span class="mi">370</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">435</span><span class="p">,</span> <span class="mi">470</span><span class="p">,</span> <span class="mi">500</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">short</span> <span class="n">delay</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">750</span><span class="p">,</span> <span class="mi">1000</span> <span class="p">};</span>

	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">period</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">period</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_PERIOD</span><span class="p">])</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_PERIOD</span><span class="p">]</span> <span class="o">=</span> <span class="n">period</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">delay</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_DELAY</span><span class="p">])</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_DELAY</span><span class="p">]</span> <span class="o">=</span> <span class="n">delay</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

	<span class="n">param</span> <span class="o">=</span> <span class="n">i</span> <span class="o">|</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">,</span> <span class="n">ATKBD_CMD_SETREP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atkbd_set_leds</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LED_SCROLLL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		 <span class="o">|</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LED_NUML</span><span class="p">,</span>    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		 <span class="o">|</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LED_CAPSL</span><span class="p">,</span>   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">ATKBD_CMD_SETLEDS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LED_COMPOSE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
			 <span class="o">|</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LED_SLEEP</span><span class="p">,</span>   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x02</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
			 <span class="o">|</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LED_SUSPEND</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x04</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
			 <span class="o">|</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LED_MISC</span><span class="p">,</span>    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
			 <span class="o">|</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LED_MUTE</span><span class="p">,</span>    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x20</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">ATKBD_CMD_EX_SETLEDS</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atkbd_event_work() is used to complete processing of events that</span>
<span class="cm"> * can not be processed by input_event() which is often called from</span>
<span class="cm"> * interrupt context.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atkbd_event_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atkbd</span><span class="p">,</span> <span class="n">event_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Serio ports are resumed asynchronously so while driver core</span>
<span class="cm">		 * thinks that device is already fully operational in reality</span>
<span class="cm">		 * it may not be ready yet. In this case we need to keep</span>
<span class="cm">		 * rescheduling till reconnect completes.</span>
<span class="cm">		 */</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">,</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">ATKBD_LED_EVENT_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">event_mask</span><span class="p">))</span>
			<span class="n">atkbd_set_leds</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">ATKBD_REP_EVENT_BIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">event_mask</span><span class="p">))</span>
			<span class="n">atkbd_set_repeat_rate</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Schedule switch for execution. We need to throttle requests,</span>
<span class="cm"> * otherwise keyboard may become unresponsive.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atkbd_schedule_event_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event_bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">event_jiffies</span> <span class="o">+</span> <span class="n">delay</span><span class="p">))</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">event_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">event_bit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">event_mask</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Event callback from the input module. Events that change the state of</span>
<span class="cm"> * the hardware are processed here. If action can not be performed in</span>
<span class="cm"> * interrupt context it is offloaded to atkbd_event_work.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atkbd_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">EV_LED</span>:
		<span class="n">atkbd_schedule_event_work</span><span class="p">(</span><span class="n">atkbd</span><span class="p">,</span> <span class="n">ATKBD_LED_EVENT_BIT</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EV_REP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softrepeat</span><span class="p">)</span>
			<span class="n">atkbd_schedule_event_work</span><span class="p">(</span><span class="n">atkbd</span><span class="p">,</span> <span class="n">ATKBD_REP_EVENT_BIT</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atkbd_enable() signals that interrupt handler is allowed to</span>
<span class="cm"> * generate input events.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">atkbd_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">serio_pause_rx</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">);</span>
	<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">serio_continue_rx</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atkbd_disable() tells input handler that all incoming data except</span>
<span class="cm"> * for ACKs and command response should be dropped.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">atkbd_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">serio_pause_rx</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">);</span>
	<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">serio_continue_rx</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atkbd_probe() probes for an AT keyboard on a serio port.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atkbd_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * Some systems, where the bit-twiddling when testing the io-lines of the</span>
<span class="cm"> * controller may confuse the keyboard need a full reset of the keyboard. On</span>
<span class="cm"> * these systems the BIOS also usually doesn&#39;t do it for us.</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd_reset</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ATKBD_CMD_RESET_BAT</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps2dev</span><span class="o">-&gt;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;keyboard reset failed on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ps2dev</span><span class="o">-&gt;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Then we check the keyboard ID. We should get 0xab83 under normal conditions.</span>
<span class="cm"> * Some keyboards report different values, but the first byte is always 0xab or</span>
<span class="cm"> * 0xac. Some old AT keyboards don&#39;t report anything. If a mouse is connected, this</span>
<span class="cm"> * should make sure we don&#39;t try to set the LEDs on it.</span>
<span class="cm"> */</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xa5</span><span class="p">;</span>	<span class="cm">/* initialize with invalid values */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">ATKBD_CMD_GETID</span><span class="p">))</span> <span class="p">{</span>

<span class="cm">/*</span>
<span class="cm"> * If the get ID command failed, we check if we can at least set the LEDs on</span>
<span class="cm"> * the keyboard. This should work on every keyboard out there. It also turns</span>
<span class="cm"> * the LEDs off, which we want anyway.</span>
<span class="cm"> */</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">ATKBD_CMD_SETLEDS</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xabba</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ps2_is_keyboard_id</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0xaca1</span> <span class="o">&amp;&amp;</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">translated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps2dev</span><span class="o">-&gt;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;NCD terminal keyboards are only supported on non-translating controlelrs. &quot;</span>
			<span class="s">&quot;Use i8042.direct=1 to disable translation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atkbd_select_set checks if a keyboard has a working Set 3 support, and</span>
<span class="cm"> * sets it into that. Unfortunately there are keyboards that can be switched</span>
<span class="cm"> * to Set 3, but don&#39;t work well in that (BTC Multimedia ...)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atkbd_select_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target_set</span><span class="p">,</span> <span class="kt">int</span> <span class="n">allow_extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * For known special keyboards we can go ahead and set the correct set.</span>
<span class="cm"> * We check for NCD PS/2 Sun, NorthGate OmniKey 101 and</span>
<span class="cm"> * IBM RapidAccess / IBM EzButton / Chicony KBP-8993 keyboards.</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">translated</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0xaca1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">ATKBD_CMD_SSCANSET</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">allow_extra</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x71</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">ATKBD_CMD_EX_ENABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd_terminal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">ATKBD_CMD_SETALL_MB</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_set</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">ATKBD_CMD_OK_GETID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">ATKBD_CMD_SSCANSET</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">ATKBD_CMD_GSCANSET</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">ATKBD_CMD_SSCANSET</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">ATKBD_CMD_SETALL_MBR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atkbd_reset_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * Set the LEDs to a predefined state (all off).</span>
<span class="cm"> */</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">ATKBD_CMD_SETLEDS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Set autorepeat to fastest possible.</span>
<span class="cm"> */</span>

	<span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">ATKBD_CMD_SETREP</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atkbd_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps2dev</span> <span class="o">*</span><span class="n">ps2dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Enable the keyboard to receive keystrokes.</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps2_command</span><span class="p">(</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ATKBD_CMD_ENABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps2dev</span><span class="o">-&gt;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Failed to enable keyboard on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ps2dev</span><span class="o">-&gt;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atkbd_cleanup() restores the keyboard state so that BIOS is happy after a</span>
<span class="cm"> * reboot.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atkbd_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>

	<span class="n">atkbd_disable</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
	<span class="n">ps2_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ATKBD_CMD_RESET_DEF</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * atkbd_disconnect() closes and frees.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atkbd_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>

	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atkbd_attribute_group</span><span class="p">);</span>

	<span class="n">atkbd_disable</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure we don&#39;t have a command in flight.</span>
<span class="cm">	 * Note that since atkbd-&gt;enabled is false event work will keep</span>
<span class="cm">	 * rescheduling itself until it gets canceled and will not try</span>
<span class="cm">	 * accessing freed input device or serio port.</span>
<span class="cm">	 */</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">);</span>

	<span class="n">serio_close</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>
	<span class="n">serio_set_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * generate release events for the keycodes given in data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atkbd_apply_forced_release_keylist</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span><span class="o">*</span> <span class="n">atkbd</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">keys</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1U</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">force_release_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Most special keys (Fn+F?) on Dell laptops do not generate release</span>
<span class="cm"> * events so we have to do it ourselves.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atkbd_dell_laptop_forced_release_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="o">-</span><span class="mi">1U</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Perform fixup for HP system that doesn&#39;t generate release</span>
<span class="cm"> * for its video switch</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atkbd_hp_forced_release_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x94</span><span class="p">,</span> <span class="o">-</span><span class="mi">1U</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Samsung NC10,NC20 with Fn+F? key release not working</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atkbd_samsung_forced_release_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="o">-</span><span class="mi">1U</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Amilo Pi 3525 key release for Fn+Volume keys not working</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atkbd_amilo_pi3525_forced_release_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1U</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Amilo Xi 3650 key release for light touch bar not working</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atkbd_amilo_xi3650_forced_release_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1U</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Soltech TA12 system with broken key release on volume keys and mute key</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atkdb_soltech_ta12_forced_release_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1U</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Many notebooks don&#39;t send key release event for volume up/down</span>
<span class="cm"> * keys, with key list below common among them</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">atkbd_volume_forced_release_keys</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xae</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1U</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * OQO 01+ multimedia keys (64--66) generate e0 6x upon release whereas</span>
<span class="cm"> * they should be generating e4-e6 (0x80 | code).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">atkbd_oqo_01plus_scancode_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span>
						    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">translated</span> <span class="o">&amp;&amp;</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">emul</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="mh">0x64</span> <span class="o">||</span> <span class="n">code</span> <span class="o">==</span> <span class="mh">0x65</span> <span class="o">||</span> <span class="n">code</span> <span class="o">==</span> <span class="mh">0x66</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">emul</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">code</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">code</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atkbd_set_keycode_table() initializes keyboard&#39;s keycode table</span>
<span class="cm"> * according to the selected scancode set</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atkbd_set_keycode_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scancode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">));</span>
	<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">force_release_mask</span><span class="p">,</span> <span class="n">ATKBD_KEYMAP_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">translated</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scancode</span> <span class="o">=</span> <span class="n">atkbd_unxlate_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">atkbd_set2_keycode</span><span class="p">[</span><span class="n">scancode</span><span class="p">];</span>
			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">i</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">]</span> <span class="o">=</span> <span class="n">atkbd_set2_keycode</span><span class="p">[</span><span class="n">scancode</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">scroll</span><span class="p">)</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">atkbd_scroll_keys</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">scancode</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="n">atkbd_scroll_keys</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">set2</span><span class="p">)</span>
						<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">i</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">]</span> <span class="o">=</span> <span class="n">atkbd_scroll_keys</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">keycode</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">,</span> <span class="n">atkbd_set3_keycode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">,</span> <span class="n">atkbd_set2_keycode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">scroll</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">atkbd_scroll_keys</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scancode</span> <span class="o">=</span> <span class="n">atkbd_scroll_keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set2</span><span class="p">;</span>
				<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">scancode</span><span class="p">]</span> <span class="o">=</span> <span class="n">atkbd_scroll_keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">keycode</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * HANGEUL and HANJA keys do not send release events so we need to</span>
<span class="cm"> * generate such events ourselves</span>
<span class="cm"> */</span>
	<span class="n">scancode</span> <span class="o">=</span> <span class="n">atkbd_compat_scancode</span><span class="p">(</span><span class="n">atkbd</span><span class="p">,</span> <span class="n">ATKBD_RET_HANGEUL</span><span class="p">);</span>
	<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">scancode</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_HANGEUL</span><span class="p">;</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">scancode</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">force_release_mask</span><span class="p">);</span>

	<span class="n">scancode</span> <span class="o">=</span> <span class="n">atkbd_compat_scancode</span><span class="p">(</span><span class="n">atkbd</span><span class="p">,</span> <span class="n">ATKBD_RET_HANJA</span><span class="p">);</span>
	<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">scancode</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_HANJA</span><span class="p">;</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">scancode</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">force_release_mask</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Perform additional fixups</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd_platform_fixup</span><span class="p">)</span>
		<span class="n">atkbd_platform_fixup</span><span class="p">(</span><span class="n">atkbd</span><span class="p">,</span> <span class="n">atkbd_platform_fixup_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atkbd_set_device_attrs() sets up keyboard&#39;s input device structure</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atkbd_set_device_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
			 <span class="s">&quot;AT Set 2 Extra keyboard&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
			 <span class="s">&quot;AT %s Set %d keyboard&quot;</span><span class="p">,</span>
			 <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">translated</span> <span class="o">?</span> <span class="s">&quot;Translated&quot;</span> <span class="o">:</span> <span class="s">&quot;Raw&quot;</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">),</span>
		 <span class="s">&quot;%s/input0&quot;</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">);</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_I8042</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">translated</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">atkbd_event</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">.</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">atkbd</span><span class="p">);</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_REP</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_MSC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_LED</span><span class="p">);</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">ledbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">LED_NUML</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">LED_CAPSL</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">LED_SCROLLL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">)</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">ledbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">LED_COMPOSE</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">LED_SUSPEND</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">LED_SLEEP</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">LED_MUTE</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">LED_MISC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softrepeat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_DELAY</span><span class="p">]</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_PERIOD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">mscbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softraw</span> <span class="o">?</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">MSC_SCAN</span><span class="p">)</span> <span class="o">:</span>
		<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">MSC_RAW</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">MSC_SCAN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">scroll</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_REL</span><span class="p">);</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">REL_WHEEL</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">REL_HWHEEL</span><span class="p">);</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keycode</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keycodesize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">);</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keycodemax</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">atkbd_set2_keycode</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATKBD_KEYMAP_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">KEY_RESERVED</span> <span class="o">&amp;&amp;</span>
		    <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ATKBD_KEY_NULL</span> <span class="o">&amp;&amp;</span>
		    <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ATKBD_SPECIAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atkbd_connect() is called when the serio module finds an interface</span>
<span class="cm"> * that isn&#39;t handled yet by an appropriate device driver. We check if</span>
<span class="cm"> * there is an AT keyboard out there and if yes, we register ourselves</span>
<span class="cm"> * to the input module.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atkbd_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">serio_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">atkbd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atkbd</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>

	<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">ps2_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">ps2dev</span><span class="p">,</span> <span class="n">serio</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">event_work</span><span class="p">,</span> <span class="n">atkbd_event_work</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">SERIO_8042_XL</span>:
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">translated</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="cm">/* Fall through */</span>

	<span class="k">case</span> <span class="n">SERIO_8042</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span>
			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softraw</span> <span class="o">=</span> <span class="n">atkbd_softraw</span><span class="p">;</span>
	<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softrepeat</span> <span class="o">=</span> <span class="n">atkbd_softrepeat</span><span class="p">;</span>
	<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">scroll</span> <span class="o">=</span> <span class="n">atkbd_scroll</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softrepeat</span><span class="p">)</span>
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softraw</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">serio_set_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">atkbd</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">serio_open</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">drv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atkbd_probe</span><span class="p">(</span><span class="n">atkbd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">atkbd_select_set</span><span class="p">(</span><span class="n">atkbd</span><span class="p">,</span> <span class="n">atkbd_set</span><span class="p">,</span> <span class="n">atkbd_extra</span><span class="p">);</span>
		<span class="n">atkbd_reset_state</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
		<span class="n">atkbd_activate</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xab00</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atkbd_set_keycode_table</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
	<span class="n">atkbd_set_device_attrs</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atkbd_attribute_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>

	<span class="n">atkbd_enable</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail4</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail4:</span> <span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atkbd_attribute_group</span><span class="p">);</span>
 <span class="nl">fail3:</span>	<span class="n">serio_close</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>
 <span class="nl">fail2:</span>	<span class="n">serio_set_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
 <span class="nl">fail1:</span>	<span class="n">input_free_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * atkbd_reconnect() tries to restore keyboard into a sane state and is</span>
<span class="cm"> * most likely called on resume.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atkbd_reconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">serio_driver</span> <span class="o">*</span><span class="n">drv</span> <span class="o">=</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atkbd</span> <span class="o">||</span> <span class="o">!</span><span class="n">drv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">serio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;reconnect request, but serio is disconnected, ignoring...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">atkbd_disable</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atkbd_probe</span><span class="p">(</span><span class="n">atkbd</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">!=</span> <span class="n">atkbd_select_set</span><span class="p">(</span><span class="n">atkbd</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">atkbd_activate</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Restore LED state and repeat rate. While input core</span>
<span class="cm">		 * will do this for us at resume time reconnect may happen</span>
<span class="cm">		 * because user requested it via sysfs or simply because</span>
<span class="cm">		 * keyboard was unplugged and plugged in again so we need</span>
<span class="cm">		 * to do it ourselves here.</span>
<span class="cm">		 */</span>
		<span class="n">atkbd_set_leds</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softrepeat</span><span class="p">)</span>
			<span class="n">atkbd_set_repeat_rate</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="n">atkbd_enable</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">serio_device_id</span> <span class="n">atkbd_serio_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">SERIO_8042</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proto</span>	<span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra</span>	<span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">SERIO_8042_XL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proto</span>	<span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra</span>	<span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">SERIO_RS232</span><span class="p">,</span>
		<span class="p">.</span><span class="n">proto</span>	<span class="o">=</span> <span class="n">SERIO_PS2SER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">extra</span>	<span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">atkbd_serio_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">serio_driver</span> <span class="n">atkbd_drv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;atkbd&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">description</span>	<span class="o">=</span> <span class="n">DRIVER_DESC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">atkbd_serio_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">interrupt</span>	<span class="o">=</span> <span class="n">atkbd_interrupt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span>	<span class="o">=</span> <span class="n">atkbd_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reconnect</span>	<span class="o">=</span> <span class="n">atkbd_reconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">atkbd_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span>	<span class="o">=</span> <span class="n">atkbd_cleanup</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atkbd_attr_show_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span> <span class="o">=</span> <span class="n">to_serio_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">atkbd</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atkbd_attr_set_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
				<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span> <span class="o">=</span> <span class="n">to_serio_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span> <span class="o">=</span> <span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">atkbd_disable</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">atkbd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">atkbd_enable</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atkbd_show_extra</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atkbd_set_extra</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">old_dev</span><span class="p">,</span> <span class="o">*</span><span class="n">new_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">old_extra</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_set</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">extra</span> <span class="o">!=</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Since device&#39;s properties will change we need to</span>
<span class="cm">		 * unregister old device. But allocate and register</span>
<span class="cm">		 * new one first to make sure we have it.</span>
<span class="cm">		 */</span>
		<span class="n">old_dev</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">old_extra</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
		<span class="n">old_set</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">;</span>

		<span class="n">new_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">new_dev</span><span class="p">;</span>
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">atkbd_select_set</span><span class="p">(</span><span class="n">atkbd</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">atkbd_reset_state</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
		<span class="n">atkbd_activate</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
		<span class="n">atkbd_set_keycode_table</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
		<span class="n">atkbd_set_device_attrs</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_free_device</span><span class="p">(</span><span class="n">new_dev</span><span class="p">);</span>

			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">old_dev</span><span class="p">;</span>
			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">atkbd_select_set</span><span class="p">(</span><span class="n">atkbd</span><span class="p">,</span> <span class="n">old_set</span><span class="p">,</span> <span class="n">old_extra</span><span class="p">);</span>
			<span class="n">atkbd_set_keycode_table</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
			<span class="n">atkbd_set_device_attrs</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">old_dev</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atkbd_show_force_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">bitmap_scnlistprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">force_release_mask</span><span class="p">,</span> <span class="n">ATKBD_KEYMAP_SIZE</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atkbd_set_force_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* 64 bytes on stack should be acceptable */</span>
	<span class="n">DECLARE_BITMAP</span><span class="p">(</span><span class="n">new_mask</span><span class="p">,</span> <span class="n">ATKBD_KEYMAP_SIZE</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">bitmap_parselist</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">new_mask</span><span class="p">,</span> <span class="n">ATKBD_KEYMAP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">force_release_mask</span><span class="p">,</span> <span class="n">new_mask</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">force_release_mask</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atkbd_show_scroll</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">scroll</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atkbd_set_scroll</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">old_dev</span><span class="p">,</span> <span class="o">*</span><span class="n">new_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">old_scroll</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">scroll</span> <span class="o">!=</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">old_dev</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">old_scroll</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">scroll</span><span class="p">;</span>

		<span class="n">new_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">new_dev</span><span class="p">;</span>
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">scroll</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">atkbd_set_keycode_table</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
		<span class="n">atkbd_set_device_attrs</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_free_device</span><span class="p">(</span><span class="n">new_dev</span><span class="p">);</span>

			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">scroll</span> <span class="o">=</span> <span class="n">old_scroll</span><span class="p">;</span>
			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">old_dev</span><span class="p">;</span>
			<span class="n">atkbd_set_keycode_table</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
			<span class="n">atkbd_set_device_attrs</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">old_dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atkbd_show_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atkbd_set_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">old_dev</span><span class="p">,</span> <span class="o">*</span><span class="n">new_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_set</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">old_extra</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">!=</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">old_dev</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">old_extra</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
		<span class="n">old_set</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">;</span>

		<span class="n">new_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">new_dev</span><span class="p">;</span>
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">atkbd_select_set</span><span class="p">(</span><span class="n">atkbd</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">);</span>
		<span class="n">atkbd_reset_state</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
		<span class="n">atkbd_activate</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
		<span class="n">atkbd_set_keycode_table</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
		<span class="n">atkbd_set_device_attrs</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_free_device</span><span class="p">(</span><span class="n">new_dev</span><span class="p">);</span>

			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">old_dev</span><span class="p">;</span>
			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">atkbd_select_set</span><span class="p">(</span><span class="n">atkbd</span><span class="p">,</span> <span class="n">old_set</span><span class="p">,</span> <span class="n">old_extra</span><span class="p">);</span>
			<span class="n">atkbd_set_keycode_table</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>
			<span class="n">atkbd_set_device_attrs</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">old_dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atkbd_show_softrepeat</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softrepeat</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atkbd_set_softrepeat</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">old_dev</span><span class="p">,</span> <span class="o">*</span><span class="n">new_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">old_softrepeat</span><span class="p">,</span> <span class="n">old_softraw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softrepeat</span> <span class="o">!=</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">old_dev</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">old_softrepeat</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softrepeat</span><span class="p">;</span>
		<span class="n">old_softraw</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softraw</span><span class="p">;</span>

		<span class="n">new_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">new_dev</span><span class="p">;</span>
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softrepeat</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softrepeat</span><span class="p">)</span>
			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softraw</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">atkbd_set_device_attrs</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_free_device</span><span class="p">(</span><span class="n">new_dev</span><span class="p">);</span>

			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">old_dev</span><span class="p">;</span>
			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softrepeat</span> <span class="o">=</span> <span class="n">old_softrepeat</span><span class="p">;</span>
			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softraw</span> <span class="o">=</span> <span class="n">old_softraw</span><span class="p">;</span>
			<span class="n">atkbd_set_device_attrs</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">old_dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atkbd_show_softraw</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softraw</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atkbd_set_softraw</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">old_dev</span><span class="p">,</span> <span class="o">*</span><span class="n">new_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">old_softraw</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softraw</span> <span class="o">!=</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">old_dev</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">old_softraw</span> <span class="o">=</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softraw</span><span class="p">;</span>

		<span class="n">new_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">new_dev</span><span class="p">;</span>
		<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softraw</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">atkbd_set_device_attrs</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_free_device</span><span class="p">(</span><span class="n">new_dev</span><span class="p">);</span>

			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">old_dev</span><span class="p">;</span>
			<span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">softraw</span> <span class="o">=</span> <span class="n">old_softraw</span><span class="p">;</span>
			<span class="n">atkbd_set_device_attrs</span><span class="p">(</span><span class="n">atkbd</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">old_dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">atkbd_show_err_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">atkbd</span> <span class="o">*</span><span class="n">atkbd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atkbd</span><span class="o">-&gt;</span><span class="n">err_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">atkbd_setup_forced_release</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atkbd_platform_fixup</span> <span class="o">=</span> <span class="n">atkbd_apply_forced_release_keylist</span><span class="p">;</span>
	<span class="n">atkbd_platform_fixup_data</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">atkbd_setup_scancode_fixup</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atkbd_platform_scancode_fixup</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">atkbd_dmi_quirk_table</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_CHASSIS_TYPE</span><span class="p">,</span> <span class="s">&quot;8&quot;</span><span class="p">),</span> <span class="cm">/* Portable */</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atkbd_setup_forced_release</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">atkbd_dell_laptop_forced_release_keys</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Computer Corporation&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_CHASSIS_TYPE</span><span class="p">,</span> <span class="s">&quot;8&quot;</span><span class="p">),</span> <span class="cm">/* Portable */</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atkbd_setup_forced_release</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">atkbd_dell_laptop_forced_release_keys</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;HP 2133&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atkbd_setup_forced_release</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">atkbd_hp_forced_release_keys</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Pavilion ZV6100&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atkbd_setup_forced_release</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">atkbd_volume_forced_release_keys</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Presario R4000&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atkbd_setup_forced_release</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">atkbd_volume_forced_release_keys</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Presario R4100&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atkbd_setup_forced_release</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">atkbd_volume_forced_release_keys</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Presario R4200&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atkbd_setup_forced_release</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">atkbd_volume_forced_release_keys</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* Inventec Symphony */</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;INVENTEC&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;SYMPHONY 6.0/7.0&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atkbd_setup_forced_release</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">atkbd_volume_forced_release_keys</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* Samsung NC10 */</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;SAMSUNG ELECTRONICS CO., LTD.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;NC10&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atkbd_setup_forced_release</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">atkbd_samsung_forced_release_keys</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* Samsung NC20 */</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;SAMSUNG ELECTRONICS CO., LTD.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;NC20&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atkbd_setup_forced_release</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">atkbd_samsung_forced_release_keys</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* Samsung SQ45S70S */</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;SAMSUNG ELECTRONICS CO., LTD.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;SQ45S70S&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atkbd_setup_forced_release</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">atkbd_samsung_forced_release_keys</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* Fujitsu Amilo PA 1510 */</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;FUJITSU SIEMENS&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;AMILO Pa 1510&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atkbd_setup_forced_release</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">atkbd_volume_forced_release_keys</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* Fujitsu Amilo Pi 3525 */</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;FUJITSU SIEMENS&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;AMILO Pi 3525&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atkbd_setup_forced_release</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">atkbd_amilo_pi3525_forced_release_keys</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* Fujitsu Amilo Xi 3650 */</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;FUJITSU SIEMENS&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;AMILO Xi 3650&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atkbd_setup_forced_release</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">atkbd_amilo_xi3650_forced_release_keys</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Soltech Corporation&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;TA12&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atkbd_setup_forced_release</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">atkdb_soltech_ta12_forced_release_keys</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* OQO Model 01+ */</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;OQO&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;ZEPTO&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">atkbd_setup_scancode_fixup</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">atkbd_oqo_01plus_scancode_fixup</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">atkbd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmi_check_system</span><span class="p">(</span><span class="n">atkbd_dmi_quirk_table</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">serio_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd_drv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">atkbd_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">serio_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atkbd_drv</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">atkbd_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">atkbd_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
