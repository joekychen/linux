<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › misc › ad714x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ad714x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * AD714X CapTouch Programmable Controller driver supporting AD7142/3/7/8/7A</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2009-2011 Analog Devices Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the GPL-2 or later.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/input/ad714x.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &quot;ad714x.h&quot;</span>

<span class="cp">#define AD714X_PWR_CTRL           0x0</span>
<span class="cp">#define AD714X_STG_CAL_EN_REG     0x1</span>
<span class="cp">#define AD714X_AMB_COMP_CTRL0_REG 0x2</span>
<span class="cp">#define AD714X_PARTID_REG         0x17</span>
<span class="cp">#define AD7142_PARTID             0xE620</span>
<span class="cp">#define AD7143_PARTID             0xE630</span>
<span class="cp">#define AD7147_PARTID             0x1470</span>
<span class="cp">#define AD7148_PARTID             0x1480</span>
<span class="cp">#define AD714X_STAGECFG_REG       0x80</span>
<span class="cp">#define AD714X_SYSCFG_REG         0x0</span>

<span class="cp">#define STG_LOW_INT_EN_REG     0x5</span>
<span class="cp">#define STG_HIGH_INT_EN_REG    0x6</span>
<span class="cp">#define STG_COM_INT_EN_REG     0x7</span>
<span class="cp">#define STG_LOW_INT_STA_REG    0x8</span>
<span class="cp">#define STG_HIGH_INT_STA_REG   0x9</span>
<span class="cp">#define STG_COM_INT_STA_REG    0xA</span>

<span class="cp">#define CDC_RESULT_S0          0xB</span>
<span class="cp">#define CDC_RESULT_S1          0xC</span>
<span class="cp">#define CDC_RESULT_S2          0xD</span>
<span class="cp">#define CDC_RESULT_S3          0xE</span>
<span class="cp">#define CDC_RESULT_S4          0xF</span>
<span class="cp">#define CDC_RESULT_S5          0x10</span>
<span class="cp">#define CDC_RESULT_S6          0x11</span>
<span class="cp">#define CDC_RESULT_S7          0x12</span>
<span class="cp">#define CDC_RESULT_S8          0x13</span>
<span class="cp">#define CDC_RESULT_S9          0x14</span>
<span class="cp">#define CDC_RESULT_S10         0x15</span>
<span class="cp">#define CDC_RESULT_S11         0x16</span>

<span class="cp">#define STAGE0_AMBIENT		0xF1</span>
<span class="cp">#define STAGE1_AMBIENT		0x115</span>
<span class="cp">#define STAGE2_AMBIENT		0x139</span>
<span class="cp">#define STAGE3_AMBIENT		0x15D</span>
<span class="cp">#define STAGE4_AMBIENT		0x181</span>
<span class="cp">#define STAGE5_AMBIENT		0x1A5</span>
<span class="cp">#define STAGE6_AMBIENT		0x1C9</span>
<span class="cp">#define STAGE7_AMBIENT		0x1ED</span>
<span class="cp">#define STAGE8_AMBIENT		0x211</span>
<span class="cp">#define STAGE9_AMBIENT		0x234</span>
<span class="cp">#define STAGE10_AMBIENT		0x259</span>
<span class="cp">#define STAGE11_AMBIENT		0x27D</span>

<span class="cp">#define PER_STAGE_REG_NUM      36</span>
<span class="cp">#define STAGE_CFGREG_NUM       8</span>
<span class="cp">#define SYS_CFGREG_NUM         8</span>

<span class="cm">/*</span>
<span class="cm"> * driver information which will be used to maintain the software flow</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">ad714x_device_state</span> <span class="p">{</span> <span class="n">IDLE</span><span class="p">,</span> <span class="n">JITTER</span><span class="p">,</span> <span class="n">ACTIVE</span><span class="p">,</span> <span class="n">SPACE</span> <span class="p">};</span>

<span class="k">struct</span> <span class="n">ad714x_slider_drv</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">highest_stage</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">abs_pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flt_pos</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ad714x_device_state</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ad714x_wheel_drv</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">abs_pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flt_pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pre_highest_stage</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">highest_stage</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ad714x_device_state</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ad714x_touchpad_drv</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">x_highest_stage</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x_flt_pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x_abs_pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y_highest_stage</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y_flt_pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y_abs_pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left_ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left_ep_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">right_ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">right_ep_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">top_ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">top_ep_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bottom_ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bottom_ep_val</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ad714x_device_state</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ad714x_button_drv</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">ad714x_device_state</span> <span class="n">state</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Unlike slider/wheel/touchpad, all buttons point to</span>
<span class="cm">	 * same input_dev instance</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ad714x_driver_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_slider_drv</span> <span class="o">*</span><span class="n">slider</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ad714x_wheel_drv</span> <span class="o">*</span><span class="n">wheel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ad714x_touchpad_drv</span> <span class="o">*</span><span class="n">touchpad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ad714x_button_drv</span> <span class="o">*</span><span class="n">button</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * information to integrate all things which will be private data</span>
<span class="cm"> * of spi/i2c device</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_use_com_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">start_stage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end_stage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">end_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">start_stage</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">STG_COM_INT_EN_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">end_stage</span><span class="p">;</span>
	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">STG_COM_INT_EN_REG</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">STG_HIGH_INT_EN_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">STG_HIGH_INT_EN_REG</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_use_thr_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">start_stage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end_stage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">end_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">start_stage</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">STG_COM_INT_EN_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">end_stage</span><span class="p">);</span>
	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">STG_COM_INT_EN_REG</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">STG_HIGH_INT_EN_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">STG_HIGH_INT_EN_REG</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad714x_cal_highest_stage</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">start_stage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end_stage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start_stage</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">end_stage</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_res</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">max_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">max_idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad714x_cal_abs_pos</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">start_stage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end_stage</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">highest_stage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_coord</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">a_param</span><span class="p">,</span> <span class="n">b_param</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">highest_stage</span> <span class="o">==</span> <span class="n">start_stage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a_param</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">start_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">b_param</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">start_stage</span><span class="p">]</span> <span class="o">+</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">start_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">highest_stage</span> <span class="o">==</span> <span class="n">end_stage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a_param</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">end_stage</span><span class="p">]</span> <span class="o">*</span>
			<span class="p">(</span><span class="n">end_stage</span> <span class="o">-</span> <span class="n">start_stage</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">end_stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span>
			<span class="p">(</span><span class="n">end_stage</span> <span class="o">-</span> <span class="n">start_stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b_param</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">end_stage</span><span class="p">]</span> <span class="o">+</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">end_stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">a_param</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">highest_stage</span><span class="p">]</span> <span class="o">*</span>
			<span class="p">(</span><span class="n">highest_stage</span> <span class="o">-</span> <span class="n">start_stage</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">highest_stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span>
			<span class="p">(</span><span class="n">highest_stage</span> <span class="o">-</span> <span class="n">start_stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">highest_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span>
			<span class="p">(</span><span class="n">highest_stage</span> <span class="o">-</span> <span class="n">start_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b_param</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">highest_stage</span><span class="p">]</span> <span class="o">+</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">highest_stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">highest_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">max_coord</span> <span class="o">/</span> <span class="p">(</span><span class="n">end_stage</span> <span class="o">-</span> <span class="n">start_stage</span><span class="p">))</span> <span class="o">*</span> <span class="n">a_param</span> <span class="o">/</span> <span class="n">b_param</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * One button can connect to multi positive and negative of CDCs</span>
<span class="cm"> * Multi-buttons can connect to same positive/negative of one CDC</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_button_state_machine</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_button_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">button</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ad714x_button_drv</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">button</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IDLE</span>:
		<span class="k">if</span> <span class="p">(((</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">h_state</span> <span class="o">&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">h_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">h_mask</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">l_state</span> <span class="o">&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">l_mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">l_mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;button %d touched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ACTIVE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTIVE</span>:
		<span class="k">if</span> <span class="p">(((</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">h_state</span> <span class="o">&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">h_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">h_mask</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">l_state</span> <span class="o">&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">l_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">l_mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;button %d released</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The response of a sensor is defined by the absolute number of codes</span>
<span class="cm"> * between the current CDC value and the ambient value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_slider_cal_sensor_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_slider_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">slider</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">CDC_RESULT_S0</span> <span class="o">+</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">adc_reg</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">],</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span> <span class="o">-</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">STAGE0_AMBIENT</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">PER_STAGE_REG_NUM</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">amb_reg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">abs</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">adc_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">amb_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_slider_cal_highest_stage</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_slider_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">slider</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ad714x_slider_drv</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">slider</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">highest_stage</span> <span class="o">=</span> <span class="n">ad714x_cal_highest_stage</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">,</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;slider %d highest_stage:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">highest_stage</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The formulae are very straight forward. It uses the sensor with the</span>
<span class="cm"> * highest response and the 2 adjacent ones.</span>
<span class="cm"> * When Sensor 0 has the highest response, only sensor 0 and sensor 1</span>
<span class="cm"> * are used in the calculations. Similarly when the last sensor has the</span>
<span class="cm"> * highest response, only the last sensor and the second last sensors</span>
<span class="cm"> * are used in the calculations.</span>
<span class="cm"> *</span>
<span class="cm"> * For i= idx_of_peak_Sensor-1 to i= idx_of_peak_Sensor+1</span>
<span class="cm"> *         v += Sensor response(i)*i</span>
<span class="cm"> *         w += Sensor response(i)</span>
<span class="cm"> * POS=(Number_of_Positions_Wanted/(Number_of_Sensors_Used-1)) *(v/w)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_slider_cal_abs_pos</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_slider_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">slider</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ad714x_slider_drv</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">slider</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">abs_pos</span> <span class="o">=</span> <span class="n">ad714x_cal_abs_pos</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span><span class="p">,</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">highest_stage</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_coord</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;slider %d absolute position:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">abs_pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * To minimise the Impact of the noise on the algorithm, ADI developed a</span>
<span class="cm"> * routine that filters the CDC results after they have been read by the</span>
<span class="cm"> * host processor.</span>
<span class="cm"> * The filter used is an Infinite Input Response(IIR) filter implemented</span>
<span class="cm"> * in firmware and attenuates the noise on the CDC results after they&#39;ve</span>
<span class="cm"> * been read by the host processor.</span>
<span class="cm"> * Filtered_CDC_result = (Filtered_CDC_result * (10 - Coefficient) +</span>
<span class="cm"> *				Latest_CDC_result * Coefficient)/10</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_slider_cal_flt_pos</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_slider_drv</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">slider</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">flt_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">flt_pos</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">abs_pos</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;slider %d filter position:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">flt_pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_slider_use_com_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_slider_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">slider</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">ad714x_use_com_int</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_slider_use_thr_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_slider_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">slider</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">ad714x_use_thr_int</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_slider_state_machine</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_slider_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">slider</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ad714x_slider_drv</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">slider</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">h_state</span><span class="p">,</span> <span class="n">c_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">h_state</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">h_state</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">c_state</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">c_state</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IDLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">h_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">JITTER</span><span class="p">;</span>
			<span class="cm">/* In End of Conversion interrupt mode, the AD714X</span>
<span class="cm">			 * continuously generates hardware interrupts.</span>
<span class="cm">			 */</span>
			<span class="n">ad714x_slider_use_com_int</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;slider %d touched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">JITTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c_state</span> <span class="o">==</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ad714x_slider_cal_sensor_val</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">ad714x_slider_cal_highest_stage</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">ad714x_slider_cal_abs_pos</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">flt_pos</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">abs_pos</span><span class="p">;</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ACTIVE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTIVE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c_state</span> <span class="o">==</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">h_state</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ad714x_slider_cal_sensor_val</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="n">ad714x_slider_cal_highest_stage</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="n">ad714x_slider_cal_abs_pos</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="n">ad714x_slider_cal_flt_pos</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="n">input_report_abs</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">flt_pos</span><span class="p">);</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* When the user lifts off the sensor, configure</span>
<span class="cm">				 * the AD714X back to threshold interrupt mode.</span>
<span class="cm">				 */</span>
				<span class="n">ad714x_slider_use_thr_int</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="n">sw</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;slider %d released</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">idx</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When the scroll wheel is activated, we compute the absolute position based</span>
<span class="cm"> * on the sensor values. To calculate the position, we first determine the</span>
<span class="cm"> * sensor that has the greatest response among the 8 sensors that constitutes</span>
<span class="cm"> * the scrollwheel. Then we determined the 2 sensors on either sides of the</span>
<span class="cm"> * sensor with the highest response and we apply weights to these sensors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_wheel_cal_highest_stage</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_wheel_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wheel</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ad714x_wheel_drv</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">wheel</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">pre_highest_stage</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">highest_stage</span><span class="p">;</span>
	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">highest_stage</span> <span class="o">=</span> <span class="n">ad714x_cal_highest_stage</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">,</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wheel %d highest_stage:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">highest_stage</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_wheel_cal_sensor_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_wheel_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wheel</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">CDC_RESULT_S0</span> <span class="o">+</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">adc_reg</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">],</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span> <span class="o">-</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">STAGE0_AMBIENT</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">PER_STAGE_REG_NUM</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">amb_reg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">adc_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">amb_reg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">adc_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">amb_reg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When the scroll wheel is activated, we compute the absolute position based</span>
<span class="cm"> * on the sensor values. To calculate the position, we first determine the</span>
<span class="cm"> * sensor that has the greatest response among the sensors that constitutes</span>
<span class="cm"> * the scrollwheel. Then we determined the sensors on either sides of the</span>
<span class="cm"> * sensor with the highest response and we apply weights to these sensors. The</span>
<span class="cm"> * result of this computation gives us the mean value.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_wheel_cal_abs_pos</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_wheel_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wheel</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ad714x_wheel_drv</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">wheel</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">stage_num</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span> <span class="o">-</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first_before</span><span class="p">,</span> <span class="n">highest</span><span class="p">,</span> <span class="n">first_after</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">a_param</span><span class="p">,</span> <span class="n">b_param</span><span class="p">;</span>

	<span class="n">first_before</span> <span class="o">=</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">highest_stage</span> <span class="o">+</span> <span class="n">stage_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">stage_num</span><span class="p">;</span>
	<span class="n">highest</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">highest_stage</span><span class="p">;</span>
	<span class="n">first_after</span> <span class="o">=</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">highest_stage</span> <span class="o">+</span> <span class="n">stage_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">stage_num</span><span class="p">;</span>

	<span class="n">a_param</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">highest</span><span class="p">]</span> <span class="o">*</span>
		<span class="p">(</span><span class="n">highest</span> <span class="o">-</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">first_before</span><span class="p">]</span> <span class="o">*</span>
		<span class="p">(</span><span class="n">highest</span> <span class="o">-</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">first_after</span><span class="p">]</span> <span class="o">*</span>
		<span class="p">(</span><span class="n">highest</span> <span class="o">-</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">b_param</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">highest</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">first_before</span><span class="p">]</span> <span class="o">+</span>
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">first_after</span><span class="p">];</span>

	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">abs_pos</span> <span class="o">=</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_coord</span> <span class="o">/</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span> <span class="o">-</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">))</span> <span class="o">*</span>
			<span class="n">a_param</span><span class="p">)</span> <span class="o">/</span> <span class="n">b_param</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">abs_pos</span> <span class="o">&gt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_coord</span><span class="p">)</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">abs_pos</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_coord</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">abs_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">abs_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_wheel_cal_flt_pos</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_wheel_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wheel</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ad714x_wheel_drv</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">wheel</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">pre_highest_stage</span> <span class="o">==</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">highest_stage</span> <span class="o">==</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">pre_highest_stage</span> <span class="o">==</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">highest_stage</span> <span class="o">==</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span><span class="p">)))</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">flt_pos</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">abs_pos</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">flt_pos</span> <span class="o">=</span> <span class="p">((</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">flt_pos</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">abs_pos</span> <span class="o">*</span> <span class="mi">71</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">flt_pos</span> <span class="o">&gt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_coord</span><span class="p">)</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">flt_pos</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_coord</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_wheel_use_com_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_wheel_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wheel</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">ad714x_use_com_int</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_wheel_use_thr_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_wheel_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wheel</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">ad714x_use_thr_int</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_wheel_state_machine</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_wheel_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wheel</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ad714x_wheel_drv</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">wheel</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">h_state</span><span class="p">,</span> <span class="n">c_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">end_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">start_stage</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">h_state</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">h_state</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">c_state</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">c_state</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IDLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">h_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">JITTER</span><span class="p">;</span>
			<span class="cm">/* In End of Conversion interrupt mode, the AD714X</span>
<span class="cm">			 * continuously generates hardware interrupts.</span>
<span class="cm">			 */</span>
			<span class="n">ad714x_wheel_use_com_int</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wheel %d touched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">JITTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c_state</span> <span class="o">==</span> <span class="n">mask</span><span class="p">)</span>	<span class="p">{</span>
			<span class="n">ad714x_wheel_cal_sensor_val</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">ad714x_wheel_cal_highest_stage</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">ad714x_wheel_cal_abs_pos</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">flt_pos</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">abs_pos</span><span class="p">;</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ACTIVE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTIVE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c_state</span> <span class="o">==</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">h_state</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ad714x_wheel_cal_sensor_val</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="n">ad714x_wheel_cal_highest_stage</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="n">ad714x_wheel_cal_abs_pos</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="n">ad714x_wheel_cal_flt_pos</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="n">input_report_abs</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_WHEEL</span><span class="p">,</span>
					<span class="n">sw</span><span class="o">-&gt;</span><span class="n">flt_pos</span><span class="p">);</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* When the user lifts off the sensor, configure</span>
<span class="cm">				 * the AD714X back to threshold interrupt mode.</span>
<span class="cm">				 */</span>
				<span class="n">ad714x_wheel_use_thr_int</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="n">sw</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wheel %d released</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">idx</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">touchpad_cal_sensor_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_touchpad_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">touchpad</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">CDC_RESULT_S0</span> <span class="o">+</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_start_stage</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">adc_reg</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_start_stage</span><span class="p">],</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_end_stage</span> <span class="o">-</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_start_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_start_stage</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_end_stage</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">STAGE0_AMBIENT</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">PER_STAGE_REG_NUM</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">amb_reg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">adc_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">amb_reg</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">adc_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">amb_reg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">touchpad_cal_highest_stage</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_touchpad_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">touchpad</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ad714x_touchpad_drv</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">touchpad</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">x_highest_stage</span> <span class="o">=</span> <span class="n">ad714x_cal_highest_stage</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_start_stage</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_end_stage</span><span class="p">);</span>
	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">y_highest_stage</span> <span class="o">=</span> <span class="n">ad714x_cal_highest_stage</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_start_stage</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_end_stage</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;touchpad %d x_highest_stage:%d, y_highest_stage:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">idx</span><span class="p">,</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">x_highest_stage</span><span class="p">,</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">y_highest_stage</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If 2 fingers are touching the sensor then 2 peaks can be observed in the</span>
<span class="cm"> * distribution.</span>
<span class="cm"> * The arithmetic doesn&#39;t support to get absolute coordinates for multi-touch</span>
<span class="cm"> * yet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">touchpad_check_second_peak</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_touchpad_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">touchpad</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ad714x_touchpad_drv</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">touchpad</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_start_stage</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">x_highest_stage</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
			<span class="o">&gt;</span> <span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">x_highest_stage</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_end_stage</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="o">&gt;</span> <span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_start_stage</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">y_highest_stage</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
			<span class="o">&gt;</span> <span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">y_highest_stage</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_end_stage</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="o">&gt;</span> <span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If only one finger is used to activate the touch pad then only 1 peak will be</span>
<span class="cm"> * registered in the distribution. This peak and the 2 adjacent sensors will be</span>
<span class="cm"> * used in the calculation of the absolute position. This will prevent hand</span>
<span class="cm"> * shadows to affect the absolute position calculation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">touchpad_cal_abs_pos</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_touchpad_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">touchpad</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ad714x_touchpad_drv</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">touchpad</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">x_abs_pos</span> <span class="o">=</span> <span class="n">ad714x_cal_abs_pos</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_start_stage</span><span class="p">,</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_end_stage</span><span class="p">,</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">x_highest_stage</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_max_coord</span><span class="p">);</span>
	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">y_abs_pos</span> <span class="o">=</span> <span class="n">ad714x_cal_abs_pos</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_start_stage</span><span class="p">,</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_end_stage</span><span class="p">,</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">y_highest_stage</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_max_coord</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;touchpad %d absolute position:(%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">x_abs_pos</span><span class="p">,</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">y_abs_pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">touchpad_cal_flt_pos</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_touchpad_drv</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">touchpad</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">x_flt_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">x_flt_pos</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">x_abs_pos</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
	<span class="n">sw</span><span class="o">-&gt;</span><span class="n">y_flt_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">y_flt_pos</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">y_abs_pos</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;touchpad %d filter position:(%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">idx</span><span class="p">,</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">x_flt_pos</span><span class="p">,</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">y_flt_pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * To prevent distortion from showing in the absolute position, it is</span>
<span class="cm"> * necessary to detect the end points. When endpoints are detected, the</span>
<span class="cm"> * driver stops updating the status variables with absolute positions.</span>
<span class="cm"> * End points are detected on the 4 edges of the touchpad sensor. The</span>
<span class="cm"> * method to detect them is the same for all 4.</span>
<span class="cm"> * To detect the end points, the firmware computes the difference in</span>
<span class="cm"> * percent between the sensor on the edge and the adjacent one. The</span>
<span class="cm"> * difference is calculated in percent in order to make the end point</span>
<span class="cm"> * detection independent of the pressure.</span>
<span class="cm"> */</span>

<span class="cp">#define LEFT_END_POINT_DETECTION_LEVEL                  550</span>
<span class="cp">#define RIGHT_END_POINT_DETECTION_LEVEL                 750</span>
<span class="cp">#define LEFT_RIGHT_END_POINT_DEAVTIVALION_LEVEL         850</span>
<span class="cp">#define TOP_END_POINT_DETECTION_LEVEL                   550</span>
<span class="cp">#define BOTTOM_END_POINT_DETECTION_LEVEL                950</span>
<span class="cp">#define TOP_BOTTOM_END_POINT_DEAVTIVALION_LEVEL         700</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">touchpad_check_endpoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_touchpad_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">touchpad</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ad714x_touchpad_drv</span> <span class="o">*</span><span class="n">sw</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">touchpad</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">percent_sensor_diff</span><span class="p">;</span>

	<span class="cm">/* left endpoint detect */</span>
	<span class="n">percent_sensor_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_start_stage</span><span class="p">]</span> <span class="o">-</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_start_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_start_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">left_ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">percent_sensor_diff</span> <span class="o">&gt;=</span> <span class="n">LEFT_END_POINT_DETECTION_LEVEL</span><span class="p">)</span>  <span class="p">{</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">left_ep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">left_ep_val</span> <span class="o">=</span>
				<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_start_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">percent_sensor_diff</span> <span class="o">&lt;</span> <span class="n">LEFT_END_POINT_DETECTION_LEVEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_start_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span>
		     <span class="n">LEFT_RIGHT_END_POINT_DEAVTIVALION_LEVEL</span> <span class="o">+</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">left_ep_val</span><span class="p">))</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">left_ep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* right endpoint detect */</span>
	<span class="n">percent_sensor_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_end_stage</span><span class="p">]</span> <span class="o">-</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_end_stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_end_stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">right_ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">percent_sensor_diff</span> <span class="o">&gt;=</span> <span class="n">RIGHT_END_POINT_DETECTION_LEVEL</span><span class="p">)</span>  <span class="p">{</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">right_ep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">right_ep_val</span> <span class="o">=</span>
				<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_end_stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">percent_sensor_diff</span> <span class="o">&lt;</span> <span class="n">RIGHT_END_POINT_DETECTION_LEVEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_end_stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span>
		<span class="n">LEFT_RIGHT_END_POINT_DEAVTIVALION_LEVEL</span> <span class="o">+</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">right_ep_val</span><span class="p">))</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">right_ep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* top endpoint detect */</span>
	<span class="n">percent_sensor_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_start_stage</span><span class="p">]</span> <span class="o">-</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_start_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_start_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">top_ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">percent_sensor_diff</span> <span class="o">&gt;=</span> <span class="n">TOP_END_POINT_DETECTION_LEVEL</span><span class="p">)</span>  <span class="p">{</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">top_ep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">top_ep_val</span> <span class="o">=</span>
				<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_start_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">percent_sensor_diff</span> <span class="o">&lt;</span> <span class="n">TOP_END_POINT_DETECTION_LEVEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_start_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span>
		<span class="n">TOP_BOTTOM_END_POINT_DEAVTIVALION_LEVEL</span> <span class="o">+</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">top_ep_val</span><span class="p">))</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">top_ep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* bottom endpoint detect */</span>
	<span class="n">percent_sensor_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_end_stage</span><span class="p">]</span> <span class="o">-</span>
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_end_stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span>
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_end_stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">bottom_ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">percent_sensor_diff</span> <span class="o">&gt;=</span> <span class="n">BOTTOM_END_POINT_DETECTION_LEVEL</span><span class="p">)</span>  <span class="p">{</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">bottom_ep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">bottom_ep_val</span> <span class="o">=</span>
				<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_end_stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">percent_sensor_diff</span> <span class="o">&lt;</span> <span class="n">BOTTOM_END_POINT_DETECTION_LEVEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sensor_val</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_end_stage</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span>
		 <span class="n">TOP_BOTTOM_END_POINT_DEAVTIVALION_LEVEL</span> <span class="o">+</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">bottom_ep_val</span><span class="p">))</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">bottom_ep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">left_ep</span> <span class="o">||</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">right_ep</span> <span class="o">||</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">top_ep</span> <span class="o">||</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">bottom_ep</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">touchpad_use_com_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_touchpad_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">touchpad</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">ad714x_use_com_int</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_start_stage</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_end_stage</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">touchpad_use_thr_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_touchpad_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">touchpad</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">ad714x_use_thr_int</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_start_stage</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_end_stage</span><span class="p">);</span>
	<span class="n">ad714x_use_thr_int</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_start_stage</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_end_stage</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_touchpad_state_machine</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_touchpad_plat</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">touchpad</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ad714x_touchpad_drv</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">touchpad</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">h_state</span><span class="p">,</span> <span class="n">c_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_end_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
		<span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">x_start_stage</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
		<span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_end_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
		<span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">y_start_stage</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">h_state</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">h_state</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">c_state</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">c_state</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IDLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">h_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sw</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">JITTER</span><span class="p">;</span>
			<span class="cm">/* In End of Conversion interrupt mode, the AD714X</span>
<span class="cm">			 * continuously generates hardware interrupts.</span>
<span class="cm">			 */</span>
			<span class="n">touchpad_use_com_int</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;touchpad %d touched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">JITTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c_state</span> <span class="o">==</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">touchpad_cal_sensor_val</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">touchpad_cal_highest_stage</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">touchpad_check_second_peak</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="o">!</span><span class="n">touchpad_check_endpoint</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;touchpad%d, 2 fingers or endpoint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">idx</span><span class="p">);</span>
				<span class="n">touchpad_cal_abs_pos</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="n">sw</span><span class="o">-&gt;</span><span class="n">x_flt_pos</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">x_abs_pos</span><span class="p">;</span>
				<span class="n">sw</span><span class="o">-&gt;</span><span class="n">y_flt_pos</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">y_abs_pos</span><span class="p">;</span>
				<span class="n">sw</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ACTIVE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTIVE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c_state</span> <span class="o">==</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">h_state</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">touchpad_cal_sensor_val</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="n">touchpad_cal_highest_stage</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">touchpad_check_second_peak</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">))</span>
				  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">touchpad_check_endpoint</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">touchpad_cal_abs_pos</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
					<span class="n">touchpad_cal_flt_pos</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
					<span class="n">input_report_abs</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span>
						<span class="n">sw</span><span class="o">-&gt;</span><span class="n">x_flt_pos</span><span class="p">);</span>
					<span class="n">input_report_abs</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span>
						<span class="n">sw</span><span class="o">-&gt;</span><span class="n">y_flt_pos</span><span class="p">);</span>
					<span class="n">input_report_key</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span>
						<span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* When the user lifts off the sensor, configure</span>
<span class="cm">				 * the AD714X back to threshold interrupt mode.</span>
<span class="cm">				 */</span>
				<span class="n">touchpad_use_thr_int</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
				<span class="n">sw</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;touchpad %d released</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">idx</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad714x_hw_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">AD714X_PARTID_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xFFF0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AD7142_PARTID</span>:
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">=</span> <span class="mh">0x7142</span><span class="p">;</span>
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;found AD7142 captouch, rev:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AD7143_PARTID</span>:
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">=</span> <span class="mh">0x7143</span><span class="p">;</span>
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;found AD7143 captouch, rev:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AD7147_PARTID</span>:
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">=</span> <span class="mh">0x7147</span><span class="p">;</span>
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;found AD7147(A) captouch, rev:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AD7148_PARTID</span>:
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">=</span> <span class="mh">0x7148</span><span class="p">;</span>
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;found AD7148 captouch, rev:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;fail to detect AD714X captouch, read ID is %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad714x_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* configuration CDC and interrupts */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STAGE_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_base</span> <span class="o">=</span> <span class="n">AD714X_STAGECFG_REG</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">STAGE_CFGREG_NUM</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">STAGE_CFGREG_NUM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">reg_base</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span>
					<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">stage_cfg_reg</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SYS_CFGREG_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">AD714X_SYSCFG_REG</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">sys_cfg_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SYS_CFGREG_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">AD714X_SYSCFG_REG</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">AD714X_STG_CAL_EN_REG</span><span class="p">,</span> <span class="mh">0xFFF</span><span class="p">);</span>

	<span class="cm">/* clear all interrupts */</span>
	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">STG_LOW_INT_STA_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">l_state</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ad714x_interrupt_thread</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">STG_LOW_INT_STA_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">l_state</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">button_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ad714x_button_state_machine</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">slider_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ad714x_slider_state_machine</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wheel_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ad714x_wheel_state_machine</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">touchpad_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ad714x_touchpad_state_machine</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAX_DEVICE_NUM 8</span>
<span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="nf">ad714x_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">bus_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span>
				 <span class="n">ad714x_read_t</span> <span class="n">read</span><span class="p">,</span> <span class="n">ad714x_write_t</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">alloc_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">[</span><span class="n">MAX_DEVICE_NUM</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">ad714x_platform_data</span> <span class="o">*</span><span class="n">plat_data</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">drv_mem</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ad714x_button_drv</span> <span class="o">*</span><span class="n">bt_drv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ad714x_slider_drv</span> <span class="o">*</span><span class="n">sd_drv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ad714x_wheel_drv</span> <span class="o">*</span><span class="n">wl_drv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ad714x_touchpad_drv</span> <span class="o">*</span><span class="n">tp_drv</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ not configured!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform data for ad714x doesn&#39;t exist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ad714x</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ad714x</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="p">)</span> <span class="o">+</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sd_drv</span><span class="p">)</span> <span class="o">*</span> <span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">slider_num</span> <span class="o">+</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl_drv</span><span class="p">)</span> <span class="o">*</span> <span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">wheel_num</span> <span class="o">+</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tp_drv</span><span class="p">)</span> <span class="o">*</span> <span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">touchpad_num</span> <span class="o">+</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bt_drv</span><span class="p">)</span> <span class="o">*</span> <span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">button_num</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ad714x</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">plat_data</span><span class="p">;</span>

	<span class="n">drv_mem</span> <span class="o">=</span> <span class="n">ad714x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span> <span class="o">=</span> <span class="n">drv_mem</span><span class="p">;</span>
	<span class="n">drv_mem</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="p">);</span>
	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">slider</span> <span class="o">=</span> <span class="n">sd_drv</span> <span class="o">=</span> <span class="n">drv_mem</span><span class="p">;</span>
	<span class="n">drv_mem</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sd_drv</span><span class="p">)</span> <span class="o">*</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">slider_num</span><span class="p">;</span>
	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">wheel</span> <span class="o">=</span> <span class="n">wl_drv</span> <span class="o">=</span> <span class="n">drv_mem</span><span class="p">;</span>
	<span class="n">drv_mem</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl_drv</span><span class="p">)</span> <span class="o">*</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wheel_num</span><span class="p">;</span>
	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">touchpad</span> <span class="o">=</span> <span class="n">tp_drv</span> <span class="o">=</span> <span class="n">drv_mem</span><span class="p">;</span>
	<span class="n">drv_mem</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tp_drv</span><span class="p">)</span> <span class="o">*</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">touchpad_num</span><span class="p">;</span>
	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">button</span> <span class="o">=</span> <span class="n">bt_drv</span> <span class="o">=</span> <span class="n">drv_mem</span><span class="p">;</span>
	<span class="n">drv_mem</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bt_drv</span><span class="p">)</span> <span class="o">*</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">button_num</span><span class="p">;</span>

	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">read</span><span class="p">;</span>
	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">write</span><span class="p">;</span>
	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">ad714x_hw_detect</span><span class="p">(</span><span class="n">ad714x</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_mem</span><span class="p">;</span>

	<span class="cm">/* initialize and request sw/hw resources */</span>

	<span class="n">ad714x_hw_init</span><span class="p">(</span><span class="n">ad714x</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate and register AD714X input device</span>
<span class="cm">	 */</span>
	<span class="n">alloc_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* a slider uses one input_dev instance */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">slider_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ad714x_slider_plat</span> <span class="o">*</span><span class="n">sd_plat</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">slider</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">slider_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">,</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">,</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">ABS_X</span><span class="p">,</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">],</span>
				<span class="n">ABS_X</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sd_plat</span><span class="o">-&gt;</span><span class="n">max_coord</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">bus_type</span><span class="p">;</span>
			<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">;</span>
			<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
			<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ad714x_captouch_slider&quot;</span><span class="p">;</span>
			<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>

			<span class="n">alloc_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* a wheel uses one input_dev instance */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wheel_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ad714x_wheel_plat</span> <span class="o">*</span><span class="n">wl_plat</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wheel</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wheel_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl_drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">,</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">,</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">ABS_WHEEL</span><span class="p">,</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">],</span>
				<span class="n">ABS_WHEEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wl_plat</span><span class="o">-&gt;</span><span class="n">max_coord</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">bus_type</span><span class="p">;</span>
			<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">;</span>
			<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
			<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ad714x_captouch_wheel&quot;</span><span class="p">;</span>
			<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>

			<span class="n">alloc_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* a touchpad uses one input_dev instance */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">touchpad_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ad714x_touchpad_plat</span> <span class="o">*</span><span class="n">tp_plat</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">touchpad</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">touchpad_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tp_drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">,</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">,</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">ABS_X</span><span class="p">,</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">ABS_Y</span><span class="p">,</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">],</span>
				<span class="n">ABS_X</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tp_plat</span><span class="o">-&gt;</span><span class="n">x_max_coord</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">],</span>
				<span class="n">ABS_Y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tp_plat</span><span class="o">-&gt;</span><span class="n">y_max_coord</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">bus_type</span><span class="p">;</span>
			<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">;</span>
			<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
			<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ad714x_captouch_pad&quot;</span><span class="p">;</span>
			<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

			<span class="n">error</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>

			<span class="n">alloc_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* all buttons use one input node */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">button_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ad714x_button_plat</span> <span class="o">*</span><span class="n">bt_plat</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">button</span><span class="p">;</span>

		<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">,</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">button_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bt_drv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">];</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">bt_plat</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">keycode</span><span class="p">,</span> <span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">bus_type</span><span class="p">;</span>
		<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">;</span>
		<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
		<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ad714x_captouch_button&quot;</span><span class="p">;</span>
		<span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>

		<span class="n">alloc_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ad714x_interrupt_thread</span><span class="p">,</span>
				<span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">irqflags</span> <span class="o">?</span>
					<span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">irqflags</span> <span class="o">:</span> <span class="n">IRQF_TRIGGER_FALLING</span><span class="p">,</span>
				<span class="s">&quot;ad714x_captouch&quot;</span><span class="p">,</span> <span class="n">ad714x</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unreg_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ad714x</span><span class="p">;</span>

 <span class="nl">err_free_dev:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to setup AD714x input device %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">alloc_idx</span><span class="p">);</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]);</span>
 <span class="nl">err_unreg_dev:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">alloc_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">input</span><span class="p">[</span><span class="n">alloc_idx</span><span class="p">]);</span>
 <span class="nl">err_free_mem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ad714x</span><span class="p">);</span>
 <span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ad714x_probe</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ad714x_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ad714x_platform_data</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ad714x_driver_data</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">sw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ad714x</span><span class="p">);</span>

	<span class="cm">/* unregister and free all input devices */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">slider_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">slider</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">input</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wheel_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">wheel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">input</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">touchpad_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">touchpad</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">input</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">button_num</span><span class="p">)</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">button</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">input</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ad714x</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ad714x_remove</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="kt">int</span> <span class="nf">ad714x_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">sys_cfg_reg</span><span class="p">[</span><span class="n">AD714X_PWR_CTRL</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">AD714X_PWR_CTRL</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ad714x_disable</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ad714x_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ad714x_chip</span> <span class="o">*</span><span class="n">ad714x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* resume to non-shutdown mode */</span>

	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">AD714X_PWR_CTRL</span><span class="p">,</span>
			<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">sys_cfg_reg</span><span class="p">[</span><span class="n">AD714X_PWR_CTRL</span><span class="p">]);</span>

	<span class="cm">/* make sure the interrupt output line is not low level after resume,</span>
<span class="cm">	 * otherwise we will get no chance to enter falling-edge irq again</span>
<span class="cm">	 */</span>

	<span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ad714x</span><span class="p">,</span> <span class="n">STG_LOW_INT_STA_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">l_state</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ad714x</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ad714x_enable</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Analog Devices AD714X Capacitance Touch Sensor Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Barry Song &lt;21cnbao@gmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
