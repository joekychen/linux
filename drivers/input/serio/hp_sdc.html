<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › serio › hp_sdc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hp_sdc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * HP i8042-based System Device Controller driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2001 Brian S. Julin</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions, and the following disclaimer,</span>
<span class="cm"> *    without modification.</span>
<span class="cm"> * 2. The name of the author may not be used to endorse or promote products</span>
<span class="cm"> *    derived from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * Alternatively, this software may be distributed under the terms of the</span>
<span class="cm"> * GNU General Public License (&quot;GPL&quot;).</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&#39;&#39; AND</span>
<span class="cm"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR</span>
<span class="cm"> * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
<span class="cm"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="cm"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<span class="cm"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
<span class="cm"> *</span>
<span class="cm"> * References:</span>
<span class="cm"> * System Device Controller Microprocessor Firmware Theory of Operation</span>
<span class="cm"> *      for Part Number 1820-4784 Revision B.  Dwg No. A-1820-4784-2</span>
<span class="cm"> * Helge Deller&#39;s original hilkbd.c port for PA-RISC.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Driver theory of operation:</span>
<span class="cm"> *</span>
<span class="cm"> * hp_sdc_put does all writing to the SDC.  ISR can run on a different</span>
<span class="cm"> * CPU than hp_sdc_put, but only one CPU runs hp_sdc_put at a time</span>
<span class="cm"> * (it cannot really benefit from SMP anyway.)  A tasket fit this perfectly.</span>
<span class="cm"> *</span>
<span class="cm"> * All data coming back from the SDC is sent via interrupt and can be read</span>
<span class="cm"> * fully in the ISR, so there are no latency/throughput problems there.</span>
<span class="cm"> * The problem is with output, due to the slow clock speed of the SDC</span>
<span class="cm"> * compared to the CPU.  This should not be too horrible most of the time,</span>
<span class="cm"> * but if used with HIL devices that support the multibyte transfer command,</span>
<span class="cm"> * keeping outbound throughput flowing at the 6500KBps that the HIL is</span>
<span class="cm"> * capable of is more than can be done at HZ=100.</span>
<span class="cm"> *</span>
<span class="cm"> * Busy polling for IBF clear wastes CPU cycles and bus cycles.  hp_sdc.ibf</span>
<span class="cm"> * is set to 0 when the IBF flag in the status register has cleared.  ISR</span>
<span class="cm"> * may do this, and may also access the parts of queued transactions related</span>
<span class="cm"> * to reading data back from the SDC, but otherwise will not touch the</span>
<span class="cm"> * hp_sdc state. Whenever a register is written hp_sdc.ibf is set to 1.</span>
<span class="cm"> *</span>
<span class="cm"> * The i8042 write index and the values in the 4-byte input buffer</span>
<span class="cm"> * starting at 0x70 are kept track of in hp_sdc.wi, and .r7[], respectively,</span>
<span class="cm"> * to minimize the amount of IO needed to the SDC.  However these values</span>
<span class="cm"> * do not need to be locked since they are only ever accessed by hp_sdc_put.</span>
<span class="cm"> *</span>
<span class="cm"> * A timer task schedules the tasklet once per second just to make</span>
<span class="cm"> * sure it doesn&#39;t freeze up and to allow for bad reads to time out.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/hp_sdc.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/hil.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cm">/* Machine-specific abstraction */</span>

<span class="cp">#if defined(__hppa__)</span>
<span class="cp"># include &lt;asm/parisc-device.h&gt;</span>
<span class="cp"># define sdc_readb(p)		gsc_readb(p)</span>
<span class="cp"># define sdc_writeb(v,p)	gsc_writeb((v),(p))</span>
<span class="cp">#elif defined(__mc68000__)</span>
<span class="cp"># include &lt;asm/uaccess.h&gt;</span>
<span class="cp"># define sdc_readb(p)		in_8(p)</span>
<span class="cp"># define sdc_writeb(v,p)	out_8((p),(v))</span>
<span class="cp">#else</span>
<span class="cp"># error &quot;HIL is not supported on this platform&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#define PREFIX &quot;HP SDC: &quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Brian S. Julin &lt;bri@calyx.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;HP i8042-based SDC Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hp_sdc_request_timer_irq</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hp_sdc_request_hil_irq</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hp_sdc_request_cooked_irq</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hp_sdc_release_timer_irq</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hp_sdc_release_hil_irq</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hp_sdc_release_cooked_irq</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__hp_sdc_enqueue_transaction</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hp_sdc_enqueue_transaction</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hp_sdc_dequeue_transaction</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">hp_sdc_disabled</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">no_hpsdc</span><span class="p">,</span> <span class="n">hp_sdc_disabled</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">no_hpsdc</span><span class="p">,</span> <span class="s">&quot;Do not enable HP SDC driver.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">hp_i8042_sdc</span>	<span class="n">hp_sdc</span><span class="p">;</span>	<span class="cm">/* All driver state is kept in here. */</span>

<span class="cm">/*************** primitives for use in any context *********************/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint8_t</span> <span class="nf">hp_sdc_status_in8</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">sdc_readb</span><span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">status_io</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HP_SDC_STATUS_IBF</span><span class="p">))</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">uint8_t</span> <span class="nf">hp_sdc_data_in8</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sdc_readb</span><span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">data_io</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hp_sdc_status_out8</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xe0</span><span class="p">)</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">wi</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">sdc_writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">status_io</span><span class="p">);</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hp_sdc_data_out8</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sdc_writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">data_io</span><span class="p">);</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*	Care must be taken to only invoke hp_sdc_spin_ibf when</span>
<span class="cm"> *	absolutely needed, or in rarely invoked subroutines.</span>
<span class="cm"> *	Not only does it waste CPU cycles, it also wastes bus cycles.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hp_sdc_spin_ibf</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">rwlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">;</span>

	<span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf_lock</span><span class="p">;</span>

	<span class="n">read_lock_irqsave</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_unlock_irqrestore</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">write_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sdc_readb</span><span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">status_io</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HP_SDC_STATUS_IBF</span><span class="p">)</span>
		<span class="p">{</span> <span class="p">}</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/************************ Interrupt context functions ************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp_sdc_take</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">status</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hp_sdc_transaction</span> <span class="o">*</span><span class="n">curr</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rcurr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">curr</span> <span class="o">=</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">tq</span><span class="p">[</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rcurr</span><span class="p">];</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>

	<span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">rqty</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rqty</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* All data has been gathered. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">actidx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_SEMAPHORE</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">act</span><span class="p">.</span><span class="n">semaphore</span><span class="p">)</span>
				<span class="n">up</span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">act</span><span class="p">.</span><span class="n">semaphore</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">actidx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_CALLBACK</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">act</span><span class="p">.</span><span class="n">irqhook</span><span class="p">)</span>
				<span class="n">curr</span><span class="o">-&gt;</span><span class="n">act</span><span class="p">.</span><span class="n">irqhook</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

		<span class="n">curr</span><span class="o">-&gt;</span><span class="n">actidx</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
		<span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* Return control of this transaction */</span>
		<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">rcurr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">rqty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">task</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">hp_sdc_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">status</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">hp_sdc_status_in8</span><span class="p">();</span>
	<span class="cm">/* Read data unconditionally to advance i8042. */</span>
	<span class="n">data</span> <span class="o">=</span>   <span class="n">hp_sdc_data_in8</span><span class="p">();</span>

	<span class="cm">/* For now we are ignoring these until we get the SDC to behave. */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xf1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x51</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">data</span> <span class="o">==</span> <span class="mh">0x82</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HP_SDC_STATUS_IRQMASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* This case is not documented. */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HP_SDC_STATUS_USERTIMER</span>:
	<span class="k">case</span> <span class="n">HP_SDC_STATUS_PERIODIC</span>:
	<span class="k">case</span> <span class="n">HP_SDC_STATUS_TIMER</span>:
		<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">timer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">hp_sdc</span><span class="p">.</span><span class="n">timer</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HP_SDC_STATUS_REG</span>:
		<span class="n">hp_sdc_take</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HP_SDC_STATUS_HILCMD</span>:
	<span class="k">case</span> <span class="n">HP_SDC_STATUS_HILDATA</span>:
		<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hil</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">hp_sdc</span><span class="p">.</span><span class="n">hil</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HP_SDC_STATUS_PUP</span>:
		<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">pup</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">hp_sdc</span><span class="p">.</span><span class="n">pup</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PREFIX</span> <span class="s">&quot;HP SDC reports successful PUP.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">cooked</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">hp_sdc</span><span class="p">.</span><span class="n">cooked</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">hp_sdc_nmisr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">hp_sdc_status_in8</span><span class="p">();</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;NMI !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (status &amp; HP_SDC_NMISTATUS_FHS) {</span>
<span class="c">		read_lock(&amp;hp_sdc.hook_lock);</span>
<span class="c">		if (hp_sdc.timer != NULL)</span>
<span class="c">			hp_sdc.timer(irq, dev_id, status, 0);</span>
<span class="c">		read_unlock(&amp;hp_sdc.hook_lock);</span>
<span class="c">	} else {</span>
<span class="c">		/* TODO: pass this on to the HIL handler, or do SAK here? */</span>
<span class="c">		printk(KERN_WARNING PREFIX &quot;HIL NMI\n&quot;);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/***************** Kernel (tasklet) context functions ****************/</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hp_sdc_put</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp_sdc_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">foo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rcurr</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>

		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">&gt;</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span>
			<span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">+=</span> <span class="n">USEC_PER_SEC</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">&gt;</span> <span class="n">HP_SDC_MAX_REG_DELAY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hp_sdc_transaction</span> <span class="o">*</span><span class="n">curr</span><span class="p">;</span>
			<span class="kt">uint8_t</span> <span class="n">tmp</span><span class="p">;</span>

			<span class="n">curr</span> <span class="o">=</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">tq</span><span class="p">[</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rcurr</span><span class="p">];</span>
			<span class="cm">/* If this turns out to be a normal failure mode</span>
<span class="cm">			 * we&#39;ll need to figure out a way to communicate</span>
<span class="cm">			 * it back to the application. and be less verbose.</span>
<span class="cm">			 */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;read timeout (%ius)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtv</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">));</span>
			<span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+=</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">rqty</span><span class="p">;</span>
			<span class="n">hp_sdc</span><span class="p">.</span><span class="n">rqty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">actidx</span><span class="p">];</span>
			<span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">actidx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HP_SDC_ACT_DEAD</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_SEMAPHORE</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">act</span><span class="p">.</span><span class="n">semaphore</span><span class="p">)</span>
					<span class="n">up</span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">act</span><span class="p">.</span><span class="n">semaphore</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_CALLBACK</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Note this means that irqhooks may be called</span>
<span class="cm">				 * in tasklet/bh context.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">act</span><span class="p">.</span><span class="n">irqhook</span><span class="p">)</span>
					<span class="n">curr</span><span class="o">-&gt;</span><span class="n">act</span><span class="p">.</span><span class="n">irqhook</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">curr</span><span class="o">-&gt;</span><span class="n">actidx</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
			<span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
			<span class="n">hp_sdc</span><span class="p">.</span><span class="n">rcurr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>
	<span class="n">hp_sdc_put</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">hp_sdc_put</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hp_sdc_transaction</span> <span class="o">*</span><span class="n">curr</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">act</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">curridx</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* If i8042 buffers are full, we cannot do anything that</span>
<span class="cm">	   requires output, so we skip to the administrativa. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp_sdc_status_in8</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">anew:</span>
	<span class="cm">/* See if we are in the middle of a sequence. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">read_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rcurr</span> <span class="o">==</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span><span class="p">)</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">read_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span> <span class="o">&gt;=</span> <span class="n">HP_SDC_QUEUE_LEN</span><span class="p">)</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">curridx</span> <span class="o">=</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">tq</span><span class="p">[</span><span class="n">curridx</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">curridx</span> <span class="o">!=</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curridx</span> <span class="o">&gt;=</span> <span class="n">HP_SDC_QUEUE_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">curridx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* Wrap to top */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">read_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rcurr</span> <span class="o">==</span> <span class="n">curridx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">read_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">read_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">tq</span><span class="p">[</span><span class="n">curridx</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* Found one. */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">curridx</span> <span class="o">==</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* There&#39;s nothing queued to do. */</span>
		<span class="n">curridx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span> <span class="o">=</span> <span class="n">curridx</span><span class="p">;</span>

 <span class="nl">start:</span>

	<span class="cm">/* Check to see if the interrupt mask needs to be set. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">set_im</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp_sdc_status_out8</span><span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">im</span> <span class="o">|</span> <span class="n">HP_SDC_CMD_SET_IM</span><span class="p">);</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">set_im</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">curr</span> <span class="o">=</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">tq</span><span class="p">[</span><span class="n">curridx</span><span class="p">];</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">actidx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">actidx</span> <span class="o">&gt;=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">endidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">tq</span><span class="p">[</span><span class="n">curridx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/* Interleave outbound data between the transactions. */</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span> <span class="o">&gt;=</span> <span class="n">HP_SDC_QUEUE_LEN</span><span class="p">)</span>
			<span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">act</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">idx</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">endidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_DEALLOC</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">curr</span><span class="p">);</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">tq</span><span class="p">[</span><span class="n">curridx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/* Interleave outbound data between the transactions. */</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span> <span class="o">&gt;=</span> <span class="n">HP_SDC_QUEUE_LEN</span><span class="p">)</span>
			<span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_PRECMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
			<span class="n">act</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HP_SDC_ACT_PRECMD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hp_sdc_status_out8</span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* act finished? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">act</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_DURING</span><span class="p">)</span> <span class="o">==</span> <span class="n">HP_SDC_ACT_PRECMD</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">actdone</span><span class="p">;</span>
		<span class="cm">/* skip quantity field if data-out sequence follows. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_DATAOUT</span><span class="p">)</span>
			<span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_DATAOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">qty</span><span class="p">;</span>

		<span class="n">qty</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">qty</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hp_sdc_data_out8</span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">]);</span>
			<span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* act finished? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">qty</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_DURING</span><span class="p">)</span> <span class="o">==</span> <span class="n">HP_SDC_ACT_DATAOUT</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">actdone</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">idx</span> <span class="o">+=</span> <span class="n">qty</span><span class="p">;</span>
		<span class="n">act</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HP_SDC_ACT_DATAOUT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
	    <span class="k">while</span> <span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_DATAREG</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
		<span class="kt">uint8_t</span> <span class="n">w7</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

		<span class="n">mask</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
			<span class="n">idx</span> <span class="o">+=</span> <span class="o">!!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">idx</span> <span class="o">+=</span> <span class="o">!!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">idx</span> <span class="o">+=</span> <span class="o">!!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">idx</span> <span class="o">+=</span> <span class="o">!!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">act</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HP_SDC_ACT_DATAREG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">w7</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="o">++</span><span class="n">idx</span><span class="p">]</span> <span class="o">:</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">r7</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">w7</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="o">++</span><span class="n">idx</span><span class="p">]</span> <span class="o">:</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">r7</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">w7</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="o">++</span><span class="n">idx</span><span class="p">]</span> <span class="o">:</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">r7</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">w7</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="o">++</span><span class="n">idx</span><span class="p">]</span> <span class="o">:</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">r7</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">wi</span> <span class="o">&gt;</span> <span class="mh">0x73</span> <span class="o">||</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">wi</span> <span class="o">&lt;</span> <span class="mh">0x70</span> <span class="o">||</span>
		    <span class="n">w7</span><span class="p">[</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">wi</span> <span class="o">-</span> <span class="mh">0x70</span><span class="p">]</span> <span class="o">==</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">r7</span><span class="p">[</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">wi</span> <span class="o">-</span> <span class="mh">0x70</span><span class="p">])</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* Need to point the write index register */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">w7</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">r7</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hp_sdc_status_out8</span><span class="p">(</span><span class="n">HP_SDC_CMD_SET_D0</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">hp_sdc</span><span class="p">.</span><span class="n">wi</span> <span class="o">=</span> <span class="mh">0x70</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">act</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_DURING</span><span class="p">)</span> <span class="o">==</span> <span class="n">HP_SDC_ACT_DATAREG</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">actdone</span><span class="p">;</span>

			<span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
			<span class="n">act</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HP_SDC_ACT_DATAREG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hp_sdc_data_out8</span><span class="p">(</span><span class="n">w7</span><span class="p">[</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">wi</span> <span class="o">-</span> <span class="mh">0x70</span><span class="p">]);</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">r7</span><span class="p">[</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">wi</span> <span class="o">-</span> <span class="mh">0x70</span><span class="p">]</span> <span class="o">=</span> <span class="n">w7</span><span class="p">[</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">wi</span> <span class="o">-</span> <span class="mh">0x70</span><span class="p">];</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">wi</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* write index register autoincrements */</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">w7</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">r7</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">act</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_DURING</span><span class="p">)</span> <span class="o">==</span>
				    <span class="n">HP_SDC_ACT_DATAREG</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">actdone</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* We don&#39;t go any further in the command if there is a pending read,</span>
<span class="cm">	   because we don&#39;t want interleaved results. */</span>
	<span class="n">read_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rcurr</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_POSTCMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="n">postcmd</span><span class="p">;</span>

		<span class="cm">/* curr-&gt;idx should == idx at this point. */</span>
		<span class="n">postcmd</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_DATAIN</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* Start a new read */</span>
			<span class="n">hp_sdc</span><span class="p">.</span><span class="n">rqty</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">[</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
			<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtv</span><span class="p">);</span>
			<span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* Still need to lock here in case of spurious irq. */</span>
			<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>
			<span class="n">hp_sdc</span><span class="p">.</span><span class="n">rcurr</span> <span class="o">=</span> <span class="n">curridx</span><span class="p">;</span>
			<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>
			<span class="n">hp_sdc_status_out8</span><span class="p">(</span><span class="n">postcmd</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hp_sdc_status_out8</span><span class="p">(</span><span class="n">postcmd</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">actdone</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">actdone:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_SEMAPHORE</span><span class="p">)</span>
		<span class="n">up</span><span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">act</span><span class="p">.</span><span class="n">semaphore</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_CALLBACK</span><span class="p">)</span>
		<span class="n">curr</span><span class="o">-&gt;</span><span class="n">act</span><span class="p">.</span><span class="n">irqhook</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">endidx</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* This transaction is over. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">act</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_DEALLOC</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">curr</span><span class="p">);</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">tq</span><span class="p">[</span><span class="n">curridx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">curr</span><span class="o">-&gt;</span><span class="n">actidx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">curr</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Interleave outbound data between the transactions. */</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span> <span class="o">&gt;=</span> <span class="n">HP_SDC_QUEUE_LEN</span><span class="p">)</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">finish:</span>
	<span class="cm">/* If by some quirk IBF has cleared and our ISR has run to</span>
<span class="cm">	   see that that has happened, do it all again. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf</span> <span class="o">&amp;&amp;</span> <span class="n">limit</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">anew</span><span class="p">;</span>

 <span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">task</span><span class="p">);</span>
	<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******* Functions called in either user or kernel context ****/</span>
<span class="kt">int</span> <span class="nf">__hp_sdc_enqueue_transaction</span><span class="p">(</span><span class="n">hp_sdc_transaction</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Can&#39;t have same transaction on queue twice */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HP_SDC_QUEUE_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">tq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">this</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">actidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Search for empty slot */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HP_SDC_QUEUE_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">tq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hp_sdc</span><span class="p">.</span><span class="n">tq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">this</span><span class="p">;</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">task</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;No free slot to add transaction.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;Transaction add failed: transaction already queued?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hp_sdc_enqueue_transaction</span><span class="p">(</span><span class="n">hp_sdc_transaction</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__hp_sdc_enqueue_transaction</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hp_sdc_dequeue_transaction</span><span class="p">(</span><span class="n">hp_sdc_transaction</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* TODO: don&#39;t remove it if it&#39;s not done. */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HP_SDC_QUEUE_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">tq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">this</span><span class="p">)</span>
			<span class="n">hp_sdc</span><span class="p">.</span><span class="n">tq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/********************** User context functions **************************/</span>
<span class="kt">int</span> <span class="nf">hp_sdc_request_timer_irq</span><span class="p">(</span><span class="n">hp_sdc_irqhook</span> <span class="o">*</span><span class="n">callback</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">callback</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">timer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>
	<span class="cm">/* Enable interrupts from the timers */</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">im</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HP_SDC_IM_FH</span><span class="p">;</span>
        <span class="n">hp_sdc</span><span class="p">.</span><span class="n">im</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HP_SDC_IM_PT</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">im</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HP_SDC_IM_TIMERS</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">set_im</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">task</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hp_sdc_request_hil_irq</span><span class="p">(</span><span class="n">hp_sdc_irqhook</span> <span class="o">*</span><span class="n">callback</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">callback</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hil</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">hil</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">im</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HP_SDC_IM_HIL</span> <span class="o">|</span> <span class="n">HP_SDC_IM_RESET</span><span class="p">);</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">set_im</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">task</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hp_sdc_request_cooked_irq</span><span class="p">(</span><span class="n">hp_sdc_irqhook</span> <span class="o">*</span><span class="n">callback</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">callback</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">cooked</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable interrupts from the HIL MLC */</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">cooked</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">im</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HP_SDC_IM_HIL</span> <span class="o">|</span> <span class="n">HP_SDC_IM_RESET</span><span class="p">);</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">set_im</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">task</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hp_sdc_release_timer_irq</span><span class="p">(</span><span class="n">hp_sdc_irqhook</span> <span class="o">*</span><span class="n">callback</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">callback</span> <span class="o">!=</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">timer</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">timer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable interrupts from the timers */</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">timer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">im</span> <span class="o">|=</span> <span class="n">HP_SDC_IM_TIMERS</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">im</span> <span class="o">|=</span> <span class="n">HP_SDC_IM_FH</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">im</span> <span class="o">|=</span> <span class="n">HP_SDC_IM_PT</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">set_im</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">task</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hp_sdc_release_hil_irq</span><span class="p">(</span><span class="n">hp_sdc_irqhook</span> <span class="o">*</span><span class="n">callback</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">callback</span> <span class="o">!=</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">hil</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hil</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">hil</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* Disable interrupts from HIL only if there is no cooked driver. */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">cooked</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">im</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HP_SDC_IM_HIL</span> <span class="o">|</span> <span class="n">HP_SDC_IM_RESET</span><span class="p">);</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">set_im</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">task</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hp_sdc_release_cooked_irq</span><span class="p">(</span><span class="n">hp_sdc_irqhook</span> <span class="o">*</span><span class="n">callback</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">callback</span> <span class="o">!=</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">cooked</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">cooked</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">cooked</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* Disable interrupts from HIL only if there is no raw HIL driver. */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hil</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">im</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HP_SDC_IM_HIL</span> <span class="o">|</span> <span class="n">HP_SDC_IM_RESET</span><span class="p">);</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">set_im</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">task</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/************************* Keepalive timer task *********************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp_sdc_kicker</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">task</span><span class="p">);</span>
	<span class="cm">/* Re-insert the periodic task. */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">kicker</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************** Module Initialization ***************************/</span>

<span class="cp">#if defined(__hppa__)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">parisc_device_id</span> <span class="n">hp_sdc_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">hw_type</span> <span class="o">=</span>	<span class="n">HPHW_FIO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hversion_rev</span> <span class="o">=</span>	<span class="n">HVERSION_REV_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hversion</span> <span class="o">=</span>	<span class="n">HVERSION_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sversion</span> <span class="o">=</span>	<span class="mh">0x73</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">parisc</span><span class="p">,</span> <span class="n">hp_sdc_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="n">hp_sdc_init_hppa</span><span class="p">(</span><span class="k">struct</span> <span class="n">parisc_device</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">moduleloader_work</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">parisc_driver</span> <span class="n">hp_sdc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;hp_sdc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">hp_sdc_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">hp_sdc_init_hppa</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* __hppa__ */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hp_sdc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">errstr</span><span class="p">;</span>
	<span class="n">hp_sdc_transaction</span> <span class="n">t_sync</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">ts_sync</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">semaphore</span> <span class="n">s_sync</span><span class="p">;</span>

	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf_lock</span><span class="p">);</span>
	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">rtq_lock</span><span class="p">);</span>
	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">hook_lock</span><span class="p">);</span>

	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">timer</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">hil</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">pup</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">cooked</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">im</span>		<span class="o">=</span> <span class="n">HP_SDC_IM_MASK</span><span class="p">;</span>  <span class="cm">/* Mask maskable irqs */</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">set_im</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">wi</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">r7</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">r7</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">r7</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">r7</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>		<span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">ibf</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">tq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">tq</span><span class="p">));</span>

	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">wcurr</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">hp_sdc</span><span class="p">.</span><span class="n">rcurr</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">rqty</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev_err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;IO not found for&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">base_io</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>

	<span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;IRQ not found for&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">irq</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>

	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev_err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

<span class="cp">#if defined(__hppa__)</span>
	<span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;IO not available for&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">data_io</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hp_sdc_driver</span><span class="p">.</span><span class="n">name</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;IRQ not available for&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hp_sdc_isr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="o">|</span><span class="n">IRQF_SAMPLE_RANDOM</span><span class="p">,</span>
			<span class="s">&quot;HP SDC&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;NMI not available for&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">nmi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hp_sdc_nmisr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="s">&quot;HP SDC NMI&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PREFIX</span> <span class="s">&quot;HP SDC at 0x%p, IRQ %d (NMI IRQ %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">base_io</span><span class="p">,</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">nmi</span><span class="p">);</span>

	<span class="n">hp_sdc_status_in8</span><span class="p">();</span>
	<span class="n">hp_sdc_data_in8</span><span class="p">();</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">task</span><span class="p">,</span> <span class="n">hp_sdc_tasklet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Sync the output buffer registers, thus scheduling hp_sdc_tasklet. */</span>
	<span class="n">t_sync</span><span class="p">.</span><span class="n">actidx</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">t_sync</span><span class="p">.</span><span class="n">idx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">t_sync</span><span class="p">.</span><span class="n">endidx</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">t_sync</span><span class="p">.</span><span class="n">seq</span>	<span class="o">=</span> <span class="n">ts_sync</span><span class="p">;</span>
	<span class="n">ts_sync</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="n">HP_SDC_ACT_DATAREG</span> <span class="o">|</span> <span class="n">HP_SDC_ACT_SEMAPHORE</span><span class="p">;</span>
	<span class="n">ts_sync</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">ts_sync</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_sync</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span> <span class="n">ts_sync</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_sync</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">t_sync</span><span class="p">.</span><span class="n">act</span><span class="p">.</span><span class="n">semaphore</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s_sync</span><span class="p">;</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s_sync</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hp_sdc_enqueue_transaction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t_sync</span><span class="p">);</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s_sync</span><span class="p">);</span> <span class="cm">/* Wait for t_sync to complete */</span>

	<span class="cm">/* Create the keepalive task */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">kicker</span><span class="p">);</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">kicker</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">kicker</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hp_sdc_kicker</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">kicker</span><span class="p">);</span>

	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">err2:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">);</span>
 <span class="nl">err1:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">data_io</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
 <span class="nl">err0:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;: %s SDC IO=0x%p IRQ=0x%x NMI=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">errstr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">base_io</span><span class="p">,</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">nmi</span><span class="p">);</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev_err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(__hppa__)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">request_module_delayed</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;hp_sdc_mlc&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hp_sdc_init_hppa</span><span class="p">(</span><span class="k">struct</span> <span class="n">parisc_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* We only expect one SDC */</span>

	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">irq</span>		<span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">nmi</span>		<span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">aux_irq</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">base_io</span>		<span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">hpa</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">data_io</span>		<span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">hpa</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0x800</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">status_io</span>	<span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">hpa</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0x801</span><span class="p">;</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moduleloader_work</span><span class="p">,</span> <span class="n">request_module_delayed</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hp_sdc_init</span><span class="p">();</span>
	<span class="cm">/* after successful initialization give SDC some time to settle</span>
<span class="cm">	 * and then load the hp_sdc_mlc upper layer driver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moduleloader_work</span><span class="p">,</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">2000</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* __hppa__ */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp_sdc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* do nothing if we don&#39;t have a SDC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Turn off all maskable &quot;sub-function&quot; irq&#39;s. */</span>
	<span class="n">hp_sdc_spin_ibf</span><span class="p">();</span>
	<span class="n">sdc_writeb</span><span class="p">(</span><span class="n">HP_SDC_CMD_SET_IM</span> <span class="o">|</span> <span class="n">HP_SDC_IM_MASK</span><span class="p">,</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">status_io</span><span class="p">);</span>

	<span class="cm">/* Wait until we know this has been processed by the i8042 */</span>
	<span class="n">hp_sdc_spin_ibf</span><span class="p">();</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">nmi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">);</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">kicker</span><span class="p">);</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">task</span><span class="p">);</span>

<span class="cp">#if defined(__hppa__)</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moduleloader_work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unregister_parisc_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc_driver</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;Error unregistering HP SDC&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hp_sdc_register</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hp_sdc_transaction</span> <span class="n">tq_init</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">tq_init_seq</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">semaphore</span> <span class="n">tq_init_sem</span><span class="p">;</span>
<span class="cp">#if defined(__mc68000__)</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc_disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;HP SDC driver disabled by no_hpsdc=1.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if defined(__hppa__)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_parisc_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_sdc_driver</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;Error registering SDC with system bus tree.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#elif defined(__mc68000__)</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MACH_IS_HP300</span><span class="p">)</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">irq</span>	 <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">nmi</span>	 <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">base_io</span>	 <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="mh">0xf0428000</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">data_io</span>	 <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">base_io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">status_io</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">base_io</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_user</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">data_io</span><span class="p">))</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev_err</span>   <span class="o">=</span> <span class="n">hp_sdc_init</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;No SDC found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">hp_sdc</span><span class="p">.</span><span class="n">dev_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tq_init_sem</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tq_init</span><span class="p">.</span><span class="n">actidx</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tq_init</span><span class="p">.</span><span class="n">idx</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tq_init</span><span class="p">.</span><span class="n">endidx</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">tq_init</span><span class="p">.</span><span class="n">seq</span>		<span class="o">=</span> <span class="n">tq_init_seq</span><span class="p">;</span>
	<span class="n">tq_init</span><span class="p">.</span><span class="n">act</span><span class="p">.</span><span class="n">semaphore</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">tq_init_sem</span><span class="p">;</span>

	<span class="n">tq_init_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">HP_SDC_ACT_POSTCMD</span> <span class="o">|</span> <span class="n">HP_SDC_ACT_DATAIN</span> <span class="o">|</span> <span class="n">HP_SDC_ACT_SEMAPHORE</span><span class="p">;</span>
	<span class="n">tq_init_seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HP_SDC_CMD_READ_KCC</span><span class="p">;</span>
	<span class="n">tq_init_seq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tq_init_seq</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tq_init_seq</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hp_sdc_enqueue_transaction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tq_init</span><span class="p">);</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tq_init_sem</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tq_init_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tq_init_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_DEAD</span><span class="p">)</span> <span class="o">==</span> <span class="n">HP_SDC_ACT_DEAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;Error reading config byte.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">hp_sdc_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hp_sdc</span><span class="p">.</span><span class="n">r11</span> <span class="o">=</span> <span class="n">tq_init_seq</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">r11</span> <span class="o">&amp;</span> <span class="n">HP_SDC_CFG_NEW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PREFIX</span> <span class="s">&quot;New style SDC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tq_init_seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HP_SDC_CMD_READ_XTD</span><span class="p">;</span>
		<span class="n">tq_init</span><span class="p">.</span><span class="n">actidx</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tq_init</span><span class="p">.</span><span class="n">idx</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tq_init_sem</span><span class="p">);</span>
		<span class="n">hp_sdc_enqueue_transaction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tq_init</span><span class="p">);</span>
		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tq_init_sem</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tq_init_sem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tq_init_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HP_SDC_ACT_DEAD</span><span class="p">)</span> <span class="o">==</span> <span class="n">HP_SDC_ACT_DEAD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">PREFIX</span> <span class="s">&quot;Error reading extended config byte.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hp_sdc</span><span class="p">.</span><span class="n">r7e</span> <span class="o">=</span> <span class="n">tq_init_seq</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">HP_SDC_XTD_REV_STRINGS</span><span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">r7e</span> <span class="o">&amp;</span> <span class="n">HP_SDC_XTD_REV</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PREFIX</span> <span class="s">&quot;Revision: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">r7e</span> <span class="o">&amp;</span> <span class="n">HP_SDC_XTD_BEEPER</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PREFIX</span> <span class="s">&quot;TI SN76494 beeper present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">r7e</span> <span class="o">&amp;</span> <span class="n">HP_SDC_XTD_BBRTC</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PREFIX</span> <span class="s">&quot;OKI MSM-58321 BBRTC present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PREFIX</span> <span class="s">&quot;Spunking the self test register to force PUP &quot;</span>
		       <span class="s">&quot;on next firmware reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tq_init_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">HP_SDC_ACT_PRECMD</span> <span class="o">|</span>
			<span class="n">HP_SDC_ACT_DATAOUT</span> <span class="o">|</span> <span class="n">HP_SDC_ACT_SEMAPHORE</span><span class="p">;</span>
		<span class="n">tq_init_seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HP_SDC_CMD_SET_STR</span><span class="p">;</span>
		<span class="n">tq_init_seq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tq_init_seq</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tq_init</span><span class="p">.</span><span class="n">actidx</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tq_init</span><span class="p">.</span><span class="n">idx</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tq_init</span><span class="p">.</span><span class="n">endidx</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tq_init_sem</span><span class="p">);</span>
		<span class="n">hp_sdc_enqueue_transaction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tq_init</span><span class="p">);</span>
		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tq_init_sem</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tq_init_sem</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PREFIX</span> <span class="s">&quot;Old style SDC (1820-%s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">hp_sdc</span><span class="p">.</span><span class="n">r11</span> <span class="o">&amp;</span> <span class="n">HP_SDC_CFG_REV</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;3300&quot;</span> <span class="o">:</span> <span class="s">&quot;2564/3087&quot;</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">hp_sdc_register</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">hp_sdc_exit</span><span class="p">);</span>

<span class="cm">/* Timing notes:  These measurements taken on my 64MHz 7100-LC (715/64)</span>
<span class="cm"> *                                              cycles cycles-adj    time</span>
<span class="cm"> * between two consecutive mfctl(16)&#39;s:              4        n/a    63ns</span>
<span class="cm"> * hp_sdc_spin_ibf when idle:                      119        115   1.7us</span>
<span class="cm"> * gsc_writeb status register:                      83         79   1.2us</span>
<span class="cm"> * IBF to clear after sending SET_IM:             6204       6006    93us</span>
<span class="cm"> * IBF to clear after sending LOAD_RT:            4467       4352    68us</span>
<span class="cm"> * IBF to clear after sending two LOAD_RTs:      18974      18859   295us</span>
<span class="cm"> * READ_T1, read status/data, IRQ, call handler: 35564        n/a   556us</span>
<span class="cm"> * cmd to ~IBF READ_T1 2nd time right after:   5158403        n/a    81ms</span>
<span class="cm"> * between IRQ received and ~IBF for above:    2578877        n/a    40ms</span>
<span class="cm"> *</span>
<span class="cm"> * Performance stats after a run of this module configuring HIL and</span>
<span class="cm"> * receiving a few mouse events:</span>
<span class="cm"> *</span>
<span class="cm"> * status in8  282508 cycles 7128 calls</span>
<span class="cm"> * status out8   8404 cycles  341 calls</span>
<span class="cm"> * data out8     1734 cycles   78 calls</span>
<span class="cm"> * isr         174324 cycles  617 calls (includes take)</span>
<span class="cm"> * take          1241 cycles    2 calls</span>
<span class="cm"> * put        1411504 cycles 6937 calls</span>
<span class="cm"> * task       1655209 cycles 6937 calls (includes put)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
