<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › serio › hil_mlc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hil_mlc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * HIL MLC state machine and serio interface driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2001 Brian S. Julin</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions, and the following disclaimer,</span>
<span class="cm"> *    without modification.</span>
<span class="cm"> * 2. The name of the author may not be used to endorse or promote products</span>
<span class="cm"> *    derived from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * Alternatively, this software may be distributed under the terms of the</span>
<span class="cm"> * GNU General Public License (&quot;GPL&quot;).</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&#39;&#39; AND</span>
<span class="cm"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR</span>
<span class="cm"> * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
<span class="cm"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="cm"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<span class="cm"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
<span class="cm"> *</span>
<span class="cm"> * References:</span>
<span class="cm"> * HP-HIL Technical Reference Manual.  Hewlett Packard Product No. 45918A</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *	Driver theory of operation:</span>
<span class="cm"> *</span>
<span class="cm"> *	Some access methods and an ISR is defined by the sub-driver</span>
<span class="cm"> *	(e.g. hp_sdc_mlc.c).  These methods are expected to provide a</span>
<span class="cm"> *	few bits of logic in addition to raw access to the HIL MLC,</span>
<span class="cm"> *	specifically, the ISR, which is entirely registered by the</span>
<span class="cm"> *	sub-driver and invoked directly, must check for record</span>
<span class="cm"> *	termination or packet match, at which point a semaphore must</span>
<span class="cm"> *	be cleared and then the hil_mlcs_tasklet must be scheduled.</span>
<span class="cm"> *</span>
<span class="cm"> *	The hil_mlcs_tasklet processes the state machine for all MLCs</span>
<span class="cm"> *	each time it runs, checking each MLC&#39;s progress at the current</span>
<span class="cm"> *	node in the state machine, and moving the MLC to subsequent nodes</span>
<span class="cm"> *	in the state machine when appropriate.  It will reschedule</span>
<span class="cm"> *	itself if output is pending.  (This rescheduling should be replaced</span>
<span class="cm"> *	at some point with a sub-driver-specific mechanism.)</span>
<span class="cm"> *</span>
<span class="cm"> *	A timer task prods the tasklet once per second to prevent</span>
<span class="cm"> *	hangups when attached devices do not return expected data</span>
<span class="cm"> *	and to initiate probes of the loop for new devices.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/hil_mlc.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Brian S. Julin &lt;bri@calyx.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;HIL MLC serio&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hil_mlc_register</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hil_mlc_unregister</span><span class="p">);</span>

<span class="cp">#define PREFIX &quot;HIL MLC: &quot;</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">hil_mlcs</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">hil_mlcs_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">hil_mlcs_kicker</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>			<span class="n">hil_mlcs_probe</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">hil_mlcs_process</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">unused</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_TASKLET_DISABLED</span><span class="p">(</span><span class="n">hil_mlcs_tasklet</span><span class="p">,</span> <span class="n">hil_mlcs_process</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>


<span class="cm">/* #define HIL_MLC_DEBUG */</span>

<span class="cm">/********************** Device info/instance management **********************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hil_mlc_clear_di_map</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_map</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hil_mlc_clear_di_scratch</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_scratch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_scratch</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hil_mlc_copy_di_scratch</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_scratch</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_scratch</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hil_mlc_match_di_scratch</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">HIL_MLC_DEVMEM</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* In-use slots are not eligible. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_map</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span>
				<span class="n">found</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_scratch</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_scratch</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">HIL_MLC_DEVMEM</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hil_mlc_find_free_di</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="cm">/* TODO: Pick all-zero slots first, failing that,</span>
<span class="cm">	 * randomize the slot picked among those eligible.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">HIL_MLC_DEVMEM</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_map</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span>
				<span class="n">found</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span> <span class="cm">/* Note: It is guaranteed at least one above will match */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hil_mlc_clean_serio_map</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">HIL_MLC_DEVMEM</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_map</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span>
				<span class="n">found</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
			<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_map</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">di_revmap</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hil_mlc_send_polls</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">did</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serio_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">did</span> <span class="o">=</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ipacket</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HIL_PKT_ADDR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">serio</span> <span class="o">=</span> <span class="n">did</span> <span class="o">?</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">[</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_map</span><span class="p">[</span><span class="n">did</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drv</span> <span class="o">=</span> <span class="p">(</span><span class="n">serio</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">drv</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">icount</span> <span class="o">&lt;</span> <span class="mi">15</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hil_packet</span> <span class="n">p</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ipacket</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">did</span> <span class="o">!=</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">HIL_PKT_ADDR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">drv</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">HIL_ERR_INT</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">HIL_PKT_CMD</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>  <span class="mi">0</span><span class="p">);</span>
				<span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">HIL_CMD_POL</span> <span class="o">+</span> <span class="n">cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">did</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;</span> <span class="n">HIL_PKT_ADDR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">serio</span> <span class="o">=</span> <span class="n">did</span> <span class="o">?</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">[</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_map</span><span class="p">[</span><span class="n">did</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">drv</span> <span class="o">=</span> <span class="p">(</span><span class="n">serio</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">drv</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">drv</span> <span class="o">&amp;&amp;</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HIL_PKT_ADDR_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*************************** State engine *********************************/</span>

<span class="cp">#define HILSEN_SCHED	0x000100	</span><span class="cm">/* Schedule the tasklet		*/</span><span class="cp"></span>
<span class="cp">#define HILSEN_BREAK	0x000200	</span><span class="cm">/* Wait until next pass		*/</span><span class="cp"></span>
<span class="cp">#define HILSEN_UP	0x000400	</span><span class="cm">/* relative node#, decrement	*/</span><span class="cp"></span>
<span class="cp">#define HILSEN_DOWN	0x000800	</span><span class="cm">/* relative node#, increment	*/</span><span class="cp"></span>
<span class="cp">#define HILSEN_FOLLOW	0x001000	</span><span class="cm">/* use retval as next node#	*/</span><span class="cp"></span>

<span class="cp">#define HILSEN_MASK	0x0000ff</span>
<span class="cp">#define HILSEN_START	0</span>
<span class="cp">#define HILSEN_RESTART	1</span>
<span class="cp">#define HILSEN_DHR	9</span>
<span class="cp">#define HILSEN_DHR2	10</span>
<span class="cp">#define HILSEN_IFC	14</span>
<span class="cp">#define HILSEN_HEAL0	16</span>
<span class="cp">#define HILSEN_HEAL	18</span>
<span class="cp">#define HILSEN_ACF      21</span>
<span class="cp">#define HILSEN_ACF2	22</span>
<span class="cp">#define HILSEN_DISC0	25</span>
<span class="cp">#define HILSEN_DISC	27</span>
<span class="cp">#define HILSEN_MATCH	40</span>
<span class="cp">#define HILSEN_OPERATE	41</span>
<span class="cp">#define HILSEN_PROBE	44</span>
<span class="cp">#define HILSEN_DSR	52</span>
<span class="cp">#define HILSEN_REPOLL	55</span>
<span class="cp">#define HILSEN_IFCACF	58</span>
<span class="cp">#define HILSEN_END	60</span>

<span class="cp">#define HILSEN_NEXT	(HILSEN_DOWN | 1)</span>
<span class="cp">#define HILSEN_SAME	(HILSEN_DOWN | 0)</span>
<span class="cp">#define HILSEN_LAST	(HILSEN_UP | 1)</span>

<span class="cp">#define HILSEN_DOZE	(HILSEN_SAME | HILSEN_SCHED | HILSEN_BREAK)</span>
<span class="cp">#define HILSEN_SLEEP	(HILSEN_SAME | HILSEN_BREAK)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hilse_match</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hil_mlc_match_di_scratch</span><span class="p">(</span><span class="n">mlc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">hil_mlc_find_free_di</span><span class="p">(</span><span class="n">mlc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef HIL_MLC_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">PREFIX</span> <span class="s">&quot;new in slot %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">hil_mlc_copy_di_scratch</span><span class="p">(</span><span class="n">mlc</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_map</span><span class="p">[</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ddi</span><span class="p">]</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_map</span><span class="p">[</span><span class="n">rc</span><span class="p">].</span><span class="n">di_revmap</span> <span class="o">=</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ddi</span><span class="p">;</span>
		<span class="n">hil_mlc_clean_serio_map</span><span class="p">(</span><span class="n">mlc</span><span class="p">);</span>
		<span class="n">serio_rescan</span><span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">[</span><span class="n">rc</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_map</span><span class="p">[</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ddi</span><span class="p">]</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
<span class="cp">#ifdef HIL_MLC_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">PREFIX</span> <span class="s">&quot;same in slot %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_map</span><span class="p">[</span><span class="n">rc</span><span class="p">].</span><span class="n">di_revmap</span> <span class="o">=</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ddi</span><span class="p">;</span>
	<span class="n">hil_mlc_clean_serio_map</span><span class="p">(</span><span class="n">mlc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PREFIX</span> <span class="s">&quot;Residual device slots exhausted, close some serios!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* An LCV used to prevent runaway loops, forces 5 second sleep when reset. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hilse_init_lcv</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lcv</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lcv_tv</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lcv_tv</span> <span class="o">=</span> <span class="n">tv</span><span class="p">;</span>
	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lcv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hilse_inc_lcv</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lcv</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">lim</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int hilse_set_lcv(hil_mlc *mlc, int val)</span>
<span class="c">{</span>
<span class="c">	mlc-&gt;lcv = val;</span>

<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Management of the discovered device index (zero based, -1 means no devs) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hilse_set_ddi</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ddi</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">hil_mlc_clear_di_map</span><span class="p">(</span><span class="n">mlc</span><span class="p">,</span> <span class="n">val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hilse_dec_ddi</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ddi</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ddi</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ddi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hil_mlc_clear_di_map</span><span class="p">(</span><span class="n">mlc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hil_mlc_clear_di_map</span><span class="p">(</span><span class="n">mlc</span><span class="p">,</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ddi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hilse_inc_ddi</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ddi</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ddi</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hilse_take_idd</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Help the state engine:</span>
<span class="cm">	 * Is this a real IDD response or just an echo?</span>
<span class="cm">	 *</span>
<span class="cm">	 * Real IDD response does not start with a command.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ipacket</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HIL_PKT_CMD</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="cm">/* Should have the command echoed further down. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ipacket</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HIL_PKT_ADDR_MASK</span><span class="p">)</span> <span class="o">==</span>
		     <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ipacket</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HIL_PKT_ADDR_MASK</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ipacket</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HIL_PKT_CMD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ipacket</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HIL_PKT_DATA_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">HIL_CMD_IDD</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="cm">/* And the rest of the packets should still be clear. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ipacket</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_scratch</span><span class="p">.</span><span class="n">idd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ipacket</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HIL_PKT_DATA_MASK</span><span class="p">;</span>

	<span class="cm">/* Next step is to see if RSC supported */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_scratch</span><span class="p">.</span><span class="n">idd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HIL_IDD_HEADER_RSC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HILSEN_NEXT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_scratch</span><span class="p">.</span><span class="n">idd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HIL_IDD_HEADER_EXD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HILSEN_DOWN</span> <span class="o">|</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">bail:</span>
	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ddi</span><span class="o">--</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* This should send us off to ACF */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hilse_take_rsc</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_scratch</span><span class="p">.</span><span class="n">rsc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ipacket</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HIL_PKT_DATA_MASK</span><span class="p">;</span>

	<span class="cm">/* Next step is to see if EXD supported (IDD has already been read) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_scratch</span><span class="p">.</span><span class="n">idd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HIL_IDD_HEADER_EXD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HILSEN_NEXT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hilse_take_exd</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_scratch</span><span class="p">.</span><span class="n">exd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ipacket</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HIL_PKT_DATA_MASK</span><span class="p">;</span>

	<span class="cm">/* Next step is to see if RNM supported. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_scratch</span><span class="p">.</span><span class="n">exd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HIL_EXD_HEADER_RNM</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">HILSEN_NEXT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hilse_take_rnm</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_scratch</span><span class="p">.</span><span class="n">rnm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ipacket</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HIL_PKT_DATA_MASK</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PREFIX</span> <span class="s">&quot;Device name gotten: %16s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di_scratch</span><span class="p">.</span><span class="n">rnm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hilse_operate</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">repoll</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">opercnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hil_mlcs_probe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">opercnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">hil_mlc_send_polls</span><span class="p">(</span><span class="n">mlc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hil_mlcs_probe</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hil_mlcs_probe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">opercnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define FUNC(funct, funct_arg, zero_rc, neg_rc, pos_rc) \</span>
<span class="cp">{ HILSE_FUNC,		{ .func = funct }, funct_arg, zero_rc, neg_rc, pos_rc },</span>
<span class="cp">#define OUT(pack) \</span>
<span class="cp">{ HILSE_OUT,		{ .packet = pack }, 0, HILSEN_NEXT, HILSEN_DOZE, 0 },</span>
<span class="cp">#define CTS \</span>
<span class="cp">{ HILSE_CTS,		{ .packet = 0    }, 0, HILSEN_NEXT | HILSEN_SCHED | HILSEN_BREAK, HILSEN_DOZE, 0 },</span>
<span class="cp">#define EXPECT(comp, to, got, got_wrong, timed_out) \</span>
<span class="cp">{ HILSE_EXPECT,		{ .packet = comp }, to, got, got_wrong, timed_out },</span>
<span class="cp">#define EXPECT_LAST(comp, to, got, got_wrong, timed_out) \</span>
<span class="cp">{ HILSE_EXPECT_LAST,	{ .packet = comp }, to, got, got_wrong, timed_out },</span>
<span class="cp">#define EXPECT_DISC(comp, to, got, got_wrong, timed_out) \</span>
<span class="cp">{ HILSE_EXPECT_DISC,	{ .packet = comp }, to, got, got_wrong, timed_out },</span>
<span class="cp">#define IN(to, got, got_error, timed_out) \</span>
<span class="cp">{ HILSE_IN,		{ .packet = 0    }, to, got, got_error, timed_out },</span>
<span class="cp">#define OUT_DISC(pack) \</span>
<span class="cp">{ HILSE_OUT_DISC,	{ .packet = pack }, 0, 0, 0, 0 },</span>
<span class="cp">#define OUT_LAST(pack) \</span>
<span class="cp">{ HILSE_OUT_LAST,	{ .packet = pack }, 0, 0, 0, 0 },</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hilse_node</span> <span class="n">hil_mlc_se</span><span class="p">[</span><span class="n">HILSEN_END</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>

	<span class="cm">/* 0  HILSEN_START */</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_init_lcv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_SLEEP</span><span class="p">,</span>	<span class="mi">0</span><span class="p">)</span>

	<span class="cm">/* 1  HILSEN_RESTART */</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_inc_lcv</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_START</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)</span>
	<span class="n">OUT</span><span class="p">(</span><span class="n">HIL_CTRL_ONLY</span><span class="p">)</span>			<span class="cm">/* Disable APE */</span>
	<span class="n">CTS</span>

<span class="cp">#define TEST_PACKET(x) \</span>
<span class="cp">(HIL_PKT_CMD | (x &lt;&lt; HIL_PKT_ADDR_SHIFT) | x &lt;&lt; 4 | x)</span>

	<span class="n">OUT</span><span class="p">(</span><span class="n">HIL_DO_ALTER_CTRL</span> <span class="o">|</span> <span class="n">HIL_CTRL_TEST</span> <span class="o">|</span> <span class="n">TEST_PACKET</span><span class="p">(</span><span class="mh">0x5</span><span class="p">))</span>
	<span class="n">EXPECT</span><span class="p">(</span><span class="n">HIL_ERR_INT</span> <span class="o">|</span> <span class="n">TEST_PACKET</span><span class="p">(</span><span class="mh">0x5</span><span class="p">),</span>
	       <span class="mi">2000</span><span class="p">,</span>		<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_RESTART</span><span class="p">,</span>	<span class="n">HILSEN_RESTART</span><span class="p">)</span>
	<span class="n">OUT</span><span class="p">(</span><span class="n">HIL_DO_ALTER_CTRL</span> <span class="o">|</span> <span class="n">HIL_CTRL_TEST</span> <span class="o">|</span> <span class="n">TEST_PACKET</span><span class="p">(</span><span class="mh">0xa</span><span class="p">))</span>
	<span class="n">EXPECT</span><span class="p">(</span><span class="n">HIL_ERR_INT</span> <span class="o">|</span> <span class="n">TEST_PACKET</span><span class="p">(</span><span class="mh">0xa</span><span class="p">),</span>
	       <span class="mi">2000</span><span class="p">,</span>		<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_RESTART</span><span class="p">,</span>	<span class="n">HILSEN_RESTART</span><span class="p">)</span>
	<span class="n">OUT</span><span class="p">(</span><span class="n">HIL_CTRL_ONLY</span> <span class="o">|</span> <span class="mi">0</span><span class="p">)</span>			<span class="cm">/* Disable test mode */</span>

	<span class="cm">/* 9  HILSEN_DHR */</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_init_lcv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_SLEEP</span><span class="p">,</span>	<span class="mi">0</span><span class="p">)</span>

	<span class="cm">/* 10 HILSEN_DHR2 */</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_inc_lcv</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_START</span><span class="p">,</span>	<span class="mi">0</span><span class="p">)</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_set_ddi</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>		<span class="mi">0</span><span class="p">)</span>
	<span class="n">OUT</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_DHR</span><span class="p">)</span>
	<span class="n">IN</span><span class="p">(</span><span class="mi">300000</span><span class="p">,</span>		<span class="n">HILSEN_DHR2</span><span class="p">,</span>	<span class="n">HILSEN_DHR2</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">)</span>

	<span class="cm">/* 14 HILSEN_IFC */</span>
	<span class="n">OUT</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_IFC</span><span class="p">)</span>
	<span class="n">EXPECT</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_IFC</span> <span class="o">|</span> <span class="n">HIL_ERR_INT</span><span class="p">,</span>
	       <span class="mi">20000</span><span class="p">,</span>		<span class="n">HILSEN_DISC</span><span class="p">,</span>	<span class="n">HILSEN_DHR2</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span> <span class="p">)</span>

	<span class="cm">/* If devices are there, they weren&#39;t in PUP or other loopback mode.</span>
<span class="cm">	 * We&#39;re more concerned at this point with restoring operation</span>
<span class="cm">	 * to devices than discovering new ones, so we try to salvage</span>
<span class="cm">	 * the loop configuration by closing off the loop.</span>
<span class="cm">	 */</span>

	<span class="cm">/* 16 HILSEN_HEAL0 */</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_dec_ddi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_ACF</span><span class="p">,</span>	<span class="mi">0</span><span class="p">)</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_inc_ddi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>		<span class="mi">0</span><span class="p">)</span>

	<span class="cm">/* 18 HILSEN_HEAL */</span>
	<span class="n">OUT_LAST</span><span class="p">(</span><span class="n">HIL_CMD_ELB</span><span class="p">)</span>
	<span class="n">EXPECT_LAST</span><span class="p">(</span><span class="n">HIL_CMD_ELB</span> <span class="o">|</span> <span class="n">HIL_ERR_INT</span><span class="p">,</span>
		    <span class="mi">20000</span><span class="p">,</span>	<span class="n">HILSEN_REPOLL</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">)</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_dec_ddi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="n">HILSEN_HEAL</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="mi">0</span><span class="p">)</span>

	<span class="cm">/* 21 HILSEN_ACF */</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_init_lcv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_DOZE</span><span class="p">,</span>	<span class="mi">0</span><span class="p">)</span>

	<span class="cm">/* 22 HILSEN_ACF2 */</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_inc_lcv</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_START</span><span class="p">,</span>	<span class="mi">0</span><span class="p">)</span>
	<span class="n">OUT</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_ACF</span> <span class="o">|</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">IN</span><span class="p">(</span><span class="mi">20000</span><span class="p">,</span>		<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">)</span>

	<span class="cm">/* 25 HILSEN_DISC0 */</span>
	<span class="n">OUT_DISC</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_ELB</span><span class="p">)</span>
	<span class="n">EXPECT_DISC</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_ELB</span> <span class="o">|</span> <span class="n">HIL_ERR_INT</span><span class="p">,</span>
	       <span class="mi">20000</span><span class="p">,</span>		<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">)</span>

	<span class="cm">/* Only enter here if response just received */</span>
	<span class="cm">/* 27 HILSEN_DISC */</span>
	<span class="n">OUT_DISC</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_IDD</span><span class="p">)</span>
	<span class="n">EXPECT_DISC</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_IDD</span> <span class="o">|</span> <span class="n">HIL_ERR_INT</span><span class="p">,</span>
	       <span class="mi">20000</span><span class="p">,</span>		<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">,</span>	<span class="n">HILSEN_START</span><span class="p">)</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_inc_ddi</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_START</span><span class="p">,</span>	<span class="mi">0</span><span class="p">)</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_take_idd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="n">HILSEN_MATCH</span><span class="p">,</span>	<span class="n">HILSEN_IFCACF</span><span class="p">,</span>	<span class="n">HILSEN_FOLLOW</span><span class="p">)</span>
	<span class="n">OUT_LAST</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_RSC</span><span class="p">)</span>
	<span class="n">EXPECT_LAST</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_RSC</span> <span class="o">|</span> <span class="n">HIL_ERR_INT</span><span class="p">,</span>
	       <span class="mi">30000</span><span class="p">,</span>		<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">)</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_take_rsc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="n">HILSEN_MATCH</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>		<span class="n">HILSEN_FOLLOW</span><span class="p">)</span>
	<span class="n">OUT_LAST</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_EXD</span><span class="p">)</span>
	<span class="n">EXPECT_LAST</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_EXD</span> <span class="o">|</span> <span class="n">HIL_ERR_INT</span><span class="p">,</span>
	       <span class="mi">30000</span><span class="p">,</span>		<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">)</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_take_exd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="n">HILSEN_MATCH</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>		<span class="n">HILSEN_FOLLOW</span><span class="p">)</span>
	<span class="n">OUT_LAST</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_RNM</span><span class="p">)</span>
	<span class="n">EXPECT_LAST</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_RNM</span> <span class="o">|</span> <span class="n">HIL_ERR_INT</span><span class="p">,</span>
	       <span class="mi">30000</span><span class="p">,</span>		<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">)</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_take_rnm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HILSEN_MATCH</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>		<span class="mi">0</span><span class="p">)</span>

	<span class="cm">/* 40 HILSEN_MATCH */</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_match</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="cm">/* TODO */</span> <span class="mi">0</span><span class="p">)</span>

	<span class="cm">/* 41 HILSEN_OPERATE */</span>
	<span class="n">OUT</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_POL</span><span class="p">)</span>
	<span class="n">EXPECT</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_POL</span> <span class="o">|</span> <span class="n">HIL_ERR_INT</span><span class="p">,</span>
	       <span class="mi">20000</span><span class="p">,</span>		<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">)</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_operate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="n">HILSEN_OPERATE</span><span class="p">,</span>	<span class="n">HILSEN_IFC</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">)</span>

	<span class="cm">/* 44 HILSEN_PROBE */</span>
	<span class="n">OUT_LAST</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_EPT</span><span class="p">)</span>
	<span class="n">IN</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span>		<span class="n">HILSEN_DISC</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">)</span>
	<span class="n">OUT_DISC</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_ELB</span><span class="p">)</span>
	<span class="n">IN</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span>		<span class="n">HILSEN_DISC</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">)</span>
	<span class="n">OUT</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_ACF</span> <span class="o">|</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">IN</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span>		<span class="n">HILSEN_DISC0</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">)</span>
	<span class="n">OUT_LAST</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_ELB</span><span class="p">)</span>
	<span class="n">IN</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span>		<span class="n">HILSEN_OPERATE</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">)</span>

	<span class="cm">/* 52 HILSEN_DSR */</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_set_ddi</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>		<span class="mi">0</span><span class="p">)</span>
	<span class="n">OUT</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_DSR</span><span class="p">)</span>
	<span class="n">IN</span><span class="p">(</span><span class="mi">20000</span><span class="p">,</span>		<span class="n">HILSEN_DHR</span><span class="p">,</span>	<span class="n">HILSEN_DHR</span><span class="p">,</span>	<span class="n">HILSEN_IFC</span><span class="p">)</span>

	<span class="cm">/* 55 HILSEN_REPOLL */</span>
	<span class="n">OUT</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_RPL</span><span class="p">)</span>
	<span class="n">EXPECT</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_RPL</span> <span class="o">|</span> <span class="n">HIL_ERR_INT</span><span class="p">,</span>
	       <span class="mi">20000</span><span class="p">,</span>		<span class="n">HILSEN_NEXT</span><span class="p">,</span>	<span class="n">HILSEN_DSR</span><span class="p">,</span>	<span class="n">HILSEN_NEXT</span><span class="p">)</span>
	<span class="n">FUNC</span><span class="p">(</span><span class="n">hilse_operate</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>	<span class="n">HILSEN_OPERATE</span><span class="p">,</span>	<span class="n">HILSEN_IFC</span><span class="p">,</span>	<span class="n">HILSEN_PROBE</span><span class="p">)</span>

	<span class="cm">/* 58 HILSEN_IFCACF */</span>
	<span class="n">OUT</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_IFC</span><span class="p">)</span>
	<span class="n">EXPECT</span><span class="p">(</span><span class="n">HIL_PKT_CMD</span> <span class="o">|</span> <span class="n">HIL_CMD_IFC</span> <span class="o">|</span> <span class="n">HIL_ERR_INT</span><span class="p">,</span>
	       <span class="mi">20000</span><span class="p">,</span>		<span class="n">HILSEN_ACF2</span><span class="p">,</span>	<span class="n">HILSEN_DHR2</span><span class="p">,</span>	<span class="n">HILSEN_HEAL</span><span class="p">)</span>

	<span class="cm">/* 60 HILSEN_END */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hilse_setup_input</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">hilse_node</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">act</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HILSE_EXPECT_DISC</span>:
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">imatch</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">packet</span><span class="p">;</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">imatch</span> <span class="o">|=</span> <span class="p">((</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ddi</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">HIL_PKT_ADDR_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HILSE_EXPECT_LAST</span>:
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">imatch</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">packet</span><span class="p">;</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">imatch</span> <span class="o">|=</span> <span class="p">((</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ddi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">HIL_PKT_ADDR_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HILSE_EXPECT</span>:
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">imatch</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">packet</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HILSE_IN</span>:
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">imatch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">istarted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">intimeout</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">instart</span><span class="p">));</span>
	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">icount</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ipacket</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hil_packet</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">isem</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#ifdef HIL_MLC_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">doze</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">seidx</span><span class="p">;</span> <span class="cm">/* For debug */</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hilse_donode</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">hilse_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nextidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sched_long</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef HIL_MLC_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">seidx</span> <span class="o">&amp;&amp;</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">seidx</span> <span class="o">!=</span> <span class="n">seidx</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">seidx</span> <span class="o">!=</span> <span class="mi">41</span> <span class="o">&amp;&amp;</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">seidx</span> <span class="o">!=</span> <span class="mi">42</span> <span class="o">&amp;&amp;</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">seidx</span> <span class="o">!=</span> <span class="mi">43</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">PREFIX</span> <span class="s">&quot;z%i </span><span class="se">\n</span><span class="s"> {%i}&quot;</span><span class="p">,</span> <span class="n">doze</span><span class="p">,</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">seidx</span><span class="p">);</span>
		<span class="n">doze</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">seidx</span> <span class="o">=</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">seidx</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">hil_mlc_se</span> <span class="o">+</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">seidx</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">act</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">hil_packet</span> <span class="n">pack</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HILSE_FUNC</span>:
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">func</span><span class="p">(</span><span class="n">mlc</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span>
		<span class="n">nextidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">ugly</span> <span class="o">:</span>
			<span class="p">((</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">bad</span> <span class="o">:</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">good</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nextidx</span> <span class="o">==</span> <span class="n">HILSEN_FOLLOW</span><span class="p">)</span>
			<span class="n">nextidx</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HILSE_EXPECT_LAST</span>:
	<span class="k">case</span> <span class="n">HILSE_EXPECT_DISC</span>:
	<span class="k">case</span> <span class="n">HILSE_EXPECT</span>:
	<span class="k">case</span> <span class="n">HILSE_IN</span>:
		<span class="cm">/* Already set up from previous HILSE_OUT_* */</span>
		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">(</span><span class="n">mlc</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>  <span class="p">{</span>
			<span class="n">nextidx</span> <span class="o">=</span> <span class="n">HILSEN_DOZE</span><span class="p">;</span>
			<span class="n">sched_long</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">nextidx</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">ugly</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nextidx</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">good</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">nextidx</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">bad</span><span class="p">;</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">istarted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HILSE_OUT_LAST</span>:
		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pack</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">packet</span><span class="p">;</span>
		<span class="n">pack</span> <span class="o">|=</span> <span class="p">((</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ddi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">HIL_PKT_ADDR_SHIFT</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HILSE_OUT_DISC</span>:
		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pack</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">packet</span><span class="p">;</span>
		<span class="n">pack</span> <span class="o">|=</span> <span class="p">((</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ddi</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">HIL_PKT_ADDR_SHIFT</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HILSE_OUT</span>:
		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pack</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">.</span><span class="n">packet</span><span class="p">;</span>
	<span class="nl">out:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">istarted</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
		<span class="cm">/* Prepare to receive input */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">node</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">act</span> <span class="o">&amp;</span> <span class="n">HILSE_IN</span><span class="p">)</span>
			<span class="n">hilse_setup_input</span><span class="p">(</span><span class="n">mlc</span><span class="p">,</span> <span class="n">node</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="nl">out2:</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">osem</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nextidx</span> <span class="o">=</span> <span class="n">HILSEN_DOZE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">osem</span><span class="p">);</span>

		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ostarted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ostarted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">opacket</span> <span class="o">=</span> <span class="n">pack</span><span class="p">;</span>
			<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">(</span><span class="n">mlc</span><span class="p">);</span>
			<span class="n">nextidx</span> <span class="o">=</span> <span class="n">HILSEN_DOZE</span><span class="p">;</span>
			<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ostarted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">instart</span><span class="p">));</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">nextidx</span> <span class="o">=</span> <span class="n">HILSEN_NEXT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HILSE_CTS</span>:
		<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">nextidx</span> <span class="o">=</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">cts</span><span class="p">(</span><span class="n">mlc</span><span class="p">)</span> <span class="o">?</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">bad</span> <span class="o">:</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">good</span><span class="p">;</span>
		<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

<span class="cp">#ifdef HIL_MLC_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nextidx</span> <span class="o">==</span> <span class="n">HILSEN_DOZE</span><span class="p">)</span>
		<span class="n">doze</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">nextidx</span> <span class="o">&amp;</span> <span class="n">HILSEN_SCHED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sched_long</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">sched</span><span class="p">;</span>

		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
		<span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">+=</span> <span class="n">USEC_PER_SEC</span> <span class="o">*</span> <span class="p">(</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">instart</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
		<span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-=</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">instart</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">&gt;=</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">intimeout</span><span class="p">)</span> <span class="k">goto</span> <span class="n">sched</span><span class="p">;</span>
		<span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">intimeout</span> <span class="o">-</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="n">USEC_PER_SEC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span> <span class="k">goto</span> <span class="n">sched</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_kicker</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">sched:</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_tasklet</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nextidx</span> <span class="o">&amp;</span> <span class="n">HILSEN_DOWN</span><span class="p">)</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">seidx</span> <span class="o">+=</span> <span class="n">nextidx</span> <span class="o">&amp;</span> <span class="n">HILSEN_MASK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nextidx</span> <span class="o">&amp;</span> <span class="n">HILSEN_UP</span><span class="p">)</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">seidx</span> <span class="o">-=</span> <span class="n">nextidx</span> <span class="o">&amp;</span> <span class="n">HILSEN_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">seidx</span> <span class="o">=</span> <span class="n">nextidx</span> <span class="o">&amp;</span> <span class="n">HILSEN_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nextidx</span> <span class="o">&amp;</span> <span class="n">HILSEN_BREAK</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************** tasklet context functions **************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hil_mlcs_process</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_lock</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hil_mlcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">hil_mlc</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">hilse_donode</span><span class="p">(</span><span class="n">mlc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef HIL_MLC_DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">seidx</span> <span class="o">!=</span> <span class="mi">41</span> <span class="o">&amp;&amp;</span>
			    <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">seidx</span> <span class="o">!=</span> <span class="mi">42</span> <span class="o">&amp;&amp;</span>
			    <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">seidx</span> <span class="o">!=</span> <span class="mi">43</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">PREFIX</span> <span class="s">&quot; + &quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************* Keepalive timer task *********************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hil_mlcs_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hil_mlcs_probe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_tasklet</span><span class="p">);</span>
	<span class="cm">/* Re-insert the periodic task. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_kicker</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_kicker</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************** user/kernel context functions **********************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hil_mlc_serio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hil_mlc_serio_map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">serio_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="o">*</span><span class="n">last</span><span class="p">;</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">port_data</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">map</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">mlc</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">mlc</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mlc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_opacket</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">didx</span><span class="p">]</span> <span class="o">|=</span>
		<span class="p">((</span><span class="n">hil_packet</span><span class="p">)</span><span class="n">c</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_oidx</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">didx</span><span class="p">]));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_oidx</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">didx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* for now only commands */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_opacket</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">didx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HIL_PKT_CMD</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_opacket</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">didx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HIL_PKT_DATA_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HIL_CMD_IDD</span>:
			<span class="n">idx</span> <span class="o">=</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">didx</span><span class="p">].</span><span class="n">idd</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">emu</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HIL_CMD_RSC</span>:
			<span class="n">idx</span> <span class="o">=</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">didx</span><span class="p">].</span><span class="n">rsc</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">emu</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HIL_CMD_EXD</span>:
			<span class="n">idx</span> <span class="o">=</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">didx</span><span class="p">].</span><span class="n">exd</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">emu</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HIL_CMD_RNM</span>:
			<span class="n">idx</span> <span class="o">=</span> <span class="n">mlc</span><span class="o">-&gt;</span><span class="n">di</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">didx</span><span class="p">].</span><span class="n">rnm</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">emu</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_oidx</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">didx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_opacket</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">didx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_oidx</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">didx</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
 <span class="nl">emu:</span>
	<span class="n">drv</span> <span class="o">=</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">drv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">last</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">15</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">last</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">last</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">last</span><span class="o">--</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">HIL_ERR_INT</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">HIL_ERR_INT</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="n">HIL_PKT_CMD</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">drv</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_oidx</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">didx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_opacket</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">didx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hil_mlc_serio_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hil_mlc_serio_map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serio_get_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">port_data</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">map</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">mlc</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">mlc</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mlc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hil_mlc_serio_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">serio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hil_mlc_serio_map</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">;</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">serio</span><span class="o">-&gt;</span><span class="n">port_data</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">map</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">mlc</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">mlc</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mlc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">serio_set_drvdata</span><span class="p">(</span><span class="n">serio</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">serio</span><span class="o">-&gt;</span><span class="n">drv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* TODO wake up interruptable */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">serio_device_id</span> <span class="n">hil_mlc_serio_id</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SERIO_HIL_MLC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">SERIO_HIL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">extra</span> <span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">SERIO_ANY</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">hil_mlc_register</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mlc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">istarted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">ostarted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">osem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">isem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">icount</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">imatch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">opercnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">csem</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hil_mlc_clear_di_scratch</span><span class="p">(</span><span class="n">mlc</span><span class="p">);</span>
	<span class="n">hil_mlc_clear_di_map</span><span class="p">(</span><span class="n">mlc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HIL_MLC_DEVMEM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">mlc_serio</span><span class="p">;</span>
		<span class="n">hil_mlc_copy_di_scratch</span><span class="p">(</span><span class="n">mlc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">mlc_serio</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mlc_serio</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlc_serio</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">mlc_serio</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mlc_serio</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;HIL_SERIO%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">mlc_serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mlc_serio</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;HIL%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">mlc_serio</span><span class="o">-&gt;</span><span class="n">id</span>			<span class="o">=</span> <span class="n">hil_mlc_serio_id</span><span class="p">;</span>
		<span class="n">mlc_serio</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="cm">/* HIL port no. */</span>
		<span class="n">mlc_serio</span><span class="o">-&gt;</span><span class="n">write</span>		<span class="o">=</span> <span class="n">hil_mlc_serio_write</span><span class="p">;</span>
		<span class="n">mlc_serio</span><span class="o">-&gt;</span><span class="n">open</span>			<span class="o">=</span> <span class="n">hil_mlc_serio_open</span><span class="p">;</span>
		<span class="n">mlc_serio</span><span class="o">-&gt;</span><span class="n">close</span>		<span class="o">=</span> <span class="n">hil_mlc_serio_close</span><span class="p">;</span>
		<span class="n">mlc_serio</span><span class="o">-&gt;</span><span class="n">port_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_map</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mlc</span>		<span class="o">=</span> <span class="n">mlc</span><span class="p">;</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">didx</span>		<span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">di_revmap</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_opacket</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio_oidx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">serio_register_port</span><span class="p">(</span><span class="n">mlc_serio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">tasklet</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hil_mlcs_tasklet</span><span class="p">;</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hil_mlcs</span><span class="p">);</span>
	<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">seidx</span> <span class="o">=</span> <span class="n">HILSEN_START</span><span class="p">;</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_tasklet</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hil_mlc_unregister</span><span class="p">(</span><span class="n">hil_mlc</span> <span class="o">*</span><span class="n">mlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mlc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hil_mlcs</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">hil_mlc</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="o">==</span> <span class="n">mlc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>

	<span class="cm">/* not found in list */</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_tasklet</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

 <span class="nl">found:</span>
	<span class="n">list_del</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HIL_MLC_DEVMEM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">serio_unregister_port</span><span class="p">(</span><span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">mlc</span><span class="o">-&gt;</span><span class="n">serio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_tasklet</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************** Module interface *************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hil_mlc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_kicker</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hil_mlcs_timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_kicker</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">tasklet_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_tasklet</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">hil_mlc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_kicker</span><span class="p">);</span>

	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_tasklet</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hil_mlcs_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">hil_mlc_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">hil_mlc_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
