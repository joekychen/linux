<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › input › tablet › aiptek.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>aiptek.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Native support for the Aiptek HyperPen USB Tablets</span>
<span class="cm"> *  (4000U/5000U/6000U/8000U/12000U)</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2001      Chris Atenasio   &lt;chris@crud.net&gt;</span>
<span class="cm"> *  Copyright (c) 2002-2004 Bryan W. Headley &lt;bwheadley@earthlink.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  based on wacom.c by</span>
<span class="cm"> *     Vojtech Pavlik      &lt;vojtech@suse.cz&gt;</span>
<span class="cm"> *     Andreas Bach Aaen   &lt;abach@stofanet.dk&gt;</span>
<span class="cm"> *     Clifford Wolf       &lt;clifford@clifford.at&gt;</span>
<span class="cm"> *     Sam Mosel           &lt;sam.mosel@computer.org&gt;</span>
<span class="cm"> *     James E. Blair      &lt;corvus@gnu.org&gt;</span>
<span class="cm"> *     Daniel Egger        &lt;egger@suse.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Many thanks to Oliver Kuechemann for his support.</span>
<span class="cm"> *</span>
<span class="cm"> *  ChangeLog:</span>
<span class="cm"> *      v0.1 - Initial release</span>
<span class="cm"> *      v0.2 - Hack to get around fake event 28&#39;s. (Bryan W. Headley)</span>
<span class="cm"> *      v0.3 - Make URB dynamic (Bryan W. Headley, Jun-8-2002)</span>
<span class="cm"> *             Released to Linux 2.4.19 and 2.5.x</span>
<span class="cm"> *      v0.4 - Rewrote substantial portions of the code to deal with</span>
<span class="cm"> *             corrected control sequences, timing, dynamic configuration,</span>
<span class="cm"> *             support of 6000U - 12000U, procfs, and macro key support</span>
<span class="cm"> *             (Jan-1-2003 - Feb-5-2003, Bryan W. Headley)</span>
<span class="cm"> *      v1.0 - Added support for diagnostic messages, count of messages</span>
<span class="cm"> *             received from URB - Mar-8-2003, Bryan W. Headley</span>
<span class="cm"> *      v1.1 - added support for tablet resolution, changed DV and proximity</span>
<span class="cm"> *             some corrections - Jun-22-2003, martin schneebacher</span>
<span class="cm"> *           - Added support for the sysfs interface, deprecating the</span>
<span class="cm"> *             procfs interface for 2.5.x kernel. Also added support for</span>
<span class="cm"> *             Wheel command. Bryan W. Headley July-15-2003.</span>
<span class="cm"> *      v1.2 - Reworked jitter timer as a kernel thread.</span>
<span class="cm"> *             Bryan W. Headley November-28-2003/Jan-10-2004.</span>
<span class="cm"> *      v1.3 - Repaired issue of kernel thread going nuts on single-processor</span>
<span class="cm"> *             machines, introduced programmableDelay as a command line</span>
<span class="cm"> *             parameter. Feb 7 2004, Bryan W. Headley.</span>
<span class="cm"> *      v1.4 - Re-wire jitter so it does not require a thread. Courtesy of</span>
<span class="cm"> *             Rene van Paassen. Added reporting of physical pointer device</span>
<span class="cm"> *             (e.g., stylus, mouse in reports 2, 3, 4, 5. We don&#39;t know</span>
<span class="cm"> *             for reports 1, 6.)</span>
<span class="cm"> *             what physical device reports for reports 1, 6.) Also enabled</span>
<span class="cm"> *             MOUSE and LENS tool button modes. Renamed &quot;rubber&quot; to &quot;eraser&quot;.</span>
<span class="cm"> *             Feb 20, 2004, Bryan W. Headley.</span>
<span class="cm"> *      v1.5 - Added previousJitterable, so we don&#39;t do jitter delay when the</span>
<span class="cm"> *             user is holding a button down for periods of time.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:</span>
<span class="cm"> *      This kernel driver is augmented by the &quot;Aiptek&quot; XFree86 input</span>
<span class="cm"> *      driver for your X server, as well as the Gaiptek GUI Front-end</span>
<span class="cm"> *      &quot;Tablet Manager&quot;.</span>
<span class="cm"> *      These three products are highly interactive with one another,</span>
<span class="cm"> *      so therefore it&#39;s easier to document them all as one subsystem.</span>
<span class="cm"> *      Please visit the project&#39;s &quot;home page&quot;, located at,</span>
<span class="cm"> *      http://aiptektablet.sourceforge.net.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/usb/input.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Version Information</span>
<span class="cm"> */</span>
<span class="cp">#define DRIVER_VERSION &quot;v2.3 (May 2, 2007)&quot;</span>
<span class="cp">#define DRIVER_AUTHOR  &quot;Bryan W. Headley/Chris Atenasio/Cedric Brun/Rene van Paassen&quot;</span>
<span class="cp">#define DRIVER_DESC    &quot;Aiptek HyperPen USB Tablet Driver (Linux 2.6.x)&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Aiptek status packet:</span>
<span class="cm"> *</span>
<span class="cm"> * (returned as Report 1 - relative coordinates from mouse and stylus)</span>
<span class="cm"> *</span>
<span class="cm"> *        bit7  bit6  bit5  bit4  bit3  bit2  bit1  bit0</span>
<span class="cm"> * byte0   0     0     0     0     0     0     0     1</span>
<span class="cm"> * byte1   0     0     0     0     0    BS2   BS    Tip</span>
<span class="cm"> * byte2  X7    X6    X5    X4    X3    X2    X1    X0</span>
<span class="cm"> * byte3  Y7    Y6    Y5    Y4    Y3    Y2    Y1    Y0</span>
<span class="cm"> *</span>
<span class="cm"> * (returned as Report 2 - absolute coordinates from the stylus)</span>
<span class="cm"> *</span>
<span class="cm"> *        bit7  bit6  bit5  bit4  bit3  bit2  bit1  bit0</span>
<span class="cm"> * byte0   0     0     0     0     0     0     1     0</span>
<span class="cm"> * byte1  X7    X6    X5    X4    X3    X2    X1    X0</span>
<span class="cm"> * byte2  X15   X14   X13   X12   X11   X10   X9    X8</span>
<span class="cm"> * byte3  Y7    Y6    Y5    Y4    Y3    Y2    Y1    Y0</span>
<span class="cm"> * byte4  Y15   Y14   Y13   Y12   Y11   Y10   Y9    Y8</span>
<span class="cm"> * byte5   *     *     *    BS2   BS1   Tip   IR    DV</span>
<span class="cm"> * byte6  P7    P6    P5    P4    P3    P2    P1    P0</span>
<span class="cm"> * byte7  P15   P14   P13   P12   P11   P10   P9    P8</span>
<span class="cm"> *</span>
<span class="cm"> * (returned as Report 3 - absolute coordinates from the mouse)</span>
<span class="cm"> *</span>
<span class="cm"> *        bit7  bit6  bit5  bit4  bit3  bit2  bit1  bit0</span>
<span class="cm"> * byte0   0     0     0     0     0     0     1     1</span>
<span class="cm"> * byte1  X7    X6    X5    X4    X3    X2    X1    X0</span>
<span class="cm"> * byte2  X15   X14   X13   X12   X11   X10   X9    X8</span>
<span class="cm"> * byte3  Y7    Y6    Y5    Y4    Y3    Y2    Y1    Y0</span>
<span class="cm"> * byte4  Y15   Y14   Y13   Y12   Y11   Y10   Y9    Y8</span>
<span class="cm"> * byte5   *     *     *    BS2   BS1   Tip   IR    DV</span>
<span class="cm"> * byte6  P7    P6    P5    P4    P3    P2    P1    P0</span>
<span class="cm"> * byte7  P15   P14   P13   P12   P11   P10   P9    P8</span>
<span class="cm"> *</span>
<span class="cm"> * (returned as Report 4 - macrokeys from the stylus)</span>
<span class="cm"> *</span>
<span class="cm"> *        bit7  bit6  bit5  bit4  bit3  bit2  bit1  bit0</span>
<span class="cm"> * byte0   0     0     0     0     0     1     0     0</span>
<span class="cm"> * byte1   0     0     0    BS2   BS    Tip   IR    DV</span>
<span class="cm"> * byte2   0     0     0     0     0     0     1     0</span>
<span class="cm"> * byte3   0     0     0    K4    K3    K2    K1    K0</span>
<span class="cm"> * byte4  P7    P6    P5    P4    P3    P2    P1    P0</span>
<span class="cm"> * byte5  P15   P14   P13   P12   P11   P10   P9    P8</span>
<span class="cm"> *</span>
<span class="cm"> * (returned as Report 5 - macrokeys from the mouse)</span>
<span class="cm"> *</span>
<span class="cm"> *        bit7  bit6  bit5  bit4  bit3  bit2  bit1  bit0</span>
<span class="cm"> * byte0   0     0     0     0     0     1     0     1</span>
<span class="cm"> * byte1   0     0     0    BS2   BS    Tip   IR    DV</span>
<span class="cm"> * byte2   0     0     0     0     0     0     1     0</span>
<span class="cm"> * byte3   0     0     0    K4    K3    K2    K1    K0</span>
<span class="cm"> * byte4  P7    P6    P5    P4    P3    P2    P1    P0</span>
<span class="cm"> * byte5  P15   P14   P13   P12   P11   P10   P9    P8</span>
<span class="cm"> *</span>
<span class="cm"> * IR: In Range = Proximity on</span>
<span class="cm"> * DV = Data Valid</span>
<span class="cm"> * BS = Barrel Switch (as in, macro keys)</span>
<span class="cm"> * BS2 also referred to as Tablet Pick</span>
<span class="cm"> *</span>
<span class="cm"> * Command Summary:</span>
<span class="cm"> *</span>
<span class="cm"> * Use report_type CONTROL (3)</span>
<span class="cm"> * Use report_id   2</span>
<span class="cm"> *</span>
<span class="cm"> * Command/Data    Description     Return Bytes    Return Value</span>
<span class="cm"> * 0x10/0x00       SwitchToMouse       0</span>
<span class="cm"> * 0x10/0x01       SwitchToTablet      0</span>
<span class="cm"> * 0x18/0x04       SetResolution       0</span>
<span class="cm"> * 0x12/0xFF       AutoGainOn          0</span>
<span class="cm"> * 0x17/0x00       FilterOn            0</span>
<span class="cm"> * 0x01/0x00       GetXExtension       2           MaxX</span>
<span class="cm"> * 0x01/0x01       GetYExtension       2           MaxY</span>
<span class="cm"> * 0x02/0x00       GetModelCode        2           ModelCode = LOBYTE</span>
<span class="cm"> * 0x03/0x00       GetODMCode          2           ODMCode</span>
<span class="cm"> * 0x08/0x00       GetPressureLevels   2           =512</span>
<span class="cm"> * 0x04/0x00       GetFirmwareVersion  2           Firmware Version</span>
<span class="cm"> * 0x11/0x02       EnableMacroKeys     0</span>
<span class="cm"> *</span>
<span class="cm"> * To initialize the tablet:</span>
<span class="cm"> *</span>
<span class="cm"> * (1) Send Resolution500LPI (Command)</span>
<span class="cm"> * (2) Query for Model code (Option Report)</span>
<span class="cm"> * (3) Query for ODM code (Option Report)</span>
<span class="cm"> * (4) Query for firmware (Option Report)</span>
<span class="cm"> * (5) Query for GetXExtension (Option Report)</span>
<span class="cm"> * (6) Query for GetYExtension (Option Report)</span>
<span class="cm"> * (7) Query for GetPressureLevels (Option Report)</span>
<span class="cm"> * (8) SwitchToTablet for Absolute coordinates, or</span>
<span class="cm"> *     SwitchToMouse for Relative coordinates (Command)</span>
<span class="cm"> * (9) EnableMacroKeys (Command)</span>
<span class="cm"> * (10) FilterOn (Command)</span>
<span class="cm"> * (11) AutoGainOn (Command)</span>
<span class="cm"> *</span>
<span class="cm"> * (Step 9 can be omitted, but you&#39;ll then have no function keys.)</span>
<span class="cm"> */</span>

<span class="cp">#define USB_VENDOR_ID_AIPTEK				0x08ca</span>
<span class="cp">#define USB_VENDOR_ID_KYE				0x0458</span>
<span class="cp">#define USB_REQ_GET_REPORT				0x01</span>
<span class="cp">#define USB_REQ_SET_REPORT				0x09</span>

	<span class="cm">/* PointerMode codes</span>
<span class="cm">	 */</span>
<span class="cp">#define AIPTEK_POINTER_ONLY_MOUSE_MODE			0</span>
<span class="cp">#define AIPTEK_POINTER_ONLY_STYLUS_MODE			1</span>
<span class="cp">#define AIPTEK_POINTER_EITHER_MODE			2</span>

<span class="cp">#define AIPTEK_POINTER_ALLOW_MOUSE_MODE(a)		\</span>
<span class="cp">	(a == AIPTEK_POINTER_ONLY_MOUSE_MODE ||		\</span>
<span class="cp">	 a == AIPTEK_POINTER_EITHER_MODE)</span>
<span class="cp">#define AIPTEK_POINTER_ALLOW_STYLUS_MODE(a)		\</span>
<span class="cp">	(a == AIPTEK_POINTER_ONLY_STYLUS_MODE ||	\</span>
<span class="cp">	 a == AIPTEK_POINTER_EITHER_MODE)</span>

	<span class="cm">/* CoordinateMode code</span>
<span class="cm">	 */</span>
<span class="cp">#define AIPTEK_COORDINATE_RELATIVE_MODE			0</span>
<span class="cp">#define AIPTEK_COORDINATE_ABSOLUTE_MODE			1</span>

       <span class="cm">/* XTilt and YTilt values</span>
<span class="cm">        */</span>
<span class="cp">#define AIPTEK_TILT_MIN					(-128)</span>
<span class="cp">#define AIPTEK_TILT_MAX					127</span>
<span class="cp">#define AIPTEK_TILT_DISABLE				(-10101)</span>

	<span class="cm">/* Wheel values</span>
<span class="cm">	 */</span>
<span class="cp">#define AIPTEK_WHEEL_MIN				0</span>
<span class="cp">#define AIPTEK_WHEEL_MAX				1024</span>
<span class="cp">#define AIPTEK_WHEEL_DISABLE				(-10101)</span>

	<span class="cm">/* ToolCode values, which BTW are 0x140 .. 0x14f</span>
<span class="cm">	 * We have things set up such that if the tool button has changed,</span>
<span class="cm">	 * the tools get reset.</span>
<span class="cm">	 */</span>
	<span class="cm">/* toolMode codes</span>
<span class="cm">	 */</span>
<span class="cp">#define AIPTEK_TOOL_BUTTON_PEN_MODE			BTN_TOOL_PEN</span>
<span class="cp">#define AIPTEK_TOOL_BUTTON_PENCIL_MODE			BTN_TOOL_PENCIL</span>
<span class="cp">#define AIPTEK_TOOL_BUTTON_BRUSH_MODE			BTN_TOOL_BRUSH</span>
<span class="cp">#define AIPTEK_TOOL_BUTTON_AIRBRUSH_MODE		BTN_TOOL_AIRBRUSH</span>
<span class="cp">#define AIPTEK_TOOL_BUTTON_ERASER_MODE			BTN_TOOL_RUBBER</span>
<span class="cp">#define AIPTEK_TOOL_BUTTON_MOUSE_MODE			BTN_TOOL_MOUSE</span>
<span class="cp">#define AIPTEK_TOOL_BUTTON_LENS_MODE			BTN_TOOL_LENS</span>

	<span class="cm">/* Diagnostic message codes</span>
<span class="cm">	 */</span>
<span class="cp">#define AIPTEK_DIAGNOSTIC_NA				0</span>
<span class="cp">#define AIPTEK_DIAGNOSTIC_SENDING_RELATIVE_IN_ABSOLUTE	1</span>
<span class="cp">#define AIPTEK_DIAGNOSTIC_SENDING_ABSOLUTE_IN_RELATIVE	2</span>
<span class="cp">#define AIPTEK_DIAGNOSTIC_TOOL_DISALLOWED		3</span>

	<span class="cm">/* Time to wait (in ms) to help mask hand jittering</span>
<span class="cm">	 * when pressing the stylus buttons.</span>
<span class="cm">	 */</span>
<span class="cp">#define AIPTEK_JITTER_DELAY_DEFAULT			50</span>

	<span class="cm">/* Time to wait (in ms) in-between sending the tablet</span>
<span class="cm">	 * a command and beginning the process of reading the return</span>
<span class="cm">	 * sequence from the tablet.</span>
<span class="cm">	 */</span>
<span class="cp">#define AIPTEK_PROGRAMMABLE_DELAY_25		25</span>
<span class="cp">#define AIPTEK_PROGRAMMABLE_DELAY_50		50</span>
<span class="cp">#define AIPTEK_PROGRAMMABLE_DELAY_100		100</span>
<span class="cp">#define AIPTEK_PROGRAMMABLE_DELAY_200		200</span>
<span class="cp">#define AIPTEK_PROGRAMMABLE_DELAY_300		300</span>
<span class="cp">#define AIPTEK_PROGRAMMABLE_DELAY_400		400</span>
<span class="cp">#define AIPTEK_PROGRAMMABLE_DELAY_DEFAULT	AIPTEK_PROGRAMMABLE_DELAY_400</span>

	<span class="cm">/* Mouse button programming</span>
<span class="cm">	 */</span>
<span class="cp">#define AIPTEK_MOUSE_LEFT_BUTTON		0x04</span>
<span class="cp">#define AIPTEK_MOUSE_RIGHT_BUTTON		0x08</span>
<span class="cp">#define AIPTEK_MOUSE_MIDDLE_BUTTON		0x10</span>

	<span class="cm">/* Stylus button programming</span>
<span class="cm">	 */</span>
<span class="cp">#define AIPTEK_STYLUS_LOWER_BUTTON		0x08</span>
<span class="cp">#define AIPTEK_STYLUS_UPPER_BUTTON		0x10</span>

	<span class="cm">/* Length of incoming packet from the tablet</span>
<span class="cm">	 */</span>
<span class="cp">#define AIPTEK_PACKET_LENGTH			8</span>

	<span class="cm">/* We report in EV_MISC both the proximity and</span>
<span class="cm">	 * whether the report came from the stylus, tablet mouse</span>
<span class="cm">	 * or &quot;unknown&quot; -- Unknown when the tablet is in relative</span>
<span class="cm">	 * mode, because we only get report 1&#39;s.</span>
<span class="cm">	 */</span>
<span class="cp">#define AIPTEK_REPORT_TOOL_UNKNOWN		0x10</span>
<span class="cp">#define AIPTEK_REPORT_TOOL_STYLUS		0x20</span>
<span class="cp">#define AIPTEK_REPORT_TOOL_MOUSE		0x40</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">programmableDelay</span> <span class="o">=</span> <span class="n">AIPTEK_PROGRAMMABLE_DELAY_DEFAULT</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">jitterDelay</span> <span class="o">=</span> <span class="n">AIPTEK_JITTER_DELAY_DEFAULT</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">aiptek_features</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">odmCode</span><span class="p">;</span>		<span class="cm">/* Tablet manufacturer code       */</span>
	<span class="kt">int</span> <span class="n">modelCode</span><span class="p">;</span>		<span class="cm">/* Tablet model code (not unique) */</span>
	<span class="kt">int</span> <span class="n">firmwareCode</span><span class="p">;</span>	<span class="cm">/* prom/eeprom version            */</span>
	<span class="kt">char</span> <span class="n">usbPath</span><span class="p">[</span><span class="mi">64</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>	<span class="cm">/* device&#39;s physical usb path     */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">aiptek_settings</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">pointerMode</span><span class="p">;</span>	<span class="cm">/* stylus-, mouse-only or either */</span>
	<span class="kt">int</span> <span class="n">coordinateMode</span><span class="p">;</span>	<span class="cm">/* absolute/relative coords      */</span>
	<span class="kt">int</span> <span class="n">toolMode</span><span class="p">;</span>		<span class="cm">/* pen, pencil, brush, etc. tool */</span>
	<span class="kt">int</span> <span class="n">xTilt</span><span class="p">;</span>		<span class="cm">/* synthetic xTilt amount        */</span>
	<span class="kt">int</span> <span class="n">yTilt</span><span class="p">;</span>		<span class="cm">/* synthetic yTilt amount        */</span>
	<span class="kt">int</span> <span class="n">wheel</span><span class="p">;</span>		<span class="cm">/* synthetic wheel amount        */</span>
	<span class="kt">int</span> <span class="n">stylusButtonUpper</span><span class="p">;</span>	<span class="cm">/* stylus upper btn delivers...  */</span>
	<span class="kt">int</span> <span class="n">stylusButtonLower</span><span class="p">;</span>	<span class="cm">/* stylus lower btn delivers...  */</span>
	<span class="kt">int</span> <span class="n">mouseButtonLeft</span><span class="p">;</span>	<span class="cm">/* mouse left btn delivers...    */</span>
	<span class="kt">int</span> <span class="n">mouseButtonMiddle</span><span class="p">;</span>	<span class="cm">/* mouse middle btn delivers...  */</span>
	<span class="kt">int</span> <span class="n">mouseButtonRight</span><span class="p">;</span>	<span class="cm">/* mouse right btn delivers...   */</span>
	<span class="kt">int</span> <span class="n">programmableDelay</span><span class="p">;</span>	<span class="cm">/* delay for tablet programming  */</span>
	<span class="kt">int</span> <span class="n">jitterDelay</span><span class="p">;</span>	<span class="cm">/* delay for hand jittering      */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">aiptek</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">inputdev</span><span class="p">;</span>		<span class="cm">/* input device struct           */</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">;</span>		<span class="cm">/* usb device struct             */</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">;</span>		<span class="cm">/* usb interface struct          */</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>			<span class="cm">/* urb for incoming reports      */</span>
	<span class="n">dma_addr_t</span> <span class="n">data_dma</span><span class="p">;</span>			<span class="cm">/* our dma stuffage              */</span>
	<span class="k">struct</span> <span class="n">aiptek_features</span> <span class="n">features</span><span class="p">;</span>	<span class="cm">/* tablet&#39;s array of features    */</span>
	<span class="k">struct</span> <span class="n">aiptek_settings</span> <span class="n">curSetting</span><span class="p">;</span>	<span class="cm">/* tablet&#39;s current programmable */</span>
	<span class="k">struct</span> <span class="n">aiptek_settings</span> <span class="n">newSetting</span><span class="p">;</span>	<span class="cm">/* ... and new param settings    */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ifnum</span><span class="p">;</span>			<span class="cm">/* interface number for IO       */</span>
	<span class="kt">int</span> <span class="n">diagnostic</span><span class="p">;</span>				<span class="cm">/* tablet diagnostic codes       */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">eventCount</span><span class="p">;</span>		<span class="cm">/* event count                   */</span>
	<span class="kt">int</span> <span class="n">inDelay</span><span class="p">;</span>				<span class="cm">/* jitter: in jitter delay?      */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">endDelay</span><span class="p">;</span>			<span class="cm">/* jitter: time when delay ends  */</span>
	<span class="kt">int</span> <span class="n">previousJitterable</span><span class="p">;</span>			<span class="cm">/* jitterable prev value     */</span>

	<span class="kt">int</span> <span class="n">lastMacro</span><span class="p">;</span>				<span class="cm">/* macro key to reset            */</span>
	<span class="kt">int</span> <span class="n">previousToolMode</span><span class="p">;</span>			<span class="cm">/* pen, pencil, brush, etc. tool */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>			<span class="cm">/* incoming packet data          */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">eventTypes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">EV_ABS</span><span class="p">,</span> <span class="n">EV_REL</span><span class="p">,</span> <span class="n">EV_MSC</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">absEvents</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">ABS_X</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="n">ABS_TILT_X</span><span class="p">,</span> <span class="n">ABS_TILT_Y</span><span class="p">,</span>
        <span class="n">ABS_WHEEL</span><span class="p">,</span> <span class="n">ABS_MISC</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">relEvents</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">REL_X</span><span class="p">,</span> <span class="n">REL_Y</span><span class="p">,</span> <span class="n">REL_WHEEL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">buttonEvents</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">BTN_MIDDLE</span><span class="p">,</span>
	<span class="n">BTN_TOOL_PEN</span><span class="p">,</span> <span class="n">BTN_TOOL_RUBBER</span><span class="p">,</span> <span class="n">BTN_TOOL_PENCIL</span><span class="p">,</span> <span class="n">BTN_TOOL_AIRBRUSH</span><span class="p">,</span>
	<span class="n">BTN_TOOL_BRUSH</span><span class="p">,</span> <span class="n">BTN_TOOL_MOUSE</span><span class="p">,</span> <span class="n">BTN_TOOL_LENS</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span>
	<span class="n">BTN_STYLUS</span><span class="p">,</span> <span class="n">BTN_STYLUS2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Permit easy lookup of keyboard events to send, versus</span>
<span class="cm"> * the bitmap which comes from the tablet. This hides the</span>
<span class="cm"> * issue that the F_keys are not sequentially numbered.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">macroKeyEvents</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">KEY_ESC</span><span class="p">,</span> <span class="n">KEY_F1</span><span class="p">,</span> <span class="n">KEY_F2</span><span class="p">,</span> <span class="n">KEY_F3</span><span class="p">,</span> <span class="n">KEY_F4</span><span class="p">,</span> <span class="n">KEY_F5</span><span class="p">,</span>
	<span class="n">KEY_F6</span><span class="p">,</span> <span class="n">KEY_F7</span><span class="p">,</span> <span class="n">KEY_F8</span><span class="p">,</span> <span class="n">KEY_F9</span><span class="p">,</span> <span class="n">KEY_F10</span><span class="p">,</span> <span class="n">KEY_F11</span><span class="p">,</span>
	<span class="n">KEY_F12</span><span class="p">,</span> <span class="n">KEY_F13</span><span class="p">,</span> <span class="n">KEY_F14</span><span class="p">,</span> <span class="n">KEY_F15</span><span class="p">,</span> <span class="n">KEY_F16</span><span class="p">,</span> <span class="n">KEY_F17</span><span class="p">,</span>
	<span class="n">KEY_F18</span><span class="p">,</span> <span class="n">KEY_F19</span><span class="p">,</span> <span class="n">KEY_F20</span><span class="p">,</span> <span class="n">KEY_F21</span><span class="p">,</span> <span class="n">KEY_F22</span><span class="p">,</span> <span class="n">KEY_F23</span><span class="p">,</span>
	<span class="n">KEY_F24</span><span class="p">,</span> <span class="n">KEY_STOP</span><span class="p">,</span> <span class="n">KEY_AGAIN</span><span class="p">,</span> <span class="n">KEY_PROPS</span><span class="p">,</span> <span class="n">KEY_UNDO</span><span class="p">,</span>
	<span class="n">KEY_FRONT</span><span class="p">,</span> <span class="n">KEY_COPY</span><span class="p">,</span> <span class="n">KEY_OPEN</span><span class="p">,</span> <span class="n">KEY_PASTE</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * Map values to strings and back. Every map should have the following</span>
<span class="cm"> * as its last element: { NULL, AIPTEK_INVALID_VALUE }.</span>
<span class="cm"> */</span>
<span class="cp">#define AIPTEK_INVALID_VALUE	-1</span>

<span class="k">struct</span> <span class="n">aiptek_map</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">map_str_to_val</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">aiptek_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">aiptek_map</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">map</span><span class="p">;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
	        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">AIPTEK_INVALID_VALUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">map_val_to_str</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">aiptek_map</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">aiptek_map</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">map</span><span class="p">;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">!=</span> <span class="n">AIPTEK_INVALID_VALUE</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">;</span>

	<span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * aiptek_irq can receive one of six potential reports.</span>
<span class="cm"> * The documentation for each is in the body of the function.</span>
<span class="cm"> *</span>
<span class="cm"> * The tablet reports on several attributes per invocation of</span>
<span class="cm"> * aiptek_irq. Because the Linux Input Event system allows the</span>
<span class="cm"> * transmission of ONE attribute per input_report_xxx() call,</span>
<span class="cm"> * collation has to be done on the other end to reconstitute</span>
<span class="cm"> * a complete tablet report. Further, the number of Input Event reports</span>
<span class="cm"> * submitted varies, depending on what USB report type, and circumstance.</span>
<span class="cm"> * To deal with this, EV_MSC is used to indicate an &#39;end-of-report&#39;</span>
<span class="cm"> * message. This has been an undocumented convention understood by the kernel</span>
<span class="cm"> * tablet driver and clients such as gpm and XFree86&#39;s tablet drivers.</span>
<span class="cm"> *</span>
<span class="cm"> * Of the information received from the tablet, the one piece I</span>
<span class="cm"> * cannot transmit is the proximity bit (without resorting to an EV_MSC</span>
<span class="cm"> * convention above.) I therefore have taken over REL_MISC and ABS_MISC</span>
<span class="cm"> * (for relative and absolute reports, respectively) for communicating</span>
<span class="cm"> * Proximity. Why two events? I thought it interesting to know if the</span>
<span class="cm"> * Proximity event occurred while the tablet was in absolute or relative</span>
<span class="cm"> * mode.</span>
<span class="cm"> * Update: REL_MISC proved not to be such a good idea. With REL_MISC you</span>
<span class="cm"> * get an event transmitted each time. ABS_MISC works better, since it</span>
<span class="cm"> * can be set and re-set. Thus, only using ABS_MISC from now on.</span>
<span class="cm"> *</span>
<span class="cm"> * Other tablets use the notion of a certain minimum stylus pressure</span>
<span class="cm"> * to infer proximity. While that could have been done, that is yet</span>
<span class="cm"> * another &#39;by convention&#39; behavior, the documentation for which</span>
<span class="cm"> * would be spread between two (or more) pieces of software.</span>
<span class="cm"> *</span>
<span class="cm"> * EV_MSC usage was terminated for this purpose in Linux 2.5.x, and</span>
<span class="cm"> * replaced with the input_sync() method (which emits EV_SYN.)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">aiptek_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">inputdev</span> <span class="o">=</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">jitterable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">macro</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">middle</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">tip</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">pck</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* Success */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* This urb is terminated, clean up */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - urb shutting down with status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s - nonzero urb status received: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* See if we are in a delay loop -- throw out report if true.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">inDelay</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">endDelay</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">inDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">eventCount</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Report 1 delivers relative coordinates with either a stylus</span>
<span class="cm">	 * or the mouse. You do not know, however, which input</span>
<span class="cm">	 * tool generated the event.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">coordinateMode</span> <span class="o">==</span>
		    <span class="n">AIPTEK_COORDINATE_ABSOLUTE_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">diagnostic</span> <span class="o">=</span>
			    <span class="n">AIPTEK_DIAGNOSTIC_SENDING_RELATIVE_IN_ABSOLUTE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">char</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

			<span class="cm">/* jitterable keeps track of whether any button has been pressed.</span>
<span class="cm">			 * We&#39;re also using it to remap the physical mouse button mask</span>
<span class="cm">			 * to pseudo-settings. (We don&#39;t specifically care about it&#39;s</span>
<span class="cm">			 * value after moving/transposing mouse button bitmasks, except</span>
<span class="cm">			 * that a non-zero value indicates that one or more</span>
<span class="cm">			 * mouse button was pressed.)</span>
<span class="cm">			 */</span>
			<span class="n">jitterable</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>

			<span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">mouseButtonLeft</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">mouseButtonRight</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">middle</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">mouseButtonMiddle</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">middle</span><span class="p">);</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>

			<span class="n">input_report_abs</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_MISC</span><span class="p">,</span>
					 <span class="mi">1</span> <span class="o">|</span> <span class="n">AIPTEK_REPORT_TOOL_UNKNOWN</span><span class="p">);</span>
			<span class="n">input_report_rel</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">REL_X</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
			<span class="n">input_report_rel</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">REL_Y</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>

			<span class="cm">/* Wheel support is in the form of a single-event</span>
<span class="cm">			 * firing.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">wheel</span> <span class="o">!=</span> <span class="n">AIPTEK_WHEEL_DISABLE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">input_report_rel</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">REL_WHEEL</span><span class="p">,</span>
						 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">wheel</span><span class="p">);</span>
				<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">wheel</span> <span class="o">=</span> <span class="n">AIPTEK_WHEEL_DISABLE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			        <span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
						 <span class="n">macroKeyEvents</span><span class="p">[</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">inputdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Report 2 is delivered only by the stylus, and delivers</span>
<span class="cm">	 * absolute coordinates.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">coordinateMode</span> <span class="o">==</span> <span class="n">AIPTEK_COORDINATE_RELATIVE_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">diagnostic</span> <span class="o">=</span> <span class="n">AIPTEK_DIAGNOSTIC_SENDING_ABSOLUTE_IN_RELATIVE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AIPTEK_POINTER_ALLOW_STYLUS_MODE</span>
			    <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">pointerMode</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">diagnostic</span> <span class="o">=</span> <span class="n">AIPTEK_DIAGNOSTIC_TOOL_DISALLOWED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">y</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">z</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>

			<span class="n">dv</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tip</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* Use jitterable to re-arrange button masks</span>
<span class="cm">			 */</span>
			<span class="n">jitterable</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">;</span>

			<span class="n">bs</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">stylusButtonLower</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pck</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">stylusButtonUpper</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* dv indicates &#39;data valid&#39; (e.g., the tablet is in sync</span>
<span class="cm">			 * and has delivered a &quot;correct&quot; report) We will ignore</span>
<span class="cm">			 * all &#39;bad&#39; reports...</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dv</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* If the selected tool changed, reset the old</span>
<span class="cm">				 * tool key, and set the new one.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousToolMode</span> <span class="o">!=</span>
				    <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span><span class="p">)</span> <span class="p">{</span>
				        <span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
							 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousToolMode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
							 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span><span class="p">,</span>
							 <span class="mi">1</span><span class="p">);</span>
					<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousToolMode</span> <span class="o">=</span>
					          <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">input_report_abs</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
					<span class="n">input_report_abs</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
					<span class="n">input_report_abs</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>

					<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">BTN_TOUCH</span><span class="p">,</span> <span class="n">tip</span><span class="p">);</span>
					<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">BTN_STYLUS</span><span class="p">,</span> <span class="n">bs</span><span class="p">);</span>
					<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">BTN_STYLUS2</span><span class="p">,</span> <span class="n">pck</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">xTilt</span> <span class="o">!=</span>
					    <span class="n">AIPTEK_TILT_DISABLE</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">input_report_abs</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
								 <span class="n">ABS_TILT_X</span><span class="p">,</span>
								 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">xTilt</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">yTilt</span> <span class="o">!=</span> <span class="n">AIPTEK_TILT_DISABLE</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">input_report_abs</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
								 <span class="n">ABS_TILT_Y</span><span class="p">,</span>
								 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">yTilt</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="cm">/* Wheel support is in the form of a single-event</span>
<span class="cm">					 * firing.</span>
<span class="cm">					 */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">wheel</span> <span class="o">!=</span>
					    <span class="n">AIPTEK_WHEEL_DISABLE</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">input_report_abs</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
								 <span class="n">ABS_WHEEL</span><span class="p">,</span>
								 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">wheel</span><span class="p">);</span>
						<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">wheel</span> <span class="o">=</span> <span class="n">AIPTEK_WHEEL_DISABLE</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">input_report_abs</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_MISC</span><span class="p">,</span> <span class="n">p</span> <span class="o">|</span> <span class="n">AIPTEK_REPORT_TOOL_STYLUS</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			                <span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
							 <span class="n">macroKeyEvents</span><span class="p">[</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">input_sync</span><span class="p">(</span><span class="n">inputdev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Report 3&#39;s come from the mouse in absolute mode.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">coordinateMode</span> <span class="o">==</span> <span class="n">AIPTEK_COORDINATE_RELATIVE_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">diagnostic</span> <span class="o">=</span> <span class="n">AIPTEK_DIAGNOSTIC_SENDING_ABSOLUTE_IN_RELATIVE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AIPTEK_POINTER_ALLOW_MOUSE_MODE</span>
			<span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">pointerMode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">diagnostic</span> <span class="o">=</span> <span class="n">AIPTEK_DIAGNOSTIC_TOOL_DISALLOWED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">y</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>

			<span class="n">jitterable</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1c</span><span class="p">;</span>

			<span class="n">dv</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">mouseButtonLeft</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">mouseButtonRight</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">middle</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">mouseButtonMiddle</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dv</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* If the selected tool changed, reset the old</span>
<span class="cm">				 * tool key, and set the new one.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousToolMode</span> <span class="o">!=</span>
				    <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span><span class="p">)</span> <span class="p">{</span>
				        <span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
							 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousToolMode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
							 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span><span class="p">,</span>
							 <span class="mi">1</span><span class="p">);</span>
					<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousToolMode</span> <span class="o">=</span>
					          <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">input_report_abs</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
					<span class="n">input_report_abs</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>

					<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
					<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="n">middle</span><span class="p">);</span>
					<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>

					<span class="cm">/* Wheel support is in the form of a single-event</span>
<span class="cm">					 * firing.</span>
<span class="cm">					 */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">wheel</span> <span class="o">!=</span> <span class="n">AIPTEK_WHEEL_DISABLE</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">input_report_abs</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
								 <span class="n">ABS_WHEEL</span><span class="p">,</span>
								 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">wheel</span><span class="p">);</span>
						<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">wheel</span> <span class="o">=</span> <span class="n">AIPTEK_WHEEL_DISABLE</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">input_report_abs</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_MISC</span><span class="p">,</span> <span class="n">p</span> <span class="o">|</span> <span class="n">AIPTEK_REPORT_TOOL_MOUSE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			                <span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
							 <span class="n">macroKeyEvents</span><span class="p">[</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
				        <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">input_sync</span><span class="p">(</span><span class="n">inputdev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Report 4s come from the macro keys when pressed by stylus</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jitterable</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">;</span>

		<span class="n">dv</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tip</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bs</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">stylusButtonLower</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pck</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">stylusButtonUpper</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">macro</span> <span class="o">=</span> <span class="n">dv</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">tip</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">z</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dv</span><span class="p">)</span> <span class="p">{</span>
		        <span class="cm">/* If the selected tool changed, reset the old</span>
<span class="cm">			 * tool key, and set the new one.</span>
<span class="cm">			 */</span>
		        <span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousToolMode</span> <span class="o">!=</span>
			    <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span><span class="p">)</span> <span class="p">{</span>
			        <span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
						 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousToolMode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
						 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span><span class="p">,</span>
						 <span class="mi">1</span><span class="p">);</span>
				<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousToolMode</span> <span class="o">=</span>
				        <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span> <span class="o">!=</span> <span class="n">macro</span><span class="p">)</span> <span class="p">{</span>
		        <span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">macroKeyEvents</span><span class="p">[</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">macro</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">macro</span> <span class="o">!=</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">macroKeyEvents</span><span class="p">[</span><span class="n">macro</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span> <span class="o">=</span> <span class="n">macro</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_MISC</span><span class="p">,</span>
				 <span class="n">p</span> <span class="o">|</span> <span class="n">AIPTEK_REPORT_TOOL_STYLUS</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">inputdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Report 5s come from the macro keys when pressed by mouse</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jitterable</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1c</span><span class="p">;</span>

		<span class="n">dv</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&amp;</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">mouseButtonLeft</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">mouseButtonRight</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">middle</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">mouseButtonMiddle</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">macro</span> <span class="o">=</span> <span class="n">dv</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">left</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dv</span><span class="p">)</span> <span class="p">{</span>
		        <span class="cm">/* If the selected tool changed, reset the old</span>
<span class="cm">			 * tool key, and set the new one.</span>
<span class="cm">			 */</span>
		        <span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousToolMode</span> <span class="o">!=</span>
			    <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span><span class="p">)</span> <span class="p">{</span>
		                <span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
						 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousToolMode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			        <span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
						 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			        <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousToolMode</span> <span class="o">=</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span> <span class="o">!=</span> <span class="n">macro</span><span class="p">)</span> <span class="p">{</span>
		        <span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">macroKeyEvents</span><span class="p">[</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">macro</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">macro</span> <span class="o">!=</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">macroKeyEvents</span><span class="p">[</span><span class="n">macro</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span> <span class="o">=</span> <span class="n">macro</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_MISC</span><span class="p">,</span>
				 <span class="n">p</span> <span class="o">|</span> <span class="n">AIPTEK_REPORT_TOOL_MOUSE</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">inputdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* We have no idea which tool can generate a report 6. Theoretically,</span>
<span class="cm">	 * neither need to, having been given reports 4 &amp; 5 for such use.</span>
<span class="cm">	 * However, report 6 is the &#39;official-looking&#39; report for macroKeys;</span>
<span class="cm">	 * reports 4 &amp; 5 supposively are used to support unnamed, unknown</span>
<span class="cm">	 * hat switches (which just so happen to be the macroKeys.)</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">macro</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">macro</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">macroKeyEvents</span><span class="p">[</span><span class="n">macro</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
					 <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">macro</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">macroKeyEvents</span><span class="p">[</span><span class="n">macro</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
					 <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* If the selected tool changed, reset the old</span>
<span class="cm">		   tool key, and set the new one.</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousToolMode</span> <span class="o">!=</span>
		    <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span><span class="p">)</span> <span class="p">{</span>
		        <span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
					 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousToolMode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span>
					 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span><span class="p">,</span>
					 <span class="mi">1</span><span class="p">);</span>
			<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousToolMode</span> <span class="o">=</span>
				<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">input_report_key</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">macroKeyEvents</span><span class="p">[</span><span class="n">macro</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_MISC</span><span class="p">,</span>
				 <span class="mi">1</span> <span class="o">|</span> <span class="n">AIPTEK_REPORT_TOOL_UNKNOWN</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">inputdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown report %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* Jitter may occur when the user presses a button on the stlyus</span>
<span class="cm">	 * or the mouse. What we do to prevent that is wait &#39;x&#39; milliseconds</span>
<span class="cm">	 * following a &#39;jitterable&#39; event, which should give the hand some time</span>
<span class="cm">	 * stabilize itself.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We just introduced aiptek-&gt;previousJitterable to carry forth the</span>
<span class="cm">	 * notion that jitter occurs when the button state changes from on to off:</span>
<span class="cm">	 * a person drawing, holding a button down is not subject to jittering.</span>
<span class="cm">	 * With that in mind, changing from upper button depressed to lower button</span>
<span class="cm">	 * WILL transition through a jitter delay.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousJitterable</span> <span class="o">!=</span> <span class="n">jitterable</span> <span class="o">&amp;&amp;</span>
	    <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">jitterDelay</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">inDelay</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">endDelay</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
		    <span class="p">((</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">jitterDelay</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">inDelay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousJitterable</span> <span class="o">=</span> <span class="n">jitterable</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s - usb_submit_urb failed with result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * These are the USB id&#39;s known so far. We do not identify them to</span>
<span class="cm"> * specific Aiptek model numbers, because there has been overlaps,</span>
<span class="cm"> * use, and reuse of id&#39;s in existing models. Certain models have</span>
<span class="cm"> * been known to use more than one ID, indicative perhaps of</span>
<span class="cm"> * manufacturing revisions. In any event, we consider these</span>
<span class="cm"> * IDs to not be model-specific nor unique.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">aiptek_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_AIPTEK</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_AIPTEK</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_AIPTEK</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_AIPTEK</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_AIPTEK</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_AIPTEK</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_AIPTEK</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_VENDOR_ID_KYE</span><span class="p">,</span> <span class="mh">0x5003</span><span class="p">)},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">aiptek_ids</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * Open an instance of the tablet driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aiptek_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">inputdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">inputdev</span><span class="p">);</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * Close an instance of the tablet driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">aiptek_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">inputdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">inputdev</span><span class="p">);</span>

	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * aiptek_set_report and aiptek_get_report() are borrowed from Linux 2.4.x,</span>
<span class="cm"> * where they were known as usb_set_report and usb_get_report.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aiptek_set_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">report_type</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">report_id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
			       <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="n">USB_REQ_SET_REPORT</span><span class="p">,</span>
			       <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span> <span class="o">|</span>
			       <span class="n">USB_DIR_OUT</span><span class="p">,</span> <span class="p">(</span><span class="n">report_type</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">report_id</span><span class="p">,</span>
			       <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">ifnum</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aiptek_get_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">report_type</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">report_id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
			       <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="n">USB_REQ_GET_REPORT</span><span class="p">,</span>
			       <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span> <span class="o">|</span>
			       <span class="n">USB_DIR_IN</span><span class="p">,</span> <span class="p">(</span><span class="n">report_type</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">report_id</span><span class="p">,</span>
			       <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">ifnum</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * Send a command to the tablet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aiptek_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">command</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">sizeof_buf</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">sizeof_buf</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span>
	     <span class="n">aiptek_set_report</span><span class="p">(</span><span class="n">aiptek</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">sizeof_buf</span><span class="p">))</span> <span class="o">!=</span> <span class="n">sizeof_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;aiptek_program: failed, tried to send: 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">command</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * Retrieve information from the tablet. Querying info is defined as first</span>
<span class="cm"> * sending the {command,data} sequence as a command, followed by a wait</span>
<span class="cm"> * (aka, &quot;programmaticDelay&quot;) and then a &quot;read&quot; request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aiptek_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">command</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">sizeof_buf</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">sizeof_buf</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aiptek_command</span><span class="p">(</span><span class="n">aiptek</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">programmableDelay</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span>
	     <span class="n">aiptek_get_report</span><span class="p">(</span><span class="n">aiptek</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">sizeof_buf</span><span class="p">))</span> <span class="o">!=</span> <span class="n">sizeof_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;aiptek_query failed: returned 0x%02x 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * Program the tablet into either absolute or relative mode.</span>
<span class="cm"> * We also get information about the tablet&#39;s size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aiptek_program_tablet</span><span class="p">(</span><span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/* Execute Resolution500LPI */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">aiptek_command</span><span class="p">(</span><span class="n">aiptek</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Query getModelCode */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">aiptek_query</span><span class="p">(</span><span class="n">aiptek</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">modelCode</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* Query getODMCode */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">aiptek_query</span><span class="p">(</span><span class="n">aiptek</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">odmCode</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Query getFirmwareCode */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">aiptek_query</span><span class="p">(</span><span class="n">aiptek</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">firmwareCode</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Query getXextension */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">aiptek_query</span><span class="p">(</span><span class="n">aiptek</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Query getYextension */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">aiptek_query</span><span class="p">(</span><span class="n">aiptek</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Query getPressureLevels */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">aiptek_query</span><span class="p">(</span><span class="n">aiptek</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Depending on whether we are in absolute or relative mode, we will</span>
<span class="cm">	 * do a switchToTablet(absolute) or switchToMouse(relative) command.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">coordinateMode</span> <span class="o">==</span>
	    <span class="n">AIPTEK_COORDINATE_ABSOLUTE_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Execute switchToTablet */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">aiptek_command</span><span class="p">(</span><span class="n">aiptek</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Execute switchToMouse */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">aiptek_command</span><span class="p">(</span><span class="n">aiptek</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Enable the macro keys */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">aiptek_command</span><span class="p">(</span><span class="n">aiptek</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* Execute FilterOn */</span>
<span class="c">	if ((ret = aiptek_command(aiptek, 0x17, 0x00)) &lt; 0)</span>
<span class="c">		return ret;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Execute AutoGainOn */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">aiptek_command</span><span class="p">(</span><span class="n">aiptek</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Reset the eventCount, so we track events from last (re)programming</span>
<span class="cm">	 */</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">diagnostic</span> <span class="o">=</span> <span class="n">AIPTEK_DIAGNOSTIC_NA</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">eventCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * Sysfs functions. Sysfs prefers that individually-tunable parameters</span>
<span class="cm"> * exist in their separate pseudo-files. Summary data that is immutable</span>
<span class="cm"> * may exist in a singular file so long as you don&#39;t define a writeable</span>
<span class="cm"> * interface.</span>
<span class="cm"> */</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support the &#39;size&#39; file -- display support</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletSize</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">input_abs_get_max</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">input_abs_get_max</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* These structs define the sysfs files, param #1 is the name of the</span>
<span class="cm"> * file, param 2 is the file permissions, param 3 &amp; 4 are to the</span>
<span class="cm"> * output generator and input parser routines. Absence of a routine is</span>
<span class="cm"> * permitted -- it only means can&#39;t either &#39;cat&#39; the file, or send data</span>
<span class="cm"> * to it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_tabletSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;pointer_mode&#39; file. Note that this file</span>
<span class="cm"> * both displays current setting and allows reprogramming.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">aiptek_map</span> <span class="n">pointer_mode_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;stylus&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_POINTER_ONLY_STYLUS_MODE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;mouse&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_POINTER_ONLY_MOUSE_MODE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;either&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_POINTER_EITHER_MODE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="n">AIPTEK_INVALID_VALUE</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletPointerMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">map_val_to_str</span><span class="p">(</span><span class="n">pointer_mode_map</span><span class="p">,</span>
					<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">pointerMode</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_tabletPointerMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">new_mode</span> <span class="o">=</span> <span class="n">map_str_to_val</span><span class="p">(</span><span class="n">pointer_mode_map</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">AIPTEK_INVALID_VALUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span><span class="p">.</span><span class="n">pointerMode</span> <span class="o">=</span> <span class="n">new_mode</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">pointer_mode</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_tabletPointerMode</span><span class="p">,</span> <span class="n">store_tabletPointerMode</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;coordinate_mode&#39; file. Note that this file</span>
<span class="cm"> * both displays current setting and allows reprogramming.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">aiptek_map</span> <span class="n">coordinate_mode_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;absolute&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_COORDINATE_ABSOLUTE_MODE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;relative&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_COORDINATE_RELATIVE_MODE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="n">AIPTEK_INVALID_VALUE</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletCoordinateMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">map_val_to_str</span><span class="p">(</span><span class="n">coordinate_mode_map</span><span class="p">,</span>
					<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">coordinateMode</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_tabletCoordinateMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">new_mode</span> <span class="o">=</span> <span class="n">map_str_to_val</span><span class="p">(</span><span class="n">coordinate_mode_map</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">AIPTEK_INVALID_VALUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span><span class="p">.</span><span class="n">coordinateMode</span> <span class="o">=</span> <span class="n">new_mode</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">coordinate_mode</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_tabletCoordinateMode</span><span class="p">,</span> <span class="n">store_tabletCoordinateMode</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;tool_mode&#39; file. Note that this file</span>
<span class="cm"> * both displays current setting and allows reprogramming.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">aiptek_map</span> <span class="n">tool_mode_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;mouse&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_TOOL_BUTTON_MOUSE_MODE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;eraser&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_TOOL_BUTTON_ERASER_MODE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;pencil&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_TOOL_BUTTON_PENCIL_MODE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;pen&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_TOOL_BUTTON_PEN_MODE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;brush&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_TOOL_BUTTON_BRUSH_MODE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;airbrush&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_TOOL_BUTTON_AIRBRUSH_MODE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;lens&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_TOOL_BUTTON_LENS_MODE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="n">AIPTEK_INVALID_VALUE</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletToolMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">map_val_to_str</span><span class="p">(</span><span class="n">tool_mode_map</span><span class="p">,</span>
					<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_tabletToolMode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">new_mode</span> <span class="o">=</span> <span class="n">map_str_to_val</span><span class="p">(</span><span class="n">tool_mode_map</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">AIPTEK_INVALID_VALUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span><span class="p">.</span><span class="n">toolMode</span> <span class="o">=</span> <span class="n">new_mode</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">tool_mode</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_tabletToolMode</span><span class="p">,</span> <span class="n">store_tabletToolMode</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;xtilt&#39; file. Note that this file</span>
<span class="cm"> * both displays current setting and allows reprogramming.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletXtilt</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">xTilt</span> <span class="o">==</span> <span class="n">AIPTEK_TILT_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">xTilt</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_tabletXtilt</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">?</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;disable&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span><span class="p">.</span><span class="n">xTilt</span> <span class="o">=</span> <span class="n">AIPTEK_TILT_DISABLE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">AIPTEK_TILT_MIN</span> <span class="o">||</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">AIPTEK_TILT_MAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span><span class="p">.</span><span class="n">xTilt</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">xtilt</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_tabletXtilt</span><span class="p">,</span> <span class="n">store_tabletXtilt</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;ytilt&#39; file. Note that this file</span>
<span class="cm"> * both displays current setting and allows reprogramming.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletYtilt</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">yTilt</span> <span class="o">==</span> <span class="n">AIPTEK_TILT_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">yTilt</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_tabletYtilt</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">y</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kstrtoint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">?</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;disable&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span><span class="p">.</span><span class="n">yTilt</span> <span class="o">=</span> <span class="n">AIPTEK_TILT_DISABLE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">AIPTEK_TILT_MIN</span> <span class="o">||</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">AIPTEK_TILT_MAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span><span class="p">.</span><span class="n">yTilt</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ytilt</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_tabletYtilt</span><span class="p">,</span> <span class="n">store_tabletYtilt</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;jitter&#39; file. Note that this file</span>
<span class="cm"> * both displays current setting and allows reprogramming.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletJitterDelay</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">jitterDelay</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_tabletJitterDelay</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">j</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span><span class="p">.</span><span class="n">jitterDelay</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">jitter</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_tabletJitterDelay</span><span class="p">,</span> <span class="n">store_tabletJitterDelay</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;delay&#39; file. Note that this file</span>
<span class="cm"> * both displays current setting and allows reprogramming.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletProgrammableDelay</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">programmableDelay</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_tabletProgrammableDelay</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span><span class="p">.</span><span class="n">programmableDelay</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_tabletProgrammableDelay</span><span class="p">,</span> <span class="n">store_tabletProgrammableDelay</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;event_count&#39; file. Note that this file</span>
<span class="cm"> * only displays current setting.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletEventsReceived</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">eventCount</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">event_count</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_tabletEventsReceived</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;diagnostic&#39; file. Note that this file</span>
<span class="cm"> * only displays current setting.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletDiagnosticMessage</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">retMsg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">diagnostic</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AIPTEK_DIAGNOSTIC_NA</span>:
		<span class="n">retMsg</span> <span class="o">=</span> <span class="s">&quot;no errors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AIPTEK_DIAGNOSTIC_SENDING_RELATIVE_IN_ABSOLUTE</span>:
		<span class="n">retMsg</span> <span class="o">=</span> <span class="s">&quot;Error: receiving relative reports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AIPTEK_DIAGNOSTIC_SENDING_ABSOLUTE_IN_RELATIVE</span>:
		<span class="n">retMsg</span> <span class="o">=</span> <span class="s">&quot;Error: receiving absolute reports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AIPTEK_DIAGNOSTIC_TOOL_DISALLOWED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">pointerMode</span> <span class="o">==</span>
		    <span class="n">AIPTEK_POINTER_ONLY_MOUSE_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retMsg</span> <span class="o">=</span> <span class="s">&quot;Error: receiving stylus reports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retMsg</span> <span class="o">=</span> <span class="s">&quot;Error: receiving mouse reports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">retMsg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">diagnostic</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_tabletDiagnosticMessage</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;stylus_upper&#39; file. Note that this file</span>
<span class="cm"> * both displays current setting and allows for setting changing.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">aiptek_map</span> <span class="n">stylus_button_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;upper&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_STYLUS_UPPER_BUTTON</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;lower&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_STYLUS_LOWER_BUTTON</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="n">AIPTEK_INVALID_VALUE</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletStylusUpper</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">map_val_to_str</span><span class="p">(</span><span class="n">stylus_button_map</span><span class="p">,</span>
					<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">stylusButtonUpper</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_tabletStylusUpper</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">new_button</span> <span class="o">=</span> <span class="n">map_str_to_val</span><span class="p">(</span><span class="n">stylus_button_map</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_button</span> <span class="o">==</span> <span class="n">AIPTEK_INVALID_VALUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span><span class="p">.</span><span class="n">stylusButtonUpper</span> <span class="o">=</span> <span class="n">new_button</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">stylus_upper</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_tabletStylusUpper</span><span class="p">,</span> <span class="n">store_tabletStylusUpper</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;stylus_lower&#39; file. Note that this file</span>
<span class="cm"> * both displays current setting and allows for setting changing.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletStylusLower</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">map_val_to_str</span><span class="p">(</span><span class="n">stylus_button_map</span><span class="p">,</span>
					<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">stylusButtonLower</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_tabletStylusLower</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">new_button</span> <span class="o">=</span> <span class="n">map_str_to_val</span><span class="p">(</span><span class="n">stylus_button_map</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_button</span> <span class="o">==</span> <span class="n">AIPTEK_INVALID_VALUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span><span class="p">.</span><span class="n">stylusButtonLower</span> <span class="o">=</span> <span class="n">new_button</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">stylus_lower</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_tabletStylusLower</span><span class="p">,</span> <span class="n">store_tabletStylusLower</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;mouse_left&#39; file. Note that this file</span>
<span class="cm"> * both displays current setting and allows for setting changing.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">aiptek_map</span> <span class="n">mouse_button_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;left&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_MOUSE_LEFT_BUTTON</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;middle&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_MOUSE_MIDDLE_BUTTON</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;right&quot;</span><span class="p">,</span>	<span class="n">AIPTEK_MOUSE_RIGHT_BUTTON</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="n">AIPTEK_INVALID_VALUE</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletMouseLeft</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">map_val_to_str</span><span class="p">(</span><span class="n">mouse_button_map</span><span class="p">,</span>
					<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">mouseButtonLeft</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_tabletMouseLeft</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">new_button</span> <span class="o">=</span> <span class="n">map_str_to_val</span><span class="p">(</span><span class="n">mouse_button_map</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_button</span> <span class="o">==</span> <span class="n">AIPTEK_INVALID_VALUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span><span class="p">.</span><span class="n">mouseButtonLeft</span> <span class="o">=</span> <span class="n">new_button</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">mouse_left</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_tabletMouseLeft</span><span class="p">,</span> <span class="n">store_tabletMouseLeft</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;mouse_middle&#39; file. Note that this file</span>
<span class="cm"> * both displays current setting and allows for setting changing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletMouseMiddle</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">map_val_to_str</span><span class="p">(</span><span class="n">mouse_button_map</span><span class="p">,</span>
					<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">mouseButtonMiddle</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_tabletMouseMiddle</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">new_button</span> <span class="o">=</span> <span class="n">map_str_to_val</span><span class="p">(</span><span class="n">mouse_button_map</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_button</span> <span class="o">==</span> <span class="n">AIPTEK_INVALID_VALUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span><span class="p">.</span><span class="n">mouseButtonMiddle</span> <span class="o">=</span> <span class="n">new_button</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">mouse_middle</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_tabletMouseMiddle</span><span class="p">,</span> <span class="n">store_tabletMouseMiddle</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;mouse_right&#39; file. Note that this file</span>
<span class="cm"> * both displays current setting and allows for setting changing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletMouseRight</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">map_val_to_str</span><span class="p">(</span><span class="n">mouse_button_map</span><span class="p">,</span>
					<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">mouseButtonRight</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_tabletMouseRight</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">new_button</span> <span class="o">=</span> <span class="n">map_str_to_val</span><span class="p">(</span><span class="n">mouse_button_map</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_button</span> <span class="o">==</span> <span class="n">AIPTEK_INVALID_VALUE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span><span class="p">.</span><span class="n">mouseButtonRight</span> <span class="o">=</span> <span class="n">new_button</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">mouse_right</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_tabletMouseRight</span><span class="p">,</span> <span class="n">store_tabletMouseRight</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;wheel&#39; file. Note that this file</span>
<span class="cm"> * both displays current setting and allows for setting changing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletWheel</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">wheel</span> <span class="o">==</span> <span class="n">AIPTEK_WHEEL_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">wheel</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_tabletWheel</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">w</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kstrtoint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span><span class="p">.</span><span class="n">wheel</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wheel</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_tabletWheel</span><span class="p">,</span> <span class="n">store_tabletWheel</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;execute&#39; file. Note that this file</span>
<span class="cm"> * both displays current setting and allows for setting changing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletExecute</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* There is nothing useful to display, so a one-line manual</span>
<span class="cm">	 * is in order...</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
			<span class="s">&quot;Write anything to this file to program your tablet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">store_tabletExecute</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* We do not care what you write to this file. Merely the action</span>
<span class="cm">	 * of writing to this file triggers a tablet reprogramming.</span>
<span class="cm">	 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aiptek_settings</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aiptek_program_tablet</span><span class="p">(</span><span class="n">aiptek</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">execute</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_tabletExecute</span><span class="p">,</span> <span class="n">store_tabletExecute</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;odm_code&#39; file. Note that this file</span>
<span class="cm"> * only displays current setting.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletODMCode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">odmCode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">odm_code</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_tabletODMCode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;model_code&#39; file. Note that this file</span>
<span class="cm"> * only displays current setting.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tabletModelCode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">modelCode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">model_code</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_tabletModelCode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * support routines for the &#39;firmware_code&#39; file. Note that this file</span>
<span class="cm"> * only displays current setting.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_firmwareCode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">firmwareCode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">firmware_code</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_firmwareCode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">aiptek_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_size</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_pointer_mode</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_coordinate_mode</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tool_mode</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_xtilt</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ytilt</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_jitter</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_delay</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_event_count</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_diagnostic</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_odm_code</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_model_code</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_firmware_code</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stylus_lower</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_stylus_upper</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_mouse_left</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_mouse_middle</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_mouse_right</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wheel</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_execute</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">aiptek_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span>	<span class="o">=</span> <span class="n">aiptek_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * This routine is called when a tablet has been identified. It basically</span>
<span class="cm"> * sets up the tablet and the driver&#39;s internal structures.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">aiptek_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">inputdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">speeds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">AIPTEK_PROGRAMMABLE_DELAY_50</span><span class="p">,</span>
		<span class="n">AIPTEK_PROGRAMMABLE_DELAY_400</span><span class="p">,</span>
		<span class="n">AIPTEK_PROGRAMMABLE_DELAY_25</span><span class="p">,</span>
		<span class="n">AIPTEK_PROGRAMMABLE_DELAY_100</span><span class="p">,</span>
		<span class="n">AIPTEK_PROGRAMMABLE_DELAY_200</span><span class="p">,</span>
		<span class="n">AIPTEK_PROGRAMMABLE_DELAY_300</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* programmableDelay is where the command-line specified</span>
<span class="cm">	 * delay is kept. We make it the first element of speeds[],</span>
<span class="cm">	 * so therefore, your override speed is tried first, then the</span>
<span class="cm">	 * remainder. Note that the default value of 400ms will be tried</span>
<span class="cm">	 * if you do not specify any command line parameter.</span>
<span class="cm">	 */</span>
	<span class="n">speeds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">programmableDelay</span><span class="p">;</span>

	<span class="n">aiptek</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">aiptek</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">inputdev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aiptek</span> <span class="o">||</span> <span class="o">!</span><span class="n">inputdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;cannot allocate memory or input device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">AIPTEK_PACKET_LENGTH</span><span class="p">,</span>
					  <span class="n">GFP_ATOMIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">data_dma</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot allocate usb buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
	        <span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot allocate urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">inputdev</span> <span class="o">=</span> <span class="n">inputdev</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">usbdev</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">intf</span> <span class="o">=</span> <span class="n">intf</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">ifnum</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">inDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">endDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">previousJitterable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">lastMacro</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Set up the curSettings struct. Said struct contains the current</span>
<span class="cm">	 * programmable parameters. The newSetting struct contains changes</span>
<span class="cm">	 * the user makes to the settings via the sysfs interface. Those</span>
<span class="cm">	 * changes are not &quot;committed&quot; to curSettings until the user</span>
<span class="cm">	 * writes to the sysfs/.../execute file.</span>
<span class="cm">	 */</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">pointerMode</span> <span class="o">=</span> <span class="n">AIPTEK_POINTER_EITHER_MODE</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">coordinateMode</span> <span class="o">=</span> <span class="n">AIPTEK_COORDINATE_ABSOLUTE_MODE</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">toolMode</span> <span class="o">=</span> <span class="n">AIPTEK_TOOL_BUTTON_PEN_MODE</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">xTilt</span> <span class="o">=</span> <span class="n">AIPTEK_TILT_DISABLE</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">yTilt</span> <span class="o">=</span> <span class="n">AIPTEK_TILT_DISABLE</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">mouseButtonLeft</span> <span class="o">=</span> <span class="n">AIPTEK_MOUSE_LEFT_BUTTON</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">mouseButtonMiddle</span> <span class="o">=</span> <span class="n">AIPTEK_MOUSE_MIDDLE_BUTTON</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">mouseButtonRight</span> <span class="o">=</span> <span class="n">AIPTEK_MOUSE_RIGHT_BUTTON</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">stylusButtonUpper</span> <span class="o">=</span> <span class="n">AIPTEK_STYLUS_UPPER_BUTTON</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">stylusButtonLower</span> <span class="o">=</span> <span class="n">AIPTEK_STYLUS_LOWER_BUTTON</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">jitterDelay</span> <span class="o">=</span> <span class="n">jitterDelay</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">programmableDelay</span> <span class="o">=</span> <span class="n">programmableDelay</span><span class="p">;</span>

	<span class="cm">/* Both structs should have equivalent settings</span>
<span class="cm">	 */</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">newSetting</span> <span class="o">=</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">;</span>

	<span class="cm">/* Determine the usb devices&#39; physical path.</span>
<span class="cm">	 * Asketh not why we always pretend we&#39;re using &quot;../input0&quot;,</span>
<span class="cm">	 * but I suspect this will have to be refactored one</span>
<span class="cm">	 * day if a single USB device can be a keyboard &amp; a mouse</span>
<span class="cm">	 * &amp; a tablet, and the inputX number actually will tell</span>
<span class="cm">	 * us something...</span>
<span class="cm">	 */</span>
	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">usbPath</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">usbPath</span><span class="p">));</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">usbPath</span><span class="p">,</span> <span class="s">&quot;/input0&quot;</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">usbPath</span><span class="p">));</span>

	<span class="cm">/* Set up client data, pointers to open and close routines</span>
<span class="cm">	 * for the input device.</span>
<span class="cm">	 */</span>
	<span class="n">inputdev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Aiptek&quot;</span><span class="p">;</span>
	<span class="n">inputdev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">usbPath</span><span class="p">;</span>
	<span class="n">usb_to_input_id</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inputdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">inputdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">aiptek</span><span class="p">);</span>

	<span class="n">inputdev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">aiptek_open</span><span class="p">;</span>
	<span class="n">inputdev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">aiptek_close</span><span class="p">;</span>

	<span class="cm">/* Now program the capacities of the tablet, in terms of being</span>
<span class="cm">	 * an input device.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">eventTypes</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	        <span class="n">__set_bit</span><span class="p">(</span><span class="n">eventTypes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">inputdev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">absEvents</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	        <span class="n">__set_bit</span><span class="p">(</span><span class="n">absEvents</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">inputdev</span><span class="o">-&gt;</span><span class="n">absbit</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">relEvents</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	        <span class="n">__set_bit</span><span class="p">(</span><span class="n">relEvents</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">inputdev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">);</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">MSC_SERIAL</span><span class="p">,</span> <span class="n">inputdev</span><span class="o">-&gt;</span><span class="n">mscbit</span><span class="p">);</span>

	<span class="cm">/* Set up key and button codes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">buttonEvents</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">buttonEvents</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">inputdev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">macroKeyEvents</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">macroKeyEvents</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">inputdev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Program the input device coordinate capacities. We do not yet</span>
<span class="cm">	 * know what maximum X, Y, and Z values are, so we&#39;re putting fake</span>
<span class="cm">	 * values in. Later, we&#39;ll ask the tablet to put in the correct</span>
<span class="cm">	 * values.</span>
<span class="cm">	 */</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2999</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2249</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_PRESSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">511</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_TILT_X</span><span class="p">,</span> <span class="n">AIPTEK_TILT_MIN</span><span class="p">,</span> <span class="n">AIPTEK_TILT_MAX</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_TILT_Y</span><span class="p">,</span> <span class="n">AIPTEK_TILT_MIN</span><span class="p">,</span> <span class="n">AIPTEK_TILT_MAX</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_WHEEL</span><span class="p">,</span> <span class="n">AIPTEK_WHEEL_MIN</span><span class="p">,</span> <span class="n">AIPTEK_WHEEL_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>

	<span class="cm">/* Go set up our URB, which is called when the tablet receives</span>
<span class="cm">	 * input.</span>
<span class="cm">	 */</span>
	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">,</span>
			 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
			 <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
					<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">),</span>
			 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">aiptek_irq</span><span class="p">,</span> <span class="n">aiptek</span><span class="p">,</span>
			 <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>

	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span> <span class="o">=</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">data_dma</span><span class="p">;</span>
	<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>

	<span class="cm">/* Program the tablet. This sets the tablet up in the mode</span>
<span class="cm">	 * specified in newSetting, and also queries the tablet&#39;s</span>
<span class="cm">	 * physical capacities.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Sanity check: if a tablet doesn&#39;t like the slow programmatic</span>
<span class="cm">	 * delay, we often get sizes of 0x0. Let&#39;s use that as an indicator</span>
<span class="cm">	 * to try faster delays, up to 25 ms. If that logic fails, well, you&#39;ll</span>
<span class="cm">	 * have to explain to us how your tablet thinks it&#39;s 0x0, and yet that&#39;s</span>
<span class="cm">	 * not an error :-)</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">speeds</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">programmableDelay</span> <span class="o">=</span> <span class="n">speeds</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">aiptek_program_tablet</span><span class="p">(</span><span class="n">aiptek</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">input_abs_get_max</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Aiptek using %d ms programming speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">curSetting</span><span class="p">.</span><span class="n">programmableDelay</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Murphy says that some day someone will have a tablet that fails the</span>
<span class="cm">	   above test. That&#39;s you, Frederic Rodrigo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">speeds</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;Aiptek tried all speeds, no sane response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Associate this driver&#39;s struct with the usb interface.</span>
<span class="cm">	 */</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">aiptek</span><span class="p">);</span>

	<span class="cm">/* Set up the sysfs files</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aiptek_attribute_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot create sysfs group err: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="cm">/* Register the tablet as an Input Device</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;input_register_device returned err: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail4</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail4:</span>	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aiptek_attribute_group</span><span class="p">);</span>
 <span class="nl">fail3:</span> <span class="n">usb_free_urb</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">);</span>
 <span class="nl">fail2:</span>	<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">AIPTEK_PACKET_LENGTH</span><span class="p">,</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			  <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">data_dma</span><span class="p">);</span>
 <span class="nl">fail1:</span> <span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">inputdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">aiptek</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * Deal with tablet disconnecting from the system.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">aiptek_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">aiptek</span> <span class="o">*</span><span class="n">aiptek</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="cm">/* Disassociate driver&#39;s struct with usb interface</span>
<span class="cm">	 */</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aiptek</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Free &amp; unhook everything from the system.</span>
<span class="cm">		 */</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">);</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">);</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aiptek_attribute_group</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">);</span>
		<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">),</span>
				  <span class="n">AIPTEK_PACKET_LENGTH</span><span class="p">,</span>
				  <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">aiptek</span><span class="o">-&gt;</span><span class="n">data_dma</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">aiptek</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">aiptek_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;aiptek&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">aiptek_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">aiptek_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">aiptek_ids</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">aiptek_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">programmableDelay</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">programmableDelay</span><span class="p">,</span> <span class="s">&quot;delay used during tablet programming&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">jitterDelay</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">jitterDelay</span><span class="p">,</span> <span class="s">&quot;stylus/mouse settlement delay&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
