<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mfd › db8500-prcmu.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>db8500-prcmu.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) STMicroelectronics 2009</span>
<span class="cm"> * Copyright (C) ST-Ericsson SA 2010</span>
<span class="cm"> *</span>
<span class="cm"> * License Terms: GNU General Public License v2</span>
<span class="cm"> * Author: Kumar Sanghvi &lt;kumar.sanghvi@stericsson.com&gt;</span>
<span class="cm"> * Author: Sundar Iyer &lt;sundar.iyer@stericsson.com&gt;</span>
<span class="cm"> * Author: Mattias Nilsson &lt;mattias.i.nilsson@stericsson.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * U8500 PRCM Unit interface driver</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/core.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/dbx500-prcmu.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/db8500-prcmu.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/machine.h&gt;</span>
<span class="cp">#include &lt;asm/hardware/gic.h&gt;</span>
<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;mach/irqs.h&gt;</span>
<span class="cp">#include &lt;mach/db8500-regs.h&gt;</span>
<span class="cp">#include &lt;mach/id.h&gt;</span>
<span class="cp">#include &quot;dbx500-prcmu-regs.h&quot;</span>

<span class="cm">/* Offset for the firmware version within the TCPM */</span>
<span class="cp">#define PRCMU_FW_VERSION_OFFSET 0xA4</span>

<span class="cm">/* Index of different voltages to be used when accessing AVSData */</span>
<span class="cp">#define PRCM_AVS_BASE		0x2FC</span>
<span class="cp">#define PRCM_AVS_VBB_RET	(PRCM_AVS_BASE + 0x0)</span>
<span class="cp">#define PRCM_AVS_VBB_MAX_OPP	(PRCM_AVS_BASE + 0x1)</span>
<span class="cp">#define PRCM_AVS_VBB_100_OPP	(PRCM_AVS_BASE + 0x2)</span>
<span class="cp">#define PRCM_AVS_VBB_50_OPP	(PRCM_AVS_BASE + 0x3)</span>
<span class="cp">#define PRCM_AVS_VARM_MAX_OPP	(PRCM_AVS_BASE + 0x4)</span>
<span class="cp">#define PRCM_AVS_VARM_100_OPP	(PRCM_AVS_BASE + 0x5)</span>
<span class="cp">#define PRCM_AVS_VARM_50_OPP	(PRCM_AVS_BASE + 0x6)</span>
<span class="cp">#define PRCM_AVS_VARM_RET	(PRCM_AVS_BASE + 0x7)</span>
<span class="cp">#define PRCM_AVS_VAPE_100_OPP	(PRCM_AVS_BASE + 0x8)</span>
<span class="cp">#define PRCM_AVS_VAPE_50_OPP	(PRCM_AVS_BASE + 0x9)</span>
<span class="cp">#define PRCM_AVS_VMOD_100_OPP	(PRCM_AVS_BASE + 0xA)</span>
<span class="cp">#define PRCM_AVS_VMOD_50_OPP	(PRCM_AVS_BASE + 0xB)</span>
<span class="cp">#define PRCM_AVS_VSAFE		(PRCM_AVS_BASE + 0xC)</span>

<span class="cp">#define PRCM_AVS_VOLTAGE		0</span>
<span class="cp">#define PRCM_AVS_VOLTAGE_MASK		0x3f</span>
<span class="cp">#define PRCM_AVS_ISSLOWSTARTUP		6</span>
<span class="cp">#define PRCM_AVS_ISSLOWSTARTUP_MASK	(1 &lt;&lt; PRCM_AVS_ISSLOWSTARTUP)</span>
<span class="cp">#define PRCM_AVS_ISMODEENABLE		7</span>
<span class="cp">#define PRCM_AVS_ISMODEENABLE_MASK	(1 &lt;&lt; PRCM_AVS_ISMODEENABLE)</span>

<span class="cp">#define PRCM_BOOT_STATUS	0xFFF</span>
<span class="cp">#define PRCM_ROMCODE_A2P	0xFFE</span>
<span class="cp">#define PRCM_ROMCODE_P2A	0xFFD</span>
<span class="cp">#define PRCM_XP70_CUR_PWR_STATE 0xFFC      </span><span class="cm">/* 4 BYTES */</span><span class="cp"></span>

<span class="cp">#define PRCM_SW_RST_REASON 0xFF8 </span><span class="cm">/* 2 bytes */</span><span class="cp"></span>

<span class="cp">#define _PRCM_MBOX_HEADER		0xFE8 </span><span class="cm">/* 16 bytes */</span><span class="cp"></span>
<span class="cp">#define PRCM_MBOX_HEADER_REQ_MB0	(_PRCM_MBOX_HEADER + 0x0)</span>
<span class="cp">#define PRCM_MBOX_HEADER_REQ_MB1	(_PRCM_MBOX_HEADER + 0x1)</span>
<span class="cp">#define PRCM_MBOX_HEADER_REQ_MB2	(_PRCM_MBOX_HEADER + 0x2)</span>
<span class="cp">#define PRCM_MBOX_HEADER_REQ_MB3	(_PRCM_MBOX_HEADER + 0x3)</span>
<span class="cp">#define PRCM_MBOX_HEADER_REQ_MB4	(_PRCM_MBOX_HEADER + 0x4)</span>
<span class="cp">#define PRCM_MBOX_HEADER_REQ_MB5	(_PRCM_MBOX_HEADER + 0x5)</span>
<span class="cp">#define PRCM_MBOX_HEADER_ACK_MB0	(_PRCM_MBOX_HEADER + 0x8)</span>

<span class="cm">/* Req Mailboxes */</span>
<span class="cp">#define PRCM_REQ_MB0 0xFDC </span><span class="cm">/* 12 bytes  */</span><span class="cp"></span>
<span class="cp">#define PRCM_REQ_MB1 0xFD0 </span><span class="cm">/* 12 bytes  */</span><span class="cp"></span>
<span class="cp">#define PRCM_REQ_MB2 0xFC0 </span><span class="cm">/* 16 bytes  */</span><span class="cp"></span>
<span class="cp">#define PRCM_REQ_MB3 0xE4C </span><span class="cm">/* 372 bytes  */</span><span class="cp"></span>
<span class="cp">#define PRCM_REQ_MB4 0xE48 </span><span class="cm">/* 4 bytes  */</span><span class="cp"></span>
<span class="cp">#define PRCM_REQ_MB5 0xE44 </span><span class="cm">/* 4 bytes  */</span><span class="cp"></span>

<span class="cm">/* Ack Mailboxes */</span>
<span class="cp">#define PRCM_ACK_MB0 0xE08 </span><span class="cm">/* 52 bytes  */</span><span class="cp"></span>
<span class="cp">#define PRCM_ACK_MB1 0xE04 </span><span class="cm">/* 4 bytes */</span><span class="cp"></span>
<span class="cp">#define PRCM_ACK_MB2 0xE00 </span><span class="cm">/* 4 bytes */</span><span class="cp"></span>
<span class="cp">#define PRCM_ACK_MB3 0xDFC </span><span class="cm">/* 4 bytes */</span><span class="cp"></span>
<span class="cp">#define PRCM_ACK_MB4 0xDF8 </span><span class="cm">/* 4 bytes */</span><span class="cp"></span>
<span class="cp">#define PRCM_ACK_MB5 0xDF4 </span><span class="cm">/* 4 bytes */</span><span class="cp"></span>

<span class="cm">/* Mailbox 0 headers */</span>
<span class="cp">#define MB0H_POWER_STATE_TRANS		0</span>
<span class="cp">#define MB0H_CONFIG_WAKEUPS_EXE		1</span>
<span class="cp">#define MB0H_READ_WAKEUP_ACK		3</span>
<span class="cp">#define MB0H_CONFIG_WAKEUPS_SLEEP	4</span>

<span class="cp">#define MB0H_WAKEUP_EXE 2</span>
<span class="cp">#define MB0H_WAKEUP_SLEEP 5</span>

<span class="cm">/* Mailbox 0 REQs */</span>
<span class="cp">#define PRCM_REQ_MB0_AP_POWER_STATE	(PRCM_REQ_MB0 + 0x0)</span>
<span class="cp">#define PRCM_REQ_MB0_AP_PLL_STATE	(PRCM_REQ_MB0 + 0x1)</span>
<span class="cp">#define PRCM_REQ_MB0_ULP_CLOCK_STATE	(PRCM_REQ_MB0 + 0x2)</span>
<span class="cp">#define PRCM_REQ_MB0_DO_NOT_WFI		(PRCM_REQ_MB0 + 0x3)</span>
<span class="cp">#define PRCM_REQ_MB0_WAKEUP_8500	(PRCM_REQ_MB0 + 0x4)</span>
<span class="cp">#define PRCM_REQ_MB0_WAKEUP_4500	(PRCM_REQ_MB0 + 0x8)</span>

<span class="cm">/* Mailbox 0 ACKs */</span>
<span class="cp">#define PRCM_ACK_MB0_AP_PWRSTTR_STATUS	(PRCM_ACK_MB0 + 0x0)</span>
<span class="cp">#define PRCM_ACK_MB0_READ_POINTER	(PRCM_ACK_MB0 + 0x1)</span>
<span class="cp">#define PRCM_ACK_MB0_WAKEUP_0_8500	(PRCM_ACK_MB0 + 0x4)</span>
<span class="cp">#define PRCM_ACK_MB0_WAKEUP_0_4500	(PRCM_ACK_MB0 + 0x8)</span>
<span class="cp">#define PRCM_ACK_MB0_WAKEUP_1_8500	(PRCM_ACK_MB0 + 0x1C)</span>
<span class="cp">#define PRCM_ACK_MB0_WAKEUP_1_4500	(PRCM_ACK_MB0 + 0x20)</span>
<span class="cp">#define PRCM_ACK_MB0_EVENT_4500_NUMBERS	20</span>

<span class="cm">/* Mailbox 1 headers */</span>
<span class="cp">#define MB1H_ARM_APE_OPP 0x0</span>
<span class="cp">#define MB1H_RESET_MODEM 0x2</span>
<span class="cp">#define MB1H_REQUEST_APE_OPP_100_VOLT 0x3</span>
<span class="cp">#define MB1H_RELEASE_APE_OPP_100_VOLT 0x4</span>
<span class="cp">#define MB1H_RELEASE_USB_WAKEUP 0x5</span>
<span class="cp">#define MB1H_PLL_ON_OFF 0x6</span>

<span class="cm">/* Mailbox 1 Requests */</span>
<span class="cp">#define PRCM_REQ_MB1_ARM_OPP			(PRCM_REQ_MB1 + 0x0)</span>
<span class="cp">#define PRCM_REQ_MB1_APE_OPP			(PRCM_REQ_MB1 + 0x1)</span>
<span class="cp">#define PRCM_REQ_MB1_PLL_ON_OFF			(PRCM_REQ_MB1 + 0x4)</span>
<span class="cp">#define PLL_SOC0_OFF	0x1</span>
<span class="cp">#define PLL_SOC0_ON	0x2</span>
<span class="cp">#define PLL_SOC1_OFF	0x4</span>
<span class="cp">#define PLL_SOC1_ON	0x8</span>

<span class="cm">/* Mailbox 1 ACKs */</span>
<span class="cp">#define PRCM_ACK_MB1_CURRENT_ARM_OPP	(PRCM_ACK_MB1 + 0x0)</span>
<span class="cp">#define PRCM_ACK_MB1_CURRENT_APE_OPP	(PRCM_ACK_MB1 + 0x1)</span>
<span class="cp">#define PRCM_ACK_MB1_APE_VOLTAGE_STATUS	(PRCM_ACK_MB1 + 0x2)</span>
<span class="cp">#define PRCM_ACK_MB1_DVFS_STATUS	(PRCM_ACK_MB1 + 0x3)</span>

<span class="cm">/* Mailbox 2 headers */</span>
<span class="cp">#define MB2H_DPS	0x0</span>
<span class="cp">#define MB2H_AUTO_PWR	0x1</span>

<span class="cm">/* Mailbox 2 REQs */</span>
<span class="cp">#define PRCM_REQ_MB2_SVA_MMDSP		(PRCM_REQ_MB2 + 0x0)</span>
<span class="cp">#define PRCM_REQ_MB2_SVA_PIPE		(PRCM_REQ_MB2 + 0x1)</span>
<span class="cp">#define PRCM_REQ_MB2_SIA_MMDSP		(PRCM_REQ_MB2 + 0x2)</span>
<span class="cp">#define PRCM_REQ_MB2_SIA_PIPE		(PRCM_REQ_MB2 + 0x3)</span>
<span class="cp">#define PRCM_REQ_MB2_SGA		(PRCM_REQ_MB2 + 0x4)</span>
<span class="cp">#define PRCM_REQ_MB2_B2R2_MCDE		(PRCM_REQ_MB2 + 0x5)</span>
<span class="cp">#define PRCM_REQ_MB2_ESRAM12		(PRCM_REQ_MB2 + 0x6)</span>
<span class="cp">#define PRCM_REQ_MB2_ESRAM34		(PRCM_REQ_MB2 + 0x7)</span>
<span class="cp">#define PRCM_REQ_MB2_AUTO_PM_SLEEP	(PRCM_REQ_MB2 + 0x8)</span>
<span class="cp">#define PRCM_REQ_MB2_AUTO_PM_IDLE	(PRCM_REQ_MB2 + 0xC)</span>

<span class="cm">/* Mailbox 2 ACKs */</span>
<span class="cp">#define PRCM_ACK_MB2_DPS_STATUS (PRCM_ACK_MB2 + 0x0)</span>
<span class="cp">#define HWACC_PWR_ST_OK 0xFE</span>

<span class="cm">/* Mailbox 3 headers */</span>
<span class="cp">#define MB3H_ANC	0x0</span>
<span class="cp">#define MB3H_SIDETONE	0x1</span>
<span class="cp">#define MB3H_SYSCLK	0xE</span>

<span class="cm">/* Mailbox 3 Requests */</span>
<span class="cp">#define PRCM_REQ_MB3_ANC_FIR_COEFF	(PRCM_REQ_MB3 + 0x0)</span>
<span class="cp">#define PRCM_REQ_MB3_ANC_IIR_COEFF	(PRCM_REQ_MB3 + 0x20)</span>
<span class="cp">#define PRCM_REQ_MB3_ANC_SHIFTER	(PRCM_REQ_MB3 + 0x60)</span>
<span class="cp">#define PRCM_REQ_MB3_ANC_WARP		(PRCM_REQ_MB3 + 0x64)</span>
<span class="cp">#define PRCM_REQ_MB3_SIDETONE_FIR_GAIN	(PRCM_REQ_MB3 + 0x68)</span>
<span class="cp">#define PRCM_REQ_MB3_SIDETONE_FIR_COEFF	(PRCM_REQ_MB3 + 0x6C)</span>
<span class="cp">#define PRCM_REQ_MB3_SYSCLK_MGT		(PRCM_REQ_MB3 + 0x16C)</span>

<span class="cm">/* Mailbox 4 headers */</span>
<span class="cp">#define MB4H_DDR_INIT	0x0</span>
<span class="cp">#define MB4H_MEM_ST	0x1</span>
<span class="cp">#define MB4H_HOTDOG	0x12</span>
<span class="cp">#define MB4H_HOTMON	0x13</span>
<span class="cp">#define MB4H_HOT_PERIOD	0x14</span>
<span class="cp">#define MB4H_A9WDOG_CONF 0x16</span>
<span class="cp">#define MB4H_A9WDOG_EN   0x17</span>
<span class="cp">#define MB4H_A9WDOG_DIS  0x18</span>
<span class="cp">#define MB4H_A9WDOG_LOAD 0x19</span>
<span class="cp">#define MB4H_A9WDOG_KICK 0x20</span>

<span class="cm">/* Mailbox 4 Requests */</span>
<span class="cp">#define PRCM_REQ_MB4_DDR_ST_AP_SLEEP_IDLE	(PRCM_REQ_MB4 + 0x0)</span>
<span class="cp">#define PRCM_REQ_MB4_DDR_ST_AP_DEEP_IDLE	(PRCM_REQ_MB4 + 0x1)</span>
<span class="cp">#define PRCM_REQ_MB4_ESRAM0_ST			(PRCM_REQ_MB4 + 0x3)</span>
<span class="cp">#define PRCM_REQ_MB4_HOTDOG_THRESHOLD		(PRCM_REQ_MB4 + 0x0)</span>
<span class="cp">#define PRCM_REQ_MB4_HOTMON_LOW			(PRCM_REQ_MB4 + 0x0)</span>
<span class="cp">#define PRCM_REQ_MB4_HOTMON_HIGH		(PRCM_REQ_MB4 + 0x1)</span>
<span class="cp">#define PRCM_REQ_MB4_HOTMON_CONFIG		(PRCM_REQ_MB4 + 0x2)</span>
<span class="cp">#define PRCM_REQ_MB4_HOT_PERIOD			(PRCM_REQ_MB4 + 0x0)</span>
<span class="cp">#define HOTMON_CONFIG_LOW			BIT(0)</span>
<span class="cp">#define HOTMON_CONFIG_HIGH			BIT(1)</span>
<span class="cp">#define PRCM_REQ_MB4_A9WDOG_0			(PRCM_REQ_MB4 + 0x0)</span>
<span class="cp">#define PRCM_REQ_MB4_A9WDOG_1			(PRCM_REQ_MB4 + 0x1)</span>
<span class="cp">#define PRCM_REQ_MB4_A9WDOG_2			(PRCM_REQ_MB4 + 0x2)</span>
<span class="cp">#define PRCM_REQ_MB4_A9WDOG_3			(PRCM_REQ_MB4 + 0x3)</span>
<span class="cp">#define A9WDOG_AUTO_OFF_EN			BIT(7)</span>
<span class="cp">#define A9WDOG_AUTO_OFF_DIS			0</span>
<span class="cp">#define A9WDOG_ID_MASK				0xf</span>

<span class="cm">/* Mailbox 5 Requests */</span>
<span class="cp">#define PRCM_REQ_MB5_I2C_SLAVE_OP	(PRCM_REQ_MB5 + 0x0)</span>
<span class="cp">#define PRCM_REQ_MB5_I2C_HW_BITS	(PRCM_REQ_MB5 + 0x1)</span>
<span class="cp">#define PRCM_REQ_MB5_I2C_REG		(PRCM_REQ_MB5 + 0x2)</span>
<span class="cp">#define PRCM_REQ_MB5_I2C_VAL		(PRCM_REQ_MB5 + 0x3)</span>
<span class="cp">#define PRCMU_I2C_WRITE(slave) \</span>
<span class="cp">	(((slave) &lt;&lt; 1) | (cpu_is_u8500v2() ? BIT(6) : 0))</span>
<span class="cp">#define PRCMU_I2C_READ(slave) \</span>
<span class="cp">	(((slave) &lt;&lt; 1) | BIT(0) | (cpu_is_u8500v2() ? BIT(6) : 0))</span>
<span class="cp">#define PRCMU_I2C_STOP_EN		BIT(3)</span>

<span class="cm">/* Mailbox 5 ACKs */</span>
<span class="cp">#define PRCM_ACK_MB5_I2C_STATUS	(PRCM_ACK_MB5 + 0x1)</span>
<span class="cp">#define PRCM_ACK_MB5_I2C_VAL	(PRCM_ACK_MB5 + 0x3)</span>
<span class="cp">#define I2C_WR_OK 0x1</span>
<span class="cp">#define I2C_RD_OK 0x2</span>

<span class="cp">#define NUM_MB 8</span>
<span class="cp">#define MBOX_BIT BIT</span>
<span class="cp">#define ALL_MBOX_BITS (MBOX_BIT(NUM_MB) - 1)</span>

<span class="cm">/*</span>
<span class="cm"> * Wakeups/IRQs</span>
<span class="cm"> */</span>

<span class="cp">#define WAKEUP_BIT_RTC BIT(0)</span>
<span class="cp">#define WAKEUP_BIT_RTT0 BIT(1)</span>
<span class="cp">#define WAKEUP_BIT_RTT1 BIT(2)</span>
<span class="cp">#define WAKEUP_BIT_HSI0 BIT(3)</span>
<span class="cp">#define WAKEUP_BIT_HSI1 BIT(4)</span>
<span class="cp">#define WAKEUP_BIT_CA_WAKE BIT(5)</span>
<span class="cp">#define WAKEUP_BIT_USB BIT(6)</span>
<span class="cp">#define WAKEUP_BIT_ABB BIT(7)</span>
<span class="cp">#define WAKEUP_BIT_ABB_FIFO BIT(8)</span>
<span class="cp">#define WAKEUP_BIT_SYSCLK_OK BIT(9)</span>
<span class="cp">#define WAKEUP_BIT_CA_SLEEP BIT(10)</span>
<span class="cp">#define WAKEUP_BIT_AC_WAKE_ACK BIT(11)</span>
<span class="cp">#define WAKEUP_BIT_SIDE_TONE_OK BIT(12)</span>
<span class="cp">#define WAKEUP_BIT_ANC_OK BIT(13)</span>
<span class="cp">#define WAKEUP_BIT_SW_ERROR BIT(14)</span>
<span class="cp">#define WAKEUP_BIT_AC_SLEEP_ACK BIT(15)</span>
<span class="cp">#define WAKEUP_BIT_ARM BIT(17)</span>
<span class="cp">#define WAKEUP_BIT_HOTMON_LOW BIT(18)</span>
<span class="cp">#define WAKEUP_BIT_HOTMON_HIGH BIT(19)</span>
<span class="cp">#define WAKEUP_BIT_MODEM_SW_RESET_REQ BIT(20)</span>
<span class="cp">#define WAKEUP_BIT_GPIO0 BIT(23)</span>
<span class="cp">#define WAKEUP_BIT_GPIO1 BIT(24)</span>
<span class="cp">#define WAKEUP_BIT_GPIO2 BIT(25)</span>
<span class="cp">#define WAKEUP_BIT_GPIO3 BIT(26)</span>
<span class="cp">#define WAKEUP_BIT_GPIO4 BIT(27)</span>
<span class="cp">#define WAKEUP_BIT_GPIO5 BIT(28)</span>
<span class="cp">#define WAKEUP_BIT_GPIO6 BIT(29)</span>
<span class="cp">#define WAKEUP_BIT_GPIO7 BIT(30)</span>
<span class="cp">#define WAKEUP_BIT_GPIO8 BIT(31)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">valid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prcmu_fw_version</span> <span class="n">version</span><span class="p">;</span>
<span class="p">}</span> <span class="n">fw_info</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This vector maps irq numbers to the bits in the bit field used in</span>
<span class="cm"> * communication with the PRCMU firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * The reason for having this is to keep the irq numbers contiguous even though</span>
<span class="cm"> * the bits in the bit field are not. (The bits also have a tendency to move</span>
<span class="cm"> * around, to further complicate matters.)</span>
<span class="cm"> */</span>
<span class="cp">#define IRQ_INDEX(_name) ((IRQ_PRCMU_##_name) - IRQ_PRCMU_BASE)</span>
<span class="cp">#define IRQ_ENTRY(_name)[IRQ_INDEX(_name)] = (WAKEUP_BIT_##_name)</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">prcmu_irq_bit</span><span class="p">[</span><span class="n">NUM_PRCMU_WAKEUPS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">RTC</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">RTT0</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">RTT1</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">HSI0</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">HSI1</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">CA_WAKE</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">USB</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">ABB</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">ABB_FIFO</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">CA_SLEEP</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">ARM</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">HOTMON_LOW</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">HOTMON_HIGH</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">MODEM_SW_RESET_REQ</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">GPIO0</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">GPIO1</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">GPIO2</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">GPIO3</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">GPIO4</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">GPIO5</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">GPIO6</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">GPIO7</span><span class="p">),</span>
	<span class="n">IRQ_ENTRY</span><span class="p">(</span><span class="n">GPIO8</span><span class="p">)</span>
<span class="p">};</span>

<span class="cp">#define VALID_WAKEUPS (BIT(NUM_PRCMU_WAKEUP_INDICES) - 1)</span>
<span class="cp">#define WAKEUP_ENTRY(_name)[PRCMU_WAKEUP_INDEX_##_name] = (WAKEUP_BIT_##_name)</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">prcmu_wakeup_bit</span><span class="p">[</span><span class="n">NUM_PRCMU_WAKEUP_INDICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">WAKEUP_ENTRY</span><span class="p">(</span><span class="n">RTC</span><span class="p">),</span>
	<span class="n">WAKEUP_ENTRY</span><span class="p">(</span><span class="n">RTT0</span><span class="p">),</span>
	<span class="n">WAKEUP_ENTRY</span><span class="p">(</span><span class="n">RTT1</span><span class="p">),</span>
	<span class="n">WAKEUP_ENTRY</span><span class="p">(</span><span class="n">HSI0</span><span class="p">),</span>
	<span class="n">WAKEUP_ENTRY</span><span class="p">(</span><span class="n">HSI1</span><span class="p">),</span>
	<span class="n">WAKEUP_ENTRY</span><span class="p">(</span><span class="n">USB</span><span class="p">),</span>
	<span class="n">WAKEUP_ENTRY</span><span class="p">(</span><span class="n">ABB</span><span class="p">),</span>
	<span class="n">WAKEUP_ENTRY</span><span class="p">(</span><span class="n">ABB_FIFO</span><span class="p">),</span>
	<span class="n">WAKEUP_ENTRY</span><span class="p">(</span><span class="n">ARM</span><span class="p">)</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * mb0_transfer - state needed for mailbox 0 communication.</span>
<span class="cm"> * @lock:		The transaction lock.</span>
<span class="cm"> * @dbb_events_lock:	A lock used to handle concurrent access to (parts of)</span>
<span class="cm"> *			the request data.</span>
<span class="cm"> * @mask_work:		Work structure used for (un)masking wakeup interrupts.</span>
<span class="cm"> * @req:		Request data that need to persist between requests.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">dbb_irqs_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">mask_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">ac_wake_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">ac_wake_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">dbb_irqs</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">dbb_wakeups</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">abb_events</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">req</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mb0_transfer</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * mb1_transfer - state needed for mailbox 1 communication.</span>
<span class="cm"> * @lock:	The transaction lock.</span>
<span class="cm"> * @work:	The transaction completion structure.</span>
<span class="cm"> * @ape_opp:	The current APE OPP.</span>
<span class="cm"> * @ack:	Reply (&quot;acknowledge&quot;) data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">work</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ape_opp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">header</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">arm_opp</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">ape_opp</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">ape_voltage_status</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">ack</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mb1_transfer</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * mb2_transfer - state needed for mailbox 2 communication.</span>
<span class="cm"> * @lock:            The transaction lock.</span>
<span class="cm"> * @work:            The transaction completion structure.</span>
<span class="cm"> * @auto_pm_lock:    The autonomous power management configuration lock.</span>
<span class="cm"> * @auto_pm_enabled: A flag indicating whether autonomous PM is enabled.</span>
<span class="cm"> * @req:             Request data that need to persist between requests.</span>
<span class="cm"> * @ack:             Reply (&quot;acknowledge&quot;) data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">work</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">auto_pm_lock</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">auto_pm_enabled</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">ack</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mb2_transfer</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * mb3_transfer - state needed for mailbox 3 communication.</span>
<span class="cm"> * @lock:		The request lock.</span>
<span class="cm"> * @sysclk_lock:	A lock used to handle concurrent sysclk requests.</span>
<span class="cm"> * @sysclk_work:	Work structure used for sysclk requests.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">sysclk_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">sysclk_work</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mb3_transfer</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * mb4_transfer - state needed for mailbox 4 communication.</span>
<span class="cm"> * @lock:	The transaction lock.</span>
<span class="cm"> * @work:	The transaction completion structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">work</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mb4_transfer</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * mb5_transfer - state needed for mailbox 5 communication.</span>
<span class="cm"> * @lock:	The transaction lock.</span>
<span class="cm"> * @work:	The transaction completion structure.</span>
<span class="cm"> * @ack:	Reply (&quot;acknowledge&quot;) data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">ack</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mb5_transfer</span><span class="p">;</span>

<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">ac_wake_req_state</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="cm">/* Spinlocks */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">prcmu_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">clkout_lock</span><span class="p">);</span>

<span class="cm">/* Global var to runtime determine TCDM base for v2 or v1 */</span>
<span class="k">static</span> <span class="n">__iomem</span> <span class="kt">void</span> <span class="o">*</span><span class="n">tcdm_base</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">clk_mgt</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pllsw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">branch</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">clk38div</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">PLL_RAW</span><span class="p">,</span>
	<span class="n">PLL_FIX</span><span class="p">,</span>
	<span class="n">PLL_DIV</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">clk_mgt_lock</span><span class="p">);</span>

<span class="cp">#define CLK_MGT_ENTRY(_name, _branch, _clk38div)[PRCMU_##_name] = \</span>
<span class="cp">	{ (PRCM_##_name##_MGT), 0 , _branch, _clk38div}</span>
<span class="k">struct</span> <span class="n">clk_mgt</span> <span class="n">clk_mgt</span><span class="p">[</span><span class="n">PRCMU_NUM_REG_CLOCKS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">SGACLK</span><span class="p">,</span> <span class="n">PLL_DIV</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">UARTCLK</span><span class="p">,</span> <span class="n">PLL_FIX</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">MSP02CLK</span><span class="p">,</span> <span class="n">PLL_FIX</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">MSP1CLK</span><span class="p">,</span> <span class="n">PLL_FIX</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">I2CCLK</span><span class="p">,</span> <span class="n">PLL_FIX</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">SDMMCCLK</span><span class="p">,</span> <span class="n">PLL_DIV</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">SLIMCLK</span><span class="p">,</span> <span class="n">PLL_FIX</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">PER1CLK</span><span class="p">,</span> <span class="n">PLL_DIV</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">PER2CLK</span><span class="p">,</span> <span class="n">PLL_DIV</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">PER3CLK</span><span class="p">,</span> <span class="n">PLL_DIV</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">PER5CLK</span><span class="p">,</span> <span class="n">PLL_DIV</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">PER6CLK</span><span class="p">,</span> <span class="n">PLL_DIV</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">PER7CLK</span><span class="p">,</span> <span class="n">PLL_DIV</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">LCDCLK</span><span class="p">,</span> <span class="n">PLL_FIX</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">BMLCLK</span><span class="p">,</span> <span class="n">PLL_DIV</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">HSITXCLK</span><span class="p">,</span> <span class="n">PLL_DIV</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">HSIRXCLK</span><span class="p">,</span> <span class="n">PLL_DIV</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">HDMICLK</span><span class="p">,</span> <span class="n">PLL_FIX</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">APEATCLK</span><span class="p">,</span> <span class="n">PLL_DIV</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">APETRACECLK</span><span class="p">,</span> <span class="n">PLL_DIV</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">MCDECLK</span><span class="p">,</span> <span class="n">PLL_DIV</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">IPI2CCLK</span><span class="p">,</span> <span class="n">PLL_FIX</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">DSIALTCLK</span><span class="p">,</span> <span class="n">PLL_FIX</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">DMACLK</span><span class="p">,</span> <span class="n">PLL_DIV</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">B2R2CLK</span><span class="p">,</span> <span class="n">PLL_DIV</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">TVCLK</span><span class="p">,</span> <span class="n">PLL_FIX</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">SSPCLK</span><span class="p">,</span> <span class="n">PLL_FIX</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">RNGCLK</span><span class="p">,</span> <span class="n">PLL_FIX</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
	<span class="n">CLK_MGT_ENTRY</span><span class="p">(</span><span class="n">UICCCLK</span><span class="p">,</span> <span class="n">PLL_FIX</span><span class="p">,</span> <span class="nb">false</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dsiclk</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">divsel_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">divsel_shift</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">divsel</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dsiclk</span> <span class="n">dsiclk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">divsel_mask</span> <span class="o">=</span> <span class="n">PRCM_DSI_PLLOUT_SEL_DSI0_PLLOUT_DIVSEL_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">divsel_shift</span> <span class="o">=</span> <span class="n">PRCM_DSI_PLLOUT_SEL_DSI0_PLLOUT_DIVSEL_SHIFT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">divsel</span> <span class="o">=</span> <span class="n">PRCM_DSI_PLLOUT_SEL_PHI</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">divsel_mask</span> <span class="o">=</span> <span class="n">PRCM_DSI_PLLOUT_SEL_DSI1_PLLOUT_DIVSEL_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">divsel_shift</span> <span class="o">=</span> <span class="n">PRCM_DSI_PLLOUT_SEL_DSI1_PLLOUT_DIVSEL_SHIFT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">divsel</span> <span class="o">=</span> <span class="n">PRCM_DSI_PLLOUT_SEL_PHI</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dsiescclk</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">en</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div_shift</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dsiescclk</span> <span class="n">dsiescclk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="n">PRCM_DSITVCLK_DIV_DSI0_ESC_CLK_EN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">div_mask</span> <span class="o">=</span> <span class="n">PRCM_DSITVCLK_DIV_DSI0_ESC_CLK_DIV_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">div_shift</span> <span class="o">=</span> <span class="n">PRCM_DSITVCLK_DIV_DSI0_ESC_CLK_DIV_SHIFT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="n">PRCM_DSITVCLK_DIV_DSI1_ESC_CLK_EN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">div_mask</span> <span class="o">=</span> <span class="n">PRCM_DSITVCLK_DIV_DSI1_ESC_CLK_DIV_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">div_shift</span> <span class="o">=</span> <span class="n">PRCM_DSITVCLK_DIV_DSI1_ESC_CLK_DIV_SHIFT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="n">PRCM_DSITVCLK_DIV_DSI2_ESC_CLK_EN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">div_mask</span> <span class="o">=</span> <span class="n">PRCM_DSITVCLK_DIV_DSI2_ESC_CLK_DIV_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">div_shift</span> <span class="o">=</span> <span class="n">PRCM_DSITVCLK_DIV_DSI2_ESC_CLK_DIV_SHIFT</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">* Used by MCDE to setup all necessary PRCMU registers</span>
<span class="cm">*/</span>
<span class="cp">#define PRCMU_RESET_DSIPLL		0x00004000</span>
<span class="cp">#define PRCMU_UNCLAMP_DSIPLL		0x00400800</span>

<span class="cp">#define PRCMU_CLK_PLL_DIV_SHIFT		0</span>
<span class="cp">#define PRCMU_CLK_PLL_SW_SHIFT		5</span>
<span class="cp">#define PRCMU_CLK_38			(1 &lt;&lt; 9)</span>
<span class="cp">#define PRCMU_CLK_38_SRC		(1 &lt;&lt; 10)</span>
<span class="cp">#define PRCMU_CLK_38_DIV		(1 &lt;&lt; 11)</span>

<span class="cm">/* PLLDIV=12, PLLSW=4 (PLLDDR) */</span>
<span class="cp">#define PRCMU_DSI_CLOCK_SETTING		0x0000008C</span>

<span class="cm">/* DPI 50000000 Hz */</span>
<span class="cp">#define PRCMU_DPI_CLOCK_SETTING		((1 &lt;&lt; PRCMU_CLK_PLL_SW_SHIFT) | \</span>
<span class="cp">					  (16 &lt;&lt; PRCMU_CLK_PLL_DIV_SHIFT))</span>
<span class="cp">#define PRCMU_DSI_LP_CLOCK_SETTING	0x00000E00</span>

<span class="cm">/* D=101, N=1, R=4, SELDIV2=0 */</span>
<span class="cp">#define PRCMU_PLLDSI_FREQ_SETTING	0x00040165</span>

<span class="cp">#define PRCMU_ENABLE_PLLDSI		0x00000001</span>
<span class="cp">#define PRCMU_DISABLE_PLLDSI		0x00000000</span>
<span class="cp">#define PRCMU_RELEASE_RESET_DSS		0x0000400C</span>
<span class="cp">#define PRCMU_DSI_PLLOUT_SEL_SETTING	0x00000202</span>
<span class="cm">/* ESC clk, div0=1, div1=1, div2=3 */</span>
<span class="cp">#define PRCMU_ENABLE_ESCAPE_CLOCK_DIV	0x07030101</span>
<span class="cp">#define PRCMU_DISABLE_ESCAPE_CLOCK_DIV	0x00030101</span>
<span class="cp">#define PRCMU_DSI_RESET_SW		0x00000007</span>

<span class="cp">#define PRCMU_PLLDSI_LOCKP_LOCKED	0x3</span>

<span class="kt">int</span> <span class="nf">db8500_prcmu_enable_dsipll</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Clear DSIPLL_RESETN */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PRCMU_RESET_DSIPLL</span><span class="p">,</span> <span class="n">PRCM_APE_RESETN_CLR</span><span class="p">);</span>
	<span class="cm">/* Unclamp DSIPLL in/out */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PRCMU_UNCLAMP_DSIPLL</span><span class="p">,</span> <span class="n">PRCM_MMIP_LS_CLAMP_CLR</span><span class="p">);</span>

	<span class="cm">/* Set DSI PLL FREQ */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PRCMU_PLLDSI_FREQ_SETTING</span><span class="p">,</span> <span class="n">PRCM_PLLDSI_FREQ</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PRCMU_DSI_PLLOUT_SEL_SETTING</span><span class="p">,</span> <span class="n">PRCM_DSI_PLLOUT_SEL</span><span class="p">);</span>
	<span class="cm">/* Enable Escape clocks */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PRCMU_ENABLE_ESCAPE_CLOCK_DIV</span><span class="p">,</span> <span class="n">PRCM_DSITVCLK_DIV</span><span class="p">);</span>

	<span class="cm">/* Start DSI PLL */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PRCMU_ENABLE_PLLDSI</span><span class="p">,</span> <span class="n">PRCM_PLLDSI_ENABLE</span><span class="p">);</span>
	<span class="cm">/* Reset DSI PLL */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PRCMU_DSI_RESET_SW</span><span class="p">,</span> <span class="n">PRCM_DSI_SW_RESET</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_PLLDSI_LOCKP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PRCMU_PLLDSI_LOCKP_LOCKED</span><span class="p">)</span>
					<span class="o">==</span> <span class="n">PRCMU_PLLDSI_LOCKP_LOCKED</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Set DSIPLL_RESETN */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PRCMU_RESET_DSIPLL</span><span class="p">,</span> <span class="n">PRCM_APE_RESETN_SET</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">db8500_prcmu_disable_dsipll</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Disable dsi pll */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PRCMU_DISABLE_PLLDSI</span><span class="p">,</span> <span class="n">PRCM_PLLDSI_ENABLE</span><span class="p">);</span>
	<span class="cm">/* Disable  escapeclock */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PRCMU_DISABLE_ESCAPE_CLOCK_DIV</span><span class="p">,</span> <span class="n">PRCM_DSITVCLK_DIV</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">db8500_prcmu_set_display_clocks</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_mgt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Grab the HW semaphore. */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_SEM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PRCM_SEM_PRCM_SEM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">PRCMU_DSI_CLOCK_SETTING</span><span class="p">,</span> <span class="n">PRCM_HDMICLK_MGT</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PRCMU_DSI_LP_CLOCK_SETTING</span><span class="p">,</span> <span class="n">PRCM_TVCLK_MGT</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PRCMU_DPI_CLOCK_SETTING</span><span class="p">,</span> <span class="n">PRCM_LCDCLK_MGT</span><span class="p">);</span>

	<span class="cm">/* Release the HW semaphore. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PRCM_SEM</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_mgt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">db8500_prcmu_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">_PRCMU_BASE</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">db8500_prcmu_write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcmu_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">_PRCMU_BASE</span> <span class="o">+</span> <span class="n">reg</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcmu_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">db8500_prcmu_write_masked</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcmu_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">_PRCMU_BASE</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">_PRCMU_BASE</span> <span class="o">+</span> <span class="n">reg</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcmu_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">prcmu_fw_version</span> <span class="o">*</span><span class="nf">prcmu_get_fw_version</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fw_info</span><span class="p">.</span><span class="n">valid</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">fw_info</span><span class="p">.</span><span class="n">version</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">prcmu_has_arm_maxopp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_AVS_VARM_MAX_OPP</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">PRCM_AVS_ISMODEENABLE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PRCM_AVS_ISMODEENABLE_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * prcmu_get_boot_status - PRCMU boot status checking</span>
<span class="cm"> * Returns: the current PRCMU boot status</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">prcmu_get_boot_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_BOOT_STATUS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * prcmu_set_rc_a2p - This function is used to run few power state sequences</span>
<span class="cm"> * @val: Value to be set, i.e. transition requested</span>
<span class="cm"> * Returns: 0 on success, -EINVAL on invalid argument</span>
<span class="cm"> *</span>
<span class="cm"> * This function is used to run the following power state sequences -</span>
<span class="cm"> * any state to ApReset,  ApDeepSleep to ApExecute, ApExecute to ApDeepSleep</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">prcmu_set_rc_a2p</span><span class="p">(</span><span class="k">enum</span> <span class="n">romcode_write</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">RDY_2_DS</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">RDY_2_XP70_RST</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_ROMCODE_A2P</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * prcmu_get_rc_p2a - This function is used to get power state sequences</span>
<span class="cm"> * Returns: the power transition that has last happened</span>
<span class="cm"> *</span>
<span class="cm"> * This function can return the following transitions-</span>
<span class="cm"> * any state to ApReset,  ApDeepSleep to ApExecute, ApExecute to ApDeepSleep</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">romcode_read</span> <span class="nf">prcmu_get_rc_p2a</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_ROMCODE_P2A</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * prcmu_get_current_mode - Return the current XP70 power mode</span>
<span class="cm"> * Returns: Returns the current AP(ARM) power mode: init,</span>
<span class="cm"> * apBoot, apExecute, apDeepSleep, apSleep, apIdle, apReset</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">ap_pwrst</span> <span class="nf">prcmu_get_xp70_current_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_XP70_CUR_PWR_STATE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * prcmu_config_clkout - Configure one of the programmable clock outputs.</span>
<span class="cm"> * @clkout:	The CLKOUT number (0 or 1).</span>
<span class="cm"> * @source:	The clock to be used (one of the PRCMU_CLKSRC_*).</span>
<span class="cm"> * @div:	The divider to be applied.</span>
<span class="cm"> *</span>
<span class="cm"> * Configures one of the programmable clock outputs (CLKOUTs).</span>
<span class="cm"> * @div should be in the range [1,63] to request a configuration, or 0 to</span>
<span class="cm"> * inform that the configuration is no longer requested.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">prcmu_config_clkout</span><span class="p">(</span><span class="n">u8</span> <span class="n">clkout</span><span class="p">,</span> <span class="n">u8</span> <span class="n">source</span><span class="p">,</span> <span class="n">u8</span> <span class="n">div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">requests</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div_mask</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">clkout</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">div</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">clkout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">source</span> <span class="o">&gt;</span> <span class="n">PRCMU_CLKSRC_CLK009</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">div</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">requests</span><span class="p">[</span><span class="n">clkout</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">clkout</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">div_mask</span> <span class="o">=</span> <span class="n">PRCM_CLKOCR_CLKODIV0_MASK</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">PRCM_CLKOCR_CLKODIV0_MASK</span> <span class="o">|</span> <span class="n">PRCM_CLKOCR_CLKOSEL0_MASK</span><span class="p">);</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="p">((</span><span class="n">source</span> <span class="o">&lt;&lt;</span> <span class="n">PRCM_CLKOCR_CLKOSEL0_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">div</span> <span class="o">&lt;&lt;</span> <span class="n">PRCM_CLKOCR_CLKODIV0_SHIFT</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">div_mask</span> <span class="o">=</span> <span class="n">PRCM_CLKOCR_CLKODIV1_MASK</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">PRCM_CLKOCR_CLKODIV1_MASK</span> <span class="o">|</span> <span class="n">PRCM_CLKOCR_CLKOSEL1_MASK</span> <span class="o">|</span>
			<span class="n">PRCM_CLKOCR_CLK1TYPE</span><span class="p">);</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="p">((</span><span class="n">source</span> <span class="o">&lt;&lt;</span> <span class="n">PRCM_CLKOCR_CLKOSEL1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">div</span> <span class="o">&lt;&lt;</span> <span class="n">PRCM_CLKOCR_CLKODIV1_SHIFT</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bits</span> <span class="o">&amp;=</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clkout_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_CLKOCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">div_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">div</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">bits</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">div_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">bits</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">bits</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)),</span> <span class="n">PRCM_CLKOCR</span><span class="p">);</span>
	<span class="n">requests</span><span class="p">[</span><span class="n">clkout</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">div</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

<span class="nl">unlock_and_return:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clkout_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">db8500_prcmu_set_power_state</span><span class="p">(</span><span class="n">u8</span> <span class="n">state</span><span class="p">,</span> <span class="n">bool</span> <span class="n">keep_ulp_clk</span><span class="p">,</span> <span class="n">bool</span> <span class="n">keep_ap_pll</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">PRCMU_AP_SLEEP</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">PRCMU_AP_DEEP_IDLE</span> <span class="o">&lt;</span> <span class="n">state</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">MB0H_POWER_STATE_TRANS</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB0</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB0_AP_POWER_STATE</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">((</span><span class="n">keep_ap_pll</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB0_AP_PLL_STATE</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">((</span><span class="n">keep_ulp_clk</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
		<span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB0_ULP_CLOCK_STATE</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB0_DO_NOT_WFI</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">db8500_prcmu_get_power_state_result</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_ACK_MB0_AP_PWRSTTR_STATUS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This function decouple the gic from the prcmu */</span>
<span class="kt">int</span> <span class="nf">db8500_prcmu_gic_decouple</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_A9_MASK_REQ</span><span class="p">);</span>

	<span class="cm">/* Set bit 0 register value to 1 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">PRCM_A9_MASK_REQ_PRCM_A9_MASK_REQ</span><span class="p">,</span>
	       <span class="n">PRCM_A9_MASK_REQ</span><span class="p">);</span>

	<span class="cm">/* Make sure the register is updated */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">PRCM_A9_MASK_REQ</span><span class="p">);</span>

	<span class="cm">/* Wait a few cycles for the gic mask completion */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function recouple the gic with the prcmu */</span>
<span class="kt">int</span> <span class="nf">db8500_prcmu_gic_recouple</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_A9_MASK_REQ</span><span class="p">);</span>

	<span class="cm">/* Set bit 0 register value to 0 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PRCM_A9_MASK_REQ_PRCM_A9_MASK_REQ</span><span class="p">,</span> <span class="n">PRCM_A9_MASK_REQ</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PRCMU_GIC_NUMBER_REGS 5</span>

<span class="cm">/*</span>
<span class="cm"> * This function checks if there are pending irq on the gic. It only</span>
<span class="cm"> * makes sense if the gic has been decoupled before with the</span>
<span class="cm"> * db8500_prcmu_gic_decouple function. Disabling an interrupt only</span>
<span class="cm"> * disables the forwarding of the interrupt to any CPU interface. It</span>
<span class="cm"> * does not prevent the interrupt from changing state, for example</span>
<span class="cm"> * becoming pending, or active and pending if it is already</span>
<span class="cm"> * active. Hence, we have to check the interrupt is pending *and* is</span>
<span class="cm"> * active.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">db8500_prcmu_gic_pending_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pr</span><span class="p">;</span> <span class="cm">/* Pending register */</span>
	<span class="n">u32</span> <span class="n">er</span><span class="p">;</span> <span class="cm">/* Enable register */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dist_base</span> <span class="o">=</span> <span class="n">__io_address</span><span class="p">(</span><span class="n">U8500_GIC_DIST_BASE</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

        <span class="cm">/* 5 registers. STI &amp; PPI not skipped */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PRCMU_GIC_NUMBER_REGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">pr</span> <span class="o">=</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">dist_base</span> <span class="o">+</span> <span class="n">GIC_DIST_PENDING_SET</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">er</span> <span class="o">=</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">dist_base</span> <span class="o">+</span> <span class="n">GIC_DIST_ENABLE_SET</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&amp;</span> <span class="n">er</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="cm">/* There is a pending interrupt */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function checks if there are pending interrupt on the</span>
<span class="cm"> * prcmu which has been delegated to monitor the irqs with the</span>
<span class="cm"> * db8500_prcmu_copy_gic_settings function.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">db8500_prcmu_pending_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">it</span><span class="p">,</span> <span class="n">im</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PRCMU_GIC_NUMBER_REGS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">it</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_ARMITVAL31TO0</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">im</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_ARMITMSK31TO0</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">&amp;</span> <span class="n">im</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="cm">/* There is a pending interrupt */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function checks if the specified cpu is in in WFI. It&#39;s usage</span>
<span class="cm"> * makes sense only if the gic is decoupled with the db8500_prcmu_gic_decouple</span>
<span class="cm"> * function. Of course passing smp_processor_id() to this function will</span>
<span class="cm"> * always return false...</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">db8500_prcmu_is_cpu_in_wfi</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_ARM_WFI_STANDBY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cpu</span> <span class="o">?</span> <span class="n">PRCM_ARM_WFI_STANDBY_WFI1</span> <span class="o">:</span>
		     <span class="n">PRCM_ARM_WFI_STANDBY_WFI0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function copies the gic SPI settings to the prcmu in order to</span>
<span class="cm"> * monitor them and abort/finish the retention/off sequence or state.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">db8500_prcmu_copy_gic_settings</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">er</span><span class="p">;</span> <span class="cm">/* Enable register */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dist_base</span> <span class="o">=</span> <span class="n">__io_address</span><span class="p">(</span><span class="n">U8500_GIC_DIST_BASE</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

        <span class="cm">/* We skip the STI and PPI */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PRCMU_GIC_NUMBER_REGS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">er</span> <span class="o">=</span> <span class="n">readl_relaxed</span><span class="p">(</span><span class="n">dist_base</span> <span class="o">+</span>
				   <span class="n">GIC_DIST_ENABLE_SET</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">er</span><span class="p">,</span> <span class="n">PRCM_ARMITMSK31TO0</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function should only be called while mb0_transfer.lock is held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">config_wakeups</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">MB0H_CONFIG_WAKEUPS_EXE</span><span class="p">,</span>
		<span class="n">MB0H_CONFIG_WAKEUPS_SLEEP</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">last_dbb_events</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">last_abb_events</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dbb_events</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">abb_events</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dbb_events</span> <span class="o">=</span> <span class="n">mb0_transfer</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">dbb_irqs</span> <span class="o">|</span> <span class="n">mb0_transfer</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">dbb_wakeups</span><span class="p">;</span>
	<span class="n">dbb_events</span> <span class="o">|=</span> <span class="p">(</span><span class="n">WAKEUP_BIT_AC_WAKE_ACK</span> <span class="o">|</span> <span class="n">WAKEUP_BIT_AC_SLEEP_ACK</span><span class="p">);</span>

	<span class="n">abb_events</span> <span class="o">=</span> <span class="n">mb0_transfer</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">abb_events</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dbb_events</span> <span class="o">==</span> <span class="n">last_dbb_events</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">abb_events</span> <span class="o">==</span> <span class="n">last_abb_events</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
			<span class="n">cpu_relax</span><span class="p">();</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dbb_events</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB0_WAKEUP_8500</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">abb_events</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB0_WAKEUP_4500</span><span class="p">));</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB0</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">last_dbb_events</span> <span class="o">=</span> <span class="n">dbb_events</span><span class="p">;</span>
	<span class="n">last_abb_events</span> <span class="o">=</span> <span class="n">abb_events</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">db8500_prcmu_enable_wakeups</span><span class="p">(</span><span class="n">u32</span> <span class="n">wakeups</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">wakeups</span> <span class="o">!=</span> <span class="p">(</span><span class="n">wakeups</span> <span class="o">&amp;</span> <span class="n">VALID_WAKEUPS</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_PRCMU_WAKEUP_INDICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wakeups</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
			<span class="n">bits</span> <span class="o">|=</span> <span class="n">prcmu_wakeup_bit</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mb0_transfer</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">dbb_wakeups</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">config_wakeups</span><span class="p">();</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">db8500_prcmu_config_abb_event_readout</span><span class="p">(</span><span class="n">u32</span> <span class="n">abb_events</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mb0_transfer</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">abb_events</span> <span class="o">=</span> <span class="n">abb_events</span><span class="p">;</span>
	<span class="n">config_wakeups</span><span class="p">();</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">db8500_prcmu_get_abb_event_buffer</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">**</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_ACK_MB0_READ_POINTER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_ACK_MB0_WAKEUP_1_4500</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_ACK_MB0_WAKEUP_0_4500</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * db8500_prcmu_set_arm_opp - set the appropriate ARM OPP</span>
<span class="cm"> * @opp: The new ARM operating point to which transition is to be made</span>
<span class="cm"> * Returns: 0 on success, non-zero on failure</span>
<span class="cm"> *</span>
<span class="cm"> * This function sets the the operating point of the ARM.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">db8500_prcmu_set_arm_opp</span><span class="p">(</span><span class="n">u8</span> <span class="n">opp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opp</span> <span class="o">&lt;</span> <span class="n">ARM_NO_CHANGE</span> <span class="o">||</span> <span class="n">opp</span> <span class="o">&gt;</span> <span class="n">ARM_EXTCLK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">MB1H_ARM_APE_OPP</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB1</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">opp</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB1_ARM_OPP</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">APE_NO_CHANGE</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB1_APE_OPP</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">header</span> <span class="o">!=</span> <span class="n">MB1H_ARM_APE_OPP</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">arm_opp</span> <span class="o">!=</span> <span class="n">opp</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * db8500_prcmu_get_arm_opp - get the current ARM OPP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: the current ARM OPP</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">db8500_prcmu_get_arm_opp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_ACK_MB1_CURRENT_ARM_OPP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * db8500_prcmu_get_ddr_opp - get the current DDR OPP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: the current DDR OPP</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">db8500_prcmu_get_ddr_opp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">PRCM_DDR_SUBSYS_APE_MINBW</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * db8500_set_ddr_opp - set the appropriate DDR OPP</span>
<span class="cm"> * @opp: The new DDR operating point to which transition is to be made</span>
<span class="cm"> * Returns: 0 on success, non-zero on failure</span>
<span class="cm"> *</span>
<span class="cm"> * This function sets the operating point of the DDR.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">db8500_prcmu_set_ddr_opp</span><span class="p">(</span><span class="n">u8</span> <span class="n">opp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opp</span> <span class="o">&lt;</span> <span class="n">DDR_100_OPP</span> <span class="o">||</span> <span class="n">opp</span> <span class="o">&gt;</span> <span class="n">DDR_25_OPP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* Changing the DDR OPP can hang the hardware pre-v21 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_u8500v20_or_later</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpu_is_u8500v20</span><span class="p">())</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">opp</span><span class="p">,</span> <span class="n">PRCM_DDR_SUBSYS_APE_MINBW</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Divide the frequency of certain clocks by 2 for APE_50_PARTLY_25_OPP. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">request_even_slower_clocks</span><span class="p">(</span><span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">clock_reg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">PRCM_ACLK_MGT</span><span class="p">,</span>
		<span class="n">PRCM_DMACLK_MGT</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_mgt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Grab the HW semaphore. */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_SEM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PRCM_SEM_PRCM_SEM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clock_reg</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">clock_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PRCM_CLK_MGT_CLKPLLDIV_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">div</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;prcmu: Bad clock divider %d in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">div</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">div</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>
			<span class="n">div</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PRCM_CLK_MGT_CLKPLLDIV_MASK</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">div</span> <span class="o">&amp;</span> <span class="n">PRCM_CLK_MGT_CLKPLLDIV_MASK</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">clock_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

<span class="nl">unlock_and_return:</span>
	<span class="cm">/* Release the HW semaphore. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PRCM_SEM</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_mgt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * db8500_set_ape_opp - set the appropriate APE OPP</span>
<span class="cm"> * @opp: The new APE operating point to which transition is to be made</span>
<span class="cm"> * Returns: 0 on success, non-zero on failure</span>
<span class="cm"> *</span>
<span class="cm"> * This function sets the operating point of the APE.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">db8500_prcmu_set_ape_opp</span><span class="p">(</span><span class="n">u8</span> <span class="n">opp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opp</span> <span class="o">==</span> <span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ape_opp</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ape_opp</span> <span class="o">==</span> <span class="n">APE_50_PARTLY_25_OPP</span><span class="p">)</span>
		<span class="n">request_even_slower_clocks</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">opp</span> <span class="o">!=</span> <span class="n">APE_100_OPP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ape_opp</span> <span class="o">!=</span> <span class="n">APE_100_OPP</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">skip_message</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">MB1H_ARM_APE_OPP</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB1</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">ARM_NO_CHANGE</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB1_ARM_OPP</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(((</span><span class="n">opp</span> <span class="o">==</span> <span class="n">APE_50_PARTLY_25_OPP</span><span class="p">)</span> <span class="o">?</span> <span class="n">APE_50_OPP</span> <span class="o">:</span> <span class="n">opp</span><span class="p">),</span>
		<span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB1_APE_OPP</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">header</span> <span class="o">!=</span> <span class="n">MB1H_ARM_APE_OPP</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">ape_opp</span> <span class="o">!=</span> <span class="n">opp</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">skip_message:</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">opp</span> <span class="o">==</span> <span class="n">APE_50_PARTLY_25_OPP</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ape_opp</span> <span class="o">==</span> <span class="n">APE_50_PARTLY_25_OPP</span><span class="p">)))</span>
		<span class="n">request_even_slower_clocks</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
		<span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ape_opp</span> <span class="o">=</span> <span class="n">opp</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * db8500_prcmu_get_ape_opp - get the current APE OPP</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: the current APE OPP</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">db8500_prcmu_get_ape_opp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_ACK_MB1_CURRENT_APE_OPP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * prcmu_request_ape_opp_100_voltage - Request APE OPP 100% voltage</span>
<span class="cm"> * @enable: true to request the higher voltage, false to drop a request.</span>
<span class="cm"> *</span>
<span class="cm"> * Calls to this function to enable and disable requests must be balanced.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">prcmu_request_ape_opp_100_voltage</span><span class="p">(</span><span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">header</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">requests</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">requests</span><span class="o">++</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>
		<span class="n">header</span> <span class="o">=</span> <span class="n">MB1H_REQUEST_APE_OPP_100_VOLT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">requests</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">requests</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">header</span> <span class="o">=</span> <span class="n">MB1H_RELEASE_APE_OPP_100_VOLT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB1</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">header</span> <span class="o">!=</span> <span class="n">header</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">ape_voltage_status</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * prcmu_release_usb_wakeup_state - release the state required by a USB wakeup</span>
<span class="cm"> *</span>
<span class="cm"> * This function releases the power state requirements of a USB wakeup.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">prcmu_release_usb_wakeup_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">MB1H_RELEASE_USB_WAKEUP</span><span class="p">,</span>
		<span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB1</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">header</span> <span class="o">!=</span> <span class="n">MB1H_RELEASE_USB_WAKEUP</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">ape_voltage_status</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">request_pll</span><span class="p">(</span><span class="n">u8</span> <span class="n">clock</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_PLLSOC0</span><span class="p">)</span>
		<span class="n">clock</span> <span class="o">=</span> <span class="p">(</span><span class="n">enable</span> <span class="o">?</span> <span class="n">PLL_SOC0_ON</span> <span class="o">:</span> <span class="n">PLL_SOC0_OFF</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_PLLSOC1</span><span class="p">)</span>
		<span class="n">clock</span> <span class="o">=</span> <span class="p">(</span><span class="n">enable</span> <span class="o">?</span> <span class="n">PLL_SOC1_ON</span> <span class="o">:</span> <span class="n">PLL_SOC1_OFF</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">MB1H_PLL_ON_OFF</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB1</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB1_PLL_ON_OFF</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">header</span> <span class="o">!=</span> <span class="n">MB1H_PLL_ON_OFF</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * db8500_prcmu_set_epod - set the state of a EPOD (power domain)</span>
<span class="cm"> * @epod_id: The EPOD to set</span>
<span class="cm"> * @epod_state: The new EPOD state</span>
<span class="cm"> *</span>
<span class="cm"> * This function sets the state of a EPOD (power domain). It may not be called</span>
<span class="cm"> * from interrupt context.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">db8500_prcmu_set_epod</span><span class="p">(</span><span class="n">u16</span> <span class="n">epod_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">epod_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ram_retention</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* check argument */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">epod_id</span> <span class="o">&gt;=</span> <span class="n">NUM_EPOD_ID</span><span class="p">);</span>

	<span class="cm">/* set flag if retention is possible */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">epod_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EPOD_ID_SVAMMDSP</span>:
	<span class="k">case</span> <span class="n">EPOD_ID_SIAMMDSP</span>:
	<span class="k">case</span> <span class="n">EPOD_ID_ESRAM12</span>:
	<span class="k">case</span> <span class="n">EPOD_ID_ESRAM34</span>:
		<span class="n">ram_retention</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check argument */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">epod_state</span> <span class="o">&gt;</span> <span class="n">EPOD_STATE_ON</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">epod_state</span> <span class="o">==</span> <span class="n">EPOD_STATE_RAMRET</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ram_retention</span><span class="p">);</span>

	<span class="cm">/* get lock */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb2_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* wait for mailbox */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="cm">/* fill in mailbox */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_EPOD_ID</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">EPOD_STATE_NO_CHANGE</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB2</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">epod_state</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB2</span> <span class="o">+</span> <span class="n">epod_id</span><span class="p">));</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">MB2H_DPS</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB2</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The current firmware version does not handle errors correctly,</span>
<span class="cm">	 * and we cannot recover if there is an error.</span>
<span class="cm">	 * This is expected to change when the firmware is updated.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb2_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">,</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20000</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;prcmu: %s timed out (20 s) waiting for a reply.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mb2_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">HWACC_PWR_ST_OK</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb2_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * prcmu_configure_auto_pm - Configure autonomous power management.</span>
<span class="cm"> * @sleep: Configuration for ApSleep.</span>
<span class="cm"> * @idle:  Configuration for ApIdle.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">prcmu_configure_auto_pm</span><span class="p">(</span><span class="k">struct</span> <span class="n">prcmu_auto_pm_config</span> <span class="o">*</span><span class="n">sleep</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">prcmu_auto_pm_config</span> <span class="o">*</span><span class="n">idle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sleep_cfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idle_cfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">sleep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">idle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">));</span>

	<span class="n">sleep_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">sleep</span><span class="o">-&gt;</span><span class="n">sva_auto_pm_enable</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>
	<span class="n">sleep_cfg</span> <span class="o">=</span> <span class="p">((</span><span class="n">sleep_cfg</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sleep</span><span class="o">-&gt;</span><span class="n">sia_auto_pm_enable</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">));</span>
	<span class="n">sleep_cfg</span> <span class="o">=</span> <span class="p">((</span><span class="n">sleep_cfg</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sleep</span><span class="o">-&gt;</span><span class="n">sva_power_on</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
	<span class="n">sleep_cfg</span> <span class="o">=</span> <span class="p">((</span><span class="n">sleep_cfg</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sleep</span><span class="o">-&gt;</span><span class="n">sia_power_on</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
	<span class="n">sleep_cfg</span> <span class="o">=</span> <span class="p">((</span><span class="n">sleep_cfg</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sleep</span><span class="o">-&gt;</span><span class="n">sva_policy</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">));</span>
	<span class="n">sleep_cfg</span> <span class="o">=</span> <span class="p">((</span><span class="n">sleep_cfg</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sleep</span><span class="o">-&gt;</span><span class="n">sia_policy</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">));</span>

	<span class="n">idle_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idle</span><span class="o">-&gt;</span><span class="n">sva_auto_pm_enable</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>
	<span class="n">idle_cfg</span> <span class="o">=</span> <span class="p">((</span><span class="n">idle_cfg</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">idle</span><span class="o">-&gt;</span><span class="n">sia_auto_pm_enable</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">));</span>
	<span class="n">idle_cfg</span> <span class="o">=</span> <span class="p">((</span><span class="n">idle_cfg</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">idle</span><span class="o">-&gt;</span><span class="n">sva_power_on</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
	<span class="n">idle_cfg</span> <span class="o">=</span> <span class="p">((</span><span class="n">idle_cfg</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">idle</span><span class="o">-&gt;</span><span class="n">sia_power_on</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
	<span class="n">idle_cfg</span> <span class="o">=</span> <span class="p">((</span><span class="n">idle_cfg</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">idle</span><span class="o">-&gt;</span><span class="n">sva_policy</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">));</span>
	<span class="n">idle_cfg</span> <span class="o">=</span> <span class="p">((</span><span class="n">idle_cfg</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">idle</span><span class="o">-&gt;</span><span class="n">sia_policy</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb2_transfer</span><span class="p">.</span><span class="n">auto_pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The autonomous power management configuration is done through</span>
<span class="cm">	 * fields in mailbox 2, but these fields are only used as shared</span>
<span class="cm">	 * variables - i.e. there is no need to send a message.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">sleep_cfg</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB2_AUTO_PM_SLEEP</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">idle_cfg</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB2_AUTO_PM_IDLE</span><span class="p">));</span>

	<span class="n">mb2_transfer</span><span class="p">.</span><span class="n">auto_pm_enabled</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">sleep</span><span class="o">-&gt;</span><span class="n">sva_auto_pm_enable</span> <span class="o">==</span> <span class="n">PRCMU_AUTO_PM_ON</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">sleep</span><span class="o">-&gt;</span><span class="n">sia_auto_pm_enable</span> <span class="o">==</span> <span class="n">PRCMU_AUTO_PM_ON</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">idle</span><span class="o">-&gt;</span><span class="n">sva_auto_pm_enable</span> <span class="o">==</span> <span class="n">PRCMU_AUTO_PM_ON</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">idle</span><span class="o">-&gt;</span><span class="n">sia_auto_pm_enable</span> <span class="o">==</span> <span class="n">PRCMU_AUTO_PM_ON</span><span class="p">));</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb2_transfer</span><span class="p">.</span><span class="n">auto_pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">prcmu_configure_auto_pm</span><span class="p">);</span>

<span class="n">bool</span> <span class="nf">prcmu_is_auto_pm_enabled</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mb2_transfer</span><span class="p">.</span><span class="n">auto_pm_enabled</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">request_sysclk</span><span class="p">(</span><span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb3_transfer</span><span class="p">.</span><span class="n">sysclk_lock</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb3_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writeb</span><span class="p">((</span><span class="n">enable</span> <span class="o">?</span> <span class="n">ON</span> <span class="o">:</span> <span class="n">OFF</span><span class="p">),</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB3_SYSCLK_MGT</span><span class="p">));</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">MB3H_SYSCLK</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB3</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb3_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The firmware only sends an ACK if we want to enable the</span>
<span class="cm">	 * SysClk, and it succeeds.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb3_transfer</span><span class="p">.</span><span class="n">sysclk_work</span><span class="p">,</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20000</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;prcmu: %s timed out (20 s) waiting for a reply.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb3_transfer</span><span class="p">.</span><span class="n">sysclk_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">request_timclk</span><span class="p">(</span><span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">PRCM_TCR_DOZE_MODE</span> <span class="o">|</span> <span class="n">PRCM_TCR_TENSEL_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">PRCM_TCR_STOP_TIMERS</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">PRCM_TCR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">request_clock</span><span class="p">(</span><span class="n">u8</span> <span class="n">clock</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_mgt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Grab the HW semaphore. */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_SEM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PRCM_SEM_PRCM_SEM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PRCM_CLK_MGT_CLKEN</span> <span class="o">|</span> <span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">pllsw</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">pllsw</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PRCM_CLK_MGT_CLKPLLSW_MASK</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PRCM_CLK_MGT_CLKEN</span> <span class="o">|</span> <span class="n">PRCM_CLK_MGT_CLKPLLSW_MASK</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Release the HW semaphore. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PRCM_SEM</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_mgt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">request_sga_clock</span><span class="p">(</span><span class="n">u8</span> <span class="n">clock</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_CGATING_BYPASS</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">PRCM_CGATING_BYPASS_ICN2</span><span class="p">,</span> <span class="n">PRCM_CGATING_BYPASS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_clock</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_CGATING_BYPASS</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PRCM_CGATING_BYPASS_ICN2</span><span class="p">,</span> <span class="n">PRCM_CGATING_BYPASS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">plldsi_locked</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_PLLDSI_LOCKP</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">PRCM_PLLDSI_LOCKP_PRCM_PLLDSI_LOCKP10</span> <span class="o">|</span>
		 <span class="n">PRCM_PLLDSI_LOCKP_PRCM_PLLDSI_LOCKP3</span><span class="p">))</span> <span class="o">==</span>
		<span class="p">(</span><span class="n">PRCM_PLLDSI_LOCKP_PRCM_PLLDSI_LOCKP10</span> <span class="o">|</span>
		 <span class="n">PRCM_PLLDSI_LOCKP_PRCM_PLLDSI_LOCKP3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">request_plldsi</span><span class="p">(</span><span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">((</span><span class="n">PRCM_MMIP_LS_CLAMP_DSIPLL_CLAMP</span> <span class="o">|</span>
		<span class="n">PRCM_MMIP_LS_CLAMP_DSIPLL_CLAMPI</span><span class="p">),</span> <span class="p">(</span><span class="n">enable</span> <span class="o">?</span>
		<span class="n">PRCM_MMIP_LS_CLAMP_CLR</span> <span class="o">:</span> <span class="n">PRCM_MMIP_LS_CLAMP_SET</span><span class="p">));</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_PLLDSI_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">PRCM_PLLDSI_ENABLE_PRCM_PLLDSI_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PRCM_PLLDSI_ENABLE_PRCM_PLLDSI_ENABLE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">PRCM_PLLDSI_ENABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">locked</span> <span class="o">=</span> <span class="n">plldsi_locked</span><span class="p">();</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="o">!</span><span class="n">locked</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="n">locked</span> <span class="o">=</span> <span class="n">plldsi_locked</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">locked</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">PRCM_APE_RESETN_DSIPLL_RESETN</span><span class="p">,</span>
				<span class="n">PRCM_APE_RESETN_SET</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">((</span><span class="n">PRCM_MMIP_LS_CLAMP_DSIPLL_CLAMP</span> <span class="o">|</span>
				<span class="n">PRCM_MMIP_LS_CLAMP_DSIPLL_CLAMPI</span><span class="p">),</span>
				<span class="n">PRCM_MMIP_LS_CLAMP_SET</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PRCM_PLLDSI_ENABLE_PRCM_PLLDSI_ENABLE</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">PRCM_PLLDSI_ENABLE</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">PRCM_APE_RESETN_DSIPLL_RESETN</span><span class="p">,</span> <span class="n">PRCM_APE_RESETN_CLR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">request_dsiclk</span><span class="p">(</span><span class="n">u8</span> <span class="n">n</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_DSI_PLLOUT_SEL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dsiclk</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">divsel_mask</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">enable</span> <span class="o">?</span> <span class="n">dsiclk</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">divsel</span> <span class="o">:</span> <span class="n">PRCM_DSI_PLLOUT_SEL_OFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">dsiclk</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">divsel_shift</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">PRCM_DSI_PLLOUT_SEL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">request_dsiescclk</span><span class="p">(</span><span class="n">u8</span> <span class="n">n</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_DSITVCLK_DIV</span><span class="p">);</span>
	<span class="n">enable</span> <span class="o">?</span> <span class="p">(</span><span class="n">val</span> <span class="o">|=</span> <span class="n">dsiescclk</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">en</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dsiescclk</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">en</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">PRCM_DSITVCLK_DIV</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * db8500_prcmu_request_clock() - Request for a clock to be enabled or disabled.</span>
<span class="cm"> * @clock:      The clock for which the request is made.</span>
<span class="cm"> * @enable:     Whether the clock should be enabled (true) or disabled (false).</span>
<span class="cm"> *</span>
<span class="cm"> * This function should only be used by the clock implementation.</span>
<span class="cm"> * Do not use it from any other place!</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">db8500_prcmu_request_clock</span><span class="p">(</span><span class="n">u8</span> <span class="n">clock</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_SGACLK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">request_sga_clock</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">&lt;</span> <span class="n">PRCMU_NUM_REG_CLOCKS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">request_clock</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_TIMCLK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">request_timclk</span><span class="p">(</span><span class="n">enable</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_DSI0CLK</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_DSI1CLK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">request_dsiclk</span><span class="p">((</span><span class="n">clock</span> <span class="o">-</span> <span class="n">PRCMU_DSI0CLK</span><span class="p">),</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">PRCMU_DSI0ESCCLK</span> <span class="o">&lt;=</span> <span class="n">clock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">clock</span> <span class="o">&lt;=</span> <span class="n">PRCMU_DSI2ESCCLK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">request_dsiescclk</span><span class="p">((</span><span class="n">clock</span> <span class="o">-</span> <span class="n">PRCMU_DSI0ESCCLK</span><span class="p">),</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_PLLDSI</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">request_plldsi</span><span class="p">(</span><span class="n">enable</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_SYSCLK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">request_sysclk</span><span class="p">(</span><span class="n">enable</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_PLLSOC0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_PLLSOC1</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">request_pll</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">pll_rate</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src_rate</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">branch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">d</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">src_rate</span><span class="p">;</span>
	<span class="n">rate</span> <span class="o">*=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PRCM_PLL_FREQ_D_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PRCM_PLL_FREQ_D_SHIFT</span><span class="p">);</span>

	<span class="n">d</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PRCM_PLL_FREQ_N_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PRCM_PLL_FREQ_N_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">div</span> <span class="o">*=</span> <span class="n">d</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PRCM_PLL_FREQ_R_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PRCM_PLL_FREQ_R_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">div</span> <span class="o">*=</span> <span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PRCM_PLL_FREQ_SELDIV2</span><span class="p">)</span>
		<span class="n">div</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">branch</span> <span class="o">==</span> <span class="n">PLL_FIX</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">branch</span> <span class="o">==</span> <span class="n">PLL_DIV</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PRCM_PLL_FREQ_DIV2EN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">reg</span> <span class="o">==</span> <span class="n">PRCM_PLLSOC0_FREQ</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">PRCM_PLLDDR_FREQ</span><span class="p">))))</span>
		<span class="n">div</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">do_div</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ROOT_CLOCK_RATE 38400000</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">clock_rate</span><span class="p">(</span><span class="n">u8</span> <span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pllsw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">ROOT_CLOCK_RATE</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PRCM_CLK_MGT_CLK38</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">clk38div</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PRCM_CLK_MGT_CLK38DIV</span><span class="p">))</span>
			<span class="n">rate</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">pllsw</span><span class="p">;</span>
	<span class="n">pllsw</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PRCM_CLK_MGT_CLKPLLSW_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pllsw</span> <span class="o">==</span> <span class="n">PRCM_CLK_MGT_CLKPLLSW_SOC0</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">pll_rate</span><span class="p">(</span><span class="n">PRCM_PLLSOC0_FREQ</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">branch</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pllsw</span> <span class="o">==</span> <span class="n">PRCM_CLK_MGT_CLKPLLSW_SOC1</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">pll_rate</span><span class="p">(</span><span class="n">PRCM_PLLSOC1_FREQ</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">branch</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pllsw</span> <span class="o">==</span> <span class="n">PRCM_CLK_MGT_CLKPLLSW_DDR</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">pll_rate</span><span class="p">(</span><span class="n">PRCM_PLLDDR_FREQ</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">branch</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_SGACLK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PRCM_SGACLK_MGT_SGACLKDIV_BY_2_5_EN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>

		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">do_div</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">PRCM_CLK_MGT_CLKPLLDIV_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rate</span> <span class="o">/</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">dsiclk_rate</span><span class="p">(</span><span class="n">u8</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">divsel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">divsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_DSI_PLLOUT_SEL</span><span class="p">);</span>
	<span class="n">divsel</span> <span class="o">=</span> <span class="p">((</span><span class="n">divsel</span> <span class="o">&amp;</span> <span class="n">dsiclk</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">divsel_mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">dsiclk</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">divsel_shift</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">divsel</span> <span class="o">==</span> <span class="n">PRCM_DSI_PLLOUT_SEL_OFF</span><span class="p">)</span>
		<span class="n">divsel</span> <span class="o">=</span> <span class="n">dsiclk</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">divsel</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">divsel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRCM_DSI_PLLOUT_SEL_PHI_4</span>:
		<span class="n">div</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRCM_DSI_PLLOUT_SEL_PHI_2</span>:
		<span class="n">div</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRCM_DSI_PLLOUT_SEL_PHI</span>:
		<span class="k">return</span> <span class="n">pll_rate</span><span class="p">(</span><span class="n">PRCM_PLLDSI_FREQ</span><span class="p">,</span> <span class="n">clock_rate</span><span class="p">(</span><span class="n">PRCMU_HDMICLK</span><span class="p">),</span>
			<span class="n">PLL_RAW</span><span class="p">)</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">dsiescclk_rate</span><span class="p">(</span><span class="n">u8</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_DSITVCLK_DIV</span><span class="p">);</span>
	<span class="n">div</span> <span class="o">=</span> <span class="p">((</span><span class="n">div</span> <span class="o">&amp;</span> <span class="n">dsiescclk</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">div_mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">dsiescclk</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">div_shift</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">clock_rate</span><span class="p">(</span><span class="n">PRCMU_TVCLK</span><span class="p">)</span> <span class="o">/</span> <span class="n">max</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mi">1</span><span class="p">,</span> <span class="n">div</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">prcmu_clock_rate</span><span class="p">(</span><span class="n">u8</span> <span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">&lt;</span> <span class="n">PRCMU_NUM_REG_CLOCKS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">clock_rate</span><span class="p">(</span><span class="n">clock</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_TIMCLK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ROOT_CLOCK_RATE</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_SYSCLK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ROOT_CLOCK_RATE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_PLLSOC0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pll_rate</span><span class="p">(</span><span class="n">PRCM_PLLSOC0_FREQ</span><span class="p">,</span> <span class="n">ROOT_CLOCK_RATE</span><span class="p">,</span> <span class="n">PLL_RAW</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_PLLSOC1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pll_rate</span><span class="p">(</span><span class="n">PRCM_PLLSOC1_FREQ</span><span class="p">,</span> <span class="n">ROOT_CLOCK_RATE</span><span class="p">,</span> <span class="n">PLL_RAW</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_PLLDDR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pll_rate</span><span class="p">(</span><span class="n">PRCM_PLLDDR_FREQ</span><span class="p">,</span> <span class="n">ROOT_CLOCK_RATE</span><span class="p">,</span> <span class="n">PLL_RAW</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_PLLDSI</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pll_rate</span><span class="p">(</span><span class="n">PRCM_PLLDSI_FREQ</span><span class="p">,</span> <span class="n">clock_rate</span><span class="p">(</span><span class="n">PRCMU_HDMICLK</span><span class="p">),</span>
			<span class="n">PLL_RAW</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_DSI0CLK</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_DSI1CLK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">dsiclk_rate</span><span class="p">(</span><span class="n">clock</span> <span class="o">-</span> <span class="n">PRCMU_DSI0CLK</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">PRCMU_DSI0ESCCLK</span> <span class="o">&lt;=</span> <span class="n">clock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">clock</span> <span class="o">&lt;=</span> <span class="n">PRCMU_DSI2ESCCLK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">dsiescclk_rate</span><span class="p">(</span><span class="n">clock</span> <span class="o">-</span> <span class="n">PRCMU_DSI0ESCCLK</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">clock_source_rate</span><span class="p">(</span><span class="n">u32</span> <span class="n">clk_mgt_val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">branch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk_mgt_val</span> <span class="o">&amp;</span> <span class="n">PRCM_CLK_MGT_CLK38</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ROOT_CLOCK_RATE</span><span class="p">;</span>
	<span class="n">clk_mgt_val</span> <span class="o">&amp;=</span> <span class="n">PRCM_CLK_MGT_CLKPLLSW_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk_mgt_val</span> <span class="o">==</span> <span class="n">PRCM_CLK_MGT_CLKPLLSW_SOC0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pll_rate</span><span class="p">(</span><span class="n">PRCM_PLLSOC0_FREQ</span><span class="p">,</span> <span class="n">ROOT_CLOCK_RATE</span><span class="p">,</span> <span class="n">branch</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clk_mgt_val</span> <span class="o">==</span> <span class="n">PRCM_CLK_MGT_CLKPLLSW_SOC1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pll_rate</span><span class="p">(</span><span class="n">PRCM_PLLSOC1_FREQ</span><span class="p">,</span> <span class="n">ROOT_CLOCK_RATE</span><span class="p">,</span> <span class="n">branch</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clk_mgt_val</span> <span class="o">==</span> <span class="n">PRCM_CLK_MGT_CLKPLLSW_DDR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pll_rate</span><span class="p">(</span><span class="n">PRCM_PLLDDR_FREQ</span><span class="p">,</span> <span class="n">ROOT_CLOCK_RATE</span><span class="p">,</span> <span class="n">branch</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">clock_divider</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src_rate</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_rate</span> <span class="o">/</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">src_rate</span> <span class="o">/</span> <span class="n">div</span><span class="p">))</span>
		<span class="n">div</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">div</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">round_clock_rate</span><span class="p">(</span><span class="n">u8</span> <span class="n">clock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src_rate</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">rounded_rate</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">src_rate</span> <span class="o">=</span> <span class="n">clock_source_rate</span><span class="p">((</span><span class="n">val</span> <span class="o">|</span> <span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">pllsw</span><span class="p">),</span>
		<span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">branch</span><span class="p">);</span>
	<span class="n">div</span> <span class="o">=</span> <span class="n">clock_divider</span><span class="p">(</span><span class="n">src_rate</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PRCM_CLK_MGT_CLK38</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">clk38div</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">div</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_SGACLK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">div</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_rate</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>

		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">do_div</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="n">rate</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rounded_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_rate</span> <span class="o">/</span> <span class="n">min</span><span class="p">(</span><span class="n">div</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">31</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">rounded_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MIN_PLL_VCO_RATE 600000000ULL</span>
<span class="cp">#define MAX_PLL_VCO_RATE 1680640000ULL</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">round_plldsi_rate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">rounded_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src_rate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rem</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">src_rate</span> <span class="o">=</span> <span class="n">clock_rate</span><span class="p">(</span><span class="n">PRCMU_HDMICLK</span><span class="p">);</span>
	<span class="n">rem</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="p">(</span><span class="n">rem</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span> <span class="n">r</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">d</span><span class="p">;</span>

		<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">rate</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">do_div</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">src_rate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">d</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
			<span class="n">d</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">*=</span> <span class="n">src_rate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">MIN_PLL_VCO_RATE</span><span class="p">))</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">r</span> <span class="o">*</span> <span class="n">MAX_PLL_VCO_RATE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">d</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">do_div</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="n">d</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rounded_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">rounded_rate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">d</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rate</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rem</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate</span> <span class="o">-</span> <span class="n">d</span><span class="p">);</span>
			<span class="n">rounded_rate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">d</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rounded_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">round_dsiclk_rate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src_rate</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">rounded_rate</span><span class="p">;</span>

	<span class="n">src_rate</span> <span class="o">=</span> <span class="n">pll_rate</span><span class="p">(</span><span class="n">PRCM_PLLDSI_FREQ</span><span class="p">,</span> <span class="n">clock_rate</span><span class="p">(</span><span class="n">PRCMU_HDMICLK</span><span class="p">),</span>
		<span class="n">PLL_RAW</span><span class="p">);</span>
	<span class="n">div</span> <span class="o">=</span> <span class="n">clock_divider</span><span class="p">(</span><span class="n">src_rate</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="n">rounded_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_rate</span> <span class="o">/</span> <span class="p">((</span><span class="n">div</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="n">div</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">rounded_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">round_dsiescclk_rate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src_rate</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">rounded_rate</span><span class="p">;</span>

	<span class="n">src_rate</span> <span class="o">=</span> <span class="n">clock_rate</span><span class="p">(</span><span class="n">PRCMU_TVCLK</span><span class="p">);</span>
	<span class="n">div</span> <span class="o">=</span> <span class="n">clock_divider</span><span class="p">(</span><span class="n">src_rate</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="n">rounded_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_rate</span> <span class="o">/</span> <span class="n">min</span><span class="p">(</span><span class="n">div</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">255</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">rounded_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">prcmu_round_clock_rate</span><span class="p">(</span><span class="n">u8</span> <span class="n">clock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">&lt;</span> <span class="n">PRCMU_NUM_REG_CLOCKS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">round_clock_rate</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_PLLDSI</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">round_plldsi_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_DSI0CLK</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_DSI1CLK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">round_dsiclk_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">PRCMU_DSI0ESCCLK</span> <span class="o">&lt;=</span> <span class="n">clock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">clock</span> <span class="o">&lt;=</span> <span class="n">PRCMU_DSI2ESCCLK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">round_dsiescclk_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">prcmu_clock_rate</span><span class="p">(</span><span class="n">clock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_clock_rate</span><span class="p">(</span><span class="n">u8</span> <span class="n">clock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src_rate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_mgt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Grab the HW semaphore. */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_SEM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PRCM_SEM_PRCM_SEM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">src_rate</span> <span class="o">=</span> <span class="n">clock_source_rate</span><span class="p">((</span><span class="n">val</span> <span class="o">|</span> <span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">pllsw</span><span class="p">),</span>
		<span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">branch</span><span class="p">);</span>
	<span class="n">div</span> <span class="o">=</span> <span class="n">clock_divider</span><span class="p">(</span><span class="n">src_rate</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PRCM_CLK_MGT_CLK38</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">clk38div</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">PRCM_CLK_MGT_CLK38DIV</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PRCM_CLK_MGT_CLK38DIV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_SGACLK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PRCM_CLK_MGT_CLKPLLDIV_MASK</span> <span class="o">|</span>
			<span class="n">PRCM_SGACLK_MGT_SGACLKDIV_BY_2_5_EN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_rate</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>

			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">do_div</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">PRCM_SGACLK_MGT_SGACLKDIV_BY_2_5_EN</span><span class="p">;</span>
				<span class="n">div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">min</span><span class="p">(</span><span class="n">div</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">31</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PRCM_CLK_MGT_CLKPLLDIV_MASK</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">min</span><span class="p">(</span><span class="n">div</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">31</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">clk_mgt</span><span class="p">[</span><span class="n">clock</span><span class="p">].</span><span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Release the HW semaphore. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PRCM_SEM</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clk_mgt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_plldsi_rate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src_rate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rem</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pll_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">src_rate</span> <span class="o">=</span> <span class="n">clock_rate</span><span class="p">(</span><span class="n">PRCMU_HDMICLK</span><span class="p">);</span>
	<span class="n">rem</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="p">(</span><span class="n">rem</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span> <span class="n">r</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">d</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">hwrate</span><span class="p">;</span>

		<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">rate</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">do_div</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">src_rate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">d</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
			<span class="n">d</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">hwrate</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">src_rate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">hwrate</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">MIN_PLL_VCO_RATE</span><span class="p">))</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">r</span> <span class="o">*</span> <span class="n">MAX_PLL_VCO_RATE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">hwrate</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">do_div</span><span class="p">(</span><span class="n">hwrate</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="n">hwrate</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pll_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">pll_freq</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">d</span> <span class="o">&lt;&lt;</span> <span class="n">PRCM_PLL_FREQ_D_SHIFT</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="n">PRCM_PLL_FREQ_R_SHIFT</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rate</span> <span class="o">-</span> <span class="n">hwrate</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rem</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate</span> <span class="o">-</span> <span class="n">hwrate</span><span class="p">);</span>
			<span class="n">pll_freq</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">d</span> <span class="o">&lt;&lt;</span> <span class="n">PRCM_PLL_FREQ_D_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="n">PRCM_PLL_FREQ_R_SHIFT</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pll_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pll_freq</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PRCM_PLL_FREQ_N_SHIFT</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pll_freq</span><span class="p">,</span> <span class="n">PRCM_PLLDSI_FREQ</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_dsiclk_rate</span><span class="p">(</span><span class="n">u8</span> <span class="n">n</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="n">clock_divider</span><span class="p">(</span><span class="n">pll_rate</span><span class="p">(</span><span class="n">PRCM_PLLDSI_FREQ</span><span class="p">,</span>
			<span class="n">clock_rate</span><span class="p">(</span><span class="n">PRCMU_HDMICLK</span><span class="p">),</span> <span class="n">PLL_RAW</span><span class="p">),</span> <span class="n">rate</span><span class="p">);</span>

	<span class="n">dsiclk</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">divsel</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">PRCM_DSI_PLLOUT_SEL_PHI</span> <span class="o">:</span>
			   <span class="p">(</span><span class="n">div</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="n">PRCM_DSI_PLLOUT_SEL_PHI_2</span> <span class="o">:</span>
			   <span class="cm">/* else */</span>	<span class="n">PRCM_DSI_PLLOUT_SEL_PHI_4</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_DSI_PLLOUT_SEL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dsiclk</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">divsel_mask</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dsiclk</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">divsel</span> <span class="o">&lt;&lt;</span> <span class="n">dsiclk</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">divsel_shift</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">PRCM_DSI_PLLOUT_SEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_dsiescclk_rate</span><span class="p">(</span><span class="n">u8</span> <span class="n">n</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="n">clock_divider</span><span class="p">(</span><span class="n">clock_rate</span><span class="p">(</span><span class="n">PRCMU_TVCLK</span><span class="p">),</span> <span class="n">rate</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_DSITVCLK_DIV</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dsiescclk</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">div_mask</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">div</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="mi">255</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">dsiescclk</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">div_shift</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">PRCM_DSITVCLK_DIV</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">prcmu_set_clock_rate</span><span class="p">(</span><span class="n">u8</span> <span class="n">clock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">&lt;</span> <span class="n">PRCMU_NUM_REG_CLOCKS</span><span class="p">)</span>
		<span class="n">set_clock_rate</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_PLLDSI</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">set_plldsi_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_DSI0CLK</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">clock</span> <span class="o">==</span> <span class="n">PRCMU_DSI1CLK</span><span class="p">))</span>
		<span class="n">set_dsiclk_rate</span><span class="p">((</span><span class="n">clock</span> <span class="o">-</span> <span class="n">PRCMU_DSI0CLK</span><span class="p">),</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">PRCMU_DSI0ESCCLK</span> <span class="o">&lt;=</span> <span class="n">clock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">clock</span> <span class="o">&lt;=</span> <span class="n">PRCMU_DSI2ESCCLK</span><span class="p">))</span>
		<span class="n">set_dsiescclk_rate</span><span class="p">((</span><span class="n">clock</span> <span class="o">-</span> <span class="n">PRCMU_DSI0ESCCLK</span><span class="p">),</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">db8500_prcmu_config_esram0_deep_sleep</span><span class="p">(</span><span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">ESRAM0_DEEP_SLEEP_STATE_RET</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">ESRAM0_DEEP_SLEEP_STATE_OFF</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">MB4H_MEM_ST</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB4</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(((</span><span class="n">DDR_PWR_STATE_OFFHIGHLAT</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DDR_PWR_STATE_ON</span><span class="p">),</span>
	       <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB4_DDR_ST_AP_SLEEP_IDLE</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">DDR_PWR_STATE_ON</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB4_DDR_ST_AP_DEEP_IDLE</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB4_ESRAM0_ST</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">db8500_prcmu_config_hotdog</span><span class="p">(</span><span class="n">u8</span> <span class="n">threshold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB4_HOTDOG_THRESHOLD</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">MB4H_HOTDOG</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB4</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">db8500_prcmu_config_hotmon</span><span class="p">(</span><span class="n">u8</span> <span class="n">low</span><span class="p">,</span> <span class="n">u8</span> <span class="n">high</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB4_HOTMON_LOW</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB4_HOTMON_HIGH</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">((</span><span class="n">HOTMON_CONFIG_LOW</span> <span class="o">|</span> <span class="n">HOTMON_CONFIG_HIGH</span><span class="p">),</span>
		<span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB4_HOTMON_CONFIG</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">MB4H_HOTMON</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB4</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">config_hot_period</span><span class="p">(</span><span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writew</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB4_HOT_PERIOD</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">MB4H_HOT_PERIOD</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB4</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">db8500_prcmu_start_temp_sense</span><span class="p">(</span><span class="n">u16</span> <span class="n">cycles32k</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycles32k</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">config_hot_period</span><span class="p">(</span><span class="n">cycles32k</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">db8500_prcmu_stop_temp_sense</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">config_hot_period</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prcmu_a9wdog</span><span class="p">(</span><span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">d0</span><span class="p">,</span> <span class="n">u8</span> <span class="n">d1</span><span class="p">,</span> <span class="n">u8</span> <span class="n">d2</span><span class="p">,</span> <span class="n">u8</span> <span class="n">d3</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB4_A9WDOG_0</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB4_A9WDOG_1</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB4_A9WDOG_2</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">d3</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB4_A9WDOG_3</span><span class="p">));</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB4</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">db8500_prcmu_config_a9wdog</span><span class="p">(</span><span class="n">u8</span> <span class="n">num</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sleep_auto_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">prcmu_a9wdog</span><span class="p">(</span><span class="n">MB4H_A9WDOG_CONF</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="n">sleep_auto_off</span> <span class="o">?</span> <span class="n">A9WDOG_AUTO_OFF_EN</span> <span class="o">:</span>
			    <span class="n">A9WDOG_AUTO_OFF_DIS</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">db8500_prcmu_enable_a9wdog</span><span class="p">(</span><span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">prcmu_a9wdog</span><span class="p">(</span><span class="n">MB4H_A9WDOG_EN</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">db8500_prcmu_disable_a9wdog</span><span class="p">(</span><span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">prcmu_a9wdog</span><span class="p">(</span><span class="n">MB4H_A9WDOG_DIS</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">db8500_prcmu_kick_a9wdog</span><span class="p">(</span><span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">prcmu_a9wdog</span><span class="p">(</span><span class="n">MB4H_A9WDOG_KICK</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * timeout is 28 bit, in ms.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">db8500_prcmu_load_a9wdog</span><span class="p">(</span><span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">prcmu_a9wdog</span><span class="p">(</span><span class="n">MB4H_A9WDOG_LOAD</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">A9WDOG_ID_MASK</span><span class="p">)</span> <span class="o">|</span>
			    <span class="cm">/*</span>
<span class="cm">			     * Put the lowest 28 bits of timeout at</span>
<span class="cm">			     * offset 4. Four first bits are used for id.</span>
<span class="cm">			     */</span>
			    <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">timeout</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">timeout</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">timeout</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">timeout</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * prcmu_abb_read() - Read register value(s) from the ABB.</span>
<span class="cm"> * @slave:	The I2C slave address.</span>
<span class="cm"> * @reg:	The (start) register address.</span>
<span class="cm"> * @value:	The read out value(s).</span>
<span class="cm"> * @size:	The number of registers to read.</span>
<span class="cm"> *</span>
<span class="cm"> * Reads register value(s) from the ABB.</span>
<span class="cm"> * @size has to be 1 for the current firmware version.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">prcmu_abb_read</span><span class="p">(</span><span class="n">u8</span> <span class="n">slave</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">u8</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb5_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB5</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">PRCMU_I2C_READ</span><span class="p">(</span><span class="n">slave</span><span class="p">),</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB5_I2C_SLAVE_OP</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">PRCMU_I2C_STOP_EN</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB5_I2C_HW_BITS</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB5_I2C_REG</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB5_I2C_VAL</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb5_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20000</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;prcmu: %s timed out (20 s) waiting for a reply.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="p">((</span><span class="n">mb5_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">I2C_RD_OK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">mb5_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb5_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * prcmu_abb_write_masked() - Write masked register value(s) to the ABB.</span>
<span class="cm"> * @slave:	The I2C slave address.</span>
<span class="cm"> * @reg:	The (start) register address.</span>
<span class="cm"> * @value:	The value(s) to write.</span>
<span class="cm"> * @mask:	The mask(s) to use.</span>
<span class="cm"> * @size:	The number of registers to write.</span>
<span class="cm"> *</span>
<span class="cm"> * Writes masked register value(s) to the ABB.</span>
<span class="cm"> * For each @value, only the bits set to 1 in the corresponding @mask</span>
<span class="cm"> * will be written. The other bits are not changed.</span>
<span class="cm"> * @size has to be 1 for the current firmware version.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">prcmu_abb_write_masked</span><span class="p">(</span><span class="n">u8</span> <span class="n">slave</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb5_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writeb</span><span class="p">(</span><span class="o">~*</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB5</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">PRCMU_I2C_WRITE</span><span class="p">(</span><span class="n">slave</span><span class="p">),</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB5_I2C_SLAVE_OP</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">PRCMU_I2C_STOP_EN</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB5_I2C_HW_BITS</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB5_I2C_REG</span><span class="p">));</span>
	<span class="n">writeb</span><span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_REQ_MB5_I2C_VAL</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb5_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20000</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;prcmu: %s timed out (20 s) waiting for a reply.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="p">((</span><span class="n">mb5_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">I2C_WR_OK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb5_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * prcmu_abb_write() - Write register value(s) to the ABB.</span>
<span class="cm"> * @slave:	The I2C slave address.</span>
<span class="cm"> * @reg:	The (start) register address.</span>
<span class="cm"> * @value:	The value(s) to write.</span>
<span class="cm"> * @size:	The number of registers to write.</span>
<span class="cm"> *</span>
<span class="cm"> * Writes register value(s) to the ABB.</span>
<span class="cm"> * @size has to be 1 for the current firmware version.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">prcmu_abb_write</span><span class="p">(</span><span class="n">u8</span> <span class="n">slave</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">u8</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">prcmu_abb_write_masked</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * prcmu_ac_wake_req - should be called whenever ARM wants to wakeup Modem</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">prcmu_ac_wake_req</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">ac_wake_lock</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_HOSTACCESS_REQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PRCM_HOSTACCESS_REQ_HOSTACCESS_REQ</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac_wake_req_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="nl">retry:</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">val</span> <span class="o">|</span> <span class="n">PRCM_HOSTACCESS_REQ_HOSTACCESS_REQ</span><span class="p">),</span> <span class="n">PRCM_HOSTACCESS_REQ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">ac_wake_work</span><span class="p">,</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">5000</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;prcmu: %s timed out (5 s) waiting for a reply.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The modem can generate an AC_WAKE_ACK, and then still go to sleep.</span>
<span class="cm">	 * As a workaround, we wait, and then check that the modem is indeed</span>
<span class="cm">	 * awake (in terms of the value of the PRCM_MOD_AWAKE_STATUS</span>
<span class="cm">	 * register, which may not be the whole truth).</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MOD_AWAKE_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BITS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="p">(</span><span class="n">PRCM_MOD_AWAKE_STATUS_PRCM_MOD_AAPD_AWAKE</span> <span class="o">|</span>
			<span class="n">PRCM_MOD_AWAKE_STATUS_PRCM_MOD_COREPD_AWAKE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;prcmu: %s received ack, but modem not awake (0x%X).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1200</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">PRCM_HOSTACCESS_REQ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">ac_wake_work</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">5000</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;prcmu: %s timed out (5 s) waiting for AC_SLEEP_ACK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">ac_wake_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * prcmu_ac_sleep_req - called when ARM no longer needs to talk to modem</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">prcmu_ac_sleep_req</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">ac_wake_lock</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_HOSTACCESS_REQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PRCM_HOSTACCESS_REQ_HOSTACCESS_REQ</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">unlock_and_return</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PRCM_HOSTACCESS_REQ_HOSTACCESS_REQ</span><span class="p">),</span>
		<span class="n">PRCM_HOSTACCESS_REQ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">ac_wake_work</span><span class="p">,</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">5000</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;prcmu: %s timed out (5 s) waiting for a reply.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac_wake_req_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">unlock_and_return:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">ac_wake_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">db8500_prcmu_is_ac_wake_requested</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac_wake_req_state</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * db8500_prcmu_system_reset - System reset</span>
<span class="cm"> *</span>
<span class="cm"> * Saves the reset reason code and then sets the APE_SOFTRST register which</span>
<span class="cm"> * fires interrupt to fw</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">db8500_prcmu_system_reset</span><span class="p">(</span><span class="n">u16</span> <span class="n">reset_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">reset_code</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_SW_RST_REASON</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">PRCM_APE_SOFTRST</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * db8500_prcmu_get_reset_code - Retrieve SW reset reason code</span>
<span class="cm"> *</span>
<span class="cm"> * Retrieves the reset reason code stored by prcmu_system_reset() before</span>
<span class="cm"> * last restart.</span>
<span class="cm"> */</span>
<span class="n">u16</span> <span class="nf">db8500_prcmu_get_reset_code</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readw</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_SW_RST_REASON</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * db8500_prcmu_reset_modem - ask the PRCMU to reset modem</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">db8500_prcmu_modem_reset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">MB1H_RESET_MODEM</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB1</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * No need to check return from PRCMU as modem should go in reset state</span>
<span class="cm">	 * This state is already managed by upper layer</span>
<span class="cm">	 */</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ack_dbb_wakeup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_MBOX_CPU_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">MB0H_READ_WAKEUP_ACK</span><span class="p">,</span> <span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB0</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">PRCM_MBOX_CPU_SET</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">print_unknown_header_warning</span><span class="p">(</span><span class="n">u8</span> <span class="n">n</span><span class="p">,</span> <span class="n">u8</span> <span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;prcmu: Unknown message header (%d) in mailbox %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">header</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">read_mailbox_0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">header</span><span class="p">;</span>

	<span class="n">header</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_ACK_MB0</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MB0H_WAKEUP_EXE</span>:
	<span class="k">case</span> <span class="n">MB0H_WAKEUP_SLEEP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_ACK_MB0_READ_POINTER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">ev</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_ACK_MB0_WAKEUP_1_8500</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ev</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_ACK_MB0_WAKEUP_0_8500</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WAKEUP_BIT_AC_WAKE_ACK</span> <span class="o">|</span> <span class="n">WAKEUP_BIT_AC_SLEEP_ACK</span><span class="p">))</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">ac_wake_work</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">WAKEUP_BIT_SYSCLK_OK</span><span class="p">)</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb3_transfer</span><span class="p">.</span><span class="n">sysclk_work</span><span class="p">);</span>

		<span class="n">ev</span> <span class="o">&amp;=</span> <span class="n">mb0_transfer</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">dbb_irqs</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">NUM_PRCMU_WAKEUPS</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">prcmu_irq_bit</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
				<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">IRQ_PRCMU_BASE</span> <span class="o">+</span> <span class="n">n</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">print_unknown_header_warning</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">PRCM_ARM_IT1_CLR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">read_mailbox_1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB1</span><span class="p">);</span>
	<span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">arm_opp</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span>
		<span class="n">PRCM_ACK_MB1_CURRENT_ARM_OPP</span><span class="p">);</span>
	<span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">ape_opp</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span>
		<span class="n">PRCM_ACK_MB1_CURRENT_APE_OPP</span><span class="p">);</span>
	<span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">ape_voltage_status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span>
		<span class="n">PRCM_ACK_MB1_APE_VOLTAGE_STATUS</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">PRCM_ARM_IT1_CLR</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">read_mailbox_2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mb2_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_ACK_MB2_DPS_STATUS</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">PRCM_ARM_IT1_CLR</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb2_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">read_mailbox_3</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">PRCM_ARM_IT1_CLR</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">read_mailbox_4</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">do_complete</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">header</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_MBOX_HEADER_REQ_MB4</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MB4H_MEM_ST</span>:
	<span class="k">case</span> <span class="n">MB4H_HOTDOG</span>:
	<span class="k">case</span> <span class="n">MB4H_HOTMON</span>:
	<span class="k">case</span> <span class="n">MB4H_HOT_PERIOD</span>:
	<span class="k">case</span> <span class="n">MB4H_A9WDOG_CONF</span>:
	<span class="k">case</span> <span class="n">MB4H_A9WDOG_EN</span>:
	<span class="k">case</span> <span class="n">MB4H_A9WDOG_DIS</span>:
	<span class="k">case</span> <span class="n">MB4H_A9WDOG_LOAD</span>:
	<span class="k">case</span> <span class="n">MB4H_A9WDOG_KICK</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">print_unknown_header_warning</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
		<span class="n">do_complete</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">PRCM_ARM_IT1_CLR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_complete</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">read_mailbox_5</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mb5_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_ACK_MB5_I2C_STATUS</span><span class="p">);</span>
	<span class="n">mb5_transfer</span><span class="p">.</span><span class="n">ack</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">tcdm_base</span> <span class="o">+</span> <span class="n">PRCM_ACK_MB5_I2C_VAL</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">PRCM_ARM_IT1_CLR</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb5_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">read_mailbox_6</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">PRCM_ARM_IT1_CLR</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">read_mailbox_7</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">MBOX_BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">PRCM_ARM_IT1_CLR</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="p">(</span><span class="o">*</span> <span class="k">const</span> <span class="n">read_mailbox</span><span class="p">[</span><span class="n">NUM_MB</span><span class="p">])(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">read_mailbox_0</span><span class="p">,</span>
	<span class="n">read_mailbox_1</span><span class="p">,</span>
	<span class="n">read_mailbox_2</span><span class="p">,</span>
	<span class="n">read_mailbox_3</span><span class="p">,</span>
	<span class="n">read_mailbox_4</span><span class="p">,</span>
	<span class="n">read_mailbox_5</span><span class="p">,</span>
	<span class="n">read_mailbox_6</span><span class="p">,</span>
	<span class="n">read_mailbox_7</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">prcmu_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">PRCM_ARM_IT1_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ALL_MBOX_BITS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">bits</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bits</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bits</span> <span class="o">-=</span> <span class="n">MBOX_BIT</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">read_mailbox</span><span class="p">[</span><span class="n">n</span><span class="p">]())</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">IRQ_WAKE_THREAD</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">prcmu_irq_thread_fn</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ack_dbb_wakeup</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prcmu_mask_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">config_wakeups</span><span class="p">();</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prcmu_irq_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">dbb_irqs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mb0_transfer</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">dbb_irqs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">prcmu_irq_bit</span><span class="p">[</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">IRQ_PRCMU_BASE</span><span class="p">];</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">dbb_irqs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">IRQ_PRCMU_CA_SLEEP</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">mask_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prcmu_irq_unmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">dbb_irqs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mb0_transfer</span><span class="p">.</span><span class="n">req</span><span class="p">.</span><span class="n">dbb_irqs</span> <span class="o">|=</span> <span class="n">prcmu_irq_bit</span><span class="p">[</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">IRQ_PRCMU_BASE</span><span class="p">];</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">dbb_irqs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">IRQ_PRCMU_CA_SLEEP</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">mask_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">noop</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">prcmu_irq_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;prcmu&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_disable</span>	<span class="o">=</span> <span class="n">prcmu_irq_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_ack</span>	<span class="o">=</span> <span class="n">noop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">prcmu_irq_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">prcmu_irq_unmask</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">fw_project_name</span><span class="p">(</span><span class="n">u8</span> <span class="n">project</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">project</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRCMU_FW_PROJECT_U8500</span>:
		<span class="k">return</span> <span class="s">&quot;U8500&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRCMU_FW_PROJECT_U8500_C2</span>:
		<span class="k">return</span> <span class="s">&quot;U8500 C2&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRCMU_FW_PROJECT_U9500</span>:
		<span class="k">return</span> <span class="s">&quot;U9500&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRCMU_FW_PROJECT_U9500_C2</span>:
		<span class="k">return</span> <span class="s">&quot;U9500 C2&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRCMU_FW_PROJECT_U8520</span>:
		<span class="k">return</span> <span class="s">&quot;U8520&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRCMU_FW_PROJECT_U8420</span>:
		<span class="k">return</span> <span class="s">&quot;U8420&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">db8500_prcmu_early_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_u8500v2</span><span class="p">())</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">tcpm_base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">U8500_PRCMU_TCPM_BASE</span><span class="p">,</span> <span class="n">SZ_4K</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tcpm_base</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">version</span><span class="p">;</span>
			<span class="n">version</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">tcpm_base</span> <span class="o">+</span> <span class="n">PRCMU_FW_VERSION_OFFSET</span><span class="p">);</span>
			<span class="n">fw_info</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">fw_info</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">api_version</span> <span class="o">=</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">fw_info</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">func_version</span> <span class="o">=</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">fw_info</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">errata</span> <span class="o">=</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">fw_info</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;PRCMU firmware: %s, version %d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fw_project_name</span><span class="p">(</span><span class="n">fw_info</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">project</span><span class="p">),</span>
				<span class="p">(</span><span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
				<span class="p">(</span><span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">tcpm_base</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">tcdm_base</span> <span class="o">=</span> <span class="n">__io_address</span><span class="p">(</span><span class="n">U8500_PRCMU_TCDM_BASE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;prcmu: Unsupported chip version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">dbb_irqs_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">ac_wake_lock</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">ac_wake_work</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb1_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">mb1_transfer</span><span class="p">.</span><span class="n">ape_opp</span> <span class="o">=</span> <span class="n">APE_NO_CHANGE</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb2_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb2_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb2_transfer</span><span class="p">.</span><span class="n">auto_pm_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb3_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb3_transfer</span><span class="p">.</span><span class="n">sysclk_lock</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb3_transfer</span><span class="p">.</span><span class="n">sysclk_work</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb4_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb5_transfer</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb5_transfer</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mb0_transfer</span><span class="p">.</span><span class="n">mask_work</span><span class="p">,</span> <span class="n">prcmu_mask_work</span><span class="p">);</span>

	<span class="cm">/* Initalize irqs. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_PRCMU_WAKEUPS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

		<span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_PRCMU_BASE</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prcmu_irq_chip</span><span class="p">,</span>
					 <span class="n">handle_simple_irq</span><span class="p">);</span>
		<span class="n">set_irq_flags</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQF_VALID</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">init_prcm_registers</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">PRCM_A9PL_FORCE_CLKEN</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PRCM_A9PL_FORCE_CLKEN_PRCM_A9PL_FORCE_CLKEN</span> <span class="o">|</span>
		<span class="n">PRCM_A9PL_FORCE_CLKEN_PRCM_A9AXI_FORCE_CLKEN</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">PRCM_A9PL_FORCE_CLKEN</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Power domain switches (ePODs) modeled as regulators for the DB8500 SoC</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">db8500_vape_consumers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;v-ape&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;v-i2c&quot;</span><span class="p">,</span> <span class="s">&quot;nmk-i2c.0&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;v-i2c&quot;</span><span class="p">,</span> <span class="s">&quot;nmk-i2c.1&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;v-i2c&quot;</span><span class="p">,</span> <span class="s">&quot;nmk-i2c.2&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;v-i2c&quot;</span><span class="p">,</span> <span class="s">&quot;nmk-i2c.3&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;v-i2c&quot;</span><span class="p">,</span> <span class="s">&quot;nmk-i2c.4&quot;</span><span class="p">),</span>
	<span class="cm">/* &quot;v-mmc&quot; changed to &quot;vcore&quot; in the mainline kernel */</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;vcore&quot;</span><span class="p">,</span> <span class="s">&quot;sdi0&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;vcore&quot;</span><span class="p">,</span> <span class="s">&quot;sdi1&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;vcore&quot;</span><span class="p">,</span> <span class="s">&quot;sdi2&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;vcore&quot;</span><span class="p">,</span> <span class="s">&quot;sdi3&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;vcore&quot;</span><span class="p">,</span> <span class="s">&quot;sdi4&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;v-dma&quot;</span><span class="p">,</span> <span class="s">&quot;dma40.0&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;v-ape&quot;</span><span class="p">,</span> <span class="s">&quot;ab8500-usb.0&quot;</span><span class="p">),</span>
	<span class="cm">/* &quot;v-uart&quot; changed to &quot;vcore&quot; in the mainline kernel */</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;vcore&quot;</span><span class="p">,</span> <span class="s">&quot;uart0&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;vcore&quot;</span><span class="p">,</span> <span class="s">&quot;uart1&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;vcore&quot;</span><span class="p">,</span> <span class="s">&quot;uart2&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;v-ape&quot;</span><span class="p">,</span> <span class="s">&quot;nmk-ske-keypad.0&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;v-hsi&quot;</span><span class="p">,</span> <span class="s">&quot;ste_hsi.0&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;vddvario&quot;</span><span class="p">,</span> <span class="s">&quot;smsc911x.0&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">db8500_vsmps2_consumers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;musb_1v8&quot;</span><span class="p">,</span> <span class="s">&quot;ab8500-usb.0&quot;</span><span class="p">),</span>
	<span class="cm">/* AV8100 regulator */</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;hdmi_1v8&quot;</span><span class="p">,</span> <span class="s">&quot;0-0070&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">db8500_b2r2_mcde_consumers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;vsupply&quot;</span><span class="p">,</span> <span class="s">&quot;b2r2_bus&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;vsupply&quot;</span><span class="p">,</span> <span class="s">&quot;mcde&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* SVA MMDSP regulator switch */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">db8500_svammdsp_consumers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;sva-mmdsp&quot;</span><span class="p">,</span> <span class="s">&quot;cm_control&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* SVA pipe regulator switch */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">db8500_svapipe_consumers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;sva-pipe&quot;</span><span class="p">,</span> <span class="s">&quot;cm_control&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* SIA MMDSP regulator switch */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">db8500_siammdsp_consumers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;sia-mmdsp&quot;</span><span class="p">,</span> <span class="s">&quot;cm_control&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* SIA pipe regulator switch */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">db8500_siapipe_consumers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;sia-pipe&quot;</span><span class="p">,</span> <span class="s">&quot;cm_control&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">db8500_sga_consumers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;v-mali&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* ESRAM1 and 2 regulator switch */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">db8500_esram12_consumers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;esram12&quot;</span><span class="p">,</span> <span class="s">&quot;cm_control&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* ESRAM3 and 4 regulator switch */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">db8500_esram34_consumers</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;v-esram34&quot;</span><span class="p">,</span> <span class="s">&quot;mcde&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;esram34&quot;</span><span class="p">,</span> <span class="s">&quot;cm_control&quot;</span><span class="p">),</span>
	<span class="n">REGULATOR_SUPPLY</span><span class="p">(</span><span class="s">&quot;lcla_esram&quot;</span><span class="p">,</span> <span class="s">&quot;dma40.0&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_init_data</span> <span class="n">db8500_regulators</span><span class="p">[</span><span class="n">DB8500_NUM_REGULATORS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_VAPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-vape&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">always_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">db8500_vape_consumers</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db8500_vape_consumers</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_VARM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-varm&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_VMODEM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-vmodem&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_VPLL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-vpll&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_VSMPS1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-vsmps1&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_VSMPS2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-vsmps2&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">db8500_vsmps2_consumers</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db8500_vsmps2_consumers</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_VSMPS3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-vsmps3&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_VRF1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-vrf1&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_SWITCH_SVAMMDSP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* dependency to u8500-vape is handled outside regulator framework */</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-sva-mmdsp&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">db8500_svammdsp_consumers</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db8500_svammdsp_consumers</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_SWITCH_SVAMMDSPRET</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="cm">/* &quot;ret&quot; means &quot;retention&quot; */</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-sva-mmdsp-ret&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_SWITCH_SVAPIPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* dependency to u8500-vape is handled outside regulator framework */</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-sva-pipe&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">db8500_svapipe_consumers</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db8500_svapipe_consumers</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_SWITCH_SIAMMDSP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* dependency to u8500-vape is handled outside regulator framework */</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-sia-mmdsp&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">db8500_siammdsp_consumers</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db8500_siammdsp_consumers</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_SWITCH_SIAMMDSPRET</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-sia-mmdsp-ret&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_SWITCH_SIAPIPE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* dependency to u8500-vape is handled outside regulator framework */</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-sia-pipe&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">db8500_siapipe_consumers</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db8500_siapipe_consumers</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_SWITCH_SGA</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">supply_regulator</span> <span class="o">=</span> <span class="s">&quot;db8500-vape&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-sga&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">db8500_sga_consumers</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db8500_sga_consumers</span><span class="p">),</span>

	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_SWITCH_B2R2_MCDE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">supply_regulator</span> <span class="o">=</span> <span class="s">&quot;db8500-vape&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-b2r2-mcde&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">db8500_b2r2_mcde_consumers</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db8500_b2r2_mcde_consumers</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_SWITCH_ESRAM12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * esram12 is set in retention and supplied by Vsafe when Vape is off,</span>
<span class="cm">		 * no need to hold Vape</span>
<span class="cm">		 */</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-esram12&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">db8500_esram12_consumers</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db8500_esram12_consumers</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_SWITCH_ESRAM12RET</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-esram12-ret&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_SWITCH_ESRAM34</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * esram34 is set in retention and supplied by Vsafe when Vape is off,</span>
<span class="cm">		 * no need to hold Vape</span>
<span class="cm">		 */</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-esram34&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">db8500_esram34_consumers</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db8500_esram34_consumers</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">DB8500_REGULATOR_SWITCH_ESRAM34RET</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-esram34-ret&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="n">db8500_prcmu_devs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-prcmu-regulators&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">db8500_regulators</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">db8500_regulators</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cpufreq-u8500&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * prcmu_fw_init - arch init call for the Linux PRCMU fw init logic</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">db8500_prcmu_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ux500_is_svp</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">init_prcm_registers</span><span class="p">();</span>

	<span class="cm">/* Clean up the mailbox interrupts after pre-kernel code. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ALL_MBOX_BITS</span><span class="p">,</span> <span class="n">PRCM_ARM_IT1_CLR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="p">)</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span> <span class="o">||</span> <span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_DB8500_PRCMU1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">prcmu_irq_handler</span><span class="p">,</span>
	        <span class="n">prcmu_irq_thread_fn</span><span class="p">,</span> <span class="n">IRQF_NO_SUSPEND</span><span class="p">,</span> <span class="s">&quot;prcmu&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;prcmu: Failed to allocate IRQ_DB8500_PRCMU1.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">no_irq_return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_u8500v20_or_later</span><span class="p">())</span>
		<span class="n">prcmu_config_esram0_deep_sleep</span><span class="p">(</span><span class="n">ESRAM0_DEEP_SLEEP_STATE_RET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mfd_add_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">db8500_prcmu_devs</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">db8500_prcmu_devs</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;prcmu: Failed to add subdevices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;DB8500 PRCMU initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">no_irq_return:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">db8500_prcmu_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;db8500-prcmu&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">db8500_prcmu_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">db8500_prcmu_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">db8500_prcmu_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">arch_initcall</span><span class="p">(</span><span class="n">db8500_prcmu_init</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mattias Nilsson &lt;mattias.i.nilsson@stericsson.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;DB8500 PRCM Unit driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
