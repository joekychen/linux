<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mfd › ab3100-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ab3100-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2007-2010 ST-Ericsson</span>
<span class="cm"> * License terms: GNU General Public License (GPL) version 2</span>
<span class="cm"> * Low-level core for exclusive access to the AB3100 IC on the I2C bus</span>
<span class="cm"> * and some basic chip-configuration.</span>
<span class="cm"> * Author: Linus Walleij &lt;linus.walleij@stericsson.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/core.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500.h&gt;</span>

<span class="cm">/* These are the only registers inside AB3100 used in this main file */</span>

<span class="cm">/* Interrupt event registers */</span>
<span class="cp">#define AB3100_EVENTA1		0x21</span>
<span class="cp">#define AB3100_EVENTA2		0x22</span>
<span class="cp">#define AB3100_EVENTA3		0x23</span>

<span class="cm">/* AB3100 DAC converter registers */</span>
<span class="cp">#define AB3100_DIS		0x00</span>
<span class="cp">#define AB3100_D0C		0x01</span>
<span class="cp">#define AB3100_D1C		0x02</span>
<span class="cp">#define AB3100_D2C		0x03</span>
<span class="cp">#define AB3100_D3C		0x04</span>

<span class="cm">/* Chip ID register */</span>
<span class="cp">#define AB3100_CID		0x20</span>

<span class="cm">/* AB3100 interrupt registers */</span>
<span class="cp">#define AB3100_IMRA1		0x24</span>
<span class="cp">#define AB3100_IMRA2		0x25</span>
<span class="cp">#define AB3100_IMRA3		0x26</span>
<span class="cp">#define AB3100_IMRB1		0x2B</span>
<span class="cp">#define AB3100_IMRB2		0x2C</span>
<span class="cp">#define AB3100_IMRB3		0x2D</span>

<span class="cm">/* System Power Monitoring and control registers */</span>
<span class="cp">#define AB3100_MCA		0x2E</span>
<span class="cp">#define AB3100_MCB		0x2F</span>

<span class="cm">/* SIM power up */</span>
<span class="cp">#define AB3100_SUP		0x50</span>

<span class="cm">/*</span>
<span class="cm"> * I2C communication</span>
<span class="cm"> *</span>
<span class="cm"> * The AB3100 is usually assigned address 0x48 (7-bit)</span>
<span class="cm"> * The chip is defined in the platform i2c_board_data section.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab3100_get_chip_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab3100_set_register_interruptible</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">regval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">regandval</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">reg</span><span class="p">,</span> <span class="n">regval</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">access_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * A two-byte write message with the first byte containing the register</span>
<span class="cm">	 * number and the second byte containing the value to be written</span>
<span class="cm">	 * effectively sets a register in the AB3100.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="p">,</span> <span class="n">regandval</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (write register): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (write register) &quot;</span>
			<span class="s">&quot;%d bytes transferred (expected 2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* All is well */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">access_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_register_interruptible</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">bank</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ab3100_set_register_interruptible</span><span class="p">(</span><span class="n">ab3100</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The test registers exist at an I2C bus address up one</span>
<span class="cm"> * from the ordinary base. They are not supposed to be used</span>
<span class="cm"> * in production code, but sometimes you have to do that</span>
<span class="cm"> * anyway. It&#39;s currently only used from this file so declare</span>
<span class="cm"> * it static and do not export.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab3100_set_test_register_interruptible</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">regval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">regandval</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">reg</span><span class="p">,</span> <span class="n">regval</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">access_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">testreg_client</span><span class="p">,</span> <span class="n">regandval</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (write test register): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (write test register) &quot;</span>
			<span class="s">&quot;%d bytes transferred (expected 2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* All is well */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">access_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab3100_get_register_interruptible</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span><span class="p">,</span>
					     <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">regval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">access_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * AB3100 require an I2C &quot;stop&quot; command between each message, else</span>
<span class="cm">	 * it will not work. The only way of achieveing this with the</span>
<span class="cm">	 * message transport layer is to send the read and write messages</span>
<span class="cm">	 * separately.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (send register address): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">get_reg_out_unlock</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (send register address) &quot;</span>
			<span class="s">&quot;%d bytes transferred (expected 1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">get_reg_out_unlock</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* All is well */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="p">,</span> <span class="n">regval</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (read register): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">get_reg_out_unlock</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (read register) &quot;</span>
			<span class="s">&quot;%d bytes transferred (expected 1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">get_reg_out_unlock</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* All is well */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">get_reg_out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">access_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_register_interruptible</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bank</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ab3100_get_register_interruptible</span><span class="p">(</span><span class="n">ab3100</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab3100_get_register_page_interruptible</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">first_reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">regvals</span><span class="p">,</span> <span class="n">u8</span> <span class="n">numregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0xa0</span> <span class="o">||</span>
	    <span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0xa1</span><span class="p">)</span>
		<span class="cm">/* These don&#39;t support paged reads */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">access_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Paged read also require an I2C &quot;stop&quot; command.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">first_reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (send first register address): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">get_reg_page_out_unlock</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (send first register address) &quot;</span>
			<span class="s">&quot;%d bytes transferred (expected 1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">get_reg_page_out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="p">,</span> <span class="n">regvals</span><span class="p">,</span> <span class="n">numregs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (read register page): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">get_reg_page_out_unlock</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">numregs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (read register page) &quot;</span>
			<span class="s">&quot;%d bytes transferred (expected %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">,</span> <span class="n">numregs</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">get_reg_page_out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* All is well */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">get_reg_page_out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">access_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_register_page_interruptible</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bank</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">first_reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">regvals</span><span class="p">,</span> <span class="n">u8</span> <span class="n">numregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ab3100_get_register_page_interruptible</span><span class="p">(</span><span class="n">ab3100</span><span class="p">,</span>
			<span class="n">first_reg</span><span class="p">,</span> <span class="n">regvals</span><span class="p">,</span> <span class="n">numregs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab3100_mask_and_set_register_interruptible</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">andmask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ormask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">regandval</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">access_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* First read out the target register */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (maskset send address): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">get_maskset_unlock</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (maskset send address) &quot;</span>
			<span class="s">&quot;%d bytes transferred (expected 1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">get_maskset_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regandval</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (maskset read register): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">get_maskset_unlock</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (maskset read register) &quot;</span>
			<span class="s">&quot;%d bytes transferred (expected 1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">get_maskset_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Modify the register */</span>
	<span class="n">regandval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">andmask</span><span class="p">;</span>
	<span class="n">regandval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">ormask</span><span class="p">;</span>

	<span class="cm">/* Write the register */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="p">,</span> <span class="n">regandval</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (write register): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">get_maskset_unlock</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;write error (write register) &quot;</span>
			<span class="s">&quot;%d bytes transferred (expected 2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">get_maskset_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* All is well */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">get_maskset_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">access_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mask_and_set_register_interruptible</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bank</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bitmask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bitvalues</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ab3100_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">ab3100</span><span class="p">,</span>
			<span class="n">reg</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">,</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">&amp;</span> <span class="n">bitvalues</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register a simple callback for handling any AB3100 events.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ab3100_event_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">blocking_notifier_chain_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">event_subscribers</span><span class="p">,</span>
					       <span class="n">nb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ab3100_event_register</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Remove a previously registered callback.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ab3100_event_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">blocking_notifier_chain_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">event_subscribers</span><span class="p">,</span>
					    <span class="n">nb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ab3100_event_unregister</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab3100_event_registers_startup_state_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					     <span class="n">u8</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">startup_events_read</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span> <span class="cm">/* Try again later */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">startup_events</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">abx500_ops</span> <span class="n">ab3100_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_chip_id</span> <span class="o">=</span> <span class="n">ab3100_get_chip_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_register</span> <span class="o">=</span> <span class="n">set_register_interruptible</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_register</span> <span class="o">=</span> <span class="n">get_register_interruptible</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_register_page</span> <span class="o">=</span> <span class="n">get_register_page_interruptible</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_register_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask_and_set_register</span> <span class="o">=</span> <span class="n">mask_and_set_register_interruptible</span><span class="p">,</span>
	<span class="p">.</span><span class="n">event_registers_startup_state_get</span> <span class="o">=</span>
		<span class="n">ab3100_event_registers_startup_state_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">startup_irq_enabled</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This is a threaded interrupt handler so we can make some</span>
<span class="cm"> * I2C calls etc.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab3100_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">event_regs</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">fatevent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">add_interrupt_randomness</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ab3100_get_register_page_interruptible</span><span class="p">(</span><span class="n">ab3100</span><span class="p">,</span> <span class="n">AB3100_EVENTA1</span><span class="p">,</span>
				       <span class="n">event_regs</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_event</span><span class="p">;</span>

	<span class="n">fatevent</span> <span class="o">=</span> <span class="p">(</span><span class="n">event_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">event_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">event_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">startup_events_read</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">startup_events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">startup_events</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">startup_events</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">startup_events_read</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * The notified parties will have to mask out the events</span>
<span class="cm">	 * they&#39;re interested in and react to them. They will be</span>
<span class="cm">	 * notified on all events, then they use the fatevent value</span>
<span class="cm">	 * to determine if they&#39;re interested.</span>
<span class="cm">	 */</span>
	<span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">event_subscribers</span><span class="p">,</span>
				     <span class="n">fatevent</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;IRQ Event: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fatevent</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

 <span class="nl">err_event:</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;error reading event status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="cm">/*</span>
<span class="cm"> * Some debugfs entries only exposed if we&#39;re using debug</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab3100_registers_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;AB3100 registers:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="n">reg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ab3100_get_register_interruptible</span><span class="p">(</span><span class="n">ab3100</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;[0x%x]:  0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab3100_registers_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ab3100_registers_print</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ab3100_registers_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">ab3100_registers_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ab3100_get_set_reg_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ab3100_get_set_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				  <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab3100_get_set_reg_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ab3100</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">regp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get userspace string and assure termination */</span>
	<span class="n">buf_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">user_buf</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">buf_size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The idea is here to parse a string which is either</span>
<span class="cm">	 * &quot;0xnn&quot; for reading a register, or &quot;0xaa 0xbb&quot; for</span>
<span class="cm">	 * writing 0xbb to the register 0xaa. First move past</span>
<span class="cm">	 * whitespace and then begin to parse the register.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf_size</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">))</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="n">regp</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Advance pointer to end of string then terminate</span>
<span class="cm">	 * the register string. This is needed to satisfy</span>
<span class="cm">	 * the strict_strtoul() function.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf_size</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">))</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">regp</span><span class="p">],</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_reg</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Either we read or we write a register here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reading */</span>
		<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">user_reg</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">regvalue</span><span class="p">;</span>

		<span class="n">ab3100_get_register_interruptible</span><span class="p">(</span><span class="n">ab3100</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regvalue</span><span class="p">);</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;debug read AB3100 reg[0x%02x]: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">reg</span><span class="p">,</span> <span class="n">regvalue</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">valp</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_value</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">user_reg</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">regvalue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Writing, we need some value to write to</span>
<span class="cm">		 * the register so keep parsing the string</span>
<span class="cm">		 * from userspace.</span>
<span class="cm">		 */</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf_size</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">))</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">valp</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf_size</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">))</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">valp</span><span class="p">],</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_reg</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">user_value</span><span class="p">;</span>
		<span class="n">ab3100_set_register_interruptible</span><span class="p">(</span><span class="n">ab3100</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">ab3100_get_register_interruptible</span><span class="p">(</span><span class="n">ab3100</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regvalue</span><span class="p">);</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;debug write reg[0x%02x] with 0x%02x, &quot;</span>
			 <span class="s">&quot;after readback: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">regvalue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">buf_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ab3100_get_set_reg_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ab3100_get_set_reg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ab3100_dir</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ab3100_reg_file</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ab3100_get_set_reg_priv</span> <span class="n">ab3100_get_priv</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ab3100_get_reg_file</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ab3100_get_set_reg_priv</span> <span class="n">ab3100_set_priv</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ab3100_set_reg_file</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab3100_setup_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ab3100_dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;ab3100&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab3100_dir</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_no_debugfs</span><span class="p">;</span>

	<span class="n">ab3100_reg_file</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;registers&quot;</span><span class="p">,</span>
				<span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">ab3100_dir</span><span class="p">,</span> <span class="n">ab3100</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ab3100_registers_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab3100_reg_file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_destroy_dir</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ab3100_get_priv</span><span class="p">.</span><span class="n">ab3100</span> <span class="o">=</span> <span class="n">ab3100</span><span class="p">;</span>
	<span class="n">ab3100_get_priv</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ab3100_get_reg_file</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;get_reg&quot;</span><span class="p">,</span>
				<span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">ab3100_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ab3100_get_priv</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ab3100_get_set_reg_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab3100_get_reg_file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_destroy_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ab3100_set_priv</span><span class="p">.</span><span class="n">ab3100</span> <span class="o">=</span> <span class="n">ab3100</span><span class="p">;</span>
	<span class="n">ab3100_set_priv</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ab3100_set_reg_file</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;set_reg&quot;</span><span class="p">,</span>
				<span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">ab3100_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ab3100_set_priv</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ab3100_get_set_reg_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab3100_set_reg_file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_destroy_get_reg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">exit_destroy_get_reg:</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">ab3100_get_reg_file</span><span class="p">);</span>
 <span class="nl">exit_destroy_reg:</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">ab3100_reg_file</span><span class="p">);</span>
 <span class="nl">exit_destroy_dir:</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">ab3100_dir</span><span class="p">);</span>
 <span class="nl">exit_no_debugfs:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ab3100_remove_debugfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">ab3100_set_reg_file</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">ab3100_get_reg_file</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">ab3100_reg_file</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">ab3100_dir</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ab3100_setup_debugfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ab3100_remove_debugfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Basic set-up, datastructure creation/destruction and I2C interface.</span>
<span class="cm"> * This sets up a default config in the AB3100 chip so that it</span>
<span class="cm"> * will work as expected.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">ab3100_init_setting</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">abreg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">setting</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ab3100_init_setting</span> <span class="n">__devinitconst</span>
<span class="n">ab3100_init_settings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">abreg</span> <span class="o">=</span> <span class="n">AB3100_MCA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setting</span> <span class="o">=</span> <span class="mh">0x01</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">abreg</span> <span class="o">=</span> <span class="n">AB3100_MCB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setting</span> <span class="o">=</span> <span class="mh">0x30</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">abreg</span> <span class="o">=</span> <span class="n">AB3100_IMRA1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setting</span> <span class="o">=</span> <span class="mh">0x00</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">abreg</span> <span class="o">=</span> <span class="n">AB3100_IMRA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setting</span> <span class="o">=</span> <span class="mh">0xFF</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">abreg</span> <span class="o">=</span> <span class="n">AB3100_IMRA3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setting</span> <span class="o">=</span> <span class="mh">0x01</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">abreg</span> <span class="o">=</span> <span class="n">AB3100_IMRB1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setting</span> <span class="o">=</span> <span class="mh">0xBF</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">abreg</span> <span class="o">=</span> <span class="n">AB3100_IMRB2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setting</span> <span class="o">=</span> <span class="mh">0xFF</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">abreg</span> <span class="o">=</span> <span class="n">AB3100_IMRB3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setting</span> <span class="o">=</span> <span class="mh">0xFF</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">abreg</span> <span class="o">=</span> <span class="n">AB3100_SUP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setting</span> <span class="o">=</span> <span class="mh">0x00</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">abreg</span> <span class="o">=</span> <span class="n">AB3100_DIS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setting</span> <span class="o">=</span> <span class="mh">0xF0</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">abreg</span> <span class="o">=</span> <span class="n">AB3100_D0C</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setting</span> <span class="o">=</span> <span class="mh">0x00</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">abreg</span> <span class="o">=</span> <span class="n">AB3100_D1C</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setting</span> <span class="o">=</span> <span class="mh">0x00</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">abreg</span> <span class="o">=</span> <span class="n">AB3100_D2C</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setting</span> <span class="o">=</span> <span class="mh">0x00</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">abreg</span> <span class="o">=</span> <span class="n">AB3100_D3C</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setting</span> <span class="o">=</span> <span class="mh">0x00</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ab3100_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab3100_init_settings</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ab3100_set_register_interruptible</span><span class="p">(</span><span class="n">ab3100</span><span class="p">,</span>
					  <span class="n">ab3100_init_settings</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">abreg</span><span class="p">,</span>
					  <span class="n">ab3100_init_settings</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">setting</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_no_setup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Special trick to make the AB3100 use the 32kHz clock (RTC)</span>
<span class="cm">	 * bit 3 in test register 0x02 is a special, undocumented test</span>
<span class="cm">	 * register bit that only exist in AB3100 P1E</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0xc4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;AB3100 P1E variant detected, &quot;</span>
			 <span class="s">&quot;forcing chip to 32KHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ab3100_set_test_register_interruptible</span><span class="p">(</span><span class="n">ab3100</span><span class="p">,</span>
			<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">exit_no_setup:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The subdevices of the AB3100 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="n">ab3100_devs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab3100-dac&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab3100-leds&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab3100-power&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab3100-regulators&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab3100-sim&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab3100-uart&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab3100-rtc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab3100-charger&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab3100-boost&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab3100-adc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab3100-fuelgauge&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab3100-vibrator&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab3100-otp&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab3100-codec&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ab_family_id</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">id</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ab_family_id</span> <span class="n">ids</span><span class="p">[]</span> <span class="n">__devinitconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* AB3100 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;P1A&quot;</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xc1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;P1B&quot;</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xc2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;P1C&quot;</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xc3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;P1D&quot;</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xc4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;P1E&quot;</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xc5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;P1F/R1A&quot;</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xc6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;P1G/R1A&quot;</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xc7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;P2A/R2A&quot;</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xc8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;P2B/R2B&quot;</span>
	<span class="p">},</span>
	<span class="cm">/* AB3000 variants, not supported */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xa0</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xa1</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xa2</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xa3</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xa4</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xa5</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xa6</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0xa7</span>
	<span class="p">},</span>
	<span class="cm">/* Terminator */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ab3100_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab3100_platform_data</span> <span class="o">*</span><span class="n">ab3100_plf_data</span> <span class="o">=</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ab3100</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab3100</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab3100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not allocate AB3100 device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize data structure */</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">access_mutex</span><span class="p">);</span>
	<span class="n">BLOCKING_INIT_NOTIFIER_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">event_subscribers</span><span class="p">);</span>

	<span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">i2c_client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">i2c_client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ab3100</span><span class="p">);</span>

	<span class="cm">/* Read chip ID register */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ab3100_get_register_interruptible</span><span class="p">(</span><span class="n">ab3100</span><span class="p">,</span> <span class="n">AB3100_CID</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;could not communicate with the AB3100 analog &quot;</span>
			<span class="s">&quot;baseband chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_no_detect</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
					 <span class="s">&quot;AB3100 %s&quot;</span><span class="p">,</span>
					 <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;AB3000 is not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">exit_no_detect</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown analog baseband chip id: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;accepting it anyway. Please update &quot;</span>
			<span class="s">&quot;the driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_no_detect</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Detected chip: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="o">&amp;</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Attach a second dummy i2c_client to the test register address */</span>
	<span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">testreg_client</span> <span class="o">=</span> <span class="n">i2c_new_dummy</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
						     <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">testreg_client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_no_testreg_client</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ab3100_setup</span><span class="p">(</span><span class="n">ab3100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_no_setup</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ab3100_irq_handler</span><span class="p">,</span>
				<span class="n">IRQF_ONESHOT</span><span class="p">,</span> <span class="s">&quot;ab3100-core&quot;</span><span class="p">,</span> <span class="n">ab3100</span><span class="p">);</span>
	<span class="cm">/* This real unpredictable IRQ is of course sampled for entropy */</span>
	<span class="n">rand_initialize_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_no_irq</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">abx500_register_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ab3100_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_no_ops</span><span class="p">;</span>

	<span class="cm">/* Set up and register the platform devices. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab3100_devs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ab3100_devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">ab3100_plf_data</span><span class="p">;</span>
		<span class="n">ab3100_devs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab3100_platform_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mfd_add_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ab3100_devs</span><span class="p">,</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab3100_devs</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ab3100_setup_debugfs</span><span class="p">(</span><span class="n">ab3100</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">exit_no_ops:</span>
 <span class="nl">exit_no_irq:</span>
 <span class="nl">exit_no_setup:</span>
	<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">testreg_client</span><span class="p">);</span>
 <span class="nl">exit_no_testreg_client:</span>
 <span class="nl">exit_no_detect:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ab3100</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">ab3100_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab3100</span> <span class="o">*</span><span class="n">ab3100</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="cm">/* Unregister subdevices */</span>
	<span class="n">mfd_remove_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ab3100_remove_debugfs</span><span class="p">();</span>
	<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">ab3100</span><span class="o">-&gt;</span><span class="n">testreg_client</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * At this point, all subscribers should have unregistered</span>
<span class="cm">	 * their notifiers so deactivate IRQ</span>
<span class="cm">	 */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ab3100</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ab3100</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">ab3100_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;ab3100&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">ab3100_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">ab3100_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ab3100&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">ab3100_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ab3100_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ab3100_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ab3100_i2c_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ab3100_i2c_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab3100_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">ab3100_i2c_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ab3100_i2c_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Linus Walleij &lt;linus.walleij@stericsson.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;AB3100 core driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
