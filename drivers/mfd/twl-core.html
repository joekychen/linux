<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mfd › twl-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>twl-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * twl_core.c - driver for TWL4030/TWL5030/TWL60X0/TPS659x0 PM</span>
<span class="cm"> * and audio CODEC devices</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 Texas Instruments, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Modifications to defer interrupt handling to a kernel thread:</span>
<span class="cm"> * Copyright (C) 2006 MontaVista Software, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on tlv320aic23.c:</span>
<span class="cm"> * Copyright (c) by Kai Svahn &lt;kai.svahn@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Code cleanup and modifications to IRQ handler.</span>
<span class="cm"> * by syed khasim &lt;x0khasim@ti.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_irq.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/irqdomain.h&gt;</span>

<span class="cp">#include &lt;linux/regulator/machine.h&gt;</span>

<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/twl.h&gt;</span>

<span class="cp">#include &quot;twl-core.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * The TWL4030 &quot;Triton 2&quot; is one of a family of a multi-function &quot;Power</span>
<span class="cm"> * Management and System Companion Device&quot; chips originally designed for</span>
<span class="cm"> * use in OMAP2 and OMAP 3 based systems.  Its control interfaces use I2C,</span>
<span class="cm"> * often at around 3 Mbit/sec, including for interrupt handling.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver core provides genirq support for the interrupts emitted,</span>
<span class="cm"> * by the various modules, and exports register access primitives.</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME this driver currently requires use of the first interrupt line</span>
<span class="cm"> * (and associated registers).</span>
<span class="cm"> */</span>

<span class="cp">#define DRIVER_NAME			&quot;twl&quot;</span>

<span class="cp">#if defined(CONFIG_KEYBOARD_TWL4030) || defined(CONFIG_KEYBOARD_TWL4030_MODULE)</span>
<span class="cp">#define twl_has_keypad()	true</span>
<span class="cp">#else</span>
<span class="cp">#define twl_has_keypad()	false</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_GPIO_TWL4030) || defined(CONFIG_GPIO_TWL4030_MODULE)</span>
<span class="cp">#define twl_has_gpio()	true</span>
<span class="cp">#else</span>
<span class="cp">#define twl_has_gpio()	false</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_REGULATOR_TWL4030) \</span>
<span class="cp">	|| defined(CONFIG_REGULATOR_TWL4030_MODULE)</span>
<span class="cp">#define twl_has_regulator()	true</span>
<span class="cp">#else</span>
<span class="cp">#define twl_has_regulator()	false</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_TWL4030_MADC) || defined(CONFIG_TWL4030_MADC_MODULE)</span>
<span class="cp">#define twl_has_madc()	true</span>
<span class="cp">#else</span>
<span class="cp">#define twl_has_madc()	false</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_TWL4030_POWER</span>
<span class="cp">#define twl_has_power()        true</span>
<span class="cp">#else</span>
<span class="cp">#define twl_has_power()        false</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_RTC_DRV_TWL4030) || defined(CONFIG_RTC_DRV_TWL4030_MODULE)</span>
<span class="cp">#define twl_has_rtc()	true</span>
<span class="cp">#else</span>
<span class="cp">#define twl_has_rtc()	false</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_TWL4030_USB) || defined(CONFIG_TWL4030_USB_MODULE) ||\</span>
<span class="cp">	defined(CONFIG_TWL6030_USB) || defined(CONFIG_TWL6030_USB_MODULE)</span>
<span class="cp">#define twl_has_usb()	true</span>
<span class="cp">#else</span>
<span class="cp">#define twl_has_usb()	false</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_TWL4030_WATCHDOG) || \</span>
<span class="cp">	defined(CONFIG_TWL4030_WATCHDOG_MODULE)</span>
<span class="cp">#define twl_has_watchdog()        true</span>
<span class="cp">#else</span>
<span class="cp">#define twl_has_watchdog()        false</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_MFD_TWL4030_AUDIO) || \</span>
<span class="cp">	defined(CONFIG_MFD_TWL4030_AUDIO_MODULE)</span>
<span class="cp">#define twl_has_codec()	true</span>
<span class="cp">#else</span>
<span class="cp">#define twl_has_codec()	false</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_CHARGER_TWL4030) || defined(CONFIG_CHARGER_TWL4030_MODULE)</span>
<span class="cp">#define twl_has_bci()	true</span>
<span class="cp">#else</span>
<span class="cp">#define twl_has_bci()	false</span>
<span class="cp">#endif</span>

<span class="cm">/* Triton Core internal information (BEGIN) */</span>

<span class="cm">/* Last - for index max*/</span>
<span class="cp">#define TWL4030_MODULE_LAST		TWL4030_MODULE_SECURED_REG</span>

<span class="cp">#define TWL_NUM_SLAVES		4</span>

<span class="cp">#if defined(CONFIG_INPUT_TWL4030_PWRBUTTON) \</span>
<span class="cp">	|| defined(CONFIG_INPUT_TWL4030_PWRBUTTON_MODULE)</span>
<span class="cp">#define twl_has_pwrbutton()	true</span>
<span class="cp">#else</span>
<span class="cp">#define twl_has_pwrbutton()	false</span>
<span class="cp">#endif</span>

<span class="cp">#define SUB_CHIP_ID0 0</span>
<span class="cp">#define SUB_CHIP_ID1 1</span>
<span class="cp">#define SUB_CHIP_ID2 2</span>
<span class="cp">#define SUB_CHIP_ID3 3</span>
<span class="cp">#define SUB_CHIP_ID_INVAL 0xff</span>

<span class="cp">#define TWL_MODULE_LAST TWL4030_MODULE_LAST</span>

<span class="cm">/* Base Address defns for twl4030_map[] */</span>

<span class="cm">/* subchip/slave 0 - USB ID */</span>
<span class="cp">#define TWL4030_BASEADD_USB		0x0000</span>

<span class="cm">/* subchip/slave 1 - AUD ID */</span>
<span class="cp">#define TWL4030_BASEADD_AUDIO_VOICE	0x0000</span>
<span class="cp">#define TWL4030_BASEADD_GPIO		0x0098</span>
<span class="cp">#define TWL4030_BASEADD_INTBR		0x0085</span>
<span class="cp">#define TWL4030_BASEADD_PIH		0x0080</span>
<span class="cp">#define TWL4030_BASEADD_TEST		0x004C</span>

<span class="cm">/* subchip/slave 2 - AUX ID */</span>
<span class="cp">#define TWL4030_BASEADD_INTERRUPTS	0x00B9</span>
<span class="cp">#define TWL4030_BASEADD_LED		0x00EE</span>
<span class="cp">#define TWL4030_BASEADD_MADC		0x0000</span>
<span class="cp">#define TWL4030_BASEADD_MAIN_CHARGE	0x0074</span>
<span class="cp">#define TWL4030_BASEADD_PRECHARGE	0x00AA</span>
<span class="cp">#define TWL4030_BASEADD_PWM0		0x00F8</span>
<span class="cp">#define TWL4030_BASEADD_PWM1		0x00FB</span>
<span class="cp">#define TWL4030_BASEADD_PWMA		0x00EF</span>
<span class="cp">#define TWL4030_BASEADD_PWMB		0x00F1</span>
<span class="cp">#define TWL4030_BASEADD_KEYPAD		0x00D2</span>

<span class="cp">#define TWL5031_BASEADD_ACCESSORY	0x0074 </span><span class="cm">/* Replaces Main Charge */</span><span class="cp"></span>
<span class="cp">#define TWL5031_BASEADD_INTERRUPTS	0x00B9 </span><span class="cm">/* Different than TWL4030&#39;s</span>
<span class="cm">						  one */</span><span class="cp"></span>

<span class="cm">/* subchip/slave 3 - POWER ID */</span>
<span class="cp">#define TWL4030_BASEADD_BACKUP		0x0014</span>
<span class="cp">#define TWL4030_BASEADD_INT		0x002E</span>
<span class="cp">#define TWL4030_BASEADD_PM_MASTER	0x0036</span>
<span class="cp">#define TWL4030_BASEADD_PM_RECEIVER	0x005B</span>
<span class="cp">#define TWL4030_BASEADD_RTC		0x001C</span>
<span class="cp">#define TWL4030_BASEADD_SECURED_REG	0x0000</span>

<span class="cm">/* Triton Core internal information (END) */</span>


<span class="cm">/* subchip/slave 0 0x48 - POWER */</span>
<span class="cp">#define TWL6030_BASEADD_RTC		0x0000</span>
<span class="cp">#define TWL6030_BASEADD_MEM		0x0017</span>
<span class="cp">#define TWL6030_BASEADD_PM_MASTER	0x001F</span>
<span class="cp">#define TWL6030_BASEADD_PM_SLAVE_MISC	0x0030 </span><span class="cm">/* PM_RECEIVER */</span><span class="cp"></span>
<span class="cp">#define TWL6030_BASEADD_PM_MISC		0x00E2</span>
<span class="cp">#define TWL6030_BASEADD_PM_PUPD		0x00F0</span>

<span class="cm">/* subchip/slave 1 0x49 - FEATURE */</span>
<span class="cp">#define TWL6030_BASEADD_USB		0x0000</span>
<span class="cp">#define TWL6030_BASEADD_GPADC_CTRL	0x002E</span>
<span class="cp">#define TWL6030_BASEADD_AUX		0x0090</span>
<span class="cp">#define TWL6030_BASEADD_PWM		0x00BA</span>
<span class="cp">#define TWL6030_BASEADD_GASGAUGE	0x00C0</span>
<span class="cp">#define TWL6030_BASEADD_PIH		0x00D0</span>
<span class="cp">#define TWL6030_BASEADD_CHARGER		0x00E0</span>
<span class="cp">#define TWL6025_BASEADD_CHARGER		0x00DA</span>

<span class="cm">/* subchip/slave 2 0x4A - DFT */</span>
<span class="cp">#define TWL6030_BASEADD_DIEID		0x00C0</span>

<span class="cm">/* subchip/slave 3 0x4B - AUDIO */</span>
<span class="cp">#define TWL6030_BASEADD_AUDIO		0x0000</span>
<span class="cp">#define TWL6030_BASEADD_RSV		0x0000</span>
<span class="cp">#define TWL6030_BASEADD_ZERO		0x0000</span>

<span class="cm">/* Few power values */</span>
<span class="cp">#define R_CFG_BOOT			0x05</span>

<span class="cm">/* some fields in R_CFG_BOOT */</span>
<span class="cp">#define HFCLK_FREQ_19p2_MHZ		(1 &lt;&lt; 0)</span>
<span class="cp">#define HFCLK_FREQ_26_MHZ		(2 &lt;&lt; 0)</span>
<span class="cp">#define HFCLK_FREQ_38p4_MHZ		(3 &lt;&lt; 0)</span>
<span class="cp">#define HIGH_PERF_SQ			(1 &lt;&lt; 3)</span>
<span class="cp">#define CK32K_LOWPWR_EN			(1 &lt;&lt; 7)</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* is driver active, bound to a chip? */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">inuse</span><span class="p">;</span>

<span class="cm">/* TWL IDCODE Register value */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">twl_idcode</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">twl_id</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">twl_rev</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">twl_id</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">twl_rev</span><span class="p">);</span>

<span class="cm">/* Structure for each TWL4030/TWL6030 Slave */</span>
<span class="k">struct</span> <span class="n">twl_client</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">address</span><span class="p">;</span>

	<span class="cm">/* max numb of i2c_msg required is for read =2 */</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">xfer_msg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* To lock access to xfer_msg */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">xfer_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">twl_client</span> <span class="n">twl_modules</span><span class="p">[</span><span class="n">TWL_NUM_SLAVES</span><span class="p">];</span>

<span class="cm">/* mapping the module id to slave id and base address */</span>
<span class="k">struct</span> <span class="n">twl_mapping</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sid</span><span class="p">;</span>	<span class="cm">/* Slave ID */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">base</span><span class="p">;</span>	<span class="cm">/* base address */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">twl_mapping</span> <span class="o">*</span><span class="n">twl_map</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">twl_mapping</span> <span class="n">twl4030_map</span><span class="p">[</span><span class="n">TWL4030_MODULE_LAST</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * NOTE:  don&#39;t change this table without updating the</span>
<span class="cm">	 * &lt;linux/i2c/twl.h&gt; defines for TWL4030_MODULE_*</span>
<span class="cm">	 * so they continue to match the order in this table.</span>
<span class="cm">	 */</span>

	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_USB</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_AUDIO_VOICE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_GPIO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_INTBR</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_PIH</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_TEST</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_KEYPAD</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_MADC</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_INTERRUPTS</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_LED</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_MAIN_CHARGE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_PRECHARGE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_PWM0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_PWM1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_PWMA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_PWMB</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TWL5031_BASEADD_ACCESSORY</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TWL5031_BASEADD_INTERRUPTS</span> <span class="p">},</span>

	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_BACKUP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_INT</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_PM_MASTER</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_PM_RECEIVER</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_RTC</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="n">TWL4030_BASEADD_SECURED_REG</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">twl_mapping</span> <span class="n">twl6030_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * NOTE:  don&#39;t change this table without updating the</span>
<span class="cm">	 * &lt;linux/i2c/twl.h&gt; defines for TWL4030_MODULE_*</span>
<span class="cm">	 * so they continue to match the order in this table.</span>
<span class="cm">	 */</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID1</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_USB</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID_INVAL</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_AUDIO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID2</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_DIEID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID2</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_RSV</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID1</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_PIH</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">SUB_CHIP_ID2</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_RSV</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID2</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_RSV</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID1</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_GPADC_CTRL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID2</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_RSV</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID2</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_RSV</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">SUB_CHIP_ID1</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_CHARGER</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID1</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_GASGAUGE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID1</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_PWM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID0</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_ZERO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID1</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_ZERO</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">SUB_CHIP_ID2</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_ZERO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID2</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_ZERO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID2</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_RSV</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID2</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_RSV</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID2</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_RSV</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID0</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_PM_MASTER</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID0</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_PM_SLAVE_MISC</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">SUB_CHIP_ID0</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_RTC</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID0</span><span class="p">,</span> <span class="n">TWL6030_BASEADD_MEM</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SUB_CHIP_ID1</span><span class="p">,</span> <span class="n">TWL6025_BASEADD_CHARGER</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* Exported Functions */</span>

<span class="cm">/**</span>
<span class="cm"> * twl_i2c_write - Writes a n bit register in TWL4030/TWL5030/TWL60X0</span>
<span class="cm"> * @mod_no: module number</span>
<span class="cm"> * @value: an array of num_bytes+1 containing data to write</span>
<span class="cm"> * @reg: register address (just offset will do)</span>
<span class="cm"> * @num_bytes: number of bytes to transfer</span>
<span class="cm"> *</span>
<span class="cm"> * IMPORTANT: for &#39;value&#39; parameter: Allocate value num_bytes+1 and</span>
<span class="cm"> * valid data starts at Offset 1.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the result of operation - 0 is success</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">twl_i2c_write</span><span class="p">(</span><span class="n">u8</span> <span class="n">mod_no</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">num_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">twl_client</span> <span class="o">*</span><span class="n">twl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">mod_no</span> <span class="o">&gt;</span> <span class="n">TWL_MODULE_LAST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: invalid module number %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">mod_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">inuse</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: not initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sid</span> <span class="o">=</span> <span class="n">twl_map</span><span class="p">[</span><span class="n">mod_no</span><span class="p">].</span><span class="n">sid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sid</span> <span class="o">==</span> <span class="n">SUB_CHIP_ID_INVAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: module %d is not part of the pmic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">mod_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">twl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">twl_modules</span><span class="p">[</span><span class="n">sid</span><span class="p">];</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">twl</span><span class="o">-&gt;</span><span class="n">xfer_lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * [MSG1]: fill the register address data</span>
<span class="cm">	 * fill the data Tx buffer</span>
<span class="cm">	 */</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">twl</span><span class="o">-&gt;</span><span class="n">xfer_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">twl</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">num_bytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="cm">/* over write the first byte of buffer with the register address */</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">twl_map</span><span class="p">[</span><span class="n">mod_no</span><span class="p">].</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">twl</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">twl</span><span class="o">-&gt;</span><span class="n">xfer_msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">twl</span><span class="o">-&gt;</span><span class="n">xfer_lock</span><span class="p">);</span>

	<span class="cm">/* i2c_transfer returns number of messages transferred */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: i2c_write failed to transfer all messages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">DRIVER_NAME</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">twl_i2c_write</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * twl_i2c_read - Reads a n bit register in TWL4030/TWL5030/TWL60X0</span>
<span class="cm"> * @mod_no: module number</span>
<span class="cm"> * @value: an array of num_bytes containing data to be read</span>
<span class="cm"> * @reg: register address (just offset will do)</span>
<span class="cm"> * @num_bytes: number of bytes to transfer</span>
<span class="cm"> *</span>
<span class="cm"> * Returns result of operation - num_bytes is success else failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">twl_i2c_read</span><span class="p">(</span><span class="n">u8</span> <span class="n">mod_no</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">num_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">twl_client</span> <span class="o">*</span><span class="n">twl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">mod_no</span> <span class="o">&gt;</span> <span class="n">TWL_MODULE_LAST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: invalid module number %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">mod_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">inuse</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: not initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sid</span> <span class="o">=</span> <span class="n">twl_map</span><span class="p">[</span><span class="n">mod_no</span><span class="p">].</span><span class="n">sid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sid</span> <span class="o">==</span> <span class="n">SUB_CHIP_ID_INVAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: module %d is not part of the pmic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">mod_no</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">twl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">twl_modules</span><span class="p">[</span><span class="n">sid</span><span class="p">];</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">twl</span><span class="o">-&gt;</span><span class="n">xfer_lock</span><span class="p">);</span>
	<span class="cm">/* [MSG1] fill the register address data */</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">twl</span><span class="o">-&gt;</span><span class="n">xfer_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">twl</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Read the register value */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">twl_map</span><span class="p">[</span><span class="n">mod_no</span><span class="p">].</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">;</span>
	<span class="cm">/* [MSG2] fill the data rx buffer */</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">twl</span><span class="o">-&gt;</span><span class="n">xfer_msg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">twl</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>	<span class="cm">/* Read the register value */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">num_bytes</span><span class="p">;</span>	<span class="cm">/* only n bytes */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">twl</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">twl</span><span class="o">-&gt;</span><span class="n">xfer_msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">twl</span><span class="o">-&gt;</span><span class="n">xfer_lock</span><span class="p">);</span>

	<span class="cm">/* i2c_transfer returns number of messages transferred */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: i2c_read failed to transfer all messages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">DRIVER_NAME</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">twl_i2c_read</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * twl_i2c_write_u8 - Writes a 8 bit register in TWL4030/TWL5030/TWL60X0</span>
<span class="cm"> * @mod_no: module number</span>
<span class="cm"> * @value: the value to be written 8 bit</span>
<span class="cm"> * @reg: register address (just offset will do)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns result of operation - 0 is success</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">twl_i2c_write_u8</span><span class="p">(</span><span class="n">u8</span> <span class="n">mod_no</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* 2 bytes offset 1 contains the data offset 0 is used by i2c_write */</span>
	<span class="n">u8</span> <span class="n">temp_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="cm">/* offset 1 contains the data */</span>
	<span class="n">temp_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">twl_i2c_write</span><span class="p">(</span><span class="n">mod_no</span><span class="p">,</span> <span class="n">temp_buffer</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">twl_i2c_write_u8</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * twl_i2c_read_u8 - Reads a 8 bit register from TWL4030/TWL5030/TWL60X0</span>
<span class="cm"> * @mod_no: module number</span>
<span class="cm"> * @value: the value read 8 bit</span>
<span class="cm"> * @reg: register address (just offset will do)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns result of operation - 0 is success</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">twl_i2c_read_u8</span><span class="p">(</span><span class="n">u8</span> <span class="n">mod_no</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">twl_i2c_read</span><span class="p">(</span><span class="n">mod_no</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">twl_i2c_read_u8</span><span class="p">);</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/**</span>
<span class="cm"> * twl_read_idcode_register - API to read the IDCODE register.</span>
<span class="cm"> *</span>
<span class="cm"> * Unlocks the IDCODE register and read the 32 bit value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl_read_idcode_register</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">twl_i2c_write_u8</span><span class="p">(</span><span class="n">TWL4030_MODULE_INTBR</span><span class="p">,</span> <span class="n">TWL_EEPROM_R_UNLOCK</span><span class="p">,</span>
						<span class="n">REG_UNLOCK_TEST_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;TWL4030 Unable to unlock IDCODE registers -%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">twl_i2c_read</span><span class="p">(</span><span class="n">TWL4030_MODULE_INTBR</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">twl_idcode</span><span class="p">),</span>
						<span class="n">REG_IDCODE_7_0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;TWL4030: unable to read IDCODE -%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">twl_i2c_write_u8</span><span class="p">(</span><span class="n">TWL4030_MODULE_INTBR</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">REG_UNLOCK_TEST_REG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;TWL4030 Unable to relock IDCODE registers -%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * twl_get_type - API to get TWL Si type.</span>
<span class="cm"> *</span>
<span class="cm"> * Api to get the TWL Si type from IDCODE value.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">twl_get_type</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">TWL_SIL_TYPE</span><span class="p">(</span><span class="n">twl_idcode</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">twl_get_type</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * twl_get_version - API to get TWL Si version.</span>
<span class="cm"> *</span>
<span class="cm"> * Api to get the TWL Si version from IDCODE value.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">twl_get_version</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">TWL_SIL_REV</span><span class="p">(</span><span class="n">twl_idcode</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">twl_get_version</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span>
<span class="nf">add_numbered_child</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">chip</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">pdata_len</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">can_wakeup</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span>	<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">twl_client</span>	<span class="o">*</span><span class="n">twl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">twl_modules</span><span class="p">[</span><span class="n">chip</span><span class="p">];</span>
	<span class="kt">int</span>			<span class="n">status</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">twl</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t alloc dev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device_init_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">can_wakeup</span><span class="p">);</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">twl</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="n">pdata_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t add platform_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">irq0</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="p">},</span>
			<span class="p">{</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">irq1</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">};</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">irq1</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t add irqs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">twl</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t add %s dev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="nf">add_child</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">chip</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">pdata_len</span><span class="p">,</span>
		<span class="n">bool</span> <span class="n">can_wakeup</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">add_numbered_child</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="n">pdata_len</span><span class="p">,</span>
		<span class="n">can_wakeup</span><span class="p">,</span> <span class="n">irq0</span><span class="p">,</span> <span class="n">irq1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span>
<span class="nf">add_regulator_linked</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">regulator_init_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="o">*</span><span class="n">consumers</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="n">num_consumers</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">sub_chip_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">twl_regulator_driver_data</span> <span class="n">drv_data</span><span class="p">;</span>

	<span class="cm">/* regulator framework demands init_data ... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">consumers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">consumer_supplies</span> <span class="o">=</span> <span class="n">consumers</span><span class="p">;</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_consumer_supplies</span> <span class="o">=</span> <span class="n">num_consumers</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If we have existing drv_data, just add the flags */</span>
		<span class="k">struct</span> <span class="n">twl_regulator_driver_data</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
		<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">features</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* add new driver data struct, used only during init */</span>
		<span class="n">drv_data</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">;</span>
		<span class="n">drv_data</span><span class="p">.</span><span class="n">set_voltage</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">drv_data</span><span class="p">.</span><span class="n">get_voltage</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">drv_data</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">drv_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* NOTE:  we currently ignore regulator IRQs, e.g. for short circuits */</span>
	<span class="n">sub_chip_id</span> <span class="o">=</span> <span class="n">twl_map</span><span class="p">[</span><span class="n">TWL_MODULE_PM_MASTER</span><span class="p">].</span><span class="n">sid</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">add_numbered_child</span><span class="p">(</span><span class="n">sub_chip_id</span><span class="p">,</span> <span class="s">&quot;twl_reg&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span>
		<span class="n">pdata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="p">),</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span>
<span class="nf">add_regulator</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">regulator_init_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">add_regulator_linked</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NOTE:  We know the first 8 IRQs after pdata-&gt;base_irq are</span>
<span class="cm"> * for the PIH, and the next are for the PWR_INT SIH, since</span>
<span class="cm"> * that&#39;s how twl_init_irq() sets things up.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">add_children</span><span class="p">(</span><span class="k">struct</span> <span class="n">twl4030_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">irq_base</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span>	<span class="o">*</span><span class="n">child</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">sub_chip_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_gpio</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">add_child</span><span class="p">(</span><span class="n">SUB_CHIP_ID1</span><span class="p">,</span> <span class="s">&quot;twl4030_gpio&quot;</span><span class="p">,</span>
				<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">),</span>
				<span class="nb">false</span><span class="p">,</span> <span class="n">irq_base</span> <span class="o">+</span> <span class="n">GPIO_INTR_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_keypad</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">keypad</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">add_child</span><span class="p">(</span><span class="n">SUB_CHIP_ID2</span><span class="p">,</span> <span class="s">&quot;twl4030_keypad&quot;</span><span class="p">,</span>
				<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">keypad</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">keypad</span><span class="p">),</span>
				<span class="nb">true</span><span class="p">,</span> <span class="n">irq_base</span> <span class="o">+</span> <span class="n">KEYPAD_INTR_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_madc</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">madc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">add_child</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;twl4030_madc&quot;</span><span class="p">,</span>
				<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">madc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">madc</span><span class="p">),</span>
				<span class="nb">true</span><span class="p">,</span> <span class="n">irq_base</span> <span class="o">+</span> <span class="n">MADC_INTR_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_rtc</span><span class="p">())</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * REVISIT platform_data here currently might expose the</span>
<span class="cm">		 * &quot;msecure&quot; line ... but for now we just expect board</span>
<span class="cm">		 * setup to tell the chip &quot;it&#39;s always ok to SET_TIME&quot;.</span>
<span class="cm">		 * Eventually, Linux might become more aware of such</span>
<span class="cm">		 * HW security concerns, and &quot;least privilege&quot;.</span>
<span class="cm">		 */</span>
		<span class="n">sub_chip_id</span> <span class="o">=</span> <span class="n">twl_map</span><span class="p">[</span><span class="n">TWL_MODULE_RTC</span><span class="p">].</span><span class="n">sid</span><span class="p">;</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">add_child</span><span class="p">(</span><span class="n">sub_chip_id</span><span class="p">,</span> <span class="s">&quot;twl_rtc&quot;</span><span class="p">,</span>
				<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="nb">true</span><span class="p">,</span> <span class="n">irq_base</span> <span class="o">+</span> <span class="n">RTC_INTR_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_usb</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">usb</span> <span class="o">&amp;&amp;</span> <span class="n">twl_class_is_4030</span><span class="p">())</span> <span class="p">{</span>

		<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">usb1v5</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">supply</span> <span class="o">=</span>	<span class="s">&quot;usb1v5&quot;</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">usb1v8</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">supply</span> <span class="o">=</span>	<span class="s">&quot;usb1v8&quot;</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">usb3v1</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">supply</span> <span class="o">=</span>	<span class="s">&quot;usb3v1&quot;</span><span class="p">,</span>
		<span class="p">};</span>

	<span class="cm">/* First add the regulators so that they can be used by transceiver */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_regulator</span><span class="p">())</span> <span class="p">{</span>
			<span class="cm">/* this is a template that gets copied */</span>
			<span class="k">struct</span> <span class="n">regulator_init_data</span> <span class="n">usb_fixed</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">constraints</span><span class="p">.</span><span class="n">valid_modes_mask</span> <span class="o">=</span>
					<span class="n">REGULATOR_MODE_NORMAL</span>
					<span class="o">|</span> <span class="n">REGULATOR_MODE_STANDBY</span><span class="p">,</span>
				<span class="p">.</span><span class="n">constraints</span><span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span>
					<span class="n">REGULATOR_CHANGE_MODE</span>
					<span class="o">|</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
			<span class="p">};</span>

			<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator_linked</span><span class="p">(</span><span class="n">TWL4030_REG_VUSB1V5</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">usb_fixed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usb1v5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						      <span class="n">features</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

			<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator_linked</span><span class="p">(</span><span class="n">TWL4030_REG_VUSB1V8</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">usb_fixed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usb1v8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						      <span class="n">features</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

			<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator_linked</span><span class="p">(</span><span class="n">TWL4030_REG_VUSB3V1</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">usb_fixed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usb3v1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						      <span class="n">features</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_child</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;twl4030_usb&quot;</span><span class="p">,</span>
				<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">),</span>
				<span class="nb">true</span><span class="p">,</span>
				<span class="cm">/* irq0 = USB_PRES, irq1 = USB */</span>
				<span class="n">irq_base</span> <span class="o">+</span> <span class="n">USB_PRES_INTR_OFFSET</span><span class="p">,</span>
				<span class="n">irq_base</span> <span class="o">+</span> <span class="n">USB_INTR_OFFSET</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="cm">/* we need to connect regulators to this transceiver */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_regulator</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">child</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usb1v5</span><span class="p">.</span><span class="n">dev_name</span> <span class="o">=</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
			<span class="n">usb1v8</span><span class="p">.</span><span class="n">dev_name</span> <span class="o">=</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
			<span class="n">usb3v1</span><span class="p">.</span><span class="n">dev_name</span> <span class="o">=</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_usb</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">usb</span> <span class="o">&amp;&amp;</span> <span class="n">twl_class_is_6030</span><span class="p">())</span> <span class="p">{</span>

		<span class="k">static</span> <span class="k">struct</span> <span class="n">regulator_consumer_supply</span> <span class="n">usb3v3</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">regulator</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_regulator</span><span class="p">())</span> <span class="p">{</span>
			<span class="cm">/* this is a template that gets copied */</span>
			<span class="k">struct</span> <span class="n">regulator_init_data</span> <span class="n">usb_fixed</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">constraints</span><span class="p">.</span><span class="n">valid_modes_mask</span> <span class="o">=</span>
					<span class="n">REGULATOR_MODE_NORMAL</span>
					<span class="o">|</span> <span class="n">REGULATOR_MODE_STANDBY</span><span class="p">,</span>
				<span class="p">.</span><span class="n">constraints</span><span class="p">.</span><span class="n">valid_ops_mask</span> <span class="o">=</span>
					<span class="n">REGULATOR_CHANGE_MODE</span>
					<span class="o">|</span> <span class="n">REGULATOR_CHANGE_STATUS</span><span class="p">,</span>
			<span class="p">};</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">TWL6025_SUBCLASS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">usb3v3</span><span class="p">.</span><span class="n">supply</span> <span class="o">=</span>	<span class="s">&quot;ldousb&quot;</span><span class="p">;</span>
				<span class="n">regulator</span> <span class="o">=</span> <span class="n">TWL6025_REG_LDOUSB</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">usb3v3</span><span class="p">.</span><span class="n">supply</span> <span class="o">=</span> <span class="s">&quot;vusb&quot;</span><span class="p">;</span>
				<span class="n">regulator</span> <span class="o">=</span> <span class="n">TWL6030_REG_VUSB</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator_linked</span><span class="p">(</span><span class="n">regulator</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usb_fixed</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">usb3v3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
							<span class="n">features</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">;</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_child</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;twl6030_usb&quot;</span><span class="p">,</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">),</span>
			<span class="nb">true</span><span class="p">,</span>
			<span class="cm">/* irq1 = VBUS_PRES, irq0 = USB ID */</span>
			<span class="n">irq_base</span> <span class="o">+</span> <span class="n">USBOTG_INTR_OFFSET</span><span class="p">,</span>
			<span class="n">irq_base</span> <span class="o">+</span> <span class="n">USB_PRES_INTR_OFFSET</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
		<span class="cm">/* we need to connect regulators to this transceiver */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_regulator</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">child</span><span class="p">)</span>
			<span class="n">usb3v3</span><span class="p">.</span><span class="n">dev_name</span> <span class="o">=</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">twl_has_regulator</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">twl_class_is_6030</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">TWL6025_SUBCLASS</span><span class="p">)</span>
			<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6025_REG_LDOUSB</span><span class="p">,</span>
						<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ldousb</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6030_REG_VUSB</span><span class="p">,</span>
						<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vusb</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
					<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_watchdog</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">twl_class_is_4030</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">add_child</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;twl4030_wdt&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_pwrbutton</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">twl_class_is_4030</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">add_child</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;twl4030_pwrbutton&quot;</span><span class="p">,</span>
				<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">irq_base</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_codec</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">audio</span> <span class="o">&amp;&amp;</span> <span class="n">twl_class_is_4030</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">sub_chip_id</span> <span class="o">=</span> <span class="n">twl_map</span><span class="p">[</span><span class="n">TWL_MODULE_AUDIO_VOICE</span><span class="p">].</span><span class="n">sid</span><span class="p">;</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">add_child</span><span class="p">(</span><span class="n">sub_chip_id</span><span class="p">,</span> <span class="s">&quot;twl4030-audio&quot;</span><span class="p">,</span>
				<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">audio</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">audio</span><span class="p">),</span>
				<span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* twl4030 regulators */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_regulator</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">twl_class_is_4030</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL4030_REG_VPLL1</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vpll1</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL4030_REG_VIO</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vio</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL4030_REG_VDD1</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vdd1</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL4030_REG_VDD2</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vdd2</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL4030_REG_VMMC1</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vmmc1</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL4030_REG_VDAC</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vdac</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">((</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">TWL4030_VAUX2</span><span class="p">)</span>
					<span class="o">?</span> <span class="n">TWL4030_REG_VAUX2_4030</span>
					<span class="o">:</span> <span class="n">TWL4030_REG_VAUX2</span><span class="p">,</span>
				<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vaux2</span><span class="p">,</span> <span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL4030_REG_VINTANA1</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vintana1</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL4030_REG_VINTANA2</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vintana2</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL4030_REG_VINTDIG</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vintdig</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* maybe add LDOs that are omitted on cost-reduced parts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_regulator</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">TPS_SUBSET</span><span class="p">)</span>
	  <span class="o">&amp;&amp;</span> <span class="n">twl_class_is_4030</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL4030_REG_VPLL2</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vpll2</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL4030_REG_VMMC2</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vmmc2</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL4030_REG_VSIM</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vsim</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL4030_REG_VAUX1</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vaux1</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL4030_REG_VAUX3</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vaux3</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL4030_REG_VAUX4</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vaux4</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* twl6030 regulators */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_regulator</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">twl_class_is_6030</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">TWL6025_SUBCLASS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6030_REG_VDD1</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vdd1</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6030_REG_VDD2</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vdd2</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6030_REG_VDD3</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vdd3</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6030_REG_V1V8</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">v1v8</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6030_REG_V2V1</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">v2v1</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6030_REG_VMMC</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vmmc</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6030_REG_VPP</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vpp</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6030_REG_VUSIM</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vusim</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6030_REG_VCXIO</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vcxio</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6030_REG_VDAC</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vdac</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6030_REG_VAUX1_6030</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vaux1</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6030_REG_VAUX2_6030</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vaux2</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6030_REG_VAUX3_6030</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vaux3</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6030_REG_CLK32KG</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clk32kg</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* 6030 and 6025 share this regulator */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_regulator</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">twl_class_is_6030</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6030_REG_VANA</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vana</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* twl6025 regulators */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_regulator</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">twl_class_is_6030</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">TWL6025_SUBCLASS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6025_REG_LDO5</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ldo5</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6025_REG_LDO1</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ldo1</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6025_REG_LDO7</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ldo7</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6025_REG_LDO6</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ldo6</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6025_REG_LDOLN</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ldoln</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6025_REG_LDO2</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ldo2</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6025_REG_LDO4</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ldo4</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6025_REG_LDO3</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ldo3</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6025_REG_SMPS3</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">smps3</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6025_REG_SMPS4</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">smps4</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

		<span class="n">child</span> <span class="o">=</span> <span class="n">add_regulator</span><span class="p">(</span><span class="n">TWL6025_REG_VIO</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vio6025</span><span class="p">,</span>
					<span class="n">features</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_bci</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">bci</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TPS_SUBSET</span> <span class="o">|</span> <span class="n">TWL5031</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">add_child</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;twl4030_bci&quot;</span><span class="p">,</span>
				<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">bci</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">bci</span><span class="p">),</span> <span class="nb">false</span><span class="p">,</span>
				<span class="cm">/* irq0 = CHG_PRES, irq1 = BCI */</span>
				<span class="n">irq_base</span> <span class="o">+</span> <span class="n">BCI_PRES_INTR_OFFSET</span><span class="p">,</span>
				<span class="n">irq_base</span> <span class="o">+</span> <span class="n">BCI_INTR_OFFSET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * These three functions initialize the on-chip clock framework,</span>
<span class="cm"> * letting it generate the right frequencies for USB, MADC, and</span>
<span class="cm"> * other purposes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">protect_pm_master</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">twl_i2c_write_u8</span><span class="p">(</span><span class="n">TWL4030_MODULE_PM_MASTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">TWL4030_PM_MASTER_PROTECT_KEY</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">unprotect_pm_master</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">|=</span> <span class="n">twl_i2c_write_u8</span><span class="p">(</span><span class="n">TWL4030_MODULE_PM_MASTER</span><span class="p">,</span>
			<span class="n">TWL4030_PM_MASTER_KEY_CFG1</span><span class="p">,</span>
			<span class="n">TWL4030_PM_MASTER_PROTECT_KEY</span><span class="p">);</span>
	<span class="n">e</span> <span class="o">|=</span> <span class="n">twl_i2c_write_u8</span><span class="p">(</span><span class="n">TWL4030_MODULE_PM_MASTER</span><span class="p">,</span>
			<span class="n">TWL4030_PM_MASTER_KEY_CFG2</span><span class="p">,</span>
			<span class="n">TWL4030_PM_MASTER_PROTECT_KEY</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clocks_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">twl4030_clock_init_data</span> <span class="o">*</span><span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">osc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">HFCLK_FREQ_26_MHZ</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_ARCH_OMAP2) || defined(CONFIG_ARCH_OMAP3)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap2430</span><span class="p">())</span>
		<span class="n">osc</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;osc_ck&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">osc</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;osc_sys_ck&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">osc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Skipping twl internal clock init and &quot;</span>
				<span class="s">&quot;using bootloader value (unknown osc rate)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">osc</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">osc</span><span class="p">);</span>

<span class="cp">#else</span>
	<span class="cm">/* REVISIT for non-OMAP systems, pass the clock rate from</span>
<span class="cm">	 * board init code, using platform_data.</span>
<span class="cm">	 */</span>
	<span class="n">osc</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Skipping twl internal clock init and &quot;</span>
	       <span class="s">&quot;using bootloader value (unknown osc rate)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">19200000</span>:
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">HFCLK_FREQ_19p2_MHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">26000000</span>:
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">HFCLK_FREQ_26_MHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">38400000</span>:
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">HFCLK_FREQ_38p4_MHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">HIGH_PERF_SQ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">&amp;&amp;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">ck32k_lowpwr_enable</span><span class="p">)</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">CK32K_LOWPWR_EN</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">|=</span> <span class="n">unprotect_pm_master</span><span class="p">();</span>
	<span class="cm">/* effect-&gt;MADC+USB ck en */</span>
	<span class="n">e</span> <span class="o">|=</span> <span class="n">twl_i2c_write_u8</span><span class="p">(</span><span class="n">TWL_MODULE_PM_MASTER</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">R_CFG_BOOT</span><span class="p">);</span>
	<span class="n">e</span> <span class="o">|=</span> <span class="n">protect_pm_master</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: clock init err [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_slaves</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">twl_class_is_4030</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">twl4030_exit_irq</span><span class="p">();</span>
		<span class="n">num_slaves</span> <span class="o">=</span> <span class="n">TWL_NUM_SLAVES</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">twl6030_exit_irq</span><span class="p">();</span>
		<span class="n">num_slaves</span> <span class="o">=</span> <span class="n">TWL_NUM_SLAVES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_slaves</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">twl_client</span>	<span class="o">*</span><span class="n">twl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">twl_modules</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">twl</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">&amp;&amp;</span> <span class="n">twl</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">!=</span> <span class="n">client</span><span class="p">)</span>
			<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">twl</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
		<span class="n">twl_modules</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">inuse</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* NOTE: This driver only handles a single twl4030/tps659x0 chip */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">twl_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">twl4030_platform_data</span>	<span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span>		<span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">irq_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span>			<span class="n">i</span><span class="p">,</span> <span class="n">num_slaves</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * XXX: Temporary pdata until the information is correctly</span>
<span class="cm">		 * retrieved by every TWL modules from DT.</span>
<span class="cm">		 */</span>
		<span class="n">pdata</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">twl4030_platform_data</span><span class="p">),</span>
				     <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no platform data?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_I2C</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t talk I2C?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inuse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;driver is already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TWL6030_CLASS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">twl_id</span> <span class="o">=</span> <span class="n">TWL6030_CLASS_ID</span><span class="p">;</span>
		<span class="n">twl_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">twl6030_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">num_slaves</span> <span class="o">=</span> <span class="n">TWL_NUM_SLAVES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">twl_id</span> <span class="o">=</span> <span class="n">TWL4030_CLASS_ID</span><span class="p">;</span>
		<span class="n">twl_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">twl4030_map</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">num_slaves</span> <span class="o">=</span> <span class="n">TWL_NUM_SLAVES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_slaves</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">twl_client</span> <span class="o">*</span><span class="n">twl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">twl_modules</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">twl</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">twl</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">twl</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">i2c_new_dummy</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
					<span class="n">twl</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">twl</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;can&#39;t attach client %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">twl</span><span class="o">-&gt;</span><span class="n">xfer_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">inuse</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* setup clock framework */</span>
	<span class="n">clocks_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>

	<span class="cm">/* read TWL IDCODE Register */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twl_id</span> <span class="o">==</span> <span class="n">TWL4030_CLASS_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">twl_read_idcode_register</span><span class="p">();</span>
		<span class="n">WARN</span><span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Error: reading twl_idcode register value</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* load power event scripts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twl_has_power</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">)</span>
		<span class="n">twl4030_power_init</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">);</span>

	<span class="cm">/* Maybe init the T2 Interrupt subsystem */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">twl_class_is_4030</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">twl4030_init_chip_irq</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">irq_base</span> <span class="o">=</span> <span class="n">twl4030_init_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">irq_base</span> <span class="o">=</span> <span class="n">twl6030_init_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">irq_base</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">irq_base</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable TWL4030/TWL5030 I2C Pull-up on I2C1 and I2C4(SR) interface.</span>
<span class="cm">	 * Program I2C_SCL_CTRL_PU(bit 0)=0, I2C_SDA_CTRL_PU (bit 2)=0,</span>
<span class="cm">	 * SR_I2C_SCL_CTRL_PU(bit 4)=0 and SR_I2C_SDA_CTRL_PU(bit 6)=0.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twl_class_is_4030</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">temp</span><span class="p">;</span>

		<span class="n">twl_i2c_read_u8</span><span class="p">(</span><span class="n">TWL4030_MODULE_INTBR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="n">REG_GPPUPDCTR1</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SR_I2C_SDA_CTRL_PU</span> <span class="o">|</span> <span class="n">SR_I2C_SCL_CTRL_PU</span> <span class="o">|</span> \
			<span class="n">I2C_SDA_CTRL_PU</span> <span class="o">|</span> <span class="n">I2C_SCL_CTRL_PU</span><span class="p">);</span>
		<span class="n">twl_i2c_write_u8</span><span class="p">(</span><span class="n">TWL4030_MODULE_INTBR</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">REG_GPPUPDCTR1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">of_platform_populate</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">add_children</span><span class="p">(</span><span class="n">pdata</span><span class="p">,</span> <span class="n">irq_base</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">);</span>

<span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">twl_remove</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">twl_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;twl4030&quot;</span><span class="p">,</span> <span class="n">TWL4030_VAUX2</span> <span class="p">},</span>	<span class="cm">/* &quot;Triton 2&quot; */</span>
	<span class="p">{</span> <span class="s">&quot;twl5030&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>		<span class="cm">/* T2 updated */</span>
	<span class="p">{</span> <span class="s">&quot;twl5031&quot;</span><span class="p">,</span> <span class="n">TWL5031</span> <span class="p">},</span>		<span class="cm">/* TWL5030 updated */</span>
	<span class="p">{</span> <span class="s">&quot;tps65950&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>		<span class="cm">/* catalog version of twl5030 */</span>
	<span class="p">{</span> <span class="s">&quot;tps65930&quot;</span><span class="p">,</span> <span class="n">TPS_SUBSET</span> <span class="p">},</span>	<span class="cm">/* fewer LDOs and DACs; no charger */</span>
	<span class="p">{</span> <span class="s">&quot;tps65920&quot;</span><span class="p">,</span> <span class="n">TPS_SUBSET</span> <span class="p">},</span>	<span class="cm">/* fewer LDOs; no codec or charger */</span>
	<span class="p">{</span> <span class="s">&quot;tps65921&quot;</span><span class="p">,</span> <span class="n">TPS_SUBSET</span> <span class="p">},</span>	<span class="cm">/* fewer LDOs; no codec, no LED</span>
<span class="cm">					   and vibrator. Charger in USB module*/</span>
	<span class="p">{</span> <span class="s">&quot;twl6030&quot;</span><span class="p">,</span> <span class="n">TWL6030_CLASS</span> <span class="p">},</span>	<span class="cm">/* &quot;Phoenix power chip&quot; */</span>
	<span class="p">{</span> <span class="s">&quot;twl6025&quot;</span><span class="p">,</span> <span class="n">TWL6030_CLASS</span> <span class="o">|</span> <span class="n">TWL6025_SUBCLASS</span> <span class="p">},</span> <span class="cm">/* &quot;Phoenix lite&quot; */</span>
	<span class="p">{</span> <span class="cm">/* end of list */</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">twl_ids</span><span class="p">);</span>

<span class="cm">/* One Client Driver , 4 Clients */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">twl_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">twl_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">twl_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">twl_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">twl_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">twl_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">twl_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">twl_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">twl_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">twl_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Texas Instruments, Inc.&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;I2C Core interface for TWL&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
