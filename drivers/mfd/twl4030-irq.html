<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mfd › twl4030-irq.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>twl4030-irq.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * twl4030-irq.c - TWL4030/TPS659x0 irq support</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 Texas Instruments, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Modifications to defer interrupt handling to a kernel thread:</span>
<span class="cm"> * Copyright (C) 2006 MontaVista Software, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on tlv320aic23.c:</span>
<span class="cm"> * Copyright (c) by Kai Svahn &lt;kai.svahn@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Code cleanup and modifications to IRQ handler.</span>
<span class="cm"> * by syed khasim &lt;x0khasim@ti.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/irqdomain.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/twl.h&gt;</span>

<span class="cp">#include &quot;twl-core.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * TWL4030 IRQ handling has two stages in hardware, and thus in software.</span>
<span class="cm"> * The Primary Interrupt Handler (PIH) stage exposes status bits saying</span>
<span class="cm"> * which Secondary Interrupt Handler (SIH) stage is raising an interrupt.</span>
<span class="cm"> * SIH modules are more traditional IRQ components, which support per-IRQ</span>
<span class="cm"> * enable/disable and trigger controls; they do most of the work.</span>
<span class="cm"> *</span>
<span class="cm"> * These chips are designed to support IRQ handling from two different</span>
<span class="cm"> * I2C masters.  Each has a dedicated IRQ line, and dedicated IRQ status</span>
<span class="cm"> * and mask registers in the PIH and SIH modules.</span>
<span class="cm"> *</span>
<span class="cm"> * We set up IRQs starting at a platform-specified base, always starting</span>
<span class="cm"> * with PIH and the SIH for PWR_INT and then usually adding GPIO:</span>
<span class="cm"> *	base + 0  .. base + 7	PIH</span>
<span class="cm"> *	base + 8  .. base + 15	SIH for PWR_INT</span>
<span class="cm"> *	base + 16 .. base + 33	SIH for GPIO</span>
<span class="cm"> */</span>
<span class="cp">#define TWL4030_CORE_NR_IRQS	8</span>
<span class="cp">#define TWL4030_PWR_NR_IRQS	8</span>

<span class="cm">/* PIH register offsets */</span>
<span class="cp">#define REG_PIH_ISR_P1			0x01</span>
<span class="cp">#define REG_PIH_ISR_P2			0x02</span>
<span class="cp">#define REG_PIH_SIR			0x03	</span><span class="cm">/* for testing */</span><span class="cp"></span>

<span class="cm">/* Linux could (eventually) use either IRQ line */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq_line</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">sih</span> <span class="p">{</span>
	<span class="kt">char</span>	<span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">module</span><span class="p">;</span>			<span class="cm">/* module id */</span>
	<span class="n">u8</span>	<span class="n">control_offset</span><span class="p">;</span>		<span class="cm">/* for SIH_CTRL */</span>
	<span class="n">bool</span>	<span class="n">set_cor</span><span class="p">;</span>

	<span class="n">u8</span>	<span class="n">bits</span><span class="p">;</span>			<span class="cm">/* valid in isr/imr */</span>
	<span class="n">u8</span>	<span class="n">bytes_ixr</span><span class="p">;</span>		<span class="cm">/* bytelen of ISR/IMR/SIR */</span>

	<span class="n">u8</span>	<span class="n">edr_offset</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">bytes_edr</span><span class="p">;</span>		<span class="cm">/* bytelen of EDR */</span>

	<span class="n">u8</span>	<span class="n">irq_lines</span><span class="p">;</span>		<span class="cm">/* number of supported irq lines */</span>

	<span class="cm">/* SIR ignored -- set interrupt, for testing only */</span>
	<span class="k">struct</span> <span class="n">sih_irq_data</span> <span class="p">{</span>
		<span class="n">u8</span>	<span class="n">isr_offset</span><span class="p">;</span>
		<span class="n">u8</span>	<span class="n">imr_offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">mask</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="cm">/* + 2 bytes padding */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sih</span> <span class="o">*</span><span class="n">sih_modules</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nr_sih_modules</span><span class="p">;</span>

<span class="cp">#define SIH_INITIALIZER(modname, nbits) \</span>
<span class="cp">	.module		= TWL4030_MODULE_ ## modname, \</span>
<span class="cp">	.control_offset = TWL4030_ ## modname ## _SIH_CTRL, \</span>
<span class="cp">	.bits		= nbits, \</span>
<span class="cp">	.bytes_ixr	= DIV_ROUND_UP(nbits, 8), \</span>
<span class="cp">	.edr_offset	= TWL4030_ ## modname ## _EDR, \</span>
<span class="cp">	.bytes_edr	= DIV_ROUND_UP((2*(nbits)), 8), \</span>
<span class="cp">	.irq_lines	= 2, \</span>
<span class="cp">	.mask = { { \</span>
<span class="cp">		.isr_offset	= TWL4030_ ## modname ## _ISR1, \</span>
<span class="cp">		.imr_offset	= TWL4030_ ## modname ## _IMR1, \</span>
<span class="cp">	}, \</span>
<span class="cp">	{ \</span>
<span class="cp">		.isr_offset	= TWL4030_ ## modname ## _ISR2, \</span>
<span class="cp">		.imr_offset	= TWL4030_ ## modname ## _IMR2, \</span>
<span class="cp">	}, },</span>

<span class="cm">/* register naming policies are inconsistent ... */</span>
<span class="cp">#define TWL4030_INT_PWR_EDR		TWL4030_INT_PWR_EDR1</span>
<span class="cp">#define TWL4030_MODULE_KEYPAD_KEYP	TWL4030_MODULE_KEYPAD</span>
<span class="cp">#define TWL4030_MODULE_INT_PWR		TWL4030_MODULE_INT</span>


<span class="cm">/*</span>
<span class="cm"> * Order in this table matches order in PIH_ISR.  That is,</span>
<span class="cm"> * BIT(n) in PIH_ISR is sih_modules[n].</span>
<span class="cm"> */</span>
<span class="cm">/* sih_modules_twl4030 is used both in twl4030 and twl5030 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sih</span> <span class="n">sih_modules_twl4030</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;gpio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">TWL4030_MODULE_GPIO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">control_offset</span>	<span class="o">=</span> <span class="n">REG_GPIO_SIH_CTRL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_cor</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits</span>		<span class="o">=</span> <span class="n">TWL4030_GPIO_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bytes_ixr</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="cm">/* Note: *all* of these IRQs default to no-trigger */</span>
		<span class="p">.</span><span class="n">edr_offset</span>	<span class="o">=</span> <span class="n">REG_GPIO_EDR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bytes_edr</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq_lines</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">isr_offset</span>	<span class="o">=</span> <span class="n">REG_GPIO_ISR1A</span><span class="p">,</span>
			<span class="p">.</span><span class="n">imr_offset</span>	<span class="o">=</span> <span class="n">REG_GPIO_IMR1A</span><span class="p">,</span>
		<span class="p">},</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">isr_offset</span>	<span class="o">=</span> <span class="n">REG_GPIO_ISR1B</span><span class="p">,</span>
			<span class="p">.</span><span class="n">imr_offset</span>	<span class="o">=</span> <span class="n">REG_GPIO_IMR1B</span><span class="p">,</span>
		<span class="p">},</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;keypad&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_cor</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="n">SIH_INITIALIZER</span><span class="p">(</span><span class="n">KEYPAD_KEYP</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;bci&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">TWL4030_MODULE_INTERRUPTS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">control_offset</span>	<span class="o">=</span> <span class="n">TWL4030_INTERRUPTS_BCISIHCTRL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_cor</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits</span>		<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bytes_ixr</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">edr_offset</span>	<span class="o">=</span> <span class="n">TWL4030_INTERRUPTS_BCIEDR1</span><span class="p">,</span>
		<span class="cm">/* Note: most of these IRQs default to no-trigger */</span>
		<span class="p">.</span><span class="n">bytes_edr</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq_lines</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">isr_offset</span>	<span class="o">=</span> <span class="n">TWL4030_INTERRUPTS_BCIISR1A</span><span class="p">,</span>
			<span class="p">.</span><span class="n">imr_offset</span>	<span class="o">=</span> <span class="n">TWL4030_INTERRUPTS_BCIIMR1A</span><span class="p">,</span>
		<span class="p">},</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">isr_offset</span>	<span class="o">=</span> <span class="n">TWL4030_INTERRUPTS_BCIISR1B</span><span class="p">,</span>
			<span class="p">.</span><span class="n">imr_offset</span>	<span class="o">=</span> <span class="n">TWL4030_INTERRUPTS_BCIIMR1B</span><span class="p">,</span>
		<span class="p">},</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;madc&quot;</span><span class="p">,</span>
		<span class="n">SIH_INITIALIZER</span><span class="p">(</span><span class="n">MADC</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* USB doesn&#39;t use the same SIH organization */</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;usb&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;power&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_cor</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="n">SIH_INITIALIZER</span><span class="p">(</span><span class="n">INT_PWR</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
	<span class="p">},</span>
		<span class="cm">/* there are no SIH modules #6 or #7 ... */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sih</span> <span class="n">sih_modules_twl5031</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;gpio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">TWL4030_MODULE_GPIO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">control_offset</span>	<span class="o">=</span> <span class="n">REG_GPIO_SIH_CTRL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_cor</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits</span>		<span class="o">=</span> <span class="n">TWL4030_GPIO_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bytes_ixr</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="cm">/* Note: *all* of these IRQs default to no-trigger */</span>
		<span class="p">.</span><span class="n">edr_offset</span>	<span class="o">=</span> <span class="n">REG_GPIO_EDR1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bytes_edr</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq_lines</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">isr_offset</span>	<span class="o">=</span> <span class="n">REG_GPIO_ISR1A</span><span class="p">,</span>
			<span class="p">.</span><span class="n">imr_offset</span>	<span class="o">=</span> <span class="n">REG_GPIO_IMR1A</span><span class="p">,</span>
		<span class="p">},</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">isr_offset</span>	<span class="o">=</span> <span class="n">REG_GPIO_ISR1B</span><span class="p">,</span>
			<span class="p">.</span><span class="n">imr_offset</span>	<span class="o">=</span> <span class="n">REG_GPIO_IMR1B</span><span class="p">,</span>
		<span class="p">},</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;keypad&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_cor</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="n">SIH_INITIALIZER</span><span class="p">(</span><span class="n">KEYPAD_KEYP</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;bci&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">TWL5031_MODULE_INTERRUPTS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">control_offset</span>	<span class="o">=</span> <span class="n">TWL5031_INTERRUPTS_BCISIHCTRL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits</span>		<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bytes_ixr</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">edr_offset</span>	<span class="o">=</span> <span class="n">TWL5031_INTERRUPTS_BCIEDR1</span><span class="p">,</span>
		<span class="cm">/* Note: most of these IRQs default to no-trigger */</span>
		<span class="p">.</span><span class="n">bytes_edr</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq_lines</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">isr_offset</span>	<span class="o">=</span> <span class="n">TWL5031_INTERRUPTS_BCIISR1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">imr_offset</span>	<span class="o">=</span> <span class="n">TWL5031_INTERRUPTS_BCIIMR1</span><span class="p">,</span>
		<span class="p">},</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">isr_offset</span>	<span class="o">=</span> <span class="n">TWL5031_INTERRUPTS_BCIISR2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">imr_offset</span>	<span class="o">=</span> <span class="n">TWL5031_INTERRUPTS_BCIIMR2</span><span class="p">,</span>
		<span class="p">},</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;madc&quot;</span><span class="p">,</span>
		<span class="n">SIH_INITIALIZER</span><span class="p">(</span><span class="n">MADC</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* USB doesn&#39;t use the same SIH organization */</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;usb&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;power&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_cor</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="n">SIH_INITIALIZER</span><span class="p">(</span><span class="n">INT_PWR</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * ECI/DBI doesn&#39;t use the same SIH organization.</span>
<span class="cm">		 * For example, it supports only one interrupt output line.</span>
<span class="cm">		 * That is, the interrupts are seen on both INT1 and INT2 lines.</span>
<span class="cm">		 */</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;eci_dbi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">TWL5031_MODULE_ACCESSORY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits</span>		<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bytes_ixr</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq_lines</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">isr_offset</span>	<span class="o">=</span> <span class="n">TWL5031_ACIIDR_LSB</span><span class="p">,</span>
			<span class="p">.</span><span class="n">imr_offset</span>	<span class="o">=</span> <span class="n">TWL5031_ACIIMR_LSB</span><span class="p">,</span>
		<span class="p">},</span> <span class="p">},</span>

	<span class="p">},</span>
	<span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Audio accessory */</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;audio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">module</span>		<span class="o">=</span> <span class="n">TWL5031_MODULE_ACCESSORY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">control_offset</span>	<span class="o">=</span> <span class="n">TWL5031_ACCSIHCTRL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bits</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bytes_ixr</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">edr_offset</span>	<span class="o">=</span> <span class="n">TWL5031_ACCEDR1</span><span class="p">,</span>
		<span class="cm">/* Note: most of these IRQs default to no-trigger */</span>
		<span class="p">.</span><span class="n">bytes_edr</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq_lines</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">isr_offset</span>	<span class="o">=</span> <span class="n">TWL5031_ACCISR1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">imr_offset</span>	<span class="o">=</span> <span class="n">TWL5031_ACCIMR1</span><span class="p">,</span>
		<span class="p">},</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">isr_offset</span>	<span class="o">=</span> <span class="n">TWL5031_ACCISR2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">imr_offset</span>	<span class="o">=</span> <span class="n">TWL5031_ACCIMR2</span><span class="p">,</span>
		<span class="p">},</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#undef TWL4030_MODULE_KEYPAD_KEYP</span>
<span class="cp">#undef TWL4030_MODULE_INT_PWR</span>
<span class="cp">#undef TWL4030_INT_PWR_EDR</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">twl4030_irq_base</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * handle_twl4030_pih() is the desc-&gt;handle method for the twl4030 interrupt.</span>
<span class="cm"> * This is a chained interrupt, so there is no desc-&gt;action method for it.</span>
<span class="cm"> * Now we need to query the interrupt controller in the twl4030 to determine</span>
<span class="cm"> * which module is generating the interrupt request.  However, we can&#39;t do i2c</span>
<span class="cm"> * transactions in interrupt context, so we must defer that work to a kernel</span>
<span class="cm"> * thread.  All we do here is acknowledge and mask the interrupt and wakeup</span>
<span class="cm"> * the kernel thread.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">handle_twl4030_pih</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqreturn_t</span>	<span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">pih_isr</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">twl_i2c_read_u8</span><span class="p">(</span><span class="n">TWL4030_MODULE_PIH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pih_isr</span><span class="p">,</span>
			<span class="n">REG_PIH_ISR_P1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;twl4030: I2C error %d reading PIH ISR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pih_isr</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">pending</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">pih_isr</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">irq</span><span class="p">;</span>

		<span class="n">pih_isr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">pending</span><span class="p">);</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">pending</span> <span class="o">+</span> <span class="n">twl4030_irq_base</span><span class="p">;</span>
		<span class="n">handle_nested_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * twl4030_init_sih_modules() ... start from a known state where no</span>
<span class="cm"> * IRQs will be coming in, and where we can quickly enable them then</span>
<span class="cm"> * handle them as they arrive.  Mask all IRQs: maybe init SIH_CTRL.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:  we don&#39;t touch EDR registers here; they stay with hardware</span>
<span class="cm"> * defaults or whatever the last value was.  Note that when both EDR</span>
<span class="cm"> * bits for an IRQ are clear, that&#39;s as if its IMR bit is set...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_init_sih_modules</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sih</span> <span class="o">*</span><span class="n">sih</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* line 0 == int1_n signal; line 1 == int2_n signal */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">irq_line</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>

	<span class="cm">/* disable all interrupts on our line */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">sih</span> <span class="o">=</span> <span class="n">sih_modules</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_sih_modules</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">sih</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* skip USB -- it&#39;s funky */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sih</span><span class="o">-&gt;</span><span class="n">bytes_ixr</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Not all the SIH modules support multiple interrupt lines */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sih</span><span class="o">-&gt;</span><span class="n">irq_lines</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">twl_i2c_write</span><span class="p">(</span><span class="n">sih</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
				<span class="n">sih</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">[</span><span class="n">line</span><span class="p">].</span><span class="n">imr_offset</span><span class="p">,</span> <span class="n">sih</span><span class="o">-&gt;</span><span class="n">bytes_ixr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;twl4030: err %d initializing %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">status</span><span class="p">,</span> <span class="n">sih</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;IMR&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Maybe disable &quot;exclusive&quot; mode; buffer second pending irq;</span>
<span class="cm">		 * set Clear-On-Read (COR) bit.</span>
<span class="cm">		 *</span>
<span class="cm">		 * NOTE that sometimes COR polarity is documented as being</span>
<span class="cm">		 * inverted:  for MADC, COR=1 means &quot;clear on write&quot;.</span>
<span class="cm">		 * And for PWR_INT it&#39;s not documented...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sih</span><span class="o">-&gt;</span><span class="n">set_cor</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">twl_i2c_write_u8</span><span class="p">(</span><span class="n">sih</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span>
					<span class="n">TWL4030_SIH_CTRL_COR_MASK</span><span class="p">,</span>
					<span class="n">sih</span><span class="o">-&gt;</span><span class="n">control_offset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;twl4030: err %d initializing %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">status</span><span class="p">,</span> <span class="n">sih</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;SIH_CTRL&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sih</span> <span class="o">=</span> <span class="n">sih_modules</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_sih_modules</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">sih</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">rxbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

		<span class="cm">/* skip USB */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sih</span><span class="o">-&gt;</span><span class="n">bytes_ixr</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Not all the SIH modules support multiple interrupt lines */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sih</span><span class="o">-&gt;</span><span class="n">irq_lines</span> <span class="o">&lt;=</span> <span class="n">line</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Clear pending interrupt status.  Either the read was</span>
<span class="cm">		 * enough, or we need to write those bits.  Repeat, in</span>
<span class="cm">		 * case an IRQ is pending (PENDDIS=0) ... that&#39;s not</span>
<span class="cm">		 * uncommon with PWR_INT.PWRON.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">twl_i2c_read</span><span class="p">(</span><span class="n">sih</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">rxbuf</span><span class="p">,</span>
				<span class="n">sih</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">[</span><span class="n">line</span><span class="p">].</span><span class="n">isr_offset</span><span class="p">,</span> <span class="n">sih</span><span class="o">-&gt;</span><span class="n">bytes_ixr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;twl4030: err %d initializing %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">status</span><span class="p">,</span> <span class="n">sih</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ISR&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sih</span><span class="o">-&gt;</span><span class="n">set_cor</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">twl_i2c_write</span><span class="p">(</span><span class="n">sih</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
					<span class="n">sih</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">[</span><span class="n">line</span><span class="p">].</span><span class="n">isr_offset</span><span class="p">,</span>
					<span class="n">sih</span><span class="o">-&gt;</span><span class="n">bytes_ixr</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * else COR=1 means read sufficed.</span>
<span class="cm">			 * (for most SIH modules...)</span>
<span class="cm">			 */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">activate_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ARM</span>
	<span class="cm">/*</span>
<span class="cm">	 * ARM requires an extra step to clear IRQ_NOREQUEST, which it</span>
<span class="cm">	 * sets on behalf of every irq_chip.  Also sets IRQ_NOPROBE.</span>
<span class="cm">	 */</span>
	<span class="n">set_irq_flags</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQF_VALID</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="cm">/* same effect on other architectures */</span>
	<span class="n">irq_set_noprobe</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">struct</span> <span class="n">sih_agent</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">irq_base</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sih</span>	<span class="o">*</span><span class="n">sih</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">imr</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">imr_change_pending</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">edge_change</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">irq_lock</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">irq_name</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * All irq_chip methods get issued from code holding irq_desc[irq].lock,</span>
<span class="cm"> * which can&#39;t perform the underlying I2C operations (because they sleep).</span>
<span class="cm"> * So we must hand them off to a thread (workqueue) and cope with asynch</span>
<span class="cm"> * completion, potentially including some re-ordering, of these requests.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">twl4030_sih_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sih_agent</span> <span class="o">*</span><span class="n">agent</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">agent</span><span class="o">-&gt;</span><span class="n">imr</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">agent</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">);</span>
	<span class="n">agent</span><span class="o">-&gt;</span><span class="n">imr_change_pending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">twl4030_sih_unmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sih_agent</span> <span class="o">*</span><span class="n">agent</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">agent</span><span class="o">-&gt;</span><span class="n">imr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">agent</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">);</span>
	<span class="n">agent</span><span class="o">-&gt;</span><span class="n">imr_change_pending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">twl4030_sih_set_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">trigger</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sih_agent</span> <span class="o">*</span><span class="n">agent</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trigger</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">IRQ_TYPE_EDGE_FALLING</span> <span class="o">|</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqd_get_trigger_type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">trigger</span><span class="p">)</span>
		<span class="n">agent</span><span class="o">-&gt;</span><span class="n">edge_change</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">agent</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">twl4030_sih_bus_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sih_agent</span>	<span class="o">*</span><span class="n">agent</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">twl4030_sih_bus_sync_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sih_agent</span>	<span class="o">*</span><span class="n">agent</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sih</span>	<span class="o">*</span><span class="n">sih</span> <span class="o">=</span> <span class="n">agent</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">imr_change_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">word</span><span class="p">;</span>
			<span class="n">u8</span>	<span class="n">bytes</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="p">}</span> <span class="n">imr</span><span class="p">;</span>

		<span class="cm">/* byte[0] gets overwritten as we write ... */</span>
		<span class="n">imr</span><span class="p">.</span><span class="n">word</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">imr</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">agent</span><span class="o">-&gt;</span><span class="n">imr_change_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* write the whole mask ... simpler than subsetting it */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">twl_i2c_write</span><span class="p">(</span><span class="n">sih</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">imr</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span>
				<span class="n">sih</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">[</span><span class="n">irq_line</span><span class="p">].</span><span class="n">imr_offset</span><span class="p">,</span>
				<span class="n">sih</span><span class="o">-&gt;</span><span class="n">bytes_ixr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;twl4030: %s, %s --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">edge_change</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span>		<span class="n">edge_change</span><span class="p">;</span>
		<span class="n">u8</span>		<span class="n">bytes</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

		<span class="n">edge_change</span> <span class="o">=</span> <span class="n">agent</span><span class="o">-&gt;</span><span class="n">edge_change</span><span class="p">;</span>
		<span class="n">agent</span><span class="o">-&gt;</span><span class="n">edge_change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Read, reserving first byte for write scratch.  Yes, this</span>
<span class="cm">		 * could be cached for some speedup ... but be careful about</span>
<span class="cm">		 * any processor on the other IRQ line, EDR registers are</span>
<span class="cm">		 * shared.</span>
<span class="cm">		 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">twl_i2c_read</span><span class="p">(</span><span class="n">sih</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">bytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">sih</span><span class="o">-&gt;</span><span class="n">edr_offset</span><span class="p">,</span> <span class="n">sih</span><span class="o">-&gt;</span><span class="n">bytes_edr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;twl4030: %s, %s --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="s">&quot;read&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Modify only the bits we know must change */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">edge_change</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span>		<span class="n">i</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">edge_change</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">irq_data</span>	<span class="o">*</span><span class="n">idata</span><span class="p">;</span>
			<span class="kt">int</span>		<span class="n">byte</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="kt">int</span>		<span class="n">off</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">type</span><span class="p">;</span>

			<span class="n">idata</span> <span class="o">=</span> <span class="n">irq_get_irq_data</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">agent</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">);</span>

			<span class="n">bytes</span><span class="p">[</span><span class="n">byte</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="n">off</span><span class="p">);</span>

			<span class="n">type</span> <span class="o">=</span> <span class="n">irqd_get_trigger_type</span><span class="p">(</span><span class="n">idata</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">)</span>
				<span class="n">bytes</span><span class="p">[</span><span class="n">byte</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">off</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">)</span>
				<span class="n">bytes</span><span class="p">[</span><span class="n">byte</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">off</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">edge_change</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Write */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">twl_i2c_write</span><span class="p">(</span><span class="n">sih</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span>
				<span class="n">sih</span><span class="o">-&gt;</span><span class="n">edr_offset</span><span class="p">,</span> <span class="n">sih</span><span class="o">-&gt;</span><span class="n">bytes_edr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;twl4030: %s, %s --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">twl4030_sih_irq_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;twl4030&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">twl4030_sih_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">twl4030_sih_unmask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_type</span>	<span class="o">=</span> <span class="n">twl4030_sih_set_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_bus_lock</span>	<span class="o">=</span> <span class="n">twl4030_sih_bus_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_bus_sync_unlock</span> <span class="o">=</span> <span class="n">twl4030_sih_bus_sync_unlock</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sih_read_isr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sih</span> <span class="o">*</span><span class="n">sih</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">bytes</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">u32</span> <span class="n">word</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">isr</span><span class="p">;</span>

	<span class="cm">/* FIXME need retry-on-error ... */</span>

	<span class="n">isr</span><span class="p">.</span><span class="n">word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">twl_i2c_read</span><span class="p">(</span><span class="n">sih</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">,</span> <span class="n">isr</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span>
			<span class="n">sih</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">[</span><span class="n">irq_line</span><span class="p">].</span><span class="n">isr_offset</span><span class="p">,</span> <span class="n">sih</span><span class="o">-&gt;</span><span class="n">bytes_ixr</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">status</span> <span class="o">:</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">isr</span><span class="p">.</span><span class="n">word</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Generic handler for SIH interrupts ... we &quot;know&quot; this is called</span>
<span class="cm"> * in task context, with IRQs enabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">handle_twl4030_sih</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sih_agent</span> <span class="o">*</span><span class="n">agent</span> <span class="o">=</span> <span class="n">irq_get_handler_data</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sih</span> <span class="o">*</span><span class="n">sih</span> <span class="o">=</span> <span class="n">agent</span><span class="o">-&gt;</span><span class="n">sih</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">isr</span><span class="p">;</span>

	<span class="cm">/* reading ISR acks the IRQs, using clear-on-read mode */</span>
	<span class="n">isr</span> <span class="o">=</span> <span class="n">sih_read_isr</span><span class="p">(</span><span class="n">sih</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;twl4030: %s SIH, read ISR error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sih</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
		<span class="cm">/* REVISIT:  recover; eventually mask it all, etc */</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">isr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">isr</span><span class="p">);</span>
		<span class="n">irq</span><span class="o">--</span><span class="p">;</span>
		<span class="n">isr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="n">sih</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">)</span>
			<span class="n">handle_nested_irq</span><span class="p">(</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">+</span> <span class="n">irq</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;twl4030: %s SIH, invalid ISR bit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sih</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns the first IRQ used by this SIH bank, or negative errno */</span>
<span class="kt">int</span> <span class="nf">twl4030_sih_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">module</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">sih_mod</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sih</span>	<span class="o">*</span><span class="n">sih</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sih_agent</span>	<span class="o">*</span><span class="n">agent</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* only support modules with standard clear-on-read for now */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">sih_mod</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sih</span> <span class="o">=</span> <span class="n">sih_modules</span><span class="p">;</span> <span class="n">sih_mod</span> <span class="o">&lt;</span> <span class="n">nr_sih_modules</span><span class="p">;</span>
			<span class="n">sih_mod</span><span class="o">++</span><span class="p">,</span> <span class="n">sih</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sih</span><span class="o">-&gt;</span><span class="n">module</span> <span class="o">==</span> <span class="n">module</span> <span class="o">&amp;&amp;</span> <span class="n">sih</span><span class="o">-&gt;</span><span class="n">set_cor</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">agent</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">agent</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">agent</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">agent</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">=</span> <span class="n">irq_base</span><span class="p">;</span>
	<span class="n">agent</span><span class="o">-&gt;</span><span class="n">sih</span> <span class="o">=</span> <span class="n">sih</span><span class="p">;</span>
	<span class="n">agent</span><span class="o">-&gt;</span><span class="n">imr</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agent</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sih</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">irq_base</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">irq_set_chip_data</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">agent</span><span class="p">);</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">twl4030_sih_irq_chip</span><span class="p">,</span>
					 <span class="n">handle_edge_irq</span><span class="p">);</span>
		<span class="n">irq_set_nested_thread</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">activate_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* replace generic PIH handler (handle_simple_irq) */</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">sih_mod</span> <span class="o">+</span> <span class="n">twl4030_irq_base</span><span class="p">;</span>
	<span class="n">irq_set_handler_data</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">agent</span><span class="p">);</span>
	<span class="n">agent</span><span class="o">-&gt;</span><span class="n">irq_name</span> <span class="o">=</span> <span class="n">kasprintf</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="s">&quot;twl4030_%s&quot;</span><span class="p">,</span> <span class="n">sih</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">handle_twl4030_sih</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">agent</span><span class="o">-&gt;</span><span class="n">irq_name</span> <span class="o">?:</span> <span class="n">sih</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s (irq %d) chaining IRQs %d..%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sih</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">irq</span><span class="p">,</span> <span class="n">irq_base</span><span class="p">,</span> <span class="n">irq_base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">status</span> <span class="o">:</span> <span class="n">irq_base</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FIXME need a call to reverse twl4030_sih_setup() ... */</span>

<span class="cm">/*----------------------------------------------------------------------*/</span>

<span class="cm">/* FIXME pass in which interrupt line we&#39;ll use ... */</span>
<span class="cp">#define twl_irq_line	0</span>

<span class="kt">int</span> <span class="nf">twl4030_init_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span>	<span class="n">twl4030_irq_chip</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">irq_base</span><span class="p">,</span> <span class="n">irq_end</span><span class="p">,</span> <span class="n">nr_irqs</span><span class="p">;</span>
	<span class="k">struct</span>			<span class="n">device_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * TWL core and pwr interrupts must be contiguous because</span>
<span class="cm">	 * the hwirqs numbers are defined contiguously from 1 to 15.</span>
<span class="cm">	 * Create only one domain for both.</span>
<span class="cm">	 */</span>
	<span class="n">nr_irqs</span> <span class="o">=</span> <span class="n">TWL4030_PWR_NR_IRQS</span> <span class="o">+</span> <span class="n">TWL4030_CORE_NR_IRQS</span><span class="p">;</span>

	<span class="n">irq_base</span> <span class="o">=</span> <span class="n">irq_alloc_descs</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nr_irqs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">irq_base</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Fail to allocate IRQ descs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">irq_base</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq_domain_add_legacy</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">nr_irqs</span><span class="p">,</span> <span class="n">irq_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">irq_domain_simple_ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">irq_end</span> <span class="o">=</span> <span class="n">irq_base</span> <span class="o">+</span> <span class="n">TWL4030_CORE_NR_IRQS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mask and clear all TWL4030 interrupts since initially we do</span>
<span class="cm">	 * not have any TWL4030 module interrupt handlers present</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">twl4030_init_sih_modules</span><span class="p">(</span><span class="n">twl_irq_line</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">twl4030_irq_base</span> <span class="o">=</span> <span class="n">irq_base</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Install an irq handler for each of the SIH modules;</span>
<span class="cm">	 * clone dummy irq_chip since PIH can&#39;t *do* anything</span>
<span class="cm">	 */</span>
	<span class="n">twl4030_irq_chip</span> <span class="o">=</span> <span class="n">dummy_irq_chip</span><span class="p">;</span>
	<span class="n">twl4030_irq_chip</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;twl4030&quot;</span><span class="p">;</span>

	<span class="n">twl4030_sih_irq_chip</span><span class="p">.</span><span class="n">irq_ack</span> <span class="o">=</span> <span class="n">dummy_irq_chip</span><span class="p">.</span><span class="n">irq_ack</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">irq_base</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">irq_end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">twl4030_irq_chip</span><span class="p">,</span>
					 <span class="n">handle_simple_irq</span><span class="p">);</span>
		<span class="n">irq_set_nested_thread</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">activate_irq</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s (irq %d) chaining IRQs %d..%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;PIH&quot;</span><span class="p">,</span>
			<span class="n">irq_num</span><span class="p">,</span> <span class="n">irq_base</span><span class="p">,</span> <span class="n">irq_end</span><span class="p">);</span>

	<span class="cm">/* ... and the PWR_INT module ... */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">twl4030_sih_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TWL4030_MODULE_INT</span><span class="p">,</span> <span class="n">irq_end</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sih_setup PWR INT --&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* install an irq handler to demultiplex the TWL4030 interrupt */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">irq_num</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">handle_twl4030_pih</span><span class="p">,</span>
				      <span class="n">IRQF_ONESHOT</span><span class="p">,</span>
				      <span class="s">&quot;TWL4030-PIH&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not claim irq%d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq_num</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_rqirq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">enable_irq_wake</span><span class="p">(</span><span class="n">irq_num</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">irq_base</span><span class="p">;</span>
<span class="nl">fail_rqirq:</span>
	<span class="cm">/* clean up twl4030_sih_setup */</span>
<span class="nl">fail:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">irq_base</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">irq_end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_set_nested_thread</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">twl4030_exit_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME undo twl_init_irq() */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twl4030_irq_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;twl4030: can&#39;t yet clean up IRQs?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">twl4030_init_chip_irq</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="s">&quot;twl5031&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sih_modules</span> <span class="o">=</span> <span class="n">sih_modules_twl5031</span><span class="p">;</span>
		<span class="n">nr_sih_modules</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sih_modules_twl5031</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sih_modules</span> <span class="o">=</span> <span class="n">sih_modules_twl4030</span><span class="p">;</span>
		<span class="n">nr_sih_modules</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sih_modules_twl4030</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
