<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mfd › sm501.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sm501.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* linux/drivers/mfd/sm501.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Simtec Electronics</span>
<span class="cm"> *	Ben Dooks &lt;ben@simtec.co.uk&gt;</span>
<span class="cm"> *	Vincent Sanders &lt;vince@simtec.co.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * SM501 MFD driver</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/i2c-gpio.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/sm501.h&gt;</span>
<span class="cp">#include &lt;linux/sm501-regs.h&gt;</span>
<span class="cp">#include &lt;linux/serial_8250.h&gt;</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="k">struct</span> <span class="n">sm501_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>		<span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span>		<span class="n">pdev</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sm501_gpio</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MFD_SM501_GPIO</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>

<span class="k">struct</span> <span class="n">sm501_gpio_chip</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">gpio_chip</span>	<span class="n">gpio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sm501_gpio</span>	<span class="o">*</span><span class="n">ourgpio</span><span class="p">;</span>	<span class="cm">/* to get back to parent. */</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">regbase</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">control</span><span class="p">;</span>	<span class="cm">/* address of control reg. */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sm501_gpio</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_gpio_chip</span>	<span class="n">low</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sm501_gpio_chip</span>	<span class="n">high</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		 <span class="n">registered</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>		<span class="o">*</span><span class="n">regs_res</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="k">struct</span> <span class="n">sm501_gpio</span> <span class="p">{</span>
	<span class="cm">/* no gpio support, empty definition for sm501_devdata. */</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>			 <span class="n">reg_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>			 <span class="n">clock_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>		 <span class="n">devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sm501_gpio</span>		 <span class="n">gpio</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">device</span>			<span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>			<span class="o">*</span><span class="n">io_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>			<span class="o">*</span><span class="n">mem_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>			<span class="o">*</span><span class="n">regs_claim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sm501_platdata</span>		<span class="o">*</span><span class="n">platdata</span><span class="p">;</span>


	<span class="kt">unsigned</span> <span class="kt">int</span>			 <span class="n">in_suspend</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			 <span class="n">pm_misc</span><span class="p">;</span>

	<span class="kt">int</span>				 <span class="n">unit_power</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			 <span class="n">pdev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			 <span class="n">irq</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>			<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			 <span class="n">rev</span><span class="p">;</span>
<span class="p">};</span>


<span class="cp">#define MHZ (1000 * 1000)</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">div_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">5</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">6</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">7</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">8</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">9</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">10</span><span class="p">]</span>	        <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">11</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">12</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">13</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">96</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">14</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">192</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">15</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">384</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">16</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">17</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">18</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">19</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">20</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">21</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">160</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">22</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">320</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">23</span><span class="p">]</span>		<span class="o">=</span> <span class="mi">604</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">decode_div</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pll2</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lshft</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">selbit</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">selbit</span><span class="p">)</span>
		<span class="n">pll2</span> <span class="o">=</span> <span class="mi">288</span> <span class="o">*</span> <span class="n">MHZ</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pll2</span> <span class="o">/</span> <span class="n">div_tab</span><span class="p">[(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">lshft</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">];</span>
<span class="p">}</span>

<span class="cp">#define fmt_freq(x) ((x) / MHZ), ((x) % MHZ), (x)</span>

<span class="cm">/* sm501_dump_clk</span>
<span class="cm"> *</span>
<span class="cm"> * Print out the current clock configuration for the device</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm501_dump_clk</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">misct</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_MISC_TIMING</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pm0</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_0_CLOCK</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pm1</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_1_CLOCK</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pmc</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_CONTROL</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sdclk0</span><span class="p">,</span> <span class="n">sdclk1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pll2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">misct</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>:
		<span class="n">pll2</span> <span class="o">=</span> <span class="mi">336</span> <span class="o">*</span> <span class="n">MHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x10</span>:
		<span class="n">pll2</span> <span class="o">=</span> <span class="mi">288</span> <span class="o">*</span> <span class="n">MHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x20</span>:
		<span class="n">pll2</span> <span class="o">=</span> <span class="mi">240</span> <span class="o">*</span> <span class="n">MHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x30</span>:
		<span class="n">pll2</span> <span class="o">=</span> <span class="mi">192</span> <span class="o">*</span> <span class="n">MHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdclk0</span> <span class="o">=</span> <span class="p">(</span><span class="n">misct</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">))</span> <span class="o">?</span> <span class="n">pll2</span> <span class="o">:</span> <span class="mi">288</span> <span class="o">*</span> <span class="n">MHZ</span><span class="p">;</span>
	<span class="n">sdclk0</span> <span class="o">/=</span> <span class="n">div_tab</span><span class="p">[((</span><span class="n">misct</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)];</span>

	<span class="n">sdclk1</span> <span class="o">=</span> <span class="p">(</span><span class="n">misct</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">))</span> <span class="o">?</span> <span class="n">pll2</span> <span class="o">:</span> <span class="mi">288</span> <span class="o">*</span> <span class="n">MHZ</span><span class="p">;</span>
	<span class="n">sdclk1</span> <span class="o">/=</span> <span class="n">div_tab</span><span class="p">[((</span><span class="n">misct</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)];</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MISCT=%08lx, PM0=%08lx, PM1=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">misct</span><span class="p">,</span> <span class="n">pm0</span><span class="p">,</span> <span class="n">pm1</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PLL2 = %ld.%ld MHz (%ld), SDCLK0=%08lx, SDCLK1=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fmt_freq</span><span class="p">(</span><span class="n">pll2</span><span class="p">),</span> <span class="n">sdclk0</span><span class="p">,</span> <span class="n">sdclk1</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SDRAM: PM0=%ld, PM1=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sdclk0</span><span class="p">,</span> <span class="n">sdclk1</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PM0[%c]: &quot;</span>
		 <span class="s">&quot;P2 %ld.%ld MHz (%ld), V2 %ld.%ld (%ld), &quot;</span>
		 <span class="s">&quot;M %ld.%ld (%ld), MX1 %ld.%ld (%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">pmc</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="sc">&#39;*&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
		 <span class="n">fmt_freq</span><span class="p">(</span><span class="n">decode_div</span><span class="p">(</span><span class="n">pll2</span><span class="p">,</span> <span class="n">pm0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">)),</span>
		 <span class="n">fmt_freq</span><span class="p">(</span><span class="n">decode_div</span><span class="p">(</span><span class="n">pll2</span><span class="p">,</span> <span class="n">pm0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">)),</span>
		 <span class="n">fmt_freq</span><span class="p">(</span><span class="n">decode_div</span><span class="p">(</span><span class="n">pll2</span><span class="p">,</span> <span class="n">pm0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">)),</span>
		 <span class="n">fmt_freq</span><span class="p">(</span><span class="n">decode_div</span><span class="p">(</span><span class="n">pll2</span><span class="p">,</span> <span class="n">pm0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">,</span>  <span class="mi">15</span><span class="p">)));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PM1[%c]: &quot;</span>
		<span class="s">&quot;P2 %ld.%ld MHz (%ld), V2 %ld.%ld (%ld), &quot;</span>
		<span class="s">&quot;M %ld.%ld (%ld), MX1 %ld.%ld (%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">pmc</span> <span class="o">&amp;</span> <span class="mi">3</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="sc">&#39;*&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
		<span class="n">fmt_freq</span><span class="p">(</span><span class="n">decode_div</span><span class="p">(</span><span class="n">pll2</span><span class="p">,</span> <span class="n">pm1</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">)),</span>
		<span class="n">fmt_freq</span><span class="p">(</span><span class="n">decode_div</span><span class="p">(</span><span class="n">pll2</span><span class="p">,</span> <span class="n">pm1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">)),</span>
		<span class="n">fmt_freq</span><span class="p">(</span><span class="n">decode_div</span><span class="p">(</span><span class="n">pll2</span><span class="p">,</span> <span class="n">pm1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">)),</span>
		<span class="n">fmt_freq</span><span class="p">(</span><span class="n">decode_div</span><span class="p">(</span><span class="n">pll2</span><span class="p">,</span> <span class="n">pm1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">,</span>  <span class="mi">15</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm501_dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;System Control   %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">smc501_readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_SYSTEM_CONTROL</span><span class="p">));</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Misc Control     %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">smc501_readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_MISC_CONTROL</span><span class="p">));</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GPIO Control Low %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">smc501_readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_GPIO31_0_CONTROL</span><span class="p">));</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GPIO Control Hi  %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">smc501_readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_GPIO63_32_CONTROL</span><span class="p">));</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DRAM Control     %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">smc501_readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_DRAM_CONTROL</span><span class="p">));</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Arbitration Ctrl %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">smc501_readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_ARBTRTN_CONTROL</span><span class="p">));</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Misc Timing      %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">smc501_readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_MISC_TIMING</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm501_dump_gate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CurrentGate      %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_CURRENT_GATE</span><span class="p">));</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CurrentClock     %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_CURRENT_CLOCK</span><span class="p">));</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PowerModeControl %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_CONTROL</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sm501_dump_gate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sm501_dump_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sm501_dump_clk</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* sm501_sync_regs</span>
<span class="cm"> *</span>
<span class="cm"> * ensure the</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm501_sync_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sm501_mdelay</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* during suspend/resume, we are currently not allowed to sleep,</span>
<span class="cm">	 * so change to using mdelay() instead of msleep() if we</span>
<span class="cm">	 * are in one of these paths */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">in_suspend</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* sm501_misc_control</span>
<span class="cm"> *</span>
<span class="cm"> * alters the miscellaneous control parameters</span>
<span class="cm">*/</span>

<span class="kt">int</span> <span class="nf">sm501_misc_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">misc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">save</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">to</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">save</span><span class="p">);</span>

	<span class="n">misc</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_MISC_CONTROL</span><span class="p">);</span>
	<span class="n">to</span> <span class="o">=</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">clear</span><span class="p">)</span> <span class="o">|</span> <span class="n">set</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">to</span> <span class="o">!=</span> <span class="n">misc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smc501_writel</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_MISC_CONTROL</span><span class="p">);</span>
		<span class="n">sm501_sync_regs</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MISC_CONTROL %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">misc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">save</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">to</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sm501_misc_control</span><span class="p">);</span>

<span class="cm">/* sm501_modify_reg</span>
<span class="cm"> *</span>
<span class="cm"> * Modify a register in the SM501 which may be shared with other</span>
<span class="cm"> * drivers.</span>
<span class="cm">*/</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sm501_modify_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">set</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">save</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">save</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">set</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">clear</span><span class="p">;</span>

	<span class="n">smc501_writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">sm501_sync_regs</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">save</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sm501_modify_reg</span><span class="p">);</span>

<span class="cm">/* sm501_unit_power</span>
<span class="cm"> *</span>
<span class="cm"> * alters the power active gate to set specific units on or off</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">sm501_unit_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unit</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">clock</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">clock_lock</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_CONTROL</span><span class="p">);</span>
	<span class="n">gate</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_CURRENT_GATE</span><span class="p">);</span>
	<span class="n">clock</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_CURRENT_CLOCK</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">&amp;=</span> <span class="mi">3</span><span class="p">;</span>		<span class="cm">/* get current power mode */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">unit_power</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: bad unit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">already</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: unit %d, cur %d, to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span>
		<span class="n">sm</span><span class="o">-&gt;</span><span class="n">unit_power</span><span class="p">[</span><span class="n">unit</span><span class="p">],</span> <span class="n">to</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">to</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">unit_power</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unit %d is already shutdown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">already</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">unit_power</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">+=</span> <span class="n">to</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">to</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">unit_power</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gate</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">unit</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">already</span><span class="p">;</span>
		<span class="n">gate</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">unit</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gate</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">unit</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">already</span><span class="p">;</span>
		<span class="n">gate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">unit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">smc501_writel</span><span class="p">(</span><span class="n">gate</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_0_GATE</span><span class="p">);</span>
		<span class="n">smc501_writel</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_0_CLOCK</span><span class="p">);</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">smc501_writel</span><span class="p">(</span><span class="n">gate</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_1_GATE</span><span class="p">);</span>
		<span class="n">smc501_writel</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_1_CLOCK</span><span class="p">);</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">gate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">already</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smc501_writel</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_CONTROL</span><span class="p">);</span>
	<span class="n">sm501_sync_regs</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gate %08lx, clock %08lx, mode %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">gate</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">sm501_mdelay</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

 <span class="nl">already:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">clock_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">gate</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sm501_unit_power</span><span class="p">);</span>

<span class="cm">/* clock value structure. */</span>
<span class="k">struct</span> <span class="n">sm501_clock</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mclk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">divider</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* sm501_calc_clock</span>
<span class="cm"> *</span>
<span class="cm"> * Calculates the nearest discrete clock frequency that</span>
<span class="cm"> * can be achieved with the specified input clock.</span>
<span class="cm"> *   the maximum divisor is 3 or 5</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sm501_calc_clock</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freq</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sm501_clock</span> <span class="o">*</span><span class="n">clock</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">max_div</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mclk</span><span class="p">,</span>
			    <span class="kt">long</span> <span class="o">*</span><span class="n">best_diff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">divider</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">diff</span><span class="p">;</span>

	<span class="cm">/* try dividers 1 and 3 for CRT and for panel,</span>
<span class="cm">	   try divider 5 for panel only.*/</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">divider</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">divider</span> <span class="o">&lt;=</span> <span class="n">max_div</span><span class="p">;</span> <span class="n">divider</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* try all 8 shift values.*/</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">shift</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Calculate difference to requested clock */</span>
			<span class="n">diff</span> <span class="o">=</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">mclk</span><span class="p">,</span> <span class="n">divider</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="n">freq</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">diff</span> <span class="o">=</span> <span class="o">-</span><span class="n">diff</span><span class="p">;</span>

			<span class="cm">/* If it is less than the current, use it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">best_diff</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">best_diff</span> <span class="o">=</span> <span class="n">diff</span><span class="p">;</span>

				<span class="n">clock</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">=</span> <span class="n">mclk</span><span class="p">;</span>
				<span class="n">clock</span><span class="o">-&gt;</span><span class="n">divider</span> <span class="o">=</span> <span class="n">divider</span><span class="p">;</span>
				<span class="n">clock</span><span class="o">-&gt;</span><span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sm501_calc_pll</span>
<span class="cm"> *</span>
<span class="cm"> * Calculates the nearest discrete clock frequency that can be</span>
<span class="cm"> * achieved using the programmable PLL.</span>
<span class="cm"> *   the maximum divisor is 3 or 5</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sm501_calc_pll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freq</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sm501_clock</span> <span class="o">*</span><span class="n">clock</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">max_div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mclk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">best_diff</span> <span class="o">=</span> <span class="mi">999999999</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The SM502 datasheet doesn&#39;t specify the min/max values for M and N.</span>
<span class="cm">	 * N = 1 at least doesn&#39;t work in practice.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">127</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mclk</span> <span class="o">=</span> <span class="p">(</span><span class="mi">24000000UL</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">k</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">sm501_calc_clock</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">max_div</span><span class="p">,</span>
						     <span class="n">mclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">best_diff</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
					<span class="n">clock</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
					<span class="n">clock</span><span class="o">-&gt;</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Return best clock. */</span>
	<span class="k">return</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">divider</span> <span class="o">&lt;&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* sm501_select_clock</span>
<span class="cm"> *</span>
<span class="cm"> * Calculates the nearest discrete clock frequency that can be</span>
<span class="cm"> * achieved using the 288MHz and 336MHz PLLs.</span>
<span class="cm"> *   the maximum divisor is 3 or 5</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sm501_select_clock</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freq</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">sm501_clock</span> <span class="o">*</span><span class="n">clock</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">max_div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mclk</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">best_diff</span> <span class="o">=</span> <span class="mi">999999999</span><span class="p">;</span>

	<span class="cm">/* Try 288MHz and 336MHz clocks. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">mclk</span> <span class="o">=</span> <span class="mi">288000000</span><span class="p">;</span> <span class="n">mclk</span> <span class="o">&lt;=</span> <span class="mi">336000000</span><span class="p">;</span> <span class="n">mclk</span> <span class="o">+=</span> <span class="mi">48000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sm501_calc_clock</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">max_div</span><span class="p">,</span> <span class="n">mclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">best_diff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Return best clock. */</span>
	<span class="k">return</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">mclk</span> <span class="o">/</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">divider</span> <span class="o">&lt;&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* sm501_set_clock</span>
<span class="cm"> *</span>
<span class="cm"> * set one of the four clock sources to the closest available frequency to</span>
<span class="cm"> *  the one specified</span>
<span class="cm">*/</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sm501_set_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">clksrc</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">req_freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_CONTROL</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gate</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_CURRENT_GATE</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">clock</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_CURRENT_CLOCK</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pll_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sm501_freq</span><span class="p">;</span> <span class="cm">/* the actual frequency achieved */</span>

	<span class="k">struct</span> <span class="n">sm501_clock</span> <span class="n">to</span><span class="p">;</span>

	<span class="cm">/* find achivable discrete frequency and setup register value</span>
<span class="cm">	 * accordingly, V2XCLK, MCLK and M1XCLK are the same P2XCLK</span>
<span class="cm">	 * has an extra bit for the divider */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">clksrc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SM501_CLOCK_P2XCLK</span>:
		<span class="cm">/* This clock is divided in half so to achieve the</span>
<span class="cm">		 * requested frequency the value must be multiplied by</span>
<span class="cm">		 * 2. This clock also has an additional pre divisor */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* SM502 -&gt; use the programmable PLL */</span>
			<span class="n">sm501_freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">sm501_calc_pll</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">req_freq</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">to</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">to</span><span class="p">.</span><span class="n">shift</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span><span class="cm">/* bottom 3 bits are shift */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="p">.</span><span class="n">divider</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span> <span class="cm">/* /3 divider required */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="p">.</span><span class="n">divider</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="cm">/* /5 divider required */</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="cm">/* select the programmable PLL */</span>
			<span class="n">pll_reg</span> <span class="o">=</span> <span class="mh">0x20000</span> <span class="o">|</span> <span class="p">(</span><span class="n">to</span><span class="p">.</span><span class="n">k</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">to</span><span class="p">.</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">to</span><span class="p">.</span><span class="n">m</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sm501_freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">sm501_select_clock</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">req_freq</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">to</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">to</span><span class="p">.</span><span class="n">shift</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span><span class="cm">/* bottom 3 bits are shift */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="p">.</span><span class="n">divider</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span> <span class="cm">/* /3 divider required */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="p">.</span><span class="n">divider</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="cm">/* /5 divider required */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="p">.</span><span class="n">mclk</span> <span class="o">!=</span> <span class="mi">288000000</span><span class="p">)</span>
				<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="cm">/* which mclk pll is source */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SM501_CLOCK_V2XCLK</span>:
		<span class="cm">/* This clock is divided in half so to achieve the</span>
<span class="cm">		 * requested frequency the value must be multiplied by 2. */</span>

		<span class="n">sm501_freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">sm501_select_clock</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">req_freq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">reg</span><span class="o">=</span><span class="n">to</span><span class="p">.</span><span class="n">shift</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>	<span class="cm">/* bottom 3 bits are shift */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="p">.</span><span class="n">divider</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>	<span class="cm">/* /3 divider required */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="p">.</span><span class="n">mclk</span> <span class="o">!=</span> <span class="mi">288000000</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* which mclk pll is source */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SM501_CLOCK_MCLK</span>:
	<span class="k">case</span> <span class="n">SM501_CLOCK_M1XCLK</span>:
		<span class="cm">/* These clocks are the same and not further divided */</span>

		<span class="n">sm501_freq</span> <span class="o">=</span> <span class="n">sm501_select_clock</span><span class="p">(</span> <span class="n">req_freq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">reg</span><span class="o">=</span><span class="n">to</span><span class="p">.</span><span class="n">shift</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>	<span class="cm">/* bottom 3 bits are shift */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="p">.</span><span class="n">divider</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>	<span class="cm">/* /3 divider required */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">to</span><span class="p">.</span><span class="n">mclk</span> <span class="o">!=</span> <span class="mi">288000000</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* which mclk pll is source */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* this is bad */</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">clock_lock</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_CONTROL</span><span class="p">);</span>
	<span class="n">gate</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_CURRENT_GATE</span><span class="p">);</span>
	<span class="n">clock</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_CURRENT_CLOCK</span><span class="p">);</span>

	<span class="n">clock</span> <span class="o">=</span> <span class="n">clock</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFF</span> <span class="o">&lt;&lt;</span> <span class="n">clksrc</span><span class="p">);</span>
	<span class="n">clock</span> <span class="o">|=</span> <span class="n">reg</span><span class="o">&lt;&lt;</span><span class="n">clksrc</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">&amp;=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* find current mode */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">smc501_writel</span><span class="p">(</span><span class="n">gate</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_0_GATE</span><span class="p">);</span>
		<span class="n">smc501_writel</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_0_CLOCK</span><span class="p">);</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">smc501_writel</span><span class="p">(</span><span class="n">gate</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_1_GATE</span><span class="p">);</span>
		<span class="n">smc501_writel</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_1_CLOCK</span><span class="p">);</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">clock_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smc501_writel</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_POWER_MODE_CONTROL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pll_reg</span><span class="p">)</span>
		<span class="n">smc501_writel</span><span class="p">(</span><span class="n">pll_reg</span><span class="p">,</span>
				<span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_PROGRAMMABLE_PLL_CONTROL</span><span class="p">);</span>

	<span class="n">sm501_sync_regs</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gate %08lx, clock %08lx, mode %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">gate</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">sm501_mdelay</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">clock_lock</span><span class="p">);</span>

	<span class="n">sm501_dump_clk</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sm501_freq</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sm501_set_clock</span><span class="p">);</span>

<span class="cm">/* sm501_find_clock</span>
<span class="cm"> *</span>
<span class="cm"> * finds the closest available frequency for a given clock</span>
<span class="cm">*/</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sm501_find_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">clksrc</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">req_freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sm501_freq</span><span class="p">;</span> <span class="cm">/* the frequency achieveable by the 501 */</span>
	<span class="k">struct</span> <span class="n">sm501_clock</span> <span class="n">to</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">clksrc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SM501_CLOCK_P2XCLK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* SM502 -&gt; use the programmable PLL */</span>
			<span class="n">sm501_freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">sm501_calc_pll</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">req_freq</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">to</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sm501_freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">sm501_select_clock</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">req_freq</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">to</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SM501_CLOCK_V2XCLK</span>:
		<span class="n">sm501_freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">sm501_select_clock</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">req_freq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SM501_CLOCK_MCLK</span>:
	<span class="k">case</span> <span class="n">SM501_CLOCK_M1XCLK</span>:
		<span class="n">sm501_freq</span> <span class="o">=</span> <span class="n">sm501_select_clock</span><span class="p">(</span><span class="n">req_freq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">sm501_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* error */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sm501_freq</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sm501_find_clock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sm501_device</span> <span class="o">*</span><span class="nf">to_sm_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sm501_device</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* sm501_device_release</span>
<span class="cm"> *</span>
<span class="cm"> * A release function for the platform devices we create to allow us to</span>
<span class="cm"> * free any items we allocated</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm501_device_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">to_sm_device</span><span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/* sm501_create_subdev</span>
<span class="cm"> *</span>
<span class="cm"> * Create a skeleton platform device with resources for passing to a</span>
<span class="cm"> * sub-driver</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span>
<span class="nf">sm501_create_subdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res_count</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">platform_data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_device</span> <span class="o">*</span><span class="n">smdev</span><span class="p">;</span>

	<span class="n">smdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_device</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span><span class="p">)</span> <span class="o">*</span> <span class="n">res_count</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">platform_data_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">smdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">sm501_device_release</span><span class="p">;</span>

	<span class="n">smdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">smdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">pdev_id</span><span class="p">;</span>
	<span class="n">smdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">resource</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="p">)(</span><span class="n">smdev</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">smdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">res_count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">platform_data_size</span><span class="p">)</span>
		<span class="n">smdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">smdev</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">smdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sm501_register_device</span>
<span class="cm"> *</span>
<span class="cm"> * Register a platform device created with sm501_create_subdev()</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sm501_register_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_device</span> <span class="o">*</span><span class="n">smdev</span> <span class="o">=</span> <span class="n">to_sm_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">num_resources</span><span class="p">;</span> <span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s[%d] %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">ptr</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_register</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;registered %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smdev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error registering %s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sm501_create_subio</span>
<span class="cm"> *</span>
<span class="cm"> * Fill in an IO resource for a sub device</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm501_create_subio</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			       <span class="n">resource_size_t</span> <span class="n">offs</span><span class="p">,</span>
			       <span class="n">resource_size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">io_res</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">io_res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">offs</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sm501_create_mem</span>
<span class="cm"> *</span>
<span class="cm"> * Fill in an MEM resource for a sub device</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm501_create_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			     <span class="n">resource_size_t</span> <span class="o">*</span><span class="n">offs</span><span class="p">,</span>
			     <span class="n">resource_size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">offs</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>		<span class="cm">/* adjust memory size */</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">mem_res</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">mem_res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="o">*</span><span class="n">offs</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sm501_create_irq</span>
<span class="cm"> *</span>
<span class="cm"> * Fill in an IRQ resource for a sub device</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm501_create_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sm501_register_usbhost</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
				  <span class="n">resource_size_t</span> <span class="o">*</span><span class="n">mem_avail</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">sm501_create_subdev</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="s">&quot;sm501-usb&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sm501_create_subio</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mh">0x40000</span><span class="p">,</span> <span class="mh">0x20000</span><span class="p">);</span>
	<span class="n">sm501_create_mem</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mem_avail</span><span class="p">,</span> <span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
	<span class="n">sm501_create_irq</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">sm501_register_device</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm501_setup_uart_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">plat_serial8250_port</span> <span class="o">*</span><span class="n">uart_data</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uart_data</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">uart_data</span><span class="o">-&gt;</span><span class="n">mapbase</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">io_res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">uart_data</span><span class="o">-&gt;</span><span class="n">iotype</span> <span class="o">=</span> <span class="n">UPIO_MEM</span><span class="p">;</span>
	<span class="n">uart_data</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">uart_data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">UPF_BOOT_AUTOCONF</span> <span class="o">|</span> <span class="n">UPF_SKIP_TEST</span> <span class="o">|</span> <span class="n">UPF_SHARE_IRQ</span><span class="p">;</span>
	<span class="n">uart_data</span><span class="o">-&gt;</span><span class="n">regshift</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uart_data</span><span class="o">-&gt;</span><span class="n">uartclk</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9600</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sm501_register_uart</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devices</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">plat_serial8250_port</span> <span class="o">*</span><span class="n">uart_data</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">sm501_create_subdev</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="s">&quot;serial8250&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">plat_serial8250_port</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">uart_data</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">SM501_USE_UART0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sm501_setup_uart_data</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">uart_data</span><span class="o">++</span><span class="p">,</span> <span class="mh">0x30000</span><span class="p">);</span>
		<span class="n">sm501_unit_power</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SM501_GATE_UART0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sm501_modify_reg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SM501_IRQ_MASK</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sm501_modify_reg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SM501_GPIO63_32_CONTROL</span><span class="p">,</span> <span class="mh">0x01e0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">SM501_USE_UART1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sm501_setup_uart_data</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">uart_data</span><span class="o">++</span><span class="p">,</span> <span class="mh">0x30020</span><span class="p">);</span>
		<span class="n">sm501_unit_power</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SM501_GATE_UART1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sm501_modify_reg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SM501_IRQ_MASK</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sm501_modify_reg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SM501_GPIO63_32_CONTROL</span><span class="p">,</span> <span class="mh">0x1e00</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">PLAT8250_DEV_SM501</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sm501_register_device</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sm501_register_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
				  <span class="n">resource_size_t</span> <span class="o">*</span><span class="n">mem_avail</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">sm501_create_subdev</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="s">&quot;sm501-fb&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sm501_create_subio</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mh">0x80000</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>
	<span class="n">sm501_create_subio</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mh">0x100000</span><span class="p">,</span> <span class="mh">0x50000</span><span class="p">);</span>
	<span class="n">sm501_create_mem</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mem_avail</span><span class="p">,</span> <span class="o">*</span><span class="n">mem_avail</span><span class="p">);</span>
	<span class="n">sm501_create_irq</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">sm501_register_device</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MFD_SM501_GPIO</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sm501_gpio_chip</span> <span class="o">*</span><span class="nf">to_sm501_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">gc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sm501_gpio_chip</span><span class="p">,</span> <span class="n">gpio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="nf">sm501_gpio_to_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_gpio</span> <span class="o">*</span><span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">gpio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sm501_devdata</span><span class="p">,</span> <span class="n">gpio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sm501_gpio_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_gpio_chip</span> <span class="o">*</span><span class="n">smgpio</span> <span class="o">=</span> <span class="n">to_sm501_gpio</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">smgpio</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">+</span> <span class="n">SM501_GPIO_DATA_LOW</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">&gt;&gt;=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="mi">1UL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm501_gpio_ensure_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_gpio_chip</span> <span class="o">*</span><span class="n">smchip</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="cm">/* check and modify if this pin is not set as gpio. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smc501_readl</span><span class="p">(</span><span class="n">smchip</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">sm501_gpio_to_dev</span><span class="p">(</span><span class="n">smchip</span><span class="o">-&gt;</span><span class="n">ourgpio</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;changing mode of gpio, bit %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>

		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">smchip</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit</span><span class="p">;</span>
		<span class="n">smc501_writel</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">smchip</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>

		<span class="n">sm501_sync_regs</span><span class="p">(</span><span class="n">sm501_gpio_to_dev</span><span class="p">(</span><span class="n">smchip</span><span class="o">-&gt;</span><span class="n">ourgpio</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm501_gpio_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_gpio_chip</span> <span class="o">*</span><span class="n">smchip</span> <span class="o">=</span> <span class="n">to_sm501_gpio</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sm501_gpio</span> <span class="o">*</span><span class="n">smgpio</span> <span class="o">=</span> <span class="n">smchip</span><span class="o">-&gt;</span><span class="n">ourgpio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">smchip</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">save</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sm501_gpio_to_dev</span><span class="p">(</span><span class="n">smgpio</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(%p,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smgpio</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">save</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_GPIO_DATA_LOW</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">bit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="n">smc501_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="n">sm501_sync_regs</span><span class="p">(</span><span class="n">sm501_gpio_to_dev</span><span class="p">(</span><span class="n">smgpio</span><span class="p">));</span>
	<span class="n">sm501_gpio_ensure_gpio</span><span class="p">(</span><span class="n">smchip</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smgpio</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">save</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sm501_gpio_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_gpio_chip</span> <span class="o">*</span><span class="n">smchip</span> <span class="o">=</span> <span class="n">to_sm501_gpio</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sm501_gpio</span> <span class="o">*</span><span class="n">smgpio</span> <span class="o">=</span> <span class="n">smchip</span><span class="o">-&gt;</span><span class="n">ourgpio</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">smchip</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">save</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ddr</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sm501_gpio_to_dev</span><span class="p">(</span><span class="n">smgpio</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(%p,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smgpio</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">save</span><span class="p">);</span>

	<span class="n">ddr</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_GPIO_DDR_LOW</span><span class="p">);</span>
	<span class="n">smc501_writel</span><span class="p">(</span><span class="n">ddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">bit</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_GPIO_DDR_LOW</span><span class="p">);</span>

	<span class="n">sm501_sync_regs</span><span class="p">(</span><span class="n">sm501_gpio_to_dev</span><span class="p">(</span><span class="n">smgpio</span><span class="p">));</span>
	<span class="n">sm501_gpio_ensure_gpio</span><span class="p">(</span><span class="n">smchip</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smgpio</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">save</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sm501_gpio_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_gpio_chip</span> <span class="o">*</span><span class="n">smchip</span> <span class="o">=</span> <span class="n">to_sm501_gpio</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sm501_gpio</span> <span class="o">*</span><span class="n">smgpio</span> <span class="o">=</span> <span class="n">smchip</span><span class="o">-&gt;</span><span class="n">ourgpio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">smchip</span><span class="o">-&gt;</span><span class="n">regbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">save</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ddr</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sm501_gpio_to_dev</span><span class="p">(</span><span class="n">smgpio</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(%p,%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smgpio</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">save</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_GPIO_DATA_LOW</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bit</span><span class="p">;</span>
	<span class="n">smc501_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="n">ddr</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_GPIO_DDR_LOW</span><span class="p">);</span>
	<span class="n">smc501_writel</span><span class="p">(</span><span class="n">ddr</span> <span class="o">|</span> <span class="n">bit</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_GPIO_DDR_LOW</span><span class="p">);</span>

	<span class="n">sm501_sync_regs</span><span class="p">(</span><span class="n">sm501_gpio_to_dev</span><span class="p">(</span><span class="n">smgpio</span><span class="p">));</span>
	<span class="n">smc501_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_GPIO_DATA_LOW</span><span class="p">);</span>

	<span class="n">sm501_sync_regs</span><span class="p">(</span><span class="n">sm501_gpio_to_dev</span><span class="p">(</span><span class="n">smgpio</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smgpio</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">save</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_chip</span> <span class="n">gpio_chip_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ngpio</span>			<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">direction_input</span>	<span class="o">=</span> <span class="n">sm501_gpio_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">direction_output</span>	<span class="o">=</span> <span class="n">sm501_gpio_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set</span>			<span class="o">=</span> <span class="n">sm501_gpio_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span>			<span class="o">=</span> <span class="n">sm501_gpio_get</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sm501_gpio_register_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">sm501_gpio</span> <span class="o">*</span><span class="n">gpio</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">sm501_gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_platdata</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">platdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">gchip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_base</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">gpio_chip_template</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">high</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">base</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_GPIO_DATA_HIGH</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_GPIO63_32_CONTROL</span><span class="p">;</span>
		<span class="n">gchip</span><span class="o">-&gt;</span><span class="n">label</span>  <span class="o">=</span> <span class="s">&quot;SM501-HIGH&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">regbase</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_GPIO_DATA_LOW</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_GPIO31_0_CONTROL</span><span class="p">;</span>
		<span class="n">gchip</span><span class="o">-&gt;</span><span class="n">label</span>  <span class="o">=</span> <span class="s">&quot;SM501-LOW&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gchip</span><span class="o">-&gt;</span><span class="n">base</span>   <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ourgpio</span> <span class="o">=</span> <span class="n">gpio</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">gpiochip_add</span><span class="p">(</span><span class="n">gchip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sm501_register_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_gpio</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">io_res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">SM501_GPIO</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;registering gpio block %08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">iobase</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">regs_res</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="s">&quot;sm501-gpio&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">regs_res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gpio: failed to request region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gpio: failed to remap registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_claimed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register both our chips. */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sm501_gpio_register_chip</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">gpio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">low</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to add low chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_mapped</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sm501_gpio_register_chip</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">gpio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">high</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to add high chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_low_chip</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_low_chip:</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">gpiochip_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">low</span><span class="p">.</span><span class="n">gpio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot remove low chip, cannot tidy up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">err_mapped:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

 <span class="nl">err_claimed:</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">regs_res</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">regs_res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm501_gpio_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_gpio</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">registered</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpiochip_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">low</span><span class="p">.</span><span class="n">gpio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot remove low chip, cannot tidy up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpiochip_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">high</span><span class="p">.</span><span class="n">gpio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot remove high chip, cannot tidy up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">regs_res</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">regs_res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sm501_gpio_pin2nr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_gpio</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">pin</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">?</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">low</span><span class="p">.</span><span class="n">gpio</span><span class="p">.</span><span class="n">base</span> <span class="o">:</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">high</span><span class="p">.</span><span class="n">gpio</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">pin</span> <span class="o">%</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="n">base</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sm501_gpio_isregistered</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">registered</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sm501_register_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sm501_gpio_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sm501_gpio_pin2nr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sm501_gpio_isregistered</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sm501_register_gpio_i2c_instance</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">sm501_platdata_gpio_i2c</span> <span class="o">*</span><span class="n">iic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_gpio_platform_data</span> <span class="o">*</span><span class="n">icd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">sm501_create_subdev</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="s">&quot;i2c-gpio&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_gpio_platform_data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">icd</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="cm">/* We keep the pin_sda and pin_scl fields relative in case the</span>
<span class="cm">	 * same platform data is passed to &gt;1 SM501.</span>
<span class="cm">	 */</span>

	<span class="n">icd</span><span class="o">-&gt;</span><span class="n">sda_pin</span> <span class="o">=</span> <span class="n">sm501_gpio_pin2nr</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">iic</span><span class="o">-&gt;</span><span class="n">pin_sda</span><span class="p">);</span>
	<span class="n">icd</span><span class="o">-&gt;</span><span class="n">scl_pin</span> <span class="o">=</span> <span class="n">sm501_gpio_pin2nr</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">iic</span><span class="o">-&gt;</span><span class="n">pin_scl</span><span class="p">);</span>
	<span class="n">icd</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">iic</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>
	<span class="n">icd</span><span class="o">-&gt;</span><span class="n">udelay</span> <span class="o">=</span> <span class="n">iic</span><span class="o">-&gt;</span><span class="n">udelay</span><span class="p">;</span>

	<span class="cm">/* note, we can&#39;t use either of the pin numbers, as the i2c-gpio</span>
<span class="cm">	 * driver uses the platform.id field to generate the bus number</span>
<span class="cm">	 * to register with the i2c core; The i2c core doesn&#39;t have enough</span>
<span class="cm">	 * entries to deal with anything we currently use.</span>
<span class="cm">	*/</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">iic</span><span class="o">-&gt;</span><span class="n">bus_num</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;registering i2c-%d: sda=%d (%d), scl=%d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">iic</span><span class="o">-&gt;</span><span class="n">bus_num</span><span class="p">,</span>
		 <span class="n">icd</span><span class="o">-&gt;</span><span class="n">sda_pin</span><span class="p">,</span> <span class="n">iic</span><span class="o">-&gt;</span><span class="n">pin_sda</span><span class="p">,</span> <span class="n">icd</span><span class="o">-&gt;</span><span class="n">scl_pin</span><span class="p">,</span> <span class="n">iic</span><span class="o">-&gt;</span><span class="n">pin_scl</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sm501_register_device</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sm501_register_gpio_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sm501_platdata</span> <span class="o">*</span><span class="n">pdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_platdata_gpio_i2c</span> <span class="o">*</span><span class="n">iic</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_i2c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_i2c_nr</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">,</span> <span class="n">iic</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sm501_register_gpio_i2c_instance</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">iic</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sm501_dbg_regs</span>
<span class="cm"> *</span>
<span class="cm"> * Debug attribute to attach to parent device to show core registers</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sm501_dbg_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>	<span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">buff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x70</span><span class="p">;</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="s">&quot;%08x = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">reg</span><span class="p">,</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">reg</span><span class="p">));</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">buff</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">dbg_regs</span><span class="p">,</span> <span class="mo">0666</span><span class="p">,</span> <span class="n">sm501_dbg_regs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* sm501_init_reg</span>
<span class="cm"> *</span>
<span class="cm"> * Helper function for the init code to setup a register</span>
<span class="cm"> *</span>
<span class="cm"> * clear the bits which are set in r-&gt;mask, and then set</span>
<span class="cm"> * the bits set in r-&gt;set.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sm501_init_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">sm501_reg_init</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">;</span>
	<span class="n">smc501_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* sm501_init_regs</span>
<span class="cm"> *</span>
<span class="cm"> * Setup core register values</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm501_init_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sm501_initdata</span> <span class="o">*</span><span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sm501_misc_control</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="n">init</span><span class="o">-&gt;</span><span class="n">misc_control</span><span class="p">.</span><span class="n">set</span><span class="p">,</span>
			   <span class="n">init</span><span class="o">-&gt;</span><span class="n">misc_control</span><span class="p">.</span><span class="n">mask</span><span class="p">);</span>

	<span class="n">sm501_init_reg</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">SM501_MISC_TIMING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">misc_timing</span><span class="p">);</span>
	<span class="n">sm501_init_reg</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">SM501_GPIO31_0_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">gpio_low</span><span class="p">);</span>
	<span class="n">sm501_init_reg</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">SM501_GPIO63_32_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">gpio_high</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">m1xclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setting M1XCLK to %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">m1xclk</span><span class="p">);</span>
		<span class="n">sm501_set_clock</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SM501_CLOCK_M1XCLK</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">m1xclk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setting MCLK to %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">);</span>
		<span class="n">sm501_set_clock</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SM501_CLOCK_MCLK</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/* Check the PLL sources for the M1CLK and M1XCLK</span>
<span class="cm"> *</span>
<span class="cm"> * If the M1CLK and M1XCLKs are not sourced from the same PLL, then</span>
<span class="cm"> * there is a risk (see errata AB-5) that the SM501 will cease proper</span>
<span class="cm"> * function. If this happens, then it is likely the SM501 will</span>
<span class="cm"> * hang the system.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sm501_check_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pwrmode</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_CURRENT_CLOCK</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msrc</span> <span class="o">=</span> <span class="p">(</span><span class="n">pwrmode</span> <span class="o">&amp;</span> <span class="n">SM501_POWERMODE_M_SRC</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">m1src</span> <span class="o">=</span> <span class="p">(</span><span class="n">pwrmode</span> <span class="o">&amp;</span> <span class="n">SM501_POWERMODE_M1_SRC</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">msrc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">m1src</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">msrc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">m1src</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sm501_mem_local</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">5</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* sm501_init_dev</span>
<span class="cm"> *</span>
<span class="cm"> * Common init code for an SM501</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sm501_init_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_initdata</span> <span class="o">*</span><span class="n">idata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sm501_platdata</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">mem_avail</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dramctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">devid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">clock_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>

	<span class="n">devid</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_DEVICEID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">devid</span> <span class="o">&amp;</span> <span class="n">SM501_DEVICEID_IDMASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SM501_DEVICEID_SM501</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;incorrect device id %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devid</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* disable irqs */</span>
	<span class="n">smc501_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_IRQ_MASK</span><span class="p">);</span>

	<span class="n">dramctrl</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_DRAM_CONTROL</span><span class="p">);</span>
	<span class="n">mem_avail</span> <span class="o">=</span> <span class="n">sm501_mem_local</span><span class="p">[(</span><span class="n">dramctrl</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">];</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SM501 At %p: Version %08lx, %ld Mb, IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mem_avail</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">devid</span> <span class="o">&amp;</span> <span class="n">SM501_DEVICEID_REVMASK</span><span class="p">;</span>

	<span class="n">sm501_dump_gate</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_dbg_regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create debug regs file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">sm501_dump_clk</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>

	<span class="cm">/* check to see if we have some device initialisation */</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">platdata</span><span class="p">;</span>
	<span class="n">idata</span> <span class="o">=</span> <span class="n">pdata</span> <span class="o">?</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sm501_init_regs</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">idata</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">SM501_USE_USB_HOST</span><span class="p">)</span>
			<span class="n">sm501_register_usbhost</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_avail</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SM501_USE_UART0</span> <span class="o">|</span> <span class="n">SM501_USE_UART1</span><span class="p">))</span>
			<span class="n">sm501_register_uart</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">SM501_USE_GPIO</span><span class="p">)</span>
			<span class="n">sm501_register_gpio</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_i2c</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_i2c_nr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sm501_gpio_isregistered</span><span class="p">(</span><span class="n">sm</span><span class="p">))</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no gpio available for i2c gpio.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sm501_register_gpio_i2c</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">pdata</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sm501_check_clocks</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;M1X and M clocks sourced from different &quot;</span>
					<span class="s">&quot;PLLs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* always create a framebuffer */</span>
	<span class="n">sm501_register_display</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_avail</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sm501_plat_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no memory for device data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">pdev_id</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">platdata</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get irq resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_res</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">io_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">mem_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">io_res</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">mem_res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get IO resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs_claim</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">io_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
					    <span class="mh">0x100</span><span class="p">,</span> <span class="s">&quot;sm501&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs_claim</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot claim registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sm</span><span class="p">);</span>

	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">io_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">io_res</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot remap registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_claim</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sm501_init_dev</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>

 <span class="nl">err_claim:</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs_claim</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs_claim</span><span class="p">);</span>
 <span class="nl">err_res:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>
 <span class="nl">err1:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="cm">/* power management support */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm501_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_platdata</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">platdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">get_power</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">get_power</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="n">on</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;is already %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">set_power</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setting power to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>

		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">set_power</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
		<span class="n">sm501_mdelay</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sm501_plat_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">pm_misc</span> <span class="o">=</span> <span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_MISC_CONTROL</span><span class="p">);</span>

	<span class="n">sm501_dump_regs</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">platdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">platdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SM501_FLAG_SUSPEND_OFF</span><span class="p">)</span>
			<span class="n">sm501_set_power</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sm501_plat_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">sm501_set_power</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">sm501_dump_regs</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>
	<span class="n">sm501_dump_gate</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>
	<span class="n">sm501_dump_clk</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>

	<span class="cm">/* check to see if we are in the same state as when suspended */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smc501_readl</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_MISC_CONTROL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">pm_misc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SM501_MISC_CONTROL changed over sleep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">smc501_writel</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">pm_misc</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">SM501_MISC_CONTROL</span><span class="p">);</span>

		<span class="cm">/* our suspend causes the controller state to change,</span>
<span class="cm">		 * either by something attempting setup, power loss,</span>
<span class="cm">		 * or an external reset event on power change */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">platdata</span> <span class="o">&amp;&amp;</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">platdata</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sm501_init_regs</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">platdata</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* dump our state from resume */</span>

	<span class="n">sm501_dump_regs</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>
	<span class="n">sm501_dump_clk</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>

	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define sm501_plat_suspend NULL</span>
<span class="cp">#define sm501_plat_resume NULL</span>
<span class="cp">#endif</span>

<span class="cm">/* Initialisation data for PCI devices */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sm501_initdata</span> <span class="n">sm501_pci_initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gpio_high</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">set</span>	<span class="o">=</span> <span class="mh">0x3F000000</span><span class="p">,</span>		<span class="cm">/* 24bit panel */</span>
		<span class="p">.</span><span class="n">mask</span>	<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">misc_timing</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">set</span>	<span class="o">=</span> <span class="mh">0x010100</span><span class="p">,</span>		<span class="cm">/* SDRAM timing */</span>
		<span class="p">.</span><span class="n">mask</span>	<span class="o">=</span> <span class="mh">0x1F1F00</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">misc_control</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">set</span>	<span class="o">=</span> <span class="n">SM501_MISC_PNL_24BIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">.</span><span class="n">devices</span>	<span class="o">=</span> <span class="n">SM501_USE_ALL</span><span class="p">,</span>

	<span class="cm">/* Errata AB-3 says that 72MHz is the fastest available</span>
<span class="cm">	 * for 33MHZ PCI with proper bus-mastering operation */</span>

	<span class="p">.</span><span class="n">mclk</span>		<span class="o">=</span> <span class="mi">72</span> <span class="o">*</span> <span class="n">MHZ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">m1xclk</span>		<span class="o">=</span> <span class="mi">144</span> <span class="o">*</span> <span class="n">MHZ</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sm501_platdata_fbsub</span> <span class="n">sm501_pdata_fbsub</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="p">(</span><span class="n">SM501FB_FLAG_USE_INIT_MODE</span> <span class="o">|</span>
			   <span class="n">SM501FB_FLAG_USE_HWCURSOR</span> <span class="o">|</span>
			   <span class="n">SM501FB_FLAG_USE_HWACCEL</span> <span class="o">|</span>
			   <span class="n">SM501FB_FLAG_DISABLE_AT_EXIT</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sm501_platdata_fb</span> <span class="n">sm501_fb_pdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fb_route</span>	<span class="o">=</span> <span class="n">SM501_FB_OWN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_crt</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sm501_pdata_fbsub</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pnl</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sm501_pdata_fbsub</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sm501_platdata</span> <span class="n">sm501_pci_platdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sm501_pci_initdata</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sm501_fb_pdata</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gpio_base</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sm501_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no memory for device data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set a default set of platform data */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">platdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sm501_pci_platdata</span><span class="p">;</span>

	<span class="cm">/* set a hopefully unique id for our child platform devices */</span>
	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">pdev_id</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sm</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot enable device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="cm">/* if the system is big-endian, we most probably have a</span>
<span class="cm">	 * translation in the IO layer making the PCI bus little endian</span>
<span class="cm">	 * so make the framebuffer swapped pixels */</span>

	<span class="n">sm501_fb_pdata</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SM501_FBPD_SWAP_FB_ENDIAN</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* check our resources */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;region #0 is not memory?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;region #1 is not memory?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make our resources ready for sharing */</span>

	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">io_res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">mem_res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs_claim</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">io_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
					    <span class="mh">0x100</span><span class="p">,</span> <span class="s">&quot;sm501&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs_claim</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot claim registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span><span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot remap registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sm501_init_dev</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err4:</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs_claim</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs_claim</span><span class="p">);</span>
 <span class="nl">err3:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">err2:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>
 <span class="nl">err1:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm501_remove_sub</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">sm501_device</span> <span class="o">*</span><span class="n">smdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smdev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm501_dev_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_device</span> <span class="o">*</span><span class="n">smdev</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">smdev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">sm501_remove_sub</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">smdev</span><span class="p">);</span>

	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_dbg_regs</span><span class="p">);</span>

	<span class="n">sm501_gpio_remove</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">sm501_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">sm501_dev_remove</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">release_resource</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs_claim</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs_claim</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sm501_plat_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sm501_devdata</span> <span class="o">*</span><span class="n">sm</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">sm501_dev_remove</span><span class="p">(</span><span class="n">sm</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">release_resource</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs_claim</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">regs_claim</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">sm501_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x126f</span><span class="p">,</span> <span class="mh">0x0501</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">sm501_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">sm501_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sm501&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">sm501_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">sm501_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sm501_pci_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:sm501&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">__devinitdata</span> <span class="n">of_sm501_match_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;smi,sm501&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* end */</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">sm501_plat_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;sm501&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">of_sm501_match_tbl</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">sm501_plat_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">sm501_plat_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">sm501_plat_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">sm501_plat_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sm501_base_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm501_plat_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm501_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sm501_base_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm501_plat_driver</span><span class="p">);</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm501_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sm501_base_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sm501_base_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SM501 Core Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ben Dooks &lt;ben@simtec.co.uk&gt;, Vincent Sanders&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
