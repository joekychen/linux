<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mfd › timberdale.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>timberdale.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * timberdale.c timberdale FPGA MFD driver</span>
<span class="cm"> * Copyright (c) 2009 Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cm">/* Supports:</span>
<span class="cm"> * Timberdale FPGA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/msi.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/core.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/timb_gpio.h&gt;</span>

<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/i2c-ocores.h&gt;</span>
<span class="cp">#include &lt;linux/i2c-xiic.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/tsc2007.h&gt;</span>

<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/spi/xilinx_spi.h&gt;</span>
<span class="cp">#include &lt;linux/spi/max7301.h&gt;</span>
<span class="cp">#include &lt;linux/spi/mc33880.h&gt;</span>

<span class="cp">#include &lt;media/timb_radio.h&gt;</span>
<span class="cp">#include &lt;media/timb_video.h&gt;</span>

<span class="cp">#include &lt;linux/timb_dma.h&gt;</span>

<span class="cp">#include &lt;linux/ks8842.h&gt;</span>

<span class="cp">#include &quot;timberdale.h&quot;</span>

<span class="cp">#define DRIVER_NAME &quot;timberdale&quot;</span>

<span class="k">struct</span> <span class="n">timberdale_device</span> <span class="p">{</span>
	<span class="n">resource_size_t</span>		<span class="n">ctl_mapbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span>   <span class="o">*</span><span class="n">ctl_membase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">major</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">minor</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">config</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">fw</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tsc2007_platform_data</span> <span class="n">timberdale_tsc2007_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="mi">2003</span><span class="p">,</span>
	<span class="p">.</span><span class="n">x_plate_ohms</span> <span class="o">=</span> <span class="mi">100</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">timberdale_i2c_board_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;tsc2007&quot;</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">),</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_tsc2007_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_TIMBERDALE_TSC_INT</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">xiic_i2c_platform_data</span>
<span class="n">timberdale_xiic_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="n">timberdale_i2c_board_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_devices</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_i2c_board_info</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">ocores_i2c_platform_data</span>
<span class="n">timberdale_ocores_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">regstep</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">clock_khz</span> <span class="o">=</span> <span class="mi">62500</span><span class="p">,</span>
	<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="n">timberdale_i2c_board_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_devices</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_i2c_board_info</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">__devinitconst</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">timberdale_xiic_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">XIICOFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">XIICEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_I2C</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_I2C</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">__devinitconst</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">timberdale_ocores_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">OCORESOFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">OCORESEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span> 	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_I2C</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_I2C</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">max7301_platform_data</span> <span class="n">timberdale_max7301_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="mi">200</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">mc33880_platform_data</span> <span class="n">timberdale_mc33880_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="mi">100</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_board_info</span> <span class="n">timberdale_spi_16bit_board_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">modalias</span> <span class="o">=</span> <span class="s">&quot;max7301&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_speed_hz</span> <span class="o">=</span> <span class="mi">26000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chip_select</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">SPI_MODE_0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_max7301_platform_data</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_board_info</span> <span class="n">timberdale_spi_8bit_board_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">modalias</span> <span class="o">=</span> <span class="s">&quot;mc33880&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_speed_hz</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chip_select</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">SPI_MODE_1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_mc33880_platform_data</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">xspi_platform_data</span> <span class="n">timberdale_xspi_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_chipselect</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">little_endian</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="cm">/* bits per word and devices will be filled in runtime depending</span>
<span class="cm">	 * on the HW config</span>
<span class="cm">	 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">__devinitconst</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">timberdale_spi_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span> 	<span class="o">=</span> <span class="n">SPIOFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">SPIEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_SPI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_SPI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">ks8842_platform_data</span>
	<span class="n">timberdale_ks8842_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rx_dma_channel</span> <span class="o">=</span> <span class="n">DMA_ETH_RX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_dma_channel</span> <span class="o">=</span> <span class="n">DMA_ETH_TX</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">__devinitconst</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">timberdale_eth_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">ETHOFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">ETHEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_ETHSW_IF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_ETHSW_IF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">timbgpio_platform_data</span>
	<span class="n">timberdale_gpio_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gpio_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nr_pins</span> <span class="o">=</span> <span class="n">GPIO_NR_PINS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_base</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">__devinitconst</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">timberdale_gpio_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">GPIOOFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">GPIOEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_GPIO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_GPIO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">__devinitconst</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">timberdale_mlogicore_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">MLCOREOFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">MLCOREEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_MLCORE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_MLCORE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_MLCORE_BUF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_MLCORE_BUF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">__devinitconst</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">timberdale_uart_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">UARTOFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">UARTEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_UART</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_UART</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">__devinitconst</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">timberdale_uartlite_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">UARTLITEOFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">UARTLITEEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_UARTLITE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_UARTLITE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">timberdale_adv7180_i2c_board_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Requires jumper JP9 to be off */</span>
	<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;adv7180&quot;</span><span class="p">,</span> <span class="mh">0x42</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_TIMBERDALE_ADV7180</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">timb_video_platform_data</span>
	<span class="n">timberdale_video_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dma_channel</span> <span class="o">=</span> <span class="n">DMA_VIDEO_RX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">i2c_adapter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_adv7180_i2c_board_info</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">__devinitconst</span> <span class="k">struct</span> <span class="n">resource</span>
<span class="n">timberdale_radio_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">RDSOFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">RDSEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_RDS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_RDS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">timberdale_tef6868_i2c_board_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;tef6862&quot;</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">timberdale_saa7706_i2c_board_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;saa7706h&quot;</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">timb_radio_platform_data</span>
	<span class="n">timberdale_radio_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">i2c_adapter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_tef6868_i2c_board_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_saa7706_i2c_board_info</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">__devinitconst</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">timberdale_video_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">LOGIWOFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">LOGIWEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	note that the &quot;frame buffer&quot; is located in DMA area</span>
<span class="cm">	starting at 0x1200000</span>
<span class="cm">	*/</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">timb_dma_platform_data</span> <span class="n">timb_dma_platform_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">nr_channels</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="cm">/* UART RX */</span>
			<span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
			<span class="p">.</span><span class="n">descriptors</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">descriptor_elements</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="cm">/* UART TX */</span>
			<span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
			<span class="p">.</span><span class="n">descriptors</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">descriptor_elements</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="cm">/* MLB RX */</span>
			<span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
			<span class="p">.</span><span class="n">descriptors</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">descriptor_elements</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="cm">/* MLB TX */</span>
			<span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
			<span class="p">.</span><span class="n">descriptors</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">descriptor_elements</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="cm">/* Video RX */</span>
			<span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
			<span class="p">.</span><span class="n">bytes_per_line</span> <span class="o">=</span> <span class="mi">1440</span><span class="p">,</span>
			<span class="p">.</span><span class="n">descriptors</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">descriptor_elements</span> <span class="o">=</span> <span class="mi">16</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="cm">/* Video framedrop */</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="cm">/* SDHCI RX */</span>
			<span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="cm">/* SDHCI TX */</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="cm">/* ETH RX */</span>
			<span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
			<span class="p">.</span><span class="n">descriptors</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">descriptor_elements</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="cm">/* ETH TX */</span>
			<span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
			<span class="p">.</span><span class="n">descriptors</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">descriptor_elements</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">__devinitconst</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">timberdale_dma_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">DMAOFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">DMAEND</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_DMA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_DMA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="n">timberdale_cells_bar0_cfg0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-dma&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_dma_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_dma_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timb_dma_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timb_dma_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-uart&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_uart_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_uart_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;xiic-i2c&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_xiic_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_xiic_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_xiic_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_xiic_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-gpio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_gpio_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_gpio_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_gpio_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_gpio_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-video&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_video_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_video_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_video_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_video_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-radio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_radio_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_radio_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_radio_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_radio_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;xilinx_spi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_spi_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_spi_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_xspi_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_xspi_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ks8842&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_eth_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_eth_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_ks8842_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_ks8842_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="n">timberdale_cells_bar0_cfg1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-dma&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_dma_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_dma_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timb_dma_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timb_dma_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-uart&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_uart_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_uart_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;uartlite&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_uartlite_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_uartlite_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;xiic-i2c&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_xiic_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_xiic_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_xiic_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_xiic_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-gpio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_gpio_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_gpio_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_gpio_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_gpio_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-mlogicore&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_mlogicore_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_mlogicore_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-video&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_video_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_video_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_video_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_video_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-radio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_radio_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_radio_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_radio_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_radio_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;xilinx_spi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_spi_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_spi_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_xspi_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_xspi_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ks8842&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_eth_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_eth_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_ks8842_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_ks8842_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="n">timberdale_cells_bar0_cfg2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-dma&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_dma_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_dma_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timb_dma_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timb_dma_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-uart&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_uart_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_uart_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;xiic-i2c&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_xiic_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_xiic_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_xiic_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_xiic_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-gpio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_gpio_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_gpio_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_gpio_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_gpio_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-video&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_video_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_video_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_video_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_video_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-radio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_radio_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_radio_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_radio_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_radio_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;xilinx_spi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_spi_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_spi_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_xspi_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_xspi_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="n">timberdale_cells_bar0_cfg3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-dma&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_dma_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_dma_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timb_dma_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timb_dma_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-uart&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_uart_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_uart_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ocores-i2c&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_ocores_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_ocores_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_ocores_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_ocores_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-gpio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_gpio_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_gpio_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_gpio_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_gpio_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-video&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_video_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_video_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_video_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_video_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timb-radio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_radio_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_radio_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_radio_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_radio_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;xilinx_spi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_spi_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_spi_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_xspi_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_xspi_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ks8842&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_eth_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_eth_resources</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">timberdale_ks8842_platform_data</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pdata_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">timberdale_ks8842_platform_data</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">__devinitconst</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">timberdale_sdhc_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* located in bar 1 and bar 2 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">SDHC0OFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">SDHC0END</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_SDHC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">IRQ_TIMBERDALE_SDHC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="n">timberdale_cells_bar1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sdhci&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_sdhc_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_sdhc_resources</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="n">timberdale_cells_bar2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sdhci&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_sdhc_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">timberdale_sdhc_resources</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_fw_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">timberdale_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">major</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">minor</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">fw_ver</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_fw_ver</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/*--------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">timb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timberdale_device</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">mapbase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msix_entry</span> <span class="o">*</span><span class="n">msix_entries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ip_setup</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_enable</span><span class="p">;</span>

	<span class="n">mapbase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mapbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create a resource for the PCI master register */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctl_mapbase</span> <span class="o">=</span> <span class="n">mapbase</span> <span class="o">+</span> <span class="n">CHIPCTLOFFSET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctl_mapbase</span><span class="p">,</span> <span class="n">CHIPCTLSIZE</span><span class="p">,</span> <span class="s">&quot;timb-ctl&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to request ctl mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_request</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctl_membase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctl_mapbase</span><span class="p">,</span> <span class="n">CHIPCTLSIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctl_membase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ioremap failed for ctl mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_ioremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read the HW config */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">major</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctl_membase</span> <span class="o">+</span> <span class="n">TIMB_REV_MAJOR</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctl_membase</span> <span class="o">+</span> <span class="n">TIMB_REV_MINOR</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctl_membase</span> <span class="o">+</span> <span class="n">TIMB_HW_CONFIG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">major</span> <span class="o">&gt;</span> <span class="n">TIMB_SUPPORTED_MAJOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The driver supports an older &quot;</span>
			<span class="s">&quot;version of the FPGA, please update the driver to &quot;</span>
			<span class="s">&quot;support %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">major</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_config</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">major</span> <span class="o">&lt;</span> <span class="n">TIMB_SUPPORTED_MAJOR</span> <span class="o">||</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">minor</span> <span class="o">&lt;</span> <span class="n">TIMB_REQUIRED_MINOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;The FPGA image is too old (%d.%d), &quot;</span>
			<span class="s">&quot;please upgrade the FPGA to at least: %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">major</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">minor</span><span class="p">,</span>
			<span class="n">TIMB_SUPPORTED_MAJOR</span><span class="p">,</span> <span class="n">TIMB_REQUIRED_MINOR</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_config</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msix_entries</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">TIMBERDALE_NR_IRQS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">msix_entries</span><span class="p">),</span>
		<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msix_entries</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_config</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TIMBERDALE_NR_IRQS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">msix_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_msix</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msix_entries</span><span class="p">,</span> <span class="n">TIMBERDALE_NR_IRQS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;MSI-X init failed: %d, expected entries: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">err</span><span class="p">,</span> <span class="n">TIMBERDALE_NR_IRQS</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_msix</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_fw_ver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_create_file</span><span class="p">;</span>

	<span class="cm">/* Reset all FPGA PLB peripherals */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctl_membase</span> <span class="o">+</span> <span class="n">TIMB_SW_RST</span><span class="p">);</span>

	<span class="cm">/* update IRQ offsets in I2C board info */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_i2c_board_info</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">timberdale_i2c_board_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span>
			<span class="n">msix_entries</span><span class="p">[</span><span class="n">timberdale_i2c_board_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="p">].</span><span class="n">vector</span><span class="p">;</span>

	<span class="cm">/* Update the SPI configuration depending on the HW (8 or 16 bit) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TIMB_HW_CONFIG_SPI_8BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timberdale_xspi_platform_data</span><span class="p">.</span><span class="n">bits_per_word</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">timberdale_xspi_platform_data</span><span class="p">.</span><span class="n">devices</span> <span class="o">=</span>
			<span class="n">timberdale_spi_8bit_board_info</span><span class="p">;</span>
		<span class="n">timberdale_xspi_platform_data</span><span class="p">.</span><span class="n">num_devices</span> <span class="o">=</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_spi_8bit_board_info</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">timberdale_xspi_platform_data</span><span class="p">.</span><span class="n">bits_per_word</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">timberdale_xspi_platform_data</span><span class="p">.</span><span class="n">devices</span> <span class="o">=</span>
			<span class="n">timberdale_spi_16bit_board_info</span><span class="p">;</span>
		<span class="n">timberdale_xspi_platform_data</span><span class="p">.</span><span class="n">num_devices</span> <span class="o">=</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_spi_16bit_board_info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ip_setup</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TIMB_HW_VER_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ip_setup</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TIMB_HW_VER0</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">mfd_add_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">timberdale_cells_bar0_cfg0</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_cells_bar0_cfg0</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">msix_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIMB_HW_VER1</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">mfd_add_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">timberdale_cells_bar0_cfg1</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_cells_bar0_cfg1</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">msix_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIMB_HW_VER2</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">mfd_add_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">timberdale_cells_bar0_cfg2</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_cells_bar0_cfg2</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">msix_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIMB_HW_VER3</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">mfd_add_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			<span class="n">timberdale_cells_bar0_cfg3</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_cells_bar0_cfg3</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">msix_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Uknown IP setup: %d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">major</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">minor</span><span class="p">,</span> <span class="n">ip_setup</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_mfd</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mfd_add_devices failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_mfd</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mfd_add_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">timberdale_cells_bar1</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_cells_bar1</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">msix_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mfd_add_devices failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_mfd2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* only version 0 and 3 have the iNand routed to SDHCI */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TIMB_HW_VER_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TIMB_HW_VER0</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">TIMB_HW_VER_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TIMB_HW_VER3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mfd_add_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">timberdale_cells_bar2</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">timberdale_cells_bar2</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">msix_entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vector</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mfd_add_devices failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_mfd2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">msix_entries</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Found Timberdale Card. Rev: %d.%d, HW config: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">major</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">minor</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">config</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_mfd2:</span>
	<span class="n">mfd_remove_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_mfd:</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_fw_ver</span><span class="p">);</span>
<span class="nl">err_create_file:</span>
	<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_msix:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">msix_entries</span><span class="p">);</span>
<span class="nl">err_config:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctl_membase</span><span class="p">);</span>
<span class="nl">err_ioremap:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctl_mapbase</span><span class="p">,</span> <span class="n">CHIPCTLSIZE</span><span class="p">);</span>
<span class="nl">err_request:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">err_start:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_enable:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">timb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timberdale_device</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mfd_remove_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_fw_ver</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctl_membase</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctl_mapbase</span><span class="p">,</span> <span class="n">CHIPCTLSIZE</span><span class="p">);</span>

	<span class="n">pci_disable_msix</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">timberdale_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_TIMB</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TIMB</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">timberdale_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">timberdale_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">timberdale_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">timb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">timb_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">timberdale_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timberdale_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;Failed to register PCI driver for %s device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">timberdale_pci_driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Driver for %s has been successfully registered.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">timberdale_pci_driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">timberdale_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timberdale_pci_driver</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Driver for %s has been successfully unregistered.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">timberdale_pci_driver</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">timberdale_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">timberdale_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mocean Laboratories &lt;info@mocean-labs.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
