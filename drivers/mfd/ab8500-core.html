<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mfd › ab8500-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ab8500-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) ST-Ericsson SA 2010</span>
<span class="cm"> *</span>
<span class="cm"> * License Terms: GNU General Public License v2</span>
<span class="cm"> * Author: Srinidhi Kasagar &lt;srinidhi.kasagar@stericsson.com&gt;</span>
<span class="cm"> * Author: Rabin Vincent &lt;rabin.vincent@stericsson.com&gt;</span>
<span class="cm"> * Author: Mattias Wallin &lt;mattias.wallin@stericsson.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/core.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500/ab8500.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/dbx500-prcmu.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/ab8500.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt register offsets</span>
<span class="cm"> * Bank : 0x0E</span>
<span class="cm"> */</span>
<span class="cp">#define AB8500_IT_SOURCE1_REG		0x00</span>
<span class="cp">#define AB8500_IT_SOURCE2_REG		0x01</span>
<span class="cp">#define AB8500_IT_SOURCE3_REG		0x02</span>
<span class="cp">#define AB8500_IT_SOURCE4_REG		0x03</span>
<span class="cp">#define AB8500_IT_SOURCE5_REG		0x04</span>
<span class="cp">#define AB8500_IT_SOURCE6_REG		0x05</span>
<span class="cp">#define AB8500_IT_SOURCE7_REG		0x06</span>
<span class="cp">#define AB8500_IT_SOURCE8_REG		0x07</span>
<span class="cp">#define AB9540_IT_SOURCE13_REG		0x0C</span>
<span class="cp">#define AB8500_IT_SOURCE19_REG		0x12</span>
<span class="cp">#define AB8500_IT_SOURCE20_REG		0x13</span>
<span class="cp">#define AB8500_IT_SOURCE21_REG		0x14</span>
<span class="cp">#define AB8500_IT_SOURCE22_REG		0x15</span>
<span class="cp">#define AB8500_IT_SOURCE23_REG		0x16</span>
<span class="cp">#define AB8500_IT_SOURCE24_REG		0x17</span>

<span class="cm">/*</span>
<span class="cm"> * latch registers</span>
<span class="cm"> */</span>
<span class="cp">#define AB8500_IT_LATCH1_REG		0x20</span>
<span class="cp">#define AB8500_IT_LATCH2_REG		0x21</span>
<span class="cp">#define AB8500_IT_LATCH3_REG		0x22</span>
<span class="cp">#define AB8500_IT_LATCH4_REG		0x23</span>
<span class="cp">#define AB8500_IT_LATCH5_REG		0x24</span>
<span class="cp">#define AB8500_IT_LATCH6_REG		0x25</span>
<span class="cp">#define AB8500_IT_LATCH7_REG		0x26</span>
<span class="cp">#define AB8500_IT_LATCH8_REG		0x27</span>
<span class="cp">#define AB8500_IT_LATCH9_REG		0x28</span>
<span class="cp">#define AB8500_IT_LATCH10_REG		0x29</span>
<span class="cp">#define AB8500_IT_LATCH12_REG		0x2B</span>
<span class="cp">#define AB9540_IT_LATCH13_REG		0x2C</span>
<span class="cp">#define AB8500_IT_LATCH19_REG		0x32</span>
<span class="cp">#define AB8500_IT_LATCH20_REG		0x33</span>
<span class="cp">#define AB8500_IT_LATCH21_REG		0x34</span>
<span class="cp">#define AB8500_IT_LATCH22_REG		0x35</span>
<span class="cp">#define AB8500_IT_LATCH23_REG		0x36</span>
<span class="cp">#define AB8500_IT_LATCH24_REG		0x37</span>

<span class="cm">/*</span>
<span class="cm"> * mask registers</span>
<span class="cm"> */</span>

<span class="cp">#define AB8500_IT_MASK1_REG		0x40</span>
<span class="cp">#define AB8500_IT_MASK2_REG		0x41</span>
<span class="cp">#define AB8500_IT_MASK3_REG		0x42</span>
<span class="cp">#define AB8500_IT_MASK4_REG		0x43</span>
<span class="cp">#define AB8500_IT_MASK5_REG		0x44</span>
<span class="cp">#define AB8500_IT_MASK6_REG		0x45</span>
<span class="cp">#define AB8500_IT_MASK7_REG		0x46</span>
<span class="cp">#define AB8500_IT_MASK8_REG		0x47</span>
<span class="cp">#define AB8500_IT_MASK9_REG		0x48</span>
<span class="cp">#define AB8500_IT_MASK10_REG		0x49</span>
<span class="cp">#define AB8500_IT_MASK11_REG		0x4A</span>
<span class="cp">#define AB8500_IT_MASK12_REG		0x4B</span>
<span class="cp">#define AB8500_IT_MASK13_REG		0x4C</span>
<span class="cp">#define AB8500_IT_MASK14_REG		0x4D</span>
<span class="cp">#define AB8500_IT_MASK15_REG		0x4E</span>
<span class="cp">#define AB8500_IT_MASK16_REG		0x4F</span>
<span class="cp">#define AB8500_IT_MASK17_REG		0x50</span>
<span class="cp">#define AB8500_IT_MASK18_REG		0x51</span>
<span class="cp">#define AB8500_IT_MASK19_REG		0x52</span>
<span class="cp">#define AB8500_IT_MASK20_REG		0x53</span>
<span class="cp">#define AB8500_IT_MASK21_REG		0x54</span>
<span class="cp">#define AB8500_IT_MASK22_REG		0x55</span>
<span class="cp">#define AB8500_IT_MASK23_REG		0x56</span>
<span class="cp">#define AB8500_IT_MASK24_REG		0x57</span>

<span class="cm">/*</span>
<span class="cm"> * latch hierarchy registers</span>
<span class="cm"> */</span>
<span class="cp">#define AB8500_IT_LATCHHIER1_REG	0x60</span>
<span class="cp">#define AB8500_IT_LATCHHIER2_REG	0x61</span>
<span class="cp">#define AB8500_IT_LATCHHIER3_REG	0x62</span>

<span class="cp">#define AB8500_IT_LATCHHIER_NUM		3</span>

<span class="cp">#define AB8500_REV_REG			0x80</span>
<span class="cp">#define AB8500_IC_NAME_REG		0x82</span>
<span class="cp">#define AB8500_SWITCH_OFF_STATUS	0x00</span>

<span class="cp">#define AB8500_TURN_ON_STATUS		0x00</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">no_bm</span><span class="p">;</span> <span class="cm">/* No battery management */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">no_bm</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>

<span class="cp">#define AB9540_MODEM_CTRL2_REG			0x23</span>
<span class="cp">#define AB9540_MODEM_CTRL2_SWDBBRSTN_BIT	BIT(2)</span>

<span class="cm">/*</span>
<span class="cm"> * Map interrupt numbers to the LATCH and MASK register offsets, Interrupt</span>
<span class="cm"> * numbers are indexed into this array with (num / 8). The interupts are</span>
<span class="cm"> * defined in linux/mfd/ab8500.h</span>
<span class="cm"> *</span>
<span class="cm"> * This is one off from the register names, i.e. AB8500_IT_MASK1_REG is at</span>
<span class="cm"> * offset 0.</span>
<span class="cm"> */</span>
<span class="cm">/* AB8500 support */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ab8500_irq_regoffset</span><span class="p">[</span><span class="n">AB8500_NUM_IRQ_REGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* AB9540 support */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ab9540_irq_regoffset</span><span class="p">[</span><span class="n">AB9540_NUM_IRQ_REGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ab8500_version_str</span><span class="p">[][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">AB8500_VERSION_AB8500</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;AB8500&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">AB8500_VERSION_AB8505</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;AB8505&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">AB8500_VERSION_AB9540</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;AB9540&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">AB8500_VERSION_AB8540</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;AB8540&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_i2c_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">prcmu_abb_write</span><span class="p">((</span><span class="n">u8</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;prcmu i2c error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_i2c_write_masked</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">prcmu_abb_write_masked</span><span class="p">((</span><span class="n">u8</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;prcmu i2c error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_i2c_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">prcmu_abb_read</span><span class="p">((</span><span class="n">u8</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;prcmu i2c error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_get_chip_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ab8500</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ab8500</span> <span class="o">?</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_register_interruptible</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bank</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Put the u8 bank and u8 register together into a an u16.</span>
<span class="cm">	 * The bank on higher 8 bits and register in lower 8 bits.</span>
<span class="cm">	 * */</span>
	<span class="n">u16</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">bank</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wr: addr %#x &lt;= %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to write reg %#x: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">addr</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_set_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bank</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">transfer_ongoing</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_register_interruptible</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">transfer_ongoing</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_register_interruptible</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bank</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/* put the u8 bank and u8 reg together into a an u16.</span>
<span class="cm">	 * bank on higher 8 bits and reg in lower */</span>
	<span class="n">u16</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">bank</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to read reg %#x: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">addr</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rd: addr %#x =&gt; data %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_get_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bank</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">transfer_ongoing</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_register_interruptible</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">transfer_ongoing</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mask_and_set_register_interruptible</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bank</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bitmask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bitvalues</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/* put the u8 bank and u8 reg together into a an u16.</span>
<span class="cm">	 * bank on higher 8 bits and reg in lower */</span>
	<span class="n">u16</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">bank</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">write_masked</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to read reg %#x: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">addr</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">ret</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">bitmask</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bitmask</span> <span class="o">&amp;</span> <span class="n">bitvalues</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to write reg %#x: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">addr</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mask: addr %#x =&gt; data %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
			<span class="n">data</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">write_masked</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">bitmask</span><span class="p">,</span> <span class="n">bitvalues</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to modify reg %#x: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_mask_and_set_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">bank</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bitmask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bitvalues</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">transfer_ongoing</span><span class="p">);</span>
	<span class="n">ret</span><span class="o">=</span> <span class="n">mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
						 <span class="n">bitmask</span><span class="p">,</span> <span class="n">bitvalues</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">transfer_ongoing</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">abx500_ops</span> <span class="n">ab8500_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_chip_id</span> <span class="o">=</span> <span class="n">ab8500_get_chip_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_register</span> <span class="o">=</span> <span class="n">ab8500_get_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_register</span> <span class="o">=</span> <span class="n">ab8500_set_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_register_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_register_page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask_and_set_register</span> <span class="o">=</span> <span class="n">ab8500_mask_and_set_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">event_registers_startup_state_get</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">startup_irq_enabled</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_irq_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">transfer_ongoing</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_irq_sync_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">old</span> <span class="o">=</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">oldmask</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">new</span> <span class="o">=</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">==</span> <span class="n">old</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Interrupt register 12 doesn&#39;t exist prior to AB8500 version</span>
<span class="cm">		 * 2.0</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_reg_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">11</span> <span class="o">&amp;&amp;</span>
			<span class="n">is_ab8500_1p1_or_earlier</span><span class="p">(</span><span class="n">ab8500</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">oldmask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">AB8500_IT_MASK1_REG</span> <span class="o">+</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_reg_offset</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">set_register_interruptible</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">AB8500_INTERRUPT</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">transfer_ongoing</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_irq_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">%</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_irq_unmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">%</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">ab8500_irq_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;ab8500&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_bus_lock</span>		<span class="o">=</span> <span class="n">ab8500_irq_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_bus_sync_unlock</span>	<span class="o">=</span> <span class="n">ab8500_irq_sync_unlock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>		<span class="o">=</span> <span class="n">ab8500_irq_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_disable</span>		<span class="o">=</span> <span class="n">ab8500_irq_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>		<span class="o">=</span> <span class="n">ab8500_irq_unmask</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_handle_hierarchical_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">latch_offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">latch_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">int_bit</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">latch_val</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">int_bit</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">latch_val</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_reg_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">latch_offset</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Register offset 0x%2x not declared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">latch_offset</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">int_bit</span><span class="p">;</span>
		<span class="n">latch_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">int_bit</span><span class="p">);</span>

		<span class="n">handle_nested_irq</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">+</span> <span class="n">line</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">latch_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_handle_hierarchical_latch</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">hier_offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hier_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">latch_bit</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">latch_offset</span><span class="p">,</span> <span class="n">latch_val</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">latch_bit</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">hier_val</span><span class="p">);</span>
		<span class="n">latch_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">hier_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">latch_bit</span><span class="p">;</span>

		<span class="cm">/* Fix inconsistent ITFromLatch25 bit mapping... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">latch_offset</span> <span class="o">==</span> <span class="mi">17</span><span class="p">))</span>
			<span class="n">latch_offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">get_register_interruptible</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span>
				<span class="n">AB8500_INTERRUPT</span><span class="p">,</span>
				<span class="n">AB8500_IT_LATCH1_REG</span> <span class="o">+</span> <span class="n">latch_offset</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">latch_val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">latch_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">discard</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">ab8500_handle_hierarchical_line</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span>
				<span class="n">latch_offset</span><span class="p">,</span> <span class="n">latch_val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="nl">discard:</span>
		<span class="n">hier_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">latch_bit</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">hier_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_hierarchical_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*  Hierarchical interrupt version */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AB8500_IT_LATCHHIER_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">hier_val</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">get_register_interruptible</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">AB8500_INTERRUPT</span><span class="p">,</span>
			<span class="n">AB8500_IT_LATCHHIER1_REG</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hier_val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hier_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">ab8500_handle_hierarchical_latch</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">hier_val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_vdbg</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">transfer_ongoing</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">regoffset</span> <span class="o">=</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_reg_offset</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Interrupt register 12 doesn&#39;t exist prior to AB8500 version</span>
<span class="cm">		 * 2.0</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regoffset</span> <span class="o">==</span> <span class="mi">11</span> <span class="o">&amp;&amp;</span> <span class="n">is_ab8500_1p1_or_earlier</span><span class="p">(</span><span class="n">ab8500</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">get_register_interruptible</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">AB8500_INTERRUPT</span><span class="p">,</span>
			<span class="n">AB8500_IT_LATCH1_REG</span> <span class="o">+</span> <span class="n">regoffset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">bit</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">line</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">bit</span><span class="p">;</span>

			<span class="n">handle_nested_irq</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">+</span> <span class="n">line</span><span class="p">);</span>
			<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">transfer_ongoing</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_irq_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_irqs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ab9540</span><span class="p">(</span><span class="n">ab8500</span><span class="p">))</span>
		<span class="n">num_irqs</span> <span class="o">=</span> <span class="n">AB9540_NR_IRQS</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_ab8505</span><span class="p">(</span><span class="n">ab8500</span><span class="p">))</span>
		<span class="n">num_irqs</span> <span class="o">=</span> <span class="n">AB8505_NR_IRQS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">num_irqs</span> <span class="o">=</span> <span class="n">AB8500_NR_IRQS</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">irq</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span> <span class="n">irq</span> <span class="o">&lt;</span> <span class="n">base</span> <span class="o">+</span> <span class="n">num_irqs</span><span class="p">;</span> <span class="n">irq</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_set_chip_data</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">ab8500</span><span class="p">);</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ab8500_irq_chip</span><span class="p">,</span>
					 <span class="n">handle_simple_irq</span><span class="p">);</span>
		<span class="n">irq_set_nested_thread</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ARM</span>
		<span class="n">set_irq_flags</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQF_VALID</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">irq_set_noprobe</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_irq_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_irqs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ab9540</span><span class="p">(</span><span class="n">ab8500</span><span class="p">))</span>
		<span class="n">num_irqs</span> <span class="o">=</span> <span class="n">AB9540_NR_IRQS</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_ab8505</span><span class="p">(</span><span class="n">ab8500</span><span class="p">))</span>
		<span class="n">num_irqs</span> <span class="o">=</span> <span class="n">AB8505_NR_IRQS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">num_irqs</span> <span class="o">=</span> <span class="n">AB8500_NR_IRQS</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">irq</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span> <span class="n">irq</span> <span class="o">&lt;</span> <span class="n">base</span> <span class="o">+</span> <span class="n">num_irqs</span><span class="p">;</span> <span class="n">irq</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_ARM</span>
		<span class="n">set_irq_flags</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">irq_set_chip_data</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ab8500_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">transfer_ongoing</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* AB8500 GPIO Resources */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">__devinitdata</span> <span class="n">ab8500_gpio_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;GPIO_INT6&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AB8500_INT_GPIO6R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AB8500_INT_GPIO41F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* AB9540 GPIO Resources */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">__devinitdata</span> <span class="n">ab9540_gpio_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;GPIO_INT6&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AB8500_INT_GPIO6R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AB8500_INT_GPIO41F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;GPIO_INT14&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AB9540_INT_GPIO50R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AB9540_INT_GPIO54R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;GPIO_INT15&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AB9540_INT_GPIO50F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AB9540_INT_GPIO54F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">__devinitdata</span> <span class="n">ab8500_gpadc_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;HW_CONV_END&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AB8500_INT_GP_HW_ADC_CONV_END</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AB8500_INT_GP_HW_ADC_CONV_END</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;SW_CONV_END&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AB8500_INT_GP_SW_ADC_CONV_END</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AB8500_INT_GP_SW_ADC_CONV_END</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">__devinitdata</span> <span class="n">ab8500_rtc_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;60S&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AB8500_INT_RTC_60S</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AB8500_INT_RTC_60S</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ALARM&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AB8500_INT_RTC_ALARM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AB8500_INT_RTC_ALARM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">__devinitdata</span> <span class="n">ab8500_poweronkey_db_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ONKEY_DBF&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AB8500_INT_PON_KEY1DB_F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AB8500_INT_PON_KEY1DB_F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ONKEY_DBR&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AB8500_INT_PON_KEY1DB_R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AB8500_INT_PON_KEY1DB_R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">__devinitdata</span> <span class="n">ab8500_av_acc_detect_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	       <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ACC_DETECT_1DB_F&quot;</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_ACC_DETECT_1DB_F</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_ACC_DETECT_1DB_F</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	       <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ACC_DETECT_1DB_R&quot;</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_ACC_DETECT_1DB_R</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_ACC_DETECT_1DB_R</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	       <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ACC_DETECT_21DB_F&quot;</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_ACC_DETECT_21DB_F</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_ACC_DETECT_21DB_F</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	       <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ACC_DETECT_21DB_R&quot;</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_ACC_DETECT_21DB_R</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_ACC_DETECT_21DB_R</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	       <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ACC_DETECT_22DB_F&quot;</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_ACC_DETECT_22DB_F</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_ACC_DETECT_22DB_F</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	       <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ACC_DETECT_22DB_R&quot;</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_ACC_DETECT_22DB_R</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_ACC_DETECT_22DB_R</span><span class="p">,</span>
	       <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">__devinitdata</span> <span class="n">ab8500_charger_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MAIN_CH_UNPLUG_DET&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_MAIN_CH_UNPLUG_DET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_MAIN_CH_UNPLUG_DET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MAIN_CHARGE_PLUG_DET&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_MAIN_CH_PLUG_DET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_MAIN_CH_PLUG_DET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VBUS_DET_R&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_VBUS_DET_R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_VBUS_DET_R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VBUS_DET_F&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_VBUS_DET_F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_VBUS_DET_F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;USB_LINK_STATUS&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_USB_LINK_STATUS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_USB_LINK_STATUS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VBUS_OVV&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_VBUS_OVV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_VBUS_OVV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;USB_CH_TH_PROT_R&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_USB_CH_TH_PROT_R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_USB_CH_TH_PROT_R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;USB_CH_TH_PROT_F&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_USB_CH_TH_PROT_F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_USB_CH_TH_PROT_F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MAIN_EXT_CH_NOT_OK&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_MAIN_EXT_CH_NOT_OK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_MAIN_EXT_CH_NOT_OK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MAIN_CH_TH_PROT_R&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_MAIN_CH_TH_PROT_R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_MAIN_CH_TH_PROT_R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MAIN_CH_TH_PROT_F&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_MAIN_CH_TH_PROT_F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_MAIN_CH_TH_PROT_F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;USB_CHARGER_NOT_OKR&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_USB_CHARGER_NOT_OKR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_USB_CHARGER_NOT_OKR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CH_WD_EXP&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_CH_WD_EXP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_CH_WD_EXP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">__devinitdata</span> <span class="n">ab8500_btemp_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;BAT_CTRL_INDB&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_BAT_CTRL_INDB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_BAT_CTRL_INDB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;BTEMP_LOW&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_BTEMP_LOW</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_BTEMP_LOW</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;BTEMP_HIGH&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_BTEMP_HIGH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_BTEMP_HIGH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;BTEMP_LOW_MEDIUM&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_BTEMP_LOW_MEDIUM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_BTEMP_LOW_MEDIUM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;BTEMP_MEDIUM_HIGH&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_BTEMP_MEDIUM_HIGH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_BTEMP_MEDIUM_HIGH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">__devinitdata</span> <span class="n">ab8500_fg_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;NCONV_ACCU&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_CCN_CONV_ACC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_CCN_CONV_ACC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;BATT_OVV&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_BATT_OVV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_BATT_OVV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;LOW_BAT_F&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_LOW_BAT_F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_LOW_BAT_F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;LOW_BAT_R&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_LOW_BAT_R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_LOW_BAT_R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CC_INT_CALIB&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_CC_INT_CALIB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_CC_INT_CALIB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;CCEOC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_CCEOC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_CCEOC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">__devinitdata</span> <span class="n">ab8500_chargalg_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{};</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">__devinitdata</span> <span class="n">ab8500_debug_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;IRQ_FIRST&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AB8500_INT_MAIN_EXT_CH_NOT_OK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AB8500_INT_MAIN_EXT_CH_NOT_OK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;IRQ_LAST&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">AB8500_INT_XTAL32K_KO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="n">AB8500_INT_XTAL32K_KO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">__devinitdata</span> <span class="n">ab8500_usb_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ID_WAKEUP_R&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_ID_WAKEUP_R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_ID_WAKEUP_R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ID_WAKEUP_F&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_ID_WAKEUP_F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_ID_WAKEUP_F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VBUS_DET_F&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_VBUS_DET_F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_VBUS_DET_F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VBUS_DET_R&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_VBUS_DET_R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_VBUS_DET_R</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;USB_LINK_STATUS&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_USB_LINK_STATUS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_USB_LINK_STATUS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;USB_ADP_PROBE_PLUG&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_ADP_PROBE_PLUG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_ADP_PROBE_PLUG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;USB_ADP_PROBE_UNPLUG&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_ADP_PROBE_UNPLUG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">AB8500_INT_ADP_PROBE_UNPLUG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">__devinitdata</span> <span class="n">ab8505_iddet_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;KeyDeglitch&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8505_INT_KEYDEGLITCH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>   <span class="o">=</span> <span class="n">AB8505_INT_KEYDEGLITCH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;KP&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8505_INT_KP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>   <span class="o">=</span> <span class="n">AB8505_INT_KP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;IKP&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8505_INT_IKP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>   <span class="o">=</span> <span class="n">AB8505_INT_IKP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;IKR&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8505_INT_IKR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>   <span class="o">=</span> <span class="n">AB8505_INT_IKR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;KeyStuck&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8505_INT_KEYSTUCK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>   <span class="o">=</span> <span class="n">AB8505_INT_KEYSTUCK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">__devinitdata</span> <span class="n">ab8500_temp_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;AB8500_TEMP_WARM&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">AB8500_INT_TEMP_WARM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>   <span class="o">=</span> <span class="n">AB8500_INT_TEMP_WARM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="n">__devinitdata</span> <span class="n">abx500_common_devs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-debug&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_debug_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ab8500_debug_resources</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-sysctrl&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-regulator&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-gpadc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_gpadc_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ab8500_gpadc_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-rtc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_rtc_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ab8500_rtc_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-acc-det&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_av_acc_detect_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ab8500_av_acc_detect_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-poweron-key&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_poweronkey_db_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ab8500_poweronkey_db_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-pwm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-pwm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-pwm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-leds&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-denc&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-temp&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_temp_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ab8500_temp_resources</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="n">__devinitdata</span> <span class="n">ab8500_bm_devs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-charger&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_charger_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ab8500_charger_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-btemp&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_btemp_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ab8500_btemp_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-fg&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_fg_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ab8500_fg_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-chargalg&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_chargalg_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ab8500_chargalg_resources</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="n">__devinitdata</span> <span class="n">ab8500_devs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-gpio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_gpio_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ab8500_gpio_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-usb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_usb_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ab8500_usb_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-codec&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="n">__devinitdata</span> <span class="n">ab9540_devs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-gpio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab9540_gpio_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ab9540_gpio_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab9540-usb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_usb_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ab8500_usb_resources</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab9540-codec&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Device list common to ab9540 and ab8505 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mfd_cell</span> <span class="n">__devinitdata</span> <span class="n">ab9540_ab8505_devs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab-iddet&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8505_iddet_resources</span><span class="p">),</span>
		<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ab8505_iddet_resources</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_chip_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">;</span>

	<span class="n">ab8500</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ab8500</span> <span class="o">?</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ab8500 has switched off due to (SWITCH_OFF_STATUS):</span>
<span class="cm"> * 0x01 Swoff bit programming</span>
<span class="cm"> * 0x02 Thermal protection activation</span>
<span class="cm"> * 0x04 Vbat lower then BattOk falling threshold</span>
<span class="cm"> * 0x08 Watchdog expired</span>
<span class="cm"> * 0x10 Non presence of 32kHz clock</span>
<span class="cm"> * 0x20 Battery level lower than power on reset threshold</span>
<span class="cm"> * 0x40 Power on key 1 pressed longer than 10 seconds</span>
<span class="cm"> * 0x80 DB8500 thermal shutdown</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_switch_off_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">;</span>

	<span class="n">ab8500</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_register_interruptible</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">AB8500_RTC</span><span class="p">,</span>
		<span class="n">AB8500_SWITCH_OFF_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ab8500 has turned on due to (TURN_ON_STATUS):</span>
<span class="cm"> * 0x01 PORnVbat</span>
<span class="cm"> * 0x02 PonKey1dbF</span>
<span class="cm"> * 0x04 PonKey2dbF</span>
<span class="cm"> * 0x08 RTCAlarm</span>
<span class="cm"> * 0x10 MainChDet</span>
<span class="cm"> * 0x20 VbusDet</span>
<span class="cm"> * 0x40 UsbIDDetect</span>
<span class="cm"> * 0x80 Reserved</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_turn_on_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">;</span>

	<span class="n">ab8500</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_register_interruptible</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">AB8500_SYS_CTRL1_BLOCK</span><span class="p">,</span>
		<span class="n">AB8500_TURN_ON_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_ab9540_dbbrstn</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">ab8500</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_register_interruptible</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">AB8500_REGU_CTRL2</span><span class="p">,</span>
		<span class="n">AB9540_MODEM_CTRL2_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">AB9540_MODEM_CTRL2_SWDBBRSTN_BIT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_ab9540_dbbrstn</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bitvalues</span><span class="p">;</span>

	<span class="n">ab8500</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;0&#39;</span>:
			<span class="n">bitvalues</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;1&#39;</span>:
			<span class="n">bitvalues</span> <span class="o">=</span> <span class="n">AB9540_MODEM_CTRL2_SWDBBRSTN_BIT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span>
			<span class="n">AB8500_REGU_CTRL2</span><span class="p">,</span> <span class="n">AB9540_MODEM_CTRL2_REG</span><span class="p">,</span>
			<span class="n">AB9540_MODEM_CTRL2_SWDBBRSTN_BIT</span><span class="p">,</span> <span class="n">bitvalues</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Failed to set DBBRSTN %c, err %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">chip_id</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_chip_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">switch_off_status</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_switch_off_status</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">turn_on_status</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_turn_on_status</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">dbbrstn</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
			<span class="n">show_ab9540_dbbrstn</span><span class="p">,</span> <span class="n">store_ab9540_dbbrstn</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">ab8500_sysfs_entries</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_chip_id</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_switch_off_status</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_turn_on_status</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">ab9540_sysfs_entries</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_chip_id</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_switch_off_status</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_turn_on_status</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_dbbrstn</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">ab8500_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span>	<span class="o">=</span> <span class="n">ab8500_sysfs_entries</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">ab9540_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span>	<span class="o">=</span> <span class="n">ab9540_sysfs_entries</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">ab8500_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;stericsson,ab8500&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">AB8500_VERSION_AB8500</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ab8500_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_platform_data</span> <span class="o">*</span><span class="n">plat</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="o">*</span><span class="n">platid</span> <span class="o">=</span> <span class="n">platform_get_device_id</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">ab8500_version</span> <span class="n">version</span> <span class="o">=</span> <span class="n">AB8500_VERSION_UNDEFINED</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">resource</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">ab8500</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab8500</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plat</span><span class="p">)</span>
		<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">=</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">of_property_read_u32</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;stericsson,irq-base&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t find irq-base</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_ab8500</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">resource</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resource</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_ab8500</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">resource</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">ab8500_i2c_read</span><span class="p">;</span>
	<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">ab8500_i2c_write</span><span class="p">;</span>
	<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">write_masked</span> <span class="o">=</span> <span class="n">ab8500_i2c_write_masked</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">transfer_ongoing</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ab8500</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platid</span><span class="p">)</span>
		<span class="n">version</span> <span class="o">=</span> <span class="n">platid</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="p">)</span>
		<span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span>
			<span class="n">of_match_device</span><span class="p">(</span><span class="n">ab8500_match</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">!=</span> <span class="n">AB8500_VERSION_UNDEFINED</span><span class="p">)</span>
		<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_register_interruptible</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">AB8500_MISC</span><span class="p">,</span>
			<span class="n">AB8500_IC_NAME_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_ab8500</span><span class="p">;</span>

		<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_register_interruptible</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">AB8500_MISC</span><span class="p">,</span>
		<span class="n">AB8500_REV_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_ab8500</span><span class="p">;</span>

	<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;detected chip, %s rev. %1x.%1x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ab8500_version_str</span><span class="p">[</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">],</span>
			<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span>
			<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>

	<span class="cm">/* Configure AB8500 or AB9540 IRQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_ab9540</span><span class="p">(</span><span class="n">ab8500</span><span class="p">)</span> <span class="o">||</span> <span class="n">is_ab8505</span><span class="p">(</span><span class="n">ab8500</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask_size</span> <span class="o">=</span> <span class="n">AB9540_NUM_IRQ_REGS</span><span class="p">;</span>
		<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_reg_offset</span> <span class="o">=</span> <span class="n">ab9540_irq_regoffset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask_size</span> <span class="o">=</span> <span class="n">AB8500_NUM_IRQ_REGS</span><span class="p">;</span>
		<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_reg_offset</span> <span class="o">=</span> <span class="n">ab8500_irq_regoffset</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">oldmask</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">oldmask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_freemask</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * ab8500 has switched off due to (SWITCH_OFF_STATUS):</span>
<span class="cm">	 * 0x01 Swoff bit programming</span>
<span class="cm">	 * 0x02 Thermal protection activation</span>
<span class="cm">	 * 0x04 Vbat lower then BattOk falling threshold</span>
<span class="cm">	 * 0x08 Watchdog expired</span>
<span class="cm">	 * 0x10 Non presence of 32kHz clock</span>
<span class="cm">	 * 0x20 Battery level lower than power on reset threshold</span>
<span class="cm">	 * 0x40 Power on key 1 pressed longer than 10 seconds</span>
<span class="cm">	 * 0x80 DB8500 thermal shutdown</span>
<span class="cm">	 */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_register_interruptible</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">AB8500_RTC</span><span class="p">,</span>
		<span class="n">AB8500_SWITCH_OFF_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;switch off status: %#x&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plat</span> <span class="o">&amp;&amp;</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
		<span class="n">plat</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">ab8500</span><span class="p">);</span>

	<span class="cm">/* Clear and mask all interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Interrupt register 12 doesn&#39;t exist prior to AB8500 version</span>
<span class="cm">		 * 2.0</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_reg_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">11</span> <span class="o">&amp;&amp;</span>
				<span class="n">is_ab8500_1p1_or_earlier</span><span class="p">(</span><span class="n">ab8500</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">get_register_interruptible</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">AB8500_INTERRUPT</span><span class="p">,</span>
			<span class="n">AB8500_IT_LATCH1_REG</span> <span class="o">+</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_reg_offset</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">set_register_interruptible</span><span class="p">(</span><span class="n">ab8500</span><span class="p">,</span> <span class="n">AB8500_INTERRUPT</span><span class="p">,</span>
			<span class="n">AB8500_IT_MASK1_REG</span> <span class="o">+</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_reg_offset</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_register_ops</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ab8500_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_freeoldmask</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">oldmask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_irq_init</span><span class="p">(</span><span class="n">ab8500</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_freeoldmask</span><span class="p">;</span>

		<span class="cm">/*  Activate this feature only in ab9540 */</span>
		<span class="cm">/*  till tests are done on ab8500 1p2 or later*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_ab9540</span><span class="p">(</span><span class="n">ab8500</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					<span class="n">ab8500_hierarchical_irq</span><span class="p">,</span>
					<span class="n">IRQF_ONESHOT</span> <span class="o">|</span> <span class="n">IRQF_NO_SUSPEND</span><span class="p">,</span>
					<span class="s">&quot;ab8500&quot;</span><span class="p">,</span> <span class="n">ab8500</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					<span class="n">ab8500_irq</span><span class="p">,</span>
					<span class="n">IRQF_ONESHOT</span> <span class="o">|</span> <span class="n">IRQF_NO_SUSPEND</span><span class="p">,</span>
					<span class="s">&quot;ab8500&quot;</span><span class="p">,</span> <span class="n">ab8500</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_removeirq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mfd_add_devices</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">abx500_common_devs</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">abx500_common_devs</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_freeirq</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_ab9540</span><span class="p">(</span><span class="n">ab8500</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mfd_add_devices</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ab9540_devs</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab9540_devs</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span>
					<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mfd_add_devices</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ab8500_devs</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_devs</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span>
					<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_freeirq</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_ab9540</span><span class="p">(</span><span class="n">ab8500</span><span class="p">)</span> <span class="o">||</span> <span class="n">is_ab8505</span><span class="p">(</span><span class="n">ab8500</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mfd_add_devices</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ab9540_ab8505_devs</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab9540_ab8505_devs</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span>
					<span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_freeirq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">no_bm</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Add battery management devices */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mfd_add_devices</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ab8500_bm_devs</span><span class="p">,</span>
				      <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_bm_devs</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span>
				      <span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error adding bm devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ab9540</span><span class="p">(</span><span class="n">ab8500</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ab9540_attr_group</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ab8500_attr_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error creating sysfs entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">out_freeirq:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ab8500</span><span class="p">);</span>
<span class="nl">out_removeirq:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">)</span>
		<span class="n">ab8500_irq_remove</span><span class="p">(</span><span class="n">ab8500</span><span class="p">);</span>
<span class="nl">out_freeoldmask:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">oldmask</span><span class="p">);</span>
<span class="nl">out_freemask:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
<span class="nl">out_free_ab8500:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ab8500</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">ab8500_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">ab8500</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ab9540</span><span class="p">(</span><span class="n">ab8500</span><span class="p">))</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ab9540_attr_group</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ab8500_attr_group</span><span class="p">);</span>
	<span class="n">mfd_remove_devices</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ab8500</span><span class="p">);</span>
		<span class="n">ab8500_irq_remove</span><span class="p">(</span><span class="n">ab8500</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">oldmask</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ab8500</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ab8500</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="n">ab8500_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;ab8500-core&quot;</span><span class="p">,</span> <span class="n">AB8500_VERSION_AB8500</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ab8505-i2c&quot;</span><span class="p">,</span> <span class="n">AB8500_VERSION_AB8505</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ab9540-i2c&quot;</span><span class="p">,</span> <span class="n">AB8500_VERSION_AB9540</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ab8540-i2c&quot;</span><span class="p">,</span> <span class="n">AB8500_VERSION_AB8540</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ab8500_core_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-core&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">ab8500_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">ab8500_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ab8500_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">ab8500_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ab8500_core_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500_core_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ab8500_core_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500_core_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">arch_initcall</span><span class="p">(</span><span class="n">ab8500_core_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ab8500_core_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mattias Wallin, Srinidhi Kasagar, Rabin Vincent&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;AB8500 MFD core&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
