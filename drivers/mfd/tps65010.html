<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › mfd › tps65010.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>tps65010.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * tps65010 - driver for tps6501x power management chips</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004 Texas Instruments</span>
<span class="cm"> * Copyright (C) 2004-2005 David Brownell</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>

<span class="cp">#include &lt;linux/i2c/tps65010.h&gt;</span>

<span class="cp">#include &lt;linux/gpio.h&gt;</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#define	DRIVER_VERSION	&quot;2 May 2005&quot;</span>
<span class="cp">#define	DRIVER_NAME	(tps65010_driver.driver.name)</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;TPS6501x Power Management Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">tps65010_driver</span><span class="p">;</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* This driver handles a family of multipurpose chips, which incorporate</span>
<span class="cm"> * voltage regulators, lithium ion/polymer battery charging, GPIOs, LEDs,</span>
<span class="cm"> * and other features often needed in portable devices like cell phones</span>
<span class="cm"> * or digital cameras.</span>
<span class="cm"> *</span>
<span class="cm"> * The tps65011 and tps65013 have different voltage settings compared</span>
<span class="cm"> * to tps65010 and tps65012.  The tps65013 has a NO_CHG status/irq.</span>
<span class="cm"> * All except tps65010 have &quot;wait&quot; mode, possibly defaulted so that</span>
<span class="cm"> * battery-insert != device-on.</span>
<span class="cm"> *</span>
<span class="cm"> * We could distinguish between some models by checking VDCDC1.UVLO or</span>
<span class="cm"> * other registers, unless they&#39;ve been changed already after powerup</span>
<span class="cm"> * as part of board setup by a bootloader.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">tps_model</span> <span class="p">{</span>
	<span class="n">TPS65010</span><span class="p">,</span>
	<span class="n">TPS65011</span><span class="p">,</span>
	<span class="n">TPS65012</span><span class="p">,</span>
	<span class="n">TPS65013</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tps65010</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>	<span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span>		<span class="o">*</span><span class="n">file</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">charging</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">por</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span>		<span class="n">model</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">vbus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
<span class="cp">#define	FLAG_VBUS_CHANGED	0</span>
<span class="cp">#define	FLAG_IRQ_ENABLE		1</span>

	<span class="cm">/* copies of last register state */</span>
	<span class="n">u8</span>			<span class="n">chgstatus</span><span class="p">,</span> <span class="n">regstatus</span><span class="p">,</span> <span class="n">chgconf</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">nmask1</span><span class="p">,</span> <span class="n">nmask2</span><span class="p">;</span>

	<span class="n">u8</span>			<span class="n">outmask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gpio_chip</span>	<span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span>	<span class="o">*</span><span class="n">leds</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define	POWER_POLL_DELAY	msecs_to_jiffies(5000)</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cp">#if	defined(DEBUG) || defined(CONFIG_DEBUG_FS)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dbg_chgstat</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">chgstatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%02x%s%s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">chgstatus</span><span class="p">,</span>
		<span class="p">(</span><span class="n">chgstatus</span> <span class="o">&amp;</span> <span class="n">TPS_CHG_USB</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; USB&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">chgstatus</span> <span class="o">&amp;</span> <span class="n">TPS_CHG_AC</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; AC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">chgstatus</span> <span class="o">&amp;</span> <span class="n">TPS_CHG_THERM</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; therm&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">chgstatus</span> <span class="o">&amp;</span> <span class="n">TPS_CHG_TERM</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; done&quot;</span> <span class="o">:</span>
			<span class="p">((</span><span class="n">chgstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TPS_CHG_USB</span><span class="o">|</span><span class="n">TPS_CHG_AC</span><span class="p">))</span>
				<span class="o">?</span> <span class="s">&quot; (charging)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
		<span class="p">(</span><span class="n">chgstatus</span> <span class="o">&amp;</span> <span class="n">TPS_CHG_TAPER_TMO</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; taper_tmo&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">chgstatus</span> <span class="o">&amp;</span> <span class="n">TPS_CHG_CHG_TMO</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; charge_tmo&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">chgstatus</span> <span class="o">&amp;</span> <span class="n">TPS_CHG_PRECHG_TMO</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; prechg_tmo&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">chgstatus</span> <span class="o">&amp;</span> <span class="n">TPS_CHG_TEMP_ERR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; temp_err&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dbg_regstat</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">regstatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%02x %s%s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">regstatus</span><span class="p">,</span>
		<span class="p">(</span><span class="n">regstatus</span> <span class="o">&amp;</span> <span class="n">TPS_REG_ONOFF</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;off&quot;</span> <span class="o">:</span> <span class="s">&quot;(on)&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">regstatus</span> <span class="o">&amp;</span> <span class="n">TPS_REG_COVER</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; uncover&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">regstatus</span> <span class="o">&amp;</span> <span class="n">TPS_REG_UVLO</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; UVLO&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">regstatus</span> <span class="o">&amp;</span> <span class="n">TPS_REG_NO_CHG</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; NO_CHG&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">regstatus</span> <span class="o">&amp;</span> <span class="n">TPS_REG_PG_LD02</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ld02_bad&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">regstatus</span> <span class="o">&amp;</span> <span class="n">TPS_REG_PG_LD01</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ld01_bad&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">regstatus</span> <span class="o">&amp;</span> <span class="n">TPS_REG_PG_MAIN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; main_bad&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">regstatus</span> <span class="o">&amp;</span> <span class="n">TPS_REG_PG_CORE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; core_bad&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dbg_chgconf</span><span class="p">(</span><span class="kt">int</span> <span class="n">por</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">chgconfig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hibit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">por</span><span class="p">)</span>
		<span class="n">hibit</span> <span class="o">=</span> <span class="p">(</span><span class="n">chgconfig</span> <span class="o">&amp;</span> <span class="n">TPS_CHARGE_POR</span><span class="p">)</span>
				<span class="o">?</span> <span class="s">&quot;POR=69ms&quot;</span> <span class="o">:</span> <span class="s">&quot;POR=1sec&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hibit</span> <span class="o">=</span> <span class="p">(</span><span class="n">chgconfig</span> <span class="o">&amp;</span> <span class="n">TPS65013_AUA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;AUA&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%02x %s%s%s AC=%d%% USB=%dmA %sCharge</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">chgconfig</span><span class="p">,</span> <span class="n">hibit</span><span class="p">,</span>
		<span class="p">(</span><span class="n">chgconfig</span> <span class="o">&amp;</span> <span class="n">TPS_CHARGE_RESET</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; reset&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">chgconfig</span> <span class="o">&amp;</span> <span class="n">TPS_CHARGE_FAST</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; fast&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">({</span><span class="kt">int</span> <span class="n">p</span><span class="p">;</span> <span class="k">switch</span> <span class="p">((</span><span class="n">chgconfig</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">3</span>:		<span class="n">p</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:		<span class="n">p</span> <span class="o">=</span> <span class="mi">75</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:		<span class="n">p</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>	<span class="n">p</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">};</span> <span class="n">p</span><span class="p">;</span> <span class="p">}),</span>
		<span class="p">(</span><span class="n">chgconfig</span> <span class="o">&amp;</span> <span class="n">TPS_VBUS_CHARGING</span><span class="p">)</span>
			<span class="o">?</span> <span class="p">((</span><span class="n">chgconfig</span> <span class="o">&amp;</span> <span class="n">TPS_VBUS_500MA</span><span class="p">)</span> <span class="o">?</span> <span class="mi">500</span> <span class="o">:</span> <span class="mi">100</span><span class="p">)</span>
			<span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">(</span><span class="n">chgconfig</span> <span class="o">&amp;</span> <span class="n">TPS_CHARGE_ENABLE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;No&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cp">#ifdef	DEBUG</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_chgstatus</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u8</span> <span class="n">chgstatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span> <span class="p">[</span><span class="mi">100</span><span class="p">];</span>

	<span class="n">dbg_chgstat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">chgstatus</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %s %s&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_regstatus</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u8</span> <span class="n">regstatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span> <span class="p">[</span><span class="mi">100</span><span class="p">];</span>

	<span class="n">dbg_regstat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">regstatus</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %s %s&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">show_chgconfig</span><span class="p">(</span><span class="kt">int</span> <span class="n">por</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u8</span> <span class="n">chgconfig</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span> <span class="p">[</span><span class="mi">100</span><span class="p">];</span>

	<span class="n">dbg_chgconf</span><span class="p">(</span><span class="n">por</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">chgconfig</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %s %s&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">show_chgstatus</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u8</span> <span class="n">chgstatus</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">show_regstatus</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u8</span> <span class="n">chgstatus</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">show_chgconfig</span><span class="p">(</span><span class="kt">int</span> <span class="n">por</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span> <span class="n">u8</span> <span class="n">chgconfig</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

<span class="cp">#endif</span>

<span class="cp">#ifdef	CONFIG_DEBUG_FS</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dbg_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tps65010</span>	<span class="o">*</span><span class="n">tps</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">value</span><span class="p">,</span> <span class="n">v2</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">chip</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPS65010</span>:	<span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;tps65010&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPS65011</span>:	<span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;tps65011&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPS65012</span>:	<span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;tps65012&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPS65013</span>:	<span class="n">chip</span> <span class="o">=</span> <span class="s">&quot;tps65013&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="n">chip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;driver  %s</span><span class="se">\n</span><span class="s">version %s</span><span class="se">\n</span><span class="s">chip    %s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">DRIVER_VERSION</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* FIXME how can we tell whether a battery is present?</span>
<span class="cm">	 * likely involves a charge gauging chip (like BQ26501).</span>
<span class="cm">	 */</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%scharging</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tps</span><span class="o">-&gt;</span><span class="n">charging</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;(not) &quot;</span><span class="p">);</span>


	<span class="cm">/* registers for monitoring battery charging and status; note</span>
<span class="cm">	 * that reading chgstat and regstat may ack IRQs...</span>
<span class="cm">	 */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_CHGCONFIG</span><span class="p">);</span>
	<span class="n">dbg_chgconf</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">por</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;chgconfig %s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_CHGSTATUS</span><span class="p">);</span>
	<span class="n">dbg_chgstat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;chgstat   %s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_MASK1</span><span class="p">);</span>
	<span class="n">dbg_chgstat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;mask1     %s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="cm">/* ignore ackint1 */</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_REGSTATUS</span><span class="p">);</span>
	<span class="n">dbg_regstat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;regstat   %s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_MASK2</span><span class="p">);</span>
	<span class="n">dbg_regstat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;mask2     %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="cm">/* ignore ackint2 */</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">POWER_POLL_DELAY</span><span class="p">);</span>


	<span class="cm">/* VMAIN voltage, enable lowpower, etc */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_VDCDC1</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;vdcdc1    %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* VCORE voltage, vibrator on/off */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_VDCDC2</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;vdcdc2    %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* both LD0s, and their lowpower behavior */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_VREGS1</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;vregs1    %02x</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>


	<span class="cm">/* LEDs and GPIOs */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_LED1_ON</span><span class="p">);</span>
	<span class="n">v2</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_LED1_PER</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;led1 %s, on=%02x, per=%02x, %d/%d msec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="o">?</span> <span class="p">((</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">)</span>
			<span class="o">:</span> <span class="p">((</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;blink&quot;</span> <span class="o">:</span> <span class="s">&quot;(nPG)&quot;</span><span class="p">),</span>
		<span class="n">value</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span>
		<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_LED2_ON</span><span class="p">);</span>
	<span class="n">v2</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_LED2_PER</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;led2 %s, on=%02x, per=%02x, %d/%d msec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="o">?</span> <span class="p">((</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">)</span>
			<span class="o">:</span> <span class="p">((</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;blink&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">),</span>
		<span class="n">value</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span>
		<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_DEFGPIO</span><span class="p">);</span>
	<span class="n">v2</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_MASK3</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;defgpio %02x mask3 %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">)))</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;  gpio%d-out %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;low&quot;</span> <span class="o">:</span> <span class="s">&quot;hi &quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;  gpio%d-in  %s %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;hi &quot;</span> <span class="o">:</span> <span class="s">&quot;low&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;no-irq&quot;</span> <span class="o">:</span> <span class="s">&quot;irq&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">)))</span> <span class="o">?</span> <span class="s">&quot;rising&quot;</span> <span class="o">:</span> <span class="s">&quot;falling&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dbg_tps_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dbg_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">debug_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">dbg_tps_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define	DEBUG_FOPS	&amp;debug_fops</span>

<span class="cp">#else</span>
<span class="cp">#define	DEBUG_FOPS	NULL</span>
<span class="cp">#endif</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* handle IRQS in a task context, so we can use I2C calls */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tps65010_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">tps65010</span> <span class="o">*</span><span class="n">tps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">poll</span><span class="p">;</span>

	<span class="cm">/* IRQs won&#39;t trigger for certain events, but we can get</span>
<span class="cm">	 * others by polling (normally, with external power applied).</span>
<span class="cm">	 */</span>
	<span class="n">poll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* regstatus irqs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">nmask2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_REGSTATUS</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">^</span> <span class="n">tps</span><span class="o">-&gt;</span><span class="n">regstatus</span><span class="p">;</span>
		<span class="n">tps</span><span class="o">-&gt;</span><span class="n">regstatus</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">tps</span><span class="o">-&gt;</span><span class="n">nmask2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tps</span><span class="o">-&gt;</span><span class="n">regstatus</span> <span class="o">=</span>  <span class="n">tmp</span><span class="p">;</span>
		<span class="cm">/* may need to shut something down ... */</span>

		<span class="cm">/* &quot;off&quot; usually means deep sleep */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">TPS_REG_ONOFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: power off button</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			/* REVISIT:  this might need its own workqueue</span>
<span class="c">			 * plus tweaks including deadlock avoidance ...</span>
<span class="c">			 * also needs to get error handling and probably</span>
<span class="c">			 * an #ifdef CONFIG_HIBERNATION</span>
<span class="c">			 */</span>
<span class="c">			hibernate();</span>
<span class="cp">#endif</span>
			<span class="n">poll</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* chgstatus irqs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">nmask1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_CHGSTATUS</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">^</span> <span class="n">tps</span><span class="o">-&gt;</span><span class="n">chgstatus</span><span class="p">;</span>
		<span class="n">tps</span><span class="o">-&gt;</span><span class="n">chgstatus</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">tps</span><span class="o">-&gt;</span><span class="n">nmask1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span>	<span class="n">charging</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">show_chgstatus</span><span class="p">(</span><span class="s">&quot;chg/irq&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TPS_CHG_USB</span><span class="o">|</span><span class="n">TPS_CHG_AC</span><span class="p">))</span>
			<span class="n">show_chgconfig</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">por</span><span class="p">,</span> <span class="s">&quot;conf&quot;</span><span class="p">,</span> <span class="n">tps</span><span class="o">-&gt;</span><span class="n">chgconf</span><span class="p">);</span>

		<span class="cm">/* Unless it was turned off or disabled, we charge any</span>
<span class="cm">		 * battery whenever there&#39;s power available for it</span>
<span class="cm">		 * and the charger hasn&#39;t been disabled.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">chgstatus</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TPS_CHG_USB</span><span class="o">|</span><span class="n">TPS_CHG_AC</span><span class="p">))</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">chgstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TPS_CHG_USB</span><span class="o">|</span><span class="n">TPS_CHG_AC</span><span class="p">))</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">chgconf</span> <span class="o">&amp;</span> <span class="n">TPS_CHARGE_ENABLE</span><span class="p">)</span>
				<span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">chgstatus</span> <span class="o">&amp;</span> <span class="n">TPS_CHG_USB</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* VBUS options are readonly until reconnect */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">TPS_CHG_USB</span><span class="p">)</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_VBUS_CHANGED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">charging</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">chgstatus</span> <span class="o">&amp;</span> <span class="n">TPS_CHG_AC</span><span class="p">)</span>
				<span class="n">charging</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">charging</span> <span class="o">!=</span> <span class="n">tps</span><span class="o">-&gt;</span><span class="n">charging</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tps</span><span class="o">-&gt;</span><span class="n">charging</span> <span class="o">=</span> <span class="n">charging</span><span class="p">;</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: battery %scharging</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">charging</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span>
				<span class="p">((</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">chgstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TPS_CHG_USB</span><span class="o">|</span><span class="n">TPS_CHG_AC</span><span class="p">))</span>
					<span class="o">?</span> <span class="s">&quot;NOT &quot;</span> <span class="o">:</span> <span class="s">&quot;dis&quot;</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* always poll to detect (a) power removal, without tps65013</span>
<span class="cm">	 * NO_CHG IRQ; or (b) restart of charging after stop.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">TPS65013</span> <span class="o">||</span> <span class="o">!</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">charging</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">chgstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TPS_CHG_USB</span><span class="o">|</span><span class="n">TPS_CHG_AC</span><span class="p">)))</span>
		<span class="n">poll</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">poll</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">POWER_POLL_DELAY</span><span class="p">);</span>

	<span class="cm">/* also potentially gpio-in rise or fall */</span>
<span class="p">}</span>

<span class="cm">/* handle IRQs and polling using keventd for now */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tps65010_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tps65010</span>		<span class="o">*</span><span class="n">tps</span><span class="p">;</span>

	<span class="n">tps</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">),</span> <span class="k">struct</span> <span class="n">tps65010</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">tps65010_interrupt</span><span class="p">(</span><span class="n">tps</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLAG_VBUS_CHANGED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">status</span><span class="p">;</span>
		<span class="n">u8</span>	<span class="n">chgconfig</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">chgconfig</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					<span class="n">TPS_CHGCONFIG</span><span class="p">);</span>
		<span class="n">chgconfig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TPS_VBUS_500MA</span> <span class="o">|</span> <span class="n">TPS_VBUS_CHARGING</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">vbus</span> <span class="o">==</span> <span class="mi">500</span><span class="p">)</span>
			<span class="n">chgconfig</span> <span class="o">|=</span> <span class="n">TPS_VBUS_500MA</span> <span class="o">|</span> <span class="n">TPS_VBUS_CHARGING</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">vbus</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">chgconfig</span> <span class="o">|=</span> <span class="n">TPS_VBUS_CHARGING</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
				<span class="n">TPS_CHGCONFIG</span><span class="p">,</span> <span class="n">chgconfig</span><span class="p">);</span>

		<span class="cm">/* vbus update fails unless VBUS is connected! */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_CHGCONFIG</span><span class="p">);</span>
		<span class="n">tps</span><span class="o">-&gt;</span><span class="n">chgconf</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">show_chgconfig</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">por</span><span class="p">,</span> <span class="s">&quot;update vbus&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLAG_IRQ_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">tps65010_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_tps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tps65010</span>		<span class="o">*</span><span class="n">tps</span> <span class="o">=</span> <span class="n">_tps</span><span class="p">;</span>

	<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_IRQ_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* offsets 0..3 == GPIO1..GPIO4</span>
<span class="cm"> * offsets 4..5 == LED1/nPG, LED2 (we set one of the non-BLINK modes)</span>
<span class="cm"> * offset 6 == vibrator motor driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tps65010_gpio_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">tps65010_set_gpio_out_value</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">tps65010_set_led</span><span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="n">value</span> <span class="o">?</span> <span class="n">ON</span> <span class="o">:</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tps65010_set_vib</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tps65010_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* GPIOs may be input-only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tps65010</span>		<span class="o">*</span><span class="n">tps</span><span class="p">;</span>

		<span class="n">tps</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tps65010</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">outmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">tps65010_set_gpio_out_value</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">tps65010_set_led</span><span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="n">value</span> <span class="o">?</span> <span class="n">ON</span> <span class="o">:</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tps65010_set_vib</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tps65010_gpio_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tps65010</span>		<span class="o">*</span><span class="n">tps</span><span class="p">;</span>

	<span class="n">tps</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tps65010</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_DEFGPIO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)))</span>	<span class="cm">/* output */</span>
			<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">));</span>
		<span class="k">else</span>					<span class="cm">/* input */</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* REVISIT we *could* report LED1/nPG and LED2 state ... */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tps65010</span> <span class="o">*</span><span class="n">the_tps</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">tps65010_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tps65010</span>		<span class="o">*</span><span class="n">tps</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tps65010_board</span>	<span class="o">*</span><span class="n">board</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">board</span> <span class="o">&amp;&amp;</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">teardown</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">teardown</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;board %s %s err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="s">&quot;teardown&quot;</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">tps</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tps</span><span class="p">);</span>
	<span class="n">the_tps</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tps65010_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tps65010</span>		<span class="o">*</span><span class="n">tps</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tps65010_board</span>	<span class="o">*</span><span class="n">board</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">the_tps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;only one tps6501x chip allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tps</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">tps</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tps</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">tps65010_work</span><span class="p">);</span>
	<span class="n">tps</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">tps</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="cm">/* the IRQ is active low, but many gpio lines can&#39;t support that</span>
<span class="cm">	 * so this driver uses falling-edge triggers instead.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">tps65010_irq</span><span class="p">,</span>
			<span class="n">IRQF_SAMPLE_RANDOM</span> <span class="o">|</span> <span class="n">IRQF_TRIGGER_FALLING</span><span class="p">,</span>
			<span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">tps</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t get IRQ %d, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* annoying race here, ideally we&#39;d have an option</span>
<span class="cm">		 * to claim the irq now and enable it later.</span>
<span class="cm">		 * FIXME genirq IRQF_NOAUTOEN now solves that ...</span>
<span class="cm">		 */</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_IRQ_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ not configured!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="k">switch</span> <span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPS65010</span>:
	<span class="k">case</span> <span class="n">TPS65012</span>:
		<span class="n">tps</span><span class="o">-&gt;</span><span class="n">por</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* else CHGCONFIG.POR is replaced by AUA, enabling a WAIT mode */</span>
	<span class="p">}</span>
	<span class="n">tps</span><span class="o">-&gt;</span><span class="n">chgconf</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_CHGCONFIG</span><span class="p">);</span>
	<span class="n">show_chgconfig</span><span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">por</span><span class="p">,</span> <span class="s">&quot;conf/init&quot;</span><span class="p">,</span> <span class="n">tps</span><span class="o">-&gt;</span><span class="n">chgconf</span><span class="p">);</span>

	<span class="n">show_chgstatus</span><span class="p">(</span><span class="s">&quot;chg/init&quot;</span><span class="p">,</span>
		<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_CHGSTATUS</span><span class="p">));</span>
	<span class="n">show_regstatus</span><span class="p">(</span><span class="s">&quot;reg/init&quot;</span><span class="p">,</span>
		<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_REGSTATUS</span><span class="p">));</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: vdcdc1 0x%02x, vdcdc2 %02x, vregs1 %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_VDCDC1</span><span class="p">),</span>
		<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_VDCDC2</span><span class="p">),</span>
		<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_VREGS1</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: defgpio 0x%02x, mask3 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_DEFGPIO</span><span class="p">),</span>
		<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_MASK3</span><span class="p">));</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">tps</span><span class="p">);</span>
	<span class="n">the_tps</span> <span class="o">=</span> <span class="n">tps</span><span class="p">;</span>

<span class="cp">#if	defined(CONFIG_USB_GADGET) &amp;&amp; !defined(CONFIG_USB_OTG)</span>
	<span class="cm">/* USB hosts can&#39;t draw VBUS.  OTG devices could, later</span>
<span class="cm">	 * when OTG infrastructure enables it.  USB peripherals</span>
<span class="cm">	 * could be relying on VBUS while booting, though.</span>
<span class="cm">	 */</span>
	<span class="n">tps</span><span class="o">-&gt;</span><span class="n">vbus</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* unmask the &quot;interesting&quot; irqs, then poll once to</span>
<span class="cm">	 * kickstart monitoring, initialize shadowed status</span>
<span class="cm">	 * registers, and maybe disable VBUS draw.</span>
<span class="cm">	 */</span>
	<span class="n">tps</span><span class="o">-&gt;</span><span class="n">nmask1</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_MASK1</span><span class="p">,</span> <span class="o">~</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">nmask1</span><span class="p">);</span>

	<span class="n">tps</span><span class="o">-&gt;</span><span class="n">nmask2</span> <span class="o">=</span> <span class="n">TPS_REG_ONOFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">TPS65013</span><span class="p">)</span>
		<span class="n">tps</span><span class="o">-&gt;</span><span class="n">nmask2</span> <span class="o">|=</span> <span class="n">TPS_REG_NO_CHG</span><span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_MASK2</span><span class="p">,</span> <span class="o">~</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">nmask2</span><span class="p">);</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_MASK3</span><span class="p">,</span> <span class="mh">0x0f</span>
		<span class="o">|</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_MASK3</span><span class="p">));</span>

	<span class="n">tps65010_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">tps</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="n">tps</span><span class="p">,</span> <span class="n">DEBUG_FOPS</span><span class="p">);</span>

	<span class="cm">/* optionally register GPIOs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board</span> <span class="o">&amp;&amp;</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tps</span><span class="o">-&gt;</span><span class="n">outmask</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">outmask</span><span class="p">;</span>

		<span class="n">tps</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
		<span class="n">tps</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">tps</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>

		<span class="n">tps</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="n">tps65010_gpio_set</span><span class="p">;</span>
		<span class="n">tps</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">direction_output</span> <span class="o">=</span> <span class="n">tps65010_output</span><span class="p">;</span>

		<span class="cm">/* NOTE:  only partial support for inputs; nyet IRQs */</span>
		<span class="n">tps</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">tps65010_gpio_get</span><span class="p">;</span>

		<span class="n">tps</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
		<span class="n">tps</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">ngpio</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">tps</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">can_sleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">gpiochip_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t add gpiochip, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">status</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">board</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;board %s %s err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="s">&quot;setup&quot;</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tps</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">tps65010_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;tps65010&quot;</span><span class="p">,</span> <span class="n">TPS65010</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tps65011&quot;</span><span class="p">,</span> <span class="n">TPS65011</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tps65012&quot;</span><span class="p">,</span> <span class="n">TPS65012</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tps65013&quot;</span><span class="p">,</span> <span class="n">TPS65013</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tps65014&quot;</span><span class="p">,</span> <span class="n">TPS65011</span> <span class="p">},</span>	<span class="cm">/* tps65011 charging at 6.5V max */</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">tps65010_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">tps65010_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;tps65010&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">tps65010_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">tps65010_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">tps65010_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="cm">/* Draw from VBUS:</span>
<span class="cm"> *   0 mA -- DON&#39;T DRAW (might supply power instead)</span>
<span class="cm"> * 100 mA -- usb unit load (slowest charge rate)</span>
<span class="cm"> * 500 mA -- usb high power (fast battery charge)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tps65010_set_vbus_draw</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">mA</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">the_tps</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* assumes non-SMP */</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mA</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="p">)</span>
		<span class="n">mA</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mA</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">mA</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">vbus</span> <span class="o">=</span> <span class="n">mA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">chgstatus</span> <span class="o">&amp;</span> <span class="n">TPS_CHG_USB</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="n">test_and_set_bit</span><span class="p">(</span>
				<span class="n">FLAG_VBUS_CHANGED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* gadget drivers call this in_irq() */</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tps65010_set_vbus_draw</span><span class="p">);</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>
<span class="cm">/* tps65010_set_gpio_out_value parameter:</span>
<span class="cm"> * gpio:  GPIO1, GPIO2, GPIO3 or GPIO4</span>
<span class="cm"> * value: LOW or HIGH</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tps65010_set_gpio_out_value</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">gpio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	 <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">defgpio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">the_tps</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">gpio</span> <span class="o">&lt;</span> <span class="n">GPIO1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&gt;</span> <span class="n">GPIO4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">defgpio</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_DEFGPIO</span><span class="p">);</span>

	<span class="cm">/* Configure GPIO for output */</span>
	<span class="n">defgpio</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* Writing 1 forces a logic 0 on that GPIO and vice versa */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LOW</span>:
		<span class="n">defgpio</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>    <span class="cm">/* set GPIO low by writing 1 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* case HIGH: */</span>
	<span class="nl">default:</span>
		<span class="n">defgpio</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span> <span class="cm">/* set GPIO high by writing 0 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
		<span class="n">TPS_DEFGPIO</span><span class="p">,</span> <span class="n">defgpio</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: gpio%dout = %s, defgpio 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="n">gpio</span><span class="p">,</span> <span class="n">value</span> <span class="o">?</span> <span class="s">&quot;high&quot;</span> <span class="o">:</span> <span class="s">&quot;low&quot;</span><span class="p">,</span>
		<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_DEFGPIO</span><span class="p">));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tps65010_set_gpio_out_value</span><span class="p">);</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>
<span class="cm">/* tps65010_set_led parameter:</span>
<span class="cm"> * led:  LED1 or LED2</span>
<span class="cm"> * mode: ON, OFF or BLINK</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tps65010_set_led</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">led</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	 <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">led_on</span><span class="p">,</span> <span class="n">led_per</span><span class="p">,</span> <span class="n">offs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">the_tps</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">led</span> <span class="o">==</span> <span class="n">LED1</span><span class="p">)</span>
		<span class="n">offs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">offs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">led</span> <span class="o">=</span> <span class="n">LED2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: led%i_on   0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">led</span><span class="p">,</span>
		<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
				<span class="n">TPS_LED1_ON</span> <span class="o">+</span> <span class="n">offs</span><span class="p">));</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: led%i_per  0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">led</span><span class="p">,</span>
		<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
				<span class="n">TPS_LED1_PER</span> <span class="o">+</span> <span class="n">offs</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OFF</span>:
		<span class="n">led_on</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">led_per</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ON</span>:
		<span class="n">led_on</span>  <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">led_per</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BLINK</span>:
		<span class="n">led_on</span>  <span class="o">=</span> <span class="mh">0x30</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">led_per</span> <span class="o">=</span> <span class="mh">0x08</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Wrong mode parameter for set_led()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">DRIVER_NAME</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
			<span class="n">TPS_LED1_ON</span> <span class="o">+</span> <span class="n">offs</span><span class="p">,</span> <span class="n">led_on</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed to write led%i_on register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: led%i_on   0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">led</span><span class="p">,</span>
		<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_LED1_ON</span> <span class="o">+</span> <span class="n">offs</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
			<span class="n">TPS_LED1_PER</span> <span class="o">+</span> <span class="n">offs</span><span class="p">,</span> <span class="n">led_per</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed to write led%i_per register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: led%i_per  0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">led</span><span class="p">,</span>
		<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
				<span class="n">TPS_LED1_PER</span> <span class="o">+</span> <span class="n">offs</span><span class="p">));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tps65010_set_led</span><span class="p">);</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>
<span class="cm">/* tps65010_set_vib parameter:</span>
<span class="cm"> * value: ON or OFF</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tps65010_set_vib</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	 <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">vdcdc2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">the_tps</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">vdcdc2</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_VDCDC2</span><span class="p">);</span>
	<span class="n">vdcdc2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">vdcdc2</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
		<span class="n">TPS_VDCDC2</span><span class="p">,</span> <span class="n">vdcdc2</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: vibrator %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">value</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tps65010_set_vib</span><span class="p">);</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>
<span class="cm">/* tps65010_set_low_pwr parameter:</span>
<span class="cm"> * mode: ON or OFF</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tps65010_set_low_pwr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	 <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">vdcdc1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">the_tps</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %s low_pwr, vdcdc1 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="n">mode</span> <span class="o">?</span> <span class="s">&quot;enable&quot;</span> <span class="o">:</span> <span class="s">&quot;disable&quot;</span><span class="p">,</span>
		<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_VDCDC1</span><span class="p">));</span>

	<span class="n">vdcdc1</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_VDCDC1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OFF</span>:
		<span class="n">vdcdc1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TPS_ENABLE_LP</span><span class="p">;</span> <span class="cm">/* disable ENABLE_LP bit */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* case ON: */</span>
	<span class="nl">default:</span>
		<span class="n">vdcdc1</span> <span class="o">|=</span> <span class="n">TPS_ENABLE_LP</span><span class="p">;</span>  <span class="cm">/* enable ENABLE_LP bit */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
			<span class="n">TPS_VDCDC1</span><span class="p">,</span> <span class="n">vdcdc1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed to write vdcdc1 register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">DRIVER_NAME</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: vdcdc1 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
			<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_VDCDC1</span><span class="p">));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tps65010_set_low_pwr</span><span class="p">);</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>
<span class="cm">/* tps65010_config_vregs1 parameter:</span>
<span class="cm"> * value to be written to VREGS1 register</span>
<span class="cm"> * Note: The complete register is written, set all bits you need</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">tps65010_config_vregs1</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	 <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">the_tps</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: vregs1 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
			<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_VREGS1</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
			<span class="n">TPS_VREGS1</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed to write vregs1 register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">DRIVER_NAME</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: vregs1 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
			<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_VREGS1</span><span class="p">));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tps65010_config_vregs1</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">tps65010_config_vdcdc2</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">the_tps</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: vdcdc2 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		 <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">TPS_VDCDC2</span><span class="p">));</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">TPS_VDCDC2</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed to write vdcdc2 register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">DRIVER_NAME</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: vregs1 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
			 <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">TPS_VDCDC2</span><span class="p">));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tps65010_config_vdcdc2</span><span class="p">);</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>
<span class="cm">/* tps65013_set_low_pwr parameter:</span>
<span class="cm"> * mode: ON or OFF</span>
<span class="cm"> */</span>

<span class="cm">/* FIXME: Assumes AC or USB power is present. Setting AUA bit is not</span>
<span class="cm">	required if power supply is through a battery */</span>

<span class="kt">int</span> <span class="nf">tps65013_set_low_pwr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	 <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">vdcdc1</span><span class="p">,</span> <span class="n">chgconfig</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">the_tps</span> <span class="o">||</span> <span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">por</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: %s low_pwr, chgconfig 0x%02x vdcdc1 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="n">mode</span> <span class="o">?</span> <span class="s">&quot;enable&quot;</span> <span class="o">:</span> <span class="s">&quot;disable&quot;</span><span class="p">,</span>
		<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_CHGCONFIG</span><span class="p">),</span>
		<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_VDCDC1</span><span class="p">));</span>

	<span class="n">chgconfig</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_CHGCONFIG</span><span class="p">);</span>
	<span class="n">vdcdc1</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_VDCDC1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OFF</span>:
		<span class="n">chgconfig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TPS65013_AUA</span><span class="p">;</span> <span class="cm">/* disable AUA bit */</span>
		<span class="n">vdcdc1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TPS_ENABLE_LP</span><span class="p">;</span> <span class="cm">/* disable ENABLE_LP bit */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* case ON: */</span>
	<span class="nl">default:</span>
		<span class="n">chgconfig</span> <span class="o">|=</span> <span class="n">TPS65013_AUA</span><span class="p">;</span>  <span class="cm">/* enable AUA bit */</span>
		<span class="n">vdcdc1</span> <span class="o">|=</span> <span class="n">TPS_ENABLE_LP</span><span class="p">;</span>  <span class="cm">/* enable ENABLE_LP bit */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
			<span class="n">TPS_CHGCONFIG</span><span class="p">,</span> <span class="n">chgconfig</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed to write chconfig register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">DRIVER_NAME</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chgconfig</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_CHGCONFIG</span><span class="p">);</span>
	<span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">chgconf</span> <span class="o">=</span> <span class="n">chgconfig</span><span class="p">;</span>
	<span class="n">show_chgconfig</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;chgconf&quot;</span><span class="p">,</span> <span class="n">chgconfig</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
			<span class="n">TPS_VDCDC1</span><span class="p">,</span> <span class="n">vdcdc1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed to write vdcdc1 register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 <span class="n">DRIVER_NAME</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: vdcdc1 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
			<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">TPS_VDCDC1</span><span class="p">));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_tps</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tps65013_set_low_pwr</span><span class="p">);</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tps_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">tries</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">DRIVER_VERSION</span><span class="p">);</span>

	<span class="cm">/* some boards have startup glitches */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tries</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps65010_driver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">the_tps</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps65010_driver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no chip?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: re-probe ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* NOTE:  this MUST be initialized before the other parts of the system</span>
<span class="cm"> * that rely on it ... but after the i2c bus on which this relies.</span>
<span class="cm"> * That is, much earlier than on PC-type systems, which don&#39;t often use</span>
<span class="cm"> * I2C as a core system bus.</span>
<span class="cm"> */</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">tps_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">tps_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tps65010_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">tps_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
