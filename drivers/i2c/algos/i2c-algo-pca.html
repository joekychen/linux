<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › i2c › algos › i2c-algo-pca.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>i2c-algo-pca.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  i2c-algo-pca.c i2c driver algorithms for PCA9564 adapters</span>
<span class="cm"> *    Copyright (C) 2004 Arcom Control Systems</span>
<span class="cm"> *    Copyright (C) 2008 Pengutronix</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,</span>
<span class="cm"> *  MA 02110-1301 USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/i2c-algo-pca.h&gt;</span>

<span class="cp">#define DEB1(fmt, args...) do { if (i2c_debug &gt;= 1)			\</span>
<span class="cp">				 printk(KERN_DEBUG fmt, ## args); } while (0)</span>
<span class="cp">#define DEB2(fmt, args...) do { if (i2c_debug &gt;= 2)			\</span>
<span class="cp">				 printk(KERN_DEBUG fmt, ## args); } while (0)</span>
<span class="cp">#define DEB3(fmt, args...) do { if (i2c_debug &gt;= 3)			\</span>
<span class="cp">				 printk(KERN_DEBUG fmt, ## args); } while (0)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">i2c_debug</span><span class="p">;</span>

<span class="cp">#define pca_outw(adap, reg, val) adap-&gt;write_byte(adap-&gt;data, reg, val)</span>
<span class="cp">#define pca_inw(adap, reg) adap-&gt;read_byte(adap-&gt;data, reg)</span>

<span class="cp">#define pca_status(adap) pca_inw(adap, I2C_PCA_STA)</span>
<span class="cp">#define pca_clock(adap) adap-&gt;i2c_clock</span>
<span class="cp">#define pca_set_con(adap, val) pca_outw(adap, I2C_PCA_CON, val)</span>
<span class="cp">#define pca_get_con(adap) pca_inw(adap, I2C_PCA_CON)</span>
<span class="cp">#define pca_wait(adap) adap-&gt;wait_for_completion(adap-&gt;data)</span>
<span class="cp">#define pca_reset(adap) adap-&gt;reset_chip(adap-&gt;data)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pca9665_reset</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_algo_pca_data</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">pd</span><span class="p">;</span>
	<span class="n">pca_outw</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">I2C_PCA_INDPTR</span><span class="p">,</span> <span class="n">I2C_PCA_IPRESET</span><span class="p">);</span>
	<span class="n">pca_outw</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">I2C_PCA_IND</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">);</span>
	<span class="n">pca_outw</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">I2C_PCA_IND</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Generate a start condition on the i2c bus.</span>
<span class="cm"> *</span>
<span class="cm"> * returns after the start condition has occurred</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pca_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_algo_pca_data</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sta</span> <span class="o">=</span> <span class="n">pca_get_con</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="n">DEB2</span><span class="p">(</span><span class="s">&quot;=== START</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">|=</span> <span class="n">I2C_PCA_CON_STA</span><span class="p">;</span>
	<span class="n">sta</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">I2C_PCA_CON_STO</span><span class="o">|</span><span class="n">I2C_PCA_CON_SI</span><span class="p">);</span>
	<span class="n">pca_set_con</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pca_wait</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Generate a repeated start condition on the i2c bus</span>
<span class="cm"> *</span>
<span class="cm"> * return after the repeated start condition has occurred</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pca_repeated_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_algo_pca_data</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sta</span> <span class="o">=</span> <span class="n">pca_get_con</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="n">DEB2</span><span class="p">(</span><span class="s">&quot;=== REPEATED START</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">|=</span> <span class="n">I2C_PCA_CON_STA</span><span class="p">;</span>
	<span class="n">sta</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">I2C_PCA_CON_STO</span><span class="o">|</span><span class="n">I2C_PCA_CON_SI</span><span class="p">);</span>
	<span class="n">pca_set_con</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pca_wait</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Generate a stop condition on the i2c bus</span>
<span class="cm"> *</span>
<span class="cm"> * returns after the stop condition has been generated</span>
<span class="cm"> *</span>
<span class="cm"> * STOPs do not generate an interrupt or set the SI flag, since the</span>
<span class="cm"> * part returns the idle state (0xf8). Hence we don&#39;t need to</span>
<span class="cm"> * pca_wait here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pca_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_algo_pca_data</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sta</span> <span class="o">=</span> <span class="n">pca_get_con</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="n">DEB2</span><span class="p">(</span><span class="s">&quot;=== STOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">|=</span> <span class="n">I2C_PCA_CON_STO</span><span class="p">;</span>
	<span class="n">sta</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">I2C_PCA_CON_STA</span><span class="o">|</span><span class="n">I2C_PCA_CON_SI</span><span class="p">);</span>
	<span class="n">pca_set_con</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send the slave address and R/W bit</span>
<span class="cm"> *</span>
<span class="cm"> * returns after the address has been sent</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pca_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_algo_pca_data</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sta</span> <span class="o">=</span> <span class="n">pca_get_con</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0x7f</span> <span class="o">&amp;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">DEB2</span><span class="p">(</span><span class="s">&quot;=== SLAVE ADDRESS %#04x+%c=%#04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">msg</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span> <span class="o">?</span> <span class="sc">&#39;R&#39;</span> <span class="o">:</span> <span class="sc">&#39;W&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="n">pca_outw</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">I2C_PCA_DAT</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="n">sta</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">I2C_PCA_CON_STO</span><span class="o">|</span><span class="n">I2C_PCA_CON_STA</span><span class="o">|</span><span class="n">I2C_PCA_CON_SI</span><span class="p">);</span>
	<span class="n">pca_set_con</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pca_wait</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Transmit a byte.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns after the byte has been transmitted</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pca_tx_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_algo_pca_data</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span>
		       <span class="n">__u8</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sta</span> <span class="o">=</span> <span class="n">pca_get_con</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="n">DEB2</span><span class="p">(</span><span class="s">&quot;=== WRITE %#04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="n">pca_outw</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">I2C_PCA_DAT</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

	<span class="n">sta</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">I2C_PCA_CON_STO</span><span class="o">|</span><span class="n">I2C_PCA_CON_STA</span><span class="o">|</span><span class="n">I2C_PCA_CON_SI</span><span class="p">);</span>
	<span class="n">pca_set_con</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pca_wait</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Receive a byte</span>
<span class="cm"> *</span>
<span class="cm"> * returns immediately.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pca_rx_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_algo_pca_data</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span>
			<span class="n">__u8</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ack</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">pca_inw</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">I2C_PCA_DAT</span><span class="p">);</span>
	<span class="n">DEB2</span><span class="p">(</span><span class="s">&quot;=== READ %#04x %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="n">ack</span> <span class="o">?</span> <span class="s">&quot;ACK&quot;</span> <span class="o">:</span> <span class="s">&quot;NACK&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup ACK or NACK for next received byte and wait for it to arrive.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns after next byte has arrived.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pca_rx_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_algo_pca_data</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">ack</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sta</span> <span class="o">=</span> <span class="n">pca_get_con</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>

	<span class="n">sta</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">I2C_PCA_CON_STO</span><span class="o">|</span><span class="n">I2C_PCA_CON_STA</span><span class="o">|</span><span class="n">I2C_PCA_CON_SI</span><span class="o">|</span><span class="n">I2C_PCA_CON_AA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ack</span><span class="p">)</span>
		<span class="n">sta</span> <span class="o">|=</span> <span class="n">I2C_PCA_CON_AA</span><span class="p">;</span>

	<span class="n">pca_set_con</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pca_wait</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pca_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msgs</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_algo_pca_data</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">i2c_adap</span><span class="o">-&gt;</span><span class="n">algo_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">curmsg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numbytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">completed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">i2c_adap</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">state</span> <span class="o">=</span> <span class="n">pca_status</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bus is not idle. status is &quot;</span>
				<span class="s">&quot;%#04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DEB1</span><span class="p">(</span><span class="s">&quot;{{{ XFER %d messages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_debug</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">curmsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">curmsg</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">curmsg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msgs</span><span class="p">[</span><span class="n">curmsg</span><span class="p">];</span>

			<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x7f</span> <span class="o">&amp;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    [%02d] RD %d bytes from %#02x [%#02x, ...]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">curmsg</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    [%02d] WR %d bytes to %#02x [%#02x%s&quot;</span><span class="p">,</span>
				       <span class="n">curmsg</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>
				       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;, &quot;</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%#04x%s&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span> <span class="o">==</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;, &quot;</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">curmsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">curmsg</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">pca_status</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>

		<span class="n">DEB3</span><span class="p">(</span><span class="s">&quot;STATE is 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msgs</span><span class="p">[</span><span class="n">curmsg</span><span class="p">];</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0xf8</span>: <span class="cm">/* On reset or stop the bus is idle */</span>
			<span class="n">completed</span> <span class="o">=</span> <span class="n">pca_start</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x08</span>: <span class="cm">/* A START condition has been transmitted */</span>
		<span class="k">case</span> <span class="mh">0x10</span>: <span class="cm">/* A repeated start condition has been transmitted */</span>
			<span class="n">completed</span> <span class="o">=</span> <span class="n">pca_address</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x18</span>: <span class="cm">/* SLA+W has been transmitted; ACK has been received */</span>
		<span class="k">case</span> <span class="mh">0x28</span>: <span class="cm">/* Data byte in I2CDAT has been transmitted; ACK has been received */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">numbytes</span> <span class="o">&lt;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">completed</span> <span class="o">=</span> <span class="n">pca_tx_byte</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span>
							<span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">numbytes</span><span class="p">]);</span>
				<span class="n">numbytes</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">curmsg</span><span class="o">++</span><span class="p">;</span> <span class="n">numbytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">curmsg</span> <span class="o">==</span> <span class="n">num</span><span class="p">)</span>
				<span class="n">pca_stop</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">completed</span> <span class="o">=</span> <span class="n">pca_repeated_start</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x20</span>: <span class="cm">/* SLA+W has been transmitted; NOT ACK has been received */</span>
			<span class="n">DEB2</span><span class="p">(</span><span class="s">&quot;NOT ACK received after SLA+W</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pca_stop</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x40</span>: <span class="cm">/* SLA+R has been transmitted; ACK has been received */</span>
			<span class="n">completed</span> <span class="o">=</span> <span class="n">pca_rx_ack</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x50</span>: <span class="cm">/* Data bytes has been received; ACK has been returned */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">numbytes</span> <span class="o">&lt;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pca_rx_byte</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">numbytes</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">numbytes</span><span class="o">++</span><span class="p">;</span>
				<span class="n">completed</span> <span class="o">=</span> <span class="n">pca_rx_ack</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span>
						       <span class="n">numbytes</span> <span class="o">&lt;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">curmsg</span><span class="o">++</span><span class="p">;</span> <span class="n">numbytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">curmsg</span> <span class="o">==</span> <span class="n">num</span><span class="p">)</span>
				<span class="n">pca_stop</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">completed</span> <span class="o">=</span> <span class="n">pca_repeated_start</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x48</span>: <span class="cm">/* SLA+R has been transmitted; NOT ACK has been received */</span>
			<span class="n">DEB2</span><span class="p">(</span><span class="s">&quot;NOT ACK received after SLA+R</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pca_stop</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x30</span>: <span class="cm">/* Data byte in I2CDAT has been transmitted; NOT ACK has been received */</span>
			<span class="n">DEB2</span><span class="p">(</span><span class="s">&quot;NOT ACK received after data byte</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pca_stop</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x38</span>: <span class="cm">/* Arbitration lost during SLA+W, SLA+R or data bytes */</span>
			<span class="n">DEB2</span><span class="p">(</span><span class="s">&quot;Arbitration lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * The PCA9564 data sheet (2006-09-01) says &quot;A</span>
<span class="cm">			 * START condition will be transmitted when the</span>
<span class="cm">			 * bus becomes free (STOP or SCL and SDA high)&quot;</span>
<span class="cm">			 * when the STA bit is set (p. 11).</span>
<span class="cm">			 *</span>
<span class="cm">			 * In case this won&#39;t work, try pca_reset()</span>
<span class="cm">			 * instead.</span>
<span class="cm">			 */</span>
			<span class="n">pca_start</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x58</span>: <span class="cm">/* Data byte has been received; NOT ACK has been returned */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">numbytes</span> <span class="o">==</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pca_rx_byte</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">numbytes</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">curmsg</span><span class="o">++</span><span class="p">;</span> <span class="n">numbytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">curmsg</span> <span class="o">==</span> <span class="n">num</span><span class="p">)</span>
					<span class="n">pca_stop</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">completed</span> <span class="o">=</span> <span class="n">pca_repeated_start</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DEB2</span><span class="p">(</span><span class="s">&quot;NOT ACK sent after data byte received. &quot;</span>
				     <span class="s">&quot;Not final byte. numbytes %d. len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">numbytes</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="n">pca_stop</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x70</span>: <span class="cm">/* Bus error - SDA stuck low */</span>
			<span class="n">DEB2</span><span class="p">(</span><span class="s">&quot;BUS ERROR - SDA Stuck low</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pca_reset</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x90</span>: <span class="cm">/* Bus error - SCL stuck low */</span>
			<span class="n">DEB2</span><span class="p">(</span><span class="s">&quot;BUS ERROR - SCL Stuck low</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pca_reset</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x00</span>: <span class="cm">/* Bus error during master or slave mode due to illegal START or STOP condition */</span>
			<span class="n">DEB2</span><span class="p">(</span><span class="s">&quot;BUS ERROR - Illegal START or STOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pca_reset</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unhandled SIO state 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">completed</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">curmsg</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">DEB1</span><span class="p">(</span><span class="s">&quot;}}} transferred %d/%d messages. &quot;</span>
	     <span class="s">&quot;status is %#04x. control is %#04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">curmsg</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">pca_status</span><span class="p">(</span><span class="n">adap</span><span class="p">),</span>
	     <span class="n">pca_get_con</span><span class="p">(</span><span class="n">adap</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">pca_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">I2C_FUNC_I2C</span> <span class="o">|</span> <span class="n">I2C_FUNC_SMBUS_EMUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">pca_algo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span>	<span class="o">=</span> <span class="n">pca_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span>	<span class="o">=</span> <span class="n">pca_func</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pca_probe_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_algo_pca_data</span> <span class="o">*</span><span class="n">pca_data</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">algo_data</span><span class="p">;</span>
	<span class="cm">/* The trick here is to check if there is an indirect register</span>
<span class="cm">	 * available. If there is one, we will read the value we first</span>
<span class="cm">	 * wrote on I2C_PCA_IADR. Otherwise, we will read the last value</span>
<span class="cm">	 * we wrote on I2C_PCA_ADR</span>
<span class="cm">	 */</span>
	<span class="n">pca_outw</span><span class="p">(</span><span class="n">pca_data</span><span class="p">,</span> <span class="n">I2C_PCA_INDPTR</span><span class="p">,</span> <span class="n">I2C_PCA_IADR</span><span class="p">);</span>
	<span class="n">pca_outw</span><span class="p">(</span><span class="n">pca_data</span><span class="p">,</span> <span class="n">I2C_PCA_IND</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">);</span>
	<span class="n">pca_outw</span><span class="p">(</span><span class="n">pca_data</span><span class="p">,</span> <span class="n">I2C_PCA_INDPTR</span><span class="p">,</span> <span class="n">I2C_PCA_ITO</span><span class="p">);</span>
	<span class="n">pca_outw</span><span class="p">(</span><span class="n">pca_data</span><span class="p">,</span> <span class="n">I2C_PCA_IND</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">pca_outw</span><span class="p">(</span><span class="n">pca_data</span><span class="p">,</span> <span class="n">I2C_PCA_INDPTR</span><span class="p">,</span> <span class="n">I2C_PCA_IADR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pca_inw</span><span class="p">(</span><span class="n">pca_data</span><span class="p">,</span> <span class="n">I2C_PCA_IND</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xAA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: PCA9665 detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">I2C_PCA_CHIP_9665</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: PCA9564 detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">I2C_PCA_CHIP_9564</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pca_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_algo_pca_data</span> <span class="o">*</span><span class="n">pca_data</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">algo_data</span><span class="p">;</span>

	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pca_algo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pca_probe_chip</span><span class="p">(</span><span class="n">adap</span><span class="p">)</span> <span class="o">==</span> <span class="n">I2C_PCA_CHIP_9564</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">freqs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">330</span><span class="p">,</span> <span class="mi">288</span><span class="p">,</span> <span class="mi">217</span><span class="p">,</span> <span class="mi">146</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">36</span><span class="p">};</span>
		<span class="kt">int</span> <span class="n">clock</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">330000</span>:
				<span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">=</span> <span class="n">I2C_PCA_CON_330kHz</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">288000</span>:
				<span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">=</span> <span class="n">I2C_PCA_CON_288kHz</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">217000</span>:
				<span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">=</span> <span class="n">I2C_PCA_CON_217kHz</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">146000</span>:
				<span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">=</span> <span class="n">I2C_PCA_CON_146kHz</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">88000</span>:
				<span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">=</span> <span class="n">I2C_PCA_CON_88kHz</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">59000</span>:
				<span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">=</span> <span class="n">I2C_PCA_CON_59kHz</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">44000</span>:
				<span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">=</span> <span class="n">I2C_PCA_CON_44kHz</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">36000</span>:
				<span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">=</span> <span class="n">I2C_PCA_CON_36kHz</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					<span class="s">&quot;%s: Invalid I2C clock speed selected.&quot;</span>
					<span class="s">&quot; Using default 59kHz.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">=</span> <span class="n">I2C_PCA_CON_59kHz</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: &quot;</span>
				<span class="s">&quot;Choosing the clock frequency based on &quot;</span>
				<span class="s">&quot;index is deprecated.&quot;</span>
				<span class="s">&quot; Use the nominal frequency.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pca_reset</span><span class="p">(</span><span class="n">pca_data</span><span class="p">);</span>

		<span class="n">clock</span> <span class="o">=</span> <span class="n">pca_clock</span><span class="p">(</span><span class="n">pca_data</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Clock frequency is %dkHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">adap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">freqs</span><span class="p">[</span><span class="n">clock</span><span class="p">]);</span>

		<span class="n">pca_set_con</span><span class="p">(</span><span class="n">pca_data</span><span class="p">,</span> <span class="n">I2C_PCA_CON_ENSIO</span> <span class="o">|</span> <span class="n">clock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">clock</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tlow</span><span class="p">,</span> <span class="n">thi</span><span class="p">;</span>
		<span class="cm">/* Values can be found on PCA9665 datasheet section 7.3.2.6 */</span>
		<span class="kt">int</span> <span class="n">min_tlow</span><span class="p">,</span> <span class="n">min_thi</span><span class="p">;</span>
		<span class="cm">/* These values are the maximum raise and fall values allowed</span>
<span class="cm">		 * by the I2C operation mode (Standard, Fast or Fast+)</span>
<span class="cm">		 * They are used (added) below to calculate the clock dividers</span>
<span class="cm">		 * of PCA9665. Note that they are slightly different of the</span>
<span class="cm">		 * real maximum, to allow the change on mode exactly on the</span>
<span class="cm">		 * maximum clock rate for each mode</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">raise_fall_time</span><span class="p">;</span>

		<span class="cm">/* Ignore the reset function from the module,</span>
<span class="cm">		 * we can use the parallel bus reset</span>
<span class="cm">		 */</span>
		<span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">reset_chip</span> <span class="o">=</span> <span class="n">pca9665_reset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">&gt;</span> <span class="mi">1265800</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: I2C clock speed too high.&quot;</span>
				<span class="s">&quot; Using 1265.8kHz.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">=</span> <span class="mi">1265800</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">&lt;</span> <span class="mi">60300</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: I2C clock speed too low.&quot;</span>
				<span class="s">&quot; Using 60.3kHz.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">=</span> <span class="mi">60300</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* To avoid integer overflow, use clock/100 for calculations */</span>
		<span class="n">clock</span> <span class="o">=</span> <span class="n">pca_clock</span><span class="p">(</span><span class="n">pca_data</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">I2C_PCA_MODE_TURBO</span><span class="p">;</span>
			<span class="n">min_tlow</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
			<span class="n">min_thi</span>  <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">raise_fall_time</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span> <span class="cm">/* Raise 11e-8s, Fall 11e-8s */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">I2C_PCA_MODE_FASTP</span><span class="p">;</span>
			<span class="n">min_tlow</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
			<span class="n">min_thi</span>  <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
			<span class="n">raise_fall_time</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span> <span class="cm">/* Raise 11e-8s, Fall 11e-8s */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pca_data</span><span class="o">-&gt;</span><span class="n">i2c_clock</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">I2C_PCA_MODE_FAST</span><span class="p">;</span>
			<span class="n">min_tlow</span> <span class="o">=</span> <span class="mi">44</span><span class="p">;</span>
			<span class="n">min_thi</span>  <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
			<span class="n">raise_fall_time</span> <span class="o">=</span> <span class="mi">58</span><span class="p">;</span> <span class="cm">/* Raise 29e-8s, Fall 29e-8s */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">I2C_PCA_MODE_STD</span><span class="p">;</span>
			<span class="n">min_tlow</span> <span class="o">=</span> <span class="mi">157</span><span class="p">;</span>
			<span class="n">min_thi</span>  <span class="o">=</span> <span class="mi">134</span><span class="p">;</span>
			<span class="n">raise_fall_time</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span> <span class="cm">/* Raise 29e-8s, Fall 98e-8s */</span>
		<span class="p">}</span>

		<span class="cm">/* The minimum clock that respects the thi/tlow = 134/157 is</span>
<span class="cm">		 * 64800 Hz. Below that, we have to fix the tlow to 255 and</span>
<span class="cm">		 * calculate the thi factor.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">&lt;</span> <span class="mi">648</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tlow</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
			<span class="n">thi</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">-</span> <span class="n">clock</span> <span class="o">*</span> <span class="n">raise_fall_time</span><span class="p">;</span>
			<span class="n">thi</span> <span class="o">/=</span> <span class="p">(</span><span class="n">I2C_PCA_OSC_PER</span> <span class="o">*</span> <span class="n">clock</span><span class="p">)</span> <span class="o">-</span> <span class="n">tlow</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tlow</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">-</span> <span class="n">clock</span> <span class="o">*</span> <span class="n">raise_fall_time</span><span class="p">)</span> <span class="o">*</span> <span class="n">min_tlow</span><span class="p">;</span>
			<span class="n">tlow</span> <span class="o">/=</span> <span class="n">I2C_PCA_OSC_PER</span> <span class="o">*</span> <span class="n">clock</span> <span class="o">*</span> <span class="p">(</span><span class="n">min_thi</span> <span class="o">+</span> <span class="n">min_tlow</span><span class="p">);</span>
			<span class="n">thi</span> <span class="o">=</span> <span class="n">tlow</span> <span class="o">*</span> <span class="n">min_thi</span> <span class="o">/</span> <span class="n">min_tlow</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pca_reset</span><span class="p">(</span><span class="n">pca_data</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		     <span class="s">&quot;%s: Clock frequency is %dHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">clock</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>

		<span class="n">pca_outw</span><span class="p">(</span><span class="n">pca_data</span><span class="p">,</span> <span class="n">I2C_PCA_INDPTR</span><span class="p">,</span> <span class="n">I2C_PCA_IMODE</span><span class="p">);</span>
		<span class="n">pca_outw</span><span class="p">(</span><span class="n">pca_data</span><span class="p">,</span> <span class="n">I2C_PCA_IND</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="n">pca_outw</span><span class="p">(</span><span class="n">pca_data</span><span class="p">,</span> <span class="n">I2C_PCA_INDPTR</span><span class="p">,</span> <span class="n">I2C_PCA_ISCLL</span><span class="p">);</span>
		<span class="n">pca_outw</span><span class="p">(</span><span class="n">pca_data</span><span class="p">,</span> <span class="n">I2C_PCA_IND</span><span class="p">,</span> <span class="n">tlow</span><span class="p">);</span>
		<span class="n">pca_outw</span><span class="p">(</span><span class="n">pca_data</span><span class="p">,</span> <span class="n">I2C_PCA_INDPTR</span><span class="p">,</span> <span class="n">I2C_PCA_ISCLH</span><span class="p">);</span>
		<span class="n">pca_outw</span><span class="p">(</span><span class="n">pca_data</span><span class="p">,</span> <span class="n">I2C_PCA_IND</span><span class="p">,</span> <span class="n">thi</span><span class="p">);</span>

		<span class="n">pca_set_con</span><span class="p">(</span><span class="n">pca_data</span><span class="p">,</span> <span class="n">I2C_PCA_CON_ENSIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span> <span class="cm">/* 500 us for oscilator to stabilise */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * registering functions to load algorithms at runtime</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i2c_pca_add_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">pca_init</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i2c_add_adapter</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">i2c_pca_add_bus</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">i2c_pca_add_numbered_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">pca_init</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i2c_add_numbered_adapter</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">i2c_pca_add_numbered_bus</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ian Campbell &lt;icampbell@arcom.com&gt;, &quot;</span>
	<span class="s">&quot;Wolfram Sang &lt;w.sang@pengutronix.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;I2C-Bus PCA9564/PCA9665 algorithm&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">i2c_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
