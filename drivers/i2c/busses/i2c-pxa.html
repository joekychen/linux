<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › i2c › busses › i2c-pxa.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>i2c-pxa.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  i2c_adap_pxa.c</span>
<span class="cm"> *</span>
<span class="cm"> *  I2C adapter for the PXA I2C bus access.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2002 Intrinsyc Software Inc.</span>
<span class="cm"> *  Copyright (C) 2004-2005 Deep Blue Solutions Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> *  published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  History:</span>
<span class="cm"> *    Apr 2002: Initial version [CS]</span>
<span class="cm"> *    Jun 2002: Properly separated algo/adap [FB]</span>
<span class="cm"> *    Jan 2003: Fixed several bugs concerning interrupt handling [Kai-Uwe Bloem]</span>
<span class="cm"> *    Jan 2003: added limited signal handling [Kai-Uwe Bloem]</span>
<span class="cm"> *    Sep 2004: Major rework to ensure efficient bus handling [RMK]</span>
<span class="cm"> *    Dec 2004: Added support for PXA27x and slave device probing [Liam Girdwood]</span>
<span class="cm"> *    Feb 2005: Rework slave mode handling [RMK]</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/i2c-pxa.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>
<span class="cp">#include &lt;linux/of_i2c.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/pxa-i2c.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#ifndef CONFIG_HAVE_CLK</span>
<span class="cp">#define clk_get(dev, id)	NULL</span>
<span class="cp">#define clk_put(clk)		do { } while (0)</span>
<span class="cp">#define clk_disable(clk)	do { } while (0)</span>
<span class="cp">#define clk_enable(clk)		do { } while (0)</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">pxa_reg_layout</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">ibmr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idbr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">icr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">isr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">isar</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">pxa_i2c_types</span> <span class="p">{</span>
	<span class="n">REGS_PXA2XX</span><span class="p">,</span>
	<span class="n">REGS_PXA3XX</span><span class="p">,</span>
	<span class="n">REGS_CE4100</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * I2C registers definitions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pxa_reg_layout</span> <span class="n">pxa_reg_layout</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">REGS_PXA2XX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ibmr</span> <span class="o">=</span>	<span class="mh">0x00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">idbr</span> <span class="o">=</span>	<span class="mh">0x08</span><span class="p">,</span>
		<span class="p">.</span><span class="n">icr</span> <span class="o">=</span>	<span class="mh">0x10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">isr</span> <span class="o">=</span>	<span class="mh">0x18</span><span class="p">,</span>
		<span class="p">.</span><span class="n">isar</span> <span class="o">=</span>	<span class="mh">0x20</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">REGS_PXA3XX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ibmr</span> <span class="o">=</span>	<span class="mh">0x00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">idbr</span> <span class="o">=</span>	<span class="mh">0x04</span><span class="p">,</span>
		<span class="p">.</span><span class="n">icr</span> <span class="o">=</span>	<span class="mh">0x08</span><span class="p">,</span>
		<span class="p">.</span><span class="n">isr</span> <span class="o">=</span>	<span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">isar</span> <span class="o">=</span>	<span class="mh">0x10</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">REGS_CE4100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ibmr</span> <span class="o">=</span>	<span class="mh">0x14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">idbr</span> <span class="o">=</span>	<span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">icr</span> <span class="o">=</span>	<span class="mh">0x00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">isr</span> <span class="o">=</span>	<span class="mh">0x04</span><span class="p">,</span>
		<span class="cm">/* no isar register */</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="n">i2c_pxa_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;pxa2xx-i2c&quot;</span><span class="p">,</span>		<span class="n">REGS_PXA2XX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;pxa3xx-pwri2c&quot;</span><span class="p">,</span>	<span class="n">REGS_PXA3XX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ce4100-i2c&quot;</span><span class="p">,</span>		<span class="n">REGS_CE4100</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">i2c_pxa_id_table</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * I2C bit definitions</span>
<span class="cm"> */</span>

<span class="cp">#define ICR_START	(1 &lt;&lt; 0)	   </span><span class="cm">/* start bit */</span><span class="cp"></span>
<span class="cp">#define ICR_STOP	(1 &lt;&lt; 1)	   </span><span class="cm">/* stop bit */</span><span class="cp"></span>
<span class="cp">#define ICR_ACKNAK	(1 &lt;&lt; 2)	   </span><span class="cm">/* send ACK(0) or NAK(1) */</span><span class="cp"></span>
<span class="cp">#define ICR_TB		(1 &lt;&lt; 3)	   </span><span class="cm">/* transfer byte bit */</span><span class="cp"></span>
<span class="cp">#define ICR_MA		(1 &lt;&lt; 4)	   </span><span class="cm">/* master abort */</span><span class="cp"></span>
<span class="cp">#define ICR_SCLE	(1 &lt;&lt; 5)	   </span><span class="cm">/* master clock enable */</span><span class="cp"></span>
<span class="cp">#define ICR_IUE		(1 &lt;&lt; 6)	   </span><span class="cm">/* unit enable */</span><span class="cp"></span>
<span class="cp">#define ICR_GCD		(1 &lt;&lt; 7)	   </span><span class="cm">/* general call disable */</span><span class="cp"></span>
<span class="cp">#define ICR_ITEIE	(1 &lt;&lt; 8)	   </span><span class="cm">/* enable tx interrupts */</span><span class="cp"></span>
<span class="cp">#define ICR_IRFIE	(1 &lt;&lt; 9)	   </span><span class="cm">/* enable rx interrupts */</span><span class="cp"></span>
<span class="cp">#define ICR_BEIE	(1 &lt;&lt; 10)	   </span><span class="cm">/* enable bus error ints */</span><span class="cp"></span>
<span class="cp">#define ICR_SSDIE	(1 &lt;&lt; 11)	   </span><span class="cm">/* slave STOP detected int enable */</span><span class="cp"></span>
<span class="cp">#define ICR_ALDIE	(1 &lt;&lt; 12)	   </span><span class="cm">/* enable arbitration interrupt */</span><span class="cp"></span>
<span class="cp">#define ICR_SADIE	(1 &lt;&lt; 13)	   </span><span class="cm">/* slave address detected int enable */</span><span class="cp"></span>
<span class="cp">#define ICR_UR		(1 &lt;&lt; 14)	   </span><span class="cm">/* unit reset */</span><span class="cp"></span>
<span class="cp">#define ICR_FM		(1 &lt;&lt; 15)	   </span><span class="cm">/* fast mode */</span><span class="cp"></span>

<span class="cp">#define ISR_RWM		(1 &lt;&lt; 0)	   </span><span class="cm">/* read/write mode */</span><span class="cp"></span>
<span class="cp">#define ISR_ACKNAK	(1 &lt;&lt; 1)	   </span><span class="cm">/* ack/nak status */</span><span class="cp"></span>
<span class="cp">#define ISR_UB		(1 &lt;&lt; 2)	   </span><span class="cm">/* unit busy */</span><span class="cp"></span>
<span class="cp">#define ISR_IBB		(1 &lt;&lt; 3)	   </span><span class="cm">/* bus busy */</span><span class="cp"></span>
<span class="cp">#define ISR_SSD		(1 &lt;&lt; 4)	   </span><span class="cm">/* slave stop detected */</span><span class="cp"></span>
<span class="cp">#define ISR_ALD		(1 &lt;&lt; 5)	   </span><span class="cm">/* arbitration loss detected */</span><span class="cp"></span>
<span class="cp">#define ISR_ITE		(1 &lt;&lt; 6)	   </span><span class="cm">/* tx buffer empty */</span><span class="cp"></span>
<span class="cp">#define ISR_IRF		(1 &lt;&lt; 7)	   </span><span class="cm">/* rx buffer full */</span><span class="cp"></span>
<span class="cp">#define ISR_GCAD	(1 &lt;&lt; 8)	   </span><span class="cm">/* general call address detected */</span><span class="cp"></span>
<span class="cp">#define ISR_SAD		(1 &lt;&lt; 9)	   </span><span class="cm">/* slave address detected */</span><span class="cp"></span>
<span class="cp">#define ISR_BED		(1 &lt;&lt; 10)	   </span><span class="cm">/* bus error no ACK/NAK */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">wait</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span>		<span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">msg_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">msg_idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">msg_ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">slave_addr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">i2c_adapter</span>	<span class="n">adap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>		<span class="o">*</span><span class="n">clk</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_I2C_PXA_SLAVE</span>
	<span class="k">struct</span> <span class="n">i2c_slave_client</span> <span class="o">*</span><span class="n">slave</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">irqlogidx</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">isrlog</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">icrlog</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">reg_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">reg_ibmr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">reg_idbr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">reg_icr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">reg_isr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">reg_isar</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">iobase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">iosize</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">use_pio</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">fast_mode</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define _IBMR(i2c)	((i2c)-&gt;reg_ibmr)</span>
<span class="cp">#define _IDBR(i2c)	((i2c)-&gt;reg_idbr)</span>
<span class="cp">#define _ICR(i2c)	((i2c)-&gt;reg_icr)</span>
<span class="cp">#define _ISR(i2c)	((i2c)-&gt;reg_isr)</span>
<span class="cp">#define _ISAR(i2c)	((i2c)-&gt;reg_isar)</span>

<span class="cm">/*</span>
<span class="cm"> * I2C Slave mode address</span>
<span class="cm"> */</span>
<span class="cp">#define I2C_PXA_SLAVE_ADDR      0x1</span>

<span class="cp">#ifdef DEBUG</span>

<span class="k">struct</span> <span class="n">bits</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">mask</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">set</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">unset</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#define PXA_BIT(m, s, u)	{ .mask = m, .set = s, .unset = u }</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">decode_bits</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">bits</span> <span class="o">*</span><span class="n">bits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s %08x: &quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">bits</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">?</span> <span class="n">bits</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">:</span> <span class="n">bits</span><span class="o">-&gt;</span><span class="n">unset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="n">bits</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">bits</span> <span class="n">isr_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ISR_RWM</span><span class="p">,</span>	<span class="s">&quot;RX&quot;</span><span class="p">,</span>		<span class="s">&quot;TX&quot;</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ISR_ACKNAK</span><span class="p">,</span>	<span class="s">&quot;NAK&quot;</span><span class="p">,</span>		<span class="s">&quot;ACK&quot;</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ISR_UB</span><span class="p">,</span>		<span class="s">&quot;Bsy&quot;</span><span class="p">,</span>		<span class="s">&quot;Rdy&quot;</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ISR_IBB</span><span class="p">,</span>	<span class="s">&quot;BusBsy&quot;</span><span class="p">,</span>	<span class="s">&quot;BusRdy&quot;</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ISR_SSD</span><span class="p">,</span>	<span class="s">&quot;SlaveStop&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ISR_ALD</span><span class="p">,</span>	<span class="s">&quot;ALD&quot;</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ISR_ITE</span><span class="p">,</span>	<span class="s">&quot;TxEmpty&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ISR_IRF</span><span class="p">,</span>	<span class="s">&quot;RxFull&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ISR_GCAD</span><span class="p">,</span>	<span class="s">&quot;GenCall&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ISR_SAD</span><span class="p">,</span>	<span class="s">&quot;SlaveAddr&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ISR_BED</span><span class="p">,</span>	<span class="s">&quot;BusErr&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_ISR</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">decode_bits</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ISR&quot;</span><span class="p">,</span> <span class="n">isr_bits</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">isr_bits</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">bits</span> <span class="n">icr_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ICR_START</span><span class="p">,</span>  <span class="s">&quot;START&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ICR_STOP</span><span class="p">,</span>   <span class="s">&quot;STOP&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ICR_ACKNAK</span><span class="p">,</span> <span class="s">&quot;ACKNAK&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ICR_TB</span><span class="p">,</span>     <span class="s">&quot;TB&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ICR_MA</span><span class="p">,</span>     <span class="s">&quot;MA&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ICR_SCLE</span><span class="p">,</span>   <span class="s">&quot;SCLE&quot;</span><span class="p">,</span>	<span class="s">&quot;scle&quot;</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ICR_IUE</span><span class="p">,</span>    <span class="s">&quot;IUE&quot;</span><span class="p">,</span>	<span class="s">&quot;iue&quot;</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ICR_GCD</span><span class="p">,</span>    <span class="s">&quot;GCD&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ICR_ITEIE</span><span class="p">,</span>  <span class="s">&quot;ITEIE&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ICR_IRFIE</span><span class="p">,</span>  <span class="s">&quot;IRFIE&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ICR_BEIE</span><span class="p">,</span>   <span class="s">&quot;BEIE&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ICR_SSDIE</span><span class="p">,</span>  <span class="s">&quot;SSDIE&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ICR_ALDIE</span><span class="p">,</span>  <span class="s">&quot;ALDIE&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ICR_SADIE</span><span class="p">,</span>  <span class="s">&quot;SADIE&quot;</span><span class="p">,</span>	<span class="nb">NULL</span><span class="p">),</span>
	<span class="n">PXA_BIT</span><span class="p">(</span><span class="n">ICR_UR</span><span class="p">,</span>     <span class="s">&quot;UR&quot;</span><span class="p">,</span>		<span class="s">&quot;ur&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_I2C_PXA_SLAVE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_ICR</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">decode_bits</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ICR&quot;</span><span class="p">,</span> <span class="n">icr_bits</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">icr_bits</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i2c_debug</span> <span class="o">=</span> <span class="n">DEBUG</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_pxa_show_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lno</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;state:%s:%d: ISR=%08x, ICR=%08x, IBMR=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">lno</span><span class="p">,</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">_ISR</span><span class="p">(</span><span class="n">i2c</span><span class="p">)),</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">)),</span> <span class="n">readl</span><span class="p">(</span><span class="n">_IBMR</span><span class="p">(</span><span class="n">i2c</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cp">#define show_state(i2c) i2c_pxa_show_state(i2c, __LINE__, __func__)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_pxa_scream_blue_murder</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">why</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;i2c: error: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">why</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;i2c: msg_num: %d msg_idx: %d msg_ptr: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_num</span><span class="p">,</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_idx</span><span class="p">,</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_ptr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;i2c: ICR: %08x ISR: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">)),</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ISR</span><span class="p">(</span><span class="n">i2c</span><span class="p">)));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;i2c: log: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">irqlogidx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[%08x:%08x] &quot;</span><span class="p">,</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">isrlog</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">icrlog</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* ifdef DEBUG */</span><span class="cp"></span>

<span class="cp">#define i2c_debug	0</span>

<span class="cp">#define show_state(i2c) do { } while (0)</span>
<span class="cp">#define decode_ISR(val) do { } while (0)</span>
<span class="cp">#define decode_ICR(val) do { } while (0)</span>
<span class="cp">#define i2c_pxa_scream_blue_murder(i2c, why) do { } while (0)</span>

<span class="cp">#endif </span><span class="cm">/* ifdef DEBUG / else */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">i2c_pxa_master_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">i2c_pxa_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">this_irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">i2c_pxa_is_slavemode</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ICR_SCLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_pxa_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_pxa_is_slavemode</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: called in slave mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_IBMR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">icr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>

		<span class="n">icr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ICR_START</span><span class="p">;</span>
		<span class="n">icr</span> <span class="o">|=</span> <span class="n">ICR_ACKNAK</span> <span class="o">|</span> <span class="n">ICR_STOP</span> <span class="o">|</span> <span class="n">ICR_TB</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">icr</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>

		<span class="n">show_state</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ICR_MA</span> <span class="o">|</span> <span class="n">ICR_START</span> <span class="o">|</span> <span class="n">ICR_STOP</span><span class="p">),</span>
	       <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_pxa_wait_bus_not_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">DEF_TIMEOUT</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ISR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ISR_IBB</span> <span class="o">|</span> <span class="n">ISR_UB</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">_ISR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ISR_SAD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">timeout</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">show_state</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">show_state</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">I2C_RETRY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_pxa_wait_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2c_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %ld: ISR=%08x, ICR=%08x, IBMR=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ISR</span><span class="p">(</span><span class="n">i2c</span><span class="p">)),</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">)),</span> <span class="n">readl</span><span class="p">(</span><span class="n">_IBMR</span><span class="p">(</span><span class="n">i2c</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ISR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ISR_SAD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i2c_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Slave detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* wait for unit and bus being not busy, and we also do a</span>
<span class="cm">		 * quick check of the i2c lines themselves to ensure they&#39;ve</span>
<span class="cm">		 * gone high...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">_ISR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ISR_UB</span> <span class="o">|</span> <span class="n">ISR_IBB</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">readl</span><span class="p">(</span><span class="n">_IBMR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i2c_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: did not free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_pxa_set_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_debug</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setting to bus master</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">_ISR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ISR_UB</span> <span class="o">|</span> <span class="n">ISR_IBB</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: unit is busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_pxa_wait_master</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: error: unit busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">I2C_RETRY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">|</span> <span class="n">ICR_SCLE</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_I2C_PXA_SLAVE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_pxa_wait_slave</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">*</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* wait for stop */</span>

	<span class="n">show_state</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2c_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %ld: ISR=%08x, ICR=%08x, IBMR=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ISR</span><span class="p">(</span><span class="n">i2c</span><span class="p">)),</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">)),</span> <span class="n">readl</span><span class="p">(</span><span class="n">_IBMR</span><span class="p">(</span><span class="n">i2c</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">_ISR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ISR_UB</span><span class="o">|</span><span class="n">ISR_IBB</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ISR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ISR_SAD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ICR_SCLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i2c_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: did not free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * clear the hold on the bus, and take of anything else</span>
<span class="cm"> * that has been configured</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_pxa_set_slave</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">errcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_state</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">errcode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>   <span class="cm">/* simple delay */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* we need to wait for the stop condition to end */</span>

		<span class="cm">/* if we where in stop, then clear... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ICR_STOP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ICR_STOP</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_pxa_wait_slave</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: wait timedout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ICR_STOP</span><span class="o">|</span><span class="n">ICR_ACKNAK</span><span class="o">|</span><span class="n">ICR_MA</span><span class="p">),</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ICR_SCLE</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ICR now %08x, ISR %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">)),</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ISR</span><span class="p">(</span><span class="n">i2c</span><span class="p">)));</span>
		<span class="n">decode_ICR</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">)));</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define i2c_pxa_set_slave(i2c, err)	do { } while (0)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_pxa_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Resetting I2C Controller Unit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* abort any transfer currently under way */</span>
	<span class="n">i2c_pxa_abort</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>

	<span class="cm">/* reset according to 9.8 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ICR_UR</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">I2C_ISR_INIT</span><span class="p">,</span> <span class="n">_ISR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ICR_UR</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">reg_isar</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">,</span> <span class="n">_ISAR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>

	<span class="cm">/* set control register values */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">I2C_ICR_INIT</span> <span class="o">|</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">fast_mode</span> <span class="o">?</span> <span class="n">ICR_FM</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_I2C_PXA_SLAVE</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Enabling slave mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">|</span> <span class="n">ICR_SADIE</span> <span class="o">|</span> <span class="n">ICR_ALDIE</span> <span class="o">|</span> <span class="n">ICR_SSDIE</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="n">i2c_pxa_set_slave</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* enable unit */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">|</span> <span class="n">ICR_IUE</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_I2C_PXA_SLAVE</span>
<span class="cm">/*</span>
<span class="cm"> * PXA I2C Slave mode</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_pxa_slave_txempty</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="n">u32</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_BED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* what should we do here? */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">_IDBR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">|</span> <span class="n">ICR_TB</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>   <span class="cm">/* allow next byte */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_pxa_slave_rxfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="n">u32</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">byte</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">_IDBR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">|</span> <span class="n">ICR_TB</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_pxa_slave_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="n">u32</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SAD, mode is slave-%cx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_RWM</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;r&#39;</span> <span class="o">:</span> <span class="sc">&#39;t&#39;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_RWM</span><span class="p">)</span> <span class="o">?</span> <span class="n">I2C_SLAVE_EVENT_START_READ</span> <span class="o">:</span> <span class="n">I2C_SLAVE_EVENT_START_WRITE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * slave could interrupt in the middle of us generating a</span>
<span class="cm">	 * start condition... if this happens, we&#39;d better back off</span>
<span class="cm">	 * and stop holding the poor thing up</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ICR_START</span><span class="o">|</span><span class="n">ICR_STOP</span><span class="p">),</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">|</span> <span class="n">ICR_TB</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">_IBMR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout waiting for SCL high</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ICR_SCLE</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_pxa_slave_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ISR: SSD (Slave Stop)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">I2C_SLAVE_EVENT_STOP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ISR: SSD (Slave Stop) acked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we have a master-mode message waiting,</span>
<span class="cm">	 * kick it off now that the slave has completed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">)</span>
		<span class="n">i2c_pxa_master_complete</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">I2C_RETRY</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_pxa_slave_txempty</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="n">u32</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_BED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* what should we do here? */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_IDBR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">|</span> <span class="n">ICR_TB</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_pxa_slave_rxfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="n">u32</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">|</span> <span class="n">ICR_TB</span> <span class="o">|</span> <span class="n">ICR_ACKNAK</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_pxa_slave_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="n">u32</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * slave could interrupt in the middle of us generating a</span>
<span class="cm">	 * start condition... if this happens, we&#39;d better back off</span>
<span class="cm">	 * and stop holding the poor thing up</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ICR_START</span><span class="o">|</span><span class="n">ICR_STOP</span><span class="p">),</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">|</span> <span class="n">ICR_TB</span> <span class="o">|</span> <span class="n">ICR_ACKNAK</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">_IBMR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout waiting for SCL high</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ICR_SCLE</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_pxa_slave_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">)</span>
		<span class="n">i2c_pxa_master_complete</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">I2C_RETRY</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * PXA I2C Master mode</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">i2c_pxa_addr_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">i2c_pxa_start_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">icr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Step 1: target slave address into IDBR</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">i2c_pxa_addr_byte</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">),</span> <span class="n">_IDBR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Step 2: initiate the write.</span>
<span class="cm">	 */</span>
	<span class="n">icr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ICR_STOP</span> <span class="o">|</span> <span class="n">ICR_ALDIE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">icr</span> <span class="o">|</span> <span class="n">ICR_START</span> <span class="o">|</span> <span class="n">ICR_TB</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">i2c_pxa_stop_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">icr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the STOP and ACK flags</span>
<span class="cm">	 */</span>
	<span class="n">icr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
	<span class="n">icr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ICR_STOP</span> <span class="o">|</span> <span class="n">ICR_ACKNAK</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">icr</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_pxa_pio_set_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* make timeout the same as for interrupt based functions */</span>
	<span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">DEF_TIMEOUT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for the bus to become free.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ISR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ISR_IBB</span> <span class="o">|</span> <span class="n">ISR_UB</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">show_state</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">show_state</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;i2c_pxa: timeout waiting for bus free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">I2C_RETRY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set master mode.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">|</span> <span class="n">ICR_SCLE</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_pxa_do_pio_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">500000</span><span class="p">;</span> <span class="cm">/* 5 seconds */</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_pxa_pio_set_master</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_num</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">irqlogidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">i2c_pxa_start_message</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_num</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c_pxa_handler</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i2c</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i2c_pxa_stop_message</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We place the return code in i2c-&gt;msg_idx.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_idx</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i2c_pxa_scream_blue_murder</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;timeout&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We are protected by the adapter bus mutex.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_pxa_do_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for the bus to become free.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_pxa_wait_bus_not_busy</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;i2c_pxa: timeout waiting for bus free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set master mode.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_pxa_set_master</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;i2c_pxa_set_master: error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_num</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">irqlogidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">i2c_pxa_start_message</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The rest of the processing occurs in the interrupt handler.</span>
<span class="cm">	 */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">i2c_pxa_stop_message</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We place the return code in i2c-&gt;msg_idx.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c_pxa_scream_blue_murder</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;timeout&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">I2C_RETRY</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_pxa_pio_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">algo_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* If the I2C controller is disabled we need to reset it</span>
<span class="cm">	  (probably due to a suspend/resume destroying state). We do</span>
<span class="cm">	  this here as we can then avoid worrying about resuming the</span>
<span class="cm">	  controller before its users. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ICR_IUE</span><span class="p">))</span>
		<span class="n">i2c_pxa_reset</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_pxa_do_pio_xfer</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">I2C_RETRY</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i2c_debug</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Retrying transmission</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">i2c_pxa_scream_blue_murder</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;exhausted retries&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">i2c_pxa_set_slave</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * i2c_pxa_master_complete - complete the message and wake up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_pxa_master_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_idx</span> <span class="o">++</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_idx</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">use_pio</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_pxa_irq_txempty</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="n">u32</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">icr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ICR_START</span><span class="o">|</span><span class="n">ICR_STOP</span><span class="o">|</span><span class="n">ICR_ACKNAK</span><span class="o">|</span><span class="n">ICR_TB</span><span class="p">);</span>

 <span class="nl">again:</span>
	<span class="cm">/*</span>
<span class="cm">	 * If ISR_ALD is set, we lost arbitration.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_ALD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Do we need to do anything here?  The PXA docs</span>
<span class="cm">		 * are vague about what happens.</span>
<span class="cm">		 */</span>
		<span class="n">i2c_pxa_scream_blue_murder</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;ALD set&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * We ignore this error.  We seem to see spurious ALDs</span>
<span class="cm">		 * for seemingly no reason.  If we handle them as I think</span>
<span class="cm">		 * they should, we end up causing an I2C error, which</span>
<span class="cm">		 * is painful for some systems.</span>
<span class="cm">		 */</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* ignore */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_BED</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">BUS_ERROR</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * I2C bus error - either the device NAK&#39;d us, or</span>
<span class="cm">		 * something more serious happened.  If we were NAK&#39;d</span>
<span class="cm">		 * on the initial address phase, we can retry.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_ACKNAK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_ptr</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">I2C_RETRY</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">XFER_NAKED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i2c_pxa_master_complete</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_RWM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Read mode.  We have just sent the address byte, and</span>
<span class="cm">		 * now we must initiate the transfer.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_ptr</span> <span class="o">==</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_idx</span> <span class="o">==</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">icr</span> <span class="o">|=</span> <span class="n">ICR_STOP</span> <span class="o">|</span> <span class="n">ICR_ACKNAK</span><span class="p">;</span>

		<span class="n">icr</span> <span class="o">|=</span> <span class="n">ICR_ALDIE</span> <span class="o">|</span> <span class="n">ICR_TB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_ptr</span> <span class="o">&lt;</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Write mode.  Write the next data byte.</span>
<span class="cm">		 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_ptr</span><span class="o">++</span><span class="p">],</span> <span class="n">_IDBR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>

		<span class="n">icr</span> <span class="o">|=</span> <span class="n">ICR_ALDIE</span> <span class="o">|</span> <span class="n">ICR_TB</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If this is the last byte of the last message, send</span>
<span class="cm">		 * a STOP.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_ptr</span> <span class="o">==</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;&amp;</span>
		    <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_idx</span> <span class="o">==</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">icr</span> <span class="o">|=</span> <span class="n">ICR_STOP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_idx</span> <span class="o">&lt;</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Next segment of the message.</span>
<span class="cm">		 */</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_idx</span> <span class="o">++</span><span class="p">;</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we aren&#39;t doing a repeated start and address,</span>
<span class="cm">		 * go back and try to send the next byte.  Note that</span>
<span class="cm">		 * we do not support switching the R/W direction here.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_NOSTART</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Write the next address.</span>
<span class="cm">		 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">i2c_pxa_addr_byte</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">),</span> <span class="n">_IDBR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * And trigger a repeated start, and send the byte.</span>
<span class="cm">		 */</span>
		<span class="n">icr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ICR_ALDIE</span><span class="p">;</span>
		<span class="n">icr</span> <span class="o">|=</span> <span class="n">ICR_START</span> <span class="o">|</span> <span class="n">ICR_TB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Device probes have a message length of zero</span>
<span class="cm">			 * and need the bus to be reset before it can</span>
<span class="cm">			 * be used again.</span>
<span class="cm">			 */</span>
			<span class="n">i2c_pxa_reset</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">i2c_pxa_master_complete</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">icrlog</span><span class="p">[</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">irqlogidx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">icr</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">icr</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
	<span class="n">show_state</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_pxa_irq_rxfull</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span> <span class="n">u32</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">icr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ICR_START</span><span class="o">|</span><span class="n">ICR_STOP</span><span class="o">|</span><span class="n">ICR_ACKNAK</span><span class="o">|</span><span class="n">ICR_TB</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read the byte.</span>
<span class="cm">	 */</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_ptr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">_IDBR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_ptr</span> <span class="o">&lt;</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If this is the last byte of the last</span>
<span class="cm">		 * message, send a STOP.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg_ptr</span> <span class="o">==</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">icr</span> <span class="o">|=</span> <span class="n">ICR_STOP</span> <span class="o">|</span> <span class="n">ICR_ACKNAK</span><span class="p">;</span>

		<span class="n">icr</span> <span class="o">|=</span> <span class="n">ICR_ALDIE</span> <span class="o">|</span> <span class="n">ICR_TB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">i2c_pxa_master_complete</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">icrlog</span><span class="p">[</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">irqlogidx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">icr</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">icr</span><span class="p">,</span> <span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define VALID_INT_SOURCE	(ISR_SSD | ISR_ALD | ISR_ITE | ISR_IRF | \</span>
<span class="cp">				ISR_SAD | ISR_BED)</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">i2c_pxa_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">this_irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">isr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ISR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">VALID_INT_SOURCE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_debug</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ISR=%08x, ICR=%08x, IBMR=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">isr</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">_ICR</span><span class="p">(</span><span class="n">i2c</span><span class="p">)),</span> <span class="n">readl</span><span class="p">(</span><span class="n">_IBMR</span><span class="p">(</span><span class="n">i2c</span><span class="p">)));</span>
		<span class="n">decode_ISR</span><span class="p">(</span><span class="n">isr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">irqlogidx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">isrlog</span><span class="p">))</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">isrlog</span><span class="p">[</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">irqlogidx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">isr</span><span class="p">;</span>

	<span class="n">show_state</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Always clear all pending IRQs.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">VALID_INT_SOURCE</span><span class="p">,</span> <span class="n">_ISR</span><span class="p">(</span><span class="n">i2c</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_SAD</span><span class="p">)</span>
		<span class="n">i2c_pxa_slave_start</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_SSD</span><span class="p">)</span>
		<span class="n">i2c_pxa_slave_stop</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_pxa_is_slavemode</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_ITE</span><span class="p">)</span>
			<span class="n">i2c_pxa_slave_txempty</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_IRF</span><span class="p">)</span>
			<span class="n">i2c_pxa_slave_rxfull</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_ITE</span><span class="p">)</span>
			<span class="n">i2c_pxa_irq_txempty</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_IRF</span><span class="p">)</span>
			<span class="n">i2c_pxa_irq_rxfull</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">i2c_pxa_scream_blue_murder</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;spurious irq&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_pxa_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">algo_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_pxa_do_xfer</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">I2C_RETRY</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i2c_debug</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Retrying transmission</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">i2c_pxa_scream_blue_murder</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;exhausted retries&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">i2c_pxa_set_slave</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">i2c_pxa_functionality</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">I2C_FUNC_I2C</span> <span class="o">|</span> <span class="n">I2C_FUNC_SMBUS_EMUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">i2c_pxa_algorithm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span>	<span class="o">=</span> <span class="n">i2c_pxa_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span>	<span class="o">=</span> <span class="n">i2c_pxa_functionality</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">i2c_pxa_pio_algorithm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span>	<span class="o">=</span> <span class="n">i2c_pxa_pio_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span>	<span class="o">=</span> <span class="n">i2c_pxa_functionality</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">i2c_pxa_dt_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;mrvl,pxa-i2c&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">REGS_PXA2XX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;mrvl,pwri2c&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">REGS_PXA3XX</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;mrvl,mmp-twsi&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">REGS_PXA2XX</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">i2c_pxa_dt_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_pxa_probe_dt</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">pxa_i2c_types</span> <span class="o">*</span><span class="n">i2c_types</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="o">*</span><span class="n">of_id</span> <span class="o">=</span>
			<span class="n">of_match_device</span><span class="p">(</span><span class="n">i2c_pxa_dt_ids</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">of_alias_get_id</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;i2c&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get alias id, errno %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;mrvl,i2c-polling&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">use_pio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;mrvl,i2c-fast-mode&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">fast_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">i2c_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">of_id</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_pxa_probe_pdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">pxa_i2c_types</span> <span class="o">*</span><span class="n">i2c_types</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_pxa_platform_data</span> <span class="o">*</span><span class="n">plat</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">platform_get_device_id</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">i2c_types</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">use_pio</span> <span class="o">=</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">use_pio</span><span class="p">;</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">fast_mode</span> <span class="o">=</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">fast_mode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_pxa_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_pxa_platform_data</span> <span class="o">*</span><span class="n">plat</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">pxa_i2c_types</span> <span class="n">i2c_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">i2c</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pxa_i2c</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">emalloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_pxa_probe_dt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_pxa_probe_pdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i2c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i2c_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">eclk</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">eclk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">eclk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">retries</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">nr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;pxa_i2c-i2c.%u&quot;</span><span class="p">,</span>
		 <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>

	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">eclk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">reg_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">eremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">reg_ibmr</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">pxa_reg_layout</span><span class="p">[</span><span class="n">i2c_type</span><span class="p">].</span><span class="n">ibmr</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">reg_idbr</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">pxa_reg_layout</span><span class="p">[</span><span class="n">i2c_type</span><span class="p">].</span><span class="n">idbr</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">reg_icr</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">pxa_reg_layout</span><span class="p">[</span><span class="n">i2c_type</span><span class="p">].</span><span class="n">icr</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">reg_isr</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">pxa_reg_layout</span><span class="p">[</span><span class="n">i2c_type</span><span class="p">].</span><span class="n">isr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_type</span> <span class="o">!=</span> <span class="n">REGS_CE4100</span><span class="p">)</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">reg_isar</span> <span class="o">=</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">reg_base</span> <span class="o">+</span> <span class="n">pxa_reg_layout</span><span class="p">[</span><span class="n">i2c_type</span><span class="p">].</span><span class="n">isar</span><span class="p">;</span>

	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">iosize</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave_addr</span> <span class="o">=</span> <span class="n">I2C_PXA_SLAVE_ADDR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plat</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_I2C_PXA_SLAVE</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave_addr</span> <span class="o">=</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">;</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">=</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">use_pio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2c_pxa_pio_algorithm</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2c_pxa_algorithm</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">i2c_pxa_handler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				  <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i2c</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ereqirq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2c_pxa_reset</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>

	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">algo_data</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">;</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_OF</span>
	<span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_add_numbered_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;I2C: Failed to add bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">eadapt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">of_i2c_register_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i2c</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_I2C_PXA_SLAVE</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;I2C: %s: PXA I2C adapter, slave address %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">),</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;I2C: %s: PXA I2C adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">.</span><span class="n">dev</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">eadapt:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">use_pio</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">i2c</span><span class="p">);</span>
<span class="nl">ereqirq:</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">reg_base</span><span class="p">);</span>
<span class="nl">eremap:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="nl">eclk:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>
<span class="nl">emalloc:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">i2c_pxa_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">use_pio</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">i2c</span><span class="p">);</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">reg_base</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="n">i2c</span><span class="o">-&gt;</span><span class="n">iosize</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_pxa_suspend_noirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_pxa_resume_noirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pxa_i2c</span> <span class="o">*</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">i2c_pxa_reset</span><span class="p">(</span><span class="n">i2c</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">i2c_pxa_dev_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend_noirq</span> <span class="o">=</span> <span class="n">i2c_pxa_suspend_noirq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume_noirq</span> <span class="o">=</span> <span class="n">i2c_pxa_resume_noirq</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define I2C_PXA_DEV_PM_OPS (&amp;i2c_pxa_dev_pm_ops)</span>
<span class="cp">#else</span>
<span class="cp">#define I2C_PXA_DEV_PM_OPS NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">i2c_pxa_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">i2c_pxa_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">i2c_pxa_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;pxa2xx-i2c&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="n">I2C_PXA_DEV_PM_OPS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">i2c_pxa_dt_ids</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">i2c_pxa_id_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">i2c_adap_pxa_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_pxa_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">i2c_adap_pxa_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_pxa_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:pxa2xx-i2c&quot;</span><span class="p">);</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">i2c_adap_pxa_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">i2c_adap_pxa_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
