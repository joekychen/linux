<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › i2c › busses › i2c-designware-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>i2c-designware-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Synopsys DesignWare I2C adapter driver (master only).</span>
<span class="cm"> *</span>
<span class="cm"> * Based on the TI DAVINCI I2C adapter driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Texas Instruments.</span>
<span class="cm"> * Copyright (C) 2007 MontaVista Software Inc.</span>
<span class="cm"> * Copyright (C) 2009 Provigent Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * ----------------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> * ----------------------------------------------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &quot;i2c-designware-core.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Registers offset</span>
<span class="cm"> */</span>
<span class="cp">#define DW_IC_CON		0x0</span>
<span class="cp">#define DW_IC_TAR		0x4</span>
<span class="cp">#define DW_IC_DATA_CMD		0x10</span>
<span class="cp">#define DW_IC_SS_SCL_HCNT	0x14</span>
<span class="cp">#define DW_IC_SS_SCL_LCNT	0x18</span>
<span class="cp">#define DW_IC_FS_SCL_HCNT	0x1c</span>
<span class="cp">#define DW_IC_FS_SCL_LCNT	0x20</span>
<span class="cp">#define DW_IC_INTR_STAT		0x2c</span>
<span class="cp">#define DW_IC_INTR_MASK		0x30</span>
<span class="cp">#define DW_IC_RAW_INTR_STAT	0x34</span>
<span class="cp">#define DW_IC_RX_TL		0x38</span>
<span class="cp">#define DW_IC_TX_TL		0x3c</span>
<span class="cp">#define DW_IC_CLR_INTR		0x40</span>
<span class="cp">#define DW_IC_CLR_RX_UNDER	0x44</span>
<span class="cp">#define DW_IC_CLR_RX_OVER	0x48</span>
<span class="cp">#define DW_IC_CLR_TX_OVER	0x4c</span>
<span class="cp">#define DW_IC_CLR_RD_REQ	0x50</span>
<span class="cp">#define DW_IC_CLR_TX_ABRT	0x54</span>
<span class="cp">#define DW_IC_CLR_RX_DONE	0x58</span>
<span class="cp">#define DW_IC_CLR_ACTIVITY	0x5c</span>
<span class="cp">#define DW_IC_CLR_STOP_DET	0x60</span>
<span class="cp">#define DW_IC_CLR_START_DET	0x64</span>
<span class="cp">#define DW_IC_CLR_GEN_CALL	0x68</span>
<span class="cp">#define DW_IC_ENABLE		0x6c</span>
<span class="cp">#define DW_IC_STATUS		0x70</span>
<span class="cp">#define DW_IC_TXFLR		0x74</span>
<span class="cp">#define DW_IC_RXFLR		0x78</span>
<span class="cp">#define DW_IC_TX_ABRT_SOURCE	0x80</span>
<span class="cp">#define DW_IC_COMP_PARAM_1	0xf4</span>
<span class="cp">#define DW_IC_COMP_TYPE		0xfc</span>
<span class="cp">#define DW_IC_COMP_TYPE_VALUE	0x44570140</span>

<span class="cp">#define DW_IC_INTR_RX_UNDER	0x001</span>
<span class="cp">#define DW_IC_INTR_RX_OVER	0x002</span>
<span class="cp">#define DW_IC_INTR_RX_FULL	0x004</span>
<span class="cp">#define DW_IC_INTR_TX_OVER	0x008</span>
<span class="cp">#define DW_IC_INTR_TX_EMPTY	0x010</span>
<span class="cp">#define DW_IC_INTR_RD_REQ	0x020</span>
<span class="cp">#define DW_IC_INTR_TX_ABRT	0x040</span>
<span class="cp">#define DW_IC_INTR_RX_DONE	0x080</span>
<span class="cp">#define DW_IC_INTR_ACTIVITY	0x100</span>
<span class="cp">#define DW_IC_INTR_STOP_DET	0x200</span>
<span class="cp">#define DW_IC_INTR_START_DET	0x400</span>
<span class="cp">#define DW_IC_INTR_GEN_CALL	0x800</span>

<span class="cp">#define DW_IC_INTR_DEFAULT_MASK		(DW_IC_INTR_RX_FULL | \</span>
<span class="cp">					 DW_IC_INTR_TX_EMPTY | \</span>
<span class="cp">					 DW_IC_INTR_TX_ABRT | \</span>
<span class="cp">					 DW_IC_INTR_STOP_DET)</span>

<span class="cp">#define DW_IC_STATUS_ACTIVITY	0x1</span>

<span class="cp">#define DW_IC_ERR_TX_ABRT	0x1</span>

<span class="cm">/*</span>
<span class="cm"> * status codes</span>
<span class="cm"> */</span>
<span class="cp">#define STATUS_IDLE			0x0</span>
<span class="cp">#define STATUS_WRITE_IN_PROGRESS	0x1</span>
<span class="cp">#define STATUS_READ_IN_PROGRESS		0x2</span>

<span class="cp">#define TIMEOUT			20 </span><span class="cm">/* ms */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * hardware abort codes from the DW_IC_TX_ABRT_SOURCE register</span>
<span class="cm"> *</span>
<span class="cm"> * only expected abort codes are listed here</span>
<span class="cm"> * refer to the datasheet for the full list</span>
<span class="cm"> */</span>
<span class="cp">#define ABRT_7B_ADDR_NOACK	0</span>
<span class="cp">#define ABRT_10ADDR1_NOACK	1</span>
<span class="cp">#define ABRT_10ADDR2_NOACK	2</span>
<span class="cp">#define ABRT_TXDATA_NOACK	3</span>
<span class="cp">#define ABRT_GCALL_NOACK	4</span>
<span class="cp">#define ABRT_GCALL_READ		5</span>
<span class="cp">#define ABRT_SBYTE_ACKDET	7</span>
<span class="cp">#define ABRT_SBYTE_NORSTRT	9</span>
<span class="cp">#define ABRT_10B_RD_NORSTRT	10</span>
<span class="cp">#define ABRT_MASTER_DIS		11</span>
<span class="cp">#define ARB_LOST		12</span>

<span class="cp">#define DW_IC_TX_ABRT_7B_ADDR_NOACK	(1UL &lt;&lt; ABRT_7B_ADDR_NOACK)</span>
<span class="cp">#define DW_IC_TX_ABRT_10ADDR1_NOACK	(1UL &lt;&lt; ABRT_10ADDR1_NOACK)</span>
<span class="cp">#define DW_IC_TX_ABRT_10ADDR2_NOACK	(1UL &lt;&lt; ABRT_10ADDR2_NOACK)</span>
<span class="cp">#define DW_IC_TX_ABRT_TXDATA_NOACK	(1UL &lt;&lt; ABRT_TXDATA_NOACK)</span>
<span class="cp">#define DW_IC_TX_ABRT_GCALL_NOACK	(1UL &lt;&lt; ABRT_GCALL_NOACK)</span>
<span class="cp">#define DW_IC_TX_ABRT_GCALL_READ	(1UL &lt;&lt; ABRT_GCALL_READ)</span>
<span class="cp">#define DW_IC_TX_ABRT_SBYTE_ACKDET	(1UL &lt;&lt; ABRT_SBYTE_ACKDET)</span>
<span class="cp">#define DW_IC_TX_ABRT_SBYTE_NORSTRT	(1UL &lt;&lt; ABRT_SBYTE_NORSTRT)</span>
<span class="cp">#define DW_IC_TX_ABRT_10B_RD_NORSTRT	(1UL &lt;&lt; ABRT_10B_RD_NORSTRT)</span>
<span class="cp">#define DW_IC_TX_ABRT_MASTER_DIS	(1UL &lt;&lt; ABRT_MASTER_DIS)</span>
<span class="cp">#define DW_IC_TX_ARB_LOST		(1UL &lt;&lt; ARB_LOST)</span>

<span class="cp">#define DW_IC_TX_ABRT_NOACK		(DW_IC_TX_ABRT_7B_ADDR_NOACK | \</span>
<span class="cp">					 DW_IC_TX_ABRT_10ADDR1_NOACK | \</span>
<span class="cp">					 DW_IC_TX_ABRT_10ADDR2_NOACK | \</span>
<span class="cp">					 DW_IC_TX_ABRT_TXDATA_NOACK | \</span>
<span class="cp">					 DW_IC_TX_ABRT_GCALL_NOACK)</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">abort_sources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">ABRT_7B_ADDR_NOACK</span><span class="p">]</span> <span class="o">=</span>
		<span class="s">&quot;slave address not acknowledged (7bit mode)&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ABRT_10ADDR1_NOACK</span><span class="p">]</span> <span class="o">=</span>
		<span class="s">&quot;first address byte not acknowledged (10bit mode)&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ABRT_10ADDR2_NOACK</span><span class="p">]</span> <span class="o">=</span>
		<span class="s">&quot;second address byte not acknowledged (10bit mode)&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ABRT_TXDATA_NOACK</span><span class="p">]</span> <span class="o">=</span>
		<span class="s">&quot;data not acknowledged&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ABRT_GCALL_NOACK</span><span class="p">]</span> <span class="o">=</span>
		<span class="s">&quot;no acknowledgement for a general call&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ABRT_GCALL_READ</span><span class="p">]</span> <span class="o">=</span>
		<span class="s">&quot;read after general call&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ABRT_SBYTE_ACKDET</span><span class="p">]</span> <span class="o">=</span>
		<span class="s">&quot;start byte acknowledged&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ABRT_SBYTE_NORSTRT</span><span class="p">]</span> <span class="o">=</span>
		<span class="s">&quot;trying to send start byte when restart is disabled&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ABRT_10B_RD_NORSTRT</span><span class="p">]</span> <span class="o">=</span>
		<span class="s">&quot;trying to read when restart is disabled (10bit mode)&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ABRT_MASTER_DIS</span><span class="p">]</span> <span class="o">=</span>
		<span class="s">&quot;trying to use disabled adapter&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ARB_LOST</span><span class="p">]</span> <span class="o">=</span>
		<span class="s">&quot;lost arbitration&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">u32</span> <span class="nf">dw_readl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">accessor_flags</span> <span class="o">&amp;</span> <span class="n">ACCESS_16BIT</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">accessor_flags</span> <span class="o">&amp;</span> <span class="n">ACCESS_SWAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">swab32</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dw_writel</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">accessor_flags</span> <span class="o">&amp;</span> <span class="n">ACCESS_SWAP</span><span class="p">)</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">accessor_flags</span> <span class="o">&amp;</span> <span class="n">ACCESS_16BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writew</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">b</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">i2c_dw_scl_hcnt</span><span class="p">(</span><span class="n">u32</span> <span class="n">ic_clk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tSYMBOL</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cond</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * DesignWare I2C core doesn&#39;t seem to have solid strategy to meet</span>
<span class="cm">	 * the tHD;STA timing spec.  Configuring _HCNT based on tHIGH spec</span>
<span class="cm">	 * will result in violation of the tHD;STA spec.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cond</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * Conditional expression:</span>
<span class="cm">		 *</span>
<span class="cm">		 *   IC_[FS]S_SCL_HCNT + (1+4+3) &gt;= IC_CLK * tHIGH</span>
<span class="cm">		 *</span>
<span class="cm">		 * This is based on the DW manuals, and represents an ideal</span>
<span class="cm">		 * configuration.  The resulting I2C bus speed will be</span>
<span class="cm">		 * faster than any of the others.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If your hardware is free from tHD;STA issue, try this one.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ic_clk</span> <span class="o">*</span> <span class="n">tSYMBOL</span> <span class="o">+</span> <span class="mi">5000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/*</span>
<span class="cm">		 * Conditional expression:</span>
<span class="cm">		 *</span>
<span class="cm">		 *   IC_[FS]S_SCL_HCNT + 3 &gt;= IC_CLK * (tHD;STA + tf)</span>
<span class="cm">		 *</span>
<span class="cm">		 * This is just experimental rule; the tHD;STA period turned</span>
<span class="cm">		 * out to be proportinal to (_HCNT + 3).  With this setting,</span>
<span class="cm">		 * we could meet both tHIGH and tHD;STA timing specs.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If unsure, you&#39;d better to take this alternative.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The reason why we need to take into account &quot;tf&quot; here,</span>
<span class="cm">		 * is the same as described in i2c_dw_scl_lcnt().</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ic_clk</span> <span class="o">*</span> <span class="p">(</span><span class="n">tSYMBOL</span> <span class="o">+</span> <span class="n">tf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">i2c_dw_scl_lcnt</span><span class="p">(</span><span class="n">u32</span> <span class="n">ic_clk</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tLOW</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Conditional expression:</span>
<span class="cm">	 *</span>
<span class="cm">	 *   IC_[FS]S_SCL_LCNT + 1 &gt;= IC_CLK * (tLOW + tf)</span>
<span class="cm">	 *</span>
<span class="cm">	 * DW I2C core starts counting the SCL CNTs for the LOW period</span>
<span class="cm">	 * of the SCL clock (tLOW) as soon as it pulls the SCL line.</span>
<span class="cm">	 * In order to meet the tLOW timing spec, we need to take into</span>
<span class="cm">	 * account the fall time of SCL signal (tf).  Default tf value</span>
<span class="cm">	 * should be 0.3 us, for safety.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">ic_clk</span> <span class="o">*</span> <span class="p">(</span><span class="n">tLOW</span> <span class="o">+</span> <span class="n">tf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i2c_dw_init() - initialize the designware i2c master hardware</span>
<span class="cm"> * @dev: device private data</span>
<span class="cm"> *</span>
<span class="cm"> * This functions configures and enables the I2C master.</span>
<span class="cm"> * This function is called during I2C init function, and in case of timeout at</span>
<span class="cm"> * run time.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i2c_dw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">input_clock_khz</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hcnt</span><span class="p">,</span> <span class="n">lcnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">input_clock_khz</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">get_clk_rate_khz</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_COMP_TYPE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">___constant_swab32</span><span class="p">(</span><span class="n">DW_IC_COMP_TYPE_VALUE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Configure register endianess access */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">accessor_flags</span> <span class="o">|=</span> <span class="n">ACCESS_SWAP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="p">(</span><span class="n">DW_IC_COMP_TYPE_VALUE</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Configure register access mode 16bit */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">accessor_flags</span> <span class="o">|=</span> <span class="n">ACCESS_16BIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">DW_IC_COMP_TYPE_VALUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown Synopsys component type: &quot;</span>
			<span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable the adapter */</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DW_IC_ENABLE</span><span class="p">);</span>

	<span class="cm">/* set standard and fast speed deviders for high/low periods */</span>

	<span class="cm">/* Standard-mode */</span>
	<span class="n">hcnt</span> <span class="o">=</span> <span class="n">i2c_dw_scl_hcnt</span><span class="p">(</span><span class="n">input_clock_khz</span><span class="p">,</span>
				<span class="mi">40</span><span class="p">,</span>	<span class="cm">/* tHD;STA = tHIGH = 4.0 us */</span>
				<span class="mi">3</span><span class="p">,</span>	<span class="cm">/* tf = 0.3 us */</span>
				<span class="mi">0</span><span class="p">,</span>	<span class="cm">/* 0: DW default, 1: Ideal */</span>
				<span class="mi">0</span><span class="p">);</span>	<span class="cm">/* No offset */</span>
	<span class="n">lcnt</span> <span class="o">=</span> <span class="n">i2c_dw_scl_lcnt</span><span class="p">(</span><span class="n">input_clock_khz</span><span class="p">,</span>
				<span class="mi">47</span><span class="p">,</span>	<span class="cm">/* tLOW = 4.7 us */</span>
				<span class="mi">3</span><span class="p">,</span>	<span class="cm">/* tf = 0.3 us */</span>
				<span class="mi">0</span><span class="p">);</span>	<span class="cm">/* No offset */</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hcnt</span><span class="p">,</span> <span class="n">DW_IC_SS_SCL_HCNT</span><span class="p">);</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lcnt</span><span class="p">,</span> <span class="n">DW_IC_SS_SCL_LCNT</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Standard-mode HCNT:LCNT = %d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hcnt</span><span class="p">,</span> <span class="n">lcnt</span><span class="p">);</span>

	<span class="cm">/* Fast-mode */</span>
	<span class="n">hcnt</span> <span class="o">=</span> <span class="n">i2c_dw_scl_hcnt</span><span class="p">(</span><span class="n">input_clock_khz</span><span class="p">,</span>
				<span class="mi">6</span><span class="p">,</span>	<span class="cm">/* tHD;STA = tHIGH = 0.6 us */</span>
				<span class="mi">3</span><span class="p">,</span>	<span class="cm">/* tf = 0.3 us */</span>
				<span class="mi">0</span><span class="p">,</span>	<span class="cm">/* 0: DW default, 1: Ideal */</span>
				<span class="mi">0</span><span class="p">);</span>	<span class="cm">/* No offset */</span>
	<span class="n">lcnt</span> <span class="o">=</span> <span class="n">i2c_dw_scl_lcnt</span><span class="p">(</span><span class="n">input_clock_khz</span><span class="p">,</span>
				<span class="mi">13</span><span class="p">,</span>	<span class="cm">/* tLOW = 1.3 us */</span>
				<span class="mi">3</span><span class="p">,</span>	<span class="cm">/* tf = 0.3 us */</span>
				<span class="mi">0</span><span class="p">);</span>	<span class="cm">/* No offset */</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hcnt</span><span class="p">,</span> <span class="n">DW_IC_FS_SCL_HCNT</span><span class="p">);</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lcnt</span><span class="p">,</span> <span class="n">DW_IC_FS_SCL_LCNT</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Fast-mode HCNT:LCNT = %d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hcnt</span><span class="p">,</span> <span class="n">lcnt</span><span class="p">);</span>

	<span class="cm">/* Configure Tx/Rx FIFO threshold levels */</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_fifo_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DW_IC_TX_TL</span><span class="p">);</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DW_IC_RX_TL</span><span class="p">);</span>

	<span class="cm">/* configure the i2c master */</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">master_cfg</span> <span class="p">,</span> <span class="n">DW_IC_CON</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Waiting for bus not busy</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_dw_wait_bus_not_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">TIMEOUT</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DW_IC_STATUS_ACTIVITY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout waiting for bus ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_dw_xfer_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msgs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">msgs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ic_con</span><span class="p">;</span>

	<span class="cm">/* Disable the adapter */</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DW_IC_ENABLE</span><span class="p">);</span>

	<span class="cm">/* set the slave (target) address */</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">msgs</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_write_idx</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">DW_IC_TAR</span><span class="p">);</span>

	<span class="cm">/* if the slave address is ten bit address, enable 10BITADDR */</span>
	<span class="n">ic_con</span> <span class="o">=</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_CON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msgs</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_write_idx</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_TEN</span><span class="p">)</span>
		<span class="n">ic_con</span> <span class="o">|=</span> <span class="n">DW_IC_CON_10BITADDR_MASTER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ic_con</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DW_IC_CON_10BITADDR_MASTER</span><span class="p">;</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ic_con</span><span class="p">,</span> <span class="n">DW_IC_CON</span><span class="p">);</span>

	<span class="cm">/* Enable the adapter */</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DW_IC_ENABLE</span><span class="p">);</span>

	<span class="cm">/* Enable interrupts */</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_INTR_DEFAULT_MASK</span><span class="p">,</span> <span class="n">DW_IC_INTR_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initiate (and continue) low level master read/write transaction.</span>
<span class="cm"> * This function is only called from i2c_dw_isr, and pumping i2c_msg</span>
<span class="cm"> * messages into the tx buffer.  Even if the size of i2c_msg data is</span>
<span class="cm"> * longer than the size of the tx buffer, it handles everything.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">i2c_dw_xfer_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msgs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">msgs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intr_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_limit</span><span class="p">,</span> <span class="n">rx_limit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">msgs</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_write_idx</span><span class="p">].</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf_len</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_buf_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">;</span>

	<span class="n">intr_mask</span> <span class="o">=</span> <span class="n">DW_IC_INTR_DEFAULT_MASK</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_write_idx</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">msgs_num</span><span class="p">;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_write_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * if target address has changed, we need to</span>
<span class="cm">		 * reprogram the target address in the i2c</span>
<span class="cm">		 * adapter when we are done with this transfer</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msgs</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_write_idx</span><span class="p">].</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: invalid target address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msgs</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_write_idx</span><span class="p">].</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: invalid message length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_WRITE_IN_PROGRESS</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* new i2c_msg */</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">msgs</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_write_idx</span><span class="p">].</span><span class="n">buf</span><span class="p">;</span>
			<span class="n">buf_len</span> <span class="o">=</span> <span class="n">msgs</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_write_idx</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tx_limit</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_fifo_depth</span> <span class="o">-</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_TXFLR</span><span class="p">);</span>
		<span class="n">rx_limit</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fifo_depth</span> <span class="o">-</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_RXFLR</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tx_limit</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rx_limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msgs</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_write_idx</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">DW_IC_DATA_CMD</span><span class="p">);</span>
				<span class="n">rx_limit</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">,</span> <span class="n">DW_IC_DATA_CMD</span><span class="p">);</span>
			<span class="n">tx_limit</span><span class="o">--</span><span class="p">;</span> <span class="n">buf_len</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_buf_len</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* more bytes to be written */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_WRITE_IN_PROGRESS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_WRITE_IN_PROGRESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If i2c_msg index search is completed, we don&#39;t need TX_EMPTY</span>
<span class="cm">	 * interrupt any more.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_write_idx</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">msgs_num</span><span class="p">)</span>
		<span class="n">intr_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DW_IC_INTR_TX_EMPTY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_err</span><span class="p">)</span>
		<span class="n">intr_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intr_mask</span><span class="p">,</span>  <span class="n">DW_IC_INTR_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">i2c_dw_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msgs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">msgs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_valid</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_read_idx</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">msgs_num</span><span class="p">;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_read_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">msgs</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_read_idx</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_READ_IN_PROGRESS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">msgs</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_read_idx</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">msgs</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_read_idx</span><span class="p">].</span><span class="n">buf</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_buf_len</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rx_valid</span> <span class="o">=</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_RXFLR</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rx_valid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">len</span><span class="o">--</span><span class="p">,</span> <span class="n">rx_valid</span><span class="o">--</span><span class="p">)</span>
			<span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">=</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_DATA_CMD</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">STATUS_READ_IN_PROGRESS</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_buf_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STATUS_READ_IN_PROGRESS</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_dw_handle_tx_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">abort_source</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">abort_source</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">abort_source</span> <span class="o">&amp;</span> <span class="n">DW_IC_TX_ABRT_NOACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">abort_source</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">abort_sources</span><span class="p">))</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">abort_sources</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">abort_source</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">abort_sources</span><span class="p">))</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">abort_sources</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">abort_source</span> <span class="o">&amp;</span> <span class="n">DW_IC_TX_ARB_LOST</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">abort_source</span> <span class="o">&amp;</span> <span class="n">DW_IC_TX_ABRT_GCALL_READ</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* wrong msgs[] data */</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare controller for a transaction and call i2c_dw_xfer_msg</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">i2c_dw_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: msgs: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd_complete</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">msgs</span> <span class="o">=</span> <span class="n">msgs</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">msgs_num</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_write_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_read_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_IDLE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">abort_source</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_dw_wait_bus_not_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* start the transfers */</span>
	<span class="n">i2c_dw_xfer_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* wait for tx to complete */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_for_completion_interruptible_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd_complete</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i2c_dw_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* no error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd_err</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Disable the adapter */</span>
		<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DW_IC_ENABLE</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We have an error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd_err</span> <span class="o">==</span> <span class="n">DW_IC_ERR_TX_ABRT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_dw_handle_tx_abort</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">i2c_dw_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2c_get_adapdata</span><span class="p">(</span><span class="n">adap</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">functionality</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">i2c_dw_read_clear_intrbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The IC_INTR_STAT register just indicates &quot;enabled&quot; interrupts.</span>
<span class="cm">	 * Ths unmasked raw version of interrupt status bits are available</span>
<span class="cm">	 * in the IC_RAW_INTR_STAT register.</span>
<span class="cm">	 *</span>
<span class="cm">	 * That is,</span>
<span class="cm">	 *   stat = dw_readl(IC_INTR_STAT);</span>
<span class="cm">	 * equals to,</span>
<span class="cm">	 *   stat = dw_readl(IC_RAW_INTR_STAT) &amp; dw_readl(IC_INTR_MASK);</span>
<span class="cm">	 *</span>
<span class="cm">	 * The raw version might be useful for debugging purposes.</span>
<span class="cm">	 */</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_INTR_STAT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do not use the IC_CLR_INTR register to clear interrupts, or</span>
<span class="cm">	 * you&#39;ll miss some interrupts, triggered during the period from</span>
<span class="cm">	 * dw_readl(IC_INTR_STAT) to dw_readl(IC_CLR_INTR).</span>
<span class="cm">	 *</span>
<span class="cm">	 * Instead, use the separately-prepared IC_CLR_* registers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DW_IC_INTR_RX_UNDER</span><span class="p">)</span>
		<span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_CLR_RX_UNDER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DW_IC_INTR_RX_OVER</span><span class="p">)</span>
		<span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_CLR_RX_OVER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DW_IC_INTR_TX_OVER</span><span class="p">)</span>
		<span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_CLR_TX_OVER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DW_IC_INTR_RD_REQ</span><span class="p">)</span>
		<span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_CLR_RD_REQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DW_IC_INTR_TX_ABRT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The IC_TX_ABRT_SOURCE register is cleared whenever</span>
<span class="cm">		 * the IC_CLR_TX_ABRT is read.  Preserve it beforehand.</span>
<span class="cm">		 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">abort_source</span> <span class="o">=</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_TX_ABRT_SOURCE</span><span class="p">);</span>
		<span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_CLR_TX_ABRT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DW_IC_INTR_RX_DONE</span><span class="p">)</span>
		<span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_CLR_RX_DONE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DW_IC_INTR_ACTIVITY</span><span class="p">)</span>
		<span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_CLR_ACTIVITY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DW_IC_INTR_STOP_DET</span><span class="p">)</span>
		<span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_CLR_STOP_DET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DW_IC_INTR_START_DET</span><span class="p">)</span>
		<span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_CLR_START_DET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DW_IC_INTR_GEN_CALL</span><span class="p">)</span>
		<span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_CLR_GEN_CALL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt service routine. This gets called whenever an I2C interrupt</span>
<span class="cm"> * occurs.</span>
<span class="cm"> */</span>
<span class="n">irqreturn_t</span> <span class="nf">i2c_dw_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">this_irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">,</span> <span class="n">enabled</span><span class="p">;</span>

	<span class="n">enabled</span> <span class="o">=</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_ENABLE</span><span class="p">);</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_RAW_INTR_STAT</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:  %s enabled= 0x%x stat=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enabled</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DW_IC_INTR_ACTIVITY</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">i2c_dw_read_clear_intrbits</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DW_IC_INTR_TX_ABRT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd_err</span> <span class="o">|=</span> <span class="n">DW_IC_ERR_TX_ABRT</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_IDLE</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Anytime TX_ABRT is set, the contents of the tx/rx</span>
<span class="cm">		 * buffers are flushed.  Make sure to skip them.</span>
<span class="cm">		 */</span>
		<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DW_IC_INTR_MASK</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">tx_aborted</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DW_IC_INTR_RX_FULL</span><span class="p">)</span>
		<span class="n">i2c_dw_read</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">DW_IC_INTR_TX_EMPTY</span><span class="p">)</span>
		<span class="n">i2c_dw_xfer_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * No need to modify or disable the interrupt mask here.</span>
<span class="cm">	 * i2c_dw_xfer_msg() will take care of it according to</span>
<span class="cm">	 * the current transmit status.</span>
<span class="cm">	 */</span>

<span class="nl">tx_aborted:</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DW_IC_INTR_TX_ABRT</span> <span class="o">|</span> <span class="n">DW_IC_INTR_STOP_DET</span><span class="p">))</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">msg_err</span><span class="p">)</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmd_complete</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i2c_dw_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
       <span class="cm">/* Enable the adapter */</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DW_IC_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">i2c_dw_is_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i2c_dw_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Disable controller */</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DW_IC_ENABLE</span><span class="p">);</span>

	<span class="cm">/* Disable all interupts */</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DW_IC_INTR_MASK</span><span class="p">);</span>
	<span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_CLR_INTR</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i2c_dw_clear_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_CLR_INTR</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i2c_dw_disable_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dw_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DW_IC_INTR_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">i2c_dw_read_comp_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">dw_i2c_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dw_readl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DW_IC_COMP_PARAM_1</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
