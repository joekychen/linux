<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pinctrl › pinctrl-coh901.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pinctrl-coh901.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * U300 GPIO module.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007-2011 ST-Ericsson AB</span>
<span class="cm"> * License terms: GNU General Public License (GPL) version 2</span>
<span class="cm"> * This can driver either of the two basic GPIO cores</span>
<span class="cm"> * available in the U300 platforms:</span>
<span class="cm"> * COH 901 335   - Used in DB3150 (U300 1.0) and DB3200 (U330 1.0)</span>
<span class="cm"> * COH 901 571/3 - Used in DB3210 (U365 2.0) and DB3350 (U335 1.0)</span>
<span class="cm"> * Author: Linus Walleij &lt;linus.walleij@linaro.org&gt;</span>
<span class="cm"> * Author: Jonas Aaberg &lt;jonas.aberg@stericsson.com&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pinctrl/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/pinctrl/pinconf-generic.h&gt;</span>
<span class="cp">#include &lt;mach/gpio-u300.h&gt;</span>
<span class="cp">#include &quot;pinctrl-coh901.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Register definitions for COH 901 335 variant</span>
<span class="cm"> */</span>
<span class="cp">#define U300_335_PORT_STRIDE				(0x1C)</span>
<span class="cm">/* Port X Pin Data Register 32bit, this is both input and output (R/W) */</span>
<span class="cp">#define U300_335_PXPDIR					(0x00)</span>
<span class="cp">#define U300_335_PXPDOR					(0x00)</span>
<span class="cm">/* Port X Pin Config Register 32bit (R/W) */</span>
<span class="cp">#define U300_335_PXPCR					(0x04)</span>
<span class="cm">/* This register layout is the same in both blocks */</span>
<span class="cp">#define U300_GPIO_PXPCR_ALL_PINS_MODE_MASK		(0x0000FFFFUL)</span>
<span class="cp">#define U300_GPIO_PXPCR_PIN_MODE_MASK			(0x00000003UL)</span>
<span class="cp">#define U300_GPIO_PXPCR_PIN_MODE_SHIFT			(0x00000002UL)</span>
<span class="cp">#define U300_GPIO_PXPCR_PIN_MODE_INPUT			(0x00000000UL)</span>
<span class="cp">#define U300_GPIO_PXPCR_PIN_MODE_OUTPUT_PUSH_PULL	(0x00000001UL)</span>
<span class="cp">#define U300_GPIO_PXPCR_PIN_MODE_OUTPUT_OPEN_DRAIN	(0x00000002UL)</span>
<span class="cp">#define U300_GPIO_PXPCR_PIN_MODE_OUTPUT_OPEN_SOURCE	(0x00000003UL)</span>
<span class="cm">/* Port X Interrupt Event Register 32bit (R/W) */</span>
<span class="cp">#define U300_335_PXIEV					(0x08)</span>
<span class="cm">/* Port X Interrupt Enable Register 32bit (R/W) */</span>
<span class="cp">#define U300_335_PXIEN					(0x0C)</span>
<span class="cm">/* Port X Interrupt Force Register 32bit (R/W) */</span>
<span class="cp">#define U300_335_PXIFR					(0x10)</span>
<span class="cm">/* Port X Interrupt Config Register 32bit (R/W) */</span>
<span class="cp">#define U300_335_PXICR					(0x14)</span>
<span class="cm">/* This register layout is the same in both blocks */</span>
<span class="cp">#define U300_GPIO_PXICR_ALL_IRQ_CONFIG_MASK		(0x000000FFUL)</span>
<span class="cp">#define U300_GPIO_PXICR_IRQ_CONFIG_MASK			(0x00000001UL)</span>
<span class="cp">#define U300_GPIO_PXICR_IRQ_CONFIG_FALLING_EDGE		(0x00000000UL)</span>
<span class="cp">#define U300_GPIO_PXICR_IRQ_CONFIG_RISING_EDGE		(0x00000001UL)</span>
<span class="cm">/* Port X Pull-up Enable Register 32bit (R/W) */</span>
<span class="cp">#define U300_335_PXPER					(0x18)</span>
<span class="cm">/* This register layout is the same in both blocks */</span>
<span class="cp">#define U300_GPIO_PXPER_ALL_PULL_UP_DISABLE_MASK	(0x000000FFUL)</span>
<span class="cp">#define U300_GPIO_PXPER_PULL_UP_DISABLE			(0x00000001UL)</span>
<span class="cm">/* Control Register 32bit (R/W) */</span>
<span class="cp">#define U300_335_CR					(0x54)</span>
<span class="cp">#define U300_335_CR_BLOCK_CLOCK_ENABLE			(0x00000001UL)</span>

<span class="cm">/*</span>
<span class="cm"> * Register definitions for COH 901 571 / 3 variant</span>
<span class="cm"> */</span>
<span class="cp">#define U300_571_PORT_STRIDE				(0x30)</span>
<span class="cm">/*</span>
<span class="cm"> * Control Register 32bit (R/W)</span>
<span class="cm"> * bit 15-9 (mask 0x0000FE00) contains the number of cores. 8*cores</span>
<span class="cm"> * gives the number of GPIO pins.</span>
<span class="cm"> * bit 8-2  (mask 0x000001FC) contains the core version ID.</span>
<span class="cm"> */</span>
<span class="cp">#define U300_571_CR					(0x00)</span>
<span class="cp">#define U300_571_CR_SYNC_SEL_ENABLE			(0x00000002UL)</span>
<span class="cp">#define U300_571_CR_BLOCK_CLKRQ_ENABLE			(0x00000001UL)</span>
<span class="cm">/*</span>
<span class="cm"> * These registers have the same layout and function as the corresponding</span>
<span class="cm"> * COH 901 335 registers, just at different offset.</span>
<span class="cm"> */</span>
<span class="cp">#define U300_571_PXPDIR					(0x04)</span>
<span class="cp">#define U300_571_PXPDOR					(0x08)</span>
<span class="cp">#define U300_571_PXPCR					(0x0C)</span>
<span class="cp">#define U300_571_PXPER					(0x10)</span>
<span class="cp">#define U300_571_PXIEV					(0x14)</span>
<span class="cp">#define U300_571_PXIEN					(0x18)</span>
<span class="cp">#define U300_571_PXIFR					(0x1C)</span>
<span class="cp">#define U300_571_PXICR					(0x20)</span>

<span class="cm">/* 8 bits per port, no version has more than 7 ports */</span>
<span class="cp">#define U300_GPIO_PINS_PER_PORT 8</span>
<span class="cp">#define U300_GPIO_MAX (U300_GPIO_PINS_PER_PORT * 7)</span>

<span class="k">struct</span> <span class="n">u300_gpio</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">gpio_chip</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">port_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">memres</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stride</span><span class="p">;</span>
	<span class="cm">/* Register offsets */</span>
	<span class="n">u32</span> <span class="n">pcr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dor</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">per</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">icr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ien</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iev</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">u300_gpio_port</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">number</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">toggle_edge_mode</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Macro to expand to read a specific register found in the &quot;gpio&quot;</span>
<span class="cm"> * struct. It requires the struct u300_gpio *gpio variable to exist in</span>
<span class="cm"> * its context. It calculates the port offset from the given pin</span>
<span class="cm"> * offset, muliplies by the port stride and adds the register offset</span>
<span class="cm"> * so it provides a pointer to the desired register.</span>
<span class="cm"> */</span>
<span class="cp">#define U300_PIN_REG(pin, reg) \</span>
<span class="cp">	(gpio-&gt;base + (pin &gt;&gt; 3) * gpio-&gt;stride + gpio-&gt;reg)</span>

<span class="cm">/*</span>
<span class="cm"> * Provides a bitmask for a specific gpio pin inside an 8-bit GPIO</span>
<span class="cm"> * register.</span>
<span class="cm"> */</span>
<span class="cp">#define U300_PIN_BIT(pin) \</span>
<span class="cp">	(1 &lt;&lt; (pin &amp; 0x07))</span>

<span class="k">struct</span> <span class="n">u300_gpio_confdata</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">bias_mode</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">output</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">outval</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* BS335 has seven ports of 8 bits each = GPIO pins 0..55 */</span>
<span class="cp">#define BS335_GPIO_NUM_PORTS 7</span>
<span class="cm">/* BS365 has five ports of 8 bits each = GPIO pins 0..39 */</span>
<span class="cp">#define BS365_GPIO_NUM_PORTS 5</span>

<span class="cp">#define U300_FLOATING_INPUT { \</span>
<span class="cp">	.bias_mode = PIN_CONFIG_BIAS_HIGH_IMPEDANCE, \</span>
<span class="cp">	.output = false, \</span>
<span class="cp">}</span>

<span class="cp">#define U300_PULL_UP_INPUT { \</span>
<span class="cp">	.bias_mode = PIN_CONFIG_BIAS_PULL_UP, \</span>
<span class="cp">	.output = false, \</span>
<span class="cp">}</span>

<span class="cp">#define U300_OUTPUT_LOW { \</span>
<span class="cp">	.output = true, \</span>
<span class="cp">	.outval = 0, \</span>
<span class="cp">}</span>

<span class="cp">#define U300_OUTPUT_HIGH { \</span>
<span class="cp">	.output = true, \</span>
<span class="cp">	.outval = 1, \</span>
<span class="cp">}</span>


<span class="cm">/* Initial configuration */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">__initconst</span> <span class="n">u300_gpio_confdata</span>
<span class="n">bs335_gpio_config</span><span class="p">[</span><span class="n">BS335_GPIO_NUM_PORTS</span><span class="p">][</span><span class="n">U300_GPIO_PINS_PER_PORT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Port 0, pins 0-7 */</span>
	<span class="p">{</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_HIGH</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Port 1, pins 0-7 */</span>
	<span class="p">{</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_HIGH</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Port 2, pins 0-7 */</span>
	<span class="p">{</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Port 3, pins 0-7 */</span>
	<span class="p">{</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Port 4, pins 0-7 */</span>
	<span class="p">{</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Port 5, pins 0-7 */</span>
	<span class="p">{</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Port 6, pind 0-7 */</span>
	<span class="p">{</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">__initconst</span> <span class="n">u300_gpio_confdata</span>
<span class="n">bs365_gpio_config</span><span class="p">[</span><span class="n">BS365_GPIO_NUM_PORTS</span><span class="p">][</span><span class="n">U300_GPIO_PINS_PER_PORT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Port 0, pins 0-7 */</span>
	<span class="p">{</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Port 1, pins 0-7 */</span>
	<span class="p">{</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_HIGH</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Port 2, pins 0-7 */</span>
	<span class="p">{</span>
		<span class="n">U300_FLOATING_INPUT</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Port 3, pins 0-7 */</span>
	<span class="p">{</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Port 4, pins 0-7 */</span>
	<span class="p">{</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="n">U300_PULL_UP_INPUT</span><span class="p">,</span>
		<span class="cm">/* These 4 pins doesn&#39;t exist on DB3210 */</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
		<span class="n">U300_OUTPUT_LOW</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * to_u300_gpio() - get the pointer to u300_gpio</span>
<span class="cm"> * @chip: the gpio chip member of the structure u300_gpio</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="nf">to_u300_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">u300_gpio</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">u300_gpio_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Map back to global GPIO space and request muxing, the direction</span>
<span class="cm">	 * parameter does not matter for this controller.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">gpio</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pinctrl_request_gpio</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">u300_gpio_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">gpio</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">pinctrl_free_gpio</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">u300_gpio_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">to_u300_gpio</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">dir</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">U300_PIN_BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">u300_gpio_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">to_u300_gpio</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">dor</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">U300_PIN_BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">dor</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">U300_PIN_BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">dor</span><span class="p">));</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">u300_gpio_direction_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">to_u300_gpio</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">pcr</span><span class="p">));</span>
	<span class="cm">/* Mask out this pin, note 2 bits per setting */</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">U300_GPIO_PXPCR_PIN_MODE_MASK</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">pcr</span><span class="p">));</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">u300_gpio_direction_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">to_u300_gpio</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">oldmode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">pcr</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * Drive mode must be set by the special mode set function, set</span>
<span class="cm">	 * push/pull mode by default if no mode has been selected.</span>
<span class="cm">	 */</span>
	<span class="n">oldmode</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">U300_GPIO_PXPCR_PIN_MODE_MASK</span> <span class="o">&lt;&lt;</span>
			 <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="cm">/* mode = 0 means input, else some mode is already set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oldmode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">U300_GPIO_PXPCR_PIN_MODE_MASK</span> <span class="o">&lt;&lt;</span>
			 <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">U300_GPIO_PXPCR_PIN_MODE_OUTPUT_PUSH_PULL</span>
			<span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">pcr</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">u300_gpio_set</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">u300_gpio_to_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">to_u300_gpio</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retirq</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request IRQ for GPIO %d, return %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
		<span class="n">retirq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retirq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Returning -EINVAL means &quot;supported but not available&quot; */</span>
<span class="kt">int</span> <span class="nf">u300_gpio_config_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">to_u300_gpio</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">pin_config_param</span> <span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="k">enum</span> <span class="n">pin_config_param</span><span class="p">)</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">biasmode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">drmode</span><span class="p">;</span>

	<span class="cm">/* One bit per pin, clamp to bool range */</span>
	<span class="n">biasmode</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">per</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">U300_PIN_BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">));</span>

	<span class="cm">/* Mask out the two bits for this pin and shift to bits 0,1 */</span>
	<span class="n">drmode</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">pcr</span><span class="p">));</span>
	<span class="n">drmode</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">U300_GPIO_PXPCR_PIN_MODE_MASK</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">drmode</span> <span class="o">&gt;&gt;=</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PIN_CONFIG_BIAS_HIGH_IMPEDANCE</span>:
		<span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">biasmode</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIN_CONFIG_BIAS_PULL_UP</span>:
		<span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">biasmode</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIN_CONFIG_DRIVE_PUSH_PULL</span>:
		<span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drmode</span> <span class="o">==</span> <span class="n">U300_GPIO_PXPCR_PIN_MODE_OUTPUT_PUSH_PULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIN_CONFIG_DRIVE_OPEN_DRAIN</span>:
		<span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drmode</span> <span class="o">==</span> <span class="n">U300_GPIO_PXPCR_PIN_MODE_OUTPUT_OPEN_DRAIN</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIN_CONFIG_DRIVE_OPEN_SOURCE</span>:
		<span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drmode</span> <span class="o">==</span> <span class="n">U300_GPIO_PXPCR_PIN_MODE_OUTPUT_OPEN_SOURCE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">u300_gpio_config_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">gpio_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">pin_config_param</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">to_u300_gpio</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PIN_CONFIG_BIAS_DISABLE</span>:
	<span class="k">case</span> <span class="n">PIN_CONFIG_BIAS_HIGH_IMPEDANCE</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">per</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">U300_PIN_BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">per</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIN_CONFIG_BIAS_PULL_UP</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">per</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">U300_PIN_BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">per</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIN_CONFIG_DRIVE_PUSH_PULL</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">pcr</span><span class="p">));</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">U300_GPIO_PXPCR_PIN_MODE_MASK</span>
			 <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">U300_GPIO_PXPCR_PIN_MODE_OUTPUT_PUSH_PULL</span>
			<span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">pcr</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIN_CONFIG_DRIVE_OPEN_DRAIN</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">pcr</span><span class="p">));</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">U300_GPIO_PXPCR_PIN_MODE_MASK</span>
			 <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">U300_GPIO_PXPCR_PIN_MODE_OUTPUT_OPEN_DRAIN</span>
			<span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">pcr</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIN_CONFIG_DRIVE_OPEN_SOURCE</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">pcr</span><span class="p">));</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">U300_GPIO_PXPCR_PIN_MODE_MASK</span>
			 <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">U300_GPIO_PXPCR_PIN_MODE_OUTPUT_OPEN_SOURCE</span>
			<span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">pcr</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;illegal configuration requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_chip</span> <span class="n">u300_gpio_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">label</span>			<span class="o">=</span> <span class="s">&quot;u300-gpio-chip&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request</span>		<span class="o">=</span> <span class="n">u300_gpio_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span>			<span class="o">=</span> <span class="n">u300_gpio_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span>			<span class="o">=</span> <span class="n">u300_gpio_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set</span>			<span class="o">=</span> <span class="n">u300_gpio_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">direction_input</span>	<span class="o">=</span> <span class="n">u300_gpio_direction_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">direction_output</span>	<span class="o">=</span> <span class="n">u300_gpio_direction_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">to_irq</span>			<span class="o">=</span> <span class="n">u300_gpio_to_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">u300_toggle_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">icr</span><span class="p">));</span>
	<span class="cm">/* Set mode depending on state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">u300_gpio_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* High now, let&#39;s trigger on falling edge next then */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">U300_PIN_BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">icr</span><span class="p">));</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;next IRQ on falling edge on pin %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Low now, let&#39;s trigger on rising edge next then */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">U300_PIN_BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">icr</span><span class="p">));</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;next IRQ on rising edge on pin %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">u300_gpio_irq_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">trigger</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">u300_gpio_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">trigger</span> <span class="o">&amp;</span> <span class="n">IRQF_TRIGGER_RISING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">trigger</span> <span class="o">&amp;</span> <span class="n">IRQF_TRIGGER_FALLING</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The GPIO block can only trigger on falling OR rising edges,</span>
<span class="cm">		 * not both. So we need to toggle the mode whenever the pin</span>
<span class="cm">		 * goes from one state to the other with a special state flag</span>
<span class="cm">		 */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;trigger on both rising and falling edge on pin %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">offset</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">toggle_edge_mode</span> <span class="o">|=</span> <span class="n">U300_PIN_BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">u300_toggle_trigger</span><span class="p">(</span><span class="n">gpio</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">trigger</span> <span class="o">&amp;</span> <span class="n">IRQF_TRIGGER_RISING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;trigger on rising edge on pin %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">offset</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">icr</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">U300_PIN_BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">icr</span><span class="p">));</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">toggle_edge_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">U300_PIN_BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">trigger</span> <span class="o">&amp;</span> <span class="n">IRQF_TRIGGER_FALLING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;trigger on falling edge on pin %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">offset</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">icr</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">U300_PIN_BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">icr</span><span class="p">));</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">toggle_edge_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">U300_PIN_BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">u300_gpio_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">u300_gpio_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">ien</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">U300_PIN_BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">ien</span><span class="p">));</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">u300_gpio_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">u300_gpio_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">-</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">ien</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">U300_PIN_BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">ien</span><span class="p">));</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">u300_gpio_irqchip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;u300-gpio-irqchip&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_enable</span>		<span class="o">=</span> <span class="n">u300_gpio_irq_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_disable</span>		<span class="o">=</span> <span class="n">u300_gpio_irq_disable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_type</span>		<span class="o">=</span> <span class="n">u300_gpio_irq_type</span><span class="p">,</span>

<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">u300_gpio_irq_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">u300_gpio_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">irq_get_handler_data</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pinoffset</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* get the right stride */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_ack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
	<span class="cm">/* Read event register */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">pinoffset</span><span class="p">,</span> <span class="n">iev</span><span class="p">));</span>
	<span class="cm">/* Mask relevant bits */</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xFFU</span><span class="p">;</span> <span class="cm">/* 8 bits per port */</span>
	<span class="cm">/* ACK IRQ (clear event) */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">U300_PIN_REG</span><span class="p">(</span><span class="n">pinoffset</span><span class="p">,</span> <span class="n">iev</span><span class="p">));</span>

	<span class="cm">/* Call IRQ handler */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">irqoffset</span><span class="p">;</span>

		<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">irqoffset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">U300_GPIO_PINS_PER_PORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">pin_irq</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">irqoffset</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pinoffset</span> <span class="o">+</span> <span class="n">irqoffset</span><span class="p">;</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GPIO IRQ %d on pin %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pin_irq</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
			<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">pin_irq</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Triggering IRQ on both rising and falling edge</span>
<span class="cm">			 * needs mockery</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">toggle_edge_mode</span> <span class="o">&amp;</span> <span class="n">U300_PIN_BIT</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>
				<span class="n">u300_toggle_trigger</span><span class="p">(</span><span class="n">gpio</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">.</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_unmask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">u300_gpio_init_pin</span><span class="p">(</span><span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">u300_gpio_confdata</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set mode: input or output */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u300_gpio_direction_output</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">outval</span><span class="p">);</span>

		<span class="cm">/* Deactivate bias mode for output */</span>
		<span class="n">u300_gpio_config_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
				     <span class="n">PIN_CONFIG_BIAS_HIGH_IMPEDANCE</span><span class="p">);</span>

		<span class="cm">/* Set drive mode for output */</span>
		<span class="n">u300_gpio_config_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
				     <span class="n">PIN_CONFIG_DRIVE_PUSH_PULL</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set up pin %d as output, value: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">offset</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">outval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u300_gpio_direction_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

		<span class="cm">/* Always set output low on input pins */</span>
		<span class="n">u300_gpio_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Set bias mode for input */</span>
		<span class="n">u300_gpio_config_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">bias_mode</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;set up pin %d as input, bias: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">offset</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">bias_mode</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">u300_gpio_init_coh901571</span><span class="p">(</span><span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">u300_gpio_platform</span> <span class="o">*</span><span class="n">plat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="cm">/* Write default config and values to all pins */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">u300_gpio_confdata</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">==</span> <span class="n">U300_GPIO_COH901571_3_BS335</span><span class="p">)</span>
				<span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bs335_gpio_config</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">==</span> <span class="n">U300_GPIO_COH901571_3_BS365</span><span class="p">)</span>
				<span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bs365_gpio_config</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">u300_gpio_init_pin</span><span class="p">(</span><span class="n">gpio</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">u300_gpio_free_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">u300_gpio_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">u300_gpio_port</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">u300_gpio_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">u300_gpio_platform</span> <span class="o">*</span><span class="n">plat</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">portno</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">gpio</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">u300_gpio</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">u300_gpio_chip</span><span class="p">;</span>
	<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">ngpio</span> <span class="o">=</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">ports</span> <span class="o">*</span> <span class="n">U300_GPIO_PINS_PER_PORT</span><span class="p">;</span>
	<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">=</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">gpio_irq_base</span><span class="p">;</span>
	<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">gpio_base</span><span class="p">;</span>
	<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Get GPIO clock */</span>
	<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not get GPIO clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_no_clk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">clk_enable</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not enable GPIO clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_no_clk_enable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">memres</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">memres</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not get GPIO memory resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_no_resource</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">memres</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				<span class="n">resource_size</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">memres</span><span class="p">),</span>
				<span class="s">&quot;GPIO Controller&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_no_ioregion</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">memres</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">memres</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_no_ioremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">==</span> <span class="n">U300_GPIO_COH901335</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;initializing GPIO Controller COH 901 335</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">stride</span> <span class="o">=</span> <span class="n">U300_335_PORT_STRIDE</span><span class="p">;</span>
		<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">pcr</span> <span class="o">=</span> <span class="n">U300_335_PXPCR</span><span class="p">;</span>
		<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dor</span> <span class="o">=</span> <span class="n">U300_335_PXPDOR</span><span class="p">;</span>
		<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">U300_335_PXPDIR</span><span class="p">;</span>
		<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">per</span> <span class="o">=</span> <span class="n">U300_335_PXPER</span><span class="p">;</span>
		<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">icr</span> <span class="o">=</span> <span class="n">U300_335_PXICR</span><span class="p">;</span>
		<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">ien</span> <span class="o">=</span> <span class="n">U300_335_PXIEN</span><span class="p">;</span>
		<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">iev</span> <span class="o">=</span> <span class="n">U300_335_PXIEV</span><span class="p">;</span>
		<span class="n">ifr</span> <span class="o">=</span> <span class="n">U300_335_PXIFR</span><span class="p">;</span>

		<span class="cm">/* Turn on the GPIO block */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">U300_335_CR_BLOCK_CLOCK_ENABLE</span><span class="p">,</span>
		       <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">U300_335_CR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">==</span> <span class="n">U300_GPIO_COH901571_3_BS335</span> <span class="o">||</span>
		   <span class="n">plat</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">==</span> <span class="n">U300_GPIO_COH901571_3_BS365</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;initializing GPIO Controller COH 901 571/3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">stride</span> <span class="o">=</span> <span class="n">U300_571_PORT_STRIDE</span><span class="p">;</span>
		<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">pcr</span> <span class="o">=</span> <span class="n">U300_571_PXPCR</span><span class="p">;</span>
		<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dor</span> <span class="o">=</span> <span class="n">U300_571_PXPDOR</span><span class="p">;</span>
		<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">U300_571_PXPDIR</span><span class="p">;</span>
		<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">per</span> <span class="o">=</span> <span class="n">U300_571_PXPER</span><span class="p">;</span>
		<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">icr</span> <span class="o">=</span> <span class="n">U300_571_PXICR</span><span class="p">;</span>
		<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">ien</span> <span class="o">=</span> <span class="n">U300_571_PXIEN</span><span class="p">;</span>
		<span class="n">gpio</span><span class="o">-&gt;</span><span class="n">iev</span> <span class="o">=</span> <span class="n">U300_571_PXIEV</span><span class="p">;</span>
		<span class="n">ifr</span> <span class="o">=</span> <span class="n">U300_571_PXIFR</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">U300_571_CR</span><span class="p">);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;COH901571/3 block version: %d, &quot;</span> \
			 <span class="s">&quot;number of cores: %d totalling %d pins</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x000001FC</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">),</span>
			 <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0000FE00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">),</span>
			 <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0000FE00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">U300_571_CR_BLOCK_CLKRQ_ENABLE</span><span class="p">,</span>
		       <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">U300_571_CR</span><span class="p">);</span>
		<span class="n">u300_gpio_init_coh901571</span><span class="p">(</span><span class="n">gpio</span><span class="p">,</span> <span class="n">plat</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown block variant</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unknown_variant</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add each port with its IRQ separately */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">portno</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">portno</span> <span class="o">&lt;</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">portno</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">u300_gpio_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
			<span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">u300_gpio_port</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_no_port</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;gpio%d&quot;</span><span class="p">,</span> <span class="n">portno</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">portno</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">gpio</span><span class="p">;</span>

		<span class="n">port</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
						    <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;register IRQ %d for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">u300_gpio_irq_handler</span><span class="p">);</span>
		<span class="n">irq_set_handler_data</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

		<span class="cm">/* For each GPIO pin set the unique IRQ handler */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">U300_GPIO_PINS_PER_PORT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">irqno</span> <span class="o">=</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">portno</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;handler for IRQ %d on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">irqno</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">irqno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u300_gpio_irqchip</span><span class="p">,</span>
						 <span class="n">handle_simple_irq</span><span class="p">);</span>
			<span class="n">set_irq_flags</span><span class="p">(</span><span class="n">irqno</span><span class="p">,</span> <span class="n">IRQF_VALID</span><span class="p">);</span>
			<span class="n">irq_set_chip_data</span><span class="p">(</span><span class="n">irqno</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Turns off irq force (test register) for this port */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">portno</span> <span class="o">*</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">stride</span> <span class="o">+</span> <span class="n">ifr</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">port_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;initialized %d GPIO ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">portno</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">gpiochip_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to add gpiochip: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_no_chip</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Spawn pin controller device as child of the GPIO, pass gpio chip */</span>
	<span class="n">plat</span><span class="o">-&gt;</span><span class="n">pinctrl_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_register</span><span class="p">(</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">pinctrl_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_no_pinctrl</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">gpio</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_no_pinctrl:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">gpiochip_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
<span class="nl">err_no_chip:</span>
<span class="nl">err_no_port:</span>
	<span class="n">u300_gpio_free_ports</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
<span class="nl">err_unknown_variant:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">err_no_ioremap:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">memres</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">memres</span><span class="p">));</span>
<span class="nl">err_no_ioregion:</span>
<span class="nl">err_no_resource:</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="nl">err_no_clk_enable:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="nl">err_no_clk:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;module ERROR:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">u300_gpio_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">u300_gpio_platform</span> <span class="o">*</span><span class="n">plat</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">u300_gpio</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Turn off the GPIO block */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">==</span> <span class="n">U300_GPIO_COH901335</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000000U</span><span class="p">,</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">U300_335_CR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">==</span> <span class="n">U300_GPIO_COH901571_3_BS335</span> <span class="o">||</span>
	    <span class="n">plat</span><span class="o">-&gt;</span><span class="n">variant</span> <span class="o">==</span> <span class="n">U300_GPIO_COH901571_3_BS365</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000000U</span><span class="p">,</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">U300_571_CR</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">gpiochip_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to remove gpiochip: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">u300_gpio_free_ports</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">memres</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			   <span class="n">resource_size</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">memres</span><span class="p">));</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gpio</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">u300_gpio_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;u300-gpio&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">u300_gpio_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">u300_gpio_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u300_gpio_driver</span><span class="p">,</span> <span class="n">u300_gpio_probe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">u300_gpio_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u300_gpio_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">arch_initcall</span><span class="p">(</span><span class="n">u300_gpio_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">u300_gpio_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Linus Walleij &lt;linus.walleij@stericsson.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ST-Ericsson AB COH 901 335/COH 901 571/3 GPIO driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
