<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › message › i2o › device.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>device.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	Functions to handle I2O devices</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (C) 2004	Markus Lidel &lt;Markus.Lidel@shadowconnect.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> *	under the terms of the GNU General Public License as published by the</span>
<span class="cm"> *	Free Software Foundation; either version 2 of the License, or (at your</span>
<span class="cm"> *	option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	Fixes/additions:</span>
<span class="cm"> *		Markus Lidel &lt;Markus.Lidel@shadowconnect.com&gt;</span>
<span class="cm"> *			initial version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/i2o.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;core.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> *	i2o_device_issue_claim - claim or release a device</span>
<span class="cm"> *	@dev: I2O device to claim or release</span>
<span class="cm"> *	@cmd: claim or release command</span>
<span class="cm"> *	@type: type of claim</span>
<span class="cm"> *</span>
<span class="cm"> *	Issue I2O UTIL_CLAIM or UTIL_RELEASE messages. The message to be sent</span>
<span class="cm"> *	is set by cmd. dev is the I2O device which should be claim or</span>
<span class="cm"> *	released and the type is the claim type (see the I2O spec).</span>
<span class="cm"> *</span>
<span class="cm"> *	Returs 0 on success or negative error code on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">i2o_device_issue_claim</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span>
					 <span class="n">u32</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2o_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">i2o_msg_get_wait</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iop</span><span class="p">,</span> <span class="n">I2O_TIMEOUT_MESSAGE_GET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">FIVE_WORD_MSG_SIZE</span> <span class="o">|</span> <span class="n">SGL_OFFSET_0</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
	    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span> <span class="n">HOST_TID</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span> <span class="o">|</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i2o_msg_post_wait</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iop</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	i2o_device_claim - claim a device for use by an OSM</span>
<span class="cm"> *	@dev: I2O device to claim</span>
<span class="cm"> *</span>
<span class="cm"> *	Do the leg work to assign a device to a given OSM. If the claim succeeds,</span>
<span class="cm"> *	the owner is the primary. If the attempt fails a negative errno code</span>
<span class="cm"> *	is returned. On success zero is returned.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i2o_device_claim</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">i2o_device_issue_claim</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2O_CMD_UTIL_CLAIM</span><span class="p">,</span> <span class="n">I2O_CLAIM_PRIMARY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;i2o: claim of device %d succeeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;i2o: claim of device %d failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	i2o_device_claim_release - release a device that the OSM is using</span>
<span class="cm"> *	@dev: device to release</span>
<span class="cm"> *</span>
<span class="cm"> *	Drop a claim by an OSM on a given I2O device.</span>
<span class="cm"> *</span>
<span class="cm"> *	AC - some devices seem to want to refuse an unclaim until they have</span>
<span class="cm"> *	finished internal processing. It makes sense since you don&#39;t want a</span>
<span class="cm"> *	new device to go reconfiguring the entire system until you are done.</span>
<span class="cm"> *	Thus we are prepared to wait briefly.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 on success or negative error code on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i2o_device_claim_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tries</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *      If the controller takes a nonblocking approach to</span>
<span class="cm">	 *      releases we have to sleep/poll for a few times.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">tries</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">i2o_device_issue_claim</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2O_CMD_UTIL_RELEASE</span><span class="p">,</span>
					    <span class="n">I2O_CLAIM_PRIMARY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;i2o: claim release of device %d succeeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;i2o: claim release of device %d failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	i2o_device_release - release the memory for a I2O device</span>
<span class="cm"> *	@dev: I2O device which should be released</span>
<span class="cm"> *</span>
<span class="cm"> *	Release the allocated memory. This function is called if refcount of</span>
<span class="cm"> *	device reaches 0 automatically.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2o_device_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">i2o_dev</span> <span class="o">=</span> <span class="n">to_i2o_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;i2o: device %s released</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">i2o_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	i2o_device_show_class_id - Displays class id of I2O device</span>
<span class="cm"> *	@dev: device of which the class id should be displayed</span>
<span class="cm"> *	@attr: pointer to device attribute</span>
<span class="cm"> *	@buf: buffer into which the class id should be printed</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns the number of bytes which are printed into the buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">i2o_device_show_class_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">i2o_dev</span> <span class="o">=</span> <span class="n">to_i2o_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%03x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">class_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	i2o_device_show_tid - Displays TID of I2O device</span>
<span class="cm"> *	@dev: device of which the TID should be displayed</span>
<span class="cm"> *	@attr: pointer to device attribute</span>
<span class="cm"> *	@buf: buffer into which the TID should be printed</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns the number of bytes which are printed into the buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">i2o_device_show_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">i2o_dev</span> <span class="o">=</span> <span class="n">to_i2o_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%03x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* I2O device attributes */</span>
<span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">i2o_device_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">class_id</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">i2o_device_show_class_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">i2o_device_show_tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR_NULL</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	i2o_device_alloc - Allocate a I2O device and initialize it</span>
<span class="cm"> *</span>
<span class="cm"> *	Allocate the memory for a I2O device and initialize locks and lists</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns the allocated I2O device or a negative error code if the device</span>
<span class="cm"> *	could not be allocated.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="nf">i2o_device_alloc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2o_bus_type</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2o_device_release</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	i2o_device_add - allocate a new I2O device and add it to the IOP</span>
<span class="cm"> *	@c: I2O controller that the device is on</span>
<span class="cm"> *	@entry: LCT entry of the I2O device</span>
<span class="cm"> *</span>
<span class="cm"> *	Allocate a new I2O device and initialize it with the LCT entry. The</span>
<span class="cm"> *	device is appended to the device list of the controller.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns zero on success, or a -ve errno.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2o_device_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2o_controller</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">i2o_lct_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">i2o_dev</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">i2o_dev</span> <span class="o">=</span> <span class="n">i2o_device_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">i2o_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;i2o: unable to allocate i2o device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">i2o_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">lct_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;%d:%03x&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
		     <span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>

	<span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">iop</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">);</span>

	<span class="cm">/* create user entries for this device */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">i2o_iop_find_device</span><span class="p">(</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">iop</span><span class="p">,</span> <span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">user_tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">i2o_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;user&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unreg_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create user entries referring to this device */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
	    <span class="k">if</span> <span class="p">((</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">user_tid</span> <span class="o">==</span> <span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">i2o_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;user&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">rmlink1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create parent entries for this device */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">i2o_iop_find_device</span><span class="p">(</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">iop</span><span class="p">,</span> <span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">parent_tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">i2o_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;parent&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">rmlink1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create parent entries referring to this device */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
	    <span class="k">if</span> <span class="p">((</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">parent_tid</span> <span class="o">==</span> <span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">i2o_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;parent&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">rmlink2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2o_driver_notify_device_add_all</span><span class="p">(</span><span class="n">i2o_dev</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;i2o: device %s added</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">rmlink2:</span>
	<span class="cm">/* If link creating failed halfway, we loop whole list to cleanup.</span>
<span class="cm">	 * And we don&#39;t care wrong removing of link, because sysfs_remove_link</span>
<span class="cm">	 * will take care of it.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">parent_tid</span> <span class="o">==</span> <span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">)</span>
			<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;parent&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;parent&quot;</span><span class="p">);</span>
<span class="nl">rmlink1:</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">user_tid</span> <span class="o">==</span> <span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">)</span>
			<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;user&quot;</span><span class="p">);</span>
	<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;user&quot;</span><span class="p">);</span>
<span class="nl">unreg_dev:</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">i2o_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	i2o_device_remove - remove an I2O device from the I2O core</span>
<span class="cm"> *	@i2o_dev: I2O device which should be released</span>
<span class="cm"> *</span>
<span class="cm"> *	Is used on I2O controller removal or LCT modification, when the device</span>
<span class="cm"> *	is removed from the system. Note that the device could still hang</span>
<span class="cm"> *	around until the refcount reaches 0.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">i2o_device_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">i2o_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2o_controller</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">iop</span><span class="p">;</span>

	<span class="n">i2o_driver_notify_device_remove_all</span><span class="p">(</span><span class="n">i2o_dev</span><span class="p">);</span>

	<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;parent&quot;</span><span class="p">);</span>
	<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;user&quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">parent_tid</span> <span class="o">==</span> <span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">)</span>
			<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;parent&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">user_tid</span> <span class="o">==</span> <span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">)</span>
			<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="s">&quot;user&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	i2o_device_parse_lct - Parse a previously fetched LCT and create devices</span>
<span class="cm"> *	@c: I2O controller from which the LCT should be parsed.</span>
<span class="cm"> *</span>
<span class="cm"> *	The Logical Configuration Table tells us what we can talk to on the</span>
<span class="cm"> *	board. For every entry we create an I2O device, which is registered in</span>
<span class="cm"> *	the I2O core.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 on success or negative error code on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i2o_device_parse_lct</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2o_controller</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">i2o_lct</span> <span class="o">*</span><span class="n">lct</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">dlct</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">dlct</span><span class="p">.</span><span class="n">virt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">table_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lct_lock</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lct</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">dlct</span><span class="o">++</span><span class="p">);</span>
	<span class="n">table_size</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">lct</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lct</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">table_size</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lct</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lct_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lct</span><span class="o">-&gt;</span><span class="n">lct_ver</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>
	<span class="n">lct</span><span class="o">-&gt;</span><span class="n">boot_tid</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>
	<span class="n">lct</span><span class="o">-&gt;</span><span class="n">table_size</span> <span class="o">=</span> <span class="n">table_size</span><span class="p">;</span>
	<span class="n">lct</span><span class="o">-&gt;</span><span class="n">change_ind</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">dlct</span><span class="o">++</span><span class="p">);</span>
	<span class="n">lct</span><span class="o">-&gt;</span><span class="n">iop_flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">dlct</span><span class="o">++</span><span class="p">);</span>

	<span class="n">table_size</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: LCT has %d entries (LCT size: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span>
		 <span class="n">lct</span><span class="o">-&gt;</span><span class="n">table_size</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">table_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2o_lct_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lct</span><span class="o">-&gt;</span><span class="n">lct_entry</span><span class="p">[</span><span class="n">max</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">dlct</span><span class="o">++</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>

		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">change_ind</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">dlct</span><span class="o">++</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">device_flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">dlct</span><span class="o">++</span><span class="p">);</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">dlct</span><span class="o">++</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">class_id</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">vendor_id</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">sub_class</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">dlct</span><span class="o">++</span><span class="p">);</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">dlct</span><span class="o">++</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">user_tid</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">parent_tid</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">bios_info</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">identity_tag</span><span class="p">,</span> <span class="n">dlct</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">dlct</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">event_capabilities</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">dlct</span><span class="o">++</span><span class="p">);</span>

		<span class="cm">/* add new devices, which are new in the LCT */</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
			<span class="n">i2o_device_add</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>

		<span class="n">table_size</span> <span class="o">-=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">max</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* remove devices, which are not in the LCT anymore */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lct</span><span class="o">-&gt;</span><span class="n">lct_entry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tid</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
			<span class="n">i2o_device_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lct_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Run time support routines</span>
<span class="cm"> */</span>

<span class="cm">/*	Issue UTIL_PARAMS_GET or UTIL_PARAMS_SET</span>
<span class="cm"> *</span>
<span class="cm"> *	This function can be used for all UtilParamsGet/Set operations.</span>
<span class="cm"> *	The OperationList is given in oplist-buffer,</span>
<span class="cm"> *	and results are returned in reslist-buffer.</span>
<span class="cm"> *	Note that the minimum sized reslist is 8 bytes and contains</span>
<span class="cm"> *	ResultCount, ErrorInfoSize, BlockStatus and BlockSize.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i2o_parm_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">i2o_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">oplist</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">oplen</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">reslist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reslen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2o_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2o_dma</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2o_controller</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">iop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">res</span><span class="p">.</span><span class="n">virt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2o_dma_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="n">reslen</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">i2o_msg_get_wait</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">I2O_TIMEOUT_MESSAGE_GET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i2o_dma_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
	    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span> <span class="n">HOST_TID</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span> <span class="o">|</span> <span class="n">i2o_dev</span><span class="o">-&gt;</span><span class="n">lct_data</span><span class="p">.</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x4C000000</span> <span class="o">|</span> <span class="n">oplen</span><span class="p">);</span>	<span class="cm">/* OperationList */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">oplist</span><span class="p">,</span> <span class="n">oplen</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">+=</span> <span class="p">(</span><span class="n">oplen</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">oplen</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xD0000000</span> <span class="o">|</span> <span class="n">res</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>	<span class="cm">/* ResultList */</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">head</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
	    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">I2O_MESSAGE_SIZE</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2o_message</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">SGL_OFFSET_5</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">i2o_msg_post_wait_mem</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>

	<span class="cm">/* This only looks like a memory leak - don&#39;t &quot;fix&quot; it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">reslist</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">virt</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">i2o_dma_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	 Query one field group value or a whole scalar group.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i2o_parm_field_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">i2o_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">group</span><span class="p">,</span> <span class="kt">int</span> <span class="n">field</span><span class="p">,</span>
		       <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">opblk</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">),</span>
		<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">group</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">I2O_PARAMS_FIELD_GET</span><span class="p">),</span>
		<span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">s16</span><span class="p">)</span> <span class="n">field</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="mh">0x00000001</span><span class="p">)</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">resblk</span><span class="p">;</span>		<span class="cm">/* 8 bytes for header */</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">resblk</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buflen</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resblk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">i2o_parm_issue</span><span class="p">(</span><span class="n">i2o_dev</span><span class="p">,</span> <span class="n">I2O_CMD_UTIL_PARAMS_GET</span><span class="p">,</span> <span class="n">opblk</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">opblk</span><span class="p">),</span> <span class="n">resblk</span><span class="p">,</span> <span class="n">buflen</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">resblk</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>	<span class="cm">/* cut off header */</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">resblk</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	if oper == I2O_PARAMS_TABLE_GET, get from all rows</span>
<span class="cm"> *		if fieldcount == -1 return all fields</span>
<span class="cm"> *			ibuf and ibuflen are unused (use NULL, 0)</span>
<span class="cm"> *		else return specific fields</span>
<span class="cm"> *			ibuf contains fieldindexes</span>
<span class="cm"> *</span>
<span class="cm"> *	if oper == I2O_PARAMS_LIST_GET, get from specific rows</span>
<span class="cm"> *		if fieldcount == -1 return all fields</span>
<span class="cm"> *			ibuf contains rowcount, keyvalues</span>
<span class="cm"> *		else return specific fields</span>
<span class="cm"> *			fieldcount is # of fieldindexes</span>
<span class="cm"> *			ibuf contains fieldindexes, rowcount, keyvalues</span>
<span class="cm"> *</span>
<span class="cm"> *	You could also use directly function i2o_issue_params().</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i2o_parm_table_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2o_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oper</span><span class="p">,</span> <span class="kt">int</span> <span class="n">group</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">fieldcount</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ibuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ibuflen</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">resblk</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">reslen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">opblk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">ibuflen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">size</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">opblk</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opblk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;i2o: no memory for query buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">opblk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* operation count */</span>
	<span class="n">opblk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* pad */</span>
	<span class="n">opblk</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">oper</span><span class="p">;</span>
	<span class="n">opblk</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="p">;</span>
	<span class="n">opblk</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">fieldcount</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">opblk</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ibuf</span><span class="p">,</span> <span class="n">ibuflen</span><span class="p">);</span>	<span class="cm">/* other params */</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">i2o_parm_issue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">I2O_CMD_UTIL_PARAMS_GET</span><span class="p">,</span> <span class="n">opblk</span><span class="p">,</span>
			      <span class="n">size</span><span class="p">,</span> <span class="n">resblk</span><span class="p">,</span> <span class="n">reslen</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">opblk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">reslen</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">reslen</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">i2o_device_claim</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">i2o_device_claim_release</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">i2o_parm_field_get</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">i2o_parm_table_get</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">i2o_parm_issue</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
