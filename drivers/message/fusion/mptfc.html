<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › message › fusion › mptfc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mptfc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/message/fusion/mptfc.c</span>
<span class="cm"> *      For use with LSI PCI chip/adapter(s)</span>
<span class="cm"> *      running LSI Fusion MPT (Message Passing Technology) firmware.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 1999-2008 LSI Corporation</span>
<span class="cm"> *  (mailto:DL-MPTFusionLinux@lsi.com)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; version 2 of the License.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    NO WARRANTY</span>
<span class="cm">    THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span>
<span class="cm">    CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT</span>
<span class="cm">    LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,</span>
<span class="cm">    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is</span>
<span class="cm">    solely responsible for determining the appropriateness of using and</span>
<span class="cm">    distributing the Program and assumes all risks associated with its</span>
<span class="cm">    exercise of rights under this Agreement, including but not limited to</span>
<span class="cm">    the risks and costs of program errors, damage to or loss of data,</span>
<span class="cm">    programs or equipment, and unavailability or interruption of operations.</span>

<span class="cm">    DISCLAIMER OF LIABILITY</span>
<span class="cm">    NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY</span>
<span class="cm">    DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm">    DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND</span>
<span class="cm">    ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR</span>
<span class="cm">    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE</span>
<span class="cm">    USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED</span>
<span class="cm">    HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm">*/</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kdev_t.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;	</span><span class="cm">/* for mdelay */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/interrupt.h&gt;	</span><span class="cm">/* needed for in_interrupt() proto */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/reboot.h&gt;	</span><span class="cm">/* notifier code */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/sort.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_fc.h&gt;</span>

<span class="cp">#include &quot;mptbase.h&quot;</span>
<span class="cp">#include &quot;mptscsih.h&quot;</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cp">#define my_NAME		&quot;Fusion MPT FC Host driver&quot;</span>
<span class="cp">#define my_VERSION	MPT_LINUX_VERSION_COMMON</span>
<span class="cp">#define MYNAM		&quot;mptfc&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">MODULEAUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">my_NAME</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">my_VERSION</span><span class="p">);</span>

<span class="cm">/* Command line args */</span>
<span class="cp">#define MPTFC_DEV_LOSS_TMO (60)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptfc_dev_loss_tmo</span> <span class="o">=</span> <span class="n">MPTFC_DEV_LOSS_TMO</span><span class="p">;</span>	<span class="cm">/* reasonable default */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mptfc_dev_loss_tmo</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mptfc_dev_loss_tmo</span><span class="p">,</span> <span class="s">&quot; Initial time the driver programs the &quot;</span>
    				     <span class="s">&quot; transport to wait for an rport to &quot;</span>
				     <span class="s">&quot; return following a device loss event.&quot;</span>
				     <span class="s">&quot;  Default=60.&quot;</span><span class="p">);</span>

<span class="cm">/* scsi-mid layer global parmeter is max_report_luns, which is 511 */</span>
<span class="cp">#define MPTFC_MAX_LUN (16895)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_lun</span> <span class="o">=</span> <span class="n">MPTFC_MAX_LUN</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">max_lun</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_lun</span><span class="p">,</span> <span class="s">&quot; max lun, default=16895 &quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u8</span>	<span class="n">mptfcDoneCtx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span>	<span class="n">mptfcTaskCtx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span>	<span class="n">mptfcInternalCtx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mptfc_target_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptfc_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptfc_qcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptfc_target_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptfc_set_rport_loss_tmo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">timeout</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">mptfc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptfc_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptfc_dev_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptfc_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptfc_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">mptfc_driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>				<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>			<span class="o">=</span> <span class="s">&quot;mptfc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_info</span>			<span class="o">=</span> <span class="n">mptscsih_proc_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>				<span class="o">=</span> <span class="s">&quot;MPT FC Host&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>				<span class="o">=</span> <span class="n">mptscsih_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>			<span class="o">=</span> <span class="n">mptfc_qcmd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_alloc</span>			<span class="o">=</span> <span class="n">mptfc_target_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_alloc</span>			<span class="o">=</span> <span class="n">mptfc_slave_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>		<span class="o">=</span> <span class="n">mptscsih_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_destroy</span>			<span class="o">=</span> <span class="n">mptfc_target_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_destroy</span>			<span class="o">=</span> <span class="n">mptscsih_slave_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span> 		<span class="o">=</span> <span class="n">mptscsih_change_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>		<span class="o">=</span> <span class="n">mptfc_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span>	<span class="o">=</span> <span class="n">mptfc_dev_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_bus_reset_handler</span>		<span class="o">=</span> <span class="n">mptfc_bus_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>		<span class="o">=</span> <span class="n">mptfc_host_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>			<span class="o">=</span> <span class="n">mptscsih_bios_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>			<span class="o">=</span> <span class="n">MPT_FC_CAN_QUEUE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>			<span class="o">=</span> <span class="n">MPT_SCSI_SG_DEPTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span>			<span class="o">=</span> <span class="mi">8192</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>			<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>			<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shost_attrs</span>			<span class="o">=</span> <span class="n">mptscsih_host_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * Supported hardware</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">mptfc_pci_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LSI_LOGIC</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC909</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LSI_LOGIC</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC919</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LSI_LOGIC</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC929</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LSI_LOGIC</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC919X</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LSI_LOGIC</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC929X</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LSI_LOGIC</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC939X</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LSI_LOGIC</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC949X</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LSI_LOGIC</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC949E</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_BROCADE</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC949E</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">}</span>	<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">mptfc_pci_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">mptfc_transport_template</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fc_function_template</span> <span class="n">mptfc_transport_functions</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dd_fcrport_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_node_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_classes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rport_supported_classes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_node_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_port_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_starget_port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="n">mptfc_set_rport_loss_tmo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rport_dev_loss_tmo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_supported_speeds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_maxframe_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_speed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_fabric_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_port_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_host_symbolic_name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_block_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">),</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">caller</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span>		<span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span>	<span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>	<span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport</span>		<span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">starget_to_rport</span><span class="p">(</span><span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ready</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> 		<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">loops</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>	<span class="cm">/* seconds */</span>

	<span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ready</span> <span class="o">=</span> <span class="n">fc_remote_port_chkready</span><span class="p">(</span><span class="n">rport</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="n">DID_IMM_RETRY</span>
	 <span class="o">||</span> <span class="p">(</span><span class="n">loops</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dfcprintk</span> <span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			<span class="s">&quot;mptfc_block_error_handler.%d: %d:%d, port status is &quot;</span>
			<span class="s">&quot;%x, active flag %d, deferring %s recovery.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
			<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
			<span class="n">ready</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="n">caller</span><span class="p">));</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">loops</span> <span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ready</span> <span class="o">==</span> <span class="n">DID_NO_CONNECT</span> <span class="o">||</span> <span class="o">!</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span>
	 <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfcprintk</span> <span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			<span class="s">&quot;%s.%d: %d:%d, failing recovery, &quot;</span>
			<span class="s">&quot;port state %x, active %d, vdevice %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
			<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="n">ready</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dfcprintk</span> <span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		<span class="s">&quot;%s.%d: %d:%d, executing recovery.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">caller</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="n">SCpnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>
	    <span class="n">mptfc_block_error_handler</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">mptscsih_abort</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_dev_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>
	    <span class="n">mptfc_block_error_handler</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">mptscsih_dev_reset</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>
	    <span class="n">mptfc_block_error_handler</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">mptscsih_bus_reset</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span>
	    <span class="n">mptfc_block_error_handler</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span> <span class="n">mptscsih_host_reset</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptfc_set_rport_loss_tmo</span><span class="p">(</span><span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">dev_loss_tmo</span> <span class="o">=</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rport</span><span class="o">-&gt;</span><span class="n">dev_loss_tmo</span> <span class="o">=</span> <span class="n">mptfc_dev_loss_tmo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_FcDevPage0_cmp_func</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FCDevicePage0_t</span> <span class="o">**</span><span class="n">aa</span> <span class="o">=</span> <span class="p">(</span><span class="n">FCDevicePage0_t</span> <span class="o">**</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
	<span class="n">FCDevicePage0_t</span> <span class="o">**</span><span class="n">bb</span> <span class="o">=</span> <span class="p">(</span><span class="n">FCDevicePage0_t</span> <span class="o">**</span><span class="p">)</span><span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">aa</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">CurrentBus</span> <span class="o">==</span> <span class="p">(</span><span class="o">*</span><span class="n">bb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">CurrentBus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">aa</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">CurrentTargetID</span> <span class="o">==</span> <span class="p">(</span><span class="o">*</span><span class="n">bb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">CurrentTargetID</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">aa</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">CurrentTargetID</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">bb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">CurrentTargetID</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">aa</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">CurrentBus</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">bb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">CurrentBus</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_GetFcDevPage0</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ioc_port</span><span class="p">,</span>
	<span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span><span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">FCDevicePage0_t</span> <span class="o">*</span><span class="n">arg</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">ConfigPageHeader_t</span>	 <span class="n">hdr</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span>		 <span class="n">cfg</span><span class="p">;</span>
	<span class="n">FCDevicePage0_t</span>		<span class="o">*</span><span class="n">ppage0_alloc</span><span class="p">,</span> <span class="o">*</span><span class="n">fc</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		 <span class="n">page0_dma</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">data_sz</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">ii</span><span class="p">;</span>

	<span class="n">FCDevicePage0_t</span>		<span class="o">*</span><span class="n">p0_array</span><span class="o">=</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">p_p0</span><span class="p">;</span>
	<span class="n">FCDevicePage0_t</span>		<span class="o">**</span><span class="n">pp0_array</span><span class="o">=</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">**</span><span class="n">p_pp0</span><span class="p">;</span>

	<span class="kt">int</span>			 <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">U32</span>			 <span class="n">port_id</span> <span class="o">=</span> <span class="mh">0xffffff</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">num_targ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">max_bus</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxBuses</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">max_targ</span><span class="p">;</span>

	<span class="n">max_targ</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxDevices</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxDevices</span><span class="p">;</span>

	<span class="n">data_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FCDevicePage0_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_bus</span> <span class="o">*</span> <span class="n">max_targ</span><span class="p">;</span>
	<span class="n">p_p0</span> <span class="o">=</span> <span class="n">p0_array</span> <span class="o">=</span>  <span class="n">kzalloc</span><span class="p">(</span><span class="n">data_sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p0_array</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">data_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FCDevicePage0_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_bus</span> <span class="o">*</span> <span class="n">max_targ</span><span class="p">;</span>
	<span class="n">p_pp0</span> <span class="o">=</span> <span class="n">pp0_array</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">data_sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp0_array</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Get FC Device Page 0 header */</span>
		<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_FC_DEVICE</span><span class="p">;</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">port_id</span><span class="p">;</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">data_sz</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ppage0_alloc</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">,</span>
		    					<span class="o">&amp;</span><span class="n">page0_dma</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppage0_alloc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">page0_dma</span><span class="p">;</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppage0_alloc</span><span class="o">-&gt;</span><span class="n">PortIdentifier</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ppage0_alloc</span><span class="o">-&gt;</span><span class="n">PortIdentifier</span><span class="p">);</span>

			<span class="n">ppage0_alloc</span><span class="o">-&gt;</span><span class="n">WWNN</span><span class="p">.</span><span class="n">Low</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ppage0_alloc</span><span class="o">-&gt;</span><span class="n">WWNN</span><span class="p">.</span><span class="n">Low</span><span class="p">);</span>

			<span class="n">ppage0_alloc</span><span class="o">-&gt;</span><span class="n">WWNN</span><span class="p">.</span><span class="n">High</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ppage0_alloc</span><span class="o">-&gt;</span><span class="n">WWNN</span><span class="p">.</span><span class="n">High</span><span class="p">);</span>

			<span class="n">ppage0_alloc</span><span class="o">-&gt;</span><span class="n">WWPN</span><span class="p">.</span><span class="n">Low</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ppage0_alloc</span><span class="o">-&gt;</span><span class="n">WWPN</span><span class="p">.</span><span class="n">Low</span><span class="p">);</span>

			<span class="n">ppage0_alloc</span><span class="o">-&gt;</span><span class="n">WWPN</span><span class="p">.</span><span class="n">High</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ppage0_alloc</span><span class="o">-&gt;</span><span class="n">WWPN</span><span class="p">.</span><span class="n">High</span><span class="p">);</span>

			<span class="n">ppage0_alloc</span><span class="o">-&gt;</span><span class="n">BBCredit</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ppage0_alloc</span><span class="o">-&gt;</span><span class="n">BBCredit</span><span class="p">);</span>

			<span class="n">ppage0_alloc</span><span class="o">-&gt;</span><span class="n">MaxRxFrameSize</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ppage0_alloc</span><span class="o">-&gt;</span><span class="n">MaxRxFrameSize</span><span class="p">);</span>

			<span class="n">port_id</span> <span class="o">=</span> <span class="n">ppage0_alloc</span><span class="o">-&gt;</span><span class="n">PortIdentifier</span><span class="p">;</span>
			<span class="n">num_targ</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p_p0</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppage0_alloc</span><span class="p">;</span>	<span class="cm">/* save data */</span>
			<span class="o">*</span><span class="n">p_pp0</span><span class="o">++</span> <span class="o">=</span> <span class="n">p_p0</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* save addr */</span>
		<span class="p">}</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">,</span>
		    			<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppage0_alloc</span><span class="p">,</span> <span class="n">page0_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">port_id</span> <span class="o">&lt;=</span> <span class="mh">0xff0000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_targ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* sort array */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_targ</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">sort</span> <span class="p">(</span><span class="n">pp0_array</span><span class="p">,</span> <span class="n">num_targ</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FCDevicePage0_t</span> <span class="o">*</span><span class="p">),</span>
				<span class="n">mptfc_FcDevPage0_cmp_func</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="cm">/* call caller&#39;s func for each targ */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">num_targ</span><span class="p">;</span>  <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fc</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">pp0_array</span><span class="o">+</span><span class="n">ii</span><span class="p">);</span>
			<span class="n">func</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc_port</span><span class="p">,</span> <span class="n">fc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pp0_array</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p0_array</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_generate_rport_ids</span><span class="p">(</span><span class="n">FCDevicePage0_t</span> <span class="o">*</span><span class="n">pg0</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_rport_identifiers</span> <span class="o">*</span><span class="n">rid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* not currently usable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MPI_FC_DEVICE_PAGE0_FLAGS_PLOGI_INVALID</span> <span class="o">|</span>
			  <span class="n">MPI_FC_DEVICE_PAGE0_FLAGS_PRLI_INVALID</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">MPI_FC_DEVICE_PAGE0_FLAGS_TARGETID_BUS_VALID</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">Protocol</span> <span class="o">&amp;</span> <span class="n">MPI_FC_DEVICE_PAGE0_PROT_FCP_TARGET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * board data structure already normalized to platform endianness</span>
<span class="cm">	 * shifted to avoid unaligned access on 64 bit architecture</span>
<span class="cm">	 */</span>
	<span class="n">rid</span><span class="o">-&gt;</span><span class="n">node_name</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">WWNN</span><span class="p">.</span><span class="n">High</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">WWNN</span><span class="p">.</span><span class="n">Low</span><span class="p">;</span>
	<span class="n">rid</span><span class="o">-&gt;</span><span class="n">port_name</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">WWPN</span><span class="p">.</span><span class="n">High</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">WWPN</span><span class="p">.</span><span class="n">Low</span><span class="p">;</span>
	<span class="n">rid</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">=</span>   <span class="n">pg0</span><span class="o">-&gt;</span><span class="n">PortIdentifier</span><span class="p">;</span>
	<span class="n">rid</span><span class="o">-&gt;</span><span class="n">roles</span> <span class="o">=</span> <span class="n">FC_RPORT_ROLE_UNKNOWN</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptfc_register_dev</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">FCDevicePage0_t</span> <span class="o">*</span><span class="n">pg0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport_identifiers</span> <span class="n">rport_ids</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport</span>		<span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptfc_rport_info</span>	<span class="o">*</span><span class="n">ri</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">new_ri</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">pn</span><span class="p">,</span> <span class="n">nn</span><span class="p">;</span>
	<span class="n">VirtTarget</span>		<span class="o">*</span><span class="n">vtarget</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">roles</span> <span class="o">=</span> <span class="n">FC_RPORT_ROLE_UNKNOWN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mptfc_generate_rport_ids</span><span class="p">(</span><span class="n">pg0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport_ids</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">roles</span> <span class="o">|=</span> <span class="n">FC_RPORT_ROLE_FCP_TARGET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">Protocol</span> <span class="o">&amp;</span> <span class="n">MPI_FC_DEVICE_PAGE0_PROT_FCP_INITIATOR</span><span class="p">)</span>
		<span class="n">roles</span> <span class="o">|=</span> <span class="n">FC_RPORT_ROLE_FCP_INITIATOR</span><span class="p">;</span>

	<span class="cm">/* scan list looking for a match */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pn</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">WWPN</span><span class="p">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">WWPN</span><span class="p">.</span><span class="n">Low</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pn</span> <span class="o">==</span> <span class="n">rport_ids</span><span class="p">.</span><span class="n">port_name</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* match */</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rports</span><span class="p">);</span>
			<span class="n">new_ri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_ri</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* allocate one */</span>
		<span class="n">ri</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptfc_rport_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ri</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rports</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span> <span class="o">=</span> <span class="o">*</span><span class="n">pg0</span><span class="p">;</span>	<span class="cm">/* add/update pg0 data */</span>
	<span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT_RPORT_INFO_FLAGS_MISSING</span><span class="p">;</span>

	<span class="cm">/* MPT_RPORT_INFO_FLAGS_REGISTERED - rport not previously deleted */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_RPORT_INFO_FLAGS_REGISTERED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MPT_RPORT_INFO_FLAGS_REGISTERED</span><span class="p">;</span>
		<span class="n">rport</span> <span class="o">=</span> <span class="n">fc_remote_port_add</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rport_ids</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ri</span><span class="o">-&gt;</span><span class="n">rport</span> <span class="o">=</span> <span class="n">rport</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_ri</span><span class="p">)</span> <span class="cm">/* may have been reset by user */</span>
				<span class="n">rport</span><span class="o">-&gt;</span><span class="n">dev_loss_tmo</span> <span class="o">=</span> <span class="n">mptfc_dev_loss_tmo</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * if already mapped, remap here.  If not mapped,</span>
<span class="cm">			 * target_alloc will allocate vtarget and map,</span>
<span class="cm">			 * slave_alloc will fill in vdevice from vtarget.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vtarget</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vtarget</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">pg0</span><span class="o">-&gt;</span><span class="n">CurrentTargetID</span><span class="p">;</span>
					<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">pg0</span><span class="o">-&gt;</span><span class="n">CurrentBus</span><span class="p">;</span>
					<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">mptfc_rport_info</span> <span class="o">**</span><span class="p">)</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">)</span> <span class="o">=</span> <span class="n">ri</span><span class="p">;</span>
			<span class="cm">/* scan will be scheduled once rport becomes a target */</span>
			<span class="n">fc_remote_port_rolechg</span><span class="p">(</span><span class="n">rport</span><span class="p">,</span><span class="n">roles</span><span class="p">);</span>

			<span class="n">pn</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">WWPN</span><span class="p">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">WWPN</span><span class="p">.</span><span class="n">Low</span><span class="p">;</span>
			<span class="n">nn</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">WWNN</span><span class="p">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">WWNN</span><span class="p">.</span><span class="n">Low</span><span class="p">;</span>
			<span class="n">dfcprintk</span> <span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
				<span class="s">&quot;mptfc_reg_dev.%d: %x, %llx / %llx, tid %d, &quot;</span>
				<span class="s">&quot;rport tid %d, tmo %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
					<span class="n">pg0</span><span class="o">-&gt;</span><span class="n">PortIdentifier</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">nn</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pn</span><span class="p">,</span>
					<span class="n">pg0</span><span class="o">-&gt;</span><span class="n">CurrentTargetID</span><span class="p">,</span>
					<span class="n">ri</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">scsi_target_id</span><span class="p">,</span>
					<span class="n">ri</span><span class="o">-&gt;</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">dev_loss_tmo</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>
			<span class="n">ri</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	OS entry point to allow for host driver to free allocated memory</span>
<span class="cm"> *	Called if no device present or device being unloaded</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptfc_target_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fc_rport</span>		<span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptfc_rport_info</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>

	<span class="n">rport</span> <span class="o">=</span> <span class="n">starget_to_rport</span><span class="p">(</span><span class="n">starget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ri</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">mptfc_rport_info</span> <span class="o">**</span><span class="p">)</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="p">)</span>	<span class="cm">/* better be! */</span>
			<span class="n">ri</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">);</span>
	<span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	OS entry point to allow host driver to alloc memory</span>
<span class="cm"> *	for each scsi target. Called once per device the bus scan.</span>
<span class="cm"> *	Return non-zero if allocation fails.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_target_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">VirtTarget</span>		<span class="o">*</span><span class="n">vtarget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport</span>		<span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptfc_rport_info</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">rc</span><span class="p">;</span>

	<span class="n">vtarget</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">VirtTarget</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vtarget</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">vtarget</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">rport</span> <span class="o">=</span> <span class="n">starget_to_rport</span><span class="p">(</span><span class="n">starget</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ri</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">mptfc_rport_info</span> <span class="o">**</span><span class="p">)</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* better be! */</span>
			<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">CurrentTargetID</span><span class="p">;</span>
			<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">CurrentBus</span><span class="p">;</span>
			<span class="n">ri</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">=</span> <span class="n">starget</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vtarget</span><span class="p">);</span>
		<span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> *	mptfc_dump_lun_info</span>
<span class="cm"> *	@ioc</span>
<span class="cm"> *	@rport</span>
<span class="cm"> *	@sdev</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptfc_dump_lun_info</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fc_rport</span> <span class="o">*</span><span class="n">rport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span>
		<span class="n">VirtTarget</span> <span class="o">*</span><span class="n">vtarget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">nn</span><span class="p">,</span> <span class="n">pn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptfc_rport_info</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>

	<span class="n">ri</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">mptfc_rport_info</span> <span class="o">**</span><span class="p">)</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">);</span>
	<span class="n">pn</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">WWPN</span><span class="p">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">WWPN</span><span class="p">.</span><span class="n">Low</span><span class="p">;</span>
	<span class="n">nn</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">WWNN</span><span class="p">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">WWNN</span><span class="p">.</span><span class="n">Low</span><span class="p">;</span>
	<span class="n">dfcprintk</span> <span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		<span class="s">&quot;mptfc_slv_alloc.%d: num_luns %d, sdev.id %d, &quot;</span>
		<span class="s">&quot;CurrentTargetID %d, %x %llx %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
		<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">num_luns</span><span class="p">,</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">CurrentTargetID</span><span class="p">,</span>
		<span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">PortIdentifier</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pn</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">nn</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	OS entry point to allow host driver to alloc memory</span>
<span class="cm"> *	for each scsi device. Called once per device the bus scan.</span>
<span class="cm"> *	Return non-zero if allocation fails.</span>
<span class="cm"> *	Init memory once per LUN.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span>		<span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="n">VirtTarget</span>		<span class="o">*</span><span class="n">vtarget</span><span class="p">;</span>
	<span class="n">VirtDevice</span>		<span class="o">*</span><span class="n">vdevice</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span>	<span class="o">*</span><span class="n">starget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport</span>		<span class="o">*</span><span class="n">rport</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> 		<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>

	<span class="n">starget</span> <span class="o">=</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="n">rport</span> <span class="o">=</span> <span class="n">starget_to_rport</span><span class="p">(</span><span class="n">starget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rport</span> <span class="o">||</span> <span class="n">fc_remote_port_chkready</span><span class="p">(</span><span class="n">rport</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="n">vdevice</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">VirtDevice</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdevice</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;slave_alloc kmalloc(%zd) FAILED!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">VirtDevice</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">vdevice</span><span class="p">;</span>
	<span class="n">vtarget</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">num_luns</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">ioc_id</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">=</span> <span class="n">MPT_TARGET_FLAGS_Q_YES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span> <span class="o">=</span> <span class="n">vtarget</span><span class="p">;</span>
	<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>

	<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">num_luns</span><span class="o">++</span><span class="p">;</span>


	<span class="n">mptfc_dump_lun_info</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">rport</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="n">vtarget</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_qcmd_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptfc_rport_info</span>	<span class="o">*</span><span class="n">ri</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fc_rport</span>	<span class="o">*</span><span class="n">rport</span> <span class="o">=</span> <span class="n">starget_to_rport</span><span class="p">(</span><span class="n">scsi_target</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">));</span>
	<span class="kt">int</span>		<span class="n">err</span><span class="p">;</span>
	<span class="n">VirtDevice</span>	<span class="o">*</span><span class="n">vdevice</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdevice</span> <span class="o">||</span> <span class="o">!</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">done</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fc_remote_port_chkready</span><span class="p">(</span><span class="n">rport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">done</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* dd_data is null until finished adding target */</span>
	<span class="n">ri</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">mptfc_rport_info</span> <span class="o">**</span><span class="p">)</span><span class="n">rport</span><span class="o">-&gt;</span><span class="n">dd_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ri</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_IMM_RETRY</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">done</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mptscsih_qcmd</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span><span class="n">done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">mptfc_qcmd</span><span class="p">)</span>

<span class="cm">/*</span>
<span class="cm"> *	mptfc_display_port_link_speed - displaying link speed</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@portnum: IOC Port number</span>
<span class="cm"> *	@pp0dest: port page0 data payload</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="n">mptfc_display_port_link_speed</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portnum</span><span class="p">,</span> <span class="n">FCPortPage0_t</span> <span class="o">*</span><span class="n">pp0dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>	<span class="n">old_speed</span><span class="p">,</span> <span class="n">new_speed</span><span class="p">,</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portnum</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">old_speed</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_link_speed</span><span class="p">[</span><span class="n">portnum</span><span class="p">];</span>
	<span class="n">new_speed</span> <span class="o">=</span> <span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">CurrentSpeed</span><span class="p">;</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">PortState</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">MPI_FCPORTPAGE0_PORTSTATE_OFFLINE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new_speed</span> <span class="o">!=</span> <span class="n">MPI_FCPORTPAGE0_CURRENT_SPEED_UKNOWN</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">old</span> <span class="o">=</span> <span class="n">old_speed</span> <span class="o">==</span> <span class="n">MPI_FCPORTPAGE0_CURRENT_SPEED_1GBIT</span> <span class="o">?</span> <span class="s">&quot;1 Gbps&quot;</span> <span class="o">:</span>
		       <span class="n">old_speed</span> <span class="o">==</span> <span class="n">MPI_FCPORTPAGE0_CURRENT_SPEED_2GBIT</span> <span class="o">?</span> <span class="s">&quot;2 Gbps&quot;</span> <span class="o">:</span>
			<span class="n">old_speed</span> <span class="o">==</span> <span class="n">MPI_FCPORTPAGE0_CURRENT_SPEED_4GBIT</span> <span class="o">?</span> <span class="s">&quot;4 Gbps&quot;</span> <span class="o">:</span>
			 <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">new_speed</span> <span class="o">==</span> <span class="n">MPI_FCPORTPAGE0_CURRENT_SPEED_1GBIT</span> <span class="o">?</span> <span class="s">&quot;1 Gbps&quot;</span> <span class="o">:</span>
		       <span class="n">new_speed</span> <span class="o">==</span> <span class="n">MPI_FCPORTPAGE0_CURRENT_SPEED_2GBIT</span> <span class="o">?</span> <span class="s">&quot;2 Gbps&quot;</span> <span class="o">:</span>
			<span class="n">new_speed</span> <span class="o">==</span> <span class="n">MPI_FCPORTPAGE0_CURRENT_SPEED_4GBIT</span> <span class="o">?</span> <span class="s">&quot;4 Gbps&quot;</span> <span class="o">:</span>
			 <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_speed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_NOTE_FMT</span>
				<span class="s">&quot;FC Link Established, Speed = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old_speed</span> <span class="o">!=</span> <span class="n">new_speed</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
				<span class="s">&quot;FC Link Speed Change, Old Speed = %s, New Speed = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>

		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_link_speed</span><span class="p">[</span><span class="n">portnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_speed</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	mptfc_GetFcPortPage0 - Fetch FCPort config Page0.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@portnum: IOC Port number</span>
<span class="cm"> *</span>
<span class="cm"> *	Return: 0 for success</span>
<span class="cm"> *	-ENOMEM if no memory available</span>
<span class="cm"> *		-EPERM if not allowed due to ISR context</span>
<span class="cm"> *		-EAGAIN if no msg frames currently available</span>
<span class="cm"> *		-EFAULT for non-successful reply or no reply (timeout)</span>
<span class="cm"> *		-EINVAL portnum arg out of range (hardwired to two elements)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_GetFcPortPage0</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ConfigPageHeader_t</span>	 <span class="n">hdr</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span>		 <span class="n">cfg</span><span class="p">;</span>
	<span class="n">FCPortPage0_t</span>		<span class="o">*</span><span class="n">ppage0_alloc</span><span class="p">;</span>
	<span class="n">FCPortPage0_t</span>		<span class="o">*</span><span class="n">pp0dest</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		 <span class="n">page0_dma</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">data_sz</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">copy_sz</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">count</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portnum</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Get FCPort Page 0 header */</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_FC_PORT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">portnum</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">data_sz</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ppage0_alloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">FCPortPage0_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page0_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppage0_alloc</span><span class="p">)</span> <span class="p">{</span>

 <span class="nl">try_again:</span>
		<span class="n">memset</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ppage0_alloc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">);</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">page0_dma</span><span class="p">;</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* save the data */</span>
			<span class="n">pp0dest</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_port_page0</span><span class="p">[</span><span class="n">portnum</span><span class="p">];</span>
			<span class="n">copy_sz</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FCPortPage0_t</span><span class="p">),</span> <span class="n">data_sz</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">pp0dest</span><span class="p">,</span> <span class="n">ppage0_alloc</span><span class="p">,</span> <span class="n">copy_sz</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 *	Normalize endianness of structure data,</span>
<span class="cm">			 *	by byte-swapping all &gt; 1 byte fields!</span>
<span class="cm">			 */</span>
			<span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
			<span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">PortIdentifier</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">PortIdentifier</span><span class="p">);</span>
			<span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">WWNN</span><span class="p">.</span><span class="n">Low</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">WWNN</span><span class="p">.</span><span class="n">Low</span><span class="p">);</span>
			<span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">WWNN</span><span class="p">.</span><span class="n">High</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">WWNN</span><span class="p">.</span><span class="n">High</span><span class="p">);</span>
			<span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">WWPN</span><span class="p">.</span><span class="n">Low</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">WWPN</span><span class="p">.</span><span class="n">Low</span><span class="p">);</span>
			<span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">WWPN</span><span class="p">.</span><span class="n">High</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">WWPN</span><span class="p">.</span><span class="n">High</span><span class="p">);</span>
			<span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">SupportedServiceClass</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">SupportedServiceClass</span><span class="p">);</span>
			<span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">SupportedSpeeds</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">SupportedSpeeds</span><span class="p">);</span>
			<span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">CurrentSpeed</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">CurrentSpeed</span><span class="p">);</span>
			<span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">MaxFrameSize</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">MaxFrameSize</span><span class="p">);</span>
			<span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">FabricWWNN</span><span class="p">.</span><span class="n">Low</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">FabricWWNN</span><span class="p">.</span><span class="n">Low</span><span class="p">);</span>
			<span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">FabricWWNN</span><span class="p">.</span><span class="n">High</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">FabricWWNN</span><span class="p">.</span><span class="n">High</span><span class="p">);</span>
			<span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">FabricWWPN</span><span class="p">.</span><span class="n">Low</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">FabricWWPN</span><span class="p">.</span><span class="n">Low</span><span class="p">);</span>
			<span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">FabricWWPN</span><span class="p">.</span><span class="n">High</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">FabricWWPN</span><span class="p">.</span><span class="n">High</span><span class="p">);</span>
			<span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">DiscoveredPortsCount</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">DiscoveredPortsCount</span><span class="p">);</span>
			<span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">MaxInitiators</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">MaxInitiators</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * if still doing discovery,</span>
<span class="cm">			 * hang loose a while until finished</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">PortState</span> <span class="o">==</span> <span class="n">MPI_FCPORTPAGE0_PORTSTATE_UNKNOWN</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">PortState</span> <span class="o">==</span> <span class="n">MPI_FCPORTPAGE0_PORTSTATE_ONLINE</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">pp0dest</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">MPI_FCPORTPAGE0_FLAGS_ATTACH_TYPE_MASK</span><span class="p">)</span>
			      <span class="o">==</span> <span class="n">MPI_FCPORTPAGE0_FLAGS_ATTACH_NO_INIT</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;Firmware discovery not&quot;</span>
							<span class="s">&quot; complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">mptfc_display_port_link_speed</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">portnum</span><span class="p">,</span> <span class="n">pp0dest</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppage0_alloc</span><span class="p">,</span> <span class="n">page0_dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_WriteFcPortPage1</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ConfigPageHeader_t</span>	 <span class="n">hdr</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span>		 <span class="n">cfg</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portnum</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">portnum</span><span class="p">].</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* get fcport page 1 header */</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_FC_PORT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">portnum</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span><span class="o">*</span><span class="mi">4</span> <span class="o">!=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">portnum</span><span class="p">].</span><span class="n">pg_sz</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">portnum</span><span class="p">].</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_GetFcPortPage1</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ConfigPageHeader_t</span>	 <span class="n">hdr</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span>		 <span class="n">cfg</span><span class="p">;</span>
	<span class="n">FCPortPage1_t</span>		<span class="o">*</span><span class="n">page1_alloc</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		 <span class="n">page1_dma</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">data_sz</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portnum</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* get fcport page 1 header */</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_FC_PORT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">portnum</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="nl">start_over:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">portnum</span><span class="p">].</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data_sz</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_sz</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FCPortPage1_t</span><span class="p">))</span>
			<span class="n">data_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FCPortPage1_t</span><span class="p">);</span>

		<span class="n">page1_alloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">FCPortPage1_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
						<span class="n">data_sz</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">page1_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page1_alloc</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">page1_alloc</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">portnum</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>
		<span class="n">page1_dma</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">portnum</span><span class="p">].</span><span class="n">dma</span><span class="p">;</span>
		<span class="n">data_sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">portnum</span><span class="p">].</span><span class="n">pg_sz</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="n">data_sz</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">portnum</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">page1_alloc</span><span class="p">,</span> <span class="n">page1_dma</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">start_over</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">page1_alloc</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">data_sz</span><span class="p">);</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">page1_dma</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">portnum</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">page1_alloc</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">portnum</span><span class="p">].</span><span class="n">pg_sz</span> <span class="o">=</span> <span class="n">data_sz</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">portnum</span><span class="p">].</span><span class="n">dma</span> <span class="o">=</span> <span class="n">page1_dma</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">portnum</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">page1_alloc</span><span class="p">,</span> <span class="n">page1_dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptfc_SetFcPortPage1_defaults</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">ii</span><span class="p">;</span>
	<span class="n">FCPortPage1_t</span>	<span class="o">*</span><span class="n">pp1</span><span class="p">;</span>

	<span class="cp">#define MPTFC_FW_DEVICE_TIMEOUT	(1)</span>
	<span class="cp">#define MPTFC_FW_IO_PEND_TIMEOUT (1)</span>
	<span class="cp">#define ON_FLAGS  (MPI_FCPORTPAGE1_FLAGS_IMMEDIATE_ERROR_REPLY)</span>
	<span class="cp">#define OFF_FLAGS (MPI_FCPORTPAGE1_FLAGS_VERBOSE_RESCAN_EVENTS)</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span><span class="o">&lt;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mptfc_GetFcPortPage1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ii</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">pp1</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pp1</span><span class="o">-&gt;</span><span class="n">InitiatorDeviceTimeout</span> <span class="o">==</span> <span class="n">MPTFC_FW_DEVICE_TIMEOUT</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pp1</span><span class="o">-&gt;</span><span class="n">InitiatorIoPendTimeout</span> <span class="o">==</span> <span class="n">MPTFC_FW_IO_PEND_TIMEOUT</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">pp1</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">ON_FLAGS</span><span class="p">)</span> <span class="o">==</span> <span class="n">ON_FLAGS</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">pp1</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">OFF_FLAGS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">pp1</span><span class="o">-&gt;</span><span class="n">InitiatorDeviceTimeout</span> <span class="o">=</span> <span class="n">MPTFC_FW_DEVICE_TIMEOUT</span><span class="p">;</span>
		<span class="n">pp1</span><span class="o">-&gt;</span><span class="n">InitiatorIoPendTimeout</span> <span class="o">=</span> <span class="n">MPTFC_FW_IO_PEND_TIMEOUT</span><span class="p">;</span>
		<span class="n">pp1</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OFF_FLAGS</span><span class="p">;</span>
		<span class="n">pp1</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">|=</span> <span class="n">ON_FLAGS</span><span class="p">;</span>
		<span class="n">mptfc_WriteFcPortPage1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptfc_init_host_attr</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span><span class="kt">int</span> <span class="n">portnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>	<span class="n">class</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">cos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">speed</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">port_type</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">port_state</span><span class="p">;</span>
	<span class="n">FCPortPage0_t</span>	<span class="o">*</span><span class="n">pp0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">sn</span><span class="p">;</span>

	<span class="cm">/* don&#39;t know what to do as only one scsi (fc) host was allocated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">portnum</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pp0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_port_page0</span><span class="p">[</span><span class="n">portnum</span><span class="p">];</span>
	<span class="n">sh</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">;</span>

	<span class="n">sn</span> <span class="o">=</span> <span class="n">fc_host_symbolic_name</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="n">FC_SYMBOLIC_NAME_SIZE</span><span class="p">,</span> <span class="s">&quot;%s %s%08xh&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">prod_name</span><span class="p">,</span>
	    <span class="n">MPT_FW_REV_MAGIC_ID_STRING</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span><span class="p">);</span>

	<span class="n">fc_host_tgtid_bind_type</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span> <span class="o">=</span> <span class="n">FC_TGTID_BIND_BY_WWPN</span><span class="p">;</span>

	<span class="n">fc_host_maxframe_size</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span> <span class="o">=</span> <span class="n">pp0</span><span class="o">-&gt;</span><span class="n">MaxFrameSize</span><span class="p">;</span>

	<span class="n">fc_host_node_name</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span> <span class="o">=</span>
	    	<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">WWNN</span><span class="p">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">WWNN</span><span class="p">.</span><span class="n">Low</span><span class="p">;</span>

	<span class="n">fc_host_port_name</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span> <span class="o">=</span>
	    	<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">WWPN</span><span class="p">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">WWPN</span><span class="p">.</span><span class="n">Low</span><span class="p">;</span>

	<span class="n">fc_host_port_id</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span> <span class="o">=</span> <span class="n">pp0</span><span class="o">-&gt;</span><span class="n">PortIdentifier</span><span class="p">;</span>

	<span class="n">class</span> <span class="o">=</span> <span class="n">pp0</span><span class="o">-&gt;</span><span class="n">SupportedServiceClass</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">&amp;</span> <span class="n">MPI_FCPORTPAGE0_SUPPORT_CLASS_1</span><span class="p">)</span>
		<span class="n">cos</span> <span class="o">|=</span> <span class="n">FC_COS_CLASS1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">&amp;</span> <span class="n">MPI_FCPORTPAGE0_SUPPORT_CLASS_2</span><span class="p">)</span>
		<span class="n">cos</span> <span class="o">|=</span> <span class="n">FC_COS_CLASS2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">class</span> <span class="o">&amp;</span> <span class="n">MPI_FCPORTPAGE0_SUPPORT_CLASS_3</span><span class="p">)</span>
		<span class="n">cos</span> <span class="o">|=</span> <span class="n">FC_COS_CLASS3</span><span class="p">;</span>
	<span class="n">fc_host_supported_classes</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span> <span class="o">=</span> <span class="n">cos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">CurrentSpeed</span> <span class="o">==</span> <span class="n">MPI_FCPORTPAGE0_CURRENT_SPEED_1GBIT</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_1GBIT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">CurrentSpeed</span> <span class="o">==</span> <span class="n">MPI_FCPORTPAGE0_CURRENT_SPEED_2GBIT</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_2GBIT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">CurrentSpeed</span> <span class="o">==</span> <span class="n">MPI_FCPORTPAGE0_CURRENT_SPEED_4GBIT</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_4GBIT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">CurrentSpeed</span> <span class="o">==</span> <span class="n">MPI_FCPORTPAGE0_CURRENT_SPEED_10GBIT</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_10GBIT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">FC_PORTSPEED_UNKNOWN</span><span class="p">;</span>
	<span class="n">fc_host_speed</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>

	<span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">SupportedSpeeds</span> <span class="o">&amp;</span> <span class="n">MPI_FCPORTPAGE0_SUPPORT_1GBIT_SPEED</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">|=</span> <span class="n">FC_PORTSPEED_1GBIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">SupportedSpeeds</span> <span class="o">&amp;</span> <span class="n">MPI_FCPORTPAGE0_SUPPORT_2GBIT_SPEED</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">|=</span> <span class="n">FC_PORTSPEED_2GBIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">SupportedSpeeds</span> <span class="o">&amp;</span> <span class="n">MPI_FCPORTPAGE0_SUPPORT_4GBIT_SPEED</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">|=</span> <span class="n">FC_PORTSPEED_4GBIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">SupportedSpeeds</span> <span class="o">&amp;</span> <span class="n">MPI_FCPORTPAGE0_SUPPORT_10GBIT_SPEED</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">|=</span> <span class="n">FC_PORTSPEED_10GBIT</span><span class="p">;</span>
	<span class="n">fc_host_supported_speeds</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>

	<span class="n">port_state</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_UNKNOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">PortState</span> <span class="o">==</span> <span class="n">MPI_FCPORTPAGE0_PORTSTATE_ONLINE</span><span class="p">)</span>
		<span class="n">port_state</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_ONLINE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">PortState</span> <span class="o">==</span> <span class="n">MPI_FCPORTPAGE0_PORTSTATE_OFFLINE</span><span class="p">)</span>
		<span class="n">port_state</span> <span class="o">=</span> <span class="n">FC_PORTSTATE_LINKDOWN</span><span class="p">;</span>
	<span class="n">fc_host_port_state</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span> <span class="o">=</span> <span class="n">port_state</span><span class="p">;</span>

	<span class="n">port_type</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_UNKNOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">MPI_FCPORTPAGE0_FLAGS_ATTACH_POINT_TO_POINT</span><span class="p">)</span>
		<span class="n">port_type</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_PTP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">MPI_FCPORTPAGE0_FLAGS_ATTACH_PRIVATE_LOOP</span><span class="p">)</span>
		<span class="n">port_type</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_LPORT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">MPI_FCPORTPAGE0_FLAGS_ATTACH_PUBLIC_LOOP</span><span class="p">)</span>
		<span class="n">port_type</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_NLPORT</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">MPI_FCPORTPAGE0_FLAGS_ATTACH_FABRIC_DIRECT</span><span class="p">)</span>
		<span class="n">port_type</span> <span class="o">=</span> <span class="n">FC_PORTTYPE_NPORT</span><span class="p">;</span>
	<span class="n">fc_host_port_type</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span> <span class="o">=</span> <span class="n">port_type</span><span class="p">;</span>

	<span class="n">fc_host_fabric_name</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">MPI_FCPORTPAGE0_FLAGS_FABRIC_WWN_VALID</span><span class="p">)</span> <span class="o">?</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">pp0</span><span class="o">-&gt;</span><span class="n">FabricWWNN</span><span class="p">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">pp0</span><span class="o">-&gt;</span><span class="n">FabricWWPN</span><span class="p">.</span><span class="n">Low</span> <span class="o">:</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">WWNN</span><span class="p">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pp0</span><span class="o">-&gt;</span><span class="n">WWNN</span><span class="p">.</span><span class="n">Low</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptfc_link_status_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span>             <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">MPT_ADAPTER</span><span class="p">,</span> <span class="n">fc_rescan_work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">mptfc_GetFcPortPage0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptfc_setup_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span>		<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">MPT_ADAPTER</span><span class="p">,</span> <span class="n">fc_setup_reset_work</span><span class="p">);</span>
	<span class="n">u64</span>			<span class="n">pn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptfc_rport_info</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span>      <span class="o">*</span><span class="n">starget</span><span class="p">;</span>
	<span class="n">VirtTarget</span>              <span class="o">*</span><span class="n">vtarget</span><span class="p">;</span>

	<span class="cm">/* reset about to happen, delete (block) all rports */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_RPORT_INFO_FLAGS_REGISTERED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT_RPORT_INFO_FLAGS_REGISTERED</span><span class="p">;</span>
			<span class="n">fc_remote_port_delete</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">);</span>	<span class="cm">/* won&#39;t sleep */</span>
			<span class="n">ri</span><span class="o">-&gt;</span><span class="n">rport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">starget</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vtarget</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vtarget</span><span class="p">)</span>
					<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pn</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">WWPN</span><span class="p">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">WWPN</span><span class="p">.</span><span class="n">Low</span><span class="p">;</span>
			<span class="n">dfcprintk</span> <span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
				<span class="s">&quot;mptfc_setup_reset.%d: %llx deleted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pn</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptfc_rescan_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span>		<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">MPT_ADAPTER</span><span class="p">,</span> <span class="n">fc_rescan_work</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">ii</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">pn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptfc_rport_info</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span>      <span class="o">*</span><span class="n">starget</span><span class="p">;</span>
	<span class="n">VirtTarget</span>              <span class="o">*</span><span class="n">vtarget</span><span class="p">;</span>

	<span class="cm">/* start by tagging all ports as missing */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_RPORT_INFO_FLAGS_REGISTERED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MPT_RPORT_INFO_FLAGS_MISSING</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * now rescan devices known to adapter,</span>
<span class="cm">	 * will reregister existing rports</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">mptfc_GetFcPortPage0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
		<span class="n">mptfc_init_host_attr</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>	<span class="cm">/* refresh */</span>
		<span class="n">mptfc_GetFcDevPage0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">mptfc_register_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* delete devices still missing */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if newly missing, delete it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_RPORT_INFO_FLAGS_MISSING</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">ri</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MPT_RPORT_INFO_FLAGS_REGISTERED</span><span class="o">|</span>
				       <span class="n">MPT_RPORT_INFO_FLAGS_MISSING</span><span class="p">);</span>
			<span class="n">fc_remote_port_delete</span><span class="p">(</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">rport</span><span class="p">);</span>	<span class="cm">/* won&#39;t sleep */</span>
			<span class="n">ri</span><span class="o">-&gt;</span><span class="n">rport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">starget</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vtarget</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vtarget</span><span class="p">)</span>
					<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pn</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">WWPN</span><span class="p">.</span><span class="n">High</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ri</span><span class="o">-&gt;</span><span class="n">pg0</span><span class="p">.</span><span class="n">WWPN</span><span class="p">.</span><span class="n">Low</span><span class="p">;</span>
			<span class="n">dfcprintk</span> <span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
				<span class="s">&quot;mptfc_rescan.%d: %llx deleted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pn</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>	<span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="n">MPT_SCSI_HOST</span>		<span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> 		<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		 <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">ii</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">numSGE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">scale</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">ioc_cap</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">mpt_attach</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="n">id</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">DoneCtx</span> <span class="o">=</span> <span class="n">mptfcDoneCtx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">TaskCtx</span> <span class="o">=</span> <span class="n">mptfcTaskCtx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">InternalCtx</span> <span class="o">=</span> <span class="n">mptfcInternalCtx</span><span class="p">;</span>

	<span class="cm">/*  Added sanity check on readiness of the MPT adapter.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">last_state</span> <span class="o">!=</span> <span class="n">MPI_IOC_STATE_OPERATIONAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
		  <span class="s">&quot;Skipping because it&#39;s not operational!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mptfc_probe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;Skipping because it&#39;s disabled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mptfc_probe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Sanity check - ensure at least 1 port is INITIATOR capable</span>
<span class="cm">	 */</span>
	<span class="n">ioc_cap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">ProtocolFlags</span> <span class="o">&amp;</span>
		    <span class="n">MPI_PORTFACTS_PROTOCOL_INITIATOR</span><span class="p">)</span>
			<span class="n">ioc_cap</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc_cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			<span class="s">&quot;Skipping ioc=%p because SCSI Initiator mode is NOT enabled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sh</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptfc_driver_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MPT_SCSI_HOST</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			<span class="s">&quot;Unable to register controller with SCSI subsystem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mptfc_probe</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_lock</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work</span><span class="p">,</span> <span class="n">mptfc_rescan_devices</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_setup_reset_work</span><span class="p">,</span> <span class="n">mptfc_setup_reset</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_lsc_work</span><span class="p">,</span> <span class="n">mptfc_link_status_change</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Attach the SCSI Host to the IOC structure</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span> <span class="o">=</span> <span class="n">sh</span><span class="p">;</span>

	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set 16 byte cdb&#39;s */</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">MaxDevices</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">max_lun</span><span class="p">;</span>

	<span class="cm">/* Required entry.</span>
<span class="cm">	 */</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="cm">/* Verify that we won&#39;t exceed the maximum</span>
<span class="cm">	 * number of chain buffers</span>
<span class="cm">	 * We can optimize:  ZZ = req_sz/sizeof(SGE)</span>
<span class="cm">	 * For 32bit SGE&#39;s:</span>
<span class="cm">	 *  numSGE = 1 + (ZZ-1)*(maxChain -1) + ZZ</span>
<span class="cm">	 *               + (req_sz - 64)/sizeof(SGE)</span>
<span class="cm">	 * A slightly different algorithm is required for</span>
<span class="cm">	 * 64bit SGEs.</span>
<span class="cm">	 */</span>
	<span class="n">scale</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="o">/</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sg_addr_size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">numSGE</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		  <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxChainDepth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">+</span>
		  <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">-</span> <span class="mi">60</span><span class="p">)</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">numSGE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">scale</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		  <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxChainDepth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">+</span>
		  <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">-</span> <span class="mi">64</span><span class="p">)</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">numSGE</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset this value */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		  <span class="s">&quot;Resetting sg_tablesize to %d from %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">numSGE</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">));</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">numSGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
	<span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">ioc</span><span class="p">;</span>

	<span class="cm">/* SCSI needs scsi_cmnd lookup table!</span>
<span class="cm">	 * (with size equal to req_depth*PtrSz!)</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mptfc_probe</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;ScsiLookup @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span><span class="p">));</span>

	<span class="n">hd</span><span class="o">-&gt;</span><span class="n">last_queue_full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">transportt</span> <span class="o">=</span> <span class="n">mptfc_transport_template</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">scsi_add_host</span> <span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
		  <span class="s">&quot;scsi_add_host failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_mptfc_probe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize workqueue */</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q_name</span><span class="p">),</span>
		 <span class="s">&quot;mptfc_wq_%d&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q</span> <span class="o">=</span>
		<span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_mptfc_probe</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Pre-fetch FC port WWN and stuff...</span>
<span class="cm">	 *  (FCPortPage0_t stuff)</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">mptfc_GetFcPortPage0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mptfc_SetFcPortPage1_defaults</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * scan for rports -</span>
<span class="cm">	 *	by doing it via the workqueue, some locking is eliminated</span>
<span class="cm">	 */</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work</span><span class="p">);</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_mptfc_probe:</span>

	<span class="n">mptscsih_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">mptfc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;mptfc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">mptfc_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mptfc_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">mptfc_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">mptscsih_shutdown</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">mptscsih_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">mptscsih_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_event_process</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">EventNotificationReply_t</span> <span class="o">*</span><span class="n">pEvReply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">event</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pEvReply</span><span class="o">-&gt;</span><span class="n">Event</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="n">FC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">devtverboseprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;MPT event (=%02Xh) routed to SCSI host driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">event</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_RESCAN</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_LINK_STATUS_CHANGE</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_lsc_work</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mptscsih_event_process</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span><span class="n">pEvReply</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptfc_ioc_reset</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_phase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mptscsih_ioc_reset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span><span class="n">reset_phase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="n">FC</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>


	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		<span class="s">&quot;: IOC %s_reset routed to FC host driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">reset_phase</span><span class="o">==</span><span class="n">MPT_IOC_SETUP_RESET</span> <span class="o">?</span> <span class="s">&quot;setup&quot;</span> <span class="o">:</span> <span class="p">(</span>
		<span class="n">reset_phase</span><span class="o">==</span><span class="n">MPT_IOC_PRE_RESET</span> <span class="o">?</span> <span class="s">&quot;pre&quot;</span> <span class="o">:</span> <span class="s">&quot;post&quot;</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset_phase</span> <span class="o">==</span> <span class="n">MPT_IOC_SETUP_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_setup_reset_work</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reset_phase</span> <span class="o">==</span> <span class="n">MPT_IOC_PRE_RESET</span><span class="p">)</span> <span class="p">{</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>	<span class="cm">/* MPT_IOC_POST_RESET */</span>
		<span class="n">mptfc_SetFcPortPage1_defaults</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptfc_init - Register MPT adapter(s) as SCSI host(s) with SCSI mid-layer.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">mptfc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">show_mptmod_ver</span><span class="p">(</span><span class="n">my_NAME</span><span class="p">,</span> <span class="n">my_VERSION</span><span class="p">);</span>

	<span class="cm">/* sanity check module parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mptfc_dev_loss_tmo</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mptfc_dev_loss_tmo</span> <span class="o">=</span> <span class="n">MPTFC_DEV_LOSS_TMO</span><span class="p">;</span>

	<span class="n">mptfc_transport_template</span> <span class="o">=</span>
		<span class="n">fc_attach_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptfc_transport_functions</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mptfc_transport_template</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mptfcDoneCtx</span> <span class="o">=</span> <span class="n">mpt_register</span><span class="p">(</span><span class="n">mptscsih_io_done</span><span class="p">,</span> <span class="n">MPTFC_DRIVER</span><span class="p">,</span>
	    <span class="s">&quot;mptscsih_scandv_complete&quot;</span><span class="p">);</span>
	<span class="n">mptfcTaskCtx</span> <span class="o">=</span> <span class="n">mpt_register</span><span class="p">(</span><span class="n">mptscsih_taskmgmt_complete</span><span class="p">,</span> <span class="n">MPTFC_DRIVER</span><span class="p">,</span>
	    <span class="s">&quot;mptscsih_scandv_complete&quot;</span><span class="p">);</span>
	<span class="n">mptfcInternalCtx</span> <span class="o">=</span> <span class="n">mpt_register</span><span class="p">(</span><span class="n">mptscsih_scandv_complete</span><span class="p">,</span> <span class="n">MPTFC_DRIVER</span><span class="p">,</span>
	    <span class="s">&quot;mptscsih_scandv_complete&quot;</span><span class="p">);</span>

	<span class="n">mpt_event_register</span><span class="p">(</span><span class="n">mptfcDoneCtx</span><span class="p">,</span> <span class="n">mptfc_event_process</span><span class="p">);</span>
	<span class="n">mpt_reset_register</span><span class="p">(</span><span class="n">mptfcDoneCtx</span><span class="p">,</span> <span class="n">mptfc_ioc_reset</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptfc_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">fc_release_transport</span><span class="p">(</span><span class="n">mptfc_transport_template</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptfc_remove - Remove fc infrastructure for devices</span>
<span class="cm"> *	@pdev: Pointer to pci_dev structure</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">mptfc_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span>		<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mptfc_rport_info</span>	<span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">work_q</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ii</span><span class="p">;</span>

	<span class="cm">/* destroy workqueue */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">work_q</span><span class="o">=</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rescan_work_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">work_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fc_remove_host</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rports</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span><span class="o">&lt;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">pg_sz</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">data</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">dma</span><span class="p">);</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_data</span><span class="p">.</span><span class="n">fc_port_page1</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mptscsih_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptfc_exit - Unregisters MPT adapter(s)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">mptfc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptfc_driver</span><span class="p">);</span>
	<span class="n">fc_release_transport</span><span class="p">(</span><span class="n">mptfc_transport_template</span><span class="p">);</span>

	<span class="n">mpt_reset_deregister</span><span class="p">(</span><span class="n">mptfcDoneCtx</span><span class="p">);</span>
	<span class="n">mpt_event_deregister</span><span class="p">(</span><span class="n">mptfcDoneCtx</span><span class="p">);</span>

	<span class="n">mpt_deregister</span><span class="p">(</span><span class="n">mptfcInternalCtx</span><span class="p">);</span>
	<span class="n">mpt_deregister</span><span class="p">(</span><span class="n">mptfcTaskCtx</span><span class="p">);</span>
	<span class="n">mpt_deregister</span><span class="p">(</span><span class="n">mptfcDoneCtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">mptfc_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mptfc_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
