<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › message › fusion › mptspi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mptspi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/message/fusion/mptspi.c</span>
<span class="cm"> *      For use with LSI PCI chip/adapter(s)</span>
<span class="cm"> *      running LSI Fusion MPT (Message Passing Technology) firmware.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 1999-2008 LSI Corporation</span>
<span class="cm"> *  (mailto:DL-MPTFusionLinux@lsi.com)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; version 2 of the License.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    NO WARRANTY</span>
<span class="cm">    THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span>
<span class="cm">    CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT</span>
<span class="cm">    LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,</span>
<span class="cm">    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is</span>
<span class="cm">    solely responsible for determining the appropriateness of using and</span>
<span class="cm">    distributing the Program and assumes all risks associated with its</span>
<span class="cm">    exercise of rights under this Agreement, including but not limited to</span>
<span class="cm">    the risks and costs of program errors, damage to or loss of data,</span>
<span class="cm">    programs or equipment, and unavailability or interruption of operations.</span>

<span class="cm">    DISCLAIMER OF LIABILITY</span>
<span class="cm">    NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY</span>
<span class="cm">    DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm">    DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND</span>
<span class="cm">    ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR</span>
<span class="cm">    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE</span>
<span class="cm">    USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED</span>
<span class="cm">    HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm">*/</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kdev_t.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;	</span><span class="cm">/* for mdelay */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/interrupt.h&gt;	</span><span class="cm">/* needed for in_interrupt() proto */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/reboot.h&gt;	</span><span class="cm">/* notifier code */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/raid_class.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_spi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_dbg.h&gt;</span>

<span class="cp">#include &quot;mptbase.h&quot;</span>
<span class="cp">#include &quot;mptscsih.h&quot;</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cp">#define my_NAME		&quot;Fusion MPT SPI Host driver&quot;</span>
<span class="cp">#define my_VERSION	MPT_LINUX_VERSION_COMMON</span>
<span class="cp">#define MYNAM		&quot;mptspi&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">MODULEAUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">my_NAME</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">my_VERSION</span><span class="p">);</span>

<span class="cm">/* Command line args */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mpt_saf_te</span> <span class="o">=</span> <span class="n">MPTSCSIH_SAF_TE</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mpt_saf_te</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpt_saf_te</span><span class="p">,</span> <span class="s">&quot; Force enabling SEP Processor: enable=1  (default=MPTSCSIH_SAF_TE=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mptspi_write_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptspi_write_width</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptspi_write_spi_device_pg1</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">_CONFIG_PAGE_SCSI_DEVICE_1</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">mptspi_transport_template</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u8</span>	<span class="n">mptspiDoneCtx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span>	<span class="n">mptspiTaskCtx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span>	<span class="n">mptspiInternalCtx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span> <span class="cm">/* Used only for internal commands */</span>

<span class="cm">/**</span>
<span class="cm"> * 	mptspi_setTargetNegoParms  - Update the target negotiation parameters</span>
<span class="cm"> *	@hd: Pointer to a SCSI Host Structure</span>
<span class="cm"> *	@target: per target private data</span>
<span class="cm"> *	@sdev: SCSI device</span>
<span class="cm"> *</span>
<span class="cm"> * 	Update the target negotiation parameters based on the the Inquiry</span>
<span class="cm"> *	data, adapter capabilities, and NVRAM settings.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptspi_setTargetNegoParms</span><span class="p">(</span><span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="n">VirtTarget</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">SpiCfgData</span> <span class="o">*</span><span class="n">pspi_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">nvram</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">width</span> <span class="o">=</span> <span class="n">MPT_NARROW</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">factor</span> <span class="o">=</span> <span class="n">MPT_ASYNC</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">nfactor</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">noQas</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">negoFlags</span> <span class="o">=</span> <span class="n">pspi_data</span><span class="o">-&gt;</span><span class="n">noQas</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&lt;</span> <span class="n">SCSI_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">factor</span> <span class="o">=</span> <span class="n">MPT_ULTRA2</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">pspi_data</span><span class="o">-&gt;</span><span class="n">maxSyncOffset</span><span class="p">;</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT_TARGET_FLAGS_Q_YES</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_device_wide</span><span class="p">(</span><span class="n">sdev</span><span class="p">))</span>
			<span class="n">width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_device_sync</span><span class="p">(</span><span class="n">sdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">factor</span> <span class="o">=</span> <span class="n">pspi_data</span><span class="o">-&gt;</span><span class="n">minSyncFactor</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_device_dt</span><span class="p">(</span><span class="n">sdev</span><span class="p">))</span>
					<span class="n">factor</span> <span class="o">=</span> <span class="n">MPT_ULTRA2</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_device_ius</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">scsi_device_qas</span><span class="p">(</span><span class="n">sdev</span><span class="p">))</span>
					<span class="n">factor</span> <span class="o">=</span> <span class="n">MPT_ULTRA160</span><span class="p">;</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">factor</span> <span class="o">=</span> <span class="n">MPT_ULTRA320</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">scsi_device_qas</span><span class="p">(</span><span class="n">sdev</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">ddvprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Enabling QAS due to &quot;</span>
						<span class="s">&quot;byte56=%02x on id=%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						<span class="n">scsi_device_qas</span><span class="p">(</span><span class="n">sdev</span><span class="p">),</span> <span class="n">id</span><span class="p">));</span>
						<span class="n">noQas</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_TAPE</span> <span class="o">&amp;&amp;</span>
					    <span class="n">scsi_device_ius</span><span class="p">(</span><span class="n">sdev</span><span class="p">))</span>
						<span class="n">target</span><span class="o">-&gt;</span><span class="n">negoFlags</span> <span class="o">|=</span> <span class="n">MPT_TAPE_NEGO_IDP</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">pspi_data</span><span class="o">-&gt;</span><span class="n">maxSyncOffset</span><span class="p">;</span>

			<span class="cm">/* If RAID, never disable QAS</span>
<span class="cm">			 * else if non RAID, do not disable</span>
<span class="cm">			 *   QAS if bit 1 is set</span>
<span class="cm">			 * bit 1 QAS support, non-raid only</span>
<span class="cm">			 * bit 0 IU support</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">raidVolume</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">noQas</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">factor</span> <span class="o">=</span> <span class="n">MPT_ASYNC</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT_TARGET_FLAGS_Q_YES</span><span class="p">;</span>

	<span class="cm">/* Update tflags based on NVRAM settings. (SCSI only)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pspi_data</span><span class="o">-&gt;</span><span class="n">nvram</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pspi_data</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MPT_HOST_NVRAM_INVALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nvram</span> <span class="o">=</span> <span class="n">pspi_data</span><span class="o">-&gt;</span><span class="n">nvram</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
		<span class="n">nfactor</span> <span class="o">=</span> <span class="p">(</span><span class="n">nvram</span> <span class="o">&amp;</span> <span class="n">MPT_NVRAM_SYNC_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">width</span><span class="p">)</span>
			<span class="n">width</span> <span class="o">=</span> <span class="n">nvram</span> <span class="o">&amp;</span> <span class="n">MPT_NVRAM_WIDE_DISABLE</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Ensure factor is set to the</span>
<span class="cm">			 * maximum of: adapter, nvram, inquiry</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nfactor</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nfactor</span> <span class="o">&lt;</span> <span class="n">pspi_data</span><span class="o">-&gt;</span><span class="n">minSyncFactor</span> <span class="p">)</span>
					<span class="n">nfactor</span> <span class="o">=</span> <span class="n">pspi_data</span><span class="o">-&gt;</span><span class="n">minSyncFactor</span><span class="p">;</span>

				<span class="n">factor</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">nfactor</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">factor</span> <span class="o">==</span> <span class="n">MPT_ASYNC</span><span class="p">)</span>
					<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">factor</span> <span class="o">=</span> <span class="n">MPT_ASYNC</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">factor</span> <span class="o">=</span> <span class="n">MPT_ASYNC</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure data is consistent</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">width</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">factor</span> <span class="o">&lt;</span> <span class="n">MPT_ULTRA2</span><span class="p">))</span>
		<span class="n">factor</span> <span class="o">=</span> <span class="n">MPT_ULTRA2</span><span class="p">;</span>

	<span class="cm">/* Save the data to the target structure.</span>
<span class="cm">	 */</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">minSyncFactor</span> <span class="o">=</span> <span class="n">factor</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">maxOffset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">maxWidth</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>

	<span class="n">spi_min_period</span><span class="p">(</span><span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">))</span> <span class="o">=</span> <span class="n">factor</span><span class="p">;</span>
	<span class="n">spi_max_offset</span><span class="p">(</span><span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">))</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">spi_max_width</span><span class="p">(</span><span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">))</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">|=</span> <span class="n">MPT_TARGET_FLAGS_VALID_NEGO</span><span class="p">;</span>

	<span class="cm">/* Disable unused features.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">width</span><span class="p">)</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">negoFlags</span> <span class="o">|=</span> <span class="n">MPT_TARGET_NO_NEGO_WIDE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">offset</span><span class="p">)</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">negoFlags</span> <span class="o">|=</span> <span class="n">MPT_TARGET_NO_NEGO_SYNC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">factor</span> <span class="o">&gt;</span> <span class="n">MPT_ULTRA320</span> <span class="p">)</span>
		<span class="n">noQas</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">noQas</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pspi_data</span><span class="o">-&gt;</span><span class="n">noQas</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pspi_data</span><span class="o">-&gt;</span><span class="n">noQas</span> <span class="o">|=</span> <span class="n">MPT_TARGET_NO_NEGO_QAS</span><span class="p">;</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">negoFlags</span> <span class="o">|=</span> <span class="n">MPT_TARGET_NO_NEGO_QAS</span><span class="p">;</span>

		<span class="cm">/* Disable QAS in a mixed configuration case</span>
<span class="cm">		 */</span>

		<span class="n">ddvprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			<span class="s">&quot;Disabling QAS due to noQas=%02x on id=%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">noQas</span><span class="p">,</span> <span class="n">id</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 	mptspi_writeIOCPage4  - write IOC Page 4</span>
<span class="cm"> *	@hd: Pointer to a SCSI Host Structure</span>
<span class="cm"> *	@channel: channel number</span>
<span class="cm"> *	@id: write IOC Page4 for this ID &amp; Bus</span>
<span class="cm"> *</span>
<span class="cm"> *	Return: -EAGAIN if unable to obtain a Message Frame</span>
<span class="cm"> *		or 0 if success.</span>
<span class="cm"> *</span>
<span class="cm"> *	Remark: We do not wait for a return, write pages sequentially.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptspi_writeIOCPage4</span><span class="p">(</span><span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span> <span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span>		<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">Config_t</span>		<span class="o">*</span><span class="n">pReq</span><span class="p">;</span>
	<span class="n">IOCPage4_t</span>		<span class="o">*</span><span class="n">IOCPage4Ptr</span><span class="p">;</span>
	<span class="n">MPT_FRAME_HDR</span>		<span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		 <span class="n">dataDma</span><span class="p">;</span>
	<span class="n">u16</span>			 <span class="n">req_idx</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">frameOffset</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">flagsLength</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">ii</span><span class="p">;</span>

	<span class="cm">/* Get a MF for this command.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">DoneCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
				<span class="s">&quot;writeIOCPage4 : no msg frames!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the request and the data pointers.</span>
<span class="cm">	 * Place data at end of MF.</span>
<span class="cm">	 */</span>
	<span class="n">pReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">Config_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">;</span>

	<span class="n">req_idx</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">req_idx</span><span class="p">);</span>
	<span class="n">frameOffset</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCPage4_t</span><span class="p">);</span>

	<span class="cm">/* Complete the request frame (same for all requests).</span>
<span class="cm">	 */</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_CONFIG</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">ExtPageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">ExtPageType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Reserved2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IOCPage4Ptr</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">pIocPg4</span><span class="p">;</span>
	<span class="n">dataDma</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">IocPg4_dma</span><span class="p">;</span>
	<span class="n">ii</span> <span class="o">=</span> <span class="n">IOCPage4Ptr</span><span class="o">-&gt;</span><span class="n">ActiveSEP</span><span class="o">++</span><span class="p">;</span>
	<span class="n">IOCPage4Ptr</span><span class="o">-&gt;</span><span class="n">SEP</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">SEPTargetID</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">IOCPage4Ptr</span><span class="o">-&gt;</span><span class="n">SEP</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">SEPBus</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Header</span> <span class="o">=</span> <span class="n">IOCPage4Ptr</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">PageAddress</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">id</span> <span class="o">|</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="p">));</span>

	<span class="cm">/* Add a SGE to the config request.</span>
<span class="cm">	 */</span>
	<span class="n">flagsLength</span> <span class="o">=</span> <span class="n">MPT_SGE_FLAGS_SSIMPLE_WRITE</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">IOCPage4Ptr</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">+</span> <span class="n">ii</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pReq</span><span class="o">-&gt;</span><span class="n">PageBufferSGE</span><span class="p">,</span> <span class="n">flagsLength</span><span class="p">,</span> <span class="n">dataDma</span><span class="p">);</span>

	<span class="n">ddvprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		<span class="s">&quot;writeIOCPage4: MaxSEP=%d ActiveSEP=%d id=%d bus=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">IOCPage4Ptr</span><span class="o">-&gt;</span><span class="n">MaxSEP</span><span class="p">,</span> <span class="n">IOCPage4Ptr</span><span class="o">-&gt;</span><span class="n">ActiveSEP</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">));</span>

	<span class="n">mpt_put_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">DoneCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptspi_initTarget - Target, LUN alloc/free functionality.</span>
<span class="cm"> *	@hd: Pointer to MPT_SCSI_HOST structure</span>
<span class="cm"> *	@vtarget: per target private data</span>
<span class="cm"> *	@sdev: SCSI device</span>
<span class="cm"> *</span>
<span class="cm"> *	NOTE: It&#39;s only SAFE to call this routine if data points to</span>
<span class="cm"> *	sane &amp; valid STANDARD INQUIRY data!</span>
<span class="cm"> *</span>
<span class="cm"> *	Allocate and initialize memory for this target.</span>
<span class="cm"> *	Save inquiry data.</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptspi_initTarget</span><span class="p">(</span><span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="n">VirtTarget</span> <span class="o">*</span><span class="n">vtarget</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* Is LUN supported? If so, upper 2 bits will be 0</span>
<span class="cm">	* in first byte of inquiry data.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">inq_periph_qual</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vtarget</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_PROCESSOR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">Saf_Te</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Treat all Processors as SAF-TE if</span>
<span class="cm">		 * command line option is set */</span>
		<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">|=</span> <span class="n">MPT_TARGET_FLAGS_SAF_TE_ISSUED</span><span class="p">;</span>
		<span class="n">mptspi_writeIOCPage4</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_PROCESSOR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_SAF_TE_ISSUED</span> <span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">inquiry_len</span> <span class="o">&gt;</span> <span class="mi">49</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">inquiry</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;S&#39;</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">inquiry</span><span class="p">[</span><span class="mi">45</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;A&#39;</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">inquiry</span><span class="p">[</span><span class="mi">46</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;F&#39;</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">inquiry</span><span class="p">[</span><span class="mi">47</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">inquiry</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;T&#39;</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">inquiry</span><span class="p">[</span><span class="mi">49</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;E&#39;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">|=</span> <span class="n">MPT_TARGET_FLAGS_SAF_TE_ISSUED</span><span class="p">;</span>
				<span class="n">mptspi_writeIOCPage4</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mptspi_setTargetNegoParms</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">vtarget</span><span class="p">,</span> <span class="n">sdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptspi_is_raid - Determines whether target is belonging to volume</span>
<span class="cm"> *	@hd: Pointer to a SCSI HOST structure</span>
<span class="cm"> *	@id: target device id</span>
<span class="cm"> *</span>
<span class="cm"> *	Return:</span>
<span class="cm"> *		non-zero = true</span>
<span class="cm"> *		zero = false</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptspi_is_raid</span><span class="p">(</span><span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="o">-&gt;</span><span class="n">NumActiveVolumes</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="o">-&gt;</span><span class="n">NumActiveVolumes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="o">-&gt;</span><span class="n">RaidVolume</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VolumeID</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mptspi_target_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">VirtTarget</span>		<span class="o">*</span><span class="n">vtarget</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">vtarget</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">VirtTarget</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vtarget</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">ioc_id</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">=</span> <span class="n">MPT_TARGET_FLAGS_Q_YES</span><span class="p">;</span>
	<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">=</span> <span class="n">starget</span><span class="p">;</span>
	<span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">vtarget</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mptscsih_is_phys_disk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">|=</span> <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">;</span>
		<span class="cm">/* The real channel for this device is zero */</span>
		<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* The actual physdisknum (for RAID passthrough) */</span>
		<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">mptscsih_raid_id_to_num</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mptspi_is_raid</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">raidVolume</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ddvprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;RAID Volume @ channel=%d id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
		    <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">nvram</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">nvram</span><span class="p">[</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MPT_HOST_NVRAM_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">nvram</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">nvram</span><span class="p">[</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
		<span class="n">spi_min_period</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">nvram</span> <span class="o">&amp;</span> <span class="n">MPT_NVRAM_SYNC_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MPT_NVRAM_SYNC_SHIFT</span><span class="p">;</span>
		<span class="n">spi_max_width</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">nvram</span> <span class="o">&amp;</span> <span class="n">MPT_NVRAM_WIDE_DISABLE</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spi_min_period</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">minSyncFactor</span><span class="p">;</span>
		<span class="n">spi_max_width</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">maxBusWidth</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spi_max_offset</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">maxSyncOffset</span><span class="p">;</span>

	<span class="n">spi_offset</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spi_period</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">mptspi_write_width</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptspi_target_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">);</span>
	<span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptspi_print_write_nego - negotiation parameters debug info that is being sent</span>
<span class="cm"> *	@hd: Pointer to a SCSI HOST structure</span>
<span class="cm"> *	@starget: SCSI target</span>
<span class="cm"> *	@ii: negotiation parameters</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptspi_print_write_nego</span><span class="p">(</span><span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ii</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ddvprintk</span><span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;id=%d Requested = 0x%08x&quot;</span>
	    <span class="s">&quot; ( %s factor = 0x%02x @ offset = 0x%02x %s%s%s%s%s%s%s%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_WIDE</span> <span class="o">?</span> <span class="s">&quot;Wide &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	    <span class="p">((</span><span class="n">ii</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">),</span> <span class="p">((</span><span class="n">ii</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">),</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_IU</span> <span class="o">?</span> <span class="s">&quot;IU &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_DT</span> <span class="o">?</span> <span class="s">&quot;DT &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_QAS</span> <span class="o">?</span> <span class="s">&quot;QAS &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_HOLD_MCS</span> <span class="o">?</span> <span class="s">&quot;HOLDMCS &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_WR_FLOW</span> <span class="o">?</span> <span class="s">&quot;WRFLOW &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_RD_STRM</span> <span class="o">?</span> <span class="s">&quot;RDSTRM &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_RTI</span> <span class="o">?</span> <span class="s">&quot;RTI &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_PCOMP_EN</span> <span class="o">?</span> <span class="s">&quot;PCOMP &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptspi_print_read_nego - negotiation parameters debug info that is being read</span>
<span class="cm"> *	@hd: Pointer to a SCSI HOST structure</span>
<span class="cm"> *	@starget: SCSI target</span>
<span class="cm"> *	@ii: negotiation parameters</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptspi_print_read_nego</span><span class="p">(</span><span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ii</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ddvprintk</span><span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;id=%d Read = 0x%08x&quot;</span>
	    <span class="s">&quot; ( %s factor = 0x%02x @ offset = 0x%02x %s%s%s%s%s%s%s%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_WIDE</span> <span class="o">?</span> <span class="s">&quot;Wide &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	    <span class="p">((</span><span class="n">ii</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">),</span> <span class="p">((</span><span class="n">ii</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">),</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_IU</span> <span class="o">?</span> <span class="s">&quot;IU &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_DT</span> <span class="o">?</span> <span class="s">&quot;DT &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_QAS</span> <span class="o">?</span> <span class="s">&quot;QAS &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_HOLD_MCS</span> <span class="o">?</span> <span class="s">&quot;HOLDMCS &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_WR_FLOW</span> <span class="o">?</span> <span class="s">&quot;WRFLOW &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_RD_STRM</span> <span class="o">?</span> <span class="s">&quot;RDSTRM &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_RTI</span> <span class="o">?</span> <span class="s">&quot;RTI &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	    <span class="n">ii</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_PCOMP_EN</span> <span class="o">?</span> <span class="s">&quot;PCOMP &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mptspi_read_spi_device_pg0</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">_CONFIG_PAGE_SCSI_DEVICE_0</span> <span class="o">*</span><span class="n">pass_pg0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_CONFIG_PAGE_SCSI_DEVICE_0</span> <span class="o">*</span><span class="n">spi_dev_pg0</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">spi_dev_pg0_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_x_config_parms</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_CONFIG_PAGE_HEADER</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* No SPI parameters for RAID devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mptspi_is_raid</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp0length</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	if (ioc-&gt;spi_data.sdp0length &amp; 1)</span>
<span class="cm">		size += size + 4;</span>
<span class="cm">	size += 2048;</span>
<span class="cm">	*/</span>

	<span class="n">spi_dev_pg0</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spi_dev_pg0_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spi_dev_pg0</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span>
		    <span class="s">&quot;dma_alloc_coherent for parameters failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">));</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp0version</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp0length</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_SCSI_DEVICE</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfg</span><span class="p">));</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">spi_dev_pg0_dma</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span> <span class="s">&quot;mpt_config failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pass_pg0</span><span class="p">,</span> <span class="n">spi_dev_pg0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">mptspi_print_read_nego</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">spi_dev_pg0</span><span class="o">-&gt;</span><span class="n">NegotiatedParameters</span><span class="p">));</span>

 <span class="nl">out_free:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">spi_dev_pg0</span><span class="p">,</span> <span class="n">spi_dev_pg0_dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">mptspi_getRP</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nego</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nego</span> <span class="o">|=</span> <span class="n">spi_iu</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">?</span> <span class="n">MPI_SCSIDEVPAGE1_RP_IU</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nego</span> <span class="o">|=</span> <span class="n">spi_dt</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">?</span> <span class="n">MPI_SCSIDEVPAGE1_RP_DT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nego</span> <span class="o">|=</span> <span class="n">spi_qas</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">?</span> <span class="n">MPI_SCSIDEVPAGE1_RP_QAS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nego</span> <span class="o">|=</span> <span class="n">spi_hold_mcs</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">?</span> <span class="n">MPI_SCSIDEVPAGE1_RP_HOLD_MCS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nego</span> <span class="o">|=</span> <span class="n">spi_wr_flow</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">?</span> <span class="n">MPI_SCSIDEVPAGE1_RP_WR_FLOW</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nego</span> <span class="o">|=</span> <span class="n">spi_rd_strm</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">?</span> <span class="n">MPI_SCSIDEVPAGE1_RP_RD_STRM</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nego</span> <span class="o">|=</span> <span class="n">spi_rti</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">?</span> <span class="n">MPI_SCSIDEVPAGE1_RP_RTI</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nego</span> <span class="o">|=</span> <span class="n">spi_pcomp_en</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">?</span> <span class="n">MPI_SCSIDEVPAGE1_RP_PCOMP_EN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nego</span> <span class="o">|=</span> <span class="p">(</span><span class="n">spi_period</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">&lt;&lt;</span>  <span class="n">MPI_SCSIDEVPAGE1_RP_SHIFT_MIN_SYNC_PERIOD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE1_RP_MIN_SYNC_PERIOD_MASK</span><span class="p">;</span>
	<span class="n">nego</span> <span class="o">|=</span> <span class="p">(</span><span class="n">spi_offset</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">MPI_SCSIDEVPAGE1_RP_SHIFT_MAX_SYNC_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE1_RP_MAX_SYNC_OFFSET_MASK</span><span class="p">;</span>
	<span class="n">nego</span> <span class="o">|=</span> <span class="n">spi_width</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">?</span>  <span class="n">MPI_SCSIDEVPAGE1_RP_WIDE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nego</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mptspi_read_parameters</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nego</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_CONFIG_PAGE_SCSI_DEVICE_0</span> <span class="n">spi_dev_pg0</span><span class="p">;</span>

	<span class="n">mptspi_read_spi_device_pg0</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spi_dev_pg0</span><span class="p">);</span>

	<span class="n">nego</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">spi_dev_pg0</span><span class="p">.</span><span class="n">NegotiatedParameters</span><span class="p">);</span>

	<span class="n">spi_iu</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">nego</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_IU</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spi_dt</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">nego</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_DT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spi_qas</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">nego</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_QAS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spi_wr_flow</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">nego</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_WR_FLOW</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spi_rd_strm</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">nego</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_RD_STRM</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spi_rti</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">nego</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_RTI</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spi_pcomp_en</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">nego</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_PCOMP_EN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spi_hold_mcs</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">nego</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_HOLD_MCS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spi_period</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">nego</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_NEG_SYNC_PERIOD_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_SHIFT_SYNC_PERIOD</span><span class="p">;</span>
	<span class="n">spi_offset</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">nego</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_NEG_SYNC_OFFSET_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_SHIFT_SYNC_OFFSET</span><span class="p">;</span>
	<span class="n">spi_width</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">nego</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_WIDE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">mptscsih_quiesce_raid</span><span class="p">(</span><span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">quiesce</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">MpiRaidActionRequest_t</span>	<span class="o">*</span><span class="n">pReq</span><span class="p">;</span>
	<span class="n">MPT_FRAME_HDR</span>		<span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> 	 	<span class="n">timeleft</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Get and Populate a free Frame</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">InternalCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			<span class="s">&quot;%s: no msg frames!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">MpiRaidActionRequest_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quiesce</span><span class="p">)</span>
		<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Action</span> <span class="o">=</span> <span class="n">MPI_RAID_ACTION_QUIESCE_PHYS_IO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Action</span> <span class="o">=</span> <span class="n">MPI_RAID_ACTION_ENABLE_PHYS_IO</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Reserved1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_RAID_ACTION</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">VolumeID</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">VolumeBus</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">PhysDiskNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">ActionDataWord</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Reserved for this action */</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pReq</span><span class="o">-&gt;</span><span class="n">ActionDataSGE</span><span class="p">,</span>
		<span class="n">MPT_SGE_FLAGS_SSIMPLE_READ</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">ddvprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;RAID Volume action=%x channel=%d id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Action</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">));</span>

	<span class="n">INITIALIZE_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">mpt_put_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">InternalCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;%s: TIMED OUT!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeleft</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;Issuing Reset from %s!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">mpt_HardResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
			<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">completion_code</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">CLEAR_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mptspi_dv_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">VirtTarget</span> <span class="o">*</span><span class="n">vtarget</span> <span class="o">=</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="cm">/* no DV on RAID devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mptspi_is_raid</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* If this is a piece of a RAID, then quiesce first */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mptscsih_quiesce_raid</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">),</span> <span class="n">MYIOC_s_FMT</span>
		    <span class="s">&quot;Integrated RAID quiesce failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hd</span><span class="o">-&gt;</span><span class="n">spi_pending</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">spi_dv_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="n">hd</span><span class="o">-&gt;</span><span class="n">spi_pending</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mptscsih_quiesce_raid</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">),</span> <span class="n">MYIOC_s_FMT</span>
		    <span class="s">&quot;Integrated RAID resume failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">mptspi_read_parameters</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">);</span>
	<span class="n">spi_display_xfer_agreement</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">);</span>
	<span class="n">mptspi_read_parameters</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mptspi_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">VirtTarget</span>		<span class="o">*</span><span class="n">vtarget</span><span class="p">;</span>
	<span class="n">VirtDevice</span>		<span class="o">*</span><span class="n">vdevice</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> 	<span class="o">*</span><span class="n">starget</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		<span class="n">mptscsih_is_phys_disk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">vdevice</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">VirtDevice</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdevice</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;slave_alloc kmalloc(%zd) FAILED!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">VirtDevice</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">vdevice</span><span class="p">;</span>

	<span class="n">starget</span> <span class="o">=</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="n">vtarget</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span> <span class="o">=</span> <span class="n">vtarget</span><span class="p">;</span>
	<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">num_luns</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">no_uld_attach</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mptspi_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">VirtTarget</span> <span class="o">*</span><span class="n">vtarget</span> <span class="o">=</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mptspi_initTarget</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">vtarget</span><span class="p">,</span> <span class="n">sdev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mptscsih_slave_configure</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ddvprintk</span><span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;id=%d min_period=0x%02x&quot;</span>
		<span class="s">&quot; max_offset=0x%02x max_width=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">spi_min_period</span><span class="p">(</span><span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">)),</span>
		<span class="n">spi_max_offset</span><span class="p">(</span><span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">)),</span>
		<span class="n">spi_max_width</span><span class="p">(</span><span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">))));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">mptspi_is_raid</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">spi_initial_dv</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="p">))</span>
		<span class="n">mptspi_dv_device</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">sdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptspi_qcmd_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">VirtDevice</span>	<span class="o">*</span><span class="n">vdevice</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdevice</span> <span class="o">||</span> <span class="o">!</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">done</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		<span class="n">mptscsih_is_phys_disk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">done</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi_dv_pending</span><span class="p">(</span><span class="n">scsi_target</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)))</span>
		<span class="n">ddvprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">scsi_print_command</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">mptscsih_qcmd</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span><span class="n">done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">mptspi_qcmd</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mptspi_slave_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span> <span class="o">=</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="n">VirtTarget</span> <span class="o">*</span><span class="n">vtarget</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">VirtDevice</span> <span class="o">*</span><span class="n">vdevice</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="cm">/* Will this be the last lun on a non-raid device? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">num_luns</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">configured_lun</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">_CONFIG_PAGE_SCSI_DEVICE_1</span> <span class="n">pg1</span><span class="p">;</span>

		<span class="cm">/* Async Narrow */</span>
		<span class="n">pg1</span><span class="p">.</span><span class="n">RequestedParameters</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pg1</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pg1</span><span class="p">.</span><span class="n">Configuration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mptspi_write_spi_device_pg1</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mptscsih_slave_destroy</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">mptspi_driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>				<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>			<span class="o">=</span> <span class="s">&quot;mptspi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_info</span>			<span class="o">=</span> <span class="n">mptscsih_proc_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>				<span class="o">=</span> <span class="s">&quot;MPT SPI Host&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>				<span class="o">=</span> <span class="n">mptscsih_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>			<span class="o">=</span> <span class="n">mptspi_qcmd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_alloc</span>			<span class="o">=</span> <span class="n">mptspi_target_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_alloc</span>			<span class="o">=</span> <span class="n">mptspi_slave_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>		<span class="o">=</span> <span class="n">mptspi_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_destroy</span>			<span class="o">=</span> <span class="n">mptspi_target_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_destroy</span>			<span class="o">=</span> <span class="n">mptspi_slave_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span> 		<span class="o">=</span> <span class="n">mptscsih_change_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>		<span class="o">=</span> <span class="n">mptscsih_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span>	<span class="o">=</span> <span class="n">mptscsih_dev_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_bus_reset_handler</span>		<span class="o">=</span> <span class="n">mptscsih_bus_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>		<span class="o">=</span> <span class="n">mptscsih_host_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>			<span class="o">=</span> <span class="n">mptscsih_bios_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>			<span class="o">=</span> <span class="n">MPT_SCSI_CAN_QUEUE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>			<span class="o">=</span> <span class="n">MPT_SCSI_SG_DEPTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span>			<span class="o">=</span> <span class="mi">8192</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>			<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>			<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shost_attrs</span>			<span class="o">=</span> <span class="n">mptscsih_host_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mptspi_write_spi_device_pg1</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">_CONFIG_PAGE_SCSI_DEVICE_1</span> <span class="o">*</span><span class="n">pass_pg1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_CONFIG_PAGE_SCSI_DEVICE_1</span> <span class="o">*</span><span class="n">pg1</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pg1_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_x_config_parms</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_CONFIG_PAGE_HEADER</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nego_parms</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">period</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* don&#39;t allow updating nego parameters on RAID devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mptspi_is_raid</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp1length</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">pg1</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg1_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pg1</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span>
		    <span class="s">&quot;dma_alloc_coherent for parameters failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">));</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp1version</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp1length</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_SCSI_DEVICE</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfg</span><span class="p">));</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">pg1_dma</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">pg1</span><span class="p">,</span> <span class="n">pass_pg1</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">pg1</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span><span class="p">;</span>
	<span class="n">pg1</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span><span class="p">;</span>
	<span class="n">pg1</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span><span class="p">;</span>
	<span class="n">pg1</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span><span class="p">;</span>

	<span class="n">nego_parms</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pg1</span><span class="o">-&gt;</span><span class="n">RequestedParameters</span><span class="p">);</span>
	<span class="n">period</span> <span class="o">=</span> <span class="p">(</span><span class="n">nego_parms</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE1_RP_MIN_SYNC_PERIOD_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">MPI_SCSIDEVPAGE1_RP_SHIFT_MIN_SYNC_PERIOD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">period</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Turn on inline data padding for TAPE when running U320 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sdev</span> <span class="o">=</span> <span class="n">scsi_device_lookup_by_target</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span> <span class="o">&amp;&amp;</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_TAPE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span>
					    <span class="s">&quot;IDP:ON</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">nego_parms</span> <span class="o">|=</span> <span class="n">MPI_SCSIDEVPAGE1_RP_IDP</span><span class="p">;</span>
				<span class="n">pg1</span><span class="o">-&gt;</span><span class="n">RequestedParameters</span> <span class="o">=</span>
				    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nego_parms</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mptspi_print_write_nego</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pg1</span><span class="o">-&gt;</span><span class="n">RequestedParameters</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span>
		    <span class="s">&quot;mpt_config failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_free:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pg1</span><span class="p">,</span> <span class="n">pg1_dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mptspi_write_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_CONFIG_PAGE_SCSI_DEVICE_1</span> <span class="n">pg1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nego</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi_offset</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">mptspi_read_parameters</span><span class="p">(</span><span class="n">starget</span><span class="p">);</span>

	<span class="n">spi_offset</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">nego</span> <span class="o">=</span> <span class="n">mptspi_getRP</span><span class="p">(</span><span class="n">starget</span><span class="p">);</span>

	<span class="n">pg1</span><span class="p">.</span><span class="n">RequestedParameters</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nego</span><span class="p">);</span>
	<span class="n">pg1</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pg1</span><span class="p">.</span><span class="n">Configuration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mptspi_write_spi_device_pg1</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mptspi_write_period</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">period</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_CONFIG_PAGE_SCSI_DEVICE_1</span> <span class="n">pg1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nego</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">period</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">period</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">period</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">period</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi_period</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">mptspi_read_parameters</span><span class="p">(</span><span class="n">starget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">period</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spi_iu</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spi_dt</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">period</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spi_dt</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spi_period</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>

	<span class="n">nego</span> <span class="o">=</span> <span class="n">mptspi_getRP</span><span class="p">(</span><span class="n">starget</span><span class="p">);</span>

	<span class="n">pg1</span><span class="p">.</span><span class="n">RequestedParameters</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nego</span><span class="p">);</span>
	<span class="n">pg1</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pg1</span><span class="p">.</span><span class="n">Configuration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mptspi_write_spi_device_pg1</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mptspi_write_dt</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_CONFIG_PAGE_SCSI_DEVICE_1</span> <span class="n">pg1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nego</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi_period</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">mptspi_read_parameters</span><span class="p">(</span><span class="n">starget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dt</span> <span class="o">&amp;&amp;</span> <span class="n">spi_period</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">spi_period</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">spi_dt</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">dt</span><span class="p">;</span>

	<span class="n">nego</span> <span class="o">=</span> <span class="n">mptspi_getRP</span><span class="p">(</span><span class="n">starget</span><span class="p">);</span>


	<span class="n">pg1</span><span class="p">.</span><span class="n">RequestedParameters</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nego</span><span class="p">);</span>
	<span class="n">pg1</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pg1</span><span class="p">.</span><span class="n">Configuration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mptspi_write_spi_device_pg1</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mptspi_write_iu</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_CONFIG_PAGE_SCSI_DEVICE_1</span> <span class="n">pg1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nego</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spi_period</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">mptspi_read_parameters</span><span class="p">(</span><span class="n">starget</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iu</span> <span class="o">&amp;&amp;</span> <span class="n">spi_period</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span>
		<span class="n">spi_period</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>

	<span class="n">spi_iu</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">iu</span><span class="p">;</span>

	<span class="n">nego</span> <span class="o">=</span> <span class="n">mptspi_getRP</span><span class="p">(</span><span class="n">starget</span><span class="p">);</span>

	<span class="n">pg1</span><span class="p">.</span><span class="n">RequestedParameters</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nego</span><span class="p">);</span>
	<span class="n">pg1</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pg1</span><span class="p">.</span><span class="n">Configuration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mptspi_write_spi_device_pg1</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MPTSPI_SIMPLE_TRANSPORT_PARM(parm) 				\</span>
<span class="cp">static void mptspi_write_##parm(struct scsi_target *starget, int parm)\</span>
<span class="cp">{									\</span>
<span class="cp">	struct _CONFIG_PAGE_SCSI_DEVICE_1 pg1;				\</span>
<span class="cp">	u32 nego;							\</span>
<span class="cp">									\</span>
<span class="cp">	spi_##parm(starget) = parm;					\</span>
<span class="cp">									\</span>
<span class="cp">	nego = mptspi_getRP(starget);					\</span>
<span class="cp">									\</span>
<span class="cp">	pg1.RequestedParameters = cpu_to_le32(nego);			\</span>
<span class="cp">	pg1.Reserved = 0;						\</span>
<span class="cp">	pg1.Configuration = 0;						\</span>
<span class="cp">									\</span>
<span class="cp">	mptspi_write_spi_device_pg1(starget, &amp;pg1);				\</span>
<span class="cp">}</span>

<span class="n">MPTSPI_SIMPLE_TRANSPORT_PARM</span><span class="p">(</span><span class="n">rd_strm</span><span class="p">)</span>
<span class="n">MPTSPI_SIMPLE_TRANSPORT_PARM</span><span class="p">(</span><span class="n">wr_flow</span><span class="p">)</span>
<span class="n">MPTSPI_SIMPLE_TRANSPORT_PARM</span><span class="p">(</span><span class="n">rti</span><span class="p">)</span>
<span class="n">MPTSPI_SIMPLE_TRANSPORT_PARM</span><span class="p">(</span><span class="n">hold_mcs</span><span class="p">)</span>
<span class="n">MPTSPI_SIMPLE_TRANSPORT_PARM</span><span class="p">(</span><span class="n">pcomp_en</span><span class="p">)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mptspi_write_qas</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qas</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_CONFIG_PAGE_SCSI_DEVICE_1</span> <span class="n">pg1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="n">VirtTarget</span> <span class="o">*</span><span class="n">vtarget</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nego</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">negoFlags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_NO_NEGO_QAS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">noQas</span><span class="p">)</span>
		<span class="n">spi_qas</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">spi_qas</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">qas</span><span class="p">;</span>

	<span class="n">nego</span> <span class="o">=</span> <span class="n">mptspi_getRP</span><span class="p">(</span><span class="n">starget</span><span class="p">);</span>

	<span class="n">pg1</span><span class="p">.</span><span class="n">RequestedParameters</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nego</span><span class="p">);</span>
	<span class="n">pg1</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pg1</span><span class="p">.</span><span class="n">Configuration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mptspi_write_spi_device_pg1</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mptspi_write_width</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_CONFIG_PAGE_SCSI_DEVICE_1</span> <span class="n">pg1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nego</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spi_dt</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spi_period</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">spi_period</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spi_width</span><span class="p">(</span><span class="n">starget</span><span class="p">)</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>

	<span class="n">nego</span> <span class="o">=</span> <span class="n">mptspi_getRP</span><span class="p">(</span><span class="n">starget</span><span class="p">);</span>

	<span class="n">pg1</span><span class="p">.</span><span class="n">RequestedParameters</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nego</span><span class="p">);</span>
	<span class="n">pg1</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pg1</span><span class="p">.</span><span class="n">Configuration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mptspi_write_spi_device_pg1</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">work_queue_wrapper</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">disk</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpt_work_wrapper</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">work_queue_wrapper</span> <span class="o">*</span><span class="n">wqw</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">work_queue_wrapper</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">wqw</span><span class="o">-&gt;</span><span class="n">hd</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disk</span> <span class="o">=</span> <span class="n">wqw</span><span class="o">-&gt;</span><span class="n">disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_CONFIG_PAGE_IOC_3</span> <span class="o">*</span><span class="n">pg3</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">wqw</span><span class="p">);</span>

	<span class="n">mpt_findImVolumes</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">pg3</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pg3</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span><span class="n">shost</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span> <span class="o">=</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="n">VirtTarget</span> <span class="o">*</span><span class="n">vtarget</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

		<span class="cm">/* only want to search RAID components */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* The id is the raid PhysDiskNum, even if</span>
<span class="cm">		 * starget-&gt;id is the actual target address */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">disk</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span>
		    <span class="s">&quot;Integrated RAID requests DV of new device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">mptspi_dv_device</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">sdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">shost</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span>
	    <span class="s">&quot;Integrated RAID detects new device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">disk</span><span class="p">);</span>
	<span class="n">scsi_scan_target</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">shost_gendev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpt_dv_raid</span><span class="p">(</span><span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">work_queue_wrapper</span> <span class="o">*</span><span class="n">wqw</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wqw</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wqw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span>
		    <span class="s">&quot;Failed to act on RAID event for physical disk %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">disk</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wqw</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">mpt_work_wrapper</span><span class="p">);</span>
	<span class="n">wqw</span><span class="o">-&gt;</span><span class="n">hd</span> <span class="o">=</span> <span class="n">hd</span><span class="p">;</span>
	<span class="n">wqw</span><span class="o">-&gt;</span><span class="n">disk</span> <span class="o">=</span> <span class="n">disk</span><span class="p">;</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wqw</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptspi_event_process</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">EventNotificationReply_t</span> <span class="o">*</span><span class="n">pEvReply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">event</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pEvReply</span><span class="o">-&gt;</span><span class="n">Event</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="n">SPI</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hd</span> <span class="o">&amp;&amp;</span> <span class="n">event</span> <span class="o">==</span>  <span class="n">MPI_EVENT_INTEGRATED_RAID</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">reason</span>
			<span class="o">=</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pEvReply</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">MPI_EVENT_RAID_RC_DOMAIN_VAL_NEEDED</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">disk</span> <span class="o">=</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pEvReply</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFF000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">mpt_dv_raid</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">disk</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">mptscsih_event_process</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">pEvReply</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptspi_deny_binding</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_to_shost</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">mptspi_is_raid</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_function_template</span> <span class="n">mptspi_transport_functions</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_offset</span>	<span class="o">=</span> <span class="n">mptspi_read_parameters</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_offset</span>	<span class="o">=</span> <span class="n">mptspi_write_offset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_offset</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_period</span>	<span class="o">=</span> <span class="n">mptspi_read_parameters</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_period</span>	<span class="o">=</span> <span class="n">mptspi_write_period</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_period</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_width</span>	<span class="o">=</span> <span class="n">mptspi_read_parameters</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_width</span>	<span class="o">=</span> <span class="n">mptspi_write_width</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_width</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_iu</span>		<span class="o">=</span> <span class="n">mptspi_read_parameters</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_iu</span>		<span class="o">=</span> <span class="n">mptspi_write_iu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_iu</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_dt</span>		<span class="o">=</span> <span class="n">mptspi_read_parameters</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dt</span>		<span class="o">=</span> <span class="n">mptspi_write_dt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_dt</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_qas</span>	<span class="o">=</span> <span class="n">mptspi_read_parameters</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_qas</span>	<span class="o">=</span> <span class="n">mptspi_write_qas</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_qas</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wr_flow</span>	<span class="o">=</span> <span class="n">mptspi_read_parameters</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wr_flow</span>	<span class="o">=</span> <span class="n">mptspi_write_wr_flow</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_wr_flow</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rd_strm</span>	<span class="o">=</span> <span class="n">mptspi_read_parameters</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rd_strm</span>	<span class="o">=</span> <span class="n">mptspi_write_rd_strm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rd_strm</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rti</span>	<span class="o">=</span> <span class="n">mptspi_read_parameters</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rti</span>	<span class="o">=</span> <span class="n">mptspi_write_rti</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_rti</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pcomp_en</span>	<span class="o">=</span> <span class="n">mptspi_read_parameters</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pcomp_en</span>	<span class="o">=</span> <span class="n">mptspi_write_pcomp_en</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_pcomp_en</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_hold_mcs</span>	<span class="o">=</span> <span class="n">mptspi_read_parameters</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_hold_mcs</span>	<span class="o">=</span> <span class="n">mptspi_write_hold_mcs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_hold_mcs</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">deny_binding</span>	<span class="o">=</span> <span class="n">mptspi_deny_binding</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * Supported hardware</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">mptspi_pci_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LSI_LOGIC</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVID_53C1030</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ATTO</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVID_53C1030</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LSI_LOGIC</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVID_53C1035</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">}</span>	<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">mptspi_pci_table</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * renegotiate for a given target</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptspi_dv_renegotiate_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">work_queue_wrapper</span> <span class="o">*</span><span class="n">wqw</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">work_queue_wrapper</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">wqw</span><span class="o">-&gt;</span><span class="n">hd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_CONFIG_PAGE_SCSI_DEVICE_1</span> <span class="n">pg1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nego</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">wqw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">spi_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span>  <span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">spi_pending</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">starget</span> <span class="o">=</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
			<span class="n">nego</span> <span class="o">=</span> <span class="n">mptspi_getRP</span><span class="p">(</span><span class="n">starget</span><span class="p">);</span>
			<span class="n">pg1</span><span class="p">.</span><span class="n">RequestedParameters</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">nego</span><span class="p">);</span>
			<span class="n">pg1</span><span class="p">.</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pg1</span><span class="p">.</span><span class="n">Configuration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mptspi_write_spi_device_pg1</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span>
			<span class="n">mptspi_dv_device</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">sdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptspi_dv_renegotiate</span><span class="p">(</span><span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">work_queue_wrapper</span> <span class="o">*</span><span class="n">wqw</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wqw</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wqw</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wqw</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">mptspi_dv_renegotiate_work</span><span class="p">);</span>
	<span class="n">wqw</span><span class="o">-&gt;</span><span class="n">hd</span> <span class="o">=</span> <span class="n">hd</span><span class="p">;</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wqw</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * spi module reset handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptspi_ioc_reset</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_phase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mptscsih_ioc_reset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reset_phase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="n">SPI</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* only try to do a renegotiation if we&#39;re properly set up</span>
<span class="cm">	 * if we get an ioc fault on bringup, ioc-&gt;sh will be NULL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset_phase</span> <span class="o">==</span> <span class="n">MPT_IOC_POST_RESET</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>

		<span class="n">mptspi_dv_renegotiate</span><span class="p">(</span><span class="n">hd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/*</span>
<span class="cm"> * spi module resume handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptspi_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> 	<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">_MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mptscsih_resume</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">mptspi_dv_renegotiate</span><span class="p">(</span><span class="n">hd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptspi_probe - Installs scsi devices per bus.</span>
<span class="cm"> *	@pdev: Pointer to pci_dev structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptspi_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>	<span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="n">MPT_SCSI_HOST</span>		<span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> 		<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		 <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">ii</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">numSGE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">scale</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">ioc_cap</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">mpt_attach</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="n">id</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">DoneCtx</span> <span class="o">=</span> <span class="n">mptspiDoneCtx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">TaskCtx</span> <span class="o">=</span> <span class="n">mptspiTaskCtx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">InternalCtx</span> <span class="o">=</span> <span class="n">mptspiInternalCtx</span><span class="p">;</span>

	<span class="cm">/*  Added sanity check on readiness of the MPT adapter.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">last_state</span> <span class="o">!=</span> <span class="n">MPI_IOC_STATE_OPERATIONAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
		  <span class="s">&quot;Skipping because it&#39;s not operational!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mptspi_probe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;Skipping because it&#39;s disabled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mptspi_probe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Sanity check - ensure at least 1 port is INITIATOR capable</span>
<span class="cm">	 */</span>
	<span class="n">ioc_cap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">ProtocolFlags</span> <span class="o">&amp;</span>
		    <span class="n">MPI_PORTFACTS_PROTOCOL_INITIATOR</span><span class="p">)</span>
			<span class="n">ioc_cap</span> <span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc_cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			<span class="s">&quot;Skipping ioc=%p because SCSI Initiator mode is NOT enabled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sh</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptspi_driver_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MPT_SCSI_HOST</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			<span class="s">&quot;Unable to register controller with SCSI subsystem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mptspi_probe</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Attach the SCSI Host to the IOC structure</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span> <span class="o">=</span> <span class="n">sh</span><span class="p">;</span>

	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set 16 byte cdb&#39;s */</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* Yikes!  This is important!</span>
<span class="cm">	 * Otherwise, by default, linux</span>
<span class="cm">	 * only scans target IDs 0-7!</span>
<span class="cm">	 * pfactsN-&gt;MaxDevices unreliable</span>
<span class="cm">	 * (not supported in early</span>
<span class="cm">	 *	versions of the FW).</span>
<span class="cm">	 * max_id = 1 + actual max id,</span>
<span class="cm">	 * max_lun = 1 + actual last lun,</span>
<span class="cm">	 *	see hosts.h :o(</span>
<span class="cm">	 */</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">devices_per_bus</span><span class="p">;</span>

	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">MPT_LAST_LUN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * If RAID Firmware Detected, setup virtual channel</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ir_firmware</span><span class="p">)</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">this_id</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PortSCSIID</span><span class="p">;</span>

	<span class="cm">/* Required entry.</span>
<span class="cm">	 */</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="cm">/* Verify that we won&#39;t exceed the maximum</span>
<span class="cm">	 * number of chain buffers</span>
<span class="cm">	 * We can optimize:  ZZ = req_sz/sizeof(SGE)</span>
<span class="cm">	 * For 32bit SGE&#39;s:</span>
<span class="cm">	 *  numSGE = 1 + (ZZ-1)*(maxChain -1) + ZZ</span>
<span class="cm">	 *               + (req_sz - 64)/sizeof(SGE)</span>
<span class="cm">	 * A slightly different algorithm is required for</span>
<span class="cm">	 * 64bit SGEs.</span>
<span class="cm">	 */</span>
	<span class="n">scale</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="o">/</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sg_addr_size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">numSGE</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		  <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxChainDepth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">+</span>
		  <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">-</span> <span class="mi">60</span><span class="p">)</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">numSGE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">scale</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		  <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxChainDepth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">+</span>
		  <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">-</span> <span class="mi">64</span><span class="p">)</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">numSGE</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset this value */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		  <span class="s">&quot;Resetting sg_tablesize to %d from %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">numSGE</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">));</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">numSGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
	<span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">ioc</span><span class="p">;</span>

	<span class="cm">/* SCSI needs scsi_cmnd lookup table!</span>
<span class="cm">	 * (with size equal to req_depth*PtrSz!)</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mptspi_probe</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;ScsiLookup @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span><span class="p">));</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">Saf_Te</span> <span class="o">=</span> <span class="n">mpt_saf_te</span><span class="p">;</span>
	<span class="n">ddvprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		<span class="s">&quot;saf_te %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">mpt_saf_te</span><span class="p">));</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">noQas</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hd</span><span class="o">-&gt;</span><span class="n">last_queue_full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hd</span><span class="o">-&gt;</span><span class="n">spi_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Some versions of the firmware don&#39;t support page 0; without</span>
<span class="cm">	 * that we can&#39;t get the parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp0length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">transportt</span> <span class="o">=</span> <span class="n">mptspi_transport_template</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">scsi_add_host</span> <span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
		  <span class="s">&quot;scsi_add_host failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_mptspi_probe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * issue internal bus reset</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">bus_reset</span><span class="p">)</span>
		<span class="n">mptscsih_IssueTaskMgmt</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span>
		    <span class="n">MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS</span><span class="p">,</span>
		    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

	<span class="n">scsi_scan_host</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_mptspi_probe:</span>

	<span class="n">mptscsih_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">mptspi_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;mptspi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">mptspi_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mptspi_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">mptscsih_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">mptscsih_shutdown</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">mptscsih_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">mptspi_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptspi_init - Register MPT adapter(s) as SCSI host(s) with SCSI mid-layer.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">mptspi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">show_mptmod_ver</span><span class="p">(</span><span class="n">my_NAME</span><span class="p">,</span> <span class="n">my_VERSION</span><span class="p">);</span>

	<span class="n">mptspi_transport_template</span> <span class="o">=</span> <span class="n">spi_attach_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptspi_transport_functions</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mptspi_transport_template</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mptspiDoneCtx</span> <span class="o">=</span> <span class="n">mpt_register</span><span class="p">(</span><span class="n">mptscsih_io_done</span><span class="p">,</span> <span class="n">MPTSPI_DRIVER</span><span class="p">,</span>
	    <span class="s">&quot;mptscsih_io_done&quot;</span><span class="p">);</span>
	<span class="n">mptspiTaskCtx</span> <span class="o">=</span> <span class="n">mpt_register</span><span class="p">(</span><span class="n">mptscsih_taskmgmt_complete</span><span class="p">,</span> <span class="n">MPTSPI_DRIVER</span><span class="p">,</span>
	    <span class="s">&quot;mptscsih_taskmgmt_complete&quot;</span><span class="p">);</span>
	<span class="n">mptspiInternalCtx</span> <span class="o">=</span> <span class="n">mpt_register</span><span class="p">(</span><span class="n">mptscsih_scandv_complete</span><span class="p">,</span>
	    <span class="n">MPTSPI_DRIVER</span><span class="p">,</span> <span class="s">&quot;mptscsih_scandv_complete&quot;</span><span class="p">);</span>

	<span class="n">mpt_event_register</span><span class="p">(</span><span class="n">mptspiDoneCtx</span><span class="p">,</span> <span class="n">mptspi_event_process</span><span class="p">);</span>
	<span class="n">mpt_reset_register</span><span class="p">(</span><span class="n">mptspiDoneCtx</span><span class="p">,</span> <span class="n">mptspi_ioc_reset</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptspi_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">spi_release_transport</span><span class="p">(</span><span class="n">mptspi_transport_template</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptspi_exit - Unregisters MPT adapter(s)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">mptspi_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptspi_driver</span><span class="p">);</span>

	<span class="n">mpt_reset_deregister</span><span class="p">(</span><span class="n">mptspiDoneCtx</span><span class="p">);</span>
	<span class="n">mpt_event_deregister</span><span class="p">(</span><span class="n">mptspiDoneCtx</span><span class="p">);</span>

	<span class="n">mpt_deregister</span><span class="p">(</span><span class="n">mptspiInternalCtx</span><span class="p">);</span>
	<span class="n">mpt_deregister</span><span class="p">(</span><span class="n">mptspiTaskCtx</span><span class="p">);</span>
	<span class="n">mpt_deregister</span><span class="p">(</span><span class="n">mptspiDoneCtx</span><span class="p">);</span>
	<span class="n">spi_release_transport</span><span class="p">(</span><span class="n">mptspi_transport_template</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">mptspi_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mptspi_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
