<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › message › fusion › mptscsih.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mptscsih.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/message/fusion/mptscsih.c</span>
<span class="cm"> *      For use with LSI PCI chip/adapter(s)</span>
<span class="cm"> *      running LSI Fusion MPT (Message Passing Technology) firmware.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 1999-2008 LSI Corporation</span>
<span class="cm"> *  (mailto:DL-MPTFusionLinux@lsi.com)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; version 2 of the License.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    NO WARRANTY</span>
<span class="cm">    THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span>
<span class="cm">    CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT</span>
<span class="cm">    LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,</span>
<span class="cm">    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is</span>
<span class="cm">    solely responsible for determining the appropriateness of using and</span>
<span class="cm">    distributing the Program and assumes all risks associated with its</span>
<span class="cm">    exercise of rights under this Agreement, including but not limited to</span>
<span class="cm">    the risks and costs of program errors, damage to or loss of data,</span>
<span class="cm">    programs or equipment, and unavailability or interruption of operations.</span>

<span class="cm">    DISCLAIMER OF LIABILITY</span>
<span class="cm">    NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY</span>
<span class="cm">    DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm">    DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND</span>
<span class="cm">    ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR</span>
<span class="cm">    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE</span>
<span class="cm">    USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED</span>
<span class="cm">    HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm">*/</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kdev_t.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;	</span><span class="cm">/* for mdelay */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/interrupt.h&gt;	</span><span class="cm">/* needed for in_interrupt() proto */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/reboot.h&gt;	</span><span class="cm">/* notifier code */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_dbg.h&gt;</span>

<span class="cp">#include &quot;mptbase.h&quot;</span>
<span class="cp">#include &quot;mptscsih.h&quot;</span>
<span class="cp">#include &quot;lsi/mpi_log_sas.h&quot;</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cp">#define my_NAME		&quot;Fusion MPT SCSI Host driver&quot;</span>
<span class="cp">#define my_VERSION	MPT_LINUX_VERSION_COMMON</span>
<span class="cp">#define MYNAM		&quot;mptscsih&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">MODULEAUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">my_NAME</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">my_VERSION</span><span class="p">);</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *  Other private/forward protos...</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">scsi_cmnd</span>	<span class="o">*</span><span class="n">mptscsih_get_scsi_lookup</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">mptscsih_getclear_scsi_lookup</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">mptscsih_set_scsi_lookup</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">SCPNT_TO_LOOKUP_IDX</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">);</span>
<span class="kt">int</span>		<span class="n">mptscsih_io_done</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">r</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">mptscsih_report_queue_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">SCSIIOReply_t</span> <span class="o">*</span><span class="n">pScsiReply</span><span class="p">,</span> <span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="n">pScsiReq</span><span class="p">);</span>
<span class="kt">int</span>		<span class="n">mptscsih_taskmgmt_complete</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">r</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>	<span class="n">mptscsih_AddSGE</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span>
				 <span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="n">pReq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_idx</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">mptscsih_freeChainBuffers</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_idx</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">mptscsih_copy_sense_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">,</span> <span class="n">SCSIIOReply_t</span> <span class="o">*</span><span class="n">pScsiReply</span><span class="p">);</span>

<span class="kt">int</span>	<span class="n">mptscsih_IssueTaskMgmt</span><span class="p">(</span><span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ctx2abort</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">timeout</span><span class="p">);</span>

<span class="kt">int</span>		<span class="n">mptscsih_ioc_reset</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">post_reset</span><span class="p">);</span>
<span class="kt">int</span>		<span class="n">mptscsih_event_process</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">EventNotificationReply_t</span> <span class="o">*</span><span class="n">pEvReply</span><span class="p">);</span>

<span class="kt">void</span>
<span class="n">mptscsih_taskmgmt_response_code</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">response_code</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">mptscsih_get_completion_code</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
		<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">reply</span><span class="p">);</span>
<span class="kt">int</span>		<span class="n">mptscsih_scandv_complete</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">r</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">mptscsih_do_cmd</span><span class="p">(</span><span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="n">INTERNAL_CMD</span> <span class="o">*</span><span class="n">iocmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">mptscsih_synchronize_cache</span><span class="p">(</span><span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="n">VirtDevice</span> <span class="o">*</span><span class="n">vdevice</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="n">mptscsih_taskmgmt_reply</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span>
				<span class="n">SCSITaskMgmtReply_t</span> <span class="o">*</span><span class="n">pScsiTmReply</span><span class="p">);</span>
<span class="kt">void</span> 		<span class="n">mptscsih_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">void</span> 		<span class="n">mptscsih_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="kt">int</span> 		<span class="n">mptscsih_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">);</span>
<span class="kt">int</span> 		<span class="n">mptscsih_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#define SNS_LEN(scp)	SCSI_SENSE_BUFFERSIZE</span>


<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptscsih_getFreeChainBuffer - Function to get a free chain</span>
<span class="cm"> *	from the MPT_SCSI_HOST FreeChainQ.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@req_idx: Index of the SCSI IO request frame. (output)</span>
<span class="cm"> *</span>
<span class="cm"> *	return SUCCESS or FAILED</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">mptscsih_getFreeChainBuffer</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">retIndex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">chainBuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chain_idx</span><span class="p">;</span>

	<span class="n">dsgprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;getFreeChainBuffer called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeChainQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>

		<span class="n">chainBuf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeChainQ</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span><span class="p">,</span>
				<span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">linkage</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chainBuf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">linkage</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">chainBuf</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainBuffer</span><span class="p">;</span>
		<span class="n">chain_idx</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="n">dsgprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;getFreeChainBuffer chainBuf=%p ChainBuffer=%p offset=%d chain_idx=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chainBuf</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainBuffer</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">chain_idx</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="n">chain_idx</span> <span class="o">=</span> <span class="n">MPT_HOST_NO_CHAIN</span><span class="p">;</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;getFreeChainBuffer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="o">*</span><span class="n">retIndex</span> <span class="o">=</span> <span class="n">chain_idx</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* mptscsih_getFreeChainBuffer() */</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptscsih_AddSGE - Add a SGE (plus chain buffers) to the</span>
<span class="cm"> *	SCSIIORequest_t Message Frame.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@SCpnt: Pointer to scsi_cmnd structure</span>
<span class="cm"> *	@pReq: Pointer to SCSIIORequest_t structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptscsih_AddSGE</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span>
		<span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="n">pReq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> 	<span class="o">*</span><span class="n">psge</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">chainSge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">frm_sz</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">sges_left</span><span class="p">,</span> <span class="n">sg_done</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">chain_idx</span> <span class="o">=</span> <span class="n">MPT_HOST_NO_CHAIN</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">sgeOffset</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">numSgeSlots</span><span class="p">,</span> <span class="n">numSgeThisFrame</span><span class="p">;</span>
	<span class="n">u32</span>	 <span class="n">sgflags</span><span class="p">,</span> <span class="n">sgdir</span><span class="p">,</span> <span class="n">thisxfer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">chain_dma_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">newIndex</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">ii</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">v2</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">RequestNB</span><span class="p">;</span>

	<span class="n">sgdir</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Control</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIIO_CONTROL_DATADIRECTION_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sgdir</span> <span class="o">==</span> <span class="n">MPI_SCSIIO_CONTROL_WRITE</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">sgdir</span> <span class="o">=</span> <span class="n">MPT_TRANSFER_HOST_TO_IOC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sgdir</span> <span class="o">=</span> <span class="n">MPT_TRANSFER_IOC_TO_HOST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psge</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pReq</span><span class="o">-&gt;</span><span class="n">SGL</span><span class="p">;</span>
	<span class="n">frm_sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">;</span>

	<span class="cm">/* Map the data portion, if any.</span>
<span class="cm">	 * sges_left  = 0 if no data transfer.</span>
<span class="cm">	 */</span>
	<span class="n">sges_left</span> <span class="o">=</span> <span class="n">scsi_dma_map</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sges_left</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>

	<span class="cm">/* Handle the SG case.</span>
<span class="cm">	 */</span>
	<span class="n">sg</span> <span class="o">=</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
	<span class="n">sg_done</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sgeOffset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCSIIORequest_t</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SGE_IO_UNION</span><span class="p">);</span>
	<span class="n">chainSge</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Prior to entering this loop - the following must be set</span>
<span class="cm">	 * current MF:  sgeOffset (bytes)</span>
<span class="cm">	 *              chainSge (Null if original MF is not a chain buffer)</span>
<span class="cm">	 *              sg_done (num SGE done for this MF)</span>
<span class="cm">	 */</span>

<span class="nl">nextSGEset:</span>
	<span class="n">numSgeSlots</span> <span class="o">=</span> <span class="p">((</span><span class="n">frm_sz</span> <span class="o">-</span> <span class="n">sgeOffset</span><span class="p">)</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">);</span>
	<span class="n">numSgeThisFrame</span> <span class="o">=</span> <span class="p">(</span><span class="n">sges_left</span> <span class="o">&lt;</span> <span class="n">numSgeSlots</span><span class="p">)</span> <span class="o">?</span> <span class="n">sges_left</span> <span class="o">:</span> <span class="n">numSgeSlots</span><span class="p">;</span>

	<span class="n">sgflags</span> <span class="o">=</span> <span class="n">MPT_SGE_FLAGS_SIMPLE_ELEMENT</span> <span class="o">|</span> <span class="n">sgdir</span><span class="p">;</span>

	<span class="cm">/* Get first (num - 1) SG elements</span>
<span class="cm">	 * Skip any SG entries with a length of 0</span>
<span class="cm">	 * NOTE: at finish, sg and psge pointed to NEXT data/location positions</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">numSgeThisFrame</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">thisxfer</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">thisxfer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Get next SG element from the OS */</span>
			<span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">sg_done</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">v2</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">sgflags</span> <span class="o">|</span> <span class="n">thisxfer</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>

		<span class="cm">/* Get next SG element from the OS */</span>
		<span class="n">sg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">psge</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
		<span class="n">sgeOffset</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
		<span class="n">sg_done</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">numSgeThisFrame</span> <span class="o">==</span> <span class="n">sges_left</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Add last element, end of buffer and end of list flags.</span>
<span class="cm">		 */</span>
		<span class="n">sgflags</span> <span class="o">|=</span> <span class="n">MPT_SGE_FLAGS_LAST_ELEMENT</span> <span class="o">|</span>
				<span class="n">MPT_SGE_FLAGS_END_OF_BUFFER</span> <span class="o">|</span>
				<span class="n">MPT_SGE_FLAGS_END_OF_LIST</span><span class="p">;</span>

		<span class="cm">/* Add last SGE and set termination flags.</span>
<span class="cm">		 * Note: Last SGE may have a length of 0 - which should be ok.</span>
<span class="cm">		 */</span>
		<span class="n">thisxfer</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

		<span class="n">v2</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">sgflags</span> <span class="o">|</span> <span class="n">thisxfer</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
		<span class="n">sgeOffset</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
		<span class="n">sg_done</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chainSge</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The current buffer is a chain buffer,</span>
<span class="cm">			 * but there is not another one.</span>
<span class="cm">			 * Update the chain element</span>
<span class="cm">			 * Offset and Length fields.</span>
<span class="cm">			 */</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_chain</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">chainSge</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sgeOffset</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainBufferDMA</span> <span class="o">+</span> <span class="n">chain_dma_off</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The current buffer is the original MF</span>
<span class="cm">			 * and there is no Chain buffer.</span>
<span class="cm">			 */</span>
			<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">RequestNB</span> <span class="o">=</span> <span class="p">(((</span><span class="n">sgeOffset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">NBShiftFactor</span><span class="p">)</span>  <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="n">dsgprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			    <span class="s">&quot;Single Buffer RequestNB=%x, sgeOffset=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">RequestNB</span><span class="p">,</span> <span class="n">sgeOffset</span><span class="p">));</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">RequestNB</span><span class="p">[</span><span class="n">req_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">RequestNB</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* At least one chain buffer is needed.</span>
<span class="cm">		 * Complete the first MF</span>
<span class="cm">		 *  - last SGE element, set the LastElement bit</span>
<span class="cm">		 *  - set ChainOffset (words) for orig MF</span>
<span class="cm">		 *             (OR finish previous MF chain buffer)</span>
<span class="cm">		 *  - update MFStructPtr ChainIndex</span>
<span class="cm">		 *  - Populate chain element</span>
<span class="cm">		 * Also</span>
<span class="cm">		 * Loop until done.</span>
<span class="cm">		 */</span>

		<span class="n">dsgprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;SG: Chain Required! sg done %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sg_done</span><span class="p">));</span>

		<span class="cm">/* Set LAST_ELEMENT flag for last non-chain element</span>
<span class="cm">		 * in the buffer. Since psge points at the NEXT</span>
<span class="cm">		 * SGE element, go back one SGE element, update the flags</span>
<span class="cm">		 * and reset the pointer. (Note: sgflags &amp; thisxfer are already</span>
<span class="cm">		 * set properly).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sg_done</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">ptmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">psge</span> <span class="o">-</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">);</span>
			<span class="n">sgflags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">ptmp</span><span class="p">);</span>
			<span class="n">sgflags</span> <span class="o">|=</span> <span class="n">MPT_SGE_FLAGS_LAST_ELEMENT</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ptmp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sgflags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chainSge</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The current buffer is a chain buffer.</span>
<span class="cm">			 * chainSge points to the previous Chain Element.</span>
<span class="cm">			 * Update its chain element Offset and Length (must</span>
<span class="cm">			 * include chain element size) fields.</span>
<span class="cm">			 * Old chain element is now complete.</span>
<span class="cm">			 */</span>
			<span class="n">u8</span> <span class="n">nextChain</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">sgeOffset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">sgeOffset</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_chain</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">chainSge</span><span class="p">,</span> <span class="n">nextChain</span><span class="p">,</span> <span class="n">sgeOffset</span><span class="p">,</span>
					 <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainBufferDMA</span> <span class="o">+</span> <span class="n">chain_dma_off</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* The original MF buffer requires a chain buffer -</span>
<span class="cm">			 * set the offset.</span>
<span class="cm">			 * Last element in this MF is a chain element.</span>
<span class="cm">			 */</span>
			<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">sgeOffset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">RequestNB</span> <span class="o">=</span> <span class="p">(((</span><span class="n">sgeOffset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">NBShiftFactor</span><span class="p">)</span>  <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="n">dsgprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Chain Buffer Needed, RequestNB=%x sgeOffset=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">RequestNB</span><span class="p">,</span> <span class="n">sgeOffset</span><span class="p">));</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">RequestNB</span><span class="p">[</span><span class="n">req_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">RequestNB</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sges_left</span> <span class="o">-=</span> <span class="n">sg_done</span><span class="p">;</span>


		<span class="cm">/* NOTE: psge points to the beginning of the chain element</span>
<span class="cm">		 * in current buffer. Get a chain buffer.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mptscsih_getFreeChainBuffer</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newIndex</span><span class="p">))</span> <span class="o">==</span> <span class="n">FAILED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			    <span class="s">&quot;getFreeChainBuffer FAILED SCSI cmd=%02x (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
 			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SCpnt</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Update the tracking arrays.</span>
<span class="cm">		 * If chainSge == NULL, update ReqToChain, else ChainToChain</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chainSge</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainToChain</span><span class="p">[</span><span class="n">chain_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">newIndex</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ReqToChain</span><span class="p">[</span><span class="n">req_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">newIndex</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chain_idx</span> <span class="o">=</span> <span class="n">newIndex</span><span class="p">;</span>
		<span class="n">chain_dma_off</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">*</span> <span class="n">chain_idx</span><span class="p">;</span>

		<span class="cm">/* Populate the chainSGE for the current buffer.</span>
<span class="cm">		 * - Set chain buffer pointer to psge and fill</span>
<span class="cm">		 *   out the Address and Flags fields.</span>
<span class="cm">		 */</span>
		<span class="n">chainSge</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">psge</span><span class="p">;</span>
		<span class="n">dsgprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;  Current buff @ %p (index 0x%x)&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">psge</span><span class="p">,</span> <span class="n">req_idx</span><span class="p">));</span>

		<span class="cm">/* Start the SGE for the next buffer</span>
<span class="cm">		 */</span>
		<span class="n">psge</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainBuffer</span> <span class="o">+</span> <span class="n">chain_dma_off</span><span class="p">);</span>
		<span class="n">sgeOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sg_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dsgprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;  Chain buff @ %p (index 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">psge</span><span class="p">,</span> <span class="n">chain_idx</span><span class="p">));</span>

		<span class="cm">/* Start the SGE for the next buffer</span>
<span class="cm">		 */</span>

		<span class="k">goto</span> <span class="n">nextSGEset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* mptscsih_AddSGE() */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptscsih_issue_sep_command</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">VirtTarget</span> <span class="o">*</span><span class="n">vtarget</span><span class="p">,</span>
    <span class="n">U32</span> <span class="n">SlotStatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">SEPRequest_t</span> 	 <span class="o">*</span><span class="n">SEPMsg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="n">SAS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Not supported for hidden raid components</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">InternalCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;%s: no msg frames!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">__func__</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SEPMsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">SEPRequest_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">SEPMsg</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_SCSI_ENCLOSURE_PROCESSOR</span><span class="p">;</span>
	<span class="n">SEPMsg</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">=</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">SEPMsg</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">SEPMsg</span><span class="o">-&gt;</span><span class="n">Action</span> <span class="o">=</span> <span class="n">MPI_SEP_REQ_ACTION_WRITE_STATUS</span><span class="p">;</span>
	<span class="n">SEPMsg</span><span class="o">-&gt;</span><span class="n">SlotStatus</span> <span class="o">=</span> <span class="n">SlotStatus</span><span class="p">;</span>
	<span class="n">devtverboseprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;Sending SEP cmd=%x channel=%d id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SlotStatus</span><span class="p">,</span> <span class="n">SEPMsg</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">,</span> <span class="n">SEPMsg</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">));</span>
	<span class="n">mpt_put_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">DoneCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FUSION_LOGGING</span>
<span class="cm">/**</span>
<span class="cm"> *	mptscsih_info_scsiio - debug print info on reply frame</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@sc: original scsi cmnd pointer</span>
<span class="cm"> *	@pScsiReply: Pointer to MPT reply frame</span>
<span class="cm"> *</span>
<span class="cm"> *	MPT_DEBUG_REPLY needs to be enabled to obtain this info</span>
<span class="cm"> *</span>
<span class="cm"> *	Refer to lsi/mpi.h.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptscsih_info_scsiio</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">SCSIIOReply_t</span> <span class="o">*</span> <span class="n">pScsiReply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">desc1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">ioc_status</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">skey</span><span class="p">,</span> <span class="n">asc</span><span class="p">,</span> <span class="n">ascq</span><span class="p">;</span>

	<span class="n">ioc_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_IOCSTATUS_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ioc_status</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SUCCESS</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;success&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_INVALID_BUS</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;invalid bus&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_INVALID_TARGETID</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;invalid target_id&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_DEVICE_NOT_THERE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;device not there&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_DATA_OVERRUN</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;data overrun&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_DATA_UNDERRUN</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;data underrun&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_IO_DATA_ERROR</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;I/O data error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_PROTOCOL_ERROR</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;protocol error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_TASK_TERMINATED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;task terminated&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_RESIDUAL_MISMATCH</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;residual mismatch&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_TASK_MGMT_FAILED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;task management failed&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_IOC_TERMINATED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;IOC terminated&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_EXT_TERMINATED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;ext terminated&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">SCSIStatus</span><span class="p">)</span>
	<span class="p">{</span>

	<span class="k">case</span> <span class="n">MPI_SCSI_STATUS_SUCCESS</span>:
		<span class="n">desc1</span> <span class="o">=</span> <span class="s">&quot;success&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSI_STATUS_CHECK_CONDITION</span>:
		<span class="n">desc1</span> <span class="o">=</span> <span class="s">&quot;check condition&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSI_STATUS_CONDITION_MET</span>:
		<span class="n">desc1</span> <span class="o">=</span> <span class="s">&quot;condition met&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSI_STATUS_BUSY</span>:
		<span class="n">desc1</span> <span class="o">=</span> <span class="s">&quot;busy&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSI_STATUS_INTERMEDIATE</span>:
		<span class="n">desc1</span> <span class="o">=</span> <span class="s">&quot;intermediate&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSI_STATUS_INTERMEDIATE_CONDMET</span>:
		<span class="n">desc1</span> <span class="o">=</span> <span class="s">&quot;intermediate condmet&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSI_STATUS_RESERVATION_CONFLICT</span>:
		<span class="n">desc1</span> <span class="o">=</span> <span class="s">&quot;reservation conflict&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSI_STATUS_COMMAND_TERMINATED</span>:
		<span class="n">desc1</span> <span class="o">=</span> <span class="s">&quot;command terminated&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSI_STATUS_TASK_SET_FULL</span>:
		<span class="n">desc1</span> <span class="o">=</span> <span class="s">&quot;task set full&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSI_STATUS_ACA_ACTIVE</span>:
		<span class="n">desc1</span> <span class="o">=</span> <span class="s">&quot;aca active&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSI_STATUS_FCPEXT_DEVICE_LOGGED_OUT</span>:
		<span class="n">desc1</span> <span class="o">=</span> <span class="s">&quot;fcpext device logged out&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSI_STATUS_FCPEXT_NO_LINK</span>:
		<span class="n">desc1</span> <span class="o">=</span> <span class="s">&quot;fcpext no link&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSI_STATUS_FCPEXT_UNASSIGNED</span>:
		<span class="n">desc1</span> <span class="o">=</span> <span class="s">&quot;fcpext unassigned&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">desc1</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">fw_channel = %d, fw_id = %d, lun = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">,</span> <span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">request_len = %d, underflow = %d, &quot;</span>
	    <span class="s">&quot;resid = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">,</span>
	    <span class="n">scsi_get_resid</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">tag = %d, transfer_count = %d, &quot;</span>
	    <span class="s">&quot;sc-&gt;result = %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">TaskTag</span><span class="p">),</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">TransferCount</span><span class="p">),</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">iocstatus = %s (0x%04x), &quot;</span>
	    <span class="s">&quot;scsi_status = %s (0x%02x), scsi_state = (0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">ioc_status</span><span class="p">,</span> <span class="n">desc1</span><span class="p">,</span> <span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">SCSIStatus</span><span class="p">,</span>
	    <span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">SCSIState</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">SCSIState</span> <span class="o">&amp;</span> <span class="n">MPI_SCSI_STATE_AUTOSENSE_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skey</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
		<span class="n">asc</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
		<span class="n">ascq</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">[sense_key,asc,ascq]: &quot;</span>
		    <span class="s">&quot;[0x%02x,0x%02x,0x%02x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skey</span><span class="p">,</span> <span class="n">asc</span><span class="p">,</span> <span class="n">ascq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Look for + dump FCP ResponseInfo[]!</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">SCSIState</span> <span class="o">&amp;</span> <span class="n">MPI_SCSI_STATE_RESPONSE_INFO_VALID</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">ResponseInfo</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;response_info = %08xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">ResponseInfo</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptscsih_io_done - Main SCSI IO callback routine registered to</span>
<span class="cm"> *	Fusion MPT (base) driver</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@mf: Pointer to original MPT request frame</span>
<span class="cm"> *	@r: Pointer to MPT reply frame (NULL if TurboReply)</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine is called from mpt.c::mpt_interrupt() at the completion</span>
<span class="cm"> *	of any SCSI IO request.</span>
<span class="cm"> *	This routine is registered with the Fusion MPT (base) driver at driver</span>
<span class="cm"> *	load/init time via the mpt_register() API call.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 1 indicating alloc&#39;d request frame ptr should be freed.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mptscsih_io_done</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span>	<span class="o">*</span><span class="n">sc</span><span class="p">;</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="n">SCSIIORequest_t</span>	<span class="o">*</span><span class="n">pScsiReq</span><span class="p">;</span>
	<span class="n">SCSIIOReply_t</span>	<span class="o">*</span><span class="n">pScsiReply</span><span class="p">;</span>
	<span class="n">u16</span>		 <span class="n">req_idx</span><span class="p">,</span> <span class="n">req_idx_MR</span><span class="p">;</span>
	<span class="n">VirtDevice</span>	 <span class="o">*</span><span class="n">vdevice</span><span class="p">;</span>
	<span class="n">VirtTarget</span>	 <span class="o">*</span><span class="n">vtarget</span><span class="p">;</span>

	<span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>
	<span class="n">req_idx</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">req_idx</span><span class="p">);</span>
	<span class="n">req_idx_MR</span> <span class="o">=</span> <span class="p">(</span><span class="n">mr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">req_idx</span><span class="p">)</span> <span class="o">:</span> <span class="n">req_idx</span><span class="p">;</span>

	<span class="cm">/* Special case, where already freed message frame is received from</span>
<span class="cm">	 * Firmware. It happens with Resetting IOC.</span>
<span class="cm">	 * Return immediately. Do not care</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">req_idx</span> <span class="o">!=</span> <span class="n">req_idx_MR</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">linkage</span><span class="p">.</span><span class="n">arg1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xdeadbeaf</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sc</span> <span class="o">=</span> <span class="n">mptscsih_getclear_scsi_lookup</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">req_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MPIHeader_t</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPIHeader_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">;</span>

		<span class="cm">/* Remark: writeSDP1 will use the ScsiDoneCtx</span>
<span class="cm">		 * If a SCSI I/O cmd, device disabled by OS and</span>
<span class="cm">		 * completion done. Cannot touch sc struct. Just free mem.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">==</span> <span class="n">MPI_FUNCTION_SCSI_IO_REQUEST</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;NULL ScsiCmd ptr!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">mptscsih_freeChainBuffers</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">req_idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span> <span class="o">!=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mptscsih_freeChainBuffers</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">req_idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">VirtDevice</span> <span class="o">*</span><span class="n">vdevice</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdevice</span> <span class="o">||</span> <span class="o">!</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span> <span class="o">||</span>
		    <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">deleted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>		<span class="cm">/* Set default reply as OK */</span>
	<span class="n">pScsiReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>
	<span class="n">pScsiReply</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIIOReply_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mr</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MsgVersion</span> <span class="o">&gt;=</span> <span class="n">MPI_VERSION_01_05</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pScsiReply</span><span class="p">){</span>
		<span class="n">dmfprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			<span class="s">&quot;ScsiDone (mf=%p,mr=%p,sc=%p,idx=%d,task-tag=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">req_idx</span><span class="p">,</span> <span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">TaskTag</span><span class="p">));</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="n">dmfprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			<span class="s">&quot;ScsiDone (mf=%p,mr=%p,sc=%p,idx=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">req_idx</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pScsiReply</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* special context reply handling */</span>
		<span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span>	 <span class="n">xfer_cnt</span><span class="p">;</span>
		<span class="n">u16</span>	 <span class="n">status</span><span class="p">;</span>
		<span class="n">u8</span>	 <span class="n">scsi_state</span><span class="p">,</span> <span class="n">scsi_status</span><span class="p">;</span>
		<span class="n">u32</span>	 <span class="n">log_info</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_IOCSTATUS_MASK</span><span class="p">;</span>

		<span class="n">scsi_state</span> <span class="o">=</span> <span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">SCSIState</span><span class="p">;</span>
		<span class="n">scsi_status</span> <span class="o">=</span> <span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">SCSIStatus</span><span class="p">;</span>
		<span class="n">xfer_cnt</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">TransferCount</span><span class="p">);</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">-</span> <span class="n">xfer_cnt</span><span class="p">);</span>
		<span class="n">log_info</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 *  if we get a data underrun indication, yet no data was</span>
<span class="cm">		 *  transferred and the SCSI status indicates that the</span>
<span class="cm">		 *  command was never started, change the data underrun</span>
<span class="cm">		 *  to success</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_SCSI_DATA_UNDERRUN</span> <span class="o">&amp;&amp;</span> <span class="n">xfer_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">scsi_status</span> <span class="o">==</span> <span class="n">MPI_SCSI_STATUS_BUSY</span> <span class="o">||</span>
		     <span class="n">scsi_status</span> <span class="o">==</span> <span class="n">MPI_SCSI_STATUS_RESERVATION_CONFLICT</span> <span class="o">||</span>
		     <span class="n">scsi_status</span> <span class="o">==</span> <span class="n">MPI_SCSI_STATUS_TASK_SET_FULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">MPI_IOCSTATUS_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI_SCSI_STATE_AUTOSENSE_VALID</span><span class="p">)</span>
			<span class="n">mptscsih_copy_sense_data</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">hd</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">pScsiReply</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 *  Look for + dump FCP ResponseInfo[]!</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI_SCSI_STATE_RESPONSE_INFO_VALID</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">ResponseInfo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_NOTE_FMT</span> <span class="s">&quot;[%d:%d:%d:%d] &quot;</span>
			<span class="s">&quot;FCP_ResponseInfo=%08xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">ResponseInfo</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">switch</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_BUSY</span>:			<span class="cm">/* 0x0002 */</span>
		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_INSUFFICIENT_RESOURCES</span>:	<span class="cm">/* 0x0006 */</span>
			<span class="cm">/* CHECKME!</span>
<span class="cm">			 * Maybe: DRIVER_BUSY | SUGGEST_RETRY | DID_SOFT_ERROR (retry)</span>
<span class="cm">			 * But not: DID_BUS_BUSY lest one risk</span>
<span class="cm">			 * killing interrupt handler:-(</span>
<span class="cm">			 */</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_BUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_INVALID_BUS</span>:		<span class="cm">/* 0x0041 */</span>
		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_INVALID_TARGETID</span>:	<span class="cm">/* 0x0042 */</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_BAD_TARGET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_DEVICE_NOT_THERE</span>:	<span class="cm">/* 0x0043 */</span>
			<span class="cm">/* Spoof to SCSI Selection Timeout! */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="n">FC</span><span class="p">)</span>
				<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="cm">/* else fibre, just stall until rescan event */</span>
			<span class="k">else</span>
				<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_REQUEUE</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">sel_timeout</span><span class="p">[</span><span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mh">0xFFFF</span><span class="p">)</span>
				<span class="n">hd</span><span class="o">-&gt;</span><span class="n">sel_timeout</span><span class="p">[</span><span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

			<span class="n">vdevice</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdevice</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">vtarget</span> <span class="o">=</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_LED_ON</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mptscsih_issue_sep_command</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">vtarget</span><span class="p">,</span>
				    <span class="n">MPI_SEP_REQ_SLOTSTATUS_UNCONFIGURED</span><span class="p">);</span>
				<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT_TARGET_FLAGS_LED_ON</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_IOC_TERMINATED</span>:		<span class="cm">/* 0x004B */</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">u16</span> <span class="n">ioc_status</span> <span class="o">=</span>
				    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ioc_status</span> <span class="o">&amp;</span>
					<span class="n">MPI_IOCSTATUS_FLAG_LOG_INFO_AVAILABLE</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span>
					<span class="p">((</span><span class="n">log_info</span> <span class="o">&amp;</span> <span class="n">SAS_LOGINFO_MASK</span><span class="p">)</span> <span class="o">==</span>
					<span class="n">SAS_LOGINFO_NEXUS_LOSS</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">VirtDevice</span> <span class="o">*</span><span class="n">vdevice</span> <span class="o">=</span>
						<span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

					    <span class="cm">/* flag the device as being in</span>
<span class="cm">					     * device removal delay so we can</span>
<span class="cm">					     * notify the midlayer to hold off</span>
<span class="cm">					     * on timeout eh */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span> <span class="o">&amp;&amp;</span> <span class="n">vdevice</span><span class="o">-&gt;</span>
							<span class="n">vtarget</span> <span class="o">&amp;&amp;</span>
							<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span>
							<span class="n">raidVolume</span><span class="p">)</span>
							<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
							<span class="s">&quot;Skipping Raid Volume&quot;</span>
							<span class="s">&quot;for inDMD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span> <span class="o">&amp;&amp;</span>
							<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="p">)</span>
							<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span>
								<span class="n">inDMD</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

					    <span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span>
						    <span class="p">(</span><span class="n">DID_TRANSPORT_DISRUPTED</span>
						    <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
					    <span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FC</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * The FC IOC may kill a request for variety of</span>
<span class="cm">				 * reasons, some of which may be recovered by a</span>
<span class="cm">				 * retry, some which are unlikely to be</span>
<span class="cm">				 * recovered. Return DID_ERROR instead of</span>
<span class="cm">				 * DID_RESET to permit retry of the command,</span>
<span class="cm">				 * just not an infinite number of them</span>
<span class="cm">				 */</span>
				<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Allow non-SAS &amp; non-NEXUS_LOSS to drop into below code</span>
<span class="cm">			 */</span>

		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_TASK_TERMINATED</span>:	<span class="cm">/* 0x0048 */</span>
			<span class="cm">/* Linux handles an unsolicited DID_RESET better</span>
<span class="cm">			 * than an unsolicited DID_ABORT.</span>
<span class="cm">			 */</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_EXT_TERMINATED</span>:		<span class="cm">/* 0x004C */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FC</span><span class="p">)</span>
				<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_RESIDUAL_MISMATCH</span>:	<span class="cm">/* 0x0049 */</span>
			<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">-</span> <span class="n">xfer_cnt</span><span class="p">);</span>
			<span class="k">if</span><span class="p">((</span><span class="n">xfer_cnt</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">||</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">underflow</span> <span class="o">&gt;</span> <span class="n">xfer_cnt</span><span class="p">))</span>
				<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span><span class="o">=</span><span class="n">DID_SOFT_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">else</span> <span class="cm">/* Sufficient data transfer occurred */</span>
				<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsi_status</span><span class="p">;</span>
			<span class="n">dreplyprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			    <span class="s">&quot;RESIDUAL_MISMATCH: result=%x on channel=%d id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_DATA_UNDERRUN</span>:		<span class="cm">/* 0x0045 */</span>
			<span class="cm">/*</span>
<span class="cm">			 *  Do upfront check for valid SenseData and give it</span>
<span class="cm">			 *  precedence!</span>
<span class="cm">			 */</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsi_status</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI_SCSI_STATE_AUTOSENSE_VALID</span><span class="p">))</span> <span class="p">{</span>

				<span class="cm">/*</span>
<span class="cm">				 * For an Errata on LSI53C1030</span>
<span class="cm">				 * When the length of request data</span>
<span class="cm">				 * and transfer data are different</span>
<span class="cm">				 * with result of command (READ or VERIFY),</span>
<span class="cm">				 * DID_SOFT_ERROR is set.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SPI</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_6</span>  <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="o">||</span>
					    <span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_10</span> <span class="o">||</span>
					    <span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_12</span> <span class="o">||</span>
						<span class="p">(</span><span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_16</span> <span class="o">&amp;&amp;</span>
						<span class="p">((</span><span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="o">||</span>
					    <span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">VERIFY</span>  <span class="o">||</span>
					    <span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">VERIFY_16</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">!=</span>
							<span class="n">xfer_cnt</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span>
							<span class="n">DID_SOFT_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
						    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Errata&quot;</span>
						    <span class="s">&quot;on LSI53C1030 occurred.&quot;</span>
						    <span class="s">&quot;sc-&gt;req_bufflen=0x%02x,&quot;</span>
						    <span class="s">&quot;xfer_cnt=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						    <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
						    <span class="n">xfer_cnt</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">xfer_cnt</span> <span class="o">&lt;</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">==</span> <span class="n">SAM_STAT_BUSY</span><span class="p">)</span>
						<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">SAM_STAT_BUSY</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_SOFT_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MPI_SCSI_STATE_AUTOSENSE_FAILED</span> <span class="o">|</span> <span class="n">MPI_SCSI_STATE_NO_SCSI_STATUS</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* What to do?</span>
<span class="cm">				 	*/</span>
					<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_SOFT_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI_SCSI_STATE_TERMINATED</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*  Not real sure here either...  */</span>
					<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>


			<span class="n">dreplyprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			    <span class="s">&quot;  sc-&gt;underflow={report ERR if &lt; %02xh bytes xfer&#39;d}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">underflow</span><span class="p">));</span>
			<span class="n">dreplyprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			    <span class="s">&quot;  ActBytesXferd=%02xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">xfer_cnt</span><span class="p">));</span>

			<span class="cm">/* Report Queue Full</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">==</span> <span class="n">MPI_SCSI_STATUS_TASK_SET_FULL</span><span class="p">)</span>
				<span class="n">mptscsih_report_queue_full</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">pScsiReply</span><span class="p">,</span> <span class="n">pScsiReq</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_DATA_OVERRUN</span>:		<span class="cm">/* 0x0044 */</span>
			<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_RECOVERED_ERROR</span>:	<span class="cm">/* 0x0040 */</span>
		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SUCCESS</span>:			<span class="cm">/* 0x0000 */</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">DID_OK</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">scsi_status</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span>
			    <span class="n">MPI_SCSI_STATE_AUTOSENSE_VALID</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/*</span>
<span class="cm">				 * For potential trouble on LSI53C1030.</span>
<span class="cm">				 * (date:2007.xx.)</span>
<span class="cm">				 * It is checked whether the length of</span>
<span class="cm">				 * request data is equal to</span>
<span class="cm">				 * the length of transfer and residual.</span>
<span class="cm">				 * MEDIUM_ERROR is set by incorrect data.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SPI</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">u32</span>	 <span class="n">difftransfer</span><span class="p">;</span>
					<span class="n">difftransfer</span> <span class="o">=</span>
					<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span>
					<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
					<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
					<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span>
						<span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
						<span class="o">!=</span> <span class="n">xfer_cnt</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
						    <span class="n">MEDIUM_ERROR</span><span class="p">;</span>
						<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
						<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;Errata&quot;</span>
						<span class="s">&quot;on LSI53C1030 occurred.&quot;</span>
						<span class="s">&quot;sc-&gt;req_bufflen=0x%02x,&quot;</span>
						<span class="s">&quot;xfer_cnt=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">,</span>
						<span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
						<span class="n">xfer_cnt</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
						<span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">!=</span>
						<span class="n">xfer_cnt</span> <span class="o">+</span> <span class="n">difftransfer</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
							<span class="n">MEDIUM_ERROR</span><span class="p">;</span>
						<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
						<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
						<span class="s">&quot;Errata on LSI53C1030 occurred&quot;</span>
						<span class="s">&quot;sc-&gt;req_bufflen=0x%02x,&quot;</span>
						<span class="s">&quot; xfer_cnt=0x%02x,&quot;</span>
						<span class="s">&quot;difftransfer=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span>
						<span class="n">xfer_cnt</span><span class="p">,</span>
						<span class="n">difftransfer</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="cm">/*</span>
<span class="cm">				 * If running against circa 200003dd 909 MPT f/w,</span>
<span class="cm">				 * may get this (AUTOSENSE_VALID) for actual TASK_SET_FULL</span>
<span class="cm">				 * (QUEUE_FULL) returned from device! --&gt; get 0x0000?128</span>
<span class="cm">				 * and with SenseBytes set to 0.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">SCSIStatus</span> <span class="o">==</span> <span class="n">MPI_SCSI_STATUS_TASK_SET_FULL</span><span class="p">)</span>
					<span class="n">mptscsih_report_queue_full</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">pScsiReply</span><span class="p">,</span> <span class="n">pScsiReq</span><span class="p">);</span>

			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span>
			         <span class="p">(</span><span class="n">MPI_SCSI_STATE_AUTOSENSE_FAILED</span> <span class="o">|</span> <span class="n">MPI_SCSI_STATE_NO_SCSI_STATUS</span><span class="p">)</span>
			   <span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * What to do?</span>
<span class="cm">				 */</span>
				<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_SOFT_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI_SCSI_STATE_TERMINATED</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*  Not real sure here either...  */</span>
				<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_state</span> <span class="o">&amp;</span> <span class="n">MPI_SCSI_STATE_QUEUE_TAG_REJECTED</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Device Inq. data indicates that it supports</span>
<span class="cm">				 * QTags, but rejects QTag messages.</span>
<span class="cm">				 * This command completed OK.</span>
<span class="cm">				 *</span>
<span class="cm">				 * Not real sure here either so do nothing...  */</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">==</span> <span class="n">MPI_SCSI_STATUS_TASK_SET_FULL</span><span class="p">)</span>
				<span class="n">mptscsih_report_queue_full</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">pScsiReply</span><span class="p">,</span> <span class="n">pScsiReq</span><span class="p">);</span>

			<span class="cm">/* Add handling of:</span>
<span class="cm">			 * Reservation Conflict, Busy,</span>
<span class="cm">			 * Command Terminated, CHECK</span>
<span class="cm">			 */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_PROTOCOL_ERROR</span>:		<span class="cm">/* 0x0047 */</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_SOFT_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_INVALID_FUNCTION</span>:		<span class="cm">/* 0x0001 */</span>
		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_INVALID_SGL</span>:			<span class="cm">/* 0x0003 */</span>
		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_INTERNAL_ERROR</span>:		<span class="cm">/* 0x0004 */</span>
		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_RESERVED</span>:			<span class="cm">/* 0x0005 */</span>
		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_INVALID_FIELD</span>:		<span class="cm">/* 0x0007 */</span>
		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_INVALID_STATE</span>:		<span class="cm">/* 0x0008 */</span>
		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_IO_DATA_ERROR</span>:		<span class="cm">/* 0x0046 */</span>
		<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_TASK_MGMT_FAILED</span>:	<span class="cm">/* 0x004A */</span>
		<span class="nl">default:</span>
			<span class="cm">/*</span>
<span class="cm">			 * What to do?</span>
<span class="cm">			 */</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_SOFT_ERROR</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>	<span class="cm">/* switch(status) */</span>

<span class="cp">#ifdef CONFIG_FUSION_LOGGING</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">debug_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_REPLY</span><span class="p">))</span>
			<span class="n">mptscsih_info_scsiio</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">pScsiReply</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="p">}</span> <span class="cm">/* end of address reply case */</span>
<span class="nl">out:</span>
	<span class="cm">/* Unmap the DMA buffers, if any. */</span>
	<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>		<span class="cm">/* Issue the command callback */</span>

	<span class="cm">/* Free Chain buffers */</span>
	<span class="n">mptscsih_freeChainBuffers</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">req_idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	mptscsih_flush_running_cmds - For each command found, search</span>
<span class="cm"> *		Scsi_Host instance taskQ and reply to OS.</span>
<span class="cm"> *		Called only if recovering from a FW reload.</span>
<span class="cm"> *	@hd: Pointer to a SCSI HOST structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns: None.</span>
<span class="cm"> *</span>
<span class="cm"> *	Must be called while new I/Os are being queued.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mptscsih_flush_running_cmds</span><span class="p">(</span><span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>
	<span class="n">SCSIIORequest_t</span>	<span class="o">*</span><span class="n">mf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">ii</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sc</span> <span class="o">=</span> <span class="n">mptscsih_getclear_scsi_lookup</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">mf</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="p">)</span><span class="n">MPT_INDEX_2_MFPTR</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mf</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">;</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">;</span>
		<span class="n">mptscsih_freeChainBuffers</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
		<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="p">(</span><span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span> <span class="o">!=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span>
		    <span class="s">&quot;completing cmds: fw_channel %d, fw_id %d, sc=%p, mf = %p, &quot;</span>
		    <span class="s">&quot;idx=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">ii</span><span class="p">));</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_flush_running_cmds</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	mptscsih_search_running_cmds - Delete any commands associated</span>
<span class="cm"> *		with the specified target and lun. Function called only</span>
<span class="cm"> *		when a lun is disable by mid-layer.</span>
<span class="cm"> *		Do NOT access the referenced scsi_cmnd structure or</span>
<span class="cm"> *		members. Will cause either a paging or NULL ptr error.</span>
<span class="cm"> *		(BUT, BUT, BUT, the code does reference it! - mdr)</span>
<span class="cm"> *      @hd: Pointer to a SCSI HOST structure</span>
<span class="cm"> *	@vdevice: per device private data</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns: None.</span>
<span class="cm"> *</span>
<span class="cm"> *	Called from slave_destroy.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptscsih_search_running_cmds</span><span class="p">(</span><span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="n">VirtDevice</span> <span class="o">*</span><span class="n">vdevice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SCSIIORequest_t</span>	<span class="o">*</span><span class="n">mf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">ii</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_lun</span>  <span class="n">lun</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sc</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">mf</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="p">)</span><span class="n">MPT_INDEX_2_MFPTR</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* If the device is a hidden raid component, then its</span>
<span class="cm">			 * expected that the mf-&gt;function will be RAID_SCSI_IO</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span>
			    <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span> <span class="o">&amp;&amp;</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">!=</span>
			    <span class="n">MPI_FUNCTION_RAID_SCSI_IO_PASSTHROUGH</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lun</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">!=</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">!=</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">memcmp</span><span class="p">(</span><span class="n">lun</span><span class="p">.</span><span class="n">scsi_lun</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span> <span class="o">!=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">host_scribble</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">mptscsih_freeChainBuffers</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
			<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="p">(</span><span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">);</span>
			<span class="n">scsi_dma_unmap</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			   <span class="n">MYIOC_s_FMT</span> <span class="s">&quot;completing cmds: fw_channel %d, &quot;</span>
			   <span class="s">&quot;fw_id %d, sc=%p, mf = %p, idx=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			   <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			   <span class="n">sc</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">ii</span><span class="p">));</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptscsih_report_queue_full - Report QUEUE_FULL status returned</span>
<span class="cm"> *	from a SCSI target device.</span>
<span class="cm"> *	@sc: Pointer to scsi_cmnd structure</span>
<span class="cm"> *	@pScsiReply: Pointer to SCSIIOReply_t</span>
<span class="cm"> *	@pScsiReq: Pointer to original SCSI request</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine periodically reports QUEUE_FULL status returned from a</span>
<span class="cm"> *	SCSI target device.  It reports this to the console via kernel</span>
<span class="cm"> *	printk() API call, not more than once every 10 seconds.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptscsih_report_queue_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">SCSIIOReply_t</span> <span class="o">*</span><span class="n">pScsiReply</span><span class="p">,</span> <span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="n">pScsiReq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">MPT_SCSI_HOST</span>		<span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">last_queue_full</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;Device (%d:%d:%d) reported QUEUE_FULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>
		<span class="n">hd</span><span class="o">-&gt;</span><span class="n">last_queue_full</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptscsih_remove - Removed scsi devices</span>
<span class="cm"> *	@pdev: Pointer to pci_dev structure</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mptscsih_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> 		<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> 	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">;</span>
	<span class="n">MPT_SCSI_HOST</span>		<span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sz1</span><span class="p">;</span>

	<span class="n">scsi_remove_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span><span class="p">((</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mptscsih_shutdown</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">sz1</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sz1</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;Free&#39;d ScsiLookup (%d) memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sz1</span><span class="p">));</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">info_kbuf</span><span class="p">);</span>

	<span class="cm">/* NULL the Scsi_Host pointer</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">scsi_host_put</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">mpt_detach</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptscsih_shutdown - reboot notifier</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mptscsih_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptscsih_suspend - Fusion MPT scsi driver suspend routine.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mptscsih_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> 		<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">scsi_block_requests</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>
	<span class="n">flush_scheduled_work</span><span class="p">();</span>
	<span class="n">mptscsih_shutdown</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mpt_suspend</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptscsih_resume - Fusion MPT scsi driver resume routine.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mptscsih_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> 		<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_resume</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">scsi_unblock_requests</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptscsih_info - Return information about MPT adapter</span>
<span class="cm"> *	@SChost: Pointer to Scsi_Host structure</span>
<span class="cm"> *</span>
<span class="cm"> *	(linux scsi_host_template.info routine)</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns pointer to buffer where information was written.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">mptscsih_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">SChost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">h</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">SChost</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">info_kbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">info_kbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mh">0x1000</span> <span class="cm">/* 4Kb */</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">info_kbuf</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">info_kbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

		<span class="n">mpt_print_ioc_summary</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">info_kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">info_kbuf</span><span class="p">[</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">info_kbuf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">info_str</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span>   <span class="n">length</span><span class="p">;</span>
	<span class="kt">int</span>   <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span>   <span class="n">pos</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptscsih_copy_mem_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">info_str</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
	        <span class="n">data</span> <span class="o">+=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">);</span>
	        <span class="n">len</span>  <span class="o">-=</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
                <span class="n">info</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptscsih_copy_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">info_str</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">81</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">vsprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="n">mptscsih_copy_mem_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptscsih_host_info</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">info_str</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">info</span><span class="p">.</span><span class="n">buffer</span>	<span class="o">=</span> <span class="n">pbuf</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">pos</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mptscsih_copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;%s: %s, &quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">prod_name</span><span class="p">);</span>
	<span class="n">mptscsih_copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;%s%08xh, &quot;</span><span class="p">,</span> <span class="n">MPT_FW_REV_MAGIC_ID_STRING</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span><span class="p">);</span>
	<span class="n">mptscsih_copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;Ports=%d, &quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">);</span>
	<span class="n">mptscsih_copy_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;MaxQ=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">info</span><span class="p">.</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="n">info</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">?</span> <span class="n">info</span><span class="p">.</span><span class="n">pos</span> <span class="o">-</span> <span class="n">info</span><span class="p">.</span><span class="n">offset</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptscsih_proc_info - Return information about MPT adapter</span>
<span class="cm"> * 	@host:   scsi host struct</span>
<span class="cm"> * 	@buffer: if write, user data; if read, buffer for user</span>
<span class="cm"> *	@start: returns the buffer address</span>
<span class="cm"> * 	@offset: if write, 0; if read, the current offset into the buffer from</span>
<span class="cm"> * 		 the previous read.</span>
<span class="cm"> * 	@length: if write, return length;</span>
<span class="cm"> *	@func:   write = 1; read = 0</span>
<span class="cm"> *</span>
<span class="cm"> *	(linux scsi_host_template.info routine)</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mptscsih_proc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * write is not supported</span>
<span class="cm">		 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="p">)</span>
			<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">mptscsih_host_info</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cp">#define ADD_INDEX_LOG(req_ent)	do { } while(0)</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptscsih_qcmd - Primary Fusion MPT SCSI initiator IO start routine.</span>
<span class="cm"> *	@SCpnt: Pointer to scsi_cmnd structure</span>
<span class="cm"> *	@done: Pointer SCSI mid-layer IO completion function</span>
<span class="cm"> *</span>
<span class="cm"> *	(linux scsi_host_template.queuecommand routine)</span>
<span class="cm"> *	This is the primary SCSI IO start routine.  Create a MPI SCSIIORequest</span>
<span class="cm"> *	from a linux scsi_cmnd request and send it to the IOC.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0. (rtn value discarded by linux scsi mid-layer)</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mptscsih_qcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span>		<span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="n">MPT_FRAME_HDR</span>		<span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">SCSIIORequest_t</span>		<span class="o">*</span><span class="n">pScsiReq</span><span class="p">;</span>
	<span class="n">VirtDevice</span>		<span class="o">*</span><span class="n">vdevice</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">u32</span>	 <span class="n">datalen</span><span class="p">;</span>
	<span class="n">u32</span>	 <span class="n">scsictl</span><span class="p">;</span>
	<span class="n">u32</span>	 <span class="n">scsidir</span><span class="p">;</span>
	<span class="n">u32</span>	 <span class="n">cmd_len</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">my_idx</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">ii</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>

	<span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">dmfprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;qcmd: SCpnt=%p, done()=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">,</span> <span class="n">done</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_quiesce_io</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Put together a MPT SCSI request...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">DoneCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;QueueCmd, no msg frames!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pScsiReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>

	<span class="n">my_idx</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">req_idx</span><span class="p">);</span>

	<span class="n">ADD_INDEX_LOG</span><span class="p">(</span><span class="n">my_idx</span><span class="p">);</span>

	<span class="cm">/*    TUR&#39;s being issued with scsictl=0x02000000 (DATA_IN)!</span>
<span class="cm">	 *    Seems we may receive a buffer (datalen&gt;0) even when there</span>
<span class="cm">	 *    will be no data transfer!  GRRRRR...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">datalen</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
		<span class="n">scsidir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_READ</span><span class="p">;</span>	<span class="cm">/* DATA IN  (host&lt;--ioc&lt;--dev) */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">datalen</span> <span class="o">=</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
		<span class="n">scsidir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_WRITE</span><span class="p">;</span>	<span class="cm">/* DATA OUT (host--&gt;ioc--&gt;dev) */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">datalen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scsidir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_NODATATRANSFER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Default to untagged. Once a target structure has been allocated,</span>
<span class="cm">	 * use the Inquiry data to determine if device supports tagged.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_Q_YES</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scsictl</span> <span class="o">=</span> <span class="n">scsidir</span> <span class="o">|</span> <span class="n">MPI_SCSIIO_CONTROL_SIMPLEQ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">&amp;&amp;</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ioprio</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ioprio</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
				<span class="o">!</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">ioprio</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">))</span>
				<span class="n">scsictl</span> <span class="o">|=</span> <span class="n">MPI_SCSIIO_CONTROL_HEADOFQ</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">scsictl</span> <span class="o">=</span> <span class="n">scsidir</span> <span class="o">|</span> <span class="n">MPI_SCSIIO_CONTROL_UNTAGGED</span><span class="p">;</span>


	<span class="cm">/* Use the above information to set up the message frame</span>
<span class="cm">	 */</span>
	<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">=</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span>  <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">)</span>
		<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_RAID_SCSI_IO_PASSTHROUGH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_SCSI_IO_REQUEST</span><span class="p">;</span>
	<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">CDBLength</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
	<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">SenseBufferLength</span> <span class="o">=</span> <span class="n">MPT_SENSE_BUFFER_SIZE</span><span class="p">;</span>
	<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">=</span> <span class="n">mpt_msg_flags</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">);</span>
	<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Control</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scsictl</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Write SCSI CDB into the message</span>
<span class="cm">	 */</span>
	<span class="n">cmd_len</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">cmd_len</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="n">cmd_len</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* DataLength */</span>
	<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">datalen</span><span class="p">);</span>

	<span class="cm">/* SenseBuffer low address */</span>
	<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">SenseBufferLowAddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_low_dma</span>
					   <span class="o">+</span> <span class="p">(</span><span class="n">my_idx</span> <span class="o">*</span> <span class="n">MPT_SENSE_BUFFER_ALLOC</span><span class="p">));</span>

	<span class="cm">/* Now add the SG list</span>
<span class="cm">	 * Always have a SGE even if null length.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">datalen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Add a NULL SGE */</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">SGL</span><span class="p">,</span>
			<span class="n">MPT_SGE_FLAGS_SSIMPLE_READ</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Add a 32 or 64 bit SGE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mptscsih_AddSGE</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">,</span> <span class="n">pScsiReq</span><span class="p">,</span> <span class="n">my_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">host_scribble</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">mptscsih_set_scsi_lookup</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">my_idx</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>

	<span class="n">mpt_put_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">DoneCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
	<span class="n">dmfprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Issued SCSI cmd (%p) mf=%p idx=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">my_idx</span><span class="p">));</span>
	<span class="n">DBG_DUMP_REQUEST_FRAME</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">mptscsih_freeChainBuffers</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">my_idx</span><span class="p">);</span>
	<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptscsih_freeChainBuffers - Function to free chain buffers associated</span>
<span class="cm"> *	with a SCSI IO request</span>
<span class="cm"> *	@hd: Pointer to the MPT_SCSI_HOST instance</span>
<span class="cm"> *	@req_idx: Index of the SCSI IO request frame.</span>
<span class="cm"> *</span>
<span class="cm"> *	Called if SG chain buffer allocation fails and mptscsih callbacks.</span>
<span class="cm"> *	No return.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptscsih_freeChainBuffers</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">chain</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chain_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">next</span><span class="p">;</span>

	<span class="cm">/* Get the first chain index and reset</span>
<span class="cm">	 * tracker state.</span>
<span class="cm">	 */</span>
	<span class="n">chain_idx</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ReqToChain</span><span class="p">[</span><span class="n">req_idx</span><span class="p">];</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ReqToChain</span><span class="p">[</span><span class="n">req_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPT_HOST_NO_CHAIN</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">chain_idx</span> <span class="o">!=</span> <span class="n">MPT_HOST_NO_CHAIN</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Save the next chain buffer index */</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainToChain</span><span class="p">[</span><span class="n">chain_idx</span><span class="p">];</span>

		<span class="cm">/* Free this chain buffer and reset</span>
<span class="cm">		 * tracker</span>
<span class="cm">		 */</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainToChain</span><span class="p">[</span><span class="n">chain_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPT_HOST_NO_CHAIN</span><span class="p">;</span>

		<span class="n">chain</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainBuffer</span>
					<span class="o">+</span> <span class="p">(</span><span class="n">chain_idx</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">));</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">linkage</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeChainQ</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">dmfprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;FreeChainBuffers (index %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chain_idx</span><span class="p">));</span>

		<span class="cm">/* handle next */</span>
		<span class="n">chain_idx</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	Reset Handling</span>
<span class="cm"> */</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptscsih_IssueTaskMgmt - Generic send Task Management function.</span>
<span class="cm"> *	@hd: Pointer to MPT_SCSI_HOST structure</span>
<span class="cm"> *	@type: Task Management type</span>
<span class="cm"> *	@channel: channel number for task management</span>
<span class="cm"> *	@id: Logical Target ID for reset (if appropriate)</span>
<span class="cm"> *	@lun: Logical Unit for reset (if appropriate)</span>
<span class="cm"> *	@ctx2abort: Context for the task to be aborted (if appropriate)</span>
<span class="cm"> *	@timeout: timeout for task management control</span>
<span class="cm"> *</span>
<span class="cm"> *	Remark: _HardResetHandler can be invoked from an interrupt thread (timer)</span>
<span class="cm"> *	or a non-interrupt thread.  In the former, must not call schedule().</span>
<span class="cm"> *</span>
<span class="cm"> *	Not all fields are meaningfull for all task types.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for SUCCESS, or FAILED.</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">mptscsih_IssueTaskMgmt</span><span class="p">(</span><span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">ctx2abort</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_FRAME_HDR</span>	<span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">SCSITaskMgmt_t</span>	<span class="o">*</span><span class="n">pScsiTm</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">ii</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">retval</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> 	<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">timeleft</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">issue_hard_reset</span><span class="p">;</span>
	<span class="n">u32</span>		 <span class="n">ioc_raw_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">time_count</span><span class="p">;</span>

	<span class="n">issue_hard_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc_raw_state</span> <span class="o">=</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ioc_raw_state</span> <span class="o">&amp;</span> <span class="n">MPI_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MPI_IOC_STATE_OPERATIONAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			<span class="s">&quot;TaskMgmt type=%x: IOC Not operational (0x%x)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">ioc_raw_state</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;Issuing HardReset from %s!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpt_HardResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;TaskMgmt HardReset &quot;</span>
			    <span class="s">&quot;FAILED!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* DOORBELL ACTIVE check is not required if</span>
<span class="cm">	*  MPI_IOCFACTS_CAPABILITY_HIGH_PRI_Q is supported.</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span> <span class="n">MPI_IOCFACTS_CAPABILITY_HIGH_PRI_Q</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MsgVersion</span> <span class="o">&gt;=</span> <span class="n">MPI_VERSION_01_05</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ioc_raw_state</span> <span class="o">&amp;</span> <span class="n">MPI_DOORBELL_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			<span class="s">&quot;TaskMgmt type=%x: ioc_state: &quot;</span>
			<span class="s">&quot;DOORBELL_ACTIVE (0x%x)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">ioc_raw_state</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_set_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Return Fail to calling function if no message frames available.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">TaskCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			<span class="s">&quot;TaskMgmt no msg frames!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="n">mpt_clear_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;TaskMgmt request (mf=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mf</span><span class="p">));</span>

	<span class="cm">/* Format the Request</span>
<span class="cm">	 */</span>
	<span class="n">pScsiTm</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSITaskMgmt_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_SCSI_TASK_MGMT</span><span class="p">;</span>

	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">TaskType</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Reserved1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS</span><span class="p">)</span>
                    <span class="o">?</span> <span class="n">MPI_SCSITASKMGMT_MSGFLAGS_LIPRESET_RESET_OPTION</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Reserved2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">TaskMsgContext</span> <span class="o">=</span> <span class="n">ctx2abort</span><span class="p">;</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;TaskMgmt: ctx2abort (0x%08x) &quot;</span>
		<span class="s">&quot;task_type = 0x%02X, timeout = %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ctx2abort</span><span class="p">,</span>
		<span class="n">type</span><span class="p">,</span> <span class="n">timeout</span><span class="p">));</span>

	<span class="n">DBG_DUMP_TM_REQUEST_FRAME</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">pScsiTm</span><span class="p">);</span>

	<span class="n">INITIALIZE_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">time_count</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span> <span class="n">MPI_IOCFACTS_CAPABILITY_HIGH_PRI_Q</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MsgVersion</span> <span class="o">&gt;=</span> <span class="n">MPI_VERSION_01_05</span><span class="p">))</span>
		<span class="n">mpt_put_msg_frame_hi_pri</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">TaskCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">mpt_send_handshake_request</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">TaskCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">SCSITaskMgmt_t</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">pScsiTm</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
				<span class="s">&quot;TaskMgmt handshake FAILED!(mf=%p, rc=%d) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">retval</span><span class="p">));</span>
			<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
			<span class="n">mpt_clear_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span>
		<span class="n">timeout</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
		    <span class="s">&quot;TaskMgmt TIMED OUT!(mf=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mf</span><span class="p">));</span>
		<span class="n">mpt_clear_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">issue_hard_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">mptscsih_taskmgmt_reply</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">SCSITaskMgmtReply_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;TaskMgmt completed (%d seconds)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">time_count</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">));</span>

 <span class="nl">out:</span>

	<span class="n">CLEAR_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">issue_hard_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
		       <span class="s">&quot;Issuing Reset from %s!! doorbell=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">mpt_HardResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="o">:</span>
			<span class="n">mpt_Soft_Hard_ResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
		<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_IssueTaskMgmt</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptscsih_get_tm_timeout</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FC</span>:
		<span class="k">return</span> <span class="mi">40</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAS</span>:
		<span class="k">return</span> <span class="mi">30</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPI</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptscsih_abort - Abort linux scsi_cmnd routine, new_eh variant</span>
<span class="cm"> *	@SCpnt: Pointer to scsi_cmnd structure, IO to be aborted</span>
<span class="cm"> *</span>
<span class="cm"> *	(linux scsi_host_template.eh_abort_handler routine)</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns SUCCESS or FAILED.</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">mptscsih_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="n">MPT_FRAME_HDR</span>	<span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">u32</span>		 <span class="n">ctx2abort</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">scpnt_idx</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">retval</span><span class="p">;</span>
	<span class="n">VirtDevice</span>	 <span class="o">*</span><span class="n">vdevice</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>

	<span class="cm">/* If we can&#39;t locate our host adapter structure, return FAILED status.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;: task abort: &quot;</span>
		    <span class="s">&quot;can&#39;t locate host! (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;attempting task abort! (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>
	<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>

	<span class="n">vdevice</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdevice</span> <span class="o">||</span> <span class="o">!</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;task abort: device has been deleted (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">));</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">scsi_done</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Task aborts are not supported for hidden raid components.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;task abort: hidden raid component (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">));</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Task aborts are not supported for volumes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">raidVolume</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;task abort: raid volume (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">));</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find this command</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scpnt_idx</span> <span class="o">=</span> <span class="n">SCPNT_TO_LOOKUP_IDX</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Cmd not found in ScsiLookup.</span>
<span class="cm">		 * Do OS callback.</span>
<span class="cm">		 */</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_RESET</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;task abort: &quot;</span>
		   <span class="s">&quot;Command not in the active list! (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		   <span class="n">SCpnt</span><span class="p">));</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">timeouts</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">timeouts</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_fwfault_debug</span><span class="p">)</span>
		<span class="n">mpt_halt_firmware</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="cm">/* Most important!  Set TaskMsgContext to SCpnt&#39;s MsgContext!</span>
<span class="cm">	 * (the IO to be ABORT&#39;d)</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE: Since we do not byteswap MsgContext, we do not</span>
<span class="cm">	 *	 swap it here either.  It is an opaque cookie to</span>
<span class="cm">	 *	 the controller, so it does not matter. -DaveM</span>
<span class="cm">	 */</span>
	<span class="n">mf</span> <span class="o">=</span> <span class="n">MPT_INDEX_2_MFPTR</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">scpnt_idx</span><span class="p">);</span>
	<span class="n">ctx2abort</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">MsgContext</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">mptscsih_IssueTaskMgmt</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span>
			 <span class="n">MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK</span><span class="p">,</span>
			 <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
			 <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span>
			 <span class="n">ctx2abort</span><span class="p">,</span> <span class="n">mptscsih_get_tm_timeout</span><span class="p">(</span><span class="n">ioc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SCPNT_TO_LOOKUP_IDX</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">)</span> <span class="o">==</span> <span class="n">scpnt_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;task abort: command still in active list! (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">));</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;task abort: command cleared from active list! (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">));</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;task abort: %s (rv=%04x) (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">((</span><span class="n">retval</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;SUCCESS&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span><span class="p">),</span> <span class="n">retval</span><span class="p">,</span>
	    <span class="n">SCpnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptscsih_dev_reset - Perform a SCSI TARGET_RESET!  new_eh variant</span>
<span class="cm"> *	@SCpnt: Pointer to scsi_cmnd structure, IO which reset is due to</span>
<span class="cm"> *</span>
<span class="cm"> *	(linux scsi_host_template.eh_dev_reset_handler routine)</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns SUCCESS or FAILED.</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">mptscsih_dev_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">retval</span><span class="p">;</span>
	<span class="n">VirtDevice</span>	 <span class="o">*</span><span class="n">vdevice</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>

	<span class="cm">/* If we can&#39;t locate our host adapter structure, return FAILED status.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;: target reset: &quot;</span>
		   <span class="s">&quot;Can&#39;t locate host! (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;attempting target reset! (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>
	<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>

	<span class="n">vdevice</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdevice</span> <span class="o">||</span> <span class="o">!</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Target reset to hidden raid component is not supported</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">mptscsih_IssueTaskMgmt</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span>
				<span class="n">MPI_SCSITASKMGMT_TASKTYPE_TARGET_RESET</span><span class="p">,</span>
				<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">mptscsih_get_tm_timeout</span><span class="p">(</span><span class="n">ioc</span><span class="p">));</span>

 <span class="nl">out:</span>
	<span class="n">printk</span> <span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;target reset: %s (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">((</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;SUCCESS&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span> <span class="p">),</span> <span class="n">SCpnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptscsih_bus_reset - Perform a SCSI BUS_RESET!	new_eh variant</span>
<span class="cm"> *	@SCpnt: Pointer to scsi_cmnd structure, IO which reset is due to</span>
<span class="cm"> *</span>
<span class="cm"> *	(linux scsi_host_template.eh_bus_reset_handler routine)</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns SUCCESS or FAILED.</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">mptscsih_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span> <span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">retval</span><span class="p">;</span>
	<span class="n">VirtDevice</span>	 <span class="o">*</span><span class="n">vdevice</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>

	<span class="cm">/* If we can&#39;t locate our host adapter structure, return FAILED status.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;: bus reset: &quot;</span>
		   <span class="s">&quot;Can&#39;t locate host! (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;attempting bus reset! (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>
	<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">timeouts</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">timeouts</span><span class="o">++</span><span class="p">;</span>

	<span class="n">vdevice</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdevice</span> <span class="o">||</span> <span class="o">!</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">mptscsih_IssueTaskMgmt</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span>
					<span class="n">MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS</span><span class="p">,</span>
					<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">mptscsih_get_tm_timeout</span><span class="p">(</span><span class="n">ioc</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;bus reset: %s (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">((</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;SUCCESS&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span> <span class="p">),</span> <span class="n">SCpnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptscsih_host_reset - Perform a SCSI host adapter RESET (new_eh variant)</span>
<span class="cm"> *	@SCpnt: Pointer to scsi_cmnd structure, IO which reset is due to</span>
<span class="cm"> *</span>
<span class="cm"> *	(linux scsi_host_template.eh_host_reset_handler routine)</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns SUCCESS or FAILED.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mptscsih_host_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span> <span class="o">*</span>  <span class="n">hd</span><span class="p">;</span>
	<span class="kt">int</span>              <span class="n">status</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">retval</span><span class="p">;</span>

	<span class="cm">/*  If we can&#39;t locate the host to reset, then we failed. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;: host reset: &quot;</span>
		    <span class="s">&quot;Can&#39;t locate host! (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make sure we have no outstanding commands at this stage */</span>
	<span class="n">mptscsih_flush_running_cmds</span><span class="p">(</span><span class="n">hd</span><span class="p">);</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;attempting host reset! (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">SCpnt</span><span class="p">);</span>

	<span class="cm">/*  If our attempts to reset the host failed, then return a failed</span>
<span class="cm">	 *  status.  The host will be taken off line by the SCSI mid-layer.</span>
<span class="cm">	 */</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="n">mpt_Soft_Hard_ResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;host reset: %s (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">((</span><span class="n">retval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;SUCCESS&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span> <span class="p">),</span> <span class="n">SCpnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptscsih_taskmgmt_reply</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span>
	<span class="n">SCSITaskMgmtReply_t</span> <span class="o">*</span><span class="n">pScsiTmReply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>			 <span class="n">iocstatus</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">termination_count</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG_DUMP_TM_REPLY_FRAME</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">pScsiTmReply</span><span class="p">);</span>

	<span class="n">iocstatus</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="n">termination_count</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">TerminationCount</span><span class="p">);</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;TaskMgmt fw_channel = %d, fw_id = %d, task_type = 0x%02X,</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;</span><span class="se">\t</span><span class="s">iocstatus = 0x%04X, loginfo = 0x%08X, response_code = 0x%02X,</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;</span><span class="se">\t</span><span class="s">term_cmnds = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">,</span>
	    <span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">),</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">),</span> <span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">ResponseCode</span><span class="p">,</span>
	    <span class="n">termination_count</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MsgVersion</span> <span class="o">&gt;=</span> <span class="n">MPI_VERSION_01_05</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">ResponseCode</span><span class="p">)</span>
		<span class="n">mptscsih_taskmgmt_response_code</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">ResponseCode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iocstatus</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">MPI_SCSITASKMGMT_TASKTYPE_ABORT_TASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">termination_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iocstatus</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_SCSI_TASK_TERMINATED</span> <span class="o">||</span>
	   <span class="n">iocstatus</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_SCSI_IOC_TERMINATED</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="kt">void</span>
<span class="nf">mptscsih_taskmgmt_response_code</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">response_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">response_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_SCSITASKMGMT_RSP_TM_COMPLETE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;The task completed.&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSITASKMGMT_RSP_INVALID_FRAME</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;The IOC received an invalid frame status.&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSITASKMGMT_RSP_TM_NOT_SUPPORTED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;The task type is not supported.&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSITASKMGMT_RSP_TM_FAILED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;The requested task failed.&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSITASKMGMT_RSP_TM_SUCCEEDED</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;The task completed successfully.&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSITASKMGMT_RSP_TM_INVALID_LUN</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;The LUN request is invalid.&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SCSITASKMGMT_RSP_IO_QUEUED_ON_IOC</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;The task is in the IOC queue and has not been sent to target.&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;Response Code(0x%08x): F/W: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">response_code</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_taskmgmt_response_code</span><span class="p">);</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptscsih_taskmgmt_complete - Registered with Fusion MPT base driver</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@mf: Pointer to SCSI task mgmt request frame</span>
<span class="cm"> *	@mr: Pointer to SCSI task mgmt reply frame</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine is called from mptbase.c::mpt_interrupt() at the completion</span>
<span class="cm"> *	of any SCSI task management request.</span>
<span class="cm"> *	This routine is registered with the MPT (base) driver at driver</span>
<span class="cm"> *	load/init time via the mpt_register() API call.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 1 indicating alloc&#39;d request frame ptr should be freed.</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">mptscsih_taskmgmt_complete</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">,</span>
	<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		<span class="s">&quot;TaskMgmt completed (mf=%p, mr=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mr</span><span class="p">));</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span>
	    <span class="n">min</span><span class="p">(</span><span class="n">MPT_DEFAULT_FRAME_SIZE</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">reply</span><span class="p">.</span><span class="n">MsgLength</span><span class="p">));</span>
 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpt_clear_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">;</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">schedule_target_reset</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	This is anyones guess quite frankly.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mptscsih_bios_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span> <span class="n">sdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">block_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
		<span class="n">sector_t</span> <span class="n">capacity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">geom</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">heads</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">sectors</span><span class="p">;</span>
	<span class="n">sector_t</span>	<span class="n">cylinders</span><span class="p">;</span>
	<span class="n">ulong</span> 		<span class="n">dummy</span><span class="p">;</span>

	<span class="n">heads</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">sectors</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">dummy</span> <span class="o">=</span> <span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">cylinders</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">;</span>
	<span class="n">sector_div</span><span class="p">(</span><span class="n">cylinders</span><span class="p">,</span><span class="n">dummy</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle extended translation size for logical drives</span>
<span class="cm">	 * &gt; 1Gb</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">capacity</span> <span class="o">&gt;=</span> <span class="mh">0x200000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">heads</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">sectors</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">dummy</span> <span class="o">=</span> <span class="n">heads</span> <span class="o">*</span> <span class="n">sectors</span><span class="p">;</span>
		<span class="n">cylinders</span> <span class="o">=</span> <span class="n">capacity</span><span class="p">;</span>
		<span class="n">sector_div</span><span class="p">(</span><span class="n">cylinders</span><span class="p">,</span><span class="n">dummy</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* return result */</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">heads</span><span class="p">;</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">geom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cylinders</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Search IOC page 3 to determine if this is hidden physical disk</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mptscsih_is_phys_disk</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inactive_raid_component_info</span> <span class="o">*</span><span class="n">component_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">RaidPhysDiskPage1_t</span> <span class="o">*</span><span class="n">phys_disk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_paths</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="o">-&gt;</span><span class="n">NumPhysDisks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">==</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="o">-&gt;</span><span class="n">PhysDisk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="o">-&gt;</span><span class="n">PhysDisk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskBus</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="n">SAS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if dual path</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="o">-&gt;</span><span class="n">NumPhysDisks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_paths</span> <span class="o">=</span> <span class="n">mpt_raid_phys_disk_get_num_paths</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="o">-&gt;</span><span class="n">PhysDisk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskNum</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_paths</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">phys_disk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="n">RaidPhysDiskPage1_t</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span> <span class="o">+</span>
		   <span class="p">(</span><span class="n">num_paths</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RAID_PHYS_DISK1_PATH</span><span class="p">)),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phys_disk</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mpt_raid_phys_disk_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="o">-&gt;</span><span class="n">PhysDisk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskNum</span><span class="p">,</span>
		    <span class="n">phys_disk</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">phys_disk</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">num_paths</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Flags</span> <span class="o">&amp;</span>
			    <span class="n">MPI_RAID_PHYSDISK1_FLAG_INVALID</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Flags</span> <span class="o">&amp;</span>
			    <span class="n">MPI_RAID_PHYSDISK1_FLAG_BROKEN</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">==</span> <span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">PhysDiskID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">PhysDiskBus</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">phys_disk</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">phys_disk</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Check inactive list for matching phys disks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">component_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">,</span>
	    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">component_info</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">PhysDiskID</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">component_info</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">PhysDiskBus</span> <span class="o">==</span> <span class="n">channel</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list_mutex</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_is_phys_disk</span><span class="p">);</span>

<span class="n">u8</span>
<span class="nf">mptscsih_raid_id_to_num</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inactive_raid_component_info</span> <span class="o">*</span><span class="n">component_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">RaidPhysDiskPage1_t</span> <span class="o">*</span><span class="n">phys_disk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_paths</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="o">-&gt;</span><span class="n">NumPhysDisks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">==</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="o">-&gt;</span><span class="n">PhysDisk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="o">-&gt;</span><span class="n">PhysDisk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskBus</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="o">-&gt;</span><span class="n">PhysDisk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskNum</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="n">SAS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if dual path</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="o">-&gt;</span><span class="n">NumPhysDisks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_paths</span> <span class="o">=</span> <span class="n">mpt_raid_phys_disk_get_num_paths</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="o">-&gt;</span><span class="n">PhysDisk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskNum</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_paths</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">phys_disk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="n">RaidPhysDiskPage1_t</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span> <span class="o">+</span>
		   <span class="p">(</span><span class="n">num_paths</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RAID_PHYS_DISK1_PATH</span><span class="p">)),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phys_disk</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mpt_raid_phys_disk_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="o">-&gt;</span><span class="n">PhysDisk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskNum</span><span class="p">,</span>
		    <span class="n">phys_disk</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">phys_disk</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">num_paths</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Flags</span> <span class="o">&amp;</span>
			    <span class="n">MPI_RAID_PHYSDISK1_FLAG_INVALID</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Flags</span> <span class="o">&amp;</span>
			    <span class="n">MPI_RAID_PHYSDISK1_FLAG_BROKEN</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">==</span> <span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">PhysDiskID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">PhysDiskBus</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">PhysDiskNum</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">phys_disk</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">phys_disk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check inactive list for matching phys disks</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">component_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">,</span>
	    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">component_info</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">PhysDiskID</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">component_info</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">PhysDiskBus</span> <span class="o">==</span> <span class="n">channel</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">component_info</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">PhysDiskNum</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list_mutex</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_raid_id_to_num</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *	OS entry point to allow for host driver to free allocated memory</span>
<span class="cm"> *	Called if no device present or device being unloaded</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mptscsih_slave_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">MPT_SCSI_HOST</span>		<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">VirtTarget</span>		<span class="o">*</span><span class="n">vtarget</span><span class="p">;</span>
	<span class="n">VirtDevice</span>		<span class="o">*</span><span class="n">vdevice</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> 	<span class="o">*</span><span class="n">starget</span><span class="p">;</span>

	<span class="n">starget</span> <span class="o">=</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="n">vtarget</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">vdevice</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdevice</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mptscsih_search_running_cmds</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">vdevice</span><span class="p">);</span>
	<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">num_luns</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mptscsih_synchronize_cache</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="n">vdevice</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vdevice</span><span class="p">);</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptscsih_change_queue_depth - This function will set a devices queue depth</span>
<span class="cm"> *	@sdev: per scsi_device pointer</span>
<span class="cm"> *	@qdepth: requested queue depth</span>
<span class="cm"> *	@reason: calling context</span>
<span class="cm"> *</span>
<span class="cm"> *	Adding support for new &#39;change_queue_depth&#39; api.</span>
<span class="cm">*/</span>
<span class="kt">int</span>
<span class="nf">mptscsih_change_queue_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qdepth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span>		<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">VirtTarget</span> 		<span class="o">*</span><span class="n">vtarget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> 	<span class="o">*</span><span class="n">starget</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">max_depth</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tagged</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>		<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="n">starget</span> <span class="o">=</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="n">vtarget</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">!=</span> <span class="n">SCSI_QDEPTH_DEFAULT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SPI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_Q_YES</span><span class="p">))</span>
			<span class="n">max_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DISK</span> <span class="o">&amp;&amp;</span>
			 <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">minSyncFactor</span> <span class="o">&lt;=</span> <span class="n">MPT_ULTRA160</span><span class="p">)</span>
			<span class="n">max_depth</span> <span class="o">=</span> <span class="n">MPT_SCSI_CMD_PER_DEV_HIGH</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">max_depth</span> <span class="o">=</span> <span class="n">MPT_SCSI_CMD_PER_DEV_LOW</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		 <span class="n">max_depth</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">)</span>
		<span class="n">max_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qdepth</span> <span class="o">&gt;</span> <span class="n">max_depth</span><span class="p">)</span>
		<span class="n">qdepth</span> <span class="o">=</span> <span class="n">max_depth</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qdepth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tagged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tagged</span> <span class="o">=</span> <span class="n">MSG_SIMPLE_TAG</span><span class="p">;</span>

	<span class="n">scsi_adjust_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">tagged</span><span class="p">,</span> <span class="n">qdepth</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	OS entry point to adjust the queue_depths on a per-device basis.</span>
<span class="cm"> *	Called once per device the bus scan. Use it to force the queue_depth</span>
<span class="cm"> *	member to 1 if a device does not support Q tags.</span>
<span class="cm"> *	Return non-zero if fails.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mptscsih_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>	<span class="o">*</span><span class="n">sh</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">VirtTarget</span>		<span class="o">*</span><span class="n">vtarget</span><span class="p">;</span>
	<span class="n">VirtDevice</span>		<span class="o">*</span><span class="n">vdevice</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> 	<span class="o">*</span><span class="n">starget</span><span class="p">;</span>
	<span class="n">MPT_SCSI_HOST</span>		<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span>		<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="n">starget</span> <span class="o">=</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="n">vtarget</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">vdevice</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">dsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		<span class="s">&quot;device @ %p, channel=%d, id=%d, lun=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SPI</span><span class="p">)</span>
		<span class="n">dsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;sdtr %d wdtr %d ppr %d inq length=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sdtr</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">wdtr</span><span class="p">,</span>
		    <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">ppr</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">inquiry_len</span><span class="p">));</span>

	<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">configured_lun</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		<span class="s">&quot;Queue depth=%d, tflags=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">,</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SPI</span><span class="p">)</span>
		<span class="n">dsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;negoFlags=%x, maxOffset=%x, SyncFactor=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">negoFlags</span><span class="p">,</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">maxOffset</span><span class="p">,</span>
		    <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">minSyncFactor</span><span class="p">));</span>

	<span class="n">mptscsih_change_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">MPT_SCSI_CMD_PER_DEV_HIGH</span><span class="p">,</span>
				    <span class="n">SCSI_QDEPTH_DEFAULT</span><span class="p">);</span>
	<span class="n">dsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		<span class="s">&quot;tagged %d, simple %d, ordered %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">tagged_supported</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">simple_tags</span><span class="p">,</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">ordered_tags</span><span class="p">));</span>

	<span class="n">blk_queue_dma_alignment</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="mi">512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *  Private routines...</span>
<span class="cm"> */</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/* Utility function to copy sense data from the scsi_cmnd buffer</span>
<span class="cm"> * to the FC and SCSI target structures.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptscsih_copy_sense_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">,</span> <span class="n">SCSIIOReply_t</span> <span class="o">*</span><span class="n">pScsiReply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">VirtDevice</span>	<span class="o">*</span><span class="n">vdevice</span><span class="p">;</span>
	<span class="n">SCSIIORequest_t</span>	<span class="o">*</span><span class="n">pReq</span><span class="p">;</span>
	<span class="n">u32</span>		 <span class="n">sense_count</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pScsiReply</span><span class="o">-&gt;</span><span class="n">SenseCount</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> 	<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="cm">/* Get target structure</span>
<span class="cm">	 */</span>
	<span class="n">pReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>
	<span class="n">vdevice</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sense_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">sense_data</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">req_index</span><span class="p">;</span>

		<span class="cm">/* Copy the sense received into the scsi command block. */</span>
		<span class="n">req_index</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">req_idx</span><span class="p">);</span>
		<span class="n">sense_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool</span> <span class="o">+</span> <span class="p">(</span><span class="n">req_index</span> <span class="o">*</span> <span class="n">MPT_SENSE_BUFFER_ALLOC</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span> <span class="n">sense_data</span><span class="p">,</span> <span class="n">SNS_LEN</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>

		<span class="cm">/* Log SMART data (asc = 0x5D, non-IM case only) if required.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">eventTypes</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MPI_EVENT_SCSI_DEVICE_STATUS_CHANGE</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">sense_data</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x5D</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">raidVolume</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

				<span class="n">idx</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">eventContext</span> <span class="o">%</span> <span class="n">MPTCTL_EVENT_LOG_SIZE</span><span class="p">;</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">event</span> <span class="o">=</span> <span class="n">MPI_EVENT_SCSI_DEVICE_STATUS_CHANGE</span><span class="p">;</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">eventContext</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">eventContext</span><span class="p">;</span>

				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pReq</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">MPI_EVENT_SCSI_DEV_STAT_RC_SMART_DATA</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sense_data</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">sense_data</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>

				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">eventContext</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span>
				    <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mptscsih_issue_sep_command</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
					    <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="p">,</span> <span class="n">MPI_SEP_REQ_SLOTSTATUS_PREDICTED_FAULT</span><span class="p">);</span>
					<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">|=</span>
					    <span class="n">MPT_TARGET_FLAGS_LED_ON</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Hmmm... SenseData len=0! (?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mptscsih_get_scsi_lookup - retrieves scmd entry</span>
<span class="cm"> * @ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> * @i: index into the array</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the scsi_cmd pointer</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span>
<span class="nf">mptscsih_get_scsi_lookup</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">scmd</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scmd</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_get_scsi_lookup</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * mptscsih_getclear_scsi_lookup -  retrieves and clears scmd entry from ScsiLookup[] array list</span>
<span class="cm"> * @ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> * @i: index into the array</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the scsi_cmd pointer</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span>
<span class="nf">mptscsih_getclear_scsi_lookup</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">scmd</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mptscsih_set_scsi_lookup - write a scmd entry into the ScsiLookup[] array list</span>
<span class="cm"> *</span>
<span class="cm"> * @ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> * @i: index into the array</span>
<span class="cm"> * @scmd: scsi_cmnd pointer</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptscsih_set_scsi_lookup</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scmd</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * SCPNT_TO_LOOKUP_IDX - searches for a given scmd in the ScsiLookup[] array list</span>
<span class="cm"> * @ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> * @sc: scsi_cmnd pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">SCPNT_TO_LOOKUP_IDX</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">sc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="kt">int</span>
<span class="nf">mptscsih_ioc_reset</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_phase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reset_phase</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPT_IOC_SETUP_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: MPT_IOC_SETUP_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT_IOC_PRE_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: MPT_IOC_PRE_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="n">mptscsih_flush_running_cmds</span><span class="p">(</span><span class="n">hd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT_IOC_POST_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: MPT_IOC_POST_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span>
				<span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">;</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* currently means nothing really */</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="kt">int</span>
<span class="nf">mptscsih_event_process</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">EventNotificationReply_t</span> <span class="o">*</span><span class="n">pEvReply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">event</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pEvReply</span><span class="o">-&gt;</span><span class="n">Event</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">devtverboseprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		<span class="s">&quot;MPT event (=%02Xh) routed to SCSI host driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">event</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">event</span> <span class="o">==</span> <span class="n">MPI_EVENT_IOC_BUS_RESET</span> <span class="o">||</span>
	    <span class="n">event</span> <span class="o">==</span> <span class="n">MPI_EVENT_EXT_BUS_RESET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SPI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">soft_resets</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">soft_resets</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* currently means nothing really */</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *  Bus Scan and Domain Validation functionality ...</span>
<span class="cm"> */</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptscsih_scandv_complete - Scan and DV callback routine registered</span>
<span class="cm"> *	to Fustion MPT (base) driver.</span>
<span class="cm"> *</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@mf: Pointer to original MPT request frame</span>
<span class="cm"> *	@mr: Pointer to MPT reply frame (NULL if TurboReply)</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine is called from mpt.c::mpt_interrupt() at the completion</span>
<span class="cm"> *	of any SCSI IO request.</span>
<span class="cm"> *	This routine is registered with the Fusion MPT (base) driver at driver</span>
<span class="cm"> *	load/init time via the mpt_register() API call.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 1 indicating alloc&#39;d request frame ptr should be freed.</span>
<span class="cm"> *</span>
<span class="cm"> *	Remark: Sets a completion code and (possibly) saves sense data</span>
<span class="cm"> *	in the IOC member localReply structure.</span>
<span class="cm"> *	Used ONLY for DV and other internal commands.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mptscsih_scandv_complete</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
				<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="n">pReq</span><span class="p">;</span>
	<span class="n">SCSIIOReply_t</span>	<span class="o">*</span><span class="n">pReply</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u16</span>		 <span class="n">req_idx</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">sense_data</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">sz</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_GOOD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">pReply</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIIOReply_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">reply</span><span class="p">;</span>
	<span class="n">pReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">completion_code</span> <span class="o">=</span>
	    <span class="n">mptscsih_get_completion_code</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span>
	    <span class="n">min</span><span class="p">(</span><span class="n">MPT_DEFAULT_FRAME_SIZE</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">reply</span><span class="p">.</span><span class="n">MsgLength</span><span class="p">));</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Function</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MPI_FUNCTION_SCSI_IO_REQUEST</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MPI_FUNCTION_RAID_SCSI_IO_PASSTHROUGH</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pReply</span><span class="o">-&gt;</span><span class="n">SCSIState</span> <span class="o">&amp;</span> <span class="n">MPI_SCSI_STATE_AUTOSENSE_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">req_idx</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">req_idx</span><span class="p">);</span>
		<span class="n">sense_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">req_idx</span> <span class="o">*</span> <span class="n">MPT_SENSE_BUFFER_ALLOC</span><span class="p">));</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">SenseBufferLength</span><span class="p">,</span>
		    <span class="n">MPT_SENSE_BUFFER_ALLOC</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">sense</span><span class="p">,</span> <span class="n">sense_data</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">;</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *	mptscsih_get_completion_code - get completion code from MPT request</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@req: Pointer to original MPT request frame</span>
<span class="cm"> *	@reply: Pointer to MPT reply frame (NULL if TurboReply)</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptscsih_get_completion_code</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
				<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SCSIIOReply_t</span>	<span class="o">*</span><span class="n">pReply</span><span class="p">;</span>
	<span class="n">MpiRaidActionReply_t</span> <span class="o">*</span><span class="n">pr</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">scsi_status</span><span class="p">;</span>
	<span class="n">u16</span>		 <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">completion_code</span><span class="p">;</span>

	<span class="n">pReply</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIIOReply_t</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pReply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="n">scsi_status</span> <span class="o">=</span> <span class="n">pReply</span><span class="o">-&gt;</span><span class="n">SCSIStatus</span><span class="p">;</span>

	<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;IOCStatus=%04xh, SCSIState=%02xh, SCSIStatus=%02xh,&quot;</span>
	    <span class="s">&quot;IOCLogInfo=%08xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">pReply</span><span class="o">-&gt;</span><span class="n">SCSIState</span><span class="p">,</span>
	    <span class="n">scsi_status</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pReply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">)));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_DEVICE_NOT_THERE</span>:	<span class="cm">/* 0x0043 */</span>
		<span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_SELECTION_TIMEOUT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_IO_DATA_ERROR</span>:		<span class="cm">/* 0x0046 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_TASK_TERMINATED</span>:	<span class="cm">/* 0x0048 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_IOC_TERMINATED</span>:		<span class="cm">/* 0x004B */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_EXT_TERMINATED</span>:		<span class="cm">/* 0x004C */</span>
		<span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_DID_RESET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_BUSY</span>:
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_INSUFFICIENT_RESOURCES</span>:
		<span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_BUSY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_DATA_UNDERRUN</span>:		<span class="cm">/* 0x0045 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_RECOVERED_ERROR</span>:	<span class="cm">/* 0x0040 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SUCCESS</span>:			<span class="cm">/* 0x0000 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pReply</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">==</span> <span class="n">MPI_FUNCTION_CONFIG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_GOOD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pReply</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">==</span> <span class="n">MPI_FUNCTION_RAID_ACTION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr</span> <span class="o">=</span> <span class="p">(</span><span class="n">MpiRaidActionReply_t</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pr</span><span class="o">-&gt;</span><span class="n">ActionStatus</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">MPI_RAID_ACTION_ASTATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_GOOD</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_SOME_ERROR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pReply</span><span class="o">-&gt;</span><span class="n">SCSIState</span> <span class="o">&amp;</span> <span class="n">MPI_SCSI_STATE_AUTOSENSE_VALID</span><span class="p">)</span>
			<span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_SENSE</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pReply</span><span class="o">-&gt;</span><span class="n">SCSIState</span> <span class="o">&amp;</span> <span class="n">MPI_SCSI_STATE_AUTOSENSE_FAILED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scsireq</span><span class="p">.</span><span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">INQUIRY</span><span class="p">)</span>
				<span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_ISSUE_SENSE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_DID_RESET</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pReply</span><span class="o">-&gt;</span><span class="n">SCSIState</span> <span class="o">&amp;</span> <span class="n">MPI_SCSI_STATE_NO_SCSI_STATUS</span><span class="p">)</span>
			<span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_DID_RESET</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pReply</span><span class="o">-&gt;</span><span class="n">SCSIState</span> <span class="o">&amp;</span> <span class="n">MPI_SCSI_STATE_TERMINATED</span><span class="p">)</span>
			<span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_DID_RESET</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_status</span> <span class="o">==</span> <span class="n">MPI_SCSI_STATUS_BUSY</span><span class="p">)</span>
			<span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_BUSY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_GOOD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_PROTOCOL_ERROR</span>:		<span class="cm">/* 0x0047 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pReply</span><span class="o">-&gt;</span><span class="n">SCSIState</span> <span class="o">&amp;</span> <span class="n">MPI_SCSI_STATE_TERMINATED</span><span class="p">)</span>
			<span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_DID_RESET</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_SOME_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">completion_code</span> <span class="o">=</span> <span class="n">MPT_SCANDV_SOME_ERROR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>	<span class="cm">/* switch(status) */</span>

	<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;  completionCode set to %08xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">completion_code</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">completion_code</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptscsih_do_cmd - Do internal command.</span>
<span class="cm"> *	@hd: MPT_SCSI_HOST pointer</span>
<span class="cm"> *	@io: INTERNAL_CMD pointer.</span>
<span class="cm"> *</span>
<span class="cm"> *	Issue the specified internally generated command and do command</span>
<span class="cm"> *	specific cleanup. For bus scan / DV only.</span>
<span class="cm"> *	NOTES: If command is Inquiry and status is good,</span>
<span class="cm"> *	initialize a target structure, save the data</span>
<span class="cm"> *</span>
<span class="cm"> *	Remark: Single threaded access only.</span>
<span class="cm"> *</span>
<span class="cm"> *	Return:</span>
<span class="cm"> *		&lt; 0 if an illegal command or no resources</span>
<span class="cm"> *</span>
<span class="cm"> *		   0 if good</span>
<span class="cm"> *</span>
<span class="cm"> *		 &gt; 0 if command complete but some type of completion error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptscsih_do_cmd</span><span class="p">(</span><span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="n">INTERNAL_CMD</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_FRAME_HDR</span>	<span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">SCSIIORequest_t</span>	<span class="o">*</span><span class="n">pScsiReq</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">my_idx</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">dir</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">char</span>		 <span class="n">cmdLen</span><span class="p">;</span>
	<span class="kt">char</span>		 <span class="n">CDB</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">u8</span>		 <span class="n">cmd</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">timeleft</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* don&#39;t send internal command during diag reset */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			<span class="s">&quot;%s: busy with host reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">MPT_SCANDV_BUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Set command specific information</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INQUIRY</span>:
		<span class="n">cmdLen</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_READ</span><span class="p">;</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
		<span class="n">cmdLen</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_READ</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">START_STOP</span>:
		<span class="n">cmdLen</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_READ</span><span class="p">;</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/*Spin up the disk */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">REQUEST_SENSE</span>:
		<span class="n">cmdLen</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_READ</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">READ_BUFFER</span>:
		<span class="n">cmdLen</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_READ</span><span class="p">;</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_ICFLAG_ECHO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_ICFLAG_BUF_CAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WRITE_BUFFER</span>:
		<span class="n">cmdLen</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_WRITE</span><span class="p">;</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_ICFLAG_ECHO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">CDB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RESERVE</span>:
		<span class="n">cmdLen</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_READ</span><span class="p">;</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RELEASE</span>:
		<span class="n">cmdLen</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_READ</span><span class="p">;</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SYNCHRONIZE_CACHE</span>:
		<span class="n">cmdLen</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_READ</span><span class="p">;</span>
		<span class="n">CDB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><pre><code>CDB[1] = 0x02;  /* set immediate bit */
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* Error Case */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get and Populate a free Frame</span>
<span class="cm">	 * MsgContext set in mpt_get_msg_frame call</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">InternalCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;%s: No msg frames!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">MPT_SCANDV_BUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pScsiReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>

	<span class="cm">/* Get the request index */</span>
	<span class="n">my_idx</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">req_idx</span><span class="p">);</span>
	<span class="n">ADD_INDEX_LOG</span><span class="p">(</span><span class="n">my_idx</span><span class="p">);</span> <span class="cm">/* for debug */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_ICFLAG_PHYS_DISK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">physDiskNum</span><span class="p">;</span>
		<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_RAID_SCSI_IO_PASSTHROUGH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_SCSI_IO_REQUEST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">CDBLength</span> <span class="o">=</span> <span class="n">cmdLen</span><span class="p">;</span>
	<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">SenseBufferLength</span> <span class="o">=</span> <span class="n">MPT_SENSE_BUFFER_SIZE</span><span class="p">;</span>

	<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">=</span> <span class="n">mpt_msg_flags</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="cm">/* MsgContext set in mpt_get_msg_fram call  */</span>

	<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPT_ICFLAG_TAGGED_CMD</span><span class="p">)</span>
		<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Control</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dir</span> <span class="o">|</span> <span class="n">MPI_SCSIIO_CONTROL_SIMPLEQ</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Control</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dir</span> <span class="o">|</span> <span class="n">MPI_SCSIIO_CONTROL_UNTAGGED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">REQUEST_SENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Control</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dir</span> <span class="o">|</span> <span class="n">MPI_SCSIIO_CONTROL_UNTAGGED</span><span class="p">);</span>
		<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: Untagged! 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">CDB</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">CDB</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>

	<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">SenseBufferLowAddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_low_dma</span>
					   <span class="o">+</span> <span class="p">(</span><span class="n">my_idx</span> <span class="o">*</span> <span class="n">MPT_SENSE_BUFFER_ALLOC</span><span class="p">));</span>

	<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;%s: Sending Command 0x%02x for fw_channel=%d fw_id=%d lun=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">MPI_SCSIIO_CONTROL_READ</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">SGL</span><span class="p">,</span>
		    <span class="n">MPT_SGE_FLAGS_SSIMPLE_READ</span> <span class="o">|</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">data_dma</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">SGL</span><span class="p">,</span>
		    <span class="n">MPT_SGE_FLAGS_SSIMPLE_WRITE</span> <span class="o">|</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">data_dma</span><span class="p">);</span>

	<span class="n">INITIALIZE_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">mpt_put_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">InternalCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span>
	    <span class="n">timeout</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">MPT_SCANDV_DID_RESET</span><span class="p">;</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: TIMED OUT for cmd=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">cmd</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeleft</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			       <span class="s">&quot;Issuing Reset from %s!! doorbell=0x%08xh&quot;</span>
			       <span class="s">&quot; cmd=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="n">cmd</span><span class="p">);</span>
			<span class="n">mpt_Soft_Hard_ResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
			<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">completion_code</span><span class="p">;</span>
	<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;%s: success, rc=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

 <span class="nl">out:</span>
	<span class="n">CLEAR_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptscsih_synchronize_cache - Send SYNCHRONIZE_CACHE to all disks.</span>
<span class="cm"> *	@hd: Pointer to a SCSI HOST structure</span>
<span class="cm"> *	@vdevice: virtual target device</span>
<span class="cm"> *</span>
<span class="cm"> *	Uses the ISR, but with special processing.</span>
<span class="cm"> *	MUST be single-threaded.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptscsih_synchronize_cache</span><span class="p">(</span><span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">,</span> <span class="n">VirtDevice</span> <span class="o">*</span><span class="n">vdevice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INTERNAL_CMD</span>		 <span class="n">iocmd</span><span class="p">;</span>

	<span class="cm">/* Ignore hidden raid components, this is handled when the command</span>
<span class="cm">	 * is sent to the volume</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TYPE_DISK</span> <span class="o">||</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">configured_lun</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Following parameters will not change</span>
<span class="cm">	 * in this routine.</span>
<span class="cm">	 */</span>
	<span class="n">iocmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SYNCHRONIZE_CACHE</span><span class="p">;</span>
	<span class="n">iocmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iocmd</span><span class="p">.</span><span class="n">physDiskNum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">iocmd</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iocmd</span><span class="p">.</span><span class="n">data_dma</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">iocmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iocmd</span><span class="p">.</span><span class="n">rsvd</span> <span class="o">=</span> <span class="n">iocmd</span><span class="p">.</span><span class="n">rsvd2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iocmd</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">iocmd</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">iocmd</span><span class="p">.</span><span class="n">lun</span> <span class="o">=</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>

	<span class="n">mptscsih_do_cmd</span><span class="p">(</span><span class="n">hd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iocmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mptscsih_version_fw_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%02d.%02d.%02d.%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span> <span class="o">&amp;</span> <span class="mh">0xFF000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">version_fw</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mptscsih_version_fw_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mptscsih_version_bios_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%02x.%02x.%02x.%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">biosVersion</span> <span class="o">&amp;</span> <span class="mh">0xFF000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">biosVersion</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">biosVersion</span> <span class="o">&amp;</span> <span class="mh">0x0000FF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">biosVersion</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">version_bios</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mptscsih_version_bios_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mptscsih_version_mpi_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%03x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MsgVersion</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">version_mpi</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mptscsih_version_mpi_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mptscsih_version_product_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">prod_name</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">version_product</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
    <span class="n">mptscsih_version_product_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mptscsih_version_nvdata_persistent_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%02xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">nvdata_version_persistent</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">version_nvdata_persistent</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
    <span class="n">mptscsih_version_nvdata_persistent_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mptscsih_version_nvdata_default_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%02xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">nvdata_version_default</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">version_nvdata_default</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
    <span class="n">mptscsih_version_nvdata_default_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mptscsih_board_name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">board_name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mptscsih_board_name_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mptscsih_board_assembly_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">board_assembly</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">board_assembly</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
    <span class="n">mptscsih_board_assembly_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mptscsih_board_tracer_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">board_tracer</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">board_tracer</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
    <span class="n">mptscsih_board_tracer_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mptscsih_io_delay_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">io_missing_delay</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">io_delay</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
    <span class="n">mptscsih_io_delay_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mptscsih_device_delay_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">device_missing_delay</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">device_delay</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
    <span class="n">mptscsih_device_delay_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mptscsih_debug_level_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%08xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">debug_level</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mptscsih_debug_level_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">debug_level</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;debug_level=%08xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">debug_level</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="n">mptscsih_debug_level_show</span><span class="p">,</span> <span class="n">mptscsih_debug_level_store</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">mptscsih_host_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_version_fw</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_version_bios</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_version_mpi</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_version_product</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_version_nvdata_persistent</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_version_nvdata_default</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_board_name</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_board_assembly</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_board_tracer</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_io_delay</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_device_delay</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_debug_level</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_host_attrs</span><span class="p">);</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_remove</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_shutdown</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_suspend</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_resume</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_proc_info</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_info</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_qcmd</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_slave_destroy</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_slave_configure</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_abort</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_dev_reset</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_bus_reset</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_host_reset</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_bios_param</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_io_done</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_taskmgmt_complete</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_scandv_complete</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_event_process</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_ioc_reset</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptscsih_change_queue_depth</span><span class="p">);</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
