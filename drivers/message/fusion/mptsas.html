<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › message › fusion › mptsas.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mptsas.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/message/fusion/mptsas.c</span>
<span class="cm"> *      For use with LSI PCI chip/adapter(s)</span>
<span class="cm"> *      running LSI Fusion MPT (Message Passing Technology) firmware.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 1999-2008 LSI Corporation</span>
<span class="cm"> *  (mailto:DL-MPTFusionLinux@lsi.com)</span>
<span class="cm"> */</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; version 2 of the License.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    NO WARRANTY</span>
<span class="cm">    THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span>
<span class="cm">    CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT</span>
<span class="cm">    LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,</span>
<span class="cm">    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is</span>
<span class="cm">    solely responsible for determining the appropriateness of using and</span>
<span class="cm">    distributing the Program and assumes all risks associated with its</span>
<span class="cm">    exercise of rights under this Agreement, including but not limited to</span>
<span class="cm">    the risks and costs of program errors, damage to or loss of data,</span>
<span class="cm">    programs or equipment, and unavailability or interruption of operations.</span>

<span class="cm">    DISCLAIMER OF LIABILITY</span>
<span class="cm">    NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY</span>
<span class="cm">    DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm">    DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND</span>
<span class="cm">    ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR</span>
<span class="cm">    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE</span>
<span class="cm">    USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED</span>
<span class="cm">    HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm">*/</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;	</span><span class="cm">/* for mdelay */</span><span class="cp"></span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport_sas.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_transport.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_dbg.h&gt;</span>

<span class="cp">#include &quot;mptbase.h&quot;</span>
<span class="cp">#include &quot;mptscsih.h&quot;</span>
<span class="cp">#include &quot;mptsas.h&quot;</span>


<span class="cp">#define my_NAME		&quot;Fusion MPT SAS Host driver&quot;</span>
<span class="cp">#define my_VERSION	MPT_LINUX_VERSION_COMMON</span>
<span class="cp">#define MYNAM		&quot;mptsas&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Reserved channel for integrated raid</span>
<span class="cm"> */</span>
<span class="cp">#define MPTSAS_RAID_CHANNEL	1</span>

<span class="cp">#define SAS_CONFIG_PAGE_TIMEOUT		30</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">MODULEAUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">my_NAME</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">my_VERSION</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mpt_pt_clear</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mpt_pt_clear</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpt_pt_clear</span><span class="p">,</span>
		<span class="s">&quot; Clear persistency table: enable=1  &quot;</span>
		<span class="s">&quot;(default=MPTSCSIH_PT_CLEAR=0)&quot;</span><span class="p">);</span>

<span class="cm">/* scsi-mid layer global parmeter is max_report_luns, which is 511 */</span>
<span class="cp">#define MPTSAS_MAX_LUN (16895)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">max_lun</span> <span class="o">=</span> <span class="n">MPTSAS_MAX_LUN</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">max_lun</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_lun</span><span class="p">,</span> <span class="s">&quot; max lun, default=16895 &quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mpt_loadtime_max_sectors</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mpt_loadtime_max_sectors</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpt_loadtime_max_sectors</span><span class="p">,</span>
		<span class="s">&quot; Maximum sector define for Host Bus Adaptor.Range 64 to 8192 default=8192&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u8</span>	<span class="n">mptsasDoneCtx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span>	<span class="n">mptsasTaskCtx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span>	<span class="n">mptsasInternalCtx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span> <span class="cm">/* Used only for internal commands */</span>
<span class="k">static</span> <span class="n">u8</span>	<span class="n">mptsasMgmtCtx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span>	<span class="n">mptsasDeviceResetCtx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">mptsas_firmware_event_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptsas_send_sas_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptsas_send_raid_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptsas_send_ir2_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptsas_parse_device_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_identify</span> <span class="o">*</span><span class="n">identify</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">mptsas_devinfo</span> <span class="o">*</span><span class="n">device_info</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">mptsas_set_rphy</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mptsas_phyinfo</span>	<span class="o">*</span><span class="n">mptsas_find_phyinfo_by_sas_address</span>
		<span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">sas_address</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptsas_sas_device_pg0</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mptsas_devinfo</span> <span class="o">*</span><span class="n">device_info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">form</span><span class="p">,</span> <span class="n">u32</span> <span class="n">form_specific</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptsas_sas_enclosure_pg0</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mptsas_enclosure</span> <span class="o">*</span><span class="n">enclosure</span><span class="p">,</span> <span class="n">u32</span> <span class="n">form</span><span class="p">,</span> <span class="n">u32</span> <span class="n">form_specific</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptsas_add_end_device</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptsas_del_end_device</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptsas_send_link_status_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mptsas_portinfo</span>	<span class="o">*</span><span class="n">mptsas_find_portinfo_by_sas_address</span>
		<span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">sas_address</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptsas_expander_delete</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">,</span> <span class="n">u8</span> <span class="n">force</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptsas_send_expander_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptsas_not_responding_devices</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptsas_scan_sas_topology</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptsas_broadcast_primative_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptsas_handle_queue_full_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptsas_volume_delete</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">);</span>
<span class="kt">void</span>	<span class="n">mptsas_schedule_target_reset</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mptsas_print_phy_data</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
					<span class="n">MPI_SAS_IO_UNIT0_PHY_DATA</span> <span class="o">*</span><span class="n">phy_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;---- IO UNIT PAGE 0 ------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Handle=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">phy_data</span><span class="o">-&gt;</span><span class="n">AttachedDeviceHandle</span><span class="p">)));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Controller Handle=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">phy_data</span><span class="o">-&gt;</span><span class="n">ControllerDevHandle</span><span class="p">)));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Port=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">phy_data</span><span class="o">-&gt;</span><span class="n">Port</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Port Flags=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">phy_data</span><span class="o">-&gt;</span><span class="n">PortFlags</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;PHY Flags=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">phy_data</span><span class="o">-&gt;</span><span class="n">PhyFlags</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Negotiated Link Rate=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">phy_data</span><span class="o">-&gt;</span><span class="n">NegotiatedLinkRate</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;Controller PHY Device Info=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">phy_data</span><span class="o">-&gt;</span><span class="n">ControllerPhyDeviceInfo</span><span class="p">)));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;DiscoveryStatus=0x%X</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">phy_data</span><span class="o">-&gt;</span><span class="n">DiscoveryStatus</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mptsas_print_phy_pg0</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">SasPhyPage0_t</span> <span class="o">*</span><span class="n">pg0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le64</span> <span class="n">sas_address</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">SASAddress</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">));</span>

	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;---- SAS PHY PAGE 0 ------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;Attached Device Handle=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">AttachedDevHandle</span><span class="p">)));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;SAS Address=0x%llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_address</span><span class="p">)));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;Attached PHY Identifier=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">pg0</span><span class="o">-&gt;</span><span class="n">AttachedPhyIdentifier</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Attached Device Info=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">AttachedDeviceInfo</span><span class="p">)));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Programmed Link Rate=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>  <span class="n">pg0</span><span class="o">-&gt;</span><span class="n">ProgrammedLinkRate</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Change Count=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pg0</span><span class="o">-&gt;</span><span class="n">ChangeCount</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;PHY Info=0x%X</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">PhyInfo</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mptsas_print_phy_pg1</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">SasPhyPage1_t</span> <span class="o">*</span><span class="n">pg1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;---- SAS PHY PAGE 1 ------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Invalid Dword Count=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>  <span class="n">pg1</span><span class="o">-&gt;</span><span class="n">InvalidDwordCount</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;Running Disparity Error Count=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">pg1</span><span class="o">-&gt;</span><span class="n">RunningDisparityErrorCount</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;Loss Dword Synch Count=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">pg1</span><span class="o">-&gt;</span><span class="n">LossDwordSynchCount</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;PHY Reset Problem Count=0x%x</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">pg1</span><span class="o">-&gt;</span><span class="n">PhyResetProblemCount</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mptsas_print_device_pg0</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">SasDevicePage0_t</span> <span class="o">*</span><span class="n">pg0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le64</span> <span class="n">sas_address</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">SASAddress</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">));</span>

	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;---- SAS DEVICE PAGE 0 ---------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Handle=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">)));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Parent Handle=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">ParentDevHandle</span><span class="p">)));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Enclosure Handle=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">EnclosureHandle</span><span class="p">)));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Slot=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">Slot</span><span class="p">)));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;SAS Address=0x%llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_address</span><span class="p">)));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Target ID=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pg0</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Bus=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pg0</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Parent Phy Num=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pg0</span><span class="o">-&gt;</span><span class="n">PhyNum</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Access Status=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">AccessStatus</span><span class="p">)));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Device Info=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">DeviceInfo</span><span class="p">)));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Flags=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pg0</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">)));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Physical Port=0x%X</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pg0</span><span class="o">-&gt;</span><span class="n">PhysicalPort</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mptsas_print_expander_pg1</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">SasExpanderPage1_t</span> <span class="o">*</span><span class="n">pg1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;---- SAS EXPANDER PAGE 1 ------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Physical Port=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pg1</span><span class="o">-&gt;</span><span class="n">PhysicalPort</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;PHY Identifier=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pg1</span><span class="o">-&gt;</span><span class="n">PhyIdentifier</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Negotiated Link Rate=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pg1</span><span class="o">-&gt;</span><span class="n">NegotiatedLinkRate</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Programmed Link Rate=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pg1</span><span class="o">-&gt;</span><span class="n">ProgrammedLinkRate</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Hardware Link Rate=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pg1</span><span class="o">-&gt;</span><span class="n">HwLinkRate</span><span class="p">));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Owner Device Handle=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pg1</span><span class="o">-&gt;</span><span class="n">OwnerDevHandle</span><span class="p">)));</span>
	<span class="n">dsasprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;Attached Device Handle=0x%X</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pg1</span><span class="o">-&gt;</span><span class="n">AttachedDevHandle</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/* inhibit sas firmware event handling */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_fw_event_off</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_events_off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_discovery_quiesce_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* enable sas firmware event handling */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_fw_event_on</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_events_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* queue a sas firmware event */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_add_fw_event</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_list</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">mptsas_firmware_event_work</span><span class="p">);</span>
	<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;%s: add (fw_event=0x%p)&quot;</span>
		<span class="s">&quot;on cpuid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">fw_event</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">()));</span>
	<span class="n">queue_delayed_work_on</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_q</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* requeue a sas firmware event */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_requeue_fw_event</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;%s: reschedule task &quot;</span>
	    <span class="s">&quot;(fw_event=0x%p)on cpuid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">fw_event</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">()));</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">retries</span><span class="o">++</span><span class="p">;</span>
	<span class="n">queue_delayed_work_on</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_q</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">delay</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* free memory associated to a sas firmware event */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_free_fw_event</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;%s: kfree (fw_event=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">));</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fw_event</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* walk the firmware event queue, and either stop or wait for</span>
<span class="cm"> * outstanding events to complete */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_cleanup_fw_event_q</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_target_reset_event</span> <span class="o">*</span><span class="n">target_reset_list</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>

	<span class="cm">/* flush the target_reset_list */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">target_reset_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">target_reset_list</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">target_reset_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			    <span class="s">&quot;%s: removing target reset for id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">target_reset_list</span><span class="o">-&gt;</span><span class="n">sas_event_data</span><span class="p">.</span><span class="n">TargetID</span><span class="p">));</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target_reset_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">target_reset_list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_list</span><span class="p">)</span> <span class="o">||</span>
	     <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_q</span> <span class="o">||</span> <span class="n">in_interrupt</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">fw_event</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">))</span>
			<span class="n">mptsas_free_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="nf">phy_to_ioc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="nf">rphy_to_ioc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="p">)</span><span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mptsas_find_portinfo_by_handle</span>
<span class="cm"> *</span>
<span class="cm"> * This function should be called with the sas_topology_mutex already held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span>
<span class="nf">mptsas_find_portinfo_by_handle</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">,</span> <span class="o">*</span><span class="n">rc</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">port_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">handle</span> <span class="o">==</span> <span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">port_info</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptsas_find_portinfo_by_sas_address -</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@handle:</span>
<span class="cm"> *</span>
<span class="cm"> *	This function should be called with the sas_topology_mutex already held</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span>
<span class="nf">mptsas_find_portinfo_by_sas_address</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">sas_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">,</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sas_address</span> <span class="o">&gt;=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_port_sas_addr</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sas_address</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_port_sas_addr</span> <span class="o">+</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_port_num_phy</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_port_info</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">port_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">==</span>
			    <span class="n">sas_address</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">port_info</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns true if there is a scsi end device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">mptsas_is_end_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_devinfo</span> <span class="o">*</span> <span class="n">attached</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">attached</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">attached</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">&amp;</span>
	    <span class="n">MPI_SAS_DEVICE_INFO_END_DEVICE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">attached</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">&amp;</span>
	    <span class="n">MPI_SAS_DEVICE_INFO_SSP_TARGET</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">attached</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">&amp;</span>
	    <span class="n">MPI_SAS_DEVICE_INFO_STP_TARGET</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">attached</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">&amp;</span>
	    <span class="n">MPI_SAS_DEVICE_INFO_SATA_DEVICE</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* no mutex */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_port_delete</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mptsas_portinfo_details</span> <span class="o">*</span> <span class="n">port_details</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_details</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">port_info</span> <span class="o">=</span> <span class="n">port_details</span><span class="o">-&gt;</span><span class="n">port_info</span><span class="p">;</span>
	<span class="n">phy_info</span> <span class="o">=</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">;</span>

	<span class="n">dsaswideprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;%s: [%p]: num_phys=%02d &quot;</span>
	    <span class="s">&quot;bitmask=0x%016llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port_details</span><span class="p">,</span>
	    <span class="n">port_details</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
	    <span class="n">port_details</span><span class="o">-&gt;</span><span class="n">phy_bitmask</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span> <span class="o">!=</span> <span class="n">port_details</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_devinfo</span><span class="p">));</span>
		<span class="n">mptsas_set_rphy</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">port_details</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span>
<span class="nf">mptsas_get_rphy</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">mptsas_set_rphy</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="o">-&gt;</span><span class="n">rphy</span> <span class="o">=</span> <span class="n">rphy</span><span class="p">;</span>
		<span class="n">dsaswideprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;sas_rphy_add: rphy=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rphy</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rphy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dsaswideprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span> <span class="s">&quot;add:&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">dsaswideprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;rphy=%p release=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rphy</span><span class="p">,</span> <span class="n">rphy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sas_port</span> <span class="o">*</span>
<span class="nf">mptsas_get_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">mptsas_set_port</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sas_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="p">)</span>
		<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dsaswideprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span> <span class="s">&quot;add:&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">dsaswideprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;port=%p release=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span>
<span class="nf">mptsas_get_starget</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">mptsas_set_starget</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span>
<span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="p">)</span>
		<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">=</span> <span class="n">starget</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptsas_add_device_component -</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@channel: fw mapped id&#39;s</span>
<span class="cm"> *	@id:</span>
<span class="cm"> *	@sas_address:</span>
<span class="cm"> *	@device_info:</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_add_device_component</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">sas_address</span><span class="p">,</span> <span class="n">u32</span> <span class="n">device_info</span><span class="p">,</span> <span class="n">u16</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u64</span> <span class="n">enclosure_logical_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_device_info</span>	<span class="o">*</span><span class="n">sas_info</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span>	<span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span>	<span class="o">*</span><span class="n">starget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span>	<span class="o">*</span><span class="n">rphy</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Delete all matching devices out of the list</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sas_info</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_list</span><span class="p">,</span>
	    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">is_logical_volume</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">sas_address</span> <span class="o">==</span> <span class="n">sas_address</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span> <span class="o">&amp;&amp;</span>
		     <span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sas_info</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sas_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_device_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_info</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set Firmware mapping</span>
<span class="cm">	 */</span>
	<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">sas_address</span> <span class="o">=</span> <span class="n">sas_address</span><span class="p">;</span>
	<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">=</span> <span class="n">device_info</span><span class="p">;</span>
	<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">enclosure_logical_id</span> <span class="o">=</span> <span class="n">enclosure_logical_id</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_list</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set OS mapping</span>
<span class="cm">	 */</span>
	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">starget</span> <span class="o">=</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="n">rphy</span> <span class="o">=</span> <span class="n">dev_to_rphy</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">==</span> <span class="n">sas_address</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
			<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_mutex</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptsas_add_device_component_by_fw -</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@channel:  fw mapped id&#39;s</span>
<span class="cm"> *	@id:</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_add_device_component_by_fw</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_devinfo</span> <span class="n">sas_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_enclosure</span> <span class="n">enclosure_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mptsas_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">MPI_SAS_DEVICE_PGAD_FORM_BUS_TARGET_ID</span> <span class="o">&lt;&lt;</span>
	     <span class="n">MPI_SAS_DEVICE_PGAD_FORM_SHIFT</span><span class="p">),</span>
	    <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enclosure_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_enclosure</span><span class="p">));</span>
	<span class="n">mptsas_sas_enclosure_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enclosure_info</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">MPI_SAS_ENCLOS_PGAD_FORM_HANDLE</span> <span class="o">&lt;&lt;</span>
	     <span class="n">MPI_SAS_ENCLOS_PGAD_FORM_SHIFT</span><span class="p">),</span>
	     <span class="n">sas_device</span><span class="p">.</span><span class="n">handle_enclosure</span><span class="p">);</span>

	<span class="n">mptsas_add_device_component</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_device</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span>
	    <span class="n">sas_device</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">sas_device</span><span class="p">.</span><span class="n">sas_address</span><span class="p">,</span> <span class="n">sas_device</span><span class="p">.</span><span class="n">device_info</span><span class="p">,</span>
	    <span class="n">sas_device</span><span class="p">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">enclosure_info</span><span class="p">.</span><span class="n">enclosure_logical_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptsas_add_device_component_starget_ir - Handle Integrated RAID, adding each individual device to list</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@channel: fw mapped id&#39;s</span>
<span class="cm"> *	@id:</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_add_device_component_starget_ir</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CONFIGPARMS</span>			<span class="n">cfg</span><span class="p">;</span>
	<span class="n">ConfigPageHeader_t</span>		<span class="n">hdr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">pRaidVolumePage0_t</span>		<span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">i</span><span class="p">;</span>
	<span class="n">RaidPhysDiskPage0_t</span> 		<span class="n">phys_disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_device_info</span>	<span class="o">*</span><span class="n">sas_info</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CONFIGPARMS</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ConfigPageHeader_t</span><span class="p">));</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_RAID_VOLUME</span><span class="p">;</span>
	<span class="cm">/* assumption that all volumes on channel = 0 */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">SAS_CONFIG_PAGE_TIMEOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">NumPhysDisks</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Adding entry for hidden components</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">NumPhysDisks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mpt_raid_phys_disk_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">PhysDisk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskNum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phys_disk</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mptsas_add_device_component_by_fw</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phys_disk</span><span class="p">.</span><span class="n">PhysDiskBus</span><span class="p">,</span>
		    <span class="n">phys_disk</span><span class="p">.</span><span class="n">PhysDiskID</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_mutex</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sas_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_list</span><span class="p">,</span>
		    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">is_logical_volume</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">channel</span> <span class="o">==</span> <span class="n">phys_disk</span><span class="p">.</span><span class="n">PhysDiskBus</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">phys_disk</span><span class="p">.</span><span class="n">PhysDiskID</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">is_hidden_raid_component</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">volume_id</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_mutex</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Delete all matching devices out of the list</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sas_info</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_list</span><span class="p">,</span>
	    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">is_logical_volume</span> <span class="o">&amp;&amp;</span> <span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span>
		    <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sas_info</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sas_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_device_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">is_logical_volume</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_mutex</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
		    <span class="n">dma_handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptsas_add_device_component_starget -</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@starget:</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_add_device_component_starget</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">VirtTarget</span>	<span class="o">*</span><span class="n">vtarget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span>	<span class="o">*</span><span class="n">rphy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_phyinfo</span>	<span class="o">*</span><span class="n">phy_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_enclosure</span>	<span class="n">enclosure_info</span><span class="p">;</span>

	<span class="n">rphy</span> <span class="o">=</span> <span class="n">dev_to_rphy</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">vtarget</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="n">phy_info</span> <span class="o">=</span> <span class="n">mptsas_find_phyinfo_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			<span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enclosure_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_enclosure</span><span class="p">));</span>
	<span class="n">mptsas_sas_enclosure_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enclosure_info</span><span class="p">,</span>
		<span class="p">(</span><span class="n">MPI_SAS_ENCLOS_PGAD_FORM_HANDLE</span> <span class="o">&lt;&lt;</span>
		<span class="n">MPI_SAS_ENCLOS_PGAD_FORM_SHIFT</span><span class="p">),</span>
		<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">handle_enclosure</span><span class="p">);</span>

	<span class="n">mptsas_add_device_component</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span>
		<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span><span class="p">,</span>
		<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">device_info</span><span class="p">,</span>
		<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">enclosure_info</span><span class="p">.</span><span class="n">enclosure_logical_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptsas_del_device_component_by_os - Once a device has been removed, we mark the entry in the list as being cached</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@channel: os mapped id&#39;s</span>
<span class="cm"> *	@id:</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_del_device_component_by_os</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_device_info</span>	<span class="o">*</span><span class="n">sas_info</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set is_cached flag</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sas_info</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_list</span><span class="p">,</span>
		<span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span> <span class="o">&amp;&amp;</span> <span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">is_cached</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptsas_del_device_components - Cleaning the list</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_del_device_components</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_device_info</span>	<span class="o">*</span><span class="n">sas_info</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sas_info</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_list</span><span class="p">,</span>
		<span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sas_info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_mutex</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * mptsas_setup_wide_ports</span>
<span class="cm"> *</span>
<span class="cm"> * Updates for new and existing narrow/wide port configuration</span>
<span class="cm"> * in the sas_topology</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_setup_wide_ports</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo_details</span> <span class="o">*</span> <span class="n">port_details</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">,</span> <span class="o">*</span><span class="n">phy_info_cmp</span><span class="p">;</span>
	<span class="n">u64</span>	<span class="n">sas_address</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>

	<span class="n">phy_info</span> <span class="o">=</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">handle</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">port_details</span> <span class="o">=</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_details</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_details</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Removing a phy from a port, letting the last</span>
<span class="cm">		 * phy be removed by firmware events.</span>
<span class="cm">		 */</span>
		<span class="n">dsaswideprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: [%p]: deleting phy = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port_details</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
		<span class="n">port_details</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="o">--</span><span class="p">;</span>
		<span class="n">port_details</span><span class="o">-&gt;</span><span class="n">phy_bitmask</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_devinfo</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span>
				<span class="s">&quot;delete phy %d, phy-obj (0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">));</span>
			<span class="n">sas_port_delete_phy</span><span class="p">(</span><span class="n">port_details</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Populate and refresh the tree</span>
<span class="cm">	 */</span>
	<span class="n">phy_info</span> <span class="o">=</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sas_address</span> <span class="o">=</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span><span class="p">;</span>
		<span class="n">dsaswideprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;phy_id=%d sas_address=0x%018llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_address</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_address</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">port_details</span> <span class="o">=</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Forming a port</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_details</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port_details</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span>
				<span class="n">mptsas_portinfo_details</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_details</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">port_details</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">port_details</span><span class="o">-&gt;</span><span class="n">port_info</span> <span class="o">=</span> <span class="n">port_info</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&lt;</span> <span class="mi">64</span> <span class="p">)</span>
				<span class="n">port_details</span><span class="o">-&gt;</span><span class="n">phy_bitmask</span> <span class="o">|=</span>
				    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">);</span>
			<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">sas_port_add_phy</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">dsaswideprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Forming port</span><span class="se">\n\t\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;phy_id=%d sas_address=0x%018llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_address</span><span class="p">));</span>
			<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span> <span class="o">=</span> <span class="n">port_details</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">phy_info_cmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span>
		    <span class="n">phy_info_cmp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info_cmp</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sas_address</span> <span class="o">!=</span> <span class="n">phy_info_cmp</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_info_cmp</span><span class="o">-&gt;</span><span class="n">port_details</span> <span class="o">==</span> <span class="n">port_details</span> <span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">dsaswideprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			    <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">phy_id=%d sas_address=0x%018llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
			    <span class="n">phy_info_cmp</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_info_cmp</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">port_details</span><span class="o">-&gt;</span><span class="n">rphy</span> <span class="o">=</span>
				    <span class="n">mptsas_get_rphy</span><span class="p">(</span><span class="n">phy_info_cmp</span><span class="p">);</span>
				<span class="n">port_details</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span>
				    <span class="n">mptsas_get_port</span><span class="p">(</span><span class="n">phy_info_cmp</span><span class="p">);</span>
				<span class="n">port_details</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">=</span>
				    <span class="n">mptsas_get_starget</span><span class="p">(</span><span class="n">phy_info_cmp</span><span class="p">);</span>
				<span class="n">port_details</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">=</span>
					<span class="n">phy_info_cmp</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info_cmp</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">)</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">phy_info_cmp</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">phy_info_cmp</span><span class="o">-&gt;</span><span class="n">sas_port_add_phy</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Adding a phy to a port</span>
<span class="cm">			 */</span>
			<span class="n">phy_info_cmp</span><span class="o">-&gt;</span><span class="n">port_details</span> <span class="o">=</span> <span class="n">port_details</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_info_cmp</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">&lt;</span> <span class="mi">64</span> <span class="p">)</span>
				<span class="n">port_details</span><span class="o">-&gt;</span><span class="n">phy_bitmask</span> <span class="o">|=</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">phy_info_cmp</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">);</span>
			<span class="n">port_details</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out:</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port_details</span> <span class="o">=</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_details</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_details</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">dsaswideprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: [%p]: phy_id=%02d num_phys=%02d &quot;</span>
		    <span class="s">&quot;bitmask=0x%016llX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">port_details</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">port_details</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">port_details</span><span class="o">-&gt;</span><span class="n">phy_bitmask</span><span class="p">));</span>
		<span class="n">dsaswideprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">port = %p rphy=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">port_details</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">port_details</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">dsaswideprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * csmisas_find_vtarget</span>
<span class="cm"> *</span>
<span class="cm"> * @ioc</span>
<span class="cm"> * @volume_id</span>
<span class="cm"> * @volume_bus</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">VirtTarget</span> <span class="o">*</span>
<span class="nf">mptsas_find_vtarget</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> 		<span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="n">VirtDevice</span>			<span class="o">*</span><span class="n">vdevice</span><span class="p">;</span>
	<span class="n">VirtTarget</span> 			<span class="o">*</span><span class="n">vtarget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vdevice</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vdevice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span>
		    <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span> <span class="o">||</span>
		    <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">raidVolume</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span> <span class="o">&amp;&amp;</span>
			<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span><span class="p">)</span>
			<span class="n">vtarget</span> <span class="o">=</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">vtarget</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_queue_device_delete</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
	<span class="n">MpiEventDataSasDeviceStatusChange_t</span> <span class="o">*</span><span class="n">sas_event_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sz</span><span class="p">;</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span><span class="p">,</span> <span class="n">event_data</span><span class="p">)</span> <span class="o">+</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">MpiEventDataSasDeviceStatusChange_t</span><span class="p">);</span>
	<span class="n">fw_event</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_event</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;%s: failed at (line=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">,</span> <span class="n">sas_event_data</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">MpiEventDataSasDeviceStatusChange_t</span><span class="p">));</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">MPI_EVENT_SAS_DEVICE_STATUS_CHANGE</span><span class="p">;</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">ioc</span><span class="p">;</span>
	<span class="n">mptsas_add_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_queue_rescan</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sz</span><span class="p">;</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span><span class="p">,</span> <span class="n">event_data</span><span class="p">);</span>
	<span class="n">fw_event</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_event</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;%s: failed at (line=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">ioc</span><span class="p">;</span>
	<span class="n">mptsas_add_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mptsas_target_reset</span>
<span class="cm"> *</span>
<span class="cm"> * Issues TARGET_RESET to end device using handshaking method</span>
<span class="cm"> *</span>
<span class="cm"> * @ioc</span>
<span class="cm"> * @channel</span>
<span class="cm"> * @id</span>
<span class="cm"> *</span>
<span class="cm"> * Returns (1) success</span>
<span class="cm"> *         (0) failure</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_target_reset</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_FRAME_HDR</span>	<span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">SCSITaskMgmt_t</span>	<span class="o">*</span><span class="n">pScsiTm</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_set_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">mptsasDeviceResetCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			<span class="s">&quot;%s, no msg frames @%d!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;TaskMgmt request (mf=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mf</span><span class="p">));</span>

	<span class="cm">/* Format the Request</span>
<span class="cm">	 */</span>
	<span class="n">pScsiTm</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSITaskMgmt_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>
	<span class="n">memset</span> <span class="p">(</span><span class="n">pScsiTm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCSITaskMgmt_t</span><span class="p">));</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_SCSI_TASK_MGMT</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">TaskType</span> <span class="o">=</span> <span class="n">MPI_SCSITASKMGMT_TASKTYPE_TARGET_RESET</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">=</span> <span class="n">MPI_SCSITASKMGMT_MSGFLAGS_LIPRESET_RESET_OPTION</span><span class="p">;</span>

	<span class="n">DBG_DUMP_TM_REQUEST_FRAME</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">);</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	   <span class="s">&quot;TaskMgmt type=%d (sas device delete) fw_channel = %d fw_id = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">MPI_SCSITASKMGMT_TASKTYPE_TARGET_RESET</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">));</span>

	<span class="n">mpt_put_msg_frame_hi_pri</span><span class="p">(</span><span class="n">mptsasDeviceResetCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

 <span class="nl">out_fail:</span>

	<span class="n">mpt_clear_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_block_io_sdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scsi_device_set_state</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SDEV_BLOCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_block_io_starget</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="p">)</span>
		<span class="n">starget_for_each_device</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">mptsas_block_io_sdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mptsas_target_reset_queue</span>
<span class="cm"> *</span>
<span class="cm"> * Receive request for TARGET_RESET after receiving an firmware</span>
<span class="cm"> * event NOT_RESPONDING_EVENT, then put command in link list</span>
<span class="cm"> * and queue if task_queue already in use.</span>
<span class="cm"> *</span>
<span class="cm"> * @ioc</span>
<span class="cm"> * @sas_event_data</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_target_reset_queue</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">EVENT_DATA_SAS_DEVICE_STATUS_CHANGE</span> <span class="o">*</span><span class="n">sas_event_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>
	<span class="n">VirtTarget</span> <span class="o">*</span><span class="n">vtarget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_target_reset_event</span> <span class="o">*</span><span class="n">target_reset_list</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">sas_event_data</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">;</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">sas_event_data</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">;</span>

	<span class="n">vtarget</span> <span class="o">=</span> <span class="n">mptsas_find_vtarget</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vtarget</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mptsas_block_io_starget</span><span class="p">(</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">starget</span><span class="p">);</span>
		<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* block IO */</span>
	<span class="p">}</span>

	<span class="n">target_reset_list</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_target_reset_event</span><span class="p">),</span>
	    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target_reset_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			<span class="s">&quot;%s, failed to allocate mem @%d..!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target_reset_list</span><span class="o">-&gt;</span><span class="n">sas_event_data</span><span class="p">,</span> <span class="n">sas_event_data</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sas_event_data</span><span class="p">));</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target_reset_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">target_reset_list</span><span class="p">);</span>

	<span class="n">target_reset_list</span><span class="o">-&gt;</span><span class="n">time_count</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mptsas_target_reset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">target_reset_list</span><span class="o">-&gt;</span><span class="n">target_reset_issued</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mptsas_schedule_target_reset- send pending target reset</span>
<span class="cm"> * @iocp: per adapter object</span>
<span class="cm"> *</span>
<span class="cm"> * This function will delete scheduled target reset from the list and</span>
<span class="cm"> * try to send next target reset. This will be called from completion</span>
<span class="cm"> * context of any Task management command.</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">mptsas_schedule_target_reset</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">iocp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="p">)(</span><span class="n">iocp</span><span class="p">);</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">target_reset_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_target_reset_event</span>	<span class="o">*</span><span class="n">target_reset_list</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * issue target reset to next device in the queue</span>
<span class="cm">	 */</span>

	<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">target_reset_list</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">target_reset_list</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">mptsas_target_reset_event</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">target_reset_list</span><span class="o">-&gt;</span><span class="n">sas_event_data</span><span class="p">.</span><span class="n">TargetID</span><span class="p">;</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">target_reset_list</span><span class="o">-&gt;</span><span class="n">sas_event_data</span><span class="p">.</span><span class="n">Bus</span><span class="p">;</span>
	<span class="n">target_reset_list</span><span class="o">-&gt;</span><span class="n">time_count</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mptsas_target_reset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span>
		<span class="n">target_reset_list</span><span class="o">-&gt;</span><span class="n">target_reset_issued</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *	mptsas_taskmgmt_complete - complete SAS task management function</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Completion for TARGET_RESET after NOT_RESPONDING_EVENT, enable work</span>
<span class="cm"> *	queue to finish off removing device from upper layers. then send next</span>
<span class="cm"> *	TARGET_RESET in the queue.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_taskmgmt_complete</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>
        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">target_reset_list</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_target_reset_event</span>	<span class="o">*</span><span class="n">target_reset_list</span><span class="p">;</span>
	<span class="n">SCSITaskMgmtReply_t</span> <span class="o">*</span><span class="n">pScsiTmReply</span><span class="p">;</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;TaskMgmt completed: &quot;</span>
	    <span class="s">&quot;(mf = %p, mr = %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mr</span><span class="p">));</span>

	<span class="n">pScsiTmReply</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSITaskMgmtReply_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pScsiTmReply</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;</span><span class="se">\t</span><span class="s">TaskMgmt completed: fw_channel = %d, fw_id = %d,</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;</span><span class="se">\t</span><span class="s">task_type = 0x%02X, iocstatus = 0x%04X &quot;</span>
		    <span class="s">&quot;loginfo = 0x%08X,</span><span class="se">\n\t</span><span class="s">response_code = 0x%02X, &quot;</span>
		    <span class="s">&quot;term_cmnds = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">,</span> <span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span>
		    <span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">TaskType</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">),</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">),</span>
		    <span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">ResponseCode</span><span class="p">,</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">TerminationCount</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">ResponseCode</span><span class="p">)</span>
			<span class="n">mptscsih_taskmgmt_response_code</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			<span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">ResponseCode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pScsiTmReply</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">TaskType</span> <span class="o">==</span>
	    <span class="n">MPI_SCSITASKMGMT_TASKTYPE_QUERY_TASK</span> <span class="o">||</span> <span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">TaskType</span> <span class="o">==</span>
	     <span class="n">MPI_SCSITASKMGMT_TASKTYPE_ABRT_TASK_SET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">MPT_DEFAULT_FRAME_SIZE</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">reply</span><span class="p">.</span><span class="n">MsgLength</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">;</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpt_clear_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">target_reset_list</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">mptsas_target_reset_event</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;TaskMgmt: completed (%d seconds)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span>
	    <span class="n">target_reset_list</span><span class="o">-&gt;</span><span class="n">time_count</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">));</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">;</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">;</span>
	<span class="n">target_reset_list</span><span class="o">-&gt;</span><span class="n">time_count</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * retry target reset</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target_reset_list</span><span class="o">-&gt;</span><span class="n">target_reset_issued</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mptsas_target_reset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span>
			<span class="n">target_reset_list</span><span class="o">-&gt;</span><span class="n">target_reset_issued</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * enable work queue to remove device from upper layers</span>
<span class="cm">	 */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target_reset_list</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_events_off</span><span class="p">)</span>
		<span class="n">mptsas_queue_device_delete</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">target_reset_list</span><span class="o">-&gt;</span><span class="n">sas_event_data</span><span class="p">);</span>


	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">schedule_target_reset</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mptscsih_ioc_reset</span>
<span class="cm"> *</span>
<span class="cm"> * @ioc</span>
<span class="cm"> * @reset_phase</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_ioc_reset</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_phase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mptscsih_ioc_reset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reset_phase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="n">SAS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reset_phase</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPT_IOC_SETUP_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: MPT_IOC_SETUP_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="n">mptsas_fw_event_off</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT_IOC_PRE_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: MPT_IOC_PRE_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT_IOC_POST_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: MPT_IOC_POST_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">;</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mptsas_cleanup_fw_event_q</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">mptsas_queue_rescan</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * enum device_state -</span>
<span class="cm"> * @DEVICE_RETRY: need to retry the TUR</span>
<span class="cm"> * @DEVICE_ERROR: TUR return error, don&#39;t add device</span>
<span class="cm"> * @DEVICE_READY: device can be added</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">device_state</span><span class="p">{</span>
	<span class="n">DEVICE_RETRY</span><span class="p">,</span>
	<span class="n">DEVICE_ERROR</span><span class="p">,</span>
	<span class="n">DEVICE_READY</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_sas_enclosure_pg0</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mptsas_enclosure</span> <span class="o">*</span><span class="n">enclosure</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">form</span><span class="p">,</span> <span class="n">u32</span> <span class="n">form_specific</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ConfigExtendedPageHeader_t</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">SasEnclosurePage0_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">le_identifier</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">MPI_SASENCLOSURE0_PAGEVERSION</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_EXTENDED</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_EXTPAGETYPE_ENCLOSURE</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">ehdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">form</span> <span class="o">+</span> <span class="n">form_specific</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* read */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">SAS_CONFIG_PAGE_TIMEOUT</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_consistent</span><span class="p">;</span>

	<span class="cm">/* save config data */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">le_identifier</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">EnclosureLogicalID</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">));</span>
	<span class="n">enclosure</span><span class="o">-&gt;</span><span class="n">enclosure_logical_id</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">le_identifier</span><span class="p">);</span>
	<span class="n">enclosure</span><span class="o">-&gt;</span><span class="n">enclosure_handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">EnclosureHandle</span><span class="p">);</span>
	<span class="n">enclosure</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
	<span class="n">enclosure</span><span class="o">-&gt;</span><span class="n">num_slot</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">NumSlots</span><span class="p">);</span>
	<span class="n">enclosure</span><span class="o">-&gt;</span><span class="n">start_slot</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">StartSlot</span><span class="p">);</span>
	<span class="n">enclosure</span><span class="o">-&gt;</span><span class="n">start_id</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">StartTargetID</span><span class="p">;</span>
	<span class="n">enclosure</span><span class="o">-&gt;</span><span class="n">start_channel</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">StartBus</span><span class="p">;</span>
	<span class="n">enclosure</span><span class="o">-&gt;</span><span class="n">sep_id</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">SEPTargetID</span><span class="p">;</span>
	<span class="n">enclosure</span><span class="o">-&gt;</span><span class="n">sep_channel</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">SEPBus</span><span class="p">;</span>

 <span class="nl">out_free_consistent:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			    <span class="n">buffer</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptsas_add_end_device - report a new end device to sas transport layer</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@phy_info: describes attached device</span>
<span class="cm"> *</span>
<span class="cm"> *	return (0) success (1) failure</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_add_end_device</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_identify</span> <span class="n">identify</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fw_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			<span class="s">&quot;%s: exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fw_id</span> <span class="o">=</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mptsas_get_rphy</span><span class="p">(</span><span class="n">phy_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			<span class="s">&quot;%s: fw_id=%d exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">mptsas_get_port</span><span class="p">(</span><span class="n">phy_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			<span class="s">&quot;%s: fw_id=%d exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">device_info</span> <span class="o">&amp;</span>
	    <span class="n">MPI_SAS_DEVICE_INFO_SSP_TARGET</span><span class="p">)</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;ssp&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">device_info</span> <span class="o">&amp;</span>
	    <span class="n">MPI_SAS_DEVICE_INFO_STP_TARGET</span><span class="p">)</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;stp&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">device_info</span> <span class="o">&amp;</span>
	    <span class="n">MPI_SAS_DEVICE_INFO_SATA_DEVICE</span><span class="p">)</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;sata&quot;</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;attaching %s device: fw_channel %d, fw_id %d,&quot;</span>
	    <span class="s">&quot; phy %d, sas_addr 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span>
	    <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
	    <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
	    <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>

	<span class="n">mptsas_parse_device_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">identify</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">);</span>
	<span class="n">rphy</span> <span class="o">=</span> <span class="n">sas_end_device_alloc</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rphy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			<span class="s">&quot;%s: fw_id=%d exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* non-fatal: an rphy can be added later */</span>
	<span class="p">}</span>

	<span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span> <span class="o">=</span> <span class="n">identify</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sas_rphy_add</span><span class="p">(</span><span class="n">rphy</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			<span class="s">&quot;%s: fw_id=%d exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="n">sas_rphy_free</span><span class="p">(</span><span class="n">rphy</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mptsas_set_rphy</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy_info</span><span class="p">,</span> <span class="n">rphy</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptsas_del_end_device - report a deleted end device to sas transport layer</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@phy_info: describes attached device</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_del_end_device</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info_parent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fw_id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sas_address</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fw_id</span> <span class="o">=</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="n">sas_address</span> <span class="o">=</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			<span class="s">&quot;%s: fw_id=%d exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rphy</span> <span class="o">=</span> <span class="n">mptsas_get_rphy</span><span class="p">(</span><span class="n">phy_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rphy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			<span class="s">&quot;%s: fw_id=%d exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_DEVICE_INFO_SSP_INITIATOR</span>
		<span class="o">||</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">device_info</span>
			<span class="o">&amp;</span> <span class="n">MPI_SAS_DEVICE_INFO_SMP_INITIATOR</span>
		<span class="o">||</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">device_info</span>
			<span class="o">&amp;</span> <span class="n">MPI_SAS_DEVICE_INFO_STP_INITIATOR</span><span class="p">)</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;initiator&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">device_info</span> <span class="o">&amp;</span>
	    <span class="n">MPI_SAS_DEVICE_INFO_SSP_TARGET</span><span class="p">)</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;ssp&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">device_info</span> <span class="o">&amp;</span>
	    <span class="n">MPI_SAS_DEVICE_INFO_STP_TARGET</span><span class="p">)</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;stp&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">device_info</span> <span class="o">&amp;</span>
	    <span class="n">MPI_SAS_DEVICE_INFO_SATA_DEVICE</span><span class="p">)</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;sata&quot;</span><span class="p">;</span>

	<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span>
	    <span class="s">&quot;removing %s device: fw_channel %d, fw_id %d, phy %d,&quot;</span>
	    <span class="s">&quot;sas_addr 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span>
	    <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sas_address</span><span class="p">);</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">mptsas_get_port</span><span class="p">(</span><span class="n">phy_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			<span class="s">&quot;%s: fw_id=%d exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">port_info</span> <span class="o">=</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">portinfo</span><span class="p">;</span>
	<span class="n">phy_info_parent</span> <span class="o">=</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">phy_info_parent</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info_parent</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_info_parent</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">!=</span>
		    <span class="n">sas_address</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_info_parent</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		    <span class="n">MYIOC_s_FMT</span> <span class="s">&quot;delete phy %d, phy-obj (0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">phy_info_parent</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span>
		    <span class="n">phy_info_parent</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
		<span class="n">sas_port_delete_phy</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">phy_info_parent</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span>
	    <span class="s">&quot;delete port %d, sas_addr (0x%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	     <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_identifier</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="n">sas_port_delete</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">mptsas_set_port</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mptsas_port_delete</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span>
<span class="nf">mptsas_refreshing_device_handles</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">mptsas_devinfo</span> <span class="o">*</span><span class="n">sas_device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">phy_info</span> <span class="o">=</span> <span class="n">mptsas_find_phyinfo_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">port_info</span> <span class="o">=</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">portinfo</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_info</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">!=</span>
			<span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">=</span>
		    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">handle_parent</span> <span class="o">=</span>
		    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle_parent</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">handle_enclosure</span> <span class="o">=</span>
		    <span class="n">sas_device</span><span class="o">-&gt;</span><span class="n">handle_enclosure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">phy_info</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mptsas_firmware_event_work - work thread for processing fw events</span>
<span class="cm"> * @work: work queue payload containing info describing the event</span>
<span class="cm"> * Context: user</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_firmware_event_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_event_work</span><span class="p">,</span> <span class="n">work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="cm">/* special rescan topology handling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">in_rescan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
				<span class="s">&quot;%s: rescan ignored as it is in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;%s: rescan after &quot;</span>
		    <span class="s">&quot;reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">in_rescan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mptsas_not_responding_devices</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">mptsas_scan_sas_topology</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">in_rescan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mptsas_free_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
		<span class="n">mptsas_fw_event_on</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* events handling turned off during host reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_events_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mptsas_free_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;%s: fw_event=(0x%p), &quot;</span>
	    <span class="s">&quot;event = (0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEVICE_STATUS_CHANGE</span>:
		<span class="n">mptsas_send_sas_event</span><span class="p">(</span><span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_INTEGRATED_RAID</span>:
		<span class="n">mptsas_send_raid_event</span><span class="p">(</span><span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_IR2</span>:
		<span class="n">mptsas_send_ir2_event</span><span class="p">(</span><span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_PERSISTENT_TABLE_FULL</span>:
		<span class="n">mptbase_sas_persist_operation</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">MPI_SAS_OP_CLEAR_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">mptsas_free_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_BROADCAST_PRIMITIVE</span>:
		<span class="n">mptsas_broadcast_primative_work</span><span class="p">(</span><span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_EXPANDER_STATUS_CHANGE</span>:
		<span class="n">mptsas_send_expander_event</span><span class="p">(</span><span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_PHY_LINK_STATUS</span>:
		<span class="n">mptsas_send_link_status_event</span><span class="p">(</span><span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_QUEUE_FULL</span>:
		<span class="n">mptsas_handle_queue_full_event</span><span class="p">(</span><span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">VirtDevice</span>	<span class="o">*</span><span class="n">vdevice</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">deleted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="s">&quot;clearing deleted flag</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * RAID volumes placed beyond the last expected port.</span>
<span class="cm">	 * Ignore sending sas mode pages in that case..</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">MPTSAS_RAID_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mptsas_add_device_component_starget_ir</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sas_read_port_mode_page</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="n">mptsas_add_device_component_starget</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">));</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">mptscsih_slave_configure</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_target_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">MPT_SCSI_HOST</span>		<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">VirtTarget</span>		<span class="o">*</span><span class="n">vtarget</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span>		<span class="o">*</span><span class="n">rphy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span>	<span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> 			 <span class="n">i</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>		<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="n">vtarget</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">VirtTarget</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vtarget</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">=</span> <span class="n">starget</span><span class="p">;</span>
	<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">ioc_id</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">=</span> <span class="n">MPT_TARGET_FLAGS_Q_YES</span><span class="p">;</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * RAID volumes placed beyond the last expected port.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">MPTSAS_RAID_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">vtarget</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="o">-&gt;</span><span class="n">NumActiveVolumes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="o">-&gt;</span>
					<span class="n">RaidVolume</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VolumeID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">channel</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="o">-&gt;</span>
					<span class="n">RaidVolume</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VolumeBus</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">raidVolume</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rphy</span> <span class="o">=</span> <span class="n">dev_to_rphy</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">!=</span>
					<span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
			<span class="n">channel</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">mptsas_set_starget</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">starget</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Exposing hidden raid components</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mptscsih_is_phys_disk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">id</span> <span class="o">=</span> <span class="n">mptscsih_raid_id_to_num</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
						<span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
				<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">|=</span>
				    <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">;</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">phys_disk_num</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">vtarget</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">vtarget</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_target_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_to_shost</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">MPT_SCSI_HOST</span>		<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span>		<span class="o">*</span><span class="n">rphy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span>	<span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> 			 <span class="n">i</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">VirtTarget</span>	<span class="o">*</span><span class="n">vtarget</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">vtarget</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="n">mptsas_del_device_component_by_os</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
	    <span class="n">starget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">MPTSAS_RAID_CHANNEL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rphy</span> <span class="o">=</span> <span class="n">dev_to_rphy</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">!=</span>
					<span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span>
			<span class="s">&quot;delete device: fw_channel %d, fw_id %d, phy %d, &quot;</span>
			<span class="s">&quot;sas_addr 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>

			<span class="n">mptsas_set_starget</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">starget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">);</span>
	<span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>	<span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="n">MPT_SCSI_HOST</span>		<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span>		<span class="o">*</span><span class="n">rphy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span>	<span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">VirtDevice</span>		<span class="o">*</span><span class="n">vdevice</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> 	<span class="o">*</span><span class="n">starget</span><span class="p">;</span>
	<span class="kt">int</span> 			<span class="n">i</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="n">vdevice</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">VirtDevice</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdevice</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;slave_alloc kzalloc(%zd) FAILED!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">VirtDevice</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">starget</span> <span class="o">=</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">MPTSAS_RAID_CHANNEL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rphy</span> <span class="o">=</span> <span class="n">dev_to_rphy</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">!=</span>
					<span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">lun</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Exposing hidden raid components</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mptscsih_is_phys_disk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			    <span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span>
			    <span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">id</span><span class="p">))</span>
				<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">no_uld_attach</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">vdevice</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">num_luns</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span> <span class="o">=</span> <span class="n">vdevice</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_qcmd_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">SCpnt</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">VirtDevice</span>	<span class="o">*</span><span class="n">vdevice</span> <span class="o">=</span> <span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdevice</span> <span class="o">||</span> <span class="o">!</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span> <span class="o">||</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">deleted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">done</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">SCpnt</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_discovery_quiesce_io</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">debug_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_SCSI</span><span class="p">)</span>
		<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mptscsih_qcmd</span><span class="p">(</span><span class="n">SCpnt</span><span class="p">,</span><span class="n">done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">mptsas_qcmd</span><span class="p">)</span>

<span class="cm">/**</span>
<span class="cm"> *	mptsas_mptsas_eh_timed_out - resets the scsi_cmnd timeout</span>
<span class="cm"> *		if the device under question is currently in the</span>
<span class="cm"> *		device removal delay.</span>
<span class="cm"> *	@sc: scsi command that the midlayer is about to time out</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">blk_eh_timer_return</span> <span class="n">mptsas_eh_timed_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>   <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">VirtDevice</span>    <span class="o">*</span><span class="n">vdevice</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">blk_eh_timer_return</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">BLK_EH_NOT_HANDLED</span><span class="p">;</span>

	<span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;: %s: Can&#39;t locate host! (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">sc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="n">SAS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;: %s: Wrong bus type (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">sc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* In case if IOC is in reset from internal context.</span>
<span class="cm">	*  Do not execute EEH for the same IOC. SML should to reset timer.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;: %s: ioc is in reset,&quot;</span>
		    <span class="s">&quot;SML need to reset the timer (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">sc</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">BLK_EH_RESET_TIMER</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vdevice</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span> <span class="o">&amp;&amp;</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">inDMD</span>
		<span class="o">||</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">deleted</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;: %s: target removed &quot;</span>
		    <span class="s">&quot;or in device removal delay (sc=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">sc</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">BLK_EH_RESET_TIMER</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">mptsas_driver_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span>				<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span>			<span class="o">=</span> <span class="s">&quot;mptsas&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_info</span>			<span class="o">=</span> <span class="n">mptscsih_proc_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>				<span class="o">=</span> <span class="s">&quot;MPT SAS Host&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>				<span class="o">=</span> <span class="n">mptscsih_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queuecommand</span>			<span class="o">=</span> <span class="n">mptsas_qcmd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_alloc</span>			<span class="o">=</span> <span class="n">mptsas_target_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_alloc</span>			<span class="o">=</span> <span class="n">mptsas_slave_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>		<span class="o">=</span> <span class="n">mptsas_slave_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">target_destroy</span>			<span class="o">=</span> <span class="n">mptsas_target_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_destroy</span>			<span class="o">=</span> <span class="n">mptscsih_slave_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_queue_depth</span> 		<span class="o">=</span> <span class="n">mptscsih_change_queue_depth</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span>		<span class="o">=</span> <span class="n">mptscsih_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span>	<span class="o">=</span> <span class="n">mptscsih_dev_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_host_reset_handler</span>		<span class="o">=</span> <span class="n">mptscsih_host_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bios_param</span>			<span class="o">=</span> <span class="n">mptscsih_bios_param</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_queue</span>			<span class="o">=</span> <span class="n">MPT_SAS_CAN_QUEUE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">this_id</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>			<span class="o">=</span> <span class="n">MPT_SCSI_SG_DEPTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_sectors</span>			<span class="o">=</span> <span class="mi">8192</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span>			<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_clustering</span>			<span class="o">=</span> <span class="n">ENABLE_CLUSTERING</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shost_attrs</span>			<span class="o">=</span> <span class="n">mptscsih_host_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mptsas_get_linkerrors</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">phy_to_ioc</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="n">ConfigExtendedPageHeader_t</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">SasPhyPage1_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* FIXME: only have link errors on local phys */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_is_sas_phy_local</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">MPI_SASPHY1_PAGEVERSION</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">1</span> <span class="cm">/* page number 1*/</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">Reserved1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_EXTENDED</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_EXTPAGETYPE_SAS_PHY</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">ehdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">phy_identifier</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* read */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">SAS_CONFIG_PAGE_TIMEOUT</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_consistent</span><span class="p">;</span>

	<span class="n">mptsas_print_phy_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">invalid_dword_count</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">InvalidDwordCount</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">running_disparity_error_count</span> <span class="o">=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">RunningDisparityErrorCount</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">loss_of_dword_sync_count</span> <span class="o">=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">LossDwordSynchCount</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_reset_problem_count</span> <span class="o">=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">PhyResetProblemCount</span><span class="p">);</span>

 <span class="nl">out_free_consistent:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			    <span class="n">buffer</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mptsas_mgmt_done</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
		<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span>
		    <span class="n">min</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">reply</span><span class="p">.</span><span class="n">MsgLength</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">;</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mptsas_phy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hard_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">phy_to_ioc</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="n">SasIoUnitControlRequest_t</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">SasIoUnitControlReply_t</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>
	<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">MPIHeader_t</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="cm">/* FIXME: fusion doesn&#39;t allow non-local phy reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi_is_sas_phy_local</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* not implemented for expanders */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">target_port_protocols</span> <span class="o">&amp;</span> <span class="n">SAS_PROTOCOL_SMP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">mutex</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">mptsasMgmtCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPIHeader_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="n">SasIoUnitControlRequest_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SasIoUnitControlRequest_t</span><span class="p">));</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_SAS_IO_UNIT_CONTROL</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">MsgContext</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">MsgContext</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">Operation</span> <span class="o">=</span> <span class="n">hard_reset</span> <span class="o">?</span>
		<span class="n">MPI_SAS_OP_PHY_HARD_RESET</span> <span class="o">:</span> <span class="n">MPI_SAS_OP_PHY_LINK_RESET</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">PhyNum</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">phy_identifier</span><span class="p">;</span>

	<span class="n">INITIALIZE_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">mpt_put_msg_frame</span><span class="p">(</span><span class="n">mptsasMgmtCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>

	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">done</span><span class="p">,</span>
			<span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeleft</span><span class="p">)</span>
			<span class="n">mpt_Soft_Hard_ResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* a reply frame is expected */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span>
	    <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* process the completed Reply Message Frame */</span>
	<span class="n">reply</span> <span class="o">=</span> <span class="p">(</span><span class="n">SasIoUnitControlReply_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span> <span class="o">!=</span> <span class="n">MPI_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;%s: IOCStatus=0x%X IOCLogInfo=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">,</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_unlock:</span>
	<span class="n">CLEAR_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_get_enclosure_identifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">identifier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">rphy_to_ioc</span><span class="p">(</span><span class="n">rphy</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_enclosure</span> <span class="n">enclosure_info</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">enclosure_handle</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">==</span>
			    <span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">enclosure_handle</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
					<span class="n">attached</span><span class="p">.</span><span class="n">handle_enclosure</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">found_info</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

 <span class="nl">found_info:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enclosure_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_enclosure</span><span class="p">));</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">mptsas_sas_enclosure_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enclosure_info</span><span class="p">,</span>
			<span class="p">(</span><span class="n">MPI_SAS_ENCLOS_PGAD_FORM_HANDLE</span> <span class="o">&lt;&lt;</span>
			 <span class="n">MPI_SAS_ENCLOS_PGAD_FORM_SHIFT</span><span class="p">),</span> <span class="n">enclosure_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="o">*</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">enclosure_info</span><span class="p">.</span><span class="n">enclosure_logical_id</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_get_bay_identifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">rphy_to_ioc</span><span class="p">(</span><span class="n">rphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">==</span>
			    <span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">slot</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mptsas_smp_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="p">((</span><span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="p">)</span> <span class="n">shost</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">SmpPassthroughRequest_t</span> <span class="o">*</span><span class="n">smpreq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">next_rq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flagsLength</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">psge</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sas_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s: the smp response space is missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* do we need to support multiple segments? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s: multiple segments req %u %u, rsp %u %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
		    <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bio</span><span class="o">-&gt;</span><span class="n">bi_vcnt</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rsp</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">mptsasMgmtCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smpreq</span> <span class="o">=</span> <span class="p">(</span><span class="n">SmpPassthroughRequest_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">smpreq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">smpreq</span><span class="p">));</span>

	<span class="n">smpreq</span><span class="o">-&gt;</span><span class="n">RequestDataLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">smpreq</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_SMP_PASSTHROUGH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rphy</span><span class="p">)</span>
		<span class="n">sas_address</span> <span class="o">=</span> <span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
		<span class="n">port_info</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_port_info</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span> <span class="o">&amp;&amp;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">)</span>
			<span class="n">sas_address</span> <span class="o">=</span>
				<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">smpreq</span><span class="o">-&gt;</span><span class="n">SASAddress</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">sas_address</span><span class="p">);</span>

	<span class="n">psge</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="n">SmpPassthroughRequest_t</span><span class="p">,</span> <span class="n">SGL</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">));</span>

	<span class="cm">/* request */</span>
	<span class="n">flagsLength</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPI_SGE_FLAGS_SIMPLE_ELEMENT</span> <span class="o">|</span>
		       <span class="n">MPI_SGE_FLAGS_END_OF_BUFFER</span> <span class="o">|</span>
		       <span class="n">MPI_SGE_FLAGS_DIRECTION</span><span class="p">)</span>
		       <span class="o">&lt;&lt;</span> <span class="n">MPI_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="n">flagsLength</span> <span class="o">|=</span> <span class="p">(</span><span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">dma_addr_out</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">bio_data</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">),</span>
				      <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_addr_out</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">put_mf</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">flagsLength</span><span class="p">,</span> <span class="n">dma_addr_out</span><span class="p">);</span>
	<span class="n">psge</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>

	<span class="cm">/* response */</span>
	<span class="n">flagsLength</span> <span class="o">=</span> <span class="n">MPI_SGE_FLAGS_SIMPLE_ELEMENT</span> <span class="o">|</span>
		<span class="n">MPI_SGE_FLAGS_SYSTEM_ADDRESS</span> <span class="o">|</span>
		<span class="n">MPI_SGE_FLAGS_IOC_TO_HOST</span> <span class="o">|</span>
		<span class="n">MPI_SGE_FLAGS_END_OF_BUFFER</span><span class="p">;</span>

	<span class="n">flagsLength</span> <span class="o">=</span> <span class="n">flagsLength</span> <span class="o">&lt;&lt;</span> <span class="n">MPI_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="n">flagsLength</span> <span class="o">|=</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rsp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">dma_addr_in</span> <span class="o">=</span>  <span class="n">pci_map_single</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">bio_data</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">bio</span><span class="p">),</span>
				      <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_addr_in</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">flagsLength</span><span class="p">,</span> <span class="n">dma_addr_in</span><span class="p">);</span>

	<span class="n">INITIALIZE_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">mpt_put_msg_frame</span><span class="p">(</span><span class="n">mptsasMgmtCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>

	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">done</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
		<span class="n">mf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeleft</span><span class="p">)</span>
			<span class="n">mpt_Soft_Hard_ResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SmpPassthroughReply_t</span> <span class="o">*</span><span class="n">smprep</span><span class="p">;</span>

		<span class="n">smprep</span> <span class="o">=</span> <span class="p">(</span><span class="n">SmpPassthroughReply_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">reply</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">sense</span><span class="p">,</span> <span class="n">smprep</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">smprep</span><span class="p">));</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">sense_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">smprep</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">resid_len</span> <span class="o">-=</span> <span class="n">smprep</span><span class="o">-&gt;</span><span class="n">ResponseDataLength</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
		    <span class="s">&quot;%s: smp passthru reply failed to be returned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">unmap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_addr_out</span><span class="p">)</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">dma_addr_out</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
				 <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_addr_in</span><span class="p">)</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">dma_addr_in</span><span class="p">,</span> <span class="n">blk_rq_bytes</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span>
				 <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
<span class="nl">put_mf:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mf</span><span class="p">)</span>
		<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">CLEAR_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sas_function_template</span> <span class="n">mptsas_transport_functions</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_linkerrors</span>		<span class="o">=</span> <span class="n">mptsas_get_linkerrors</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_enclosure_identifier</span> <span class="o">=</span> <span class="n">mptsas_get_enclosure_identifier</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_bay_identifier</span>	<span class="o">=</span> <span class="n">mptsas_get_bay_identifier</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_reset</span>		<span class="o">=</span> <span class="n">mptsas_phy_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">smp_handler</span>		<span class="o">=</span> <span class="n">mptsas_smp_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_transport_template</span> <span class="o">*</span><span class="n">mptsas_transport_template</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_sas_io_unit_pg0</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ConfigExtendedPageHeader_t</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">SasIOUnitPage0_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">MPI_SASIOUNITPAGE0_PAGEVERSION</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">Reserved1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_EXTENDED</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_EXTPAGETYPE_SAS_IO_UNIT</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">ehdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* read */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">SAS_CONFIG_PAGE_TIMEOUT</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_consistent</span><span class="p">;</span>

	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">NumPhys</span><span class="p">;</span>
	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_phyinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_consistent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">nvdata_version_persistent</span> <span class="o">=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">NvdataVersionPersistent</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">nvdata_version_default</span> <span class="o">=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">NvdataVersionDefault</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mptsas_print_phy_data</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_id</span> <span class="o">=</span>
		    <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Port</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">negotiated_link_rate</span> <span class="o">=</span>
		    <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">NegotiatedLinkRate</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">portinfo</span> <span class="o">=</span> <span class="n">port_info</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ControllerDevHandle</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out_free_consistent:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			    <span class="n">buffer</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_sas_io_unit_pg1</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ConfigExtendedPageHeader_t</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">SasIOUnitPage1_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">device_missing_delay</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ConfigExtendedPageHeader_t</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CONFIGPARMS</span><span class="p">));</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">ehdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">SAS_CONFIG_PAGE_TIMEOUT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_EXTENDED</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">ExtPageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_EXTPAGETYPE_SAS_IO_UNIT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">MPI_SASIOUNITPAGE1_PAGEVERSION</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_consistent</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">io_missing_delay</span>  <span class="o">=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">IODeviceMissingDelay</span><span class="p">);</span>
	<span class="n">device_missing_delay</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">ReportDeviceMissingDelay</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">device_missing_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">device_missing_delay</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_IOUNIT1_REPORT_MISSING_UNIT_16</span><span class="p">)</span> <span class="o">?</span>
	    <span class="p">(</span><span class="n">device_missing_delay</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_IOUNIT1_REPORT_MISSING_TIMEOUT_MASK</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">:</span>
	    <span class="n">device_missing_delay</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_IOUNIT1_REPORT_MISSING_TIMEOUT_MASK</span><span class="p">;</span>

 <span class="nl">out_free_consistent:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			    <span class="n">buffer</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_sas_phy_pg0</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">form</span><span class="p">,</span> <span class="n">u32</span> <span class="n">form_specific</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ConfigExtendedPageHeader_t</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">SasPhyPage0_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">MPI_SASPHY0_PAGEVERSION</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">Reserved1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_EXTENDED</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_EXTPAGETYPE_SAS_PHY</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">ehdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* read */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">SAS_CONFIG_PAGE_TIMEOUT</span><span class="p">;</span>

	<span class="cm">/* Get Phy Pg 0 for each Phy. */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">form</span> <span class="o">+</span> <span class="n">form_specific</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_consistent</span><span class="p">;</span>

	<span class="n">mptsas_print_phy_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">hw_link_rate</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">HwLinkRate</span><span class="p">;</span>
	<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">programmed_link_rate</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">ProgrammedLinkRate</span><span class="p">;</span>
	<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">OwnerDevHandle</span><span class="p">);</span>
	<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">AttachedDevHandle</span><span class="p">);</span>

 <span class="nl">out_free_consistent:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			    <span class="n">buffer</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_sas_device_pg0</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mptsas_devinfo</span> <span class="o">*</span><span class="n">device_info</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">form</span><span class="p">,</span> <span class="n">u32</span> <span class="n">form_specific</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ConfigExtendedPageHeader_t</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">SasDevicePage0_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">sas_address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">MPI_SASDEVICE0_PAGEVERSION</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">Reserved1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_EXTENDED</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_EXTPAGETYPE_SAS_DEVICE</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">ehdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">form</span> <span class="o">+</span> <span class="n">form_specific</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* read */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">SAS_CONFIG_PAGE_TIMEOUT</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">device_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_devinfo</span><span class="p">));</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_CONFIG_INVALID_PAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_consistent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_consistent</span><span class="p">;</span>

	<span class="n">mptsas_print_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">device_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_devinfo</span><span class="p">));</span>
	<span class="n">device_info</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">);</span>
	<span class="n">device_info</span><span class="o">-&gt;</span><span class="n">handle_parent</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">ParentDevHandle</span><span class="p">);</span>
	<span class="n">device_info</span><span class="o">-&gt;</span><span class="n">handle_enclosure</span> <span class="o">=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">EnclosureHandle</span><span class="p">);</span>
	<span class="n">device_info</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Slot</span><span class="p">);</span>
	<span class="n">device_info</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">PhyNum</span><span class="p">;</span>
	<span class="n">device_info</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">PhysicalPort</span><span class="p">;</span>
	<span class="n">device_info</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">;</span>
	<span class="n">device_info</span><span class="o">-&gt;</span><span class="n">phys_disk_num</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">device_info</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">SASAddress</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">));</span>
	<span class="n">device_info</span><span class="o">-&gt;</span><span class="n">sas_address</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="n">device_info</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">=</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">DeviceInfo</span><span class="p">);</span>
	<span class="n">device_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>

 <span class="nl">out_free_consistent:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			    <span class="n">buffer</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_sas_expander_pg0</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">form</span><span class="p">,</span> <span class="n">u32</span> <span class="n">form_specific</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ConfigExtendedPageHeader_t</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">SasExpanderPage0_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">sas_address</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">port_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_portinfo</span><span class="p">));</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">MPI_SASEXPANDER0_PAGEVERSION</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">Reserved1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_EXTENDED</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_EXTPAGETYPE_SAS_EXPANDER</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">ehdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">form</span> <span class="o">+</span> <span class="n">form_specific</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* read */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">SAS_CONFIG_PAGE_TIMEOUT</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">port_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_portinfo</span><span class="p">));</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_CONFIG_INVALID_PAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_consistent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_consistent</span><span class="p">;</span>

	<span class="cm">/* save config data */</span>
	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">=</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">NumPhys</span><span class="p">)</span> <span class="o">?</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">NumPhys</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_phyinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_consistent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">SASAddress</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">portinfo</span> <span class="o">=</span> <span class="n">port_info</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">);</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">=</span>
		    <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">handle_parent</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">ParentDevHandle</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out_free_consistent:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			    <span class="n">buffer</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_sas_expander_pg1</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">form</span><span class="p">,</span> <span class="n">u32</span> <span class="n">form_specific</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ConfigExtendedPageHeader_t</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">SasExpanderPage1_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">MPI_SASEXPANDER1_PAGEVERSION</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">Reserved1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">Reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_EXTENDED</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_EXTPAGETYPE_SAS_EXPANDER</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">ehdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">form</span> <span class="o">+</span> <span class="n">form_specific</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* read */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">SAS_CONFIG_PAGE_TIMEOUT</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_CONFIG_INVALID_PAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_consistent</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_consistent</span><span class="p">;</span>


	<span class="n">mptsas_print_expander_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="cm">/* save config data */</span>
	<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">PhyIdentifier</span><span class="p">;</span>
	<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">PhysicalPort</span><span class="p">;</span>
	<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">negotiated_link_rate</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">NegotiatedLinkRate</span><span class="p">;</span>
	<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">programmed_link_rate</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">ProgrammedLinkRate</span><span class="p">;</span>
	<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">hw_link_rate</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">HwLinkRate</span><span class="p">;</span>
	<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">OwnerDevHandle</span><span class="p">);</span>
	<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">AttachedDevHandle</span><span class="p">);</span>

 <span class="nl">out_free_consistent:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			    <span class="n">buffer</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">rep_manu_request</span><span class="p">{</span>
	<span class="n">u8</span> <span class="n">smp_frame_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">request_length</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rep_manu_reply</span><span class="p">{</span>
	<span class="n">u8</span> <span class="n">smp_frame_type</span><span class="p">;</span> <span class="cm">/* 0x41 */</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">;</span> <span class="cm">/* 0x01 */</span>
	<span class="n">u8</span> <span class="n">function_result</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">response_length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">expander_change_count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved0</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">sas_format</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved1</span><span class="o">:</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">vendor_id</span><span class="p">[</span><span class="n">SAS_EXPANDER_VENDOR_ID_LEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">product_id</span><span class="p">[</span><span class="n">SAS_EXPANDER_PRODUCT_ID_LEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">product_rev</span><span class="p">[</span><span class="n">SAS_EXPANDER_PRODUCT_REV_LEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">component_vendor_id</span><span class="p">[</span><span class="n">SAS_EXPANDER_COMPONENT_VENDOR_ID_LEN</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">component_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">component_revision_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved3</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vendor_specific</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm">  * mptsas_exp_repmanufacture_info -</span>
<span class="cm">  * @ioc: per adapter object</span>
<span class="cm">  * @sas_address: expander sas address</span>
<span class="cm">  * @edev: the sas_expander_device object</span>
<span class="cm">  *</span>
<span class="cm">  * Fills in the sas_expander_device object when SMP port is created.</span>
<span class="cm">  *</span>
<span class="cm">  * Returns 0 for success, non-zero for failure.</span>
<span class="cm">  */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_exp_repmanufacture_info</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">sas_address</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sas_expander_device</span> <span class="o">*</span><span class="n">edev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">SmpPassthroughRequest_t</span> <span class="o">*</span><span class="n">smpreq</span><span class="p">;</span>
	<span class="n">SmpPassthroughReply_t</span> <span class="o">*</span><span class="n">smprep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rep_manu_reply</span> <span class="o">*</span><span class="n">manufacture_reply</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rep_manu_request</span> <span class="o">*</span><span class="n">manufacture_request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flagsLength</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">psge</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">data_out_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sz</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;%s: host reset in progress!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">mptsasMgmtCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smpreq</span> <span class="o">=</span> <span class="p">(</span><span class="n">SmpPassthroughRequest_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">smpreq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">smpreq</span><span class="p">));</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rep_manu_request</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rep_manu_reply</span><span class="p">);</span>

	<span class="n">data_out</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_out_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Memory allocation failure at %s:%d/%s()!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">put_mf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">manufacture_request</span> <span class="o">=</span> <span class="n">data_out</span><span class="p">;</span>
	<span class="n">manufacture_request</span><span class="o">-&gt;</span><span class="n">smp_frame_type</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">manufacture_request</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">manufacture_request</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">manufacture_request</span><span class="o">-&gt;</span><span class="n">request_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">smpreq</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_SMP_PASSTHROUGH</span><span class="p">;</span>
	<span class="n">smpreq</span><span class="o">-&gt;</span><span class="n">PhysicalPort</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">smpreq</span><span class="o">-&gt;</span><span class="n">SASAddress</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="n">smpreq</span><span class="o">-&gt;</span><span class="n">RequestDataLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rep_manu_request</span><span class="p">);</span>

	<span class="n">psge</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="n">SmpPassthroughRequest_t</span><span class="p">,</span> <span class="n">SGL</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">));</span>

	<span class="n">flagsLength</span> <span class="o">=</span> <span class="n">MPI_SGE_FLAGS_SIMPLE_ELEMENT</span> <span class="o">|</span>
		<span class="n">MPI_SGE_FLAGS_SYSTEM_ADDRESS</span> <span class="o">|</span>
		<span class="n">MPI_SGE_FLAGS_HOST_TO_IOC</span> <span class="o">|</span>
		<span class="n">MPI_SGE_FLAGS_END_OF_BUFFER</span><span class="p">;</span>
	<span class="n">flagsLength</span> <span class="o">=</span> <span class="n">flagsLength</span> <span class="o">&lt;&lt;</span> <span class="n">MPI_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="n">flagsLength</span> <span class="o">|=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rep_manu_request</span><span class="p">);</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">flagsLength</span><span class="p">,</span> <span class="n">data_out_dma</span><span class="p">);</span>
	<span class="n">psge</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>

	<span class="n">flagsLength</span> <span class="o">=</span> <span class="n">MPI_SGE_FLAGS_SIMPLE_ELEMENT</span> <span class="o">|</span>
		<span class="n">MPI_SGE_FLAGS_SYSTEM_ADDRESS</span> <span class="o">|</span>
		<span class="n">MPI_SGE_FLAGS_IOC_TO_HOST</span> <span class="o">|</span>
		<span class="n">MPI_SGE_FLAGS_END_OF_BUFFER</span><span class="p">;</span>
	<span class="n">flagsLength</span> <span class="o">=</span> <span class="n">flagsLength</span> <span class="o">&lt;&lt;</span> <span class="n">MPI_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="n">flagsLength</span> <span class="o">|=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rep_manu_reply</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">flagsLength</span><span class="p">,</span> <span class="n">data_out_dma</span> <span class="o">+</span>
	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rep_manu_request</span><span class="p">));</span>

	<span class="n">INITIALIZE_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">mpt_put_msg_frame</span><span class="p">(</span><span class="n">mptsasMgmtCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>

	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">done</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
		<span class="n">mf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeleft</span><span class="p">)</span>
			<span class="n">mpt_Soft_Hard_ResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">smprep</span> <span class="o">=</span> <span class="p">(</span><span class="n">SmpPassthroughReply_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">smprep</span><span class="o">-&gt;</span><span class="n">ResponseDataLength</span><span class="p">)</span> <span class="o">!=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rep_manu_reply</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">manufacture_reply</span> <span class="o">=</span> <span class="n">data_out</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rep_manu_request</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">vendor_id</span><span class="p">,</span> <span class="n">manufacture_reply</span><span class="o">-&gt;</span><span class="n">vendor_id</span><span class="p">,</span>
		<span class="n">SAS_EXPANDER_VENDOR_ID_LEN</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">,</span> <span class="n">manufacture_reply</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">,</span>
		<span class="n">SAS_EXPANDER_PRODUCT_ID_LEN</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">product_rev</span><span class="p">,</span> <span class="n">manufacture_reply</span><span class="o">-&gt;</span><span class="n">product_rev</span><span class="p">,</span>
		<span class="n">SAS_EXPANDER_PRODUCT_REV_LEN</span><span class="p">);</span>
	<span class="n">edev</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">manufacture_reply</span><span class="o">-&gt;</span><span class="n">sas_format</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">manufacture_reply</span><span class="o">-&gt;</span><span class="n">sas_format</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">edev</span><span class="o">-&gt;</span><span class="n">component_vendor_id</span><span class="p">,</span>
			<span class="n">manufacture_reply</span><span class="o">-&gt;</span><span class="n">component_vendor_id</span><span class="p">,</span>
				<span class="n">SAS_EXPANDER_COMPONENT_VENDOR_ID_LEN</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">manufacture_reply</span><span class="o">-&gt;</span><span class="n">component_id</span><span class="p">;</span>
		<span class="n">edev</span><span class="o">-&gt;</span><span class="n">component_id</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">edev</span><span class="o">-&gt;</span><span class="n">component_revision_id</span> <span class="o">=</span>
			<span class="n">manufacture_reply</span><span class="o">-&gt;</span><span class="n">component_revision_id</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			<span class="s">&quot;%s: smp passthru reply failed to be returned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out_free:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_out_dma</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">data_out</span><span class="p">,</span> <span class="n">data_out_dma</span><span class="p">);</span>
<span class="nl">put_mf:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mf</span><span class="p">)</span>
		<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">CLEAR_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
 <span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_parse_device_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">sas_identify</span> <span class="o">*</span><span class="n">identify</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">mptsas_devinfo</span> <span class="o">*</span><span class="n">device_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">protocols</span><span class="p">;</span>

	<span class="n">identify</span><span class="o">-&gt;</span><span class="n">sas_address</span> <span class="o">=</span> <span class="n">device_info</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">;</span>
	<span class="n">identify</span><span class="o">-&gt;</span><span class="n">phy_identifier</span> <span class="o">=</span> <span class="n">device_info</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill in Phy Initiator Port Protocol.</span>
<span class="cm">	 * Bits 6:3, more than one bit can be set, fall through cases.</span>
<span class="cm">	 */</span>
	<span class="n">protocols</span> <span class="o">=</span> <span class="n">device_info</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="mh">0x78</span><span class="p">;</span>
	<span class="n">identify</span><span class="o">-&gt;</span><span class="n">initiator_port_protocols</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">protocols</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_DEVICE_INFO_SSP_INITIATOR</span><span class="p">)</span>
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">initiator_port_protocols</span> <span class="o">|=</span> <span class="n">SAS_PROTOCOL_SSP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">protocols</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_DEVICE_INFO_STP_INITIATOR</span><span class="p">)</span>
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">initiator_port_protocols</span> <span class="o">|=</span> <span class="n">SAS_PROTOCOL_STP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">protocols</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_DEVICE_INFO_SMP_INITIATOR</span><span class="p">)</span>
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">initiator_port_protocols</span> <span class="o">|=</span> <span class="n">SAS_PROTOCOL_SMP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">protocols</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_DEVICE_INFO_SATA_HOST</span><span class="p">)</span>
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">initiator_port_protocols</span> <span class="o">|=</span> <span class="n">SAS_PROTOCOL_SATA</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill in Phy Target Port Protocol.</span>
<span class="cm">	 * Bits 10:7, more than one bit can be set, fall through cases.</span>
<span class="cm">	 */</span>
	<span class="n">protocols</span> <span class="o">=</span> <span class="n">device_info</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">&amp;</span> <span class="mh">0x780</span><span class="p">;</span>
	<span class="n">identify</span><span class="o">-&gt;</span><span class="n">target_port_protocols</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">protocols</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_DEVICE_INFO_SSP_TARGET</span><span class="p">)</span>
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">target_port_protocols</span> <span class="o">|=</span> <span class="n">SAS_PROTOCOL_SSP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">protocols</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_DEVICE_INFO_STP_TARGET</span><span class="p">)</span>
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">target_port_protocols</span> <span class="o">|=</span> <span class="n">SAS_PROTOCOL_STP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">protocols</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_DEVICE_INFO_SMP_TARGET</span><span class="p">)</span>
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">target_port_protocols</span> <span class="o">|=</span> <span class="n">SAS_PROTOCOL_SMP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">protocols</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_DEVICE_INFO_SATA_DEVICE</span><span class="p">)</span>
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">target_port_protocols</span> <span class="o">|=</span> <span class="n">SAS_PROTOCOL_SATA</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill in Attached device type.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">device_info</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">&amp;</span>
			<span class="n">MPI_SAS_DEVICE_INFO_MASK_DEVICE_TYPE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_SAS_DEVICE_INFO_NO_DEVICE</span>:
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">SAS_PHY_UNUSED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SAS_DEVICE_INFO_END_DEVICE</span>:
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">SAS_END_DEVICE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SAS_DEVICE_INFO_EDGE_EXPANDER</span>:
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">SAS_EDGE_EXPANDER_DEVICE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SAS_DEVICE_INFO_FANOUT_EXPANDER</span>:
		<span class="n">identify</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">SAS_FANOUT_EXPANDER_DEVICE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mptsas_probe_one_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">VirtTarget</span> <span class="o">*</span><span class="n">vtarget</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy</span> <span class="o">=</span> <span class="n">sas_phy_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">phy</span> <span class="o">=</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="n">mptsas_parse_device_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set Negotiated link rate.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">negotiated_link_rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_SAS_IOUNIT0_RATE_PHY_DISABLED</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span> <span class="n">SAS_PHY_DISABLED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SAS_IOUNIT0_RATE_FAILED_SPEED_NEGOTIATION</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_FAILED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SAS_IOUNIT0_RATE_1_5</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_1_5_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SAS_IOUNIT0_RATE_3_0</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_3_0_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SAS_IOUNIT0_RATE_6_0</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_6_0_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SAS_IOUNIT0_RATE_SATA_OOB_COMPLETE</span>:
	<span class="k">case</span> <span class="n">MPI_SAS_IOUNIT0_RATE_UNKNOWN</span>:
	<span class="nl">default:</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_UNKNOWN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set Max hardware link rate.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">hw_link_rate</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_PHY0_PRATE_MAX_RATE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_SAS_PHY0_HWRATE_MAX_RATE_1_5</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate_hw</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_1_5_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SAS_PHY0_PRATE_MAX_RATE_3_0</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate_hw</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_3_0_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set Max programmed link rate.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">programmed_link_rate</span> <span class="o">&amp;</span>
			<span class="n">MPI_SAS_PHY0_PRATE_MAX_RATE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_SAS_PHY0_PRATE_MAX_RATE_1_5</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_1_5_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SAS_PHY0_PRATE_MAX_RATE_3_0</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">maximum_linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_3_0_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set Min hardware link rate.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">hw_link_rate</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_PHY0_HWRATE_MIN_RATE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_SAS_PHY0_HWRATE_MIN_RATE_1_5</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate_hw</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_1_5_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SAS_PHY0_PRATE_MIN_RATE_3_0</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate_hw</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_3_0_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set Min programmed link rate.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">programmed_link_rate</span> <span class="o">&amp;</span>
			<span class="n">MPI_SAS_PHY0_PRATE_MIN_RATE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_SAS_PHY0_PRATE_MIN_RATE_1_5</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_1_5_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_SAS_PHY0_PRATE_MIN_RATE_3_0</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">minimum_linkrate</span> <span class="o">=</span> <span class="n">SAS_LINK_RATE_3_0_GBPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">sas_phy_add</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sas_phy_free</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="n">phy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">handle</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">mptsas_get_port</span><span class="p">(</span><span class="n">phy_info</span><span class="p">);</span>
	<span class="n">ioc</span> <span class="o">=</span> <span class="n">phy_to_ioc</span><span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">sas_port_add_phy</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port</span> <span class="o">=</span> <span class="n">sas_port_alloc_num</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">sas_port_add</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
					<span class="s">&quot;%s: exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mptsas_set_port</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy_info</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
			<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			    <span class="n">MYIOC_s_FMT</span> <span class="s">&quot;add port %d, sas_addr (0x%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_identifier</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">phy_info</span><span class="o">-&gt;</span>
			    <span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">dsaswideprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			<span class="s">&quot;sas_port_add_phy: phy_id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">));</span>
		<span class="n">sas_port_add_phy</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
		<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">sas_port_add_phy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		    <span class="n">MYIOC_s_FMT</span> <span class="s">&quot;add phy %d, phy-obj (0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		     <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mptsas_get_rphy</span><span class="p">(</span><span class="n">phy_info</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">port</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rphy</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sas_identify</span> <span class="n">identify</span><span class="p">;</span>

		<span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Let the hotplug_work thread handle processing</span>
<span class="cm">		 * the adding/removing of devices that occur</span>
<span class="cm">		 * after start of day.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mptsas_is_end_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">handle_parent</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mptsas_parse_device_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">identify</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_is_host_device</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">port_info</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_port_info</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">==</span>
				    <span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sas_port_mark_backlink</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scsi_is_sas_rphy</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">parent_rphy</span> <span class="o">=</span> <span class="n">dev_to_rphy</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">==</span>
			    <span class="n">parent_rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sas_port_mark_backlink</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">identify</span><span class="p">.</span><span class="n">device_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SAS_END_DEVICE</span>:
			<span class="n">rphy</span> <span class="o">=</span> <span class="n">sas_end_device_alloc</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SAS_EDGE_EXPANDER_DEVICE</span>:
		<span class="k">case</span> <span class="n">SAS_FANOUT_EXPANDER_DEVICE</span>:
			<span class="n">rphy</span> <span class="o">=</span> <span class="n">sas_expander_alloc</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">identify</span><span class="p">.</span><span class="n">device_type</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">rphy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rphy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
				<span class="s">&quot;%s: exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span> <span class="o">=</span> <span class="n">identify</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">sas_rphy_add</span><span class="p">(</span><span class="n">rphy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
				<span class="s">&quot;%s: exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="n">sas_rphy_free</span><span class="p">(</span><span class="n">rphy</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mptsas_set_rphy</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy_info</span><span class="p">,</span> <span class="n">rphy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">SAS_EDGE_EXPANDER_DEVICE</span> <span class="o">||</span>
			<span class="n">identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">SAS_FANOUT_EXPANDER_DEVICE</span><span class="p">)</span>
				<span class="n">mptsas_exp_repmanufacture_info</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
					<span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">,</span>
					<span class="n">rphy_to_expander_device</span><span class="p">(</span><span class="n">rphy</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* If the device exists,verify it wasn&#39;t previously flagged</span>
<span class="cm">	as a missing device.  If so, clear it */</span>
	<span class="n">vtarget</span> <span class="o">=</span> <span class="n">mptsas_find_vtarget</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span>
	    <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vtarget</span> <span class="o">&amp;&amp;</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">inDMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Device returned, unsetting inDMD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">inDMD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_probe_hba_phys</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">,</span> <span class="o">*</span><span class="n">hba</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">hba</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_portinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">hba</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mptsas_sas_io_unit_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">hba</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_port_info</span><span class="p">;</span>

	<span class="n">mptsas_sas_io_unit_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="n">port_info</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_port_info</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_port_info</span> <span class="o">=</span> <span class="n">port_info</span> <span class="o">=</span> <span class="n">hba</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_port_num_phy</span> <span class="o">=</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hba</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">negotiated_link_rate</span> <span class="o">=</span>
				<span class="n">hba</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">negotiated_link_rate</span><span class="p">;</span>
			<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span> <span class="o">=</span>
				<span class="n">hba</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span><span class="p">;</span>
			<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_id</span> <span class="o">=</span>
				<span class="n">hba</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_id</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hba</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
		<span class="n">hba</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
<span class="cp">#if defined(CPQ_CIM)</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">num_ports</span> <span class="o">=</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mptsas_sas_phy_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="p">(</span><span class="n">MPI_SAS_PHY_PGAD_FORM_PHY_NUMBER</span> <span class="o">&lt;&lt;</span>
			 <span class="n">MPI_SAS_PHY_PGAD_FORM_SHIFT</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span>
		    <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">mptsas_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">,</span>
			<span class="p">(</span><span class="n">MPI_SAS_DEVICE_PGAD_FORM_HANDLE</span> <span class="o">&lt;&lt;</span>
			 <span class="n">MPI_SAS_DEVICE_PGAD_FORM_SHIFT</span><span class="p">),</span>
			 <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_port_sas_addr</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_port_sas_addr</span> <span class="o">=</span>
			    <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span>
		    <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">handle</span><span class="p">)</span>
			<span class="n">mptsas_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">,</span>
				<span class="p">(</span><span class="n">MPI_SAS_DEVICE_PGAD_FORM_HANDLE</span> <span class="o">&lt;&lt;</span>
				 <span class="n">MPI_SAS_DEVICE_PGAD_FORM_SHIFT</span><span class="p">),</span>
				<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mptsas_setup_wide_ports</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">port_info</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_index</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mptsas_probe_one_phy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">shost_gendev</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_free_port_info:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hba</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_expander_refresh</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span>	<span class="o">*</span><span class="n">rphy</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span>		<span class="n">sas_address</span><span class="p">;</span> <span class="cm">/* expander sas address */</span>
	<span class="n">u32</span>		<span class="n">handle</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">sas_address</span> <span class="o">=</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mptsas_sas_expander_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
		    <span class="p">(</span><span class="n">MPI_SAS_EXPAND_PGAD_FORM_HANDLE_PHY_NUM</span> <span class="o">&lt;&lt;</span>
		    <span class="n">MPI_SAS_EXPAND_PGAD_FORM_SHIFT</span><span class="p">),</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">handle</span><span class="p">);</span>

		<span class="n">mptsas_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">MPI_SAS_DEVICE_PGAD_FORM_HANDLE</span> <span class="o">&lt;&lt;</span>
		    <span class="n">MPI_SAS_DEVICE_PGAD_FORM_SHIFT</span><span class="p">),</span>
		    <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span>
		    <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy_id</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mptsas_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">MPI_SAS_DEVICE_PGAD_FORM_HANDLE</span> <span class="o">&lt;&lt;</span>
			     <span class="n">MPI_SAS_DEVICE_PGAD_FORM_SHIFT</span><span class="p">),</span>
			    <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>
			<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span>
			    <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy_id</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="n">parent</span> <span class="o">=</span> <span class="n">mptsas_find_portinfo_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">handle_parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">parent_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">parent_dev</span><span class="p">;</span>
	    <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">==</span> <span class="n">sas_address</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rphy</span> <span class="o">=</span> <span class="n">mptsas_get_rphy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">parent_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>

	<span class="n">mptsas_setup_wide_ports</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">port_info</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_index</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mptsas_probe_one_phy</span><span class="p">(</span><span class="n">parent_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_expander_event_add</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">MpiEventDataSasExpanderStatusChange_t</span> <span class="o">*</span><span class="n">expander_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">sas_address</span><span class="p">;</span>

	<span class="n">port_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_portinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_info</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">=</span> <span class="p">(</span><span class="n">expander_data</span><span class="o">-&gt;</span><span class="n">NumPhys</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">expander_data</span><span class="o">-&gt;</span><span class="n">NumPhys</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">,</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_phyinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">)</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">expander_data</span><span class="o">-&gt;</span><span class="n">SASAddress</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">portinfo</span> <span class="o">=</span> <span class="n">port_info</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">expander_data</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">);</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">=</span>
		    <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">handle_parent</span> <span class="o">=</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">expander_data</span><span class="o">-&gt;</span><span class="n">ParentDevHandle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;add expander: num_phys %d, &quot;</span>
	    <span class="s">&quot;sas_addr (0x%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sas_address</span><span class="p">);</span>

	<span class="n">mptsas_expander_refresh</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">port_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mptsas_delete_expander_siblings - remove siblings attached to expander</span>
<span class="cm"> * @ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> * @parent: the parent port_info object</span>
<span class="cm"> * @expander: the expander port_info object</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_delete_expander_siblings</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mptsas_portinfo</span>
    <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">expander</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_rphy</span> <span class="o">*</span><span class="n">rphy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">phy_info</span> <span class="o">=</span> <span class="n">expander</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">expander</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rphy</span> <span class="o">=</span> <span class="n">mptsas_get_rphy</span><span class="p">(</span><span class="n">phy_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rphy</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">SAS_END_DEVICE</span><span class="p">)</span>
			<span class="n">mptsas_del_end_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy_info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">phy_info</span> <span class="o">=</span> <span class="n">expander</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">expander</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rphy</span> <span class="o">=</span> <span class="n">mptsas_get_rphy</span><span class="p">(</span><span class="n">phy_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rphy</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span>
		    <span class="n">MPI_SAS_DEVICE_INFO_EDGE_EXPANDER</span> <span class="o">||</span>
		    <span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">device_type</span> <span class="o">==</span>
		    <span class="n">MPI_SAS_DEVICE_INFO_FANOUT_EXPANDER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port_info</span> <span class="o">=</span> <span class="n">mptsas_find_portinfo_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			    <span class="n">rphy</span><span class="o">-&gt;</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_info</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span> <span class="o">==</span> <span class="n">parent</span><span class="p">)</span> <span class="cm">/* backlink rphy */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			Delete this expander even if the expdevpage is exists</span>
<span class="cm">			because the parent expander is already deleted</span>
<span class="cm">			*/</span>
			<span class="n">mptsas_expander_delete</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">port_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *	mptsas_expander_delete - remove this expander</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@port_info: expander port_info struct</span>
<span class="cm"> *	@force: Flag to forcefully delete the expander</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mptsas_expander_delete</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">,</span> <span class="n">u8</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span>		<span class="n">expander_sas_address</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo_details</span> <span class="o">*</span><span class="n">port_details</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sas_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* see if expander is still there before deleting */</span>
	<span class="n">mptsas_sas_expander_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">MPI_SAS_EXPAND_PGAD_FORM_HANDLE</span> <span class="o">&lt;&lt;</span>
	    <span class="n">MPI_SAS_EXPAND_PGAD_FORM_SHIFT</span><span class="p">),</span>
	    <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">num_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">phy_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * Obtain the port_info instance to the parent port</span>
<span class="cm">	 */</span>
	<span class="n">port_details</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">expander_sas_address</span> <span class="o">=</span>
	    <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">;</span>
	<span class="n">parent</span> <span class="o">=</span> <span class="n">mptsas_find_portinfo_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">handle_parent</span><span class="p">);</span>
	<span class="n">mptsas_delete_expander_siblings</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">port_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Delete rphys in the parent that point</span>
<span class="cm">	 * to this expander.</span>
<span class="cm">	 */</span>
	<span class="n">phy_info</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">;</span>
	<span class="n">port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">!=</span>
		    <span class="n">expander_sas_address</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port</span> <span class="o">=</span> <span class="n">mptsas_get_port</span><span class="p">(</span><span class="n">phy_info</span><span class="p">);</span>
			<span class="n">port_details</span> <span class="o">=</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">port_details</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		    <span class="n">MYIOC_s_FMT</span> <span class="s">&quot;delete phy %d, phy-obj (0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
		<span class="n">sas_port_delete_phy</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		    <span class="n">MYIOC_s_FMT</span> <span class="s">&quot;delete port %d, sas_addr (0x%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port_identifier</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">expander_sas_address</span><span class="p">);</span>
		<span class="n">sas_port_delete</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">mptsas_port_delete</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">port_details</span><span class="p">);</span>
	<span class="p">}</span>
 <span class="nl">out:</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;delete expander: num_phys %d, &quot;</span>
	    <span class="s">&quot;sas_addr (0x%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">expander_sas_address</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * free link</span>
<span class="cm">	 */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">port_info</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mptsas_send_expander_event - expanders events</span>
<span class="cm"> * @ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> * @expander_data: event data</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This function handles adding, removing, and refreshing</span>
<span class="cm"> * device handles within the expander objects.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_send_expander_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">MpiEventDataSasExpanderStatusChange_t</span> <span class="o">*</span><span class="n">expander_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">sas_address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">expander_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">MpiEventDataSasExpanderStatusChange_t</span> <span class="o">*</span><span class="p">)</span>
	    <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">expander_data</span><span class="o">-&gt;</span><span class="n">SASAddress</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">));</span>
	<span class="n">sas_address</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="n">port_info</span> <span class="o">=</span> <span class="n">mptsas_find_portinfo_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">expander_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span> <span class="n">MPI_EVENT_SAS_EXP_RC_ADDED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">portinfo</span> <span class="o">=</span> <span class="n">port_info</span><span class="p">;</span>
				<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span> <span class="o">=</span>
				    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">expander_data</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">);</span>
				<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">=</span>
				    <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_address</span><span class="p">);</span>
				<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">handle_parent</span> <span class="o">=</span>
				    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">expander_data</span><span class="o">-&gt;</span><span class="n">ParentDevHandle</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">mptsas_expander_refresh</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">port_info</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_info</span> <span class="o">&amp;&amp;</span> <span class="n">expander_data</span><span class="o">-&gt;</span><span class="n">NumPhys</span><span class="p">)</span>
			<span class="n">mptsas_expander_event_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">expander_data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">expander_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span>
	    <span class="n">MPI_EVENT_SAS_EXP_RC_NOT_RESPONDING</span><span class="p">)</span>
		<span class="n">mptsas_expander_delete</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">port_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mptsas_free_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * mptsas_expander_add -</span>
<span class="cm"> * @ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> * @handle:</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span>
<span class="nf">mptsas_expander_add</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="n">buffer</span><span class="p">,</span> <span class="o">*</span><span class="n">port_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mptsas_sas_expander_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">MPI_SAS_EXPAND_PGAD_FORM_HANDLE</span> <span class="o">&lt;&lt;</span>
	    <span class="n">MPI_SAS_EXPAND_PGAD_FORM_SHIFT</span><span class="p">),</span> <span class="n">handle</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">port_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_portinfo</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
		<span class="s">&quot;%s: exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">num_phys</span><span class="p">;</span>
	<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">phy_info</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">portinfo</span> <span class="o">=</span> <span class="n">port_info</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;add expander: num_phys %d, &quot;</span>
	    <span class="s">&quot;sas_addr (0x%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">buffer</span><span class="p">.</span><span class="n">phy_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="n">mptsas_expander_refresh</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">port_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">port_info</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_send_link_status_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">MpiEventDataSasPhyLinkStatus_t</span> <span class="o">*</span><span class="n">link_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">sas_address</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_num</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">link_rate</span><span class="p">;</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">link_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">MpiEventDataSasPhyLinkStatus_t</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_data</span><span class="o">-&gt;</span><span class="n">SASAddress</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">));</span>
	<span class="n">sas_address</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_address</span><span class="p">);</span>
	<span class="n">link_rate</span> <span class="o">=</span> <span class="n">link_data</span><span class="o">-&gt;</span><span class="n">LinkRates</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">phy_num</span> <span class="o">=</span> <span class="n">link_data</span><span class="o">-&gt;</span><span class="n">PhyNum</span><span class="p">;</span>

	<span class="n">port_info</span> <span class="o">=</span> <span class="n">mptsas_find_portinfo_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">phy_num</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="p">)</span>
			<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">negotiated_link_rate</span> <span class="o">=</span> <span class="n">link_rate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_rate</span> <span class="o">==</span> <span class="n">MPI_SAS_IOUNIT0_RATE_1_5</span> <span class="o">||</span>
	    <span class="n">link_rate</span> <span class="o">==</span> <span class="n">MPI_SAS_IOUNIT0_RATE_3_0</span> <span class="o">||</span>
	    <span class="n">link_rate</span> <span class="o">==</span> <span class="n">MPI_SAS_IOUNIT0_RATE_6_0</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">old_sas_discovery_protocal</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">port_info</span> <span class="o">=</span> <span class="n">mptsas_expander_add</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">link_data</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span> <span class="o">==</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_port_info</span><span class="p">)</span>
			<span class="n">mptsas_probe_hba_phys</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mptsas_expander_refresh</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">port_info</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span> <span class="o">&amp;&amp;</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link_rate</span> <span class="o">==</span>  <span class="n">MPI_SAS_IOUNIT0_RATE_PHY_DISABLED</span><span class="p">)</span>
			<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span>
			    <span class="n">SAS_PHY_DISABLED</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">link_rate</span> <span class="o">==</span>
		    <span class="n">MPI_SAS_IOUNIT0_RATE_FAILED_SPEED_NEGOTIATION</span><span class="p">)</span>
			<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span>
			    <span class="n">SAS_LINK_RATE_FAILED</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">negotiated_linkrate</span> <span class="o">=</span>
			    <span class="n">SAS_LINK_RATE_UNKNOWN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">device_missing_delay</span> <span class="o">&amp;&amp;</span>
			    <span class="n">mptsas_is_end_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">scsi_device</span>		<span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
				<span class="n">VirtDevice</span>			<span class="o">*</span><span class="n">vdevice</span><span class="p">;</span>
				<span class="n">u8</span>	<span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
				<span class="n">id</span> <span class="o">=</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
				<span class="n">channel</span> <span class="o">=</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
				<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
				<span class="s">&quot;Link down for fw_id %d:fw_channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
				    <span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">channel</span><span class="p">));</span>

				<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">vdevice</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">vdevice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
						<span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span>
					    <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span> <span class="o">||</span>
					    <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">raidVolume</span><span class="p">))</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span> <span class="o">&amp;&amp;</span>
						<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span>
						<span class="n">channel</span><span class="p">)</span>
						<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
						<span class="s">&quot;SDEV OUTSTANDING CMDS&quot;</span>
						<span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">device_busy</span><span class="p">));</span>
				<span class="p">}</span>

			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">mptsas_free_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_not_responding_devices</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="n">buffer</span><span class="p">,</span> <span class="o">*</span><span class="n">port_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_device_info</span>	<span class="o">*</span><span class="n">sas_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_devinfo</span> <span class="n">sas_device</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">handle</span><span class="p">;</span>
	<span class="n">VirtTarget</span> <span class="o">*</span><span class="n">vtarget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">found_expander</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mpt_findImVolumes</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		   <span class="s">&quot;%s: exiting due to a parallel reset </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* devices, logical volumes */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_mutex</span><span class="p">);</span>
 <span class="nl">redo_device_scan:</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sas_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">is_cached</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">is_logical_volume</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sas_device</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">retry_page:</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">mptsas_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device</span><span class="p">,</span>
				<span class="p">(</span><span class="n">MPI_SAS_DEVICE_PGAD_FORM_BUS_TARGET_ID</span>
				<span class="o">&lt;&lt;</span> <span class="n">MPI_SAS_DEVICE_PGAD_FORM_SHIFT</span><span class="p">),</span>
				<span class="p">(</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">.</span><span class="n">handle</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
					<span class="s">&quot;%s: exiting due to reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
					<span class="n">spin_unlock_irqrestore</span>
					<span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span>
					<span class="n">sas_device_info_mutex</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span>
				<span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retry_count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">retry_count</span><span class="o">++</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">retry_page</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
					<span class="s">&quot;%s: Config page retry exceeded retry &quot;</span>
					<span class="s">&quot;count deleting device 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* delete device */</span>
			<span class="n">vtarget</span> <span class="o">=</span> <span class="n">mptsas_find_vtarget</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
				<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">vtarget</span><span class="p">)</span>
				<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">phy_info</span> <span class="o">=</span> <span class="n">mptsas_find_phyinfo_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
					<span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mptsas_del_end_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy_info</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">redo_device_scan</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">mptsas_volume_delete</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_mutex</span><span class="p">);</span>

	<span class="cm">/* expanders */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
 <span class="nl">redo_expander_scan:</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">port_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">device_info</span> <span class="o">&amp;</span>
		    <span class="n">MPI_SAS_DEVICE_INFO_SMP_TARGET</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">found_expander</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">handle</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">mptsas_sas_expander_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">MPI_SAS_EXPAND_PGAD_FORM_GET_NEXT_HANDLE</span> <span class="o">&lt;&lt;</span>
		     <span class="n">MPI_SAS_EXPAND_PGAD_FORM_SHIFT</span><span class="p">),</span> <span class="n">handle</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">found_expander</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">handle</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">phy_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">handle</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">phy_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">==</span>
			    <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">found_expander</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">phy_info</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found_expander</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mptsas_expander_delete</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">port_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">redo_expander_scan</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptsas_probe_expanders - adding expanders</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_probe_expanders</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="n">buffer</span><span class="p">,</span> <span class="o">*</span><span class="n">port_info</span><span class="p">;</span>
	<span class="n">u32</span> 			<span class="n">handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">mptsas_sas_expander_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">MPI_SAS_EXPAND_PGAD_FORM_GET_NEXT_HANDLE</span> <span class="o">&lt;&lt;</span>
	     <span class="n">MPI_SAS_EXPAND_PGAD_FORM_SHIFT</span><span class="p">),</span> <span class="n">handle</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">handle</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">phy_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">port_info</span> <span class="o">=</span> <span class="n">mptsas_find_portinfo_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">buffer</span><span class="p">.</span><span class="n">phy_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* refreshing handles */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buffer</span><span class="p">.</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
				<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">handle_parent</span> <span class="o">=</span>
				    <span class="n">buffer</span><span class="p">.</span><span class="n">phy_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">handle_parent</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mptsas_expander_refresh</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">port_info</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">phy_info</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">port_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_portinfo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			<span class="s">&quot;%s: exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">num_phys</span><span class="p">;</span>
		<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">phy_info</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">portinfo</span> <span class="o">=</span> <span class="n">port_info</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;add expander: num_phys %d, &quot;</span>
		    <span class="s">&quot;sas_addr (0x%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">buffer</span><span class="p">.</span><span class="n">phy_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">identify</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="n">mptsas_expander_refresh</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">port_info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_probe_devices</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_devinfo</span> <span class="n">sas_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mptsas_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device</span><span class="p">,</span>
	    <span class="n">MPI_SAS_DEVICE_PGAD_FORM_GET_NEXT_HANDLE</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">handle</span> <span class="o">=</span> <span class="n">sas_device</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">sas_device</span><span class="p">.</span><span class="n">device_info</span> <span class="o">&amp;</span>
		     <span class="p">(</span><span class="n">MPI_SAS_DEVICE_INFO_SSP_TARGET</span> <span class="o">|</span>
		      <span class="n">MPI_SAS_DEVICE_INFO_STP_TARGET</span> <span class="o">|</span>
		      <span class="n">MPI_SAS_DEVICE_INFO_SATA_DEVICE</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* If there is no FW B_T mapping for this device then continue</span>
<span class="cm">		 * */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sas_device</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_DEVICE0_FLAGS_DEVICE_PRESENT</span><span class="p">)</span>
			<span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">sas_device</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span>
			<span class="n">MPI_SAS_DEVICE0_FLAGS_DEVICE_MAPPED</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">phy_info</span> <span class="o">=</span> <span class="n">mptsas_refreshing_device_handles</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mptsas_get_rphy</span><span class="p">(</span><span class="n">phy_info</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mptsas_add_end_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy_info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptsas_scan_sas_topology -</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@sas_address:</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_scan_sas_topology</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mptsas_probe_hba_phys</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">mptsas_probe_expanders</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">mptsas_probe_devices</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	  Reporting RAID volumes.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ir_firmware</span> <span class="o">||</span> <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="o">-&gt;</span><span class="n">NumActiveVolumes</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="o">-&gt;</span><span class="n">NumActiveVolumes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev</span> <span class="o">=</span> <span class="n">scsi_device_lookup</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">,</span> <span class="n">MPTSAS_RAID_CHANNEL</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="o">-&gt;</span><span class="n">RaidVolume</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VolumeID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;attaching raid volume, channel %d, &quot;</span>
		    <span class="s">&quot;id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">MPTSAS_RAID_CHANNEL</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="o">-&gt;</span><span class="n">RaidVolume</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VolumeID</span><span class="p">);</span>
		<span class="n">scsi_add_device</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">,</span> <span class="n">MPTSAS_RAID_CHANNEL</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="o">-&gt;</span><span class="n">RaidVolume</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VolumeID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_handle_queue_full_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">EventDataQueueFull_t</span> <span class="o">*</span><span class="n">qfull_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_device_info</span> <span class="o">*</span><span class="n">sas_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span>	<span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">depth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">fw_channel</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">current_depth</span><span class="p">;</span>


	<span class="n">ioc</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">qfull_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">EventDataQueueFull_t</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">;</span>
	<span class="n">fw_id</span> <span class="o">=</span> <span class="n">qfull_data</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">;</span>
	<span class="n">fw_channel</span> <span class="o">=</span> <span class="n">qfull_data</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">;</span>
	<span class="n">current_depth</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">qfull_data</span><span class="o">-&gt;</span><span class="n">CurrentDepth</span><span class="p">);</span>

	<span class="cm">/* if hidden raid component, look for the volume id */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mptscsih_is_phys_disk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_channel</span><span class="p">,</span> <span class="n">fw_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sas_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_list</span><span class="p">,</span>
		    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">is_cached</span> <span class="o">||</span>
			    <span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">is_logical_volume</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">is_hidden_raid_component</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">channel</span> <span class="o">==</span> <span class="n">fw_channel</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">fw_id</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">id</span> <span class="o">=</span> <span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">volume_id</span><span class="p">;</span>
				<span class="n">channel</span> <span class="o">=</span> <span class="n">MPTSAS_RAID_CHANNEL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sas_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_list</span><span class="p">,</span>
		    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">is_cached</span> <span class="o">||</span>
			    <span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">is_hidden_raid_component</span> <span class="o">||</span>
			    <span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">is_logical_volume</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">channel</span> <span class="o">==</span> <span class="n">fw_channel</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">fw_id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">id</span> <span class="o">=</span> <span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
				<span class="n">channel</span> <span class="o">=</span> <span class="n">sas_info</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">current_depth</span> <span class="o">&gt;</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
					    <span class="s">&quot;strange observation, the queue &quot;</span>
					    <span class="s">&quot;depth is (%d) meanwhile fw queue &quot;</span>
					    <span class="s">&quot;depth (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">,</span>
					    <span class="n">current_depth</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">depth</span> <span class="o">=</span> <span class="n">scsi_track_queue_full</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span>
				    <span class="n">current_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
					<span class="s">&quot;Queue depth reduced to (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">depth</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
					<span class="s">&quot;Tagged Command Queueing is being &quot;</span>
					<span class="s">&quot;disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">sdev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span>
					<span class="s">&quot;Queue depth not changed yet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mptsas_free_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span>
<span class="nf">mptsas_find_phyinfo_by_sas_address</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u64</span> <span class="n">sas_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">port_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mptsas_is_end_device</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">sas_address</span>
			    <span class="o">!=</span> <span class="n">sas_address</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">phy_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">phy_info</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptsas_find_phyinfo_by_phys_disk_num -</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@phys_disk_num:</span>
<span class="cm"> *	@channel:</span>
<span class="cm"> *	@id:</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span>
<span class="nf">mptsas_find_phyinfo_by_phys_disk_num</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phys_disk_num</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">;</span>
	<span class="n">RaidPhysDiskPage1_t</span> <span class="o">*</span><span class="n">phys_disk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_paths</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sas_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">phy_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* dual port support */</span>
	<span class="n">num_paths</span> <span class="o">=</span> <span class="n">mpt_raid_phys_disk_get_num_paths</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phys_disk_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_paths</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">phys_disk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="n">RaidPhysDiskPage1_t</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span> <span class="o">+</span>
	   <span class="p">(</span><span class="n">num_paths</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RAID_PHYS_DISK1_PATH</span><span class="p">)),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phys_disk</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">mpt_raid_phys_disk_pg1</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phys_disk_num</span><span class="p">,</span> <span class="n">phys_disk</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_paths</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* entry no longer valid */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">==</span> <span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskBus</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">WWID</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
			<span class="n">phy_info</span> <span class="o">=</span> <span class="n">mptsas_find_phyinfo_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
					<span class="n">sas_address</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phys_disk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">phy_info</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Extra code to handle RAID0 case, where the sas_address is not updated</span>
<span class="cm">	 * in phys_disk_page_1 when hotswapped</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">port_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">port_info</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">phy_info</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mptsas_is_end_device</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">phys_disk_num</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">phys_disk_num</span> <span class="o">==</span>
			    <span class="n">phys_disk_num</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attached</span><span class="p">.</span><span class="n">channel</span> <span class="o">==</span>
			     <span class="n">channel</span><span class="p">))</span>
				<span class="n">phy_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">phy_info</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_reprobe_lun</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">no_uld_attach</span> <span class="o">=</span> <span class="n">data</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">scsi_device_reprobe</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_reprobe_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span><span class="p">,</span> <span class="kt">int</span> <span class="n">uld_attach</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">starget_for_each_device</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="n">uld_attach</span> <span class="o">?</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mi">1</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="n">mptsas_reprobe_lun</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_adding_inactive_raid_components</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CONFIGPARMS</span>			<span class="n">cfg</span><span class="p">;</span>
	<span class="n">ConfigPageHeader_t</span>		<span class="n">hdr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">pRaidVolumePage0_t</span>		<span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">RaidPhysDiskPage0_t</span> 		<span class="n">phys_disk</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_phyinfo</span>	<span class="o">*</span><span class="n">phy_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_devinfo</span>		<span class="n">sas_device</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CONFIGPARMS</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ConfigPageHeader_t</span><span class="p">));</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_RAID_VOLUME</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">SAS_CONFIG_PAGE_TIMEOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">VolumeStatus</span><span class="p">.</span><span class="n">Flags</span> <span class="o">&amp;</span>
	    <span class="n">MPI_RAIDVOL0_STATUS_FLAG_VOLUME_INACTIVE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">NumPhysDisks</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">NumPhysDisks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mpt_raid_phys_disk_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">PhysDisk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskNum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phys_disk</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mptsas_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">MPI_SAS_DEVICE_PGAD_FORM_BUS_TARGET_ID</span> <span class="o">&lt;&lt;</span>
		     <span class="n">MPI_SAS_DEVICE_PGAD_FORM_SHIFT</span><span class="p">),</span>
			<span class="p">(</span><span class="n">phys_disk</span><span class="p">.</span><span class="n">PhysDiskBus</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">phys_disk</span><span class="p">.</span><span class="n">PhysDiskID</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* If there is no FW B_T mapping for this device then continue</span>
<span class="cm">		 * */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sas_device</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_DEVICE0_FLAGS_DEVICE_PRESENT</span><span class="p">)</span>
			<span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">sas_device</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span>
			<span class="n">MPI_SAS_DEVICE0_FLAGS_DEVICE_MAPPED</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>


		<span class="n">phy_info</span> <span class="o">=</span> <span class="n">mptsas_find_phyinfo_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">sas_device</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="n">mptsas_add_end_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy_info</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
		    <span class="n">dma_handle</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Work queue thread to handle SAS hotplug events</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_hotplug_work</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">,</span>
    <span class="k">struct</span> <span class="n">mptsas_hotplug_event</span> <span class="o">*</span><span class="n">hot_plug_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mptsas_phyinfo</span> <span class="o">*</span><span class="n">phy_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span> <span class="n">starget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_devinfo</span> <span class="n">sas_device</span><span class="p">;</span>
	<span class="n">VirtTarget</span> <span class="o">*</span><span class="n">vtarget</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">port_info</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">MPTSAS_ADD_PHYSDISK</span>:

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="o">-&gt;</span><span class="n">NumActiveVolumes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="o">-&gt;</span><span class="n">RaidVolume</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VolumeID</span> <span class="o">==</span>
			    <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;firmware bug: unable &quot;</span>
				    <span class="s">&quot;to add hidden disk - target_id matchs &quot;</span>
				    <span class="s">&quot;volume_id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">mptsas_free_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">mpt_findImVolumes</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">MPTSAS_ADD_DEVICE</span>:
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_device</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_devinfo</span><span class="p">));</span>
		<span class="n">mptsas_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">MPI_SAS_DEVICE_PGAD_FORM_BUS_TARGET_ID</span> <span class="o">&lt;&lt;</span>
		    <span class="n">MPI_SAS_DEVICE_PGAD_FORM_SHIFT</span><span class="p">),</span>
		    <span class="p">(</span><span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
		    <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

		<span class="cm">/* If there is no FW B_T mapping for this device then break</span>
<span class="cm">		 * */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sas_device</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_DEVICE0_FLAGS_DEVICE_PRESENT</span><span class="p">)</span>
			<span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">sas_device</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span>
			<span class="n">MPI_SAS_DEVICE0_FLAGS_DEVICE_MAPPED</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas_device</span><span class="p">.</span><span class="n">handle</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">phy_info</span> <span class="o">=</span> <span class="n">mptsas_refreshing_device_handles</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device</span><span class="p">);</span>
		<span class="cm">/* Only For SATA Device ADD */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sas_device</span><span class="p">.</span><span class="n">device_info</span> <span class="o">&amp;</span>
				<span class="n">MPI_SAS_DEVICE_INFO_SATA_DEVICE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
				<span class="s">&quot;%s %d SATA HOT PLUG: &quot;</span>
				<span class="s">&quot;parent handle of device %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">sas_device</span><span class="p">.</span><span class="n">handle_parent</span><span class="p">));</span>
			<span class="n">port_info</span> <span class="o">=</span> <span class="n">mptsas_find_portinfo_by_handle</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
				<span class="n">sas_device</span><span class="p">.</span><span class="n">handle_parent</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">port_info</span> <span class="o">==</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_port_info</span><span class="p">)</span>
				<span class="n">mptsas_probe_hba_phys</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">port_info</span><span class="p">)</span>
				<span class="n">mptsas_expander_refresh</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">port_info</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
					<span class="s">&quot;%s %d port info is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">phy_info</span> <span class="o">=</span> <span class="n">mptsas_refreshing_device_handles</span>
				<span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
				<span class="s">&quot;%s %d phy info is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mptsas_get_rphy</span><span class="p">(</span><span class="n">phy_info</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">mptsas_add_end_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy_info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPTSAS_DEL_DEVICE</span>:
		<span class="n">phy_info</span> <span class="o">=</span> <span class="n">mptsas_find_phyinfo_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="n">mptsas_del_end_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy_info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPTSAS_DEL_PHYSDISK</span>:

		<span class="n">mpt_findImVolumes</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

		<span class="n">phy_info</span> <span class="o">=</span> <span class="n">mptsas_find_phyinfo_by_phys_disk_num</span><span class="p">(</span>
				<span class="n">ioc</span><span class="p">,</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">phys_disk_num</span><span class="p">,</span>
				<span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				<span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">mptsas_del_end_device</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">phy_info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPTSAS_ADD_PHYSDISK_REPROBE</span>:

		<span class="k">if</span> <span class="p">(</span><span class="n">mptsas_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">MPI_SAS_DEVICE_PGAD_FORM_BUS_TARGET_ID</span> <span class="o">&lt;&lt;</span>
		     <span class="n">MPI_SAS_DEVICE_PGAD_FORM_SHIFT</span><span class="p">),</span>
		    <span class="p">(</span><span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			<span class="s">&quot;%s: fw_id=%d exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If there is no FW B_T mapping for this device then break</span>
<span class="cm">		 * */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sas_device</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_DEVICE0_FLAGS_DEVICE_PRESENT</span><span class="p">)</span>
			<span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">sas_device</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span>
			<span class="n">MPI_SAS_DEVICE0_FLAGS_DEVICE_MAPPED</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">phy_info</span> <span class="o">=</span> <span class="n">mptsas_find_phyinfo_by_sas_address</span><span class="p">(</span>
		    <span class="n">ioc</span><span class="p">,</span> <span class="n">sas_device</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
				<span class="s">&quot;%s: fw_id=%d exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">starget</span> <span class="o">=</span> <span class="n">mptsas_get_starget</span><span class="p">(</span><span class="n">phy_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">starget</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
				<span class="s">&quot;%s: fw_id=%d exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vtarget</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vtarget</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
				<span class="s">&quot;%s: fw_id=%d exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mpt_findImVolumes</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

		<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span> <span class="s">&quot;RAID Hidding: &quot;</span>
		    <span class="s">&quot;fw_channel=%d, fw_id=%d, physdsk %d, sas_addr 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		    <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">phys_disk_num</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		    <span class="n">sas_device</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>

		<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">phys_disk_num</span><span class="p">;</span>
		<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">|=</span> <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">;</span>
		<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">phys_disk_num</span> <span class="o">=</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">phys_disk_num</span><span class="p">;</span>
		<span class="n">mptsas_reprobe_target</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPTSAS_DEL_PHYSDISK_REPROBE</span>:

		<span class="k">if</span> <span class="p">(</span><span class="n">mptsas_sas_device_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_device</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">MPI_SAS_DEVICE_PGAD_FORM_BUS_TARGET_ID</span> <span class="o">&lt;&lt;</span>
		     <span class="n">MPI_SAS_DEVICE_PGAD_FORM_SHIFT</span><span class="p">),</span>
			<span class="p">(</span><span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
				    <span class="s">&quot;%s: fw_id=%d exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				    <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If there is no FW B_T mapping for this device then break</span>
<span class="cm">		 * */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sas_device</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPI_SAS_DEVICE0_FLAGS_DEVICE_PRESENT</span><span class="p">)</span>
			<span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">sas_device</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span>
			<span class="n">MPI_SAS_DEVICE0_FLAGS_DEVICE_MAPPED</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">phy_info</span> <span class="o">=</span> <span class="n">mptsas_find_phyinfo_by_sas_address</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
				<span class="n">sas_device</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy_info</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			    <span class="s">&quot;%s: fw_id=%d exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">starget</span> <span class="o">=</span> <span class="n">mptsas_get_starget</span><span class="p">(</span><span class="n">phy_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">starget</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			    <span class="s">&quot;%s: fw_id=%d exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vtarget</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vtarget</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			    <span class="s">&quot;%s: fw_id=%d exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			    <span class="s">&quot;%s: fw_id=%d exit at line=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mpt_findImVolumes</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

		<span class="n">starget_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">starget</span><span class="p">,</span> <span class="n">MYIOC_s_FMT</span> <span class="s">&quot;RAID Exposing:&quot;</span>
		    <span class="s">&quot; fw_channel=%d, fw_id=%d, physdsk %d, sas_addr 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		    <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">phys_disk_num</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span>
		    <span class="n">sas_device</span><span class="p">.</span><span class="n">sas_address</span><span class="p">);</span>

		<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">;</span>
		<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">phy_info</span><span class="o">-&gt;</span><span class="n">attached</span><span class="p">.</span><span class="n">phys_disk_num</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">mptsas_reprobe_target</span><span class="p">(</span><span class="n">starget</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mptsas_add_device_component_by_fw</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPTSAS_ADD_RAID</span>:

		<span class="n">mpt_findImVolumes</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;attaching raid volume, channel %d, &quot;</span>
		    <span class="s">&quot;id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">MPTSAS_RAID_CHANNEL</span><span class="p">,</span>
		    <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">scsi_add_device</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">,</span> <span class="n">MPTSAS_RAID_CHANNEL</span><span class="p">,</span>
		    <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPTSAS_DEL_RAID</span>:

		<span class="n">mpt_findImVolumes</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;removing raid volume, channel %d, &quot;</span>
		    <span class="s">&quot;id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">MPTSAS_RAID_CHANNEL</span><span class="p">,</span>
		    <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">scsi_remove_device</span><span class="p">(</span><span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">);</span>
		<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPTSAS_ADD_INACTIVE_VOLUME</span>:

		<span class="n">mpt_findImVolumes</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">mptsas_adding_inactive_raid_components</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">hot_plug_info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mptsas_free_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_send_sas_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_hotplug_event</span> <span class="n">hot_plug_info</span><span class="p">;</span>
	<span class="n">EVENT_DATA_SAS_DEVICE_STATUS_CHANGE</span> <span class="o">*</span><span class="n">sas_event_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">device_info</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">sas_address</span><span class="p">;</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">sas_event_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">EVENT_DATA_SAS_DEVICE_STATUS_CHANGE</span> <span class="o">*</span><span class="p">)</span>
	    <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">;</span>
	<span class="n">device_info</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sas_event_data</span><span class="o">-&gt;</span><span class="n">DeviceInfo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">device_info</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">MPI_SAS_DEVICE_INFO_SSP_TARGET</span> <span class="o">|</span>
		<span class="n">MPI_SAS_DEVICE_INFO_STP_TARGET</span> <span class="o">|</span>
		<span class="n">MPI_SAS_DEVICE_INFO_SATA_DEVICE</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mptsas_free_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sas_event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span>
		<span class="n">MPI_EVENT_SAS_DEV_STAT_RC_NO_PERSIST_ADDED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mptbase_sas_persist_operation</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		<span class="n">MPI_SAS_OP_CLEAR_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">mptsas_free_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sas_event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_NOT_RESPONDING</span>:
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_ADDED</span>:
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hot_plug_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_hotplug_event</span><span class="p">));</span>
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sas_event_data</span><span class="o">-&gt;</span><span class="n">DevHandle</span><span class="p">);</span>
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">sas_event_data</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">;</span>
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">sas_event_data</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">;</span>
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="n">sas_event_data</span><span class="o">-&gt;</span><span class="n">PhyNum</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_event_data</span><span class="o">-&gt;</span><span class="n">SASAddress</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">sas_address</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">device_info</span> <span class="o">=</span> <span class="n">device_info</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">&amp;</span>
		    <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_ADDED</span><span class="p">)</span>
			<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">MPTSAS_ADD_DEVICE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">MPTSAS_DEL_DEVICE</span><span class="p">;</span>
		<span class="n">mptsas_hotplug_work</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hot_plug_info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_NO_PERSIST_ADDED</span>:
		<span class="n">mptbase_sas_persist_operation</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">MPI_SAS_OP_CLEAR_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">mptsas_free_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_SMART_DATA</span>:
	<span class="cm">/* TODO */</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_INTERNAL_DEVICE_RESET</span>:
	<span class="cm">/* TODO */</span>
	<span class="nl">default:</span>
		<span class="n">mptsas_free_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_send_raid_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">EVENT_DATA_RAID</span> <span class="o">*</span><span class="n">raid_event_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_hotplug_event</span> <span class="n">hot_plug_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">VirtDevice</span> <span class="o">*</span><span class="n">vdevice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">RaidPhysDiskPage0_t</span> <span class="n">phys_disk</span><span class="p">;</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">raid_event_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">EVENT_DATA_RAID</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">raid_event_data</span><span class="o">-&gt;</span><span class="n">SettingsStatus</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hot_plug_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_hotplug_event</span><span class="p">));</span>
	<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">raid_event_data</span><span class="o">-&gt;</span><span class="n">VolumeID</span><span class="p">;</span>
	<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">raid_event_data</span><span class="o">-&gt;</span><span class="n">VolumeBus</span><span class="p">;</span>
	<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">phys_disk_num</span> <span class="o">=</span> <span class="n">raid_event_data</span><span class="o">-&gt;</span><span class="n">PhysDiskNum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">raid_event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span> <span class="n">MPI_EVENT_RAID_RC_VOLUME_DELETED</span> <span class="o">||</span>
	    <span class="n">raid_event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span> <span class="n">MPI_EVENT_RAID_RC_VOLUME_CREATED</span> <span class="o">||</span>
	    <span class="n">raid_event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span>
	    <span class="n">MPI_EVENT_RAID_RC_VOLUME_STATUS_CHANGED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdev</span> <span class="o">=</span> <span class="n">scsi_device_lookup</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">,</span> <span class="n">MPTSAS_RAID_CHANNEL</span><span class="p">,</span>
		    <span class="n">hot_plug_info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">sdev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="p">)</span>
			<span class="n">vdevice</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Entering %s: &quot;</span>
	    <span class="s">&quot;ReasonCode=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">raid_event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">raid_event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_PHYSDISK_DELETED</span>:
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">MPTSAS_DEL_PHYSDISK_REPROBE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_PHYSDISK_CREATED</span>:
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">MPTSAS_ADD_PHYSDISK_REPROBE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_PHYSDISK_STATUS_CHANGED</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI_PD_STATE_ONLINE</span>:
		<span class="k">case</span> <span class="n">MPI_PD_STATE_NOT_COMPATIBLE</span>:
			<span class="n">mpt_raid_phys_disk_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			    <span class="n">raid_event_data</span><span class="o">-&gt;</span><span class="n">PhysDiskNum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phys_disk</span><span class="p">);</span>
			<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">phys_disk</span><span class="p">.</span><span class="n">PhysDiskID</span><span class="p">;</span>
			<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">phys_disk</span><span class="p">.</span><span class="n">PhysDiskBus</span><span class="p">;</span>
			<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">MPTSAS_ADD_PHYSDISK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_PD_STATE_FAILED</span>:
		<span class="k">case</span> <span class="n">MPI_PD_STATE_MISSING</span>:
		<span class="k">case</span> <span class="n">MPI_PD_STATE_OFFLINE_AT_HOST_REQUEST</span>:
		<span class="k">case</span> <span class="n">MPI_PD_STATE_FAILED_AT_HOST_REQUEST</span>:
		<span class="k">case</span> <span class="n">MPI_PD_STATE_OFFLINE_FOR_ANOTHER_REASON</span>:
			<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">MPTSAS_DEL_PHYSDISK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_VOLUME_DELETED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* block IO */</span>
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">MPTSAS_DEL_RAID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_VOLUME_CREATED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">MPTSAS_ADD_RAID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_VOLUME_STATUS_CHANGED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPI_RAIDVOL0_STATUS_FLAG_ENABLED</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* block IO */</span>
			<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">MPTSAS_DEL_RAID</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI_RAIDVOL0_STATUS_STATE_FAILED</span>:
		<span class="k">case</span> <span class="n">MPI_RAIDVOL0_STATUS_STATE_MISSING</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* block IO */</span>
			<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">MPTSAS_DEL_RAID</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_RAIDVOL0_STATUS_STATE_OPTIMAL</span>:
		<span class="k">case</span> <span class="n">MPI_RAIDVOL0_STATUS_STATE_DEGRADED</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">MPTSAS_ADD_RAID</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hot_plug_info</span><span class="p">.</span><span class="n">event_type</span> <span class="o">!=</span> <span class="n">MPTSAS_IGNORE_EVENT</span><span class="p">)</span>
		<span class="n">mptsas_hotplug_work</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hot_plug_info</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mptsas_free_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptsas_issue_tm - send mptsas internal tm request</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@type: Task Management type</span>
<span class="cm"> *	@channel: channel number for task management</span>
<span class="cm"> *	@id: Logical Target ID for reset (if appropriate)</span>
<span class="cm"> *	@lun: Logical unit for reset (if appropriate)</span>
<span class="cm"> *	@task_context: Context for the task to be aborted</span>
<span class="cm"> *	@timeout: timeout for task management control</span>
<span class="cm"> *</span>
<span class="cm"> *	return 0 on success and -1 on failure:</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_issue_tm</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u64</span> <span class="n">lun</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">task_context</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">issue_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_FRAME_HDR</span>	<span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">SCSITaskMgmt_t</span>	<span class="o">*</span><span class="n">pScsiTm</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">timeleft</span><span class="p">;</span>

	<span class="o">*</span><span class="n">issue_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">mptsasDeviceResetCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* return failure */</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;TaskMgmt request: no &quot;</span>
		    <span class="s">&quot;msg frames!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;TaskMgmt request: mr = %p, &quot;</span>
	    <span class="s">&quot;task_type = 0x%02X,</span><span class="se">\n\t</span><span class="s"> timeout = %ld, fw_channel = %d, &quot;</span>
	    <span class="s">&quot;fw_id = %d, lun = %lld,</span><span class="se">\n\t</span><span class="s"> task_context = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span>
	     <span class="n">type</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">lun</span><span class="p">,</span>
	     <span class="n">task_context</span><span class="p">));</span>

	<span class="n">pScsiTm</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSITaskMgmt_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pScsiTm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCSITaskMgmt_t</span><span class="p">));</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_SCSI_TASK_MGMT</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">TaskType</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Reserved1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">TaskMsgContext</span> <span class="o">=</span> <span class="n">task_context</span><span class="p">;</span>
	<span class="n">int_to_scsilun</span><span class="p">(</span><span class="n">lun</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_lun</span> <span class="o">*</span><span class="p">)</span><span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">);</span>

	<span class="n">INITIALIZE_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">CLEAR_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mpt_put_msg_frame_hi_pri</span><span class="p">(</span><span class="n">mptsasDeviceResetCtx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>

	<span class="cm">/* Now wait for the command to complete */</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span>
	    <span class="n">timeout</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* return failure */</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
		    <span class="s">&quot;TaskMgmt request: TIMED OUT!(mr=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mf</span><span class="p">));</span>
		<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="o">*</span><span class="n">issue_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* return failure */</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;TaskMgmt request: failed with no reply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">CLEAR_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mptsas_broadcast_primative_work - Handle broadcast primitives</span>
<span class="cm"> *	@work: work queue payload containing info describing the event</span>
<span class="cm"> *</span>
<span class="cm"> *	this will be handled in workqueue context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_broadcast_primative_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">MPT_FRAME_HDR</span>	<span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">VirtDevice</span>	<span class="o">*</span><span class="n">vdevice</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ii</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span>	<span class="o">*</span><span class="n">sc</span><span class="p">;</span>
	<span class="n">SCSITaskMgmtReply_t</span>	<span class="o">*</span><span class="n">pScsiTmReply</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">issue_reset</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">task_context</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">lun</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">termination_count</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">query_count</span><span class="p">;</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;%s - enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_set_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">mptsas_requeue_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">issue_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">termination_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">query_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mpt_findImVolumes</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">pScsiTmReply</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSITaskMgmtReply_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_events_off</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">sc</span> <span class="o">=</span> <span class="n">mptscsih_get_scsi_lookup</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">mf</span> <span class="o">=</span> <span class="n">MPT_INDEX_2_MFPTR</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mf</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">task_context</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">MsgContext</span><span class="p">;</span>
		<span class="n">vdevice</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdevice</span> <span class="o">||</span> <span class="o">!</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span> <span class="cm">/* skip hidden raid components */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">raidVolume</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span> <span class="cm">/* skip hidden raid components */</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">lun</span> <span class="o">=</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mptsas_issue_tm</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI_SCSITASKMGMT_TASKTYPE_QUERY_TASK</span><span class="p">,</span>
		    <span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">lun</span><span class="p">,</span> <span class="n">task_context</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">issue_reset</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">query_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">termination_count</span> <span class="o">+=</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">TerminationCount</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">ResponseCode</span> <span class="o">==</span>
		    <span class="n">MPI_SCSITASKMGMT_RSP_TM_SUCCEEDED</span> <span class="o">||</span>
		    <span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">ResponseCode</span> <span class="o">==</span>
		    <span class="n">MPI_SCSITASKMGMT_RSP_IO_QUEUED_ON_IOC</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mptsas_issue_tm</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">MPI_SCSITASKMGMT_TASKTYPE_ABRT_TASK_SET</span><span class="p">,</span>
		    <span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">lun</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">issue_reset</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">termination_count</span> <span class="o">+=</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">TerminationCount</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;%s - exit, query_count = %d termination_count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">query_count</span><span class="p">,</span> <span class="n">termination_count</span><span class="p">));</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">broadcast_aen_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mpt_clear_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">issue_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
		       <span class="s">&quot;Issuing Reset from %s!! doorbell=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">mpt_Soft_Hard_ResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mptsas_free_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mptsas_send_ir2_event - handle exposing hidden disk when</span>
<span class="cm"> * an inactive raid volume is added</span>
<span class="cm"> *</span>
<span class="cm"> * @ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> * @ir2_data</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptsas_send_ir2_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mptsas_hotplug_event</span> <span class="n">hot_plug_info</span><span class="p">;</span>
	<span class="n">MPI_EVENT_DATA_IR2</span>	<span class="o">*</span><span class="n">ir2_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reasonCode</span><span class="p">;</span>
	<span class="n">RaidPhysDiskPage0_t</span> <span class="n">phys_disk</span><span class="p">;</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">ir2_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPI_EVENT_DATA_IR2</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">;</span>
	<span class="n">reasonCode</span> <span class="o">=</span> <span class="n">ir2_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span><span class="p">;</span>

	<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Entering %s: &quot;</span>
	    <span class="s">&quot;ReasonCode=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reasonCode</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hot_plug_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mptsas_hotplug_event</span><span class="p">));</span>
	<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">ir2_data</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">;</span>
	<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">ir2_data</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reasonCode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_IR2_RC_FOREIGN_CFG_DETECTED</span>:
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">MPTSAS_ADD_INACTIVE_VOLUME</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_IR2_RC_DUAL_PORT_REMOVED</span>:
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">phys_disk_num</span> <span class="o">=</span> <span class="n">ir2_data</span><span class="o">-&gt;</span><span class="n">PhysDiskNum</span><span class="p">;</span>
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">MPTSAS_DEL_PHYSDISK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_IR2_RC_DUAL_PORT_ADDED</span>:
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">phys_disk_num</span> <span class="o">=</span> <span class="n">ir2_data</span><span class="o">-&gt;</span><span class="n">PhysDiskNum</span><span class="p">;</span>
		<span class="n">mpt_raid_phys_disk_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">ir2_data</span><span class="o">-&gt;</span><span class="n">PhysDiskNum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phys_disk</span><span class="p">);</span>
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">phys_disk</span><span class="p">.</span><span class="n">PhysDiskID</span><span class="p">;</span>
		<span class="n">hot_plug_info</span><span class="p">.</span><span class="n">event_type</span> <span class="o">=</span> <span class="n">MPTSAS_ADD_PHYSDISK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mptsas_free_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mptsas_hotplug_work</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hot_plug_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_event_process</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">EventNotificationReply_t</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">event</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">Event</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sz</span><span class="p">,</span> <span class="n">event_data_sz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_event_work</span> <span class="o">*</span><span class="n">fw_event</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="n">SAS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* events turned off due to host reset or driver unloading */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_events_off</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">delay</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_BROADCAST_PRIMITIVE</span>:
	<span class="p">{</span>
		<span class="n">EVENT_DATA_SAS_BROADCAST_PRIMITIVE</span> <span class="o">*</span><span class="n">broadcast_event_data</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">EVENT_DATA_SAS_BROADCAST_PRIMITIVE</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">broadcast_event_data</span><span class="o">-&gt;</span><span class="n">Primitive</span> <span class="o">!=</span>
		    <span class="n">MPI_EVENT_PRIMITIVE_ASYNCHRONOUS_EVENT</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">broadcast_aen_busy</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">broadcast_aen_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEVICE_STATUS_CHANGE</span>:
	<span class="p">{</span>
		<span class="n">EVENT_DATA_SAS_DEVICE_STATUS_CHANGE</span> <span class="o">*</span><span class="n">sas_event_data</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">EVENT_DATA_SAS_DEVICE_STATUS_CHANGE</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">;</span>
		<span class="n">u16</span>	<span class="n">ioc_stat</span><span class="p">;</span>
		<span class="n">ioc_stat</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sas_event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span>
		    <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_NOT_RESPONDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mptsas_target_reset_queue</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sas_event_data</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sas_event_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span>
			<span class="n">MPI_EVENT_SAS_DEV_STAT_RC_INTERNAL_DEVICE_RESET</span> <span class="o">&amp;&amp;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">device_missing_delay</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">ioc_stat</span> <span class="o">&amp;</span> <span class="n">MPI_IOCSTATUS_FLAG_LOG_INFO_AVAILABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">VirtTarget</span> <span class="o">*</span><span class="n">vtarget</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">u8</span>		<span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">;</span>

			<span class="n">id</span> <span class="o">=</span> <span class="n">sas_event_data</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">;</span>
			<span class="n">channel</span> <span class="o">=</span> <span class="n">sas_event_data</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">;</span>

			<span class="n">vtarget</span> <span class="o">=</span> <span class="n">mptsas_find_vtarget</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vtarget</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
				    <span class="s">&quot;LogInfo (0x%x) available for &quot;</span>
				   <span class="s">&quot;INTERNAL_DEVICE_RESET&quot;</span>
				   <span class="s">&quot;fw_id %d fw_channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">),</span>
				   <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">raidVolume</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
					<span class="s">&quot;Skipping Raid Volume for inDMD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
					<span class="s">&quot;Setting device flag inDMD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
					<span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">inDMD</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_EXPANDER_STATUS_CHANGE</span>:
	<span class="p">{</span>
		<span class="n">MpiEventDataSasExpanderStatusChange_t</span> <span class="o">*</span><span class="n">expander_data</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">MpiEventDataSasExpanderStatusChange_t</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">old_sas_discovery_protocal</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">expander_data</span><span class="o">-&gt;</span><span class="n">ReasonCode</span> <span class="o">==</span>
		    <span class="n">MPI_EVENT_SAS_EXP_RC_NOT_RESPONDING</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">device_missing_delay</span><span class="p">)</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">device_missing_delay</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DISCOVERY</span>:
	<span class="p">{</span>
		<span class="n">u32</span> <span class="n">discovery_status</span><span class="p">;</span>
		<span class="n">EventDataSasDiscovery_t</span> <span class="o">*</span><span class="n">discovery_data</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">EventDataSasDiscovery_t</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">;</span>

		<span class="n">discovery_status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">discovery_data</span><span class="o">-&gt;</span><span class="n">DiscoveryStatus</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_discovery_quiesce_io</span> <span class="o">=</span> <span class="n">discovery_status</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">old_sas_discovery_protocal</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">discovery_status</span><span class="p">)</span>
			<span class="n">mptsas_queue_rescan</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_INTEGRATED_RAID</span>:
	<span class="k">case</span> <span class="n">MPI_EVENT_PERSISTENT_TABLE_FULL</span>:
	<span class="k">case</span> <span class="n">MPI_EVENT_IR2</span>:
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_PHY_LINK_STATUS</span>:
	<span class="k">case</span> <span class="n">MPI_EVENT_QUEUE_FULL</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">event_data_sz</span> <span class="o">=</span> <span class="p">((</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">MsgLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span>
	    <span class="n">offsetof</span><span class="p">(</span><span class="n">EventNotificationReply_t</span><span class="p">,</span> <span class="n">Data</span><span class="p">));</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_event_work</span><span class="p">,</span> <span class="n">event_data</span><span class="p">)</span> <span class="o">+</span> <span class="n">event_data_sz</span><span class="p">;</span>
	<span class="n">fw_event</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_event</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;%s: failed at (line=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event_data</span><span class="p">,</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">,</span> <span class="n">event_data_sz</span><span class="p">);</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
	<span class="n">fw_event</span><span class="o">-&gt;</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">ioc</span><span class="p">;</span>
	<span class="n">mptsas_add_fw_event</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">fw_event</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Delete a volume when no longer listed in ioc pg2</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mptsas_volume_delete</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sdev</span> <span class="o">=</span> <span class="n">scsi_device_lookup</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">,</span> <span class="n">MPTSAS_RAID_CHANNEL</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="o">-&gt;</span><span class="n">NumActiveVolumes</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="o">-&gt;</span><span class="n">NumActiveVolumes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="o">-&gt;</span><span class="n">RaidVolume</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VolumeID</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release_sdev</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;removing raid volume, channel %d, &quot;</span>
	    <span class="s">&quot;id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">MPTSAS_RAID_CHANNEL</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">scsi_remove_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
 <span class="nl">release_sdev:</span>
	<span class="n">scsi_device_put</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptsas_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span>	<span class="o">*</span><span class="n">sh</span><span class="p">;</span>
	<span class="n">MPT_SCSI_HOST</span>		<span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> 		<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		 <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">ii</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">numSGE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">scale</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">ioc_cap</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">mpt_attach</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">mptsas_fw_event_off</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">DoneCtx</span> <span class="o">=</span> <span class="n">mptsasDoneCtx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">TaskCtx</span> <span class="o">=</span> <span class="n">mptsasTaskCtx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">InternalCtx</span> <span class="o">=</span> <span class="n">mptsasInternalCtx</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">schedule_target_reset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mptsas_schedule_target_reset</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">schedule_dead_ioc_flush_running_cmds</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">mptscsih_flush_running_cmds</span><span class="p">;</span>
	<span class="cm">/*  Added sanity check on readiness of the MPT adapter.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">last_state</span> <span class="o">!=</span> <span class="n">MPI_IOC_STATE_OPERATIONAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
		  <span class="s">&quot;Skipping because it&#39;s not operational!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mptsas_probe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;Skipping because it&#39;s disabled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mptsas_probe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Sanity check - ensure at least 1 port is INITIATOR capable</span>
<span class="cm">	 */</span>
	<span class="n">ioc_cap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">[</span><span class="n">ii</span><span class="p">].</span><span class="n">ProtocolFlags</span> <span class="o">&amp;</span>
				<span class="n">MPI_PORTFACTS_PROTOCOL_INITIATOR</span><span class="p">)</span>
			<span class="n">ioc_cap</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc_cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			<span class="s">&quot;Skipping ioc=%p because SCSI Initiator mode &quot;</span>
			<span class="s">&quot;is NOT enabled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sh</span> <span class="o">=</span> <span class="n">scsi_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptsas_driver_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MPT_SCSI_HOST</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			<span class="s">&quot;Unable to register controller with SCSI subsystem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mptsas_probe</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Attach the SCSI Host to the IOC structure</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span> <span class="o">=</span> <span class="n">sh</span><span class="p">;</span>

	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">io_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">n_io_port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set 16 byte cdb&#39;s */</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_cmd_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">can_queue</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">can_queue</span><span class="p">);</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="n">max_lun</span><span class="p">;</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">transportt</span> <span class="o">=</span> <span class="n">mptsas_transport_template</span><span class="p">;</span>

	<span class="cm">/* Required entry.</span>
<span class="cm">	 */</span>
	<span class="n">sh</span><span class="o">-&gt;</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_discovery_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_mgmt</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>

	<span class="cm">/* Verify that we won&#39;t exceed the maximum</span>
<span class="cm">	 * number of chain buffers</span>
<span class="cm">	 * We can optimize:  ZZ = req_sz/sizeof(SGE)</span>
<span class="cm">	 * For 32bit SGE&#39;s:</span>
<span class="cm">	 *  numSGE = 1 + (ZZ-1)*(maxChain -1) + ZZ</span>
<span class="cm">	 *               + (req_sz - 64)/sizeof(SGE)</span>
<span class="cm">	 * A slightly different algorithm is required for</span>
<span class="cm">	 * 64bit SGEs.</span>
<span class="cm">	 */</span>
	<span class="n">scale</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="o">/</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sg_addr_size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">numSGE</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		  <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxChainDepth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">+</span>
		  <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">-</span> <span class="mi">60</span><span class="p">)</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">numSGE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">scale</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
		  <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxChainDepth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">+</span>
		  <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">-</span> <span class="mi">64</span><span class="p">)</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">numSGE</span> <span class="o">&lt;</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset this value */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		  <span class="s">&quot;Resetting sg_tablesize to %d from %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">numSGE</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span><span class="p">));</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">numSGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_loadtime_max_sectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpt_loadtime_max_sectors</span> <span class="o">&lt;</span> <span class="mi">64</span> <span class="o">||</span>
			<span class="n">mpt_loadtime_max_sectors</span> <span class="o">&gt;</span> <span class="mi">8192</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;Invalid value passed for&quot;</span>
				<span class="s">&quot;mpt_loadtime_max_sectors %d.&quot;</span>
				<span class="s">&quot;Range from 64 to 8192</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">mpt_loadtime_max_sectors</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mpt_loadtime_max_sectors</span> <span class="o">&amp;=</span>  <span class="mh">0xFFFFFFFE</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			<span class="s">&quot;Resetting max sector to %d from %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mpt_loadtime_max_sectors</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_sectors</span><span class="p">));</span>
		<span class="n">sh</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="n">mpt_loadtime_max_sectors</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
	<span class="n">hd</span><span class="o">-&gt;</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">ioc</span><span class="p">;</span>

	<span class="cm">/* SCSI needs scsi_cmnd lookup table!</span>
<span class="cm">	 * (with size equal to req_depth*PtrSz!)</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_mptsas_probe</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">scsi_lookup_lock</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;ScsiLookup @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ScsiLookup</span><span class="p">));</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_data</span><span class="p">.</span><span class="n">ptClear</span> <span class="o">=</span> <span class="n">mpt_pt_clear</span><span class="p">;</span>

	<span class="n">hd</span><span class="o">-&gt;</span><span class="n">last_queue_full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hd</span><span class="o">-&gt;</span><span class="n">target_reset_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_list</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_device_info_mutex</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_data</span><span class="p">.</span><span class="n">ptClear</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mptbase_sas_persist_operation</span><span class="p">(</span>
		    <span class="n">ioc</span><span class="p">,</span> <span class="n">MPI_SAS_OP_CLEAR_ALL_PERSISTENT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">scsi_add_host</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
		  <span class="s">&quot;scsi_add_host failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out_mptsas_probe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* older firmware doesn&#39;t support expander events */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">HeaderVersion</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0xE</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">old_sas_discovery_protocal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mptsas_scan_sas_topology</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">mptsas_fw_event_on</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_mptsas_probe:</span>

	<span class="n">mptscsih_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">mptsas_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">mptsas_fw_event_off</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">mptsas_cleanup_fw_event_q</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">mptsas_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mptsas_portinfo</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;IOC is in Target mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">mpt_detach</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mptsas_shutdown</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">mptsas_del_device_components</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_discovery_ignore_events</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sas_remove_host</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_phys</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">mptsas_port_delete</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port_details</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">phy_info</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_topology_mutex</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hba_port_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mptscsih_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">mptsas_pci_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LSI_LOGIC</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1064</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LSI_LOGIC</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1068</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LSI_LOGIC</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1064E</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LSI_LOGIC</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1068E</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LSI_LOGIC</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1078</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LSI_LOGIC</span><span class="p">,</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1068_820XELP</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">}</span>	<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">mptsas_pci_table</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">mptsas_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;mptsas&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">mptsas_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mptsas_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">mptsas_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">mptsas_shutdown</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">mptscsih_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">mptscsih_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">mptsas_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">show_mptmod_ver</span><span class="p">(</span><span class="n">my_NAME</span><span class="p">,</span> <span class="n">my_VERSION</span><span class="p">);</span>

	<span class="n">mptsas_transport_template</span> <span class="o">=</span>
	    <span class="n">sas_attach_transport</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptsas_transport_functions</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mptsas_transport_template</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">mptsas_transport_template</span><span class="o">-&gt;</span><span class="n">eh_timed_out</span> <span class="o">=</span> <span class="n">mptsas_eh_timed_out</span><span class="p">;</span>

	<span class="n">mptsasDoneCtx</span> <span class="o">=</span> <span class="n">mpt_register</span><span class="p">(</span><span class="n">mptscsih_io_done</span><span class="p">,</span> <span class="n">MPTSAS_DRIVER</span><span class="p">,</span>
	    <span class="s">&quot;mptscsih_io_done&quot;</span><span class="p">);</span>
	<span class="n">mptsasTaskCtx</span> <span class="o">=</span> <span class="n">mpt_register</span><span class="p">(</span><span class="n">mptscsih_taskmgmt_complete</span><span class="p">,</span> <span class="n">MPTSAS_DRIVER</span><span class="p">,</span>
	    <span class="s">&quot;mptscsih_taskmgmt_complete&quot;</span><span class="p">);</span>
	<span class="n">mptsasInternalCtx</span> <span class="o">=</span>
		<span class="n">mpt_register</span><span class="p">(</span><span class="n">mptscsih_scandv_complete</span><span class="p">,</span> <span class="n">MPTSAS_DRIVER</span><span class="p">,</span>
		    <span class="s">&quot;mptscsih_scandv_complete&quot;</span><span class="p">);</span>
	<span class="n">mptsasMgmtCtx</span> <span class="o">=</span> <span class="n">mpt_register</span><span class="p">(</span><span class="n">mptsas_mgmt_done</span><span class="p">,</span> <span class="n">MPTSAS_DRIVER</span><span class="p">,</span>
	    <span class="s">&quot;mptsas_mgmt_done&quot;</span><span class="p">);</span>
	<span class="n">mptsasDeviceResetCtx</span> <span class="o">=</span>
		<span class="n">mpt_register</span><span class="p">(</span><span class="n">mptsas_taskmgmt_complete</span><span class="p">,</span> <span class="n">MPTSAS_DRIVER</span><span class="p">,</span>
		    <span class="s">&quot;mptsas_taskmgmt_complete&quot;</span><span class="p">);</span>

	<span class="n">mpt_event_register</span><span class="p">(</span><span class="n">mptsasDoneCtx</span><span class="p">,</span> <span class="n">mptsas_event_process</span><span class="p">);</span>
	<span class="n">mpt_reset_register</span><span class="p">(</span><span class="n">mptsasDoneCtx</span><span class="p">,</span> <span class="n">mptsas_ioc_reset</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptsas_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">sas_release_transport</span><span class="p">(</span><span class="n">mptsas_transport_template</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">mptsas_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptsas_driver</span><span class="p">);</span>
	<span class="n">sas_release_transport</span><span class="p">(</span><span class="n">mptsas_transport_template</span><span class="p">);</span>

	<span class="n">mpt_reset_deregister</span><span class="p">(</span><span class="n">mptsasDoneCtx</span><span class="p">);</span>
	<span class="n">mpt_event_deregister</span><span class="p">(</span><span class="n">mptsasDoneCtx</span><span class="p">);</span>

	<span class="n">mpt_deregister</span><span class="p">(</span><span class="n">mptsasMgmtCtx</span><span class="p">);</span>
	<span class="n">mpt_deregister</span><span class="p">(</span><span class="n">mptsasInternalCtx</span><span class="p">);</span>
	<span class="n">mpt_deregister</span><span class="p">(</span><span class="n">mptsasTaskCtx</span><span class="p">);</span>
	<span class="n">mpt_deregister</span><span class="p">(</span><span class="n">mptsasDoneCtx</span><span class="p">);</span>
	<span class="n">mpt_deregister</span><span class="p">(</span><span class="n">mptsasDeviceResetCtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">mptsas_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mptsas_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
