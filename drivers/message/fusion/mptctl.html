<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › message › fusion › mptctl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mptctl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/message/fusion/mptctl.c</span>
<span class="cm"> *      mpt Ioctl driver.</span>
<span class="cm"> *      For use with LSI PCI chip/adapters</span>
<span class="cm"> *      running LSI Fusion MPT (Message Passing Technology) firmware.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 1999-2008 LSI Corporation</span>
<span class="cm"> *  (mailto:DL-MPTFusionLinux@lsi.com)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; version 2 of the License.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    NO WARRANTY</span>
<span class="cm">    THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span>
<span class="cm">    CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT</span>
<span class="cm">    LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,</span>
<span class="cm">    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is</span>
<span class="cm">    solely responsible for determining the appropriateness of using and</span>
<span class="cm">    distributing the Program and assumes all risks associated with its</span>
<span class="cm">    exercise of rights under this Agreement, including but not limited to</span>
<span class="cm">    the risks and costs of program errors, damage to or loss of data,</span>
<span class="cm">    programs or equipment, and unavailability or interruption of operations.</span>

<span class="cm">    DISCLAIMER OF LIABILITY</span>
<span class="cm">    NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY</span>
<span class="cm">    DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm">    DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND</span>
<span class="cm">    ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR</span>
<span class="cm">    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE</span>
<span class="cm">    USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED</span>
<span class="cm">    HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm">*/</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;	</span><span class="cm">/* for mdelay */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_tcq.h&gt;</span>

<span class="cp">#define COPYRIGHT	&quot;Copyright (c) 1999-2008 LSI Corporation&quot;</span>
<span class="cp">#define MODULEAUTHOR	&quot;LSI Corporation&quot;</span>
<span class="cp">#include &quot;mptbase.h&quot;</span>
<span class="cp">#include &quot;mptctl.h&quot;</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cp">#define my_NAME		&quot;Fusion MPT misc device (ioctl) driver&quot;</span>
<span class="cp">#define my_VERSION	MPT_LINUX_VERSION_COMMON</span>
<span class="cp">#define MYNAM		&quot;mptctl&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">MODULEAUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">my_NAME</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">my_VERSION</span><span class="p">);</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">mpctl_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">mptctl_id</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">mptctl_taskmgmt_id</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span> <span class="p">(</span> <span class="n">mptctl_wait</span> <span class="p">);</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>

<span class="k">struct</span> <span class="n">buflist</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">kptr</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">len</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Function prototypes. Called from OS entry point mptctl_ioctl.</span>
<span class="cm"> * arg contents specific to function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptctl_fw_download</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptctl_getiocinfo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptctl_gettargetinfo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptctl_readtest</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptctl_mpt_command</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptctl_eventquery</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptctl_eventenable</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptctl_eventreport</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptctl_replace_fw</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mptctl_do_reset</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptctl_hp_hostinfo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptctl_hp_targetinfo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">mptctl_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mptctl_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">compat_mpctl_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cm">/*</span>
<span class="cm"> * Private function calls.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptctl_do_mpt_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_command</span> <span class="n">karg</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">mfPtr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptctl_do_fw_download</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ufwbuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">fwlen</span><span class="p">);</span>
<span class="k">static</span> <span class="n">MptSge_t</span> <span class="o">*</span><span class="n">kbuf_alloc_2_sgl</span><span class="p">(</span><span class="kt">int</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sge_offset</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">frags</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">buflist</span> <span class="o">**</span><span class="n">blp</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">sglbuf_dma</span><span class="p">,</span> <span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">kfree_sgl</span><span class="p">(</span><span class="n">MptSge_t</span> <span class="o">*</span><span class="n">sgl</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">sgl_dma</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">buflist</span> <span class="o">*</span><span class="n">buflist</span><span class="p">,</span> <span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Reset Handler cleanup function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">mptctl_ioc_reset</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_phase</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Event Handler function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mptctl_event_process</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">EventNotificationReply_t</span> <span class="o">*</span><span class="n">pEvReply</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fasync_struct</span> <span class="o">*</span><span class="n">async_queue</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> * Scatter gather list (SGL) sizes and limits...</span>
<span class="cm"> */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define MAX<em>SCSI</em>FRAGS    9</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#define MAX_FRAGS_SPILL1	9</span>
<span class="cp">#define MAX_FRAGS_SPILL2	15</span>
<span class="cp">#define FRAGS_PER_BUCKET	(MAX_FRAGS_SPILL2 + 1)</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><h1>define MAX<em>CHAIN</em>FRAGS    64</h1>

<h1>define MAX<em>CHAIN</em>FRAGS    (15+15+15+16)</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#define MAX_CHAIN_FRAGS		(4 * MAX_FRAGS_SPILL2 + 1)</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Define max sg LIST bytes ( == (#frags + #chains) * 8 bytes each)
 Works out to: 592d bytes!     (9+1)<em>8 + 4</em>(15+1)*8
                 ^----------------- 80 + 512</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define MAX_SGL_BYTES		((MAX_FRAGS_SPILL1 + 1 + (4 * FRAGS_PER_BUCKET)) * 8)</span>

<span class="cm">/* linux only seems to ever give 128kB MAX contiguous (GFP_USER) mem bytes */</span>
<span class="cp">#define MAX_KMALLOC_SZ		(128*1024)</span>

<span class="cp">#define MPT_IOCTL_DEFAULT_TIMEOUT 10	</span><span class="cm">/* Default timeout value (seconds) */</span><span class="cp"></span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptctl_syscall_down - Down the MPT adapter syscall semaphore.</span>
<span class="cm"> *	@ioc: Pointer to MPT adapter</span>
<span class="cm"> *	@nonblock: boolean, non-zero if O_NONBLOCK is set</span>
<span class="cm"> *</span>
<span class="cm"> *	All of the ioctl commands can potentially sleep, which is illegal</span>
<span class="cm"> *	with a spinlock held, thus we perform mutual exclusion here.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns negative errno on error, or zero for success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">mptctl_syscall_down</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nonblock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nonblock</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *  This is the callback for any message we have posted. The message itself</span>
<span class="cm"> *  will be returned to the message pool when we return from the IRQ</span>
<span class="cm"> *</span>
<span class="cm"> *  This runs in irq context so be short and sweet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_reply</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">sense_data</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">req_index</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">sz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;completing mpi function &quot;</span>
	    <span class="s">&quot;(0x%02X), req=%p, reply=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>  <span class="n">req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Function</span><span class="p">,</span>
	    <span class="n">req</span><span class="p">,</span> <span class="n">reply</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handling continuation of the same reply. Processing the first</span>
<span class="cm">	 * reply, and eating the other replys that come later.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">msg_context</span> <span class="o">!=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">MsgContext</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_continuation</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">;</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">reply</span><span class="p">.</span><span class="n">MsgLength</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">reply</span><span class="p">.</span><span class="n">IOCStatus</span> <span class="o">||</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">reply</span><span class="p">.</span><span class="n">IOCLogInfo</span><span class="p">)</span>
		<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;iocstatus (0x%04X), loginfo (0x%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">),</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">reply</span><span class="p">.</span><span class="n">IOCLogInfo</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Function</span> <span class="o">==</span> <span class="n">MPI_FUNCTION_SCSI_IO_REQUEST</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Function</span> <span class="o">==</span>
		 <span class="n">MPI_FUNCTION_RAID_SCSI_IO_PASSTHROUGH</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sreply</span><span class="p">.</span><span class="n">SCSIStatus</span> <span class="o">||</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sreply</span><span class="p">.</span><span class="n">SCSIState</span><span class="p">)</span>
			<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			<span class="s">&quot;scsi_status (0x%02x), scsi_state (0x%02x), &quot;</span>
			<span class="s">&quot;tag = (0x%04x), transfer_count (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sreply</span><span class="p">.</span><span class="n">SCSIStatus</span><span class="p">,</span>
			<span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sreply</span><span class="p">.</span><span class="n">SCSIState</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sreply</span><span class="p">.</span><span class="n">TaskTag</span><span class="p">),</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sreply</span><span class="p">.</span><span class="n">TransferCount</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sreply</span><span class="p">.</span><span class="n">SCSIState</span> <span class="o">&amp;</span>
			<span class="n">MPI_SCSI_STATE_AUTOSENSE_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sz</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scsireq</span><span class="p">.</span><span class="n">SenseBufferLength</span><span class="p">;</span>
			<span class="n">req_index</span> <span class="o">=</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">req_idx</span><span class="p">);</span>
			<span class="n">sense_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool</span> <span class="o">+</span>
			     <span class="p">(</span><span class="n">req_index</span> <span class="o">*</span> <span class="n">MPT_SENSE_BUFFER_ALLOC</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">sense</span><span class="p">,</span> <span class="n">sense_data</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_SENSE_VALID</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="cm">/* We are done, issue wake up</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Function</span> <span class="o">==</span> <span class="n">MPI_FUNCTION_SCSI_TASK_MGMT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mpt_clear_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">;</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span><span class="p">)</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">schedule_target_reset</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">;</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out_continuation:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reply</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">reply</span><span class="p">.</span><span class="n">MsgFlags</span> <span class="o">&amp;</span>
	    <span class="n">MPI_MSGFLAGS_CONTINUATION_REPLY</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_taskmgmt_reply</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		<span class="s">&quot;TaskMgmt completed (mf=%p, mr=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mr</span><span class="p">));</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span>
	    <span class="n">min</span><span class="p">(</span><span class="n">MPT_DEFAULT_FRAME_SIZE</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">reply</span><span class="p">.</span><span class="n">MsgLength</span><span class="p">));</span>
 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpt_clear_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">;</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">schedule_target_reset</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_do_taskmgmt</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tm_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bus_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">target_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_FRAME_HDR</span>	<span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">SCSITaskMgmt_t</span>	<span class="o">*</span><span class="n">pScsiTm</span><span class="p">;</span>
	<span class="n">SCSITaskMgmtReply_t</span> <span class="o">*</span><span class="n">pScsiTmReply</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">ii</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">time_count</span><span class="p">;</span>
	<span class="n">u16</span>		 <span class="n">iocstatus</span><span class="p">;</span>


	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_set_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">mptctl_taskmgmt_id</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;TaskMgmt, no msg frames!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">mpt_clear_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">tm_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;TaskMgmt request (mf=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mf</span><span class="p">));</span>

	<span class="n">pScsiTm</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSITaskMgmt_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pScsiTm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SCSITaskMgmt_t</span><span class="p">));</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_SCSI_TASK_MGMT</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">TaskType</span> <span class="o">=</span> <span class="n">tm_type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tm_type</span> <span class="o">==</span> <span class="n">MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FC</span><span class="p">))</span>
		<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">=</span>
				<span class="n">MPI_SCSITASKMGMT_MSGFLAGS_LIPRESET_RESET_OPTION</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">=</span> <span class="n">target_id</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">=</span> <span class="n">bus_id</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Reserved1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">TaskMsgContext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">LUN</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Reserved2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FC</span>:
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAS</span>:
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPI</span>:
		<span class="nl">default:</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;TaskMgmt type=%d timeout=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tm_type</span><span class="p">,</span> <span class="n">timeout</span><span class="p">));</span>

	<span class="n">INITIALIZE_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">time_count</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span> <span class="n">MPI_IOCFACTS_CAPABILITY_HIGH_PRI_Q</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MsgVersion</span> <span class="o">&gt;=</span> <span class="n">MPI_VERSION_01_05</span><span class="p">))</span>
		<span class="n">mpt_put_msg_frame_hi_pri</span><span class="p">(</span><span class="n">mptctl_taskmgmt_id</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">mpt_send_handshake_request</span><span class="p">(</span><span class="n">mptctl_taskmgmt_id</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">SCSITaskMgmt_t</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">pScsiTm</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
				<span class="s">&quot;TaskMgmt send_handshake FAILED!&quot;</span>
				<span class="s">&quot; (ioc %p, mf %p, rc=%d) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">retval</span><span class="p">));</span>
			<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
			<span class="n">mpt_clear_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">tm_done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Now wait for the command to complete */</span>
	<span class="n">ii</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span> <span class="n">timeout</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;TaskMgmt failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
		<span class="n">mpt_clear_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* return failure */</span>
		<span class="k">goto</span> <span class="n">tm_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;TaskMgmt failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* return failure */</span>
		<span class="k">goto</span> <span class="n">tm_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pScsiTmReply</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSITaskMgmtReply_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">;</span>
	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;TaskMgmt fw_channel = %d, fw_id = %d, task_type=0x%02X, &quot;</span>
	    <span class="s">&quot;iocstatus=0x%04X</span><span class="se">\n\t</span><span class="s">loginfo=0x%08X, response_code=0x%02X, &quot;</span>
	    <span class="s">&quot;term_cmnds=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">,</span>
	    <span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span> <span class="n">tm_type</span><span class="p">,</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">),</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">),</span>
	    <span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">ResponseCode</span><span class="p">,</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">TerminationCount</span><span class="p">)));</span>

	<span class="n">iocstatus</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pScsiTmReply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_IOCSTATUS_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iocstatus</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_SCSI_TASK_TERMINATED</span> <span class="o">||</span>
	   <span class="n">iocstatus</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_SCSI_IOC_TERMINATED</span> <span class="o">||</span>
	   <span class="n">iocstatus</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;TaskMgmt failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* return failure */</span>
	<span class="p">}</span>

 <span class="nl">tm_done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">CLEAR_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/* mptctl_timeout_expired</span>
<span class="cm"> *</span>
<span class="cm"> * Expecting an interrupt, however timed out.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptctl_timeout_expired</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="n">scsi_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">function</span> <span class="o">=</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Function</span><span class="p">;</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_fwfault_debug</span><span class="p">)</span>
		<span class="n">mpt_halt_firmware</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">CLEAR_MGMT_PENDING_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
		<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>


	<span class="n">CLEAR_MGMT_PENDING_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">function</span> <span class="o">==</span> <span class="n">MPI_FUNCTION_SCSI_IO_REQUEST</span><span class="p">)</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">mptctl_do_taskmgmt</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
				<span class="n">MPI_SCSITASKMGMT_TASKTYPE_TARGET_RESET</span><span class="p">,</span>
				<span class="n">scsi_req</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">,</span> <span class="n">scsi_req</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">function</span> <span class="o">==</span> <span class="n">MPI_FUNCTION_RAID_SCSI_IO_PASSTHROUGH</span><span class="p">)</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">mptctl_do_taskmgmt</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
				<span class="n">MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS</span><span class="p">,</span>
				<span class="n">scsi_req</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">function</span> <span class="o">==</span> <span class="n">MPI_FUNCTION_SCSI_IO_REQUEST</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">function</span> <span class="o">==</span> <span class="n">MPI_FUNCTION_RAID_SCSI_IO_PASSTHROUGH</span><span class="p">))</span>
			<span class="n">ret_val</span> <span class="o">=</span> <span class="n">mptctl_do_taskmgmt</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
				<span class="n">MPI_SCSITASKMGMT_TASKTYPE_RESET_BUS</span><span class="p">,</span>
				<span class="n">scsi_req</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret_val</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Calling Reset! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">mpt_Soft_Hard_ResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
	<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/* mptctl_ioc_reset</span>
<span class="cm"> *</span>
<span class="cm"> * Clean-up functionality. Used only if there has been a</span>
<span class="cm"> * reload of the FW due.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_ioc_reset</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_phase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">reset_phase</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPT_IOC_SETUP_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: MPT_IOC_SETUP_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT_IOC_PRE_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: MPT_IOC_PRE_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT_IOC_POST_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: MPT_IOC_POST_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">;</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/* ASYNC Event Notification Support */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_event_process</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">EventNotificationReply_t</span> <span class="o">*</span><span class="n">pEvReply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">event</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pEvReply</span><span class="o">-&gt;</span><span class="n">Event</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;%s() called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
	<span class="k">if</span><span class="p">(</span><span class="n">async_queue</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Raise SIGIO for persistent events.</span>
<span class="cm">	 * TODO - this define is not in MPI spec yet,</span>
<span class="cm">	 * but they plan to set it to 0x21</span>
<span class="cm">	 */</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="mh">0x21</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">aen_event_read_flag</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Raised SIGIO to application</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">devtverboseprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;Raised SIGIO to application</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">kill_fasync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">async_queue</span><span class="p">,</span> <span class="n">SIGIO</span><span class="p">,</span> <span class="n">POLL_IN</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	 <span class="p">}</span>

	<span class="cm">/* This flag is set after SIGIO was raised, and</span>
<span class="cm">	 * remains set until the application has read</span>
<span class="cm">	 * the event log via ioctl=MPTEVENTREPORT</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">aen_event_read_flag</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Signal only for the events that are</span>
<span class="cm">	 * requested for by the application</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">eventTypes</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">event</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">aen_event_read_flag</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;Raised SIGIO to application</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">devtverboseprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;Raised SIGIO to application</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">kill_fasync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">async_queue</span><span class="p">,</span> <span class="n">SIGIO</span><span class="p">,</span> <span class="n">POLL_IN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fasync_helper</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">filep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">async_queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_fasync</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpctl_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">aen_event_read_flag</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fasync_helper</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">filep</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">async_queue</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpctl_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *  MPT ioctl handler</span>
<span class="cm"> *  cmd - specify the particular IOCTL command to be issued</span>
<span class="cm"> *  arg - data specific to the command. Must not be null.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span>
<span class="nf">__mptctl_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mpt_ioctl_header</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uhdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">mpt_ioctl_header</span>	 <span class="n">khdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iocnum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">iocnumX</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nonblock</span> <span class="o">=</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">iocp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">khdr</span><span class="p">,</span> <span class="n">uhdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">khdr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;%s::mptctl_ioctl() @%d - &quot;</span>
				<span class="s">&quot;Unable to copy mpt_ioctl_header data @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uhdr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>				<span class="cm">/* (-6) No such device or address */</span>

	<span class="cm">/* Verify intended MPT adapter - set iocnum and the adapter</span>
<span class="cm">	 * pointer (iocp)</span>
<span class="cm">	 */</span>
	<span class="n">iocnumX</span> <span class="o">=</span> <span class="n">khdr</span><span class="p">.</span><span class="n">iocnum</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">iocnum</span> <span class="o">=</span> <span class="n">mpt_verify_adapter</span><span class="p">(</span><span class="n">iocnumX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iocp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">iocp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iocp</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span> <span class="s">&quot;%s::mptctl_ioctl() @%d - Controller disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handle those commands that are just returning</span>
<span class="cm">	 * information stored in the driver.</span>
<span class="cm">	 * These commands should never time out and are unaffected</span>
<span class="cm">	 * by TM and FW reloads.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IOCSIZE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">MPTIOCINFO</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IOCSIZE_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">mptctl_getiocinfo</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MPTTARGETINFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">mptctl_gettargetinfo</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MPTTEST</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">mptctl_readtest</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MPTEVENTQUERY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">mptctl_eventquery</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MPTEVENTENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">mptctl_eventenable</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MPTEVENTREPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">mptctl_eventreport</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MPTFWREPLACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">mptctl_replace_fw</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* All of these commands require an interrupt or</span>
<span class="cm">	 * are unknown/illegal.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">mptctl_syscall_down</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="n">nonblock</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MPTFWDOWNLOAD</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mptctl_fw_download</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MPTCOMMAND</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mptctl_mpt_command</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MPTHARDRESET</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mptctl_do_reset</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IOCSIZE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">HP_GETHOSTINFO</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IOCSIZE_MASK</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mptctl_hp_hostinfo</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">HP_GETTARGETINFO</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mptctl_hp_targetinfo</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iocp</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">mptctl_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpctl_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__mptctl_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpctl_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mptctl_do_reset</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_diag_reset</span> <span class="n">__user</span> <span class="o">*</span><span class="n">urinfo</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_diag_reset</span> <span class="n">krinfo</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>		<span class="o">*</span><span class="n">iocp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">krinfo</span><span class="p">,</span> <span class="n">urinfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_diag_reset</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;%s@%d::mptctl_do_reset - &quot;</span>
				<span class="s">&quot;Unable to copy mpt_ioctl_diag_reset struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">urinfo</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_verify_adapter</span><span class="p">(</span><span class="n">krinfo</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">iocnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iocp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span> <span class="s">&quot;%s@%d::mptctl_do_reset - ioc%d not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">krinfo</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">iocnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span> <span class="cm">/* (-6) No such device or address */</span>
	<span class="p">}</span>

	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;mptctl_do_reset called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_HardResetHandler</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_do_reset - reset failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> * MPT FW download function.  Cast the arg into the mpt_fw_xfer structure.</span>
<span class="cm"> * This structure contains: iocnum, firmware length (bytes),</span>
<span class="cm"> *      pointer to user space memory where the fw image is stored.</span>
<span class="cm"> *</span>
<span class="cm"> * Outputs:	None.</span>
<span class="cm"> * Return:	0 if successful</span>
<span class="cm"> *		-EFAULT if data unavailable</span>
<span class="cm"> *		-ENXIO  if no such device</span>
<span class="cm"> *		-EAGAIN if resource problem</span>
<span class="cm"> *		-ENOMEM if no memory for SGE</span>
<span class="cm"> *		-EMLINK if too many chain buffers required</span>
<span class="cm"> *		-EBADRQC if adapter does not support FW download</span>
<span class="cm"> *		-EBUSY if adapter is busy</span>
<span class="cm"> *		-ENOMSG if FW upload returned bad status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_fw_download</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpt_fw_xfer</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ufwdl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpt_fw_xfer</span>	 <span class="n">kfwdl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kfwdl</span><span class="p">,</span> <span class="n">ufwdl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_fw_xfer</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;%s@%d::_ioctl_fwdl - &quot;</span>
				<span class="s">&quot;Unable to copy mpt_fw_xfer struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ufwdl</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mptctl_do_fw_download</span><span class="p">(</span><span class="n">kfwdl</span><span class="p">.</span><span class="n">iocnum</span><span class="p">,</span> <span class="n">kfwdl</span><span class="p">.</span><span class="n">bufp</span><span class="p">,</span> <span class="n">kfwdl</span><span class="p">.</span><span class="n">fwlen</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> * FW Download engine.</span>
<span class="cm"> * Outputs:	None.</span>
<span class="cm"> * Return:	0 if successful</span>
<span class="cm"> *		-EFAULT if data unavailable</span>
<span class="cm"> *		-ENXIO  if no such device</span>
<span class="cm"> *		-EAGAIN if resource problem</span>
<span class="cm"> *		-ENOMEM if no memory for SGE</span>
<span class="cm"> *		-EMLINK if too many chain buffers required</span>
<span class="cm"> *		-EBADRQC if adapter does not support FW download</span>
<span class="cm"> *		-EBUSY if adapter is busy</span>
<span class="cm"> *		-ENOMSG if FW upload returned bad status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_do_fw_download</span><span class="p">(</span><span class="kt">int</span> <span class="n">ioc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ufwbuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">fwlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FWDownload_t</span>		<span class="o">*</span><span class="n">dlmsg</span><span class="p">;</span>
	<span class="n">MPT_FRAME_HDR</span>		<span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>		<span class="o">*</span><span class="n">iocp</span><span class="p">;</span>
	<span class="n">FWDownloadTCSGE_t</span>	<span class="o">*</span><span class="n">ptsge</span><span class="p">;</span>
	<span class="n">MptSge_t</span>		<span class="o">*</span><span class="n">sgl</span><span class="p">,</span> <span class="o">*</span><span class="n">sgIn</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">sgOut</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buflist</span>		<span class="o">*</span><span class="n">buflist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buflist</span>		<span class="o">*</span><span class="n">bl</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		 <span class="n">sgl_dma</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">numfrags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">maxfrags</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">sgdir</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">nib</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">fw_bytes_copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">sge_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span>			 <span class="n">iocstat</span><span class="p">;</span>
	<span class="n">pFWDownloadReply_t</span>	 <span class="n">ReplyMsg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		 <span class="n">timeleft</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_verify_adapter</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iocp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span> <span class="s">&quot;ioctl_fwdl - ioc%d not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span> <span class="cm">/* (-6) No such device or address */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/*  Valid device. Get a message frame and construct the FW download message.</span>
<span class="cm">	 	*/</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">mptctl_id</span><span class="p">,</span> <span class="n">iocp</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;mptctl_do_fwdl called. mptctl_id = %xh.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mptctl_id</span><span class="p">));</span>
	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;DbG: kfwdl.bufp  = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ufwbuf</span><span class="p">));</span>
	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;DbG: kfwdl.fwlen = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">fwlen</span><span class="p">));</span>
	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;DbG: kfwdl.ioc   = %04xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="p">));</span>

	<span class="n">dlmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">FWDownload_t</span><span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>
	<span class="n">ptsge</span> <span class="o">=</span> <span class="p">(</span><span class="n">FWDownloadTCSGE_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dlmsg</span><span class="o">-&gt;</span><span class="n">SGL</span><span class="p">;</span>
	<span class="n">sgOut</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ptsge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Construct f/w download request</span>
<span class="cm">	 */</span>
	<span class="n">dlmsg</span><span class="o">-&gt;</span><span class="n">ImageType</span> <span class="o">=</span> <span class="n">MPI_FW_DOWNLOAD_ITYPE_FW</span><span class="p">;</span>
	<span class="n">dlmsg</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dlmsg</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dlmsg</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_FW_DOWNLOAD</span><span class="p">;</span>
	<span class="n">dlmsg</span><span class="o">-&gt;</span><span class="n">Reserved1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlmsg</span><span class="o">-&gt;</span><span class="n">Reserved1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlmsg</span><span class="o">-&gt;</span><span class="n">Reserved1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iocp</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MsgVersion</span> <span class="o">&gt;=</span> <span class="n">MPI_VERSION_01_05</span><span class="p">)</span>
		<span class="n">dlmsg</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">=</span> <span class="n">MPI_FW_DOWNLOAD_MSGFLGS_LAST_SEGMENT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dlmsg</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="cm">/* Set up the Transaction SGE.</span>
<span class="cm">	 */</span>
	<span class="n">ptsge</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptsge</span><span class="o">-&gt;</span><span class="n">ContextSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptsge</span><span class="o">-&gt;</span><span class="n">DetailsLength</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">ptsge</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">MPI_SGE_FLAGS_TRANSACTION_ELEMENT</span><span class="p">;</span>
	<span class="n">ptsge</span><span class="o">-&gt;</span><span class="n">Reserved_0100_Checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptsge</span><span class="o">-&gt;</span><span class="n">ImageOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptsge</span><span class="o">-&gt;</span><span class="n">ImageSize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">fwlen</span><span class="p">);</span>

	<span class="cm">/* Add the SGL</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Need to kmalloc area(s) for holding firmware image bytes.</span>
<span class="cm">	 * But we need to do it piece meal, using a proper</span>
<span class="cm">	 * scatter gather list (with 128kB MAX hunks).</span>
<span class="cm">	 *</span>
<span class="cm">	 * A practical limit here might be # of sg hunks that fit into</span>
<span class="cm">	 * a single IOC request frame; 12 or 8 (see below), so:</span>
<span class="cm">	 * For FC9xx: 12 x 128kB == 1.5 mB (max)</span>
<span class="cm">	 * For C1030:  8 x 128kB == 1   mB (max)</span>
<span class="cm">	 * We could support chaining, but things get ugly(ier:)</span>
<span class="cm">	 *</span>
<span class="cm">	 * Set the sge_offset to the start of the sgl (bytes).</span>
<span class="cm">	 */</span>
	<span class="n">sgdir</span> <span class="o">=</span> <span class="mh">0x04000000</span><span class="p">;</span>		<span class="cm">/* IOC will READ from sys mem */</span>
	<span class="n">sge_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MPIHeader_t</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FWDownloadTCSGE_t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sgl</span> <span class="o">=</span> <span class="n">kbuf_alloc_2_sgl</span><span class="p">(</span><span class="n">fwlen</span><span class="p">,</span> <span class="n">sgdir</span><span class="p">,</span> <span class="n">sge_offset</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">numfrags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buflist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sgl_dma</span><span class="p">,</span> <span class="n">iocp</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We should only need SGL with 2 simple_32bit entries (up to 256 kB)</span>
<span class="cm">	 * for FC9xx f/w image, but calculate max number of sge hunks</span>
<span class="cm">	 * we can fit into a request frame, and limit ourselves to that.</span>
<span class="cm">	 * (currently no chain support)</span>
<span class="cm">	 * maxfrags = (Request Size - FWdownload Size ) / Size of 32 bit SGE</span>
<span class="cm">	 *	Request		maxfrags</span>
<span class="cm">	 *	128		12</span>
<span class="cm">	 *	96		8</span>
<span class="cm">	 *	64		4</span>
<span class="cm">	 */</span>
	<span class="n">maxfrags</span> <span class="o">=</span> <span class="p">(</span><span class="n">iocp</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MPIHeader_t</span><span class="p">)</span> <span class="o">-</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">FWDownloadTCSGE_t</span><span class="p">))</span>
			<span class="o">/</span> <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">numfrags</span> <span class="o">&gt;</span> <span class="n">maxfrags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMLINK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fwdl_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;DbG: sgl buffer = %p, sgfrags = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sgl</span><span class="p">,</span> <span class="n">numfrags</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Parse SG list, copying sgl itself,</span>
<span class="cm">	 * plus f/w image hunks from user space as we go...</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">sgIn</span> <span class="o">=</span> <span class="n">sgl</span><span class="p">;</span>
	<span class="n">bl</span> <span class="o">=</span> <span class="n">buflist</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numfrags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Get the SGE type: 0 - TCSGE, 3 - Chain, 1 - Simple SGE</span>
<span class="cm">		 * Skip everything but Simple. If simple, copy from</span>
<span class="cm">		 *	user space into kernel space.</span>
<span class="cm">		 * Note: we should not have anything but Simple as</span>
<span class="cm">		 *	Chain SGE are illegal.</span>
<span class="cm">		 */</span>
		<span class="n">nib</span> <span class="o">=</span> <span class="p">(</span><span class="n">sgIn</span><span class="o">-&gt;</span><span class="n">FlagsLength</span> <span class="o">&amp;</span> <span class="mh">0x30000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nib</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">nib</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sgIn</span><span class="o">-&gt;</span><span class="n">Address</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iocp</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">(</span><span class="n">sgOut</span><span class="p">,</span> <span class="n">sgIn</span><span class="o">-&gt;</span><span class="n">FlagsLength</span><span class="p">,</span> <span class="n">sgIn</span><span class="o">-&gt;</span><span class="n">Address</span><span class="p">);</span>
			<span class="n">n</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">bl</span><span class="o">-&gt;</span><span class="n">kptr</span><span class="p">,</span> <span class="n">ufwbuf</span><span class="o">+</span><span class="n">fw_bytes_copied</span><span class="p">,</span> <span class="n">bl</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::_ioctl_fwdl - &quot;</span>
					<span class="s">&quot;Unable to copy f/w buffer hunk#%d @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ufwbuf</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">fwdl_out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fw_bytes_copied</span> <span class="o">+=</span> <span class="n">bl</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sgIn</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bl</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sgOut</span> <span class="o">+=</span> <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG_DUMP_FW_DOWNLOAD</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">,</span> <span class="n">numfrags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Finally, perform firmware download.</span>
<span class="cm">	 */</span>
	<span class="n">ReplyMsg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">SET_MGMT_MSG_CONTEXT</span><span class="p">(</span><span class="n">iocp</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">msg_context</span><span class="p">,</span> <span class="n">dlmsg</span><span class="o">-&gt;</span><span class="n">MsgContext</span><span class="p">);</span>
	<span class="n">INITIALIZE_MGMT_STATUS</span><span class="p">(</span><span class="n">iocp</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">mpt_put_msg_frame</span><span class="p">(</span><span class="n">mptctl_id</span><span class="p">,</span> <span class="n">iocp</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>

	<span class="cm">/* Now wait for the command to complete */</span>
<span class="nl">retry_wait:</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iocp</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span> <span class="n">HZ</span><span class="o">*</span><span class="mi">60</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">iocp</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;%s: failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iocp</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fwdl_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeleft</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			       <span class="s">&quot;FW download timeout, doorbell=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
			<span class="n">mptctl_timeout_expired</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">retry_wait</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fwdl_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">iocp</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;%s: failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fwdl_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sgl</span><span class="p">)</span>
		<span class="n">kfree_sgl</span><span class="p">(</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sgl_dma</span><span class="p">,</span> <span class="n">buflist</span><span class="p">,</span> <span class="n">iocp</span><span class="p">);</span>

	<span class="n">ReplyMsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">pFWDownloadReply_t</span><span class="p">)</span><span class="n">iocp</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">;</span>
	<span class="n">iocstat</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ReplyMsg</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iocstat</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;F/W update successful!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iocstat</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_INVALID_FUNCTION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;Hmmm...  F/W download not supported!?!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;(time to go bang on somebodies door)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADRQC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iocstat</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_BUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;IOC_BUSY!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;(try again later?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;ioctl_fwdl() returned [bad] status = %04xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">iocstat</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;(bad VooDoo)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMSG</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fwdl_out:</span>

	<span class="n">CLEAR_MGMT_STATUS</span><span class="p">(</span><span class="n">iocp</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="n">SET_MGMT_MSG_CONTEXT</span><span class="p">(</span><span class="n">iocp</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">msg_context</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">kfree_sgl</span><span class="p">(</span><span class="n">sgl</span><span class="p">,</span> <span class="n">sgl_dma</span><span class="p">,</span> <span class="n">buflist</span><span class="p">,</span> <span class="n">iocp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> * SGE Allocation routine</span>
<span class="cm"> *</span>
<span class="cm"> * Inputs:	bytes - number of bytes to be transferred</span>
<span class="cm"> *		sgdir - data direction</span>
<span class="cm"> *		sge_offset - offset (in bytes) from the start of the request</span>
<span class="cm"> *			frame to the first SGE</span>
<span class="cm"> *		ioc - pointer to the mptadapter</span>
<span class="cm"> * Outputs:	frags - number of scatter gather elements</span>
<span class="cm"> *		blp - point to the buflist pointer</span>
<span class="cm"> *		sglbuf_dma - pointer to the (dma) sgl</span>
<span class="cm"> * Returns:	Null if failes</span>
<span class="cm"> *		pointer to the (virtual) sgl if successful.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">MptSge_t</span> <span class="o">*</span>
<span class="nf">kbuf_alloc_2_sgl</span><span class="p">(</span><span class="kt">int</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sgdir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sge_offset</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">frags</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">buflist</span> <span class="o">**</span><span class="n">blp</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">sglbuf_dma</span><span class="p">,</span> <span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MptSge_t</span>	<span class="o">*</span><span class="n">sglbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>		<span class="cm">/* pointer to array of SGE */</span>
						<span class="cm">/* and chain buffers */</span>
	<span class="k">struct</span> <span class="n">buflist</span>	<span class="o">*</span><span class="n">buflist</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* kernel routine */</span>
	<span class="n">MptSge_t</span>	<span class="o">*</span><span class="n">sgl</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">numfrags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">fragcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">alloc_sz</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span><span class="n">MAX_KMALLOC_SZ</span><span class="p">);</span>	<span class="c1">// avoid kernel warning msg!</span>
	<span class="kt">int</span>		 <span class="n">bytes_allocd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">this_alloc</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	 <span class="n">pa</span><span class="p">;</span>					<span class="c1">// phys addr</span>
	<span class="kt">int</span>		 <span class="n">i</span><span class="p">,</span> <span class="n">buflist_ent</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">sg_spill</span> <span class="o">=</span> <span class="n">MAX_FRAGS_SPILL1</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">dir</span><span class="p">;</span>
	<span class="cm">/* initialization */</span>
	<span class="o">*</span><span class="n">frags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">blp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Allocate and initialize an array of kernel</span>
<span class="cm">	 * structures for the SG elements.</span>
<span class="cm">	 */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">MAX_SGL_BYTES</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">buflist</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">GFP_USER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buflist</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">buflist_ent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Allocate a single block of memory to store the sg elements and</span>
<span class="cm">	 * the chain buffers.  The calling routine is responsible for</span>
<span class="cm">	 * copying the data in this array into the correct place in the</span>
<span class="cm">	 * request and chain buffers.</span>
<span class="cm">	 */</span>
	<span class="n">sglbuf</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">MAX_SGL_BYTES</span><span class="p">,</span> <span class="n">sglbuf_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sglbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_and_fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sgdir</span> <span class="o">&amp;</span> <span class="mh">0x04000000</span><span class="p">)</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">;</span>

	<span class="cm">/* At start:</span>
<span class="cm">	 *	sgl = sglbuf = point to beginning of sg buffer</span>
<span class="cm">	 *	buflist_ent = 0 = first kernel structure</span>
<span class="cm">	 *	sg_spill = number of SGE that can be written before the first</span>
<span class="cm">	 *		chain element.</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="n">sgl</span> <span class="o">=</span> <span class="n">sglbuf</span><span class="p">;</span>
	<span class="n">sg_spill</span> <span class="o">=</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">-</span> <span class="n">sge_offset</span><span class="p">)</span><span class="o">/</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bytes_allocd</span> <span class="o">&lt;</span> <span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">this_alloc</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">alloc_sz</span><span class="p">,</span> <span class="n">bytes</span><span class="o">-</span><span class="n">bytes_allocd</span><span class="p">);</span>
		<span class="n">buflist</span><span class="p">[</span><span class="n">buflist_ent</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">this_alloc</span><span class="p">;</span>
		<span class="n">buflist</span><span class="p">[</span><span class="n">buflist_ent</span><span class="p">].</span><span class="n">kptr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
								 <span class="n">this_alloc</span><span class="p">,</span>
								 <span class="o">&amp;</span><span class="n">pa</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buflist</span><span class="p">[</span><span class="n">buflist_ent</span><span class="p">].</span><span class="n">kptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">alloc_sz</span> <span class="o">=</span> <span class="n">alloc_sz</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">alloc_sz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;-SG: No can do - &quot;</span>
				    <span class="s">&quot;not enough memory!   :-(</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;-SG: (freeing %d frags)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">numfrags</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">free_and_fail</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>

			<span class="n">bytes_allocd</span> <span class="o">+=</span> <span class="n">this_alloc</span><span class="p">;</span>
			<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">FlagsLength</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x10000000</span><span class="o">|</span><span class="n">sgdir</span><span class="o">|</span><span class="n">this_alloc</span><span class="p">);</span>
			<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				<span class="n">buflist</span><span class="p">[</span><span class="n">buflist_ent</span><span class="p">].</span><span class="n">kptr</span><span class="p">,</span> <span class="n">this_alloc</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
			<span class="n">sgl</span><span class="o">-&gt;</span><span class="n">Address</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>

			<span class="n">fragcnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">numfrags</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sgl</span><span class="o">++</span><span class="p">;</span>
			<span class="n">buflist_ent</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_allocd</span> <span class="o">&gt;=</span> <span class="n">bytes</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Need to chain? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fragcnt</span> <span class="o">==</span> <span class="n">sg_spill</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			    <span class="s">&quot;-SG: No can do - &quot;</span> <span class="s">&quot;Chain required!   :-(</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;(freeing %d frags)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">numfrags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">free_and_fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* overflow check... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">numfrags</span><span class="o">*</span><span class="mi">8</span> <span class="o">&gt;</span> <span class="n">MAX_SGL_BYTES</span><span class="p">){</span>
			<span class="cm">/* GRRRRR... */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;-SG: No can do - &quot;</span>
				<span class="s">&quot;too many SG frags!   :-(</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;-SG: (freeing %d frags)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">numfrags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">free_and_fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Last sge fixup: set LE+eol+eob bits */</span>
	<span class="n">sgl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">FlagsLength</span> <span class="o">|=</span> <span class="mh">0xC1000000</span><span class="p">;</span>

	<span class="o">*</span><span class="n">frags</span> <span class="o">=</span> <span class="n">numfrags</span><span class="p">;</span>
	<span class="o">*</span><span class="n">blp</span> <span class="o">=</span> <span class="n">buflist</span><span class="p">;</span>

	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;-SG: kbuf_alloc_2_sgl() - &quot;</span>
	   <span class="s">&quot;%d SG frags generated!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">numfrags</span><span class="p">));</span>

	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;-SG: kbuf_alloc_2_sgl() - &quot;</span>
	   <span class="s">&quot;last (big) alloc_sz=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">alloc_sz</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">sglbuf</span><span class="p">;</span>

<span class="nl">free_and_fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sglbuf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numfrags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">kptr</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">sglbuf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">FlagsLength</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x30</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">sglbuf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Address</span><span class="p">;</span>
			<span class="n">kptr</span> <span class="o">=</span> <span class="n">buflist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kptr</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">buflist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>

			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">kptr</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">MAX_SGL_BYTES</span><span class="p">,</span> <span class="n">sglbuf</span><span class="p">,</span> <span class="o">*</span><span class="n">sglbuf_dma</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buflist</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> * Routine to free the SGL elements.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">kfree_sgl</span><span class="p">(</span><span class="n">MptSge_t</span> <span class="o">*</span><span class="n">sgl</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">sgl_dma</span><span class="p">,</span> <span class="k">struct</span> <span class="n">buflist</span> <span class="o">*</span><span class="n">buflist</span><span class="p">,</span> <span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MptSge_t</span>	<span class="o">*</span><span class="n">sg</span> <span class="o">=</span> <span class="n">sgl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buflist</span>	<span class="o">*</span><span class="n">bl</span> <span class="o">=</span> <span class="n">buflist</span><span class="p">;</span>
	<span class="n">u32</span>		 <span class="n">nib</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">dir</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">FlagsLength</span> <span class="o">&amp;</span> <span class="mh">0x04000000</span><span class="p">)</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">;</span>

	<span class="n">nib</span> <span class="o">=</span> <span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">FlagsLength</span> <span class="o">&amp;</span> <span class="mh">0xF0000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">nib</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* eob */</span>
		<span class="cm">/* skip ignore/chain. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nib</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">nib</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">Address</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">kptr</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

			<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">Address</span><span class="p">;</span>
			<span class="n">kptr</span> <span class="o">=</span> <span class="n">bl</span><span class="o">-&gt;</span><span class="n">kptr</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">bl</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">kptr</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">);</span>
			<span class="n">n</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sg</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bl</span><span class="o">++</span><span class="p">;</span>
		<span class="n">nib</span> <span class="o">=</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">FlagsLength</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF0000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we&#39;re at eob! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sg</span><span class="o">-&gt;</span><span class="n">Address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">kptr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">Address</span><span class="p">;</span>
		<span class="n">kptr</span> <span class="o">=</span> <span class="n">bl</span><span class="o">-&gt;</span><span class="n">kptr</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">bl</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">kptr</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">);</span>
		<span class="n">n</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">MAX_SGL_BYTES</span><span class="p">,</span> <span class="n">sgl</span><span class="p">,</span> <span class="n">sgl_dma</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buflist</span><span class="p">);</span>
	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;-SG: Free&#39;d 1 SGL buf + %d kbufs!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptctl_getiocinfo - Query the host adapter for IOC information.</span>
<span class="cm"> *	@arg: User space argument</span>
<span class="cm"> *</span>
<span class="cm"> * Outputs:	None.</span>
<span class="cm"> * Return:	0 if successful</span>
<span class="cm"> *		-EFAULT if data unavailable</span>
<span class="cm"> *		-ENODEV  if no such device/adapter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_getiocinfo</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_iocinfo</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uarg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_iocinfo</span> <span class="o">*</span><span class="n">karg</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>		<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>		<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">iocnum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">cim_rev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> 	<span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="n">VirtDevice</span>		<span class="o">*</span><span class="n">vdevice</span><span class="p">;</span>

	<span class="cm">/* Add of PCI INFO results in unaligned access for</span>
<span class="cm">	 * IA64 and Sparc. Reset long to int. Return no PCI</span>
<span class="cm">	 * data for obsolete format.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_iocinfo_rev0</span><span class="p">))</span>
		<span class="n">cim_rev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_iocinfo_rev1</span><span class="p">))</span>
		<span class="n">cim_rev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_iocinfo</span><span class="p">))</span>
		<span class="n">cim_rev</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">==</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_iocinfo_rev0</span><span class="p">)</span><span class="o">+</span><span class="mi">12</span><span class="p">))</span>
		<span class="n">cim_rev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* obsolete */</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">karg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">data_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">karg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;%s::mpt_ioctl_iocinfo() @%d - no memory available!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">karg</span><span class="p">,</span> <span class="n">uarg</span><span class="p">,</span> <span class="n">data_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;%s@%d::mptctl_getiocinfo - &quot;</span>
			<span class="s">&quot;Unable to read in mpt_ioctl_iocinfo struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">karg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">iocnum</span> <span class="o">=</span> <span class="n">mpt_verify_adapter</span><span class="p">(</span><span class="n">karg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">iocnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ioc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span> <span class="s">&quot;%s::mptctl_getiocinfo() @%d - ioc%d not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">iocnum</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">karg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Verify the data transfer size is correct. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">karg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">maxDataSize</span> <span class="o">!=</span> <span class="n">data_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_getiocinfo - &quot;</span>
			<span class="s">&quot;Structure size mismatch. Command not completed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">karg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;mptctl_getiocinfo called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="cm">/* Fill in the data and return the structure to the calling</span>
<span class="cm">	 * program</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span><span class="p">)</span>
		<span class="n">karg</span><span class="o">-&gt;</span><span class="n">adapterType</span> <span class="o">=</span> <span class="n">MPT_IOCTL_INTERFACE_SAS</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FC</span><span class="p">)</span>
		<span class="n">karg</span><span class="o">-&gt;</span><span class="n">adapterType</span> <span class="o">=</span> <span class="n">MPT_IOCTL_INTERFACE_FC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">karg</span><span class="o">-&gt;</span><span class="n">adapterType</span> <span class="o">=</span> <span class="n">MPT_IOCTL_INTERFACE_SCSI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">karg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">port</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">karg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">karg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>

	<span class="n">karg</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>

	<span class="n">karg</span><span class="o">-&gt;</span><span class="n">pciId</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">karg</span><span class="o">-&gt;</span><span class="n">hwRev</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">karg</span><span class="o">-&gt;</span><span class="n">subSystemDevice</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="n">karg</span><span class="o">-&gt;</span><span class="n">subSystemVendor</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cim_rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get the PCI bus, device, and function numbers for the IOC</span>
<span class="cm">		 */</span>
		<span class="n">karg</span><span class="o">-&gt;</span><span class="n">pciInfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">busNumber</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
		<span class="n">karg</span><span class="o">-&gt;</span><span class="n">pciInfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">deviceNumber</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="p">);</span>
		<span class="n">karg</span><span class="o">-&gt;</span><span class="n">pciInfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">functionNumber</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cim_rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get the PCI bus, device, function and segment ID numbers</span>
<span class="cm">		   for the IOC */</span>
		<span class="n">karg</span><span class="o">-&gt;</span><span class="n">pciInfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">busNumber</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
		<span class="n">karg</span><span class="o">-&gt;</span><span class="n">pciInfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">deviceNumber</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="p">);</span>
		<span class="n">karg</span><span class="o">-&gt;</span><span class="n">pciInfo</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">functionNumber</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="p">);</span>
		<span class="n">karg</span><span class="o">-&gt;</span><span class="n">pciInfo</span><span class="p">.</span><span class="n">segmentID</span> <span class="o">=</span> <span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Get number of devices</span>
<span class="cm">         */</span>
	<span class="n">karg</span><span class="o">-&gt;</span><span class="n">numDevices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vdevice</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span>
			    <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">karg</span><span class="o">-&gt;</span><span class="n">numDevices</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set the BIOS and FW Version</span>
<span class="cm">	 */</span>
	<span class="n">karg</span><span class="o">-&gt;</span><span class="n">FWVersion</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span><span class="p">;</span>
	<span class="n">karg</span><span class="o">-&gt;</span><span class="n">BIOSVersion</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">biosVersion</span><span class="p">;</span>

	<span class="cm">/* Set the Version Strings.</span>
<span class="cm">	 */</span>
	<span class="n">strncpy</span> <span class="p">(</span><span class="n">karg</span><span class="o">-&gt;</span><span class="n">driverVersion</span><span class="p">,</span> <span class="n">MPT_LINUX_PACKAGE_NAME</span><span class="p">,</span> <span class="n">MPT_IOCTL_VERSION_LENGTH</span><span class="p">);</span>
	<span class="n">karg</span><span class="o">-&gt;</span><span class="n">driverVersion</span><span class="p">[</span><span class="n">MPT_IOCTL_VERSION_LENGTH</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">karg</span><span class="o">-&gt;</span><span class="n">busChangeEvent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">karg</span><span class="o">-&gt;</span><span class="n">hostId</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">PortSCSIID</span><span class="p">;</span>
	<span class="n">karg</span><span class="o">-&gt;</span><span class="n">rsvd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">karg</span><span class="o">-&gt;</span><span class="n">rsvd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Copy the data from kernel memory to user memory</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="n">karg</span><span class="p">,</span> <span class="n">data_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_getiocinfo - &quot;</span>
			<span class="s">&quot;Unable to write out mpt_ioctl_iocinfo struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">karg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">karg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptctl_gettargetinfo - Query the host adapter for target information.</span>
<span class="cm"> *	@arg: User space argument</span>
<span class="cm"> *</span>
<span class="cm"> * Outputs:	None.</span>
<span class="cm"> * Return:	0 if successful</span>
<span class="cm"> *		-EFAULT if data unavailable</span>
<span class="cm"> *		-ENODEV  if no such device/adapter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_gettargetinfo</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_targetinfo</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uarg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_targetinfo</span> <span class="n">karg</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>		<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">VirtDevice</span>		<span class="o">*</span><span class="n">vdevice</span><span class="p">;</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">pmem</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">iocnum</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">numDevices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">lun</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">maxWordsLeft</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">numBytes</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> 	<span class="o">*</span><span class="n">sdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">,</span> <span class="n">uarg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_targetinfo</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;%s@%d::mptctl_gettargetinfo - &quot;</span>
			<span class="s">&quot;Unable to read in mpt_ioctl_targetinfo struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">iocnum</span> <span class="o">=</span> <span class="n">mpt_verify_adapter</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">iocnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ioc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span> <span class="s">&quot;%s::mptctl_gettargetinfo() @%d - ioc%d not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">iocnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;mptctl_gettargetinfo called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="cm">/* Get the port number and set the maximum number of bytes</span>
<span class="cm">	 * in the returned structure.</span>
<span class="cm">	 * Ignore the port setting.</span>
<span class="cm">	 */</span>
	<span class="n">numBytes</span> <span class="o">=</span> <span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">maxDataSize</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpt_ioctl_header</span><span class="p">);</span>
	<span class="n">maxWordsLeft</span> <span class="o">=</span> <span class="n">numBytes</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">maxWordsLeft</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_gettargetinfo() - no memory available!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fill in the data and return the structure to the calling</span>
<span class="cm">	 * program</span>
<span class="cm">	 */</span>

	<span class="cm">/* struct mpt_ioctl_targetinfo does not contain sufficient space</span>
<span class="cm">	 * for the target structures so when the IOCTL is called, there is</span>
<span class="cm">	 * not sufficient stack space for the structure. Allocate memory,</span>
<span class="cm">	 * populate the memory, copy back to the user, then free memory.</span>
<span class="cm">	 * targetInfo format:</span>
<span class="cm">	 * bits 31-24: reserved</span>
<span class="cm">	 *      23-16: LUN</span>
<span class="cm">	 *      15- 8: Bus Number</span>
<span class="cm">	 *       7- 0: Target ID</span>
<span class="cm">	 */</span>
	<span class="n">pmem</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">numBytes</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_gettargetinfo() - no memory available!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pdata</span> <span class="o">=</span>  <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">pmem</span><span class="p">;</span>

	<span class="cm">/* Get number of devices</span>
<span class="cm">         */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">){</span>
		<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">maxWordsLeft</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">vdevice</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span>
			    <span class="n">MPT_TARGET_FLAGS_RAID_COMPONENT</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">lun</span> <span class="o">=</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">raidVolume</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">;</span>
			<span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u8</span><span class="p">)</span><span class="n">lun</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
			    <span class="p">(</span><span class="n">vdevice</span><span class="o">-&gt;</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span> <span class="p">));</span>
			<span class="n">pdata</span><span class="o">++</span><span class="p">;</span>
			<span class="n">numDevices</span><span class="o">++</span><span class="p">;</span>
			<span class="o">--</span><span class="n">maxWordsLeft</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">numDevices</span> <span class="o">=</span> <span class="n">numDevices</span><span class="p">;</span>

	<span class="cm">/* Copy part of the data from kernel memory to user memory</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">karg</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_targetinfo</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_gettargetinfo - &quot;</span>
			<span class="s">&quot;Unable to write out mpt_ioctl_targetinfo struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pmem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy the remaining data from kernel memory to user memory</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">uarg</span><span class="o">-&gt;</span><span class="n">targetInfo</span><span class="p">,</span> <span class="n">pmem</span><span class="p">,</span> <span class="n">numBytes</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_gettargetinfo - &quot;</span>
			<span class="s">&quot;Unable to write out mpt_ioctl_targetinfo struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">pdata</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pmem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pmem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/* MPT IOCTL Test function.</span>
<span class="cm"> *</span>
<span class="cm"> * Outputs:	None.</span>
<span class="cm"> * Return:	0 if successful</span>
<span class="cm"> *		-EFAULT if data unavailable</span>
<span class="cm"> *		-ENODEV  if no such device/adapter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_readtest</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_test</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uarg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_test</span>	 <span class="n">karg</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iocnum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">,</span> <span class="n">uarg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_test</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;%s@%d::mptctl_readtest - &quot;</span>
			<span class="s">&quot;Unable to read in mpt_ioctl_test struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">iocnum</span> <span class="o">=</span> <span class="n">mpt_verify_adapter</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">iocnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ioc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span> <span class="s">&quot;%s::mptctl_readtest() @%d - ioc%d not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">iocnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;mptctl_readtest called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="cm">/* Fill in the data and return the structure to the calling</span>
<span class="cm">	 * program</span>
<span class="cm">	 */</span>

<span class="cp">#ifdef MFCNT</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">chip_type</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mfcnt</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">chip_type</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">strncpy</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">MPT_MAX_NAME</span><span class="p">);</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="n">MPT_MAX_NAME</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">strncpy</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">product</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">prod_name</span><span class="p">,</span> <span class="n">MPT_PRODUCT_LENGTH</span><span class="p">);</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">product</span><span class="p">[</span><span class="n">MPT_PRODUCT_LENGTH</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="cm">/* Copy the data from kernel memory to user memory</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">karg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_test</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_readtest - &quot;</span>
			<span class="s">&quot;Unable to write out mpt_ioctl_test struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptctl_eventquery - Query the host adapter for the event types</span>
<span class="cm"> *	that are being logged.</span>
<span class="cm"> *	@arg: User space argument</span>
<span class="cm"> *</span>
<span class="cm"> * Outputs:	None.</span>
<span class="cm"> * Return:	0 if successful</span>
<span class="cm"> *		-EFAULT if data unavailable</span>
<span class="cm"> *		-ENODEV  if no such device/adapter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_eventquery</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_eventquery</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uarg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_eventquery</span>	 <span class="n">karg</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iocnum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">,</span> <span class="n">uarg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_eventquery</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;%s@%d::mptctl_eventquery - &quot;</span>
			<span class="s">&quot;Unable to read in mpt_ioctl_eventquery struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">iocnum</span> <span class="o">=</span> <span class="n">mpt_verify_adapter</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">iocnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ioc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span> <span class="s">&quot;%s::mptctl_eventquery() @%d - ioc%d not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">iocnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;mptctl_eventquery called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">eventEntries</span> <span class="o">=</span> <span class="n">MPTCTL_EVENT_LOG_SIZE</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">eventTypes</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">eventTypes</span><span class="p">;</span>

	<span class="cm">/* Copy the data from kernel memory to user memory</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">karg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_eventquery</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_eventquery - &quot;</span>
			<span class="s">&quot;Unable to write out mpt_ioctl_eventquery struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_eventenable</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_eventenable</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uarg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_eventenable</span>	 <span class="n">karg</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iocnum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">,</span> <span class="n">uarg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_eventenable</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;%s@%d::mptctl_eventenable - &quot;</span>
			<span class="s">&quot;Unable to read in mpt_ioctl_eventenable struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">iocnum</span> <span class="o">=</span> <span class="n">mpt_verify_adapter</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">iocnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ioc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span> <span class="s">&quot;%s::mptctl_eventenable() @%d - ioc%d not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">iocnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;mptctl_eventenable called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Have not yet allocated memory - do so now.</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">MPTCTL_EVENT_LOG_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MPT_IOCTL_EVENTS</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			    <span class="s">&quot;: ERROR - Insufficient memory to add adapter!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>

		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">eventContext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="cm">/* Update the IOC event logging flag.</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">eventTypes</span> <span class="o">=</span> <span class="n">karg</span><span class="p">.</span><span class="n">eventTypes</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_eventreport</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_eventreport</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uarg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_eventreport</span>	 <span class="n">karg</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>		 <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">iocnum</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">numBytes</span><span class="p">,</span> <span class="n">maxEvents</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">,</span> <span class="n">uarg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_eventreport</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;%s@%d::mptctl_eventreport - &quot;</span>
			<span class="s">&quot;Unable to read in mpt_ioctl_eventreport struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">iocnum</span> <span class="o">=</span> <span class="n">mpt_verify_adapter</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">iocnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ioc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span> <span class="s">&quot;%s::mptctl_eventreport() @%d - ioc%d not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">iocnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;mptctl_eventreport called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">numBytes</span> <span class="o">=</span> <span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">maxDataSize</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mpt_ioctl_header</span><span class="p">);</span>
	<span class="n">maxEvents</span> <span class="o">=</span> <span class="n">numBytes</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MPT_IOCTL_EVENTS</span><span class="p">);</span>


	<span class="n">max</span> <span class="o">=</span> <span class="n">MPTCTL_EVENT_LOG_SIZE</span> <span class="o">&lt;</span> <span class="n">maxEvents</span> <span class="o">?</span> <span class="n">MPTCTL_EVENT_LOG_SIZE</span> <span class="o">:</span> <span class="n">maxEvents</span><span class="p">;</span>

	<span class="cm">/* If fewer than 1 event is requested, there must have</span>
<span class="cm">	 * been some type of error.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>

	<span class="cm">/* reset this flag so SIGIO can restart */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">aen_event_read_flag</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Copy the data from kernel memory to user memory</span>
<span class="cm">	 */</span>
	<span class="n">numBytes</span> <span class="o">=</span> <span class="n">max</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MPT_IOCTL_EVENTS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">uarg</span><span class="o">-&gt;</span><span class="n">eventData</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span> <span class="n">numBytes</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_eventreport - &quot;</span>
			<span class="s">&quot;Unable to write out mpt_ioctl_eventreport struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_replace_fw</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_replace_fw</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uarg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_replace_fw</span>	 <span class="n">karg</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>		 <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">iocnum</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">newFwSize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">,</span> <span class="n">uarg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_replace_fw</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;%s@%d::mptctl_replace_fw - &quot;</span>
			<span class="s">&quot;Unable to read in mpt_ioctl_replace_fw struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">iocnum</span> <span class="o">=</span> <span class="n">mpt_verify_adapter</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">iocnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ioc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span> <span class="s">&quot;%s::mptctl_replace_fw() @%d - ioc%d not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">iocnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;mptctl_replace_fw called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="cm">/* If caching FW, Free the old FW image</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mpt_free_fw_memory</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="cm">/* Allocate memory for the new FW image</span>
<span class="cm">	 */</span>
	<span class="n">newFwSize</span> <span class="o">=</span> <span class="n">karg</span><span class="p">.</span><span class="n">newImageSize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newFwSize</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">newFwSize</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newFwSize</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
		<span class="n">newFwSize</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">mpt_alloc_fw_memory</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">newFwSize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Copy the data from user memory to kernel space</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">,</span> <span class="n">uarg</span><span class="o">-&gt;</span><span class="n">newImage</span><span class="p">,</span> <span class="n">newFwSize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_replace_fw - &quot;</span>
				<span class="s">&quot;Unable to read in mpt_ioctl_replace_fw image &quot;</span>
				<span class="s">&quot;@ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="n">mpt_free_fw_memory</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Update IOCFactsReply</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWImageSize</span> <span class="o">=</span> <span class="n">newFwSize</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/* MPT IOCTL MPTCOMMAND function.</span>
<span class="cm"> * Cast the arg into the mpt_ioctl_mpt_command structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Outputs:	None.</span>
<span class="cm"> * Return:	0 if successful</span>
<span class="cm"> *		-EBUSY  if previous command timeout and IOC reset is not complete.</span>
<span class="cm"> *		-EFAULT if data unavailable</span>
<span class="cm"> *		-ENODEV if no such device/adapter</span>
<span class="cm"> *		-ETIME	if timer expires</span>
<span class="cm"> *		-ENOMEM if memory allocation error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_mpt_command</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_command</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uarg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_command</span>  <span class="n">karg</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">iocnum</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">rc</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">,</span> <span class="n">uarg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_command</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;%s@%d::mptctl_mpt_command - &quot;</span>
			<span class="s">&quot;Unable to read in mpt_ioctl_command struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">iocnum</span> <span class="o">=</span> <span class="n">mpt_verify_adapter</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">iocnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ioc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span> <span class="s">&quot;%s::mptctl_mpt_command() @%d - ioc%d not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">iocnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mptctl_do_mpt_command</span> <span class="p">(</span><span class="n">karg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uarg</span><span class="o">-&gt;</span><span class="n">MF</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/* Worker routine for the IOCTL MPTCOMMAND and MPTCOMMAND32 (sparc) commands.</span>
<span class="cm"> *</span>
<span class="cm"> * Outputs:	None.</span>
<span class="cm"> * Return:	0 if successful</span>
<span class="cm"> *		-EBUSY  if previous command timeout and IOC reset is not complete.</span>
<span class="cm"> *		-EFAULT if data unavailable</span>
<span class="cm"> *		-ENODEV if no such device/adapter</span>
<span class="cm"> *		-ETIME	if timer expires</span>
<span class="cm"> *		-ENOMEM if memory allocation error</span>
<span class="cm"> *		-EPERM if SCSI I/O and target is untagged</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_do_mpt_command</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_command</span> <span class="n">karg</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">mfPtr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">MPT_FRAME_HDR</span>	<span class="o">*</span><span class="n">mf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">MPIHeader_t</span>	<span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">psge</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buflist</span>	<span class="n">bufIn</span><span class="p">;</span>	<span class="cm">/* data In buffer */</span>
	<span class="k">struct</span> <span class="n">buflist</span>	<span class="n">bufOut</span><span class="p">;</span> <span class="cm">/* data Out buffer */</span>
	<span class="n">dma_addr_t</span>	<span class="n">dma_addr_in</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">dma_addr_out</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">sgSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Num SG elements */</span>
	<span class="kt">int</span>		<span class="n">iocnum</span><span class="p">,</span> <span class="n">flagsLength</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">sz</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">msgContext</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">req_idx</span><span class="p">;</span>
	<span class="n">ulong</span> 		<span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">timeleft</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">function</span><span class="p">;</span>

	<span class="cm">/* bufIn and bufOut are used for user to kernel space transfers</span>
<span class="cm">	 */</span>
	<span class="n">bufIn</span><span class="p">.</span><span class="n">kptr</span> <span class="o">=</span> <span class="n">bufOut</span><span class="p">.</span><span class="n">kptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bufIn</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">bufOut</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">iocnum</span> <span class="o">=</span> <span class="n">mpt_verify_adapter</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">iocnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ioc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span> <span class="s">&quot;%s::mptctl_do_mpt_command() @%d - ioc%d not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">iocnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;%s@%d::mptctl_do_mpt_command - &quot;</span>
			<span class="s">&quot;Busy with diagnostic reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Verify that the final request frame will not be too large.</span>
<span class="cm">	 */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">karg</span><span class="p">.</span><span class="n">dataSgeOffset</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">dataInSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sz</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">dataOutSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sz</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&gt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_do_mpt_command - &quot;</span>
			<span class="s">&quot;Request frame too large (%d) maximum (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get a free request frame and save the message context.</span>
<span class="cm">	 */</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">mptctl_id</span><span class="p">,</span> <span class="n">ioc</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPIHeader_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>
	<span class="n">msgContext</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">MsgContext</span><span class="p">);</span>
	<span class="n">req_idx</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">req_idx</span><span class="p">);</span>

	<span class="cm">/* Copy the request frame</span>
<span class="cm">	 * Reset the saved message context.</span>
<span class="cm">	 * Request frame in user space</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="n">mfPtr</span><span class="p">,</span> <span class="n">karg</span><span class="p">.</span><span class="n">dataSgeOffset</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_do_mpt_command - &quot;</span>
			<span class="s">&quot;Unable to read MF from mpt_ioctl_command struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">mfPtr</span><span class="p">);</span>
		<span class="n">function</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">MsgContext</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">msgContext</span><span class="p">);</span>
	<span class="n">function</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">Function</span><span class="p">;</span>


	<span class="cm">/* Verify that this request is allowed.</span>
<span class="cm">	 */</span>
	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;sending mpi function (0x%02X), req=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">Function</span><span class="p">,</span> <span class="n">mf</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_FUNCTION_IOC_FACTS</span>:
	<span class="k">case</span> <span class="n">MPI_FUNCTION_PORT_FACTS</span>:
		<span class="n">karg</span><span class="p">.</span><span class="n">dataOutSize</span>  <span class="o">=</span> <span class="n">karg</span><span class="p">.</span><span class="n">dataInSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_FUNCTION_CONFIG</span>:
	<span class="p">{</span>
		<span class="n">Config_t</span> <span class="o">*</span><span class="n">config_frame</span><span class="p">;</span>
		<span class="n">config_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">Config_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">;</span>
		<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">type=0x%02x ext_type=0x%02x &quot;</span>
		    <span class="s">&quot;number=0x%02x action=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">config_frame</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageType</span><span class="p">,</span>
		    <span class="n">config_frame</span><span class="o">-&gt;</span><span class="n">ExtPageType</span><span class="p">,</span>
		    <span class="n">config_frame</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageNumber</span><span class="p">,</span>
		    <span class="n">config_frame</span><span class="o">-&gt;</span><span class="n">Action</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">MPI_FUNCTION_FC_COMMON_TRANSPORT_SEND</span>:
	<span class="k">case</span> <span class="n">MPI_FUNCTION_FC_EX_LINK_SRVC_SEND</span>:
	<span class="k">case</span> <span class="n">MPI_FUNCTION_FW_UPLOAD</span>:
	<span class="k">case</span> <span class="n">MPI_FUNCTION_SCSI_ENCLOSURE_PROCESSOR</span>:
	<span class="k">case</span> <span class="n">MPI_FUNCTION_FW_DOWNLOAD</span>:
	<span class="k">case</span> <span class="n">MPI_FUNCTION_FC_PRIMITIVE_SEND</span>:
	<span class="k">case</span> <span class="n">MPI_FUNCTION_TOOLBOX</span>:
	<span class="k">case</span> <span class="n">MPI_FUNCTION_SAS_IO_UNIT_CONTROL</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_FUNCTION_SCSI_IO_REQUEST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="n">pScsiReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">qtag</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_UNTAGGED</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">scsidir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">dataSize</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>

			<span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">devices_per_bus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">devices_per_bus</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">&gt;</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_do_mpt_command - &quot;</span>
					<span class="s">&quot;Target ID out of bounds. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">&gt;=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">number_of_buses</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_do_mpt_command - &quot;</span>
					<span class="s">&quot;Target Bus out of bounds. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPI_SCSIIO_MSGFLGS_SENSE_WIDTH</span><span class="p">;</span>
			<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">|=</span> <span class="n">mpt_msg_flags</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>


			<span class="cm">/* verify that app has not requested</span>
<span class="cm">			 *	more sense data than driver</span>
<span class="cm">			 *	can provide, if so, reset this parameter</span>
<span class="cm">			 * set the sense buffer pointer low address</span>
<span class="cm">			 * update the control field to specify Q type</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">maxSenseBytes</span> <span class="o">&gt;</span> <span class="n">MPT_SENSE_BUFFER_SIZE</span><span class="p">)</span>
				<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">SenseBufferLength</span> <span class="o">=</span> <span class="n">MPT_SENSE_BUFFER_SIZE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">SenseBufferLength</span> <span class="o">=</span> <span class="n">karg</span><span class="p">.</span><span class="n">maxSenseBytes</span><span class="p">;</span>

			<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">SenseBufferLowAddr</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_low_dma</span>
				   <span class="o">+</span> <span class="p">(</span><span class="n">req_idx</span> <span class="o">*</span> <span class="n">MPT_SENSE_BUFFER_ALLOC</span><span class="p">));</span>

			<span class="n">shost_for_each_device</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">scsi_target</span> <span class="o">*</span><span class="n">starget</span> <span class="o">=</span> <span class="n">scsi_target</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
				<span class="n">VirtTarget</span> <span class="o">*</span><span class="n">vtarget</span> <span class="o">=</span> <span class="n">starget</span><span class="o">-&gt;</span><span class="n">hostdata</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">vtarget</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">TargetID</span> <span class="o">==</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Bus</span> <span class="o">==</span> <span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">vtarget</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">&amp;</span> <span class="n">MPT_TARGET_FLAGS_Q_YES</span><span class="p">))</span>
					<span class="n">qtag</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_SIMPLEQ</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Have the IOCTL driver set the direction based</span>
<span class="cm">			 * on the dataOutSize (ordering issue with Sparc).</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">dataOutSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scsidir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_WRITE</span><span class="p">;</span>
				<span class="n">dataSize</span> <span class="o">=</span> <span class="n">karg</span><span class="p">.</span><span class="n">dataOutSize</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">scsidir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_READ</span><span class="p">;</span>
				<span class="n">dataSize</span> <span class="o">=</span> <span class="n">karg</span><span class="p">.</span><span class="n">dataInSize</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Control</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scsidir</span> <span class="o">|</span> <span class="n">qtag</span><span class="p">);</span>
			<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dataSize</span><span class="p">);</span>


		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_do_mpt_command - &quot;</span>
				<span class="s">&quot;SCSI driver is not loaded. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_FUNCTION_SMP_PASSTHROUGH</span>:
		<span class="cm">/* Check mf-&gt;PassthruFlags to determine if</span>
<span class="cm">		 * transfer is ImmediateMode or not.</span>
<span class="cm">		 * Immediate mode returns data in the ReplyFrame.</span>
<span class="cm">		 * Else, we are sending request and response data</span>
<span class="cm">		 * in two SGLs at the end of the mf.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_FUNCTION_SATA_PASSTHROUGH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_do_mpt_command - &quot;</span>
				<span class="s">&quot;SCSI driver is not loaded. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_FUNCTION_RAID_ACTION</span>:
		<span class="cm">/* Just add a SGE</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_FUNCTION_RAID_SCSI_IO_PASSTHROUGH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="n">pScsiReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIIORequest_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">qtag</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_SIMPLEQ</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">scsidir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_READ</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">dataSize</span><span class="p">;</span>

			<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPI_SCSIIO_MSGFLGS_SENSE_WIDTH</span><span class="p">;</span>
			<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">|=</span> <span class="n">mpt_msg_flags</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>


			<span class="cm">/* verify that app has not requested</span>
<span class="cm">			 *	more sense data than driver</span>
<span class="cm">			 *	can provide, if so, reset this parameter</span>
<span class="cm">			 * set the sense buffer pointer low address</span>
<span class="cm">			 * update the control field to specify Q type</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">maxSenseBytes</span> <span class="o">&gt;</span> <span class="n">MPT_SENSE_BUFFER_SIZE</span><span class="p">)</span>
				<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">SenseBufferLength</span> <span class="o">=</span> <span class="n">MPT_SENSE_BUFFER_SIZE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">SenseBufferLength</span> <span class="o">=</span> <span class="n">karg</span><span class="p">.</span><span class="n">maxSenseBytes</span><span class="p">;</span>

			<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">SenseBufferLowAddr</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_low_dma</span>
				   <span class="o">+</span> <span class="p">(</span><span class="n">req_idx</span> <span class="o">*</span> <span class="n">MPT_SENSE_BUFFER_ALLOC</span><span class="p">));</span>

			<span class="cm">/* All commands to physical devices are tagged</span>
<span class="cm">			 */</span>

			<span class="cm">/* Have the IOCTL driver set the direction based</span>
<span class="cm">			 * on the dataOutSize (ordering issue with Sparc).</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">dataOutSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scsidir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_WRITE</span><span class="p">;</span>
				<span class="n">dataSize</span> <span class="o">=</span> <span class="n">karg</span><span class="p">.</span><span class="n">dataOutSize</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">scsidir</span> <span class="o">=</span> <span class="n">MPI_SCSIIO_CONTROL_READ</span><span class="p">;</span>
				<span class="n">dataSize</span> <span class="o">=</span> <span class="n">karg</span><span class="p">.</span><span class="n">dataInSize</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">Control</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scsidir</span> <span class="o">|</span> <span class="n">qtag</span><span class="p">);</span>
			<span class="n">pScsiReq</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dataSize</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_do_mpt_command - &quot;</span>
				<span class="s">&quot;SCSI driver is not loaded. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_FUNCTION_SCSI_TASK_MGMT</span>:
	<span class="p">{</span>
		<span class="n">SCSITaskMgmt_t</span>	<span class="o">*</span><span class="n">pScsiTm</span><span class="p">;</span>
		<span class="n">pScsiTm</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSITaskMgmt_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">;</span>
		<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			<span class="s">&quot;</span><span class="se">\t</span><span class="s">TaskType=0x%x MsgFlags=0x%x &quot;</span>
			<span class="s">&quot;TaskMsgContext=0x%x id=%d channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">TaskType</span><span class="p">,</span> <span class="n">le32_to_cpu</span>
			<span class="p">(</span><span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">TaskMsgContext</span><span class="p">),</span> <span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">MsgFlags</span><span class="p">,</span>
			<span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">TargetID</span><span class="p">,</span> <span class="n">pScsiTm</span><span class="o">-&gt;</span><span class="n">Bus</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">MPI_FUNCTION_IOC_INIT</span>:
		<span class="p">{</span>
			<span class="n">IOCInit_t</span>	<span class="o">*</span><span class="n">pInit</span> <span class="o">=</span> <span class="p">(</span><span class="n">IOCInit_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>
			<span class="n">u32</span>		<span class="n">high_addr</span><span class="p">,</span> <span class="n">sense_high</span><span class="p">;</span>

			<span class="cm">/* Verify that all entries in the IOC INIT match</span>
<span class="cm">			 * existing setup (and in LE format).</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">high_addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
				<span class="n">sense_high</span><span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">high_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">sense_high</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">pInit</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pInit</span><span class="o">-&gt;</span><span class="n">MaxDevices</span> <span class="o">!=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxDevices</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">pInit</span><span class="o">-&gt;</span><span class="n">MaxBuses</span> <span class="o">!=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxBuses</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">pInit</span><span class="o">-&gt;</span><span class="n">ReplyFrameSize</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">))</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">pInit</span><span class="o">-&gt;</span><span class="n">HostMfaHighAddr</span> <span class="o">!=</span> <span class="n">high_addr</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">pInit</span><span class="o">-&gt;</span><span class="n">SenseBufferHighAddr</span> <span class="o">!=</span> <span class="n">sense_high</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_do_mpt_command - &quot;</span>
					<span class="s">&quot;IOC_INIT issued with 1 or more incorrect parameters. Rejected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * MPI_FUNCTION_PORT_ENABLE</span>
<span class="cm">		 * MPI_FUNCTION_TARGET_CMD_BUFFER_POST</span>
<span class="cm">		 * MPI_FUNCTION_TARGET_ASSIST</span>
<span class="cm">		 * MPI_FUNCTION_TARGET_STATUS_SEND</span>
<span class="cm">		 * MPI_FUNCTION_TARGET_MODE_ABORT</span>
<span class="cm">		 * MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET</span>
<span class="cm">		 * MPI_FUNCTION_IO_UNIT_RESET</span>
<span class="cm">		 * MPI_FUNCTION_HANDSHAKE</span>
<span class="cm">		 * MPI_FUNCTION_REPLY_FRAME_REMOVAL</span>
<span class="cm">		 * MPI_FUNCTION_EVENT_NOTIFICATION</span>
<span class="cm">		 *  (driver handles event notification)</span>
<span class="cm">		 * MPI_FUNCTION_EVENT_ACK</span>
<span class="cm">		 */</span>

		<span class="cm">/*  What to do with these???  CHECK ME!!!</span>
<span class="cm">			MPI_FUNCTION_FC_LINK_SRVC_BUF_POST</span>
<span class="cm">			MPI_FUNCTION_FC_LINK_SRVC_RSP</span>
<span class="cm">			MPI_FUNCTION_FC_ABORT</span>
<span class="cm">			MPI_FUNCTION_LAN_SEND</span>
<span class="cm">			MPI_FUNCTION_LAN_RECEIVE</span>
<span class="cm">		 	MPI_FUNCTION_LAN_RESET</span>
<span class="cm">		*/</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_do_mpt_command - &quot;</span>
			<span class="s">&quot;Illegal request (function 0x%x) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">Function</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add the SGL ( at most one data in SGE and one data out SGE )</span>
<span class="cm">	 * In the case of two SGE&#39;s - the data out (write) will always</span>
<span class="cm">	 * preceede the data in (read) SGE. psgList is used to free the</span>
<span class="cm">	 * allocated memory.</span>
<span class="cm">	 */</span>
	<span class="n">psge</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">)</span> <span class="o">+</span> <span class="n">karg</span><span class="p">.</span><span class="n">dataSgeOffset</span><span class="p">);</span>
	<span class="n">flagsLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">dataOutSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sgSize</span> <span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">dataInSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sgSize</span> <span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sgSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Set up the dataOut memory allocation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">dataOutSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">dataInSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">flagsLength</span> <span class="o">=</span> <span class="p">(</span> <span class="n">MPI_SGE_FLAGS_SIMPLE_ELEMENT</span> <span class="o">|</span>
						<span class="n">MPI_SGE_FLAGS_END_OF_BUFFER</span> <span class="o">|</span>
						<span class="n">MPI_SGE_FLAGS_DIRECTION</span><span class="p">)</span>
						<span class="o">&lt;&lt;</span> <span class="n">MPI_SGE_FLAGS_SHIFT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">flagsLength</span> <span class="o">=</span> <span class="n">MPT_SGE_FLAGS_SSIMPLE_WRITE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">flagsLength</span> <span class="o">|=</span> <span class="n">karg</span><span class="p">.</span><span class="n">dataOutSize</span><span class="p">;</span>
			<span class="n">bufOut</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">karg</span><span class="p">.</span><span class="n">dataOutSize</span><span class="p">;</span>
			<span class="n">bufOut</span><span class="p">.</span><span class="n">kptr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">bufOut</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_addr_out</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bufOut</span><span class="p">.</span><span class="n">kptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Set up this SGE.</span>
<span class="cm">				 * Copy to MF and to sglbuf</span>
<span class="cm">				 */</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">flagsLength</span><span class="p">,</span> <span class="n">dma_addr_out</span><span class="p">);</span>
				<span class="n">psge</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>

				<span class="cm">/* Copy user data to kernel space.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">bufOut</span><span class="p">.</span><span class="n">kptr</span><span class="p">,</span>
						<span class="n">karg</span><span class="p">.</span><span class="n">dataOutBufPtr</span><span class="p">,</span>
						<span class="n">bufOut</span><span class="p">.</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
						<span class="s">&quot;%s@%d::mptctl_do_mpt_command - Unable &quot;</span>
						<span class="s">&quot;to read user data &quot;</span>
						<span class="s">&quot;struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span><span class="n">karg</span><span class="p">.</span><span class="n">dataOutBufPtr</span><span class="p">);</span>
					<span class="n">rc</span> <span class="o">=</span>  <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">dataInSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">flagsLength</span> <span class="o">=</span> <span class="n">MPT_SGE_FLAGS_SSIMPLE_READ</span><span class="p">;</span>
			<span class="n">flagsLength</span> <span class="o">|=</span> <span class="n">karg</span><span class="p">.</span><span class="n">dataInSize</span><span class="p">;</span>

			<span class="n">bufIn</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">karg</span><span class="p">.</span><span class="n">dataInSize</span><span class="p">;</span>
			<span class="n">bufIn</span><span class="p">.</span><span class="n">kptr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					<span class="n">bufIn</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_addr_in</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bufIn</span><span class="p">.</span><span class="n">kptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Set up this SGE</span>
<span class="cm">				 * Copy to MF and to sglbuf</span>
<span class="cm">				 */</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">flagsLength</span><span class="p">,</span> <span class="n">dma_addr_in</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
		<span class="cm">/* Add a NULL SGE</span>
<span class="cm">		 */</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">flagsLength</span><span class="p">,</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">SET_MGMT_MSG_CONTEXT</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">msg_context</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">MsgContext</span><span class="p">);</span>
	<span class="n">INITIALIZE_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">==</span> <span class="n">MPI_FUNCTION_SCSI_TASK_MGMT</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpt_set_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">DBG_DUMP_TM_REQUEST_FRAME</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCCapabilities</span> <span class="o">&amp;</span> <span class="n">MPI_IOCFACTS_CAPABILITY_HIGH_PRI_Q</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MsgVersion</span> <span class="o">&gt;=</span> <span class="n">MPI_VERSION_01_05</span><span class="p">))</span>
			<span class="n">mpt_put_msg_frame_hi_pri</span><span class="p">(</span><span class="n">mptctl_id</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span><span class="n">mpt_send_handshake_request</span><span class="p">(</span><span class="n">mptctl_id</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">SCSITaskMgmt_t</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
				    <span class="s">&quot;send_handshake FAILED! (ioc %p, mf %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">));</span>
				<span class="n">mpt_clear_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mpt_put_msg_frame</span><span class="p">(</span><span class="n">mptctl_id</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>

	<span class="cm">/* Now wait for the command to complete */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">karg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">:</span> <span class="n">MPT_IOCTL_DEFAULT_TIMEOUT</span><span class="p">;</span>
<span class="nl">retry_wait:</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span>
				<span class="n">HZ</span><span class="o">*</span><span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s: TIMED OUT!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">function</span> <span class="o">==</span> <span class="n">MPI_FUNCTION_SCSI_TASK_MGMT</span><span class="p">)</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeleft</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			       <span class="s">&quot;mpt cmd timeout, doorbell=0x%08x&quot;</span>
			       <span class="s">&quot; function=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">function</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">function</span> <span class="o">==</span> <span class="n">MPI_FUNCTION_SCSI_TASK_MGMT</span><span class="p">)</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
			<span class="n">mptctl_timeout_expired</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
			<span class="n">mf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">retry_wait</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">function</span> <span class="o">==</span> <span class="n">MPI_FUNCTION_SCSI_TASK_MGMT</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>


	<span class="n">mf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* If a valid reply frame, copy to the user.</span>
<span class="cm">	 * Offset 2: reply length in U32&#39;s</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">maxReplyBytes</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sz</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">maxReplyBytes</span><span class="p">,</span>
				<span class="mi">4</span><span class="o">*</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			 <span class="n">sz</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">replyFrameBufPtr</span><span class="p">,</span>
				 <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">sz</span><span class="p">)){</span>
				 <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
				     <span class="s">&quot;%s@%d::mptctl_do_mpt_command - &quot;</span>
				 <span class="s">&quot;Unable to write out reply frame %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">karg</span><span class="p">.</span><span class="n">replyFrameBufPtr</span><span class="p">);</span>
				 <span class="n">rc</span> <span class="o">=</span>  <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
				 <span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If valid sense data, copy to user.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_SENSE_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">maxSenseBytes</span><span class="p">,</span> <span class="n">MPT_SENSE_BUFFER_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">senseDataPtr</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">sense</span><span class="p">,</span> <span class="n">sz</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_do_mpt_command - &quot;</span>
				<span class="s">&quot;Unable to write sense data to user %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
				<span class="n">karg</span><span class="p">.</span><span class="n">senseDataPtr</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span>  <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done_free_mem</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If the overall status is _GOOD and data in, copy data</span>
<span class="cm">	 * to user.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">dataInSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bufIn</span><span class="p">.</span><span class="n">kptr</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">dataInBufPtr</span><span class="p">,</span>
				 <span class="n">bufIn</span><span class="p">.</span><span class="n">kptr</span><span class="p">,</span> <span class="n">karg</span><span class="p">.</span><span class="n">dataInSize</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_do_mpt_command - &quot;</span>
				<span class="s">&quot;Unable to write data to user %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
				<span class="n">karg</span><span class="p">.</span><span class="n">dataInBufPtr</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span>  <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">done_free_mem:</span>

	<span class="n">CLEAR_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">SET_MGMT_MSG_CONTEXT</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">msg_context</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Free the allocated memory.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bufOut</span><span class="p">.</span><span class="n">kptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			<span class="n">bufOut</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bufOut</span><span class="p">.</span><span class="n">kptr</span><span class="p">,</span> <span class="n">dma_addr_out</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bufIn</span><span class="p">.</span><span class="n">kptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			<span class="n">bufIn</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">bufIn</span><span class="p">.</span><span class="n">kptr</span><span class="p">,</span> <span class="n">dma_addr_in</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* mf is null if command issued successfully</span>
<span class="cm">	 * otherwise, failure occurred after mf acquired.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mf</span><span class="p">)</span>
		<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/* Prototype Routine for the HOST INFO command.</span>
<span class="cm"> *</span>
<span class="cm"> * Outputs:	None.</span>
<span class="cm"> * Return:	0 if successful</span>
<span class="cm"> *		-EFAULT if data unavailable</span>
<span class="cm"> *		-EBUSY  if previous command timeout and IOC reset is not complete.</span>
<span class="cm"> *		-ENODEV if no such device/adapter</span>
<span class="cm"> *		-ETIME	if timer expires</span>
<span class="cm"> *		-ENOMEM if memory allocation error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_hp_hostinfo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hp_host_info_t</span>	<span class="n">__user</span> <span class="o">*</span><span class="n">uarg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>		<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>		<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">char</span>                    <span class="o">*</span><span class="n">pbuf</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">buf_dma</span><span class="p">;</span>
	<span class="n">hp_host_info_t</span>		<span class="n">karg</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span>		<span class="n">cfg</span><span class="p">;</span>
	<span class="n">ConfigPageHeader_t</span>	<span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">iocnum</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">rc</span><span class="p">,</span> <span class="n">cim_rev</span><span class="p">;</span>
	<span class="n">ToolboxIstwiReadWriteRequest_t</span>	<span class="o">*</span><span class="n">IstwiRWRequest</span><span class="p">;</span>
	<span class="n">MPT_FRAME_HDR</span>		<span class="o">*</span><span class="n">mf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">MPIHeader_t</span>		<span class="o">*</span><span class="n">mpi_hdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">timeleft</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* Reset long to int. Should affect IA64 and SPARC only</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hp_host_info_t</span><span class="p">))</span>
		<span class="n">cim_rev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hp_host_info_rev0_t</span><span class="p">))</span>
		<span class="n">cim_rev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* obsolete */</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">,</span> <span class="n">uarg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hp_host_info_t</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;%s@%d::mptctl_hp_host_info - &quot;</span>
			<span class="s">&quot;Unable to read in hp_host_info struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">iocnum</span> <span class="o">=</span> <span class="n">mpt_verify_adapter</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">iocnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ioc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span> <span class="s">&quot;%s::mptctl_hp_hostinfo() @%d - ioc%d not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">iocnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;: mptctl_hp_hostinfo called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="cm">/* Fill in the data and return the structure to the calling</span>
<span class="cm">	 * program</span>
<span class="cm">	 */</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>

	<span class="n">karg</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">subsystem_id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">subsystem_vendor</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">devfn</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="cm">/* Save the SCSI host no. if</span>
<span class="cm">	 * SCSI driver loaded</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">karg</span><span class="p">.</span><span class="n">host_no</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">karg</span><span class="p">.</span><span class="n">host_no</span> <span class="o">=</span>  <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Reformat the fw_version into a string</span>
<span class="cm">	 */</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">fw_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Struct</span><span class="p">.</span><span class="n">Major</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="o">?</span>
		<span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Struct</span><span class="p">.</span><span class="n">Major</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">fw_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Struct</span><span class="p">.</span><span class="n">Major</span> <span class="o">%</span> <span class="mi">10</span> <span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">fw_version</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">fw_version</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Struct</span><span class="p">.</span><span class="n">Minor</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="o">?</span>
		<span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Struct</span><span class="p">.</span><span class="n">Minor</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">fw_version</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Struct</span><span class="p">.</span><span class="n">Minor</span> <span class="o">%</span> <span class="mi">10</span> <span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">fw_version</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">fw_version</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Struct</span><span class="p">.</span><span class="n">Unit</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="o">?</span>
		<span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Struct</span><span class="p">.</span><span class="n">Unit</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">fw_version</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Struct</span><span class="p">.</span><span class="n">Unit</span> <span class="o">%</span> <span class="mi">10</span> <span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">fw_version</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">fw_version</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Struct</span><span class="p">.</span><span class="n">Dev</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="o">?</span>
		<span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Struct</span><span class="p">.</span><span class="n">Dev</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">fw_version</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Struct</span><span class="p">.</span><span class="n">Dev</span> <span class="o">%</span> <span class="mi">10</span> <span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">fw_version</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="cm">/* Issue a config request to get the device serial number</span>
<span class="cm">	 */</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_MANUFACTURING</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* read */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">serial_number</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Issue the second config page request */</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

			<span class="n">pbuf</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf_dma</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pbuf</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">buf_dma</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ManufacturingPage0_t</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">ManufacturingPage0_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pbuf</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">BoardTracerNumber</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">strncpy</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">serial_number</span><span class="p">,</span> 									    <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">BoardTracerNumber</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
						<span class="n">karg</span><span class="p">.</span><span class="n">serial_number</span><span class="p">[</span><span class="mi">24</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">,</span> <span class="n">buf_dma</span><span class="p">);</span>
				<span class="n">pbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_IOC_STATE_OPERATIONAL</span>:
		<span class="n">karg</span><span class="p">.</span><span class="n">ioc_status</span> <span class="o">=</span>  <span class="n">HP_STATUS_OK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOC_STATE_FAULT</span>:
		<span class="n">karg</span><span class="p">.</span><span class="n">ioc_status</span> <span class="o">=</span>  <span class="n">HP_STATUS_FAILED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOC_STATE_RESET</span>:
	<span class="k">case</span> <span class="n">MPI_IOC_STATE_READY</span>:
	<span class="nl">default:</span>
		<span class="n">karg</span><span class="p">.</span><span class="n">ioc_status</span> <span class="o">=</span>  <span class="n">HP_STATUS_OTHER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">karg</span><span class="p">.</span><span class="n">base_io_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FC</span><span class="p">))</span>
		<span class="n">karg</span><span class="p">.</span><span class="n">bus_phys_width</span> <span class="o">=</span> <span class="n">HP_BUS_WIDTH_UNK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">karg</span><span class="p">.</span><span class="n">bus_phys_width</span> <span class="o">=</span> <span class="n">HP_BUS_WIDTH_16</span><span class="p">;</span>

	<span class="n">karg</span><span class="p">.</span><span class="n">hard_resets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">soft_resets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">timeouts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MPT_SCSI_HOST</span> <span class="o">*</span><span class="n">hd</span> <span class="o">=</span>  <span class="n">shost_priv</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hd</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cim_rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">karg</span><span class="p">.</span><span class="n">hard_resets</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hard_resets</span><span class="p">;</span>
			<span class="n">karg</span><span class="p">.</span><span class="n">soft_resets</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">soft_resets</span><span class="p">;</span>
			<span class="n">karg</span><span class="p">.</span><span class="n">timeouts</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">timeouts</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* </span>
<span class="cm">	 * Gather ISTWI(Industry Standard Two Wire Interface) Data</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">mptctl_id</span><span class="p">,</span> <span class="n">ioc</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			<span class="s">&quot;%s, no msg frames!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IstwiRWRequest</span> <span class="o">=</span> <span class="p">(</span><span class="n">ToolboxIstwiReadWriteRequest_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">mpi_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPIHeader_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">IstwiRWRequest</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ToolboxIstwiReadWriteRequest_t</span><span class="p">));</span>
	<span class="n">IstwiRWRequest</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_TOOLBOX</span><span class="p">;</span>
	<span class="n">IstwiRWRequest</span><span class="o">-&gt;</span><span class="n">Tool</span> <span class="o">=</span> <span class="n">MPI_TOOLBOX_ISTWI_READ_WRITE_TOOL</span><span class="p">;</span>
	<span class="n">IstwiRWRequest</span><span class="o">-&gt;</span><span class="n">MsgContext</span> <span class="o">=</span> <span class="n">mpi_hdr</span><span class="o">-&gt;</span><span class="n">MsgContext</span><span class="p">;</span>
	<span class="n">IstwiRWRequest</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">MPI_TB_ISTWI_FLAGS_READ</span><span class="p">;</span>
	<span class="n">IstwiRWRequest</span><span class="o">-&gt;</span><span class="n">NumAddressBytes</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">IstwiRWRequest</span><span class="o">-&gt;</span><span class="n">DataLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x04</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">IstwiRWRequest</span><span class="o">-&gt;</span><span class="n">DeviceAddr</span> <span class="o">=</span> <span class="mh">0xB2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">IstwiRWRequest</span><span class="o">-&gt;</span><span class="n">DeviceAddr</span> <span class="o">=</span> <span class="mh">0xB0</span><span class="p">;</span>

	<span class="n">pbuf</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbuf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">IstwiRWRequest</span><span class="o">-&gt;</span><span class="n">SGL</span><span class="p">,</span>
	    <span class="p">(</span><span class="n">MPT_SGE_FLAGS_SSIMPLE_READ</span><span class="o">|</span><span class="mi">4</span><span class="p">),</span> <span class="n">buf_dma</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SET_MGMT_MSG_CONTEXT</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">msg_context</span><span class="p">,</span>
				<span class="n">IstwiRWRequest</span><span class="o">-&gt;</span><span class="n">MsgContext</span><span class="p">);</span>
	<span class="n">INITIALIZE_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">mpt_put_msg_frame</span><span class="p">(</span><span class="n">mptctl_id</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>

<span class="nl">retry_wait:</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span>
			<span class="n">HZ</span><span class="o">*</span><span class="n">MPT_IOCTL_DEFAULT_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;%s: failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeleft</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			       <span class="s">&quot;HOST INFO command timeout, doorbell=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
			<span class="n">mptctl_timeout_expired</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">retry_wait</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *ISTWI Data Definition</span>
<span class="cm">	 * pbuf[0] = FW_VERSION = 0x4</span>
<span class="cm">	 * pbuf[1] = Bay Count = 6 or 4 or 2, depending on</span>
<span class="cm">	 *  the config, you should be seeing one out of these three values</span>
<span class="cm">	 * pbuf[2] = Drive Installed Map = bit pattern depend on which</span>
<span class="cm">	 *   bays have drives in them</span>
<span class="cm">	 * pbuf[3] = Checksum (0x100 = (byte0 + byte2 + byte3)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">)</span>
		<span class="n">karg</span><span class="p">.</span><span class="n">rsvd</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">pbuf</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">CLEAR_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">SET_MGMT_MSG_CONTEXT</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">msg_context</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pbuf</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">,</span> <span class="n">buf_dma</span><span class="p">);</span>

	<span class="cm">/* Copy the data from kernel memory to user memory</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">karg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hp_host_info_t</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_hpgethostinfo - &quot;</span>
			<span class="s">&quot;Unable to write out hp_host_info @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/* Prototype Routine for the TARGET INFO command.</span>
<span class="cm"> *</span>
<span class="cm"> * Outputs:	None.</span>
<span class="cm"> * Return:	0 if successful</span>
<span class="cm"> *		-EFAULT if data unavailable</span>
<span class="cm"> *		-EBUSY  if previous command timeout and IOC reset is not complete.</span>
<span class="cm"> *		-ENODEV if no such device/adapter</span>
<span class="cm"> *		-ETIME	if timer expires</span>
<span class="cm"> *		-ENOMEM if memory allocation error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_hp_targetinfo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hp_target_info_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uarg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">SCSIDevicePage0_t</span>	<span class="o">*</span><span class="n">pg0_alloc</span><span class="p">;</span>
	<span class="n">SCSIDevicePage3_t</span>	<span class="o">*</span><span class="n">pg3_alloc</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>		<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">MPT_SCSI_HOST</span> 		<span class="o">*</span><span class="n">hd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hp_target_info_t</span>	<span class="n">karg</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">iocnum</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">data_sz</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">page_dma</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span>	 	<span class="n">cfg</span><span class="p">;</span>
	<span class="n">ConfigPageHeader_t</span>	<span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">tmp</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">,</span> <span class="n">uarg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hp_target_info_t</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;%s@%d::mptctl_hp_targetinfo - &quot;</span>
			<span class="s">&quot;Unable to read in hp_host_targetinfo struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">iocnum</span> <span class="o">=</span> <span class="n">mpt_verify_adapter</span><span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">iocnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ioc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span> <span class="s">&quot;%s::mptctl_hp_targetinfo() @%d - ioc%d not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">iocnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;mptctl_hp_targetinfo called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="cm">/*  There is nothing to do for FCP parts.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FC</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp0length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">host_no</span> <span class="o">!=</span> <span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">host</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

       <span class="cm">/* Get the data transfer speeds</span>
<span class="cm">        */</span>
	<span class="n">data_sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp0length</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">pg0_alloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIDevicePage0_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pg0_alloc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp0version</span><span class="p">;</span>
		<span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="n">data_sz</span><span class="p">;</span>
		<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_SCSI_DEVICE</span><span class="p">;</span>

		<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">page_dma</span><span class="p">;</span>

		<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">np</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pg0_alloc</span><span class="o">-&gt;</span><span class="n">NegotiatedParameters</span><span class="p">);</span>
			<span class="n">karg</span><span class="p">.</span><span class="n">negotiated_width</span> <span class="o">=</span> <span class="n">np</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_WIDE</span> <span class="o">?</span>
					<span class="n">HP_BUS_WIDTH_16</span> <span class="o">:</span> <span class="n">HP_BUS_WIDTH_8</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_NEG_SYNC_OFFSET_MASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIDEVPAGE0_NP_NEG_SYNC_PERIOD_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mh">0x09</span><span class="p">)</span>
					<span class="n">karg</span><span class="p">.</span><span class="n">negotiated_speed</span> <span class="o">=</span> <span class="n">HP_DEV_SPEED_ULTRA320</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mh">0x09</span><span class="p">)</span>
					<span class="n">karg</span><span class="p">.</span><span class="n">negotiated_speed</span> <span class="o">=</span> <span class="n">HP_DEV_SPEED_ULTRA160</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mh">0x0A</span><span class="p">)</span>
					<span class="n">karg</span><span class="p">.</span><span class="n">negotiated_speed</span> <span class="o">=</span> <span class="n">HP_DEV_SPEED_ULTRA2</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mh">0x0C</span><span class="p">)</span>
					<span class="n">karg</span><span class="p">.</span><span class="n">negotiated_speed</span> <span class="o">=</span> <span class="n">HP_DEV_SPEED_ULTRA</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mh">0x25</span><span class="p">)</span>
					<span class="n">karg</span><span class="p">.</span><span class="n">negotiated_speed</span> <span class="o">=</span> <span class="n">HP_DEV_SPEED_FAST</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">karg</span><span class="p">.</span><span class="n">negotiated_speed</span> <span class="o">=</span> <span class="n">HP_DEV_SPEED_ASYNC</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">karg</span><span class="p">.</span><span class="n">negotiated_speed</span> <span class="o">=</span> <span class="n">HP_DEV_SPEED_ASYNC</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">pg0_alloc</span><span class="p">,</span> <span class="n">page_dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set defaults</span>
<span class="cm">	 */</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">message_rejects</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">phase_errors</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">parity_errors</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">select_timeouts</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Get the target error parameters</span>
<span class="cm">	 */</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_SCSI_DEVICE</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Issue the second config page request */</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>
		<span class="n">data_sz</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">pg3_alloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIDevicePage3_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span>
							<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pg3_alloc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">page_dma</span><span class="p">;</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">karg</span><span class="p">.</span><span class="n">message_rejects</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pg3_alloc</span><span class="o">-&gt;</span><span class="n">MsgRejectCount</span><span class="p">);</span>
				<span class="n">karg</span><span class="p">.</span><span class="n">phase_errors</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pg3_alloc</span><span class="o">-&gt;</span><span class="n">PhaseErrorCount</span><span class="p">);</span>
				<span class="n">karg</span><span class="p">.</span><span class="n">parity_errors</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pg3_alloc</span><span class="o">-&gt;</span><span class="n">ParityErrorCount</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">pg3_alloc</span><span class="p">,</span> <span class="n">page_dma</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">karg</span><span class="p">.</span><span class="n">select_timeouts</span> <span class="o">=</span> <span class="n">hd</span><span class="o">-&gt;</span><span class="n">sel_timeout</span><span class="p">[</span><span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">id</span><span class="p">];</span>

	<span class="cm">/* Copy the data from kernel memory to user memory</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">karg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hp_target_info_t</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s@%d::mptctl_hp_target_info - &quot;</span>
			<span class="s">&quot;Unable to write out mpt_ioctl_targetinfo struct @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">uarg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mptctl_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span>	<span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fasync</span> <span class="o">=</span> 	<span class="n">mptctl_fasync</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">mptctl_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">mptctl_release</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span> <span class="o">=</span> <span class="n">compat_mpctl_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">mptctl_miscdev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MPT_MINOR</span><span class="p">,</span>
	<span class="n">MYNAM</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">mptctl_fops</span>
<span class="p">};</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">compat_mptfwxfer_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpt_fw_xfer32</span> <span class="n">kfw32</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpt_fw_xfer</span> <span class="n">kfw</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">iocp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iocnum</span><span class="p">,</span> <span class="n">iocnumX</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nonblock</span> <span class="o">=</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kfw32</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kfw32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* Verify intended MPT adapter */</span>
	<span class="n">iocnumX</span> <span class="o">=</span> <span class="n">kfw32</span><span class="p">.</span><span class="n">iocnum</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">iocnum</span> <span class="o">=</span> <span class="n">mpt_verify_adapter</span><span class="p">(</span><span class="n">iocnumX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iocp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">iocp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span> <span class="s">&quot;::compat_mptfwxfer_ioctl @%d - ioc%d not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__LINE__</span><span class="p">,</span> <span class="n">iocnumX</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">mptctl_syscall_down</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="n">nonblock</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;compat_mptfwxfer_ioctl() called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">kfw</span><span class="p">.</span><span class="n">iocnum</span> <span class="o">=</span> <span class="n">iocnum</span><span class="p">;</span>
	<span class="n">kfw</span><span class="p">.</span><span class="n">fwlen</span> <span class="o">=</span> <span class="n">kfw32</span><span class="p">.</span><span class="n">fwlen</span><span class="p">;</span>
	<span class="n">kfw</span><span class="p">.</span><span class="n">bufp</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">kfw32</span><span class="p">.</span><span class="n">bufp</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mptctl_do_fw_download</span><span class="p">(</span><span class="n">kfw</span><span class="p">.</span><span class="n">iocnum</span><span class="p">,</span> <span class="n">kfw</span><span class="p">.</span><span class="n">bufp</span><span class="p">,</span> <span class="n">kfw</span><span class="p">.</span><span class="n">fwlen</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iocp</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">compat_mpt_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_command32</span> <span class="n">karg32</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_command32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uarg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mpt_ioctl_command32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpt_ioctl_command</span> <span class="n">karg</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">iocp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iocnum</span><span class="p">,</span> <span class="n">iocnumX</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nonblock</span> <span class="o">=</span> <span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg32</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">karg32</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* Verify intended MPT adapter */</span>
	<span class="n">iocnumX</span> <span class="o">=</span> <span class="n">karg32</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">iocnum</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">iocnum</span> <span class="o">=</span> <span class="n">mpt_verify_adapter</span><span class="p">(</span><span class="n">iocnumX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iocp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">iocp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span> <span class="s">&quot;::compat_mpt_command @%d - ioc%d not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__LINE__</span><span class="p">,</span> <span class="n">iocnumX</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">mptctl_syscall_down</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="n">nonblock</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dctlprintk</span><span class="p">(</span><span class="n">iocp</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;compat_mpt_command() called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">iocp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="cm">/* Copy data to karg */</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">iocnum</span> <span class="o">=</span> <span class="n">karg32</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">iocnum</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">karg32</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">port</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">karg32</span><span class="p">.</span><span class="n">timeout</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">maxReplyBytes</span> <span class="o">=</span> <span class="n">karg32</span><span class="p">.</span><span class="n">maxReplyBytes</span><span class="p">;</span>

	<span class="n">karg</span><span class="p">.</span><span class="n">dataInSize</span> <span class="o">=</span> <span class="n">karg32</span><span class="p">.</span><span class="n">dataInSize</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">dataOutSize</span> <span class="o">=</span> <span class="n">karg32</span><span class="p">.</span><span class="n">dataOutSize</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">maxSenseBytes</span> <span class="o">=</span> <span class="n">karg32</span><span class="p">.</span><span class="n">maxSenseBytes</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">dataSgeOffset</span> <span class="o">=</span> <span class="n">karg32</span><span class="p">.</span><span class="n">dataSgeOffset</span><span class="p">;</span>

	<span class="n">karg</span><span class="p">.</span><span class="n">replyFrameBufPtr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">karg32</span><span class="p">.</span><span class="n">replyFrameBufPtr</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">dataInBufPtr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">karg32</span><span class="p">.</span><span class="n">dataInBufPtr</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">dataOutBufPtr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">karg32</span><span class="p">.</span><span class="n">dataOutBufPtr</span><span class="p">;</span>
	<span class="n">karg</span><span class="p">.</span><span class="n">senseDataPtr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">karg32</span><span class="p">.</span><span class="n">senseDataPtr</span><span class="p">;</span>

	<span class="cm">/* Pass new structure to do_mpt_command</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mptctl_do_mpt_command</span> <span class="p">(</span><span class="n">karg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uarg</span><span class="o">-&gt;</span><span class="n">MF</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iocp</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">compat_mpctl_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpctl_mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPTIOCINFO</span>:
	<span class="k">case</span> <span class="n">MPTIOCINFO1</span>:
	<span class="k">case</span> <span class="n">MPTIOCINFO2</span>:
	<span class="k">case</span> <span class="n">MPTTARGETINFO</span>:
	<span class="k">case</span> <span class="n">MPTEVENTQUERY</span>:
	<span class="k">case</span> <span class="n">MPTEVENTENABLE</span>:
	<span class="k">case</span> <span class="n">MPTEVENTREPORT</span>:
	<span class="k">case</span> <span class="n">MPTHARDRESET</span>:
	<span class="k">case</span> <span class="n">HP_GETHOSTINFO</span>:
	<span class="k">case</span> <span class="n">HP_GETTARGETINFO</span>:
	<span class="k">case</span> <span class="n">MPTTEST</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__mptctl_ioctl</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPTCOMMAND32</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">compat_mpt_command</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPTFWDOWNLOAD32</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">compat_mptfwxfer_ioctl</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpctl_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>


<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptctl_probe - Installs ioctl devices per bus.</span>
<span class="cm"> *	@pdev: Pointer to pci_dev structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptctl_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioctl_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	mptctl_remove - Removed ioctl devices</span>
<span class="cm"> *	@pdev: Pointer to pci_dev structure</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptctl_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mpt_pci_driver</span> <span class="n">mptctl_driver</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mptctl_probe</span><span class="p">,</span>
  <span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">mptctl_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mptctl_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">where</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">show_mptmod_ver</span><span class="p">(</span><span class="n">my_NAME</span><span class="p">,</span> <span class="n">my_VERSION</span><span class="p">);</span>

	<span class="n">mpt_device_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptctl_driver</span><span class="p">,</span> <span class="n">MPTCTL_DRIVER</span><span class="p">);</span>

	<span class="cm">/* Register this device */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptctl_miscdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;: Can&#39;t register misc device [minor=%d].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MPT_MINOR</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">MYNAM</span> <span class="s">&quot;: Registered with Fusion MPT base driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">MYNAM</span> <span class="s">&quot;: /dev/%s @ (major,minor=%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">mptctl_miscdev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">MISC_MAJOR</span><span class="p">,</span> <span class="n">mptctl_miscdev</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Install our handler</span>
<span class="cm">	 */</span>
	<span class="o">++</span><span class="n">where</span><span class="p">;</span>
	<span class="n">mptctl_id</span> <span class="o">=</span> <span class="n">mpt_register</span><span class="p">(</span><span class="n">mptctl_reply</span><span class="p">,</span> <span class="n">MPTCTL_DRIVER</span><span class="p">,</span>
	    <span class="s">&quot;mptctl_reply&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mptctl_id</span> <span class="o">||</span> <span class="n">mptctl_id</span> <span class="o">&gt;=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;: ERROR: Failed to register with Fusion MPT base driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptctl_miscdev</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mptctl_taskmgmt_id</span> <span class="o">=</span> <span class="n">mpt_register</span><span class="p">(</span><span class="n">mptctl_taskmgmt_reply</span><span class="p">,</span> <span class="n">MPTCTL_DRIVER</span><span class="p">,</span>
	    <span class="s">&quot;mptctl_taskmgmt_reply&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mptctl_taskmgmt_id</span> <span class="o">||</span> <span class="n">mptctl_taskmgmt_id</span> <span class="o">&gt;=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;: ERROR: Failed to register with Fusion MPT base driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mpt_deregister</span><span class="p">(</span><span class="n">mptctl_id</span><span class="p">);</span>
		<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptctl_miscdev</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpt_reset_register</span><span class="p">(</span><span class="n">mptctl_id</span><span class="p">,</span> <span class="n">mptctl_ioc_reset</span><span class="p">);</span>
	<span class="n">mpt_event_register</span><span class="p">(</span><span class="n">mptctl_id</span><span class="p">,</span> <span class="n">mptctl_event_process</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_fail:</span>

	<span class="n">mpt_device_driver_deregister</span><span class="p">(</span><span class="n">MPTCTL_DRIVER</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mptctl_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mptctl_miscdev</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">MYNAM</span> <span class="s">&quot;: Deregistered /dev/%s @ (major,minor=%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">mptctl_miscdev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">MISC_MAJOR</span><span class="p">,</span> <span class="n">mptctl_miscdev</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>

	<span class="cm">/* De-register event handler from base module */</span>
	<span class="n">mpt_event_deregister</span><span class="p">(</span><span class="n">mptctl_id</span><span class="p">);</span>

	<span class="cm">/* De-register reset handler from base module */</span>
	<span class="n">mpt_reset_deregister</span><span class="p">(</span><span class="n">mptctl_id</span><span class="p">);</span>

	<span class="cm">/* De-register callback handler from base module */</span>
	<span class="n">mpt_deregister</span><span class="p">(</span><span class="n">mptctl_taskmgmt_id</span><span class="p">);</span>
	<span class="n">mpt_deregister</span><span class="p">(</span><span class="n">mptctl_id</span><span class="p">);</span>

        <span class="n">mpt_device_driver_deregister</span><span class="p">(</span><span class="n">MPTCTL_DRIVER</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">mptctl_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mptctl_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
