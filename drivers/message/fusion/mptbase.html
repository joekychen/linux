<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › message › fusion › mptbase.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mptbase.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/drivers/message/fusion/mptbase.c</span>
<span class="cm"> *      This is the Fusion MPT base driver which supports multiple</span>
<span class="cm"> *      (SCSI + LAN) specialized protocol drivers.</span>
<span class="cm"> *      For use with LSI PCI chip/adapter(s)</span>
<span class="cm"> *      running LSI Fusion MPT (Message Passing Technology) firmware.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 1999-2008 LSI Corporation</span>
<span class="cm"> *  (mailto:DL-MPTFusionLinux@lsi.com)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; version 2 of the License.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    NO WARRANTY</span>
<span class="cm">    THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span>
<span class="cm">    CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT</span>
<span class="cm">    LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,</span>
<span class="cm">    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is</span>
<span class="cm">    solely responsible for determining the appropriateness of using and</span>
<span class="cm">    distributing the Program and assumes all risks associated with its</span>
<span class="cm">    exercise of rights under this Agreement, including but not limited to</span>
<span class="cm">    the risks and costs of program errors, damage to or loss of data,</span>
<span class="cm">    programs or equipment, and unavailability or interruption of operations.</span>

<span class="cm">    DISCLAIMER OF LIABILITY</span>
<span class="cm">    NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY</span>
<span class="cm">    DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm">    DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND</span>
<span class="cm">    ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR</span>
<span class="cm">    TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE</span>
<span class="cm">    USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED</span>
<span class="cm">    HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm">*/</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/kdev_t.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;		</span><span class="cm">/* needed for in_interrupt() proto */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="cp">#include &lt;asm/mtrr.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>

<span class="cp">#include &quot;mptbase.h&quot;</span>
<span class="cp">#include &quot;lsi/mpi_log_fc.h&quot;</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cp">#define my_NAME		&quot;Fusion MPT base driver&quot;</span>
<span class="cp">#define my_VERSION	MPT_LINUX_VERSION_COMMON</span>
<span class="cp">#define MYNAM		&quot;mptbase&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">MODULEAUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">my_NAME</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">my_VERSION</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  cmd line parameters</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mpt_msi_enable_spi</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mpt_msi_enable_spi</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpt_msi_enable_spi</span><span class="p">,</span>
		 <span class="s">&quot; Enable MSI Support for SPI controllers (default=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mpt_msi_enable_fc</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mpt_msi_enable_fc</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpt_msi_enable_fc</span><span class="p">,</span>
		 <span class="s">&quot; Enable MSI Support for FC controllers (default=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mpt_msi_enable_sas</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mpt_msi_enable_sas</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpt_msi_enable_sas</span><span class="p">,</span>
		 <span class="s">&quot; Enable MSI Support for SAS controllers (default=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mpt_channel_mapping</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mpt_channel_mapping</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpt_channel_mapping</span><span class="p">,</span> <span class="s">&quot; Mapping id&#39;s to channels (default=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mpt_debug_level</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mpt_set_debug_level</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">);</span>
<span class="n">module_param_call</span><span class="p">(</span><span class="n">mpt_debug_level</span><span class="p">,</span> <span class="n">mpt_set_debug_level</span><span class="p">,</span> <span class="n">param_get_int</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">mpt_debug_level</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpt_debug_level</span><span class="p">,</span>
		 <span class="s">&quot; debug level - refer to mptdebug.h - (default=0)&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">mpt_fwfault_debug</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_fwfault_debug</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mpt_fwfault_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpt_fwfault_debug</span><span class="p">,</span>
		 <span class="s">&quot;Enable detection of Firmware fault and halt Firmware on fault - (default=0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span>	<span class="n">MptCallbacksName</span><span class="p">[</span><span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">]</span>
				<span class="p">[</span><span class="n">MPT_MAX_CALLBACKNAME_LEN</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

<span class="cp">#ifdef MFCNT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mfcounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#define PRINT_MF_COUNT 20000</span>
<span class="cp">#endif</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *  Public data...</span>
<span class="cm"> */</span>

<span class="cp">#define WHOINIT_UNKNOWN		0xAA</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *  Private data...</span>
<span class="cm"> */</span>
					<span class="cm">/* Adapter link list */</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">ioc_list</span><span class="p">);</span>
					<span class="cm">/* Callback lookup table */</span>
<span class="k">static</span> <span class="n">MPT_CALLBACK</span>		 <span class="n">MptCallbacks</span><span class="p">[</span><span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">];</span>
					<span class="cm">/* Protocol driver class lookup table */</span>
<span class="k">static</span> <span class="kt">int</span>			 <span class="n">MptDriverClass</span><span class="p">[</span><span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">];</span>
					<span class="cm">/* Event handler lookup table */</span>
<span class="k">static</span> <span class="n">MPT_EVHANDLER</span>		 <span class="n">MptEvHandlers</span><span class="p">[</span><span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">];</span>
					<span class="cm">/* Reset handler lookup table */</span>
<span class="k">static</span> <span class="n">MPT_RESETHANDLER</span>		 <span class="n">MptResetHandlers</span><span class="p">[</span><span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mpt_pci_driver</span> 	<span class="o">*</span><span class="n">MptDeviceDriverHandlers</span><span class="p">[</span><span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">];</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> 	<span class="o">*</span><span class="n">mpt_proc_root_dir</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *  Driver Callback Index&#39;s</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">mpt_base_index</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">last_drv_idx</span><span class="p">;</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *  Forward protos...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">mpt_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bus_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">mptbase_reply</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
		<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">reply</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">mpt_handshake_req_reply_wait</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reqBytes</span><span class="p">,</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">replyBytes</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">u16reply</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxwait</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">mpt_do_ioc_recovery</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reason</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">mpt_detect_bound_ports</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">mpt_adapter_disable</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">mpt_adapter_dispose</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>	<span class="n">MptDisplayIocCapabilities</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">MakeIocReady</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">GetIocFacts</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">GetPortFacts</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portnum</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">SendIocInit</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">SendPortEnable</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portnum</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">mpt_do_upload</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">mpt_downloadboot</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MpiFwHeader_t</span> <span class="o">*</span><span class="n">pFwHeader</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">mpt_diag_reset</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignore</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">KickStart</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignore</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">SendIocReset</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reset_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">PrimeIocFifos</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">WaitForDoorbellAck</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">howlong</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">WaitForDoorbellInt</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">howlong</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">WaitForDoorbellReply</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">howlong</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">GetLanConfigPages</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">GetIoUnitPage2</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="kt">int</span>		<span class="n">mptbase_sas_persist_operation</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">persist_opcode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">mpt_GetScsiPortSettings</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portnum</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">mpt_readScsiDevicePageHeaders</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portnum</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> 	<span class="n">mpt_read_ioc_pg_1</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> 	<span class="n">mpt_read_ioc_pg_4</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">mpt_get_manufacturing_pg_0</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">SendEventNotification</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">EvSwitch</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">SendEventAck</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">EventNotificationReply_t</span> <span class="o">*</span><span class="n">evnp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">mpt_host_page_access_control</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">access_control_value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">mpt_host_page_alloc</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">pIOCInit_t</span> <span class="n">ioc_init</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mpt_summary_proc_fops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mpt_version_proc_fops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mpt_iocinfo_proc_fops</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">mpt_get_fw_exp_ver</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>	<span class="n">ProcessEventNotification</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
		<span class="n">EventNotificationReply_t</span> <span class="o">*</span><span class="n">evReply</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">evHandlers</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">mpt_iocstatus_info</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ioc_status</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">mpt_fc_log_info</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">log_info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">mpt_spi_log_info</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">log_info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">mpt_sas_log_info</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">log_info</span> <span class="p">,</span> <span class="n">u8</span> <span class="n">cb_idx</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">mpt_read_ioc_pg_3</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">mpt_inactive_raid_list_free</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">);</span>

<span class="cm">/* module entry point */</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">__init</span>    <span class="n">fusion_init</span>  <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>    <span class="n">fusion_exit</span>  <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#define CHIPREG_READ32(addr) 		readl_relaxed(addr)</span>
<span class="cp">#define CHIPREG_READ32_dmasync(addr)	readl(addr)</span>
<span class="cp">#define CHIPREG_WRITE32(addr,val) 	writel(val, addr)</span>
<span class="cp">#define CHIPREG_PIO_WRITE32(addr,val)	outl(val, (unsigned long)addr)</span>
<span class="cp">#define CHIPREG_PIO_READ32(addr) 	inl((unsigned long)addr)</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pci_disable_io_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">command_reg</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command_reg</span><span class="p">);</span>
	<span class="n">command_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">command_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pci_enable_io_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">command_reg</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command_reg</span><span class="p">);</span>
	<span class="n">command_reg</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">command_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpt_set_debug_level</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">param_set_int</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">kp</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">debug_level</span> <span class="o">=</span> <span class="n">mpt_debug_level</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mpt_get_cb_idx - obtain cb_idx for registered driver</span>
<span class="cm"> *	@dclass: class driver enum</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns cb_idx, or zero means it wasn&#39;t found</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">mpt_get_cb_idx</span><span class="p">(</span><span class="n">MPT_DRIVER_CLASS</span> <span class="n">dclass</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cb_idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">cb_idx</span><span class="p">;</span> <span class="n">cb_idx</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MptDriverClass</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">dclass</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">cb_idx</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt_is_discovery_complete - determine if discovery has completed</span>
<span class="cm"> * @ioc: per adatper instance</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 when discovery completed, else zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpt_is_discovery_complete</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ConfigExtendedPageHeader_t</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">SasIOUnitPage0_t</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ConfigExtendedPageHeader_t</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CONFIGPARMS</span><span class="p">));</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">MPI_SASIOUNITPAGE0_PAGEVERSION</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_EXTENDED</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_EXTPAGETYPE_SAS_IO_UNIT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">ehdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_free_consistent</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">PhyData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">PortFlags</span> <span class="o">&amp;</span>
	    <span class="n">MPI_SAS_IOUNIT0_PORT_FLAGS_DISCOVERY_IN_PROGRESS</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

 <span class="nl">out_free_consistent:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
	    <span class="n">buffer</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *  mpt_remove_dead_ioc_func - kthread context to remove dead ioc</span>
<span class="cm"> * @arg: input argument, used to derive ioc</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 if controller is removed from pci subsystem.</span>
<span class="cm"> * Return -1 for other case.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpt_remove_dead_ioc_func</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">pci_stop_and_remove_bus_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/**</span>
<span class="cm"> *	mpt_fault_reset_work - work performed on workq after ioc fault</span>
<span class="cm"> *	@work: input argument, used to derive ioc</span>
<span class="cm"> *</span>
<span class="cm">**/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_fault_reset_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">MPT_ADAPTER</span><span class="p">,</span> <span class="n">fault_reset_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">u32</span>		 <span class="n">ioc_raw_state</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">flags</span><span class="p">;</span>
	<span class="n">MPT_SCSI_HOST</span>	<span class="o">*</span><span class="n">hd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span> <span class="o">||</span> <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>


	<span class="n">ioc_raw_state</span> <span class="o">=</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc_raw_state</span> <span class="o">&amp;</span> <span class="n">MPI_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPI_IOC_STATE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;%s: IOC is non-operational !!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Call mptscsih_flush_pending_cmds callback so that we</span>
<span class="cm">		 * flush all pending commands back to OS.</span>
<span class="cm">		 * This call is required to aovid deadlock at block layer.</span>
<span class="cm">		 * Dead IOC will fail to do diag reset,and this call is safe</span>
<span class="cm">		 * since dead ioc will never return any command back from HW.</span>
<span class="cm">		 */</span>
		<span class="n">hd</span> <span class="o">=</span> <span class="n">shost_priv</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">schedule_dead_ioc_flush_running_cmds</span><span class="p">(</span><span class="n">hd</span><span class="p">);</span>

		<span class="cm">/*Remove the Dead Host */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">mpt_remove_dead_ioc_func</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span>
				<span class="s">&quot;mpt_dead_ioc_%d&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>	<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
				<span class="s">&quot;%s: Running mpt_dead_ioc thread failed !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
				<span class="s">&quot;%s: Running mpt_dead_ioc thread success !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* don&#39;t rearm timer */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ioc_raw_state</span> <span class="o">&amp;</span> <span class="n">MPI_IOC_STATE_MASK</span><span class="p">)</span>
			<span class="o">==</span> <span class="n">MPI_IOC_STATE_FAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;IOC is in FAULT state (%04xh)!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc_raw_state</span> <span class="o">&amp;</span> <span class="n">MPI_DOORBELL_DATA_MASK</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;Issuing HardReset from %s!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_HardResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;%s: HardReset: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;success&quot;</span> <span class="o">:</span> <span class="s">&quot;failed&quot;</span><span class="p">);</span>
		<span class="n">ioc_raw_state</span> <span class="o">=</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ioc_raw_state</span> <span class="o">&amp;</span> <span class="n">MPI_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPI_IOC_STATE_FAULT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;IOC is in FAULT state after &quot;</span>
			    <span class="s">&quot;reset (%04xh)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc_raw_state</span> <span class="o">&amp;</span>
			    <span class="n">MPI_DOORBELL_DATA_MASK</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span> <span class="o">&amp;&amp;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_discovery_quiesce_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mpt_is_discovery_complete</span><span class="p">(</span><span class="n">ioc</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;clearing &quot;</span>
			    <span class="s">&quot;discovery_quiesce_io flag</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sas_discovery_quiesce_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Take turns polling alternate controller</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span>
		<span class="n">ioc</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">;</span>

	<span class="cm">/* rearm the timer */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_work_q</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_work_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work</span><span class="p">,</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">MPT_POLLING_INTERVAL</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Process turbo (context) reply...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_turbo_reply</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">req_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cb_idx</span><span class="p">;</span>

	<span class="n">dmfprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Got TURBO reply req_idx=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pa</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pa</span> <span class="o">&gt;&gt;</span> <span class="n">MPI_CONTEXT_REPLY_TYPE_SHIFT</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_CONTEXT_REPLY_TYPE_SCSI_INIT</span>:
		<span class="n">req_idx</span> <span class="o">=</span> <span class="n">pa</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">;</span>
		<span class="n">cb_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pa</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">mf</span> <span class="o">=</span> <span class="n">MPT_INDEX_2_MFPTR</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">req_idx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_CONTEXT_REPLY_TYPE_LAN</span>:
		<span class="n">cb_idx</span> <span class="o">=</span> <span class="n">mpt_get_cb_idx</span><span class="p">(</span><span class="n">MPTLAN_DRIVER</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Blind set of mf to NULL here was fatal</span>
<span class="cm">		 *  after lan_reply says &quot;freeme&quot;</span>
<span class="cm">		 *  Fix sort of combined with an optimization here;</span>
<span class="cm">		 *  added explicit check for case where lan_reply</span>
<span class="cm">		 *  was just returning 1 and doing nothing else.</span>
<span class="cm">		 *  For this case skip the callback, but set up</span>
<span class="cm">		 *  proper mf value first here:-)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pa</span> <span class="o">&amp;</span> <span class="mh">0x58000000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x58000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req_idx</span> <span class="o">=</span> <span class="n">pa</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">;</span>
			<span class="n">mf</span> <span class="o">=</span> <span class="n">MPT_INDEX_2_MFPTR</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">req_idx</span><span class="p">);</span>
			<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">();</span>
			<span class="k">return</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mr</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="p">)</span> <span class="n">CAST_U32_TO_PTR</span><span class="p">(</span><span class="n">pa</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_CONTEXT_REPLY_TYPE_SCSI_TARGET</span>:
		<span class="n">cb_idx</span> <span class="o">=</span> <span class="n">mpt_get_cb_idx</span><span class="p">(</span><span class="n">MPTSTM_DRIVER</span><span class="p">);</span>
		<span class="n">mr</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="p">)</span> <span class="n">CAST_U32_TO_PTR</span><span class="p">(</span><span class="n">pa</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cb_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/*  Check for (valid) IO callback!  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb_idx</span> <span class="o">||</span> <span class="n">cb_idx</span> <span class="o">&gt;=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span> <span class="o">||</span>
		<span class="n">MptCallbacks</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;%s: Invalid cb_idx (%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cb_idx</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MptCallbacks</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">](</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mr</span><span class="p">))</span>
		<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_reply</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_FRAME_HDR</span>	<span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">MPT_FRAME_HDR</span>	<span class="o">*</span><span class="n">mr</span><span class="p">;</span>
	<span class="n">u16</span>		 <span class="n">req_idx</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">cb_idx</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">freeme</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">reply_dma_low</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ioc_stat</span><span class="p">;</span>

	<span class="cm">/* non-TURBO reply!  Hmmm, something may be up...</span>
<span class="cm">	 *  Newest turbo reply mechanism; get address</span>
<span class="cm">	 *  via left shift 1 (get rid of MPI_ADDRESS_REPLY_A_BIT)!</span>
<span class="cm">	 */</span>

	<span class="cm">/* Map DMA address of reply header to cpu address.</span>
<span class="cm">	 * pa is 32 bits - but the dma address may be 32 or 64 bits</span>
<span class="cm">	 * get offset based only only the low addresses</span>
<span class="cm">	 */</span>

	<span class="n">reply_dma_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">pa</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mr</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_frames</span> <span class="o">+</span>
			 <span class="p">(</span><span class="n">reply_dma_low</span> <span class="o">-</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_frames_low_dma</span><span class="p">));</span>

	<span class="n">req_idx</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">req_idx</span><span class="p">);</span>
	<span class="n">cb_idx</span> <span class="o">=</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">cb_idx</span><span class="p">;</span>
	<span class="n">mf</span> <span class="o">=</span> <span class="n">MPT_INDEX_2_MFPTR</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">req_idx</span><span class="p">);</span>

	<span class="n">dmfprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Got non-TURBO reply=%p req_idx=%x cb_idx=%x Function=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">req_idx</span><span class="p">,</span> <span class="n">cb_idx</span><span class="p">,</span> <span class="n">mr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Function</span><span class="p">));</span>
	<span class="n">DBG_DUMP_REPLY_FRAME</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">mr</span><span class="p">);</span>

	 <span class="cm">/*  Check/log IOC log info</span>
<span class="cm">	 */</span>
	<span class="n">ioc_stat</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">reply</span><span class="p">.</span><span class="n">IOCStatus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_stat</span> <span class="o">&amp;</span> <span class="n">MPI_IOCSTATUS_FLAG_LOG_INFO_AVAILABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span>	 <span class="n">log_info</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">mr</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">reply</span><span class="p">.</span><span class="n">IOCLogInfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FC</span><span class="p">)</span>
			<span class="n">mpt_fc_log_info</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">log_info</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SPI</span><span class="p">)</span>
			<span class="n">mpt_spi_log_info</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">log_info</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span><span class="p">)</span>
			<span class="n">mpt_sas_log_info</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">log_info</span><span class="p">,</span> <span class="n">cb_idx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_stat</span> <span class="o">&amp;</span> <span class="n">MPI_IOCSTATUS_MASK</span><span class="p">)</span>
		<span class="n">mpt_iocstatus_info</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ioc_stat</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>

	<span class="cm">/*  Check for (valid) IO callback!  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb_idx</span> <span class="o">||</span> <span class="n">cb_idx</span> <span class="o">&gt;=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span> <span class="o">||</span>
		<span class="n">MptCallbacks</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;%s: Invalid cb_idx (%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cb_idx</span><span class="p">);</span>
		<span class="n">freeme</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">freeme</span> <span class="o">=</span> <span class="n">MptCallbacks</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">](</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">mr</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="cm">/*  Flush (non-TURBO) reply with a WRITE!  */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ReplyFifo</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freeme</span><span class="p">)</span>
		<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_interrupt - MPT adapter (IOC) specific interrupt handler.</span>
<span class="cm"> *	@irq: irq number (not used)</span>
<span class="cm"> *	@bus_id: bus identifier cookie == pointer to MPT_ADAPTER structure</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine is registered via the request_irq() kernel API call,</span>
<span class="cm"> *	and handles all interrupts generated from a specific MPT adapter</span>
<span class="cm"> *	(also referred to as a IO Controller or IOC).</span>
<span class="cm"> *	This routine must clear the interrupt from the adapter and does</span>
<span class="cm"> *	so by reading the reply FIFO.  Multiple replies may be processed</span>
<span class="cm"> *	per single call to this routine.</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine handles register-level access of the adapter but</span>
<span class="cm"> *	dispatches (calls) a protocol-specific callback routine to handle</span>
<span class="cm"> *	the protocol-specific details of the MPT request completion.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">mpt_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bus_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">bus_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pa</span> <span class="o">=</span> <span class="n">CHIPREG_READ32_dmasync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ReplyFifo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pa</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Drain the reply FIFO!</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pa</span> <span class="o">&amp;</span> <span class="n">MPI_ADDRESS_REPLY_A_BIT</span><span class="p">)</span>
			<span class="n">mpt_reply</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mpt_turbo_reply</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
		<span class="n">pa</span> <span class="o">=</span> <span class="n">CHIPREG_READ32_dmasync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ReplyFifo</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pa</span> <span class="o">!=</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptbase_reply - MPT base driver&#39;s callback routine</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@req: Pointer to original MPT request frame</span>
<span class="cm"> *	@reply: Pointer to MPT reply frame (NULL if TurboReply)</span>
<span class="cm"> *</span>
<span class="cm"> *	MPT base driver&#39;s callback routine; all base driver</span>
<span class="cm"> *	&quot;internal&quot; request/reply processing is routed here.</span>
<span class="cm"> *	Currently used for EventNotification and EventAck handling.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 1 indicating original alloc&#39;d request frame ptr</span>
<span class="cm"> *	should be freed, or 0 if it shouldn&#39;t.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mptbase_reply</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">reply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">EventNotificationReply_t</span> <span class="o">*</span><span class="n">pEventReply</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">evHandlers</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">freereq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_FUNCTION_EVENT_NOTIFICATION</span>:
		<span class="n">pEventReply</span> <span class="o">=</span> <span class="p">(</span><span class="n">EventNotificationReply_t</span> <span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="p">;</span>
		<span class="n">evHandlers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ProcessEventNotification</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">pEventReply</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evHandlers</span><span class="p">);</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pEventReply</span><span class="o">-&gt;</span><span class="n">Event</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pEventReply</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">&amp;</span> <span class="n">MPI_MSGFLAGS_CONTINUATION_REPLY</span><span class="p">)</span>
			<span class="n">freereq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">MPI_EVENT_EVENT_CHANGE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_FUNCTION_CONFIG</span>:
	<span class="k">case</span> <span class="n">MPI_FUNCTION_SAS_IO_UNIT_CONTROL</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span> <span class="n">reply</span><span class="p">,</span>
			    <span class="n">min</span><span class="p">(</span><span class="n">MPT_DEFAULT_FRAME_SIZE</span><span class="p">,</span>
				<span class="mi">4</span> <span class="o">*</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">reply</span><span class="p">.</span><span class="n">MsgLength</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">;</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">freereq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_FREE_MF</span><span class="p">)</span>
			<span class="n">freereq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_FUNCTION_EVENT_ACK</span>:
		<span class="n">devtverboseprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;EventAck reply received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
		    <span class="s">&quot;Unexpected msg function (=%02Xh) reply received!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">reply</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">Function</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Conditionally tell caller to free the original</span>
<span class="cm">	 *	EventNotification/EventAck/unexpected request frame!</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">freereq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_register - Register protocol-specific main callback handler.</span>
<span class="cm"> *	@cbfunc: callback function pointer</span>
<span class="cm"> *	@dclass: Protocol driver&#39;s class (%MPT_DRIVER_CLASS enum value)</span>
<span class="cm"> *	@func_name: call function&#39;s name</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine is called by a protocol-specific driver (SCSI host,</span>
<span class="cm"> *	LAN, SCSI target) to register its reply callback routine.  Each</span>
<span class="cm"> *	protocol-specific driver must do this before it will be able to</span>
<span class="cm"> *	use any IOC resources, such as obtaining request frames.</span>
<span class="cm"> *</span>
<span class="cm"> *	NOTES: The SCSI protocol driver currently calls this routine thrice</span>
<span class="cm"> *	in order to register separate callbacks; one for &quot;normal&quot; SCSI IO;</span>
<span class="cm"> *	one for MptScsiTaskMgmt requests; one for Scan/DV requests.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns u8 valued &quot;handle&quot; in the range (and S.O.D. order)</span>
<span class="cm"> *	{N,...,7,6,5,...,1} if successful.</span>
<span class="cm"> *	A return value of MPT_MAX_PROTOCOL_DRIVERS (including zero!) should be</span>
<span class="cm"> *	considered an error by the caller.</span>
<span class="cm"> */</span>
<span class="n">u8</span>
<span class="nf">mpt_register</span><span class="p">(</span><span class="n">MPT_CALLBACK</span> <span class="n">cbfunc</span><span class="p">,</span> <span class="n">MPT_DRIVER_CLASS</span> <span class="n">dclass</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cb_idx</span><span class="p">;</span>
	<span class="n">last_drv_idx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Search for empty callback slot in this order: {N,...,7,6,5,...,1}</span>
<span class="cm">	 *  (slot/handle 0 is reserved!)</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">cb_idx</span><span class="p">;</span> <span class="n">cb_idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MptCallbacks</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">MptCallbacks</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbfunc</span><span class="p">;</span>
			<span class="n">MptDriverClass</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">dclass</span><span class="p">;</span>
			<span class="n">MptEvHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">last_drv_idx</span> <span class="o">=</span> <span class="n">cb_idx</span><span class="p">;</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">MptCallbacksName</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">],</span> <span class="n">func_name</span><span class="p">,</span>
				<span class="n">MPT_MAX_CALLBACKNAME_LEN</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">last_drv_idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_deregister - Deregister a protocol drivers resources.</span>
<span class="cm"> *	@cb_idx: previously registered callback handle</span>
<span class="cm"> *</span>
<span class="cm"> *	Each protocol-specific driver should call this routine when its</span>
<span class="cm"> *	module is unloaded.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt_deregister</span><span class="p">(</span><span class="n">u8</span> <span class="n">cb_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cb_idx</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cb_idx</span> <span class="o">&lt;</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">MptCallbacks</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">MptDriverClass</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPTUNKNOWN_DRIVER</span><span class="p">;</span>
		<span class="n">MptEvHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">last_drv_idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_event_register - Register protocol-specific event callback handler.</span>
<span class="cm"> *	@cb_idx: previously registered (via mpt_register) callback handle</span>
<span class="cm"> *	@ev_cbfunc: callback function</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine can be called by one or more protocol-specific drivers</span>
<span class="cm"> *	if/when they choose to be notified of MPT events.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt_event_register</span><span class="p">(</span><span class="n">u8</span> <span class="n">cb_idx</span><span class="p">,</span> <span class="n">MPT_EVHANDLER</span> <span class="n">ev_cbfunc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb_idx</span> <span class="o">||</span> <span class="n">cb_idx</span> <span class="o">&gt;=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">MptEvHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev_cbfunc</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_event_deregister - Deregister protocol-specific event callback handler</span>
<span class="cm"> *	@cb_idx: previously registered callback handle</span>
<span class="cm"> *</span>
<span class="cm"> *	Each protocol-specific driver should call this routine</span>
<span class="cm"> *	when it does not (or can no longer) handle events,</span>
<span class="cm"> *	or when its module is unloaded.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt_event_deregister</span><span class="p">(</span><span class="n">u8</span> <span class="n">cb_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb_idx</span> <span class="o">||</span> <span class="n">cb_idx</span> <span class="o">&gt;=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">MptEvHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_reset_register - Register protocol-specific IOC reset handler.</span>
<span class="cm"> *	@cb_idx: previously registered (via mpt_register) callback handle</span>
<span class="cm"> *	@reset_func: reset function</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine can be called by one or more protocol-specific drivers</span>
<span class="cm"> *	if/when they choose to be notified of IOC resets.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt_reset_register</span><span class="p">(</span><span class="n">u8</span> <span class="n">cb_idx</span><span class="p">,</span> <span class="n">MPT_RESETHANDLER</span> <span class="n">reset_func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb_idx</span> <span class="o">||</span> <span class="n">cb_idx</span> <span class="o">&gt;=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">MptResetHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">reset_func</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_reset_deregister - Deregister protocol-specific IOC reset handler.</span>
<span class="cm"> *	@cb_idx: previously registered callback handle</span>
<span class="cm"> *</span>
<span class="cm"> *	Each protocol-specific driver should call this routine</span>
<span class="cm"> *	when it does not (or can no longer) handle IOC reset handling,</span>
<span class="cm"> *	or when its module is unloaded.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt_reset_deregister</span><span class="p">(</span><span class="n">u8</span> <span class="n">cb_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb_idx</span> <span class="o">||</span> <span class="n">cb_idx</span> <span class="o">&gt;=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">MptResetHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_device_driver_register - Register device driver hooks</span>
<span class="cm"> *	@dd_cbfunc: driver callbacks struct</span>
<span class="cm"> *	@cb_idx: MPT protocol driver index</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt_device_driver_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpt_pci_driver</span> <span class="o">*</span> <span class="n">dd_cbfunc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cb_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb_idx</span> <span class="o">||</span> <span class="n">cb_idx</span> <span class="o">&gt;=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">MptDeviceDriverHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd_cbfunc</span><span class="p">;</span>

	<span class="cm">/* call per pci device probe entry point */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">?</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">id_table</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd_cbfunc</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">)</span>
			<span class="n">dd_cbfunc</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	 <span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_device_driver_deregister - DeRegister device driver hooks</span>
<span class="cm"> *	@cb_idx: MPT protocol driver index</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt_device_driver_deregister</span><span class="p">(</span><span class="n">u8</span> <span class="n">cb_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpt_pci_driver</span> <span class="o">*</span><span class="n">dd_cbfunc</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb_idx</span> <span class="o">||</span> <span class="n">cb_idx</span> <span class="o">&gt;=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dd_cbfunc</span> <span class="o">=</span> <span class="n">MptDeviceDriverHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">];</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd_cbfunc</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span>
			<span class="n">dd_cbfunc</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">MptDeviceDriverHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_get_msg_frame - Obtain an MPT request frame from the pool</span>
<span class="cm"> *	@cb_idx: Handle of registered MPT protocol driver</span>
<span class="cm"> *	@ioc: Pointer to MPT adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Obtain an MPT request frame from the pool (of 1024) that are</span>
<span class="cm"> *	allocated per MPT adapter.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns pointer to a MPT request frame or %NULL if none are available</span>
<span class="cm"> *	or IOC is not active.</span>
<span class="cm"> */</span>
<span class="n">MPT_FRAME_HDR</span><span class="o">*</span>
<span class="nf">mpt_get_msg_frame</span><span class="p">(</span><span class="n">u8</span> <span class="n">cb_idx</span><span class="p">,</span> <span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span>	 <span class="n">req_idx</span><span class="p">;</span>	<span class="cm">/* Request index */</span>

	<span class="cm">/* validate handle and ioc identifier */</span>

<span class="cp">#ifdef MFCNT</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;IOC Not Active! mpt_get_msg_frame &quot;</span>
		    <span class="s">&quot;returning NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* If interrupts are not attached, do not return a request frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">req_offset</span><span class="p">;</span>

		<span class="n">mf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQ</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span><span class="p">,</span>
				<span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">linkage</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">linkage</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">linkage</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">cb_idx</span><span class="p">;</span>	<span class="cm">/* byte */</span>
		<span class="n">req_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames</span><span class="p">;</span>
								<span class="cm">/* u16! */</span>
		<span class="n">req_idx</span> <span class="o">=</span> <span class="n">req_offset</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">;</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">req_idx</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">req_idx</span><span class="p">);</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">rsvd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Default, will be changed if necessary in SG generation */</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">RequestNB</span><span class="p">[</span><span class="n">req_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">NB_for_64_byte_frame</span><span class="p">;</span>
<span class="cp">#ifdef MFCNT</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mfcnt</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">mf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="cp">#ifdef MFCNT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;IOC Active. No free Msg Frames! &quot;</span>
		    <span class="s">&quot;Count 0x%x Max 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mfcnt</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">);</span>
	<span class="n">mfcounter</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mfcounter</span> <span class="o">==</span> <span class="n">PRINT_MF_COUNT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;MF Count 0x%x Max 0x%x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mfcnt</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">dmfprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;mpt_get_msg_frame(%d,%d), got mf=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cb_idx</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">mf</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">mf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_put_msg_frame - Send a protocol-specific MPT request frame to an IOC</span>
<span class="cm"> *	@cb_idx: Handle of registered MPT protocol driver</span>
<span class="cm"> *	@ioc: Pointer to MPT adapter structure</span>
<span class="cm"> *	@mf: Pointer to MPT request frame</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine posts an MPT request frame to the request post FIFO of a</span>
<span class="cm"> *	specific MPT adapter.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt_put_msg_frame</span><span class="p">(</span><span class="n">u8</span> <span class="n">cb_idx</span><span class="p">,</span> <span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mf_dma_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">req_offset</span><span class="p">;</span>
	<span class="n">u16</span>	 <span class="n">req_idx</span><span class="p">;</span>	<span class="cm">/* Request index */</span>

	<span class="cm">/* ensure values are reset properly! */</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">cb_idx</span><span class="p">;</span>		<span class="cm">/* byte */</span>
	<span class="n">req_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames</span><span class="p">;</span>
								<span class="cm">/* u16! */</span>
	<span class="n">req_idx</span> <span class="o">=</span> <span class="n">req_offset</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">req_idx</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">req_idx</span><span class="p">);</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">rsvd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBG_DUMP_PUT_MSG_FRAME</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">);</span>

	<span class="n">mf_dma_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames_low_dma</span> <span class="o">+</span> <span class="n">req_offset</span><span class="p">)</span> <span class="o">|</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">RequestNB</span><span class="p">[</span><span class="n">req_idx</span><span class="p">];</span>
	<span class="n">dsgprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;mf_dma_addr=%x req_idx=%d &quot;</span>
	    <span class="s">&quot;RequestNB=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mf_dma_addr</span><span class="p">,</span> <span class="n">req_idx</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">RequestNB</span><span class="p">[</span><span class="n">req_idx</span><span class="p">]));</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">RequestFifo</span><span class="p">,</span> <span class="n">mf_dma_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mpt_put_msg_frame_hi_pri - Send a hi-pri protocol-specific MPT request frame</span>
<span class="cm"> *	@cb_idx: Handle of registered MPT protocol driver</span>
<span class="cm"> *	@ioc: Pointer to MPT adapter structure</span>
<span class="cm"> *	@mf: Pointer to MPT request frame</span>
<span class="cm"> *</span>
<span class="cm"> *	Send a protocol-specific MPT request frame to an IOC using</span>
<span class="cm"> *	hi-priority request queue.</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine posts an MPT request frame to the request post FIFO of a</span>
<span class="cm"> *	specific MPT adapter.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">mpt_put_msg_frame_hi_pri</span><span class="p">(</span><span class="n">u8</span> <span class="n">cb_idx</span><span class="p">,</span> <span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mf_dma_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">req_offset</span><span class="p">;</span>
	<span class="n">u16</span>	 <span class="n">req_idx</span><span class="p">;</span>	<span class="cm">/* Request index */</span>

	<span class="cm">/* ensure values are reset properly! */</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">cb_idx</span><span class="p">;</span>
	<span class="n">req_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames</span><span class="p">;</span>
	<span class="n">req_idx</span> <span class="o">=</span> <span class="n">req_offset</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">req_idx</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">req_idx</span><span class="p">);</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">rsvd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBG_DUMP_PUT_MSG_FRAME</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">);</span>

	<span class="n">mf_dma_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames_low_dma</span> <span class="o">+</span> <span class="n">req_offset</span><span class="p">);</span>
	<span class="n">dsgprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;mf_dma_addr=%x req_idx=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mf_dma_addr</span><span class="p">,</span> <span class="n">req_idx</span><span class="p">));</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">RequestHiPriFifo</span><span class="p">,</span> <span class="n">mf_dma_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_free_msg_frame - Place MPT request frame back on FreeQ.</span>
<span class="cm"> *	@ioc: Pointer to MPT adapter structure</span>
<span class="cm"> *	@mf: Pointer to MPT request frame</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine places a MPT request frame back on the MPT adapter&#39;s</span>
<span class="cm"> *	FreeQ.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt_free_msg_frame</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*  Put Request back on FreeQ!  */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">linkage</span><span class="p">.</span><span class="n">arg1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xdeadbeaf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="cm">/* signature to know if this mf is freed */</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">linkage</span><span class="p">.</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xdeadbeaf</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">linkage</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQ</span><span class="p">);</span>
<span class="cp">#ifdef MFCNT</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mfcnt</span><span class="o">--</span><span class="p">;</span>
<span class="cp">#endif</span>
 <span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_add_sge - Place a simple 32 bit SGE at address pAddr.</span>
<span class="cm"> *	@pAddr: virtual address for SGE</span>
<span class="cm"> *	@flagslength: SGE flags and data transfer length</span>
<span class="cm"> *	@dma_addr: Physical address</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine places a MPT request frame back on the MPT adapter&#39;s</span>
<span class="cm"> *	FreeQ.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_add_sge</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pAddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flagslength</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SGESimple32_t</span> <span class="o">*</span><span class="n">pSge</span> <span class="o">=</span> <span class="p">(</span><span class="n">SGESimple32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pAddr</span><span class="p">;</span>
	<span class="n">pSge</span><span class="o">-&gt;</span><span class="n">FlagsLength</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flagslength</span><span class="p">);</span>
	<span class="n">pSge</span><span class="o">-&gt;</span><span class="n">Address</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mpt_add_sge_64bit - Place a simple 64 bit SGE at address pAddr.</span>
<span class="cm"> *	@pAddr: virtual address for SGE</span>
<span class="cm"> *	@flagslength: SGE flags and data transfer length</span>
<span class="cm"> *	@dma_addr: Physical address</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine places a MPT request frame back on the MPT adapter&#39;s</span>
<span class="cm"> *	FreeQ.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_add_sge_64bit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pAddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flagslength</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SGESimple64_t</span> <span class="o">*</span><span class="n">pSge</span> <span class="o">=</span> <span class="p">(</span><span class="n">SGESimple64_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pAddr</span><span class="p">;</span>
	<span class="n">pSge</span><span class="o">-&gt;</span><span class="n">Address</span><span class="p">.</span><span class="n">Low</span> <span class="o">=</span> <span class="n">cpu_to_le32</span>
			<span class="p">(</span><span class="n">lower_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">));</span>
	<span class="n">pSge</span><span class="o">-&gt;</span><span class="n">Address</span><span class="p">.</span><span class="n">High</span> <span class="o">=</span> <span class="n">cpu_to_le32</span>
			<span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">));</span>
	<span class="n">pSge</span><span class="o">-&gt;</span><span class="n">FlagsLength</span> <span class="o">=</span> <span class="n">cpu_to_le32</span>
			<span class="p">((</span><span class="n">flagslength</span> <span class="o">|</span> <span class="n">MPT_SGE_FLAGS_64_BIT_ADDRESSING</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mpt_add_sge_64bit_1078 - Place a simple 64 bit SGE at address pAddr (1078 workaround).</span>
<span class="cm"> *	@pAddr: virtual address for SGE</span>
<span class="cm"> *	@flagslength: SGE flags and data transfer length</span>
<span class="cm"> *	@dma_addr: Physical address</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine places a MPT request frame back on the MPT adapter&#39;s</span>
<span class="cm"> *	FreeQ.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_add_sge_64bit_1078</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pAddr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flagslength</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SGESimple64_t</span> <span class="o">*</span><span class="n">pSge</span> <span class="o">=</span> <span class="p">(</span><span class="n">SGESimple64_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pAddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">pSge</span><span class="o">-&gt;</span><span class="n">Address</span><span class="p">.</span><span class="n">Low</span> <span class="o">=</span> <span class="n">cpu_to_le32</span>
			<span class="p">(</span><span class="n">lower_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">));</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * 1078 errata workaround for the 36GB limitation</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((((</span><span class="n">u64</span><span class="p">)</span><span class="n">dma_addr</span> <span class="o">+</span> <span class="n">MPI_SGE_LENGTH</span><span class="p">(</span><span class="n">flagslength</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span>  <span class="o">==</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flagslength</span> <span class="o">|=</span>
		    <span class="n">MPI_SGE_SET_FLAGS</span><span class="p">(</span><span class="n">MPI_SGE_FLAGS_LOCAL_ADDRESS</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpt_debug_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG_36GB_MEM</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;1078 P0M2 addressing for &quot;</span>
			    <span class="s">&quot;addr = 0x%llx len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">dma_addr</span><span class="p">,</span>
			    <span class="n">MPI_SGE_LENGTH</span><span class="p">(</span><span class="n">flagslength</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">pSge</span><span class="o">-&gt;</span><span class="n">Address</span><span class="p">.</span><span class="n">High</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">pSge</span><span class="o">-&gt;</span><span class="n">FlagsLength</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
		<span class="p">(</span><span class="n">flagslength</span> <span class="o">|</span> <span class="n">MPT_SGE_FLAGS_64_BIT_ADDRESSING</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_add_chain - Place a 32 bit chain SGE at address pAddr.</span>
<span class="cm"> *	@pAddr: virtual address for SGE</span>
<span class="cm"> *	@next: nextChainOffset value (u32&#39;s)</span>
<span class="cm"> *	@length: length of next SGL segment</span>
<span class="cm"> *	@dma_addr: Physical address</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_add_chain</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pAddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">next</span><span class="p">,</span> <span class="n">u16</span> <span class="n">length</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">)</span>
<span class="p">{</span>
		<span class="n">SGEChain32_t</span> <span class="o">*</span><span class="n">pChain</span> <span class="o">=</span> <span class="p">(</span><span class="n">SGEChain32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pAddr</span><span class="p">;</span>
		<span class="n">pChain</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
		<span class="n">pChain</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">MPI_SGE_FLAGS_CHAIN_ELEMENT</span><span class="p">;</span>
		<span class="n">pChain</span><span class="o">-&gt;</span><span class="n">NextChainOffset</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="n">pChain</span><span class="o">-&gt;</span><span class="n">Address</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_add_chain_64bit - Place a 64 bit chain SGE at address pAddr.</span>
<span class="cm"> *	@pAddr: virtual address for SGE</span>
<span class="cm"> *	@next: nextChainOffset value (u32&#39;s)</span>
<span class="cm"> *	@length: length of next SGL segment</span>
<span class="cm"> *	@dma_addr: Physical address</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_add_chain_64bit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pAddr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">next</span><span class="p">,</span> <span class="n">u16</span> <span class="n">length</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">)</span>
<span class="p">{</span>
		<span class="n">SGEChain64_t</span> <span class="o">*</span><span class="n">pChain</span> <span class="o">=</span> <span class="p">(</span><span class="n">SGEChain64_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pAddr</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">dma_addr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>

		<span class="n">pChain</span><span class="o">-&gt;</span><span class="n">Length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
		<span class="n">pChain</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPI_SGE_FLAGS_CHAIN_ELEMENT</span> <span class="o">|</span>
				 <span class="n">MPI_SGE_FLAGS_64_BIT_ADDRESSING</span><span class="p">);</span>

		<span class="n">pChain</span><span class="o">-&gt;</span><span class="n">NextChainOffset</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>

		<span class="n">pChain</span><span class="o">-&gt;</span><span class="n">Address</span><span class="p">.</span><span class="n">Low</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">));</span>
		<span class="n">pChain</span><span class="o">-&gt;</span><span class="n">Address</span><span class="p">.</span><span class="n">High</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_send_handshake_request - Send MPT request via doorbell handshake method.</span>
<span class="cm"> *	@cb_idx: Handle of registered MPT protocol driver</span>
<span class="cm"> *	@ioc: Pointer to MPT adapter structure</span>
<span class="cm"> *	@reqBytes: Size of the request in bytes</span>
<span class="cm"> *	@req: Pointer to MPT request frame</span>
<span class="cm"> *	@sleepFlag: Use schedule if CAN_SLEEP else use udelay.</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine is used exclusively to send MptScsiTaskMgmt</span>
<span class="cm"> *	requests since they are required to be sent via doorbell handshake.</span>
<span class="cm"> *</span>
<span class="cm"> *	NOTE: It is the callers responsibility to byte-swap fields in the</span>
<span class="cm"> *	request which are greater than 1 byte in size.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt_send_handshake_request</span><span class="p">(</span><span class="n">u8</span> <span class="n">cb_idx</span><span class="p">,</span> <span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reqBytes</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">req_as_bytes</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">ii</span><span class="p">;</span>

	<span class="cm">/* State is known to be good upon entering</span>
<span class="cm">	 * this function so issue the bus reset</span>
<span class="cm">	 * request.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Emulate what mpt_put_msg_frame() does /wrt to sanity</span>
<span class="cm">	 * setting cb_idx/req_idx.  But ONLY if this request</span>
<span class="cm">	 * is in proper (pre-alloc&#39;d) request buffer range...</span>
<span class="cm">	 */</span>
	<span class="n">ii</span> <span class="o">=</span> <span class="n">MFPTR_2_MPT_INDEX</span><span class="p">(</span><span class="n">ioc</span><span class="p">,(</span><span class="n">MPT_FRAME_HDR</span><span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reqBytes</span> <span class="o">&gt;=</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="n">ii</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPT_FRAME_HDR</span><span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="p">;</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">req_idx</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ii</span><span class="p">);</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">hwhdr</span><span class="p">.</span><span class="n">msgctxu</span><span class="p">.</span><span class="n">fld</span><span class="p">.</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">cb_idx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure there are no doorbells */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">,</span>
			<span class="p">((</span><span class="n">MPI_FUNCTION_HANDSHAKE</span><span class="o">&lt;&lt;</span><span class="n">MPI_DOORBELL_FUNCTION_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">((</span><span class="n">reqBytes</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="n">MPI_DOORBELL_ADD_DWORDS_SHIFT</span><span class="p">)));</span>

	<span class="cm">/* Wait for IOC doorbell int */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ii</span> <span class="o">=</span> <span class="n">WaitForDoorbellInt</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ii</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read doorbell and check for active bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_DOORBELL_ACTIVE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>

	<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;mpt_send_handshake_request start, WaitCnt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ii</span><span class="p">));</span>

	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">WaitForDoorbellAck</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send request via doorbell handshake */</span>
	<span class="n">req_as_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">req</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">reqBytes</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">word</span><span class="p">;</span>

		<span class="n">word</span> <span class="o">=</span> <span class="p">((</span><span class="n">req_as_bytes</span><span class="p">[(</span><span class="n">ii</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">req_as_bytes</span><span class="p">[(</span><span class="n">ii</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">req_as_bytes</span><span class="p">[(</span><span class="n">ii</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">req_as_bytes</span><span class="p">[(</span><span class="n">ii</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
		<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">WaitForDoorbellAck</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">WaitForDoorbellInt</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* Make sure there are no doorbells */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> * mpt_host_page_access_control - control the IOC&#39;s Host Page Buffer access</span>
<span class="cm"> * @ioc: Pointer to MPT adapter structure</span>
<span class="cm"> * @access_control_value: define bits below</span>
<span class="cm"> * @sleepFlag: Specifies whether the process can sleep</span>
<span class="cm"> *</span>
<span class="cm"> * Provides mechanism for the host driver to control the IOC&#39;s</span>
<span class="cm"> * Host Page Buffer access.</span>
<span class="cm"> *</span>
<span class="cm"> * Access Control Value - bits[15:12]</span>
<span class="cm"> * 0h Reserved</span>
<span class="cm"> * 1h Enable Access { MPI_DB_HPBAC_ENABLE_ACCESS }</span>
<span class="cm"> * 2h Disable Access { MPI_DB_HPBAC_DISABLE_ACCESS }</span>
<span class="cm"> * 3h Free Buffer { MPI_DB_HPBAC_FREE_BUFFER }</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpt_host_page_access_control</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">access_control_value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	 <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* return if in use */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">)</span>
	    <span class="o">&amp;</span> <span class="n">MPI_DOORBELL_ACTIVE</span><span class="p">)</span>
	    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">,</span>
		<span class="p">((</span><span class="n">MPI_FUNCTION_HOST_PAGEBUF_ACCESS_CONTROL</span>
		 <span class="o">&lt;&lt;</span><span class="n">MPI_DOORBELL_FUNCTION_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		 <span class="p">(</span><span class="n">access_control_value</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)));</span>

	<span class="cm">/* Wait for IOC to clear Doorbell Status bit */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">WaitForDoorbellAck</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_host_page_alloc - allocate system memory for the fw</span>
<span class="cm"> *	@ioc: Pointer to pointer to IOC adapter</span>
<span class="cm"> *	@ioc_init: Pointer to ioc init config page</span>
<span class="cm"> *</span>
<span class="cm"> *	If we already allocated memory in past, then resend the same pointer.</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpt_host_page_alloc</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">pIOCInit_t</span> <span class="n">ioc_init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">psge</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">flags_length</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">host_page_buffer_sz</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">host_page_buffer_sz</span> <span class="o">=</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">HostPageBufferSGE</span><span class="p">.</span><span class="n">FlagsLength</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">host_page_buffer_sz</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* fw doesn&#39;t need any host buffers */</span>

		<span class="cm">/* spin till we get enough memory */</span>
		<span class="k">while</span><span class="p">(</span><span class="n">host_page_buffer_sz</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span><span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			    <span class="n">host_page_buffer_sz</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer_dma</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
				    <span class="s">&quot;host_page_buffer @ %p, dma @ %x, sz=%d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer_dma</span><span class="p">,</span>
				    <span class="n">host_page_buffer_sz</span><span class="p">));</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span> <span class="o">+=</span> <span class="n">host_page_buffer_sz</span><span class="p">;</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer_sz</span> <span class="o">=</span> <span class="n">host_page_buffer_sz</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">host_page_buffer_sz</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
		    <span class="s">&quot;Failed to alloc memory for host_page_buffer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">999</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psge</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ioc_init</span><span class="o">-&gt;</span><span class="n">HostPageBufferSGE</span><span class="p">;</span>
	<span class="n">flags_length</span> <span class="o">=</span> <span class="n">MPI_SGE_FLAGS_SIMPLE_ELEMENT</span> <span class="o">|</span>
	    <span class="n">MPI_SGE_FLAGS_SYSTEM_ADDRESS</span> <span class="o">|</span>
	    <span class="n">MPI_SGE_FLAGS_HOST_TO_IOC</span> <span class="o">|</span>
	    <span class="n">MPI_SGE_FLAGS_END_OF_BUFFER</span><span class="p">;</span>
	<span class="n">flags_length</span> <span class="o">=</span> <span class="n">flags_length</span> <span class="o">&lt;&lt;</span> <span class="n">MPI_SGE_FLAGS_SHIFT</span><span class="p">;</span>
	<span class="n">flags_length</span> <span class="o">|=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer_sz</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">(</span><span class="n">psge</span><span class="p">,</span> <span class="n">flags_length</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer_dma</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">HostPageBufferSGE</span> <span class="o">=</span> <span class="n">ioc_init</span><span class="o">-&gt;</span><span class="n">HostPageBufferSGE</span><span class="p">;</span>

<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_verify_adapter - Given IOC identifier, set pointer to its adapter structure.</span>
<span class="cm"> *	@iocid: IOC unique identifier (integer)</span>
<span class="cm"> *	@iocpp: Pointer to pointer to IOC adapter</span>
<span class="cm"> *</span>
<span class="cm"> *	Given a unique IOC identifier, set pointer to the associated MPT</span>
<span class="cm"> *	adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns iocid and sets iocpp if iocid is found.</span>
<span class="cm"> *	Returns -1 if iocid is not found.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt_verify_adapter</span><span class="p">(</span><span class="kt">int</span> <span class="n">iocid</span><span class="p">,</span> <span class="n">MPT_ADAPTER</span> <span class="o">**</span><span class="n">iocpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ioc_list</span><span class="p">,</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">iocid</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">iocpp</span> <span class="o">=</span><span class="n">ioc</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">iocid</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">iocpp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mpt_get_product_name - returns product string</span>
<span class="cm"> *	@vendor: pci vendor id</span>
<span class="cm"> *	@device: pci device id</span>
<span class="cm"> *	@revision: pci revision id</span>
<span class="cm"> *	@prod_name: string returned</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns product string displayed when driver loads,</span>
<span class="cm"> *	in /proc/mpt/summary and /sysfs/class/scsi_host/host&lt;X&gt;/version_product</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_get_product_name</span><span class="p">(</span><span class="n">u16</span> <span class="n">vendor</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device</span><span class="p">,</span> <span class="n">u8</span> <span class="n">revision</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prod_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">product_str</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_BROCADE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC949E</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">revision</span><span class="p">)</span>
			<span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x00</span>:
				<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;BRE040 A0&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x01</span>:
				<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;BRE040 A1&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;BRE040&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">device</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC909</span>:
		<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSIFC909 B1&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC919</span>:
		<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSIFC919 B0&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC929</span>:
		<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSIFC929 B0&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC919X</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSIFC919X A0&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSIFC919XL A1&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC929X</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSIFC929X A0&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSIFC929XL A1&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC939X</span>:
		<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSIFC939X A1&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC949X</span>:
		<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSIFC949X A1&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC949E</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">revision</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSIFC949E A0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSIFC949E A1&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSIFC949E&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVID_53C1030</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">revision</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSI53C1030 A0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSI53C1030 B0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSI53C1030 B1&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x07</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSI53C1030 B2&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSI53C1030 C0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x80</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSI53C1030T A0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x83</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSI53C1030T A2&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x87</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSI53C1030T A3&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xc1</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSI53C1020A A1&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSI53C1030&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVID_1030_53C1035</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">revision</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x03</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSI53C1035 A2&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x04</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSI53C1035 B0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSI53C1035&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1064</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">revision</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1064 A1&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1064 A2&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1064 A3&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1064 A4&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1064&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1064E</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">revision</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1064E A0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1064E B0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1064E B1&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x04</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1064E B2&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1064E B3&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1064E&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1068</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">revision</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1068 A0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1068 B0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1068 B1&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1068&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1068E</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">revision</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1068E A0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1068E B0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1068E B1&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x04</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1068E B2&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1068E B3&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1068E&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1078</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">revision</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1078 A0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1078 B0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1078 C0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1078 C1&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x04</span>:
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1078 C2&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">product_str</span> <span class="o">=</span> <span class="s">&quot;LSISAS1078&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">product_str</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">prod_name</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">product_str</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mpt_mapresources - map in memory mapped io</span>
<span class="cm"> *	@ioc: Pointer to pointer to IOC adapter</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpt_mapresources</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>		<span class="n">__iomem</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">ii</span><span class="p">;</span>
	<span class="n">resource_size_t</span>	 <span class="n">mem_phys</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span>		 <span class="n">msize</span><span class="p">;</span>
	<span class="n">u32</span>		 <span class="n">psize</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bars</span> <span class="o">=</span> <span class="n">pci_select_bars</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device_mem</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;pci_enable_device_mem() &quot;</span>
		    <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_request_selected_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">,</span> <span class="s">&quot;mpt&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;pci_request_selected_regions() with &quot;</span>
		    <span class="s">&quot;MEM failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">required_mask</span> <span class="o">=</span> <span class="n">dma_get_required_mask</span>
		    <span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">required_mask</span> <span class="o">&gt;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
						 <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
			<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span>
				<span class="s">&quot;: 64 BIT PCI BUS DMA ADDRESSING SUPPORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
						<span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
			<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span>
				<span class="s">&quot;: 32 BIT PCI BUS DMA ADDRESSING SUPPORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;no suitable DMA mask for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
			<span class="n">pci_release_selected_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
						<span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
			<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span>
				<span class="s">&quot;: 32 BIT PCI BUS DMA ADDRESSING SUPPORTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;no suitable DMA mask for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
			<span class="n">pci_release_selected_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mem_phys</span> <span class="o">=</span> <span class="n">msize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">psize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">DEVICE_COUNT_RESOURCE</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ii</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_SPACE_IO</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psize</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* Get I/O space! */</span>
			<span class="n">port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
			<span class="n">psize</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msize</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* Get memmap */</span>
			<span class="n">mem_phys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
			<span class="n">msize</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mem_size</span> <span class="o">=</span> <span class="n">msize</span><span class="p">;</span>

	<span class="n">mem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* Get logical ptr for PciMem0 space */</span>
	<span class="cm">/*mem = ioremap(mem_phys, msize);*/</span>
	<span class="n">mem</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_phys</span><span class="p">,</span> <span class="n">msize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;: ERROR - Unable to map adapter&quot;</span>
			<span class="s">&quot; memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">pci_release_selected_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">memmap</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;mem = %p, mem_phys = %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mem_phys</span><span class="p">));</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mem_phys</span> <span class="o">=</span> <span class="n">mem_phys</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="n">SYSIF_REGS</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">mem</span><span class="p">;</span>

	<span class="cm">/* Save Port IO values in case we need to do downloadboot */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pio_mem_phys</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pio_chip</span> <span class="o">=</span> <span class="p">(</span><span class="n">SYSIF_REGS</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_attach - Install a PCI intelligent MPT adapter.</span>
<span class="cm"> *	@pdev: Pointer to pci_dev structure</span>
<span class="cm"> *	@id: PCI device ID information</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine performs all the steps necessary to bring the IOC of</span>
<span class="cm"> *	a MPT adapter to a OPERATIONAL state.  This includes registering</span>
<span class="cm"> *	memory regions, registering the interrupt, and allocating request</span>
<span class="cm"> *	and reply memory pools.</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine also pre-fetches the LAN MAC address of a Fibre Channel</span>
<span class="cm"> *	MPT adapter.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> *</span>
<span class="cm"> *	TODO: Add support for polled controllers</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">cb_idx</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">pcixcmd</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span>	 <span class="n">mpt_ids</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">dent</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">ioc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MPT_ADAPTER</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span> <span class="s">&quot;: ERROR - Insufficient memory to add adapter!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">mpt_ids</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ioc%d&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">MYNAM</span> <span class="s">&quot;: mpt_adapter_install</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * set initial debug level</span>
<span class="cm">	 * (refer to mptdebug.h)</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">debug_level</span> <span class="o">=</span> <span class="n">mpt_debug_level</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_debug_level</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mpt_debug_level=%xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpt_debug_level</span><span class="p">);</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;: mpt_adapter_install</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_mapresources</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setting up proper handlers for scatter gather handling</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">==</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1078</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpt_add_sge_64bit_1078</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpt_add_sge_64bit</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_chain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpt_add_chain_64bit</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sg_addr_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpt_add_sge</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_chain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpt_add_chain</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sg_addr_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">+</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sg_addr_size</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MPT_ADAPTER</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">=</span> <span class="n">MPT_DEFAULT_FRAME_SIZE</span><span class="p">;</span>		<span class="cm">/* avoid div by zero! */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span> <span class="o">=</span> <span class="n">MPT_REPLY_FRAME_SIZE</span><span class="p">;</span>


	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">internal_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>

	<span class="cm">/* Initialize the event logging.</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">eventTypes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* None */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">eventContext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">eventLogSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef MFCNT</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mfcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Initialize SCSI Config Data structure</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SpiCfgData</span><span class="p">));</span>

	<span class="cm">/* Initialize the fc rport list head.</span>
<span class="cm">	 */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_rports</span><span class="p">);</span>

	<span class="cm">/* Find lookup slot. */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>


	<span class="cm">/* Initialize workqueue */</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work</span><span class="p">,</span> <span class="n">mpt_fault_reset_work</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_work_q_name</span><span class="p">,</span> <span class="n">MPT_KOBJ_NAME_LEN</span><span class="p">,</span>
		 <span class="s">&quot;mpt_poll_%d&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_work_q</span> <span class="o">=</span>
		<span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_work_q_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_work_q</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Insufficient memory to add adapter!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">pci_release_selected_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;facts @ %p, pfacts[0] @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

	<span class="n">mpt_get_product_name</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span>
			     <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">prod_name</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC939X</span>:
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC949X</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">errata_flag_1064</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC909</span>:
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC929</span>:
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC919</span>:
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC949E</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">=</span> <span class="n">FC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC929X</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="n">XL_929</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* 929X Chip Fix. Set Split transactions level</span>
<span class="cm">		 	* for PCIX. Set MOST bits to zero.</span>
<span class="cm">		 	*/</span>
			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcixcmd</span><span class="p">);</span>
			<span class="n">pcixcmd</span> <span class="o">&amp;=</span> <span class="mh">0x8F</span><span class="p">;</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="n">pcixcmd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* 929XL Chip Fix. Set MMRBC to 0x08.</span>
<span class="cm">		 	*/</span>
			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcixcmd</span><span class="p">);</span>
			<span class="n">pcixcmd</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="n">pcixcmd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">=</span> <span class="n">FC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVICEID_FC919X</span>:
		<span class="cm">/* 919X Chip Fix. Set Split transactions level</span>
<span class="cm">		 * for PCIX. Set MOST bits to zero.</span>
<span class="cm">		 */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcixcmd</span><span class="p">);</span>
		<span class="n">pcixcmd</span> <span class="o">&amp;=</span> <span class="mh">0x8F</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="n">pcixcmd</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">=</span> <span class="n">FC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVID_53C1030</span>:
		<span class="cm">/* 1030 Chip Fix. Disable Split transactions</span>
<span class="cm">		 * for PCIX. Set MOST bits to zero if Rev &lt; C0( = 8).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="n">C0_1030</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcixcmd</span><span class="p">);</span>
			<span class="n">pcixcmd</span> <span class="o">&amp;=</span> <span class="mh">0x8F</span><span class="p">;</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="n">pcixcmd</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVID_1030_53C1035</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">=</span> <span class="n">SPI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1064</span>:
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1068</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">errata_flag_1064</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">=</span> <span class="n">SAS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1064E</span>:
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1068E</span>:
	<span class="k">case</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1078</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">=</span> <span class="n">SAS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">switch</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">SAS</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msi_enable</span> <span class="o">=</span> <span class="n">mpt_msi_enable_sas</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SPI</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msi_enable</span> <span class="o">=</span> <span class="n">mpt_msi_enable_spi</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FC</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msi_enable</span> <span class="o">=</span> <span class="n">mpt_msi_enable_fc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msi_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_events_off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">errata_flag_1064</span><span class="p">)</span>
		<span class="n">pci_disable_io_access</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">);</span>

	<span class="cm">/* Disable all! */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set IOC ptr in the pcidev&#39;s driver data. */</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>

	<span class="cm">/* Set lookup ptr. */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc_list</span><span class="p">);</span>

	<span class="cm">/* Check for &quot;bound ports&quot; (929, 929X, 1030, 1035) to reduce redundant resets.</span>
<span class="cm">	 */</span>
	<span class="n">mpt_detect_bound_ports</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_q_name</span><span class="p">,</span> <span class="n">MPT_KOBJ_NAME_LEN</span><span class="p">,</span> <span class="s">&quot;mpt/%d&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_q</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_q_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">mpt_do_ioc_recovery</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_HOSTEVENT_IOC_BRINGUP</span><span class="p">,</span>
	    <span class="n">CAN_SLEEP</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;didn&#39;t initialize properly! (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">memmap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span>
			<span class="n">pci_release_selected_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">);</span>

		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_work_q</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_work_q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* call per device driver probe entry point */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cb_idx</span> <span class="o">&lt;</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span> <span class="n">cb_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">MptDeviceDriverHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		  <span class="n">MptDeviceDriverHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">MptDeviceDriverHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Create &quot;/proc/mpt/iocN&quot; subdirectory entry for each MPT adapter.</span>
<span class="cm">	 */</span>
	<span class="n">dent</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mpt_proc_root_dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;info&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">dent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt_iocinfo_proc_fops</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>
		<span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;summary&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">dent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt_summary_proc_fops</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_work_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work</span><span class="p">,</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">MPT_POLLING_INTERVAL</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_detach - Remove a PCI intelligent MPT adapter.</span>
<span class="cm"> *	@pdev: Pointer to pci_dev structure</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">mpt_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> 	<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">pname</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">cb_idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">wq</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop polling ioc for fault condition</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wq</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_work_q</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_work_q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fault_reset_work</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wq</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_q</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fw_event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">wq</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="n">MPT_PROCFS_MPTBASEDIR</span> <span class="s">&quot;/%s/summary&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="n">MPT_PROCFS_MPTBASEDIR</span> <span class="s">&quot;/%s/info&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="n">MPT_PROCFS_MPTBASEDIR</span> <span class="s">&quot;/%s&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* call per device driver remove entry point */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cb_idx</span> <span class="o">&lt;</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span> <span class="n">cb_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">MptDeviceDriverHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		  <span class="n">MptDeviceDriverHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">MptDeviceDriverHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Disable interrupts! */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* Clear any lingering interrupt */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">);</span>

	<span class="n">mpt_adapter_dispose</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm"> * Power Management</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_suspend - Fusion MPT base driver suspend routine.</span>
<span class="cm"> *	@pdev: Pointer to pci_dev structure</span>
<span class="cm"> *	@state: new state to enter</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">device_state</span><span class="p">;</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">device_state</span> <span class="o">=</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;pci-suspend: pdev=0x%p, slot=%s, Entering &quot;</span>
	    <span class="s">&quot;operating state [D%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span>
	    <span class="n">device_state</span><span class="p">);</span>

	<span class="cm">/* put ioc into READY_STATE */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">SendIocReset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
		<span class="s">&quot;pci-suspend:  IOC msg unit reset failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* disable interrupts */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Clear any lingering interrupt */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_irq</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msi_enable</span><span class="p">)</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_release_selected_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">device_state</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_resume - Fusion MPT base driver resume routine.</span>
<span class="cm"> *	@pdev: Pointer to pci_dev structure</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">device_state</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">current_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recovery_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;pci-resume: pdev=0x%p, slot=%s, Previous &quot;</span>
	    <span class="s">&quot;operating state [D%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span>
	    <span class="n">device_state</span><span class="p">);</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mpt_mapresources</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">==</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1078</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpt_add_sge_64bit_1078</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpt_add_sge_64bit</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_chain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpt_add_chain_64bit</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sg_addr_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpt_add_sge</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_chain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpt_add_chain</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sg_addr_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">+</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sg_addr_size</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;pci-resume: ioc-state=0x%x,doorbell=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MPI_IOC_STATE_SHIFT</span><span class="p">),</span>
	    <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Errata workaround for SAS pci express:</span>
<span class="cm">	 * Upon returning to the D0 state, the contents of the doorbell will be</span>
<span class="cm">	 * stale data, and this will incorrectly signal to the host driver that</span>
<span class="cm">	 * the firmware is ready to process mpt commands.   The workaround is</span>
<span class="cm">	 * to issue a diagnostic reset.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span>
	    <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1068E</span> <span class="o">||</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span>
	    <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1064E</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">KickStart</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;pci-resume: Cannot recover</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* bring ioc to operational state */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;Sending mpt_do_ioc_recovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">recovery_state</span> <span class="o">=</span> <span class="n">mpt_do_ioc_recovery</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_HOSTEVENT_IOC_BRINGUP</span><span class="p">,</span>
						 <span class="n">CAN_SLEEP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recovery_state</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;pci-resume: Cannot recover, &quot;</span>
		    <span class="s">&quot;error:[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">recovery_state</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span>
		    <span class="s">&quot;pci-resume: success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpt_signal_reset</span><span class="p">(</span><span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_phase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">MptDriverClass</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">MPTSPI_DRIVER</span> <span class="o">&amp;&amp;</span>
	     <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="n">SPI</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">MptDriverClass</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">MPTFC_DRIVER</span> <span class="o">&amp;&amp;</span>
	     <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="n">FC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">MptDriverClass</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">MPTSAS_DRIVER</span> <span class="o">&amp;&amp;</span>
	     <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="n">SAS</span><span class="p">))</span>
		<span class="cm">/* make sure we only call the relevant reset handler</span>
<span class="cm">		 * for the bus */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">MptResetHandlers</span><span class="p">[</span><span class="n">index</span><span class="p">])(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">reset_phase</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_do_ioc_recovery - Initialize or recover MPT adapter.</span>
<span class="cm"> *	@ioc: Pointer to MPT adapter structure</span>
<span class="cm"> *	@reason: Event word / reason</span>
<span class="cm"> *	@sleepFlag: Use schedule if CAN_SLEEP else use udelay.</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine performs all the steps necessary to bring the IOC</span>
<span class="cm"> *	to a OPERATIONAL state.</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine also pre-fetches the LAN MAC address of a Fibre Channel</span>
<span class="cm"> *	MPT adapter.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		 0 for success</span>
<span class="cm"> *		-1 if failed to get board READY</span>
<span class="cm"> *		-2 if READY but IOCFacts Failed</span>
<span class="cm"> *		-3 if READY but PrimeIOCFifos Failed</span>
<span class="cm"> *		-4 if READY but IOCInit Failed</span>
<span class="cm"> *		-5 if failed to enable_device and/or request_selected_regions</span>
<span class="cm"> *		-6 if failed to upload firmware</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpt_do_ioc_recovery</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reason</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	 <span class="n">hard_reset_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">alt_ioc_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">hard</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">rc</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">ii</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">reset_alt_ioc_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">irq_allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="o">*</span><span class="n">a</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;Initiating %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	    <span class="n">reason</span> <span class="o">==</span> <span class="n">MPT_HOSTEVENT_IOC_BRINGUP</span> <span class="o">?</span> <span class="s">&quot;bringup&quot;</span> <span class="o">:</span> <span class="s">&quot;recovery&quot;</span><span class="p">);</span>

	<span class="cm">/* Disable reply interrupts (also blocks FreeQ) */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">||</span>
		    <span class="n">reason</span> <span class="o">==</span> <span class="n">MPT_HOSTEVENT_IOC_RECOVER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reset_alt_ioc_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* Disable alt-IOC&#39;s reply interrupts</span>
<span class="cm">			 *  (and FreeQ) for a bit</span>
<span class="cm">			 **/</span>
			<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span>
				<span class="mh">0xFFFFFFFF</span><span class="p">);</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hard</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">MPT_HOSTEVENT_IOC_BRINGUP</span><span class="p">)</span>
		<span class="n">hard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hard_reset_done</span> <span class="o">=</span> <span class="n">MakeIocReady</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">hard</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hard_reset_done</span> <span class="o">==</span> <span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;Owned by PEER..skipping!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">reset_alt_ioc_active</span> <span class="o">&amp;&amp;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* (re)Enable alt-IOC! (reply interrupt, FreeQ) */</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span>
				    <span class="s">&quot;alt_ioc reply irq re-enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
				<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">MPI_HIM_DIM</span><span class="p">);</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			    <span class="s">&quot;NOT READY WARNING!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* hard_reset_done = 0 if a soft reset was performed</span>
<span class="cm">	 * and 1 if a hard reset was performed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hard_reset_done</span> <span class="o">&amp;&amp;</span> <span class="n">reset_alt_ioc_active</span> <span class="o">&amp;&amp;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">MakeIocReady</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">alt_ioc_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			    <span class="s">&quot;: alt-ioc Not ready WARNING!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get IOC facts! Allow 5 retries */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">GetIocFacts</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;Retry IocFacts failed rc=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">MPT_HOSTEVENT_IOC_BRINGUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MptDisplayIocCapabilities</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alt_ioc_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">GetIocFacts</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			    <span class="s">&quot;Initial Alt IocFacts failed rc=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
			<span class="cm">/* Retry - alt IOC was initialized once</span>
<span class="cm">			 */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">GetIocFacts</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			    <span class="s">&quot;Retry Alt IocFacts failed rc=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rc</span><span class="p">));</span>
			<span class="n">alt_ioc_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">reset_alt_ioc_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">MPT_HOSTEVENT_IOC_BRINGUP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">MptDisplayIocCapabilities</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">MPT_HOSTEVENT_IOC_BRINGUP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">MPI_IOCFACTS_FLAGS_FW_DOWNLOAD_BOOT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_release_selected_regions</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bars</span> <span class="o">=</span> <span class="n">pci_select_bars</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span> <span class="o">|</span>
		    <span class="n">IORESOURCE_IO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_request_selected_regions</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">,</span>
			<span class="s">&quot;mpt&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Device is reset now. It must have de-asserted the interrupt line</span>
<span class="cm">	 * (if it was asserted) and it should be safe to register for the</span>
<span class="cm">	 * interrupt now.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">MPT_HOSTEVENT_IOC_BRINGUP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msi_enable</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;PCI-MSI enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msi_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mpt_interrupt</span><span class="p">,</span>
			    <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Unable to allocate &quot;</span>
				    <span class="s">&quot;interrupt %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msi_enable</span><span class="p">)</span>
					<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">irq_allocated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_irq</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
			<span class="n">pci_set_master</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>		<span class="cm">/* ?? */</span>
			<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>
			<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span>
			    <span class="s">&quot;installed at interrupt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Prime reply &amp; request queues!</span>
<span class="cm">	 * (mucho alloc&#39;s) Must be done prior to</span>
<span class="cm">	 * init as upper addresses are needed for init.</span>
<span class="cm">	 * If fails, continue with alt-ioc processing</span>
<span class="cm">	 */</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;PrimeIocFifos</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">PrimeIocFifos</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* May need to check/upload firmware &amp; data here!</span>
<span class="cm">	 * If fails, continue with alt-ioc processing</span>
<span class="cm">	 */</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;SendIocInit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">SendIocInit</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>NEW!</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">alt_ioc_ready</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">PrimeIocFifos</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
		    <span class="s">&quot;: alt-ioc (%d) FIFO mgmt alloc WARNING!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">alt_ioc_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">reset_alt_ioc_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alt_ioc_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">SendIocInit</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">alt_ioc_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">reset_alt_ioc_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
				<span class="s">&quot;: alt-ioc: (%d) init failure WARNING!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">MPT_HOSTEVENT_IOC_BRINGUP</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">upload_fw</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			    <span class="s">&quot;firmware upload required!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

			<span class="cm">/* Controller is not operational, cannot do upload</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_do_upload</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span> <span class="o">&amp;&amp;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/*</span>
<span class="cm">						 * Maintain only one pointer to FW memory</span>
<span class="cm">						 * so there will not be two attempt to</span>
<span class="cm">						 * downloadboot onboard dual function</span>
<span class="cm">						 * chips (mpt_adapter_disable,</span>
<span class="cm">						 * mpt_diag_reset)</span>
<span class="cm">						 */</span>
						<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
						    <span class="s">&quot;mpt_upload:  alt_%s has cached_fw=%p </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">));</span>
						<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
					    <span class="s">&quot;firmware upload failure!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*  Enable MPT base driver management of EventNotification</span>
<span class="cm">	 *  and EventAck handling.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">EventState</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span>
			<span class="s">&quot;SendEventNotification</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SendEventNotification</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>	<span class="cm">/* 1=Enable */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span> <span class="o">&amp;&amp;</span> <span class="n">alt_ioc_ready</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">EventState</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SendEventNotification</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable! (reply interrupt) */</span>
		<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">MPI_HIM_DIM</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* alt ioc */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reset_alt_ioc_active</span> <span class="o">&amp;&amp;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* (re)Enable alt-IOC! (reply interrupt) */</span>
			<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;alt-ioc&quot;</span>
				<span class="s">&quot;reply irq re-enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
			<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span>
				<span class="n">MPI_HIM_DIM</span><span class="p">);</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="cm">/*	Add additional &quot;reason&quot; check before call to GetLanConfigPages</span>
<span class="cm">	 *	(combined with GetIoUnitPage2 call).  This prevents a somewhat</span>
<span class="cm">	 *	recursive scenario; GetLanConfigPages times out, timer expired</span>
<span class="cm">	 *	routine calls HardResetHandler, which calls into here again,</span>
<span class="cm">	 *	and we try GetLanConfigPages again...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">MPT_HOSTEVENT_IOC_BRINGUP</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Initialize link list for inactive raid volumes.</span>
<span class="cm">		 */</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list_mutex</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">SAS</span>:
			<span class="cm">/* clear persistency table */</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">IOCExceptions</span> <span class="o">&amp;</span>
			    <span class="n">MPI_IOCFACTS_EXCEPT_PERSISTENT_TABLE_FULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">mptbase_sas_persist_operation</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
				    <span class="n">MPI_SAS_OP_CLEAR_NOT_PRESENT</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Find IM volumes</span>
<span class="cm">			 */</span>
			<span class="n">mpt_findImVolumes</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

			<span class="cm">/* Check, and possibly reset, the coalescing value</span>
<span class="cm">			 */</span>
			<span class="n">mpt_read_ioc_pg_1</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FC</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ProtocolFlags</span> <span class="o">&amp;</span>
				<span class="n">MPI_PORTFACTS_PROTOCOL_LAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">lan_cnfg_page0</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 *  Pre-fetch the ports LAN MAC address!</span>
<span class="cm">				 *  (LANPage1_t stuff)</span>
<span class="cm">				 */</span>
				<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">GetLanConfigPages</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
				<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">lan_cnfg_page1</span><span class="p">.</span><span class="n">HardwareAddressLow</span><span class="p">;</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
					<span class="s">&quot;LanAddr = %02X:%02X:%02X&quot;</span>
					<span class="s">&quot;:%02X:%02X:%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
					<span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SPI</span>:
			<span class="cm">/* Get NVRAM and adapter maximums from SPP 0 and 2</span>
<span class="cm">			 */</span>
			<span class="n">mpt_GetScsiPortSettings</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* Get version and length of SDP 1</span>
<span class="cm">			 */</span>
			<span class="n">mpt_readScsiDevicePageHeaders</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="cm">/* Find IM volumes</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MsgVersion</span> <span class="o">&gt;=</span> <span class="n">MPI_VERSION_01_02</span><span class="p">)</span>
				<span class="n">mpt_findImVolumes</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

			<span class="cm">/* Check, and possibly reset, the coalescing value</span>
<span class="cm">			 */</span>
			<span class="n">mpt_read_ioc_pg_1</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

			<span class="n">mpt_read_ioc_pg_4</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">GetIoUnitPage2</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="n">mpt_get_manufacturing_pg_0</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">irq_allocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_irq</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msi_enable</span><span class="p">)</span>
			<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_detect_bound_ports - Search for matching PCI bus/dev_function</span>
<span class="cm"> *	@ioc: Pointer to MPT adapter structure</span>
<span class="cm"> *	@pdev: Pointer to (struct pci_dev) structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Search for PCI bus/dev_function which matches</span>
<span class="cm"> *	PCI bus/dev_function (+/-1) for newly discovered 929,</span>
<span class="cm"> *	929X, 1030 or 1035.</span>
<span class="cm"> *</span>
<span class="cm"> *	If match on PCI dev_function +/-1 is found, bind the two MPT adapters</span>
<span class="cm"> *	using alt_ioc pointer fields in their %MPT_ADAPTER structures.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_detect_bound_ports</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">peer</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc_srch</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;PCI device %s devfn=%x/%x,&quot;</span>
	    <span class="s">&quot; searching for devfn match on %x or %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">,</span> <span class="n">func</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">func</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>

	<span class="n">peer</span> <span class="o">=</span> <span class="n">pci_get_slot</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span><span class="n">func</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">peer</span> <span class="o">=</span> <span class="n">pci_get_slot</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span><span class="n">func</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peer</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ioc_srch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">_pcidev</span> <span class="o">=</span> <span class="n">ioc_srch</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_pcidev</span> <span class="o">==</span> <span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Paranoia checks */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
				    <span class="s">&quot;Oops, already bound (%s &lt;==&gt; %s)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioc_srch</span><span class="o">-&gt;</span><span class="n">alt_ioc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
				    <span class="s">&quot;Oops, already bound (%s &lt;==&gt; %s)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ioc_srch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc_srch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				    <span class="n">ioc_srch</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
				<span class="s">&quot;FOUND! binding %s &lt;==&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc_srch</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
			<span class="n">ioc_srch</span><span class="o">-&gt;</span><span class="n">alt_ioc</span> <span class="o">=</span> <span class="n">ioc</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span> <span class="o">=</span> <span class="n">ioc_srch</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">peer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_adapter_disable - Disable misbehaving MPT adapter.</span>
<span class="cm"> *	@ioc: Pointer to MPT adapter structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_adapter_disable</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			<span class="s">&quot;%s: Pushing FW onto adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">mpt_downloadboot</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="p">(</span><span class="n">MpiFwHeader_t</span> <span class="o">*</span><span class="p">)</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			    <span class="s">&quot;: firmware downloadboot failure (%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Put the controller into ready state (if its not already)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MPI_IOC_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SendIocReset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET</span><span class="p">,</span>
		    <span class="n">CAN_SLEEP</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MPI_IOC_STATE_READY</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s:  IOC msg unit &quot;</span>
				    <span class="s">&quot;reset failed to put ioc in ready state!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;%s:  IOC msg unit reset &quot;</span>
			    <span class="s">&quot;failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="cm">/* Disable adapter interrupts! */</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Clear any lingering interrupt */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_sz</span><span class="p">;</span>
		<span class="n">dexitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;free  @ %p, sz=%d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_sz</span><span class="p">));</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_dma</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_frames</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span> <span class="o">-=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span> <span class="o">*</span> <span class="n">MPT_SENSE_BUFFER_ALLOC</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool_dma</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span> <span class="o">-=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">MPTCTL_EVENT_LOG_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MPT_IOCTL_EVENTS</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span> <span class="o">-=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpt_free_fw_memory</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">nvram</span><span class="p">);</span>
	<span class="n">mpt_inactive_raid_list_free</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">nvram</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">pIocPg4</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">IocPg4Sz</span><span class="p">;</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">pIocPg4</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">IocPg4_dma</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">pIocPg4</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span> <span class="o">-=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ReqToChain</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ReqToChain</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">RequestNB</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ReqToChain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainToChain</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainToChain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">mpt_host_page_access_control</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">MPI_DB_HPBAC_FREE_BUFFER</span><span class="p">,</span> <span class="n">NO_SLEEP</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			   <span class="s">&quot;: %s: host page buffers free failed (%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dexitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			<span class="s">&quot;HostPageBuffer free  @ %p, sz=%d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer_sz</span><span class="p">));</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer_sz</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer_dma</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span> <span class="o">-=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">HostPageBuffer_sz</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_adapter_dispose - Free all resources associated with an MPT adapter</span>
<span class="cm"> *	@ioc: Pointer to MPT adapter structure</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine unregisters h/w resources and frees all alloc&#39;d memory</span>
<span class="cm"> *	associated with a MPT adapter structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_adapter_dispose</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sz_first</span><span class="p">,</span> <span class="n">sz_last</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sz_first</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span><span class="p">;</span>

	<span class="n">mpt_adapter_disable</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_irq</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">msi_enable</span><span class="p">)</span>
			<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">memmap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">memmap</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">memmap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="n">pci_release_selected_regions</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bars</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_MTRR) &amp;&amp; 0</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mtrr_reg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mtrr_del</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mtrr_reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;MTRR region de-registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*  Zap the adapter lookup ptr!  */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="n">sz_last</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;free&#39;d %d of %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sz_first</span><span class="o">-</span><span class="n">sz_last</span><span class="o">+</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ioc</span><span class="p">),</span> <span class="n">sz_first</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	MptDisplayIocCapabilities - Disply IOC&#39;s capabilities.</span>
<span class="cm"> *	@ioc: Pointer to MPT adapter structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">MptDisplayIocCapabilities</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: &quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">prod_name</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: &quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">prod_name</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Capabilities={&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ProtocolFlags</span> <span class="o">&amp;</span> <span class="n">MPI_PORTFACTS_PROTOCOL_INITIATOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Initiator&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ProtocolFlags</span> <span class="o">&amp;</span> <span class="n">MPI_PORTFACTS_PROTOCOL_TARGET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sTarget&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ProtocolFlags</span> <span class="o">&amp;</span> <span class="n">MPI_PORTFACTS_PROTOCOL_LAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%sLAN&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/*</span>
<span class="c">	 *  This would probably evoke more questions than it&#39;s worth</span>
<span class="c">	 */</span>
<span class="c">	if (ioc-&gt;pfacts[0].ProtocolFlags &amp; MPI_PORTFACTS_PROTOCOL_TARGET) {</span>
<span class="c">		printk(&quot;%sLogBusAddr&quot;, i ? &quot;,&quot; : &quot;&quot;);</span>
<span class="c">		i++;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	MakeIocReady - Get IOC to a READY state, using KickStart if needed.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@force: Force hard KickStart of IOC</span>
<span class="cm"> *	@sleepFlag: Specifies whether the process can sleep</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		 1 - DIAG reset and READY</span>
<span class="cm"> *		 0 - READY initially OR soft reset and READY</span>
<span class="cm"> *		-1 - Any failure on KickStart</span>
<span class="cm"> *		-2 - Msg Unit Reset Failed</span>
<span class="cm"> *		-3 - IO Unit Reset Failed</span>
<span class="cm"> *		-4 - IOC owned by a PEER</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">MakeIocReady</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	 <span class="n">ioc_state</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">statefault</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">cntdn</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">hard_reset_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">ii</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">whoinit</span><span class="p">;</span>

	<span class="cm">/* Get current [raw] IOC state  */</span>
	<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;MakeIocReady [raw] state=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc_state</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Check to see if IOC got left/stuck in doorbell handshake</span>
<span class="cm">	 *	grip of death.  If so, hard reset the IOC.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">&amp;</span> <span class="n">MPI_DOORBELL_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">statefault</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;Unexpected doorbell active!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Is it already READY? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">statefault</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">ioc_state</span> <span class="o">&amp;</span> <span class="n">MPI_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPI_IOC_STATE_READY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span>
		    <span class="s">&quot;IOC is in READY state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Check to see if IOC is in FAULT state.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc_state</span> <span class="o">&amp;</span> <span class="n">MPI_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPI_IOC_STATE_FAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">statefault</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;IOC is in FAULT state!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;           FAULT code = %04xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc_state</span> <span class="o">&amp;</span> <span class="n">MPI_DOORBELL_DATA_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Hmmm...  Did it get left operational?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc_state</span> <span class="o">&amp;</span> <span class="n">MPI_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPI_IOC_STATE_OPERATIONAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;IOC operational unexpected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

		<span class="cm">/* Check WhoInit.</span>
<span class="cm">		 * If PCI Peer, exit.</span>
<span class="cm">		 * Else, if no fault conditions are present, issue a MessageUnitReset</span>
<span class="cm">		 * Else, fall through to KickStart case</span>
<span class="cm">		 */</span>
		<span class="n">whoinit</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">&amp;</span> <span class="n">MPI_DOORBELL_WHO_INIT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MPI_DOORBELL_WHO_INIT_SHIFT</span><span class="p">;</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span>
			<span class="s">&quot;whoinit 0x%x statefault %d force %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">whoinit</span><span class="p">,</span> <span class="n">statefault</span><span class="p">,</span> <span class="n">force</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">whoinit</span> <span class="o">==</span> <span class="n">MPI_WHOINIT_PCI_PEER</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">statefault</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">force</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">SendIocReset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">statefault</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hard_reset_done</span> <span class="o">=</span> <span class="n">KickStart</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">statefault</span><span class="o">||</span><span class="n">force</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hard_reset_done</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Loop here waiting for IOC to come READY.</span>
<span class="cm">	 */</span>
	<span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntdn</span> <span class="o">=</span> <span class="p">((</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="o">?</span> <span class="n">HZ</span> <span class="o">:</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>	<span class="cm">/* 5 seconds */</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="n">MPI_IOC_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">==</span> <span class="n">MPI_IOC_STATE_OPERATIONAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 *  BIOS or previous driver load left IOC in OP state.</span>
<span class="cm">			 *  Reset messaging FIFOs.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">SendIocReset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;IOC msg unit reset failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">==</span> <span class="n">MPI_IOC_STATE_RESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 *  Something is wrong.  Try to get IOC back</span>
<span class="cm">			 *  to a known state.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">SendIocReset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI_FUNCTION_IO_UNIT_RESET</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;IO unit reset failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ii</span><span class="o">++</span><span class="p">;</span> <span class="n">cntdn</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cntdn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
				<span class="s">&quot;Wait IOC_READY state (0x%x) timeout(%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc_state</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">ii</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="n">HZ</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mdelay</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* 1 msec delay */</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">statefault</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;Recovered from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">statefault</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;stuck handshake&quot;</span> <span class="o">:</span> <span class="s">&quot;IOC FAULT&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">hard_reset_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_GetIocState - Get the current state of a MPT adapter.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@cooked: Request raw or cooked IOC state</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns all IOC Doorbell register bits if cooked==0, else just the</span>
<span class="cm"> *	Doorbell bits in MPI_IOC_STATE_MASK.</span>
<span class="cm"> */</span>
<span class="n">u32</span>
<span class="nf">mpt_GetIocState</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cooked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">s</span><span class="p">,</span> <span class="n">sc</span><span class="p">;</span>

	<span class="cm">/*  Get!  */</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">);</span>
	<span class="n">sc</span> <span class="o">=</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">MPI_IOC_STATE_MASK</span><span class="p">;</span>

	<span class="cm">/*  Save!  */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">last_state</span> <span class="o">=</span> <span class="n">sc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cooked</span> <span class="o">?</span> <span class="n">sc</span> <span class="o">:</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	GetIocFacts - Send IOCFacts request to MPT adapter.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@sleepFlag: Specifies whether the process can sleep</span>
<span class="cm"> *	@reason: If recovery, only update facts.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">GetIocFacts</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IOCFacts_t</span>		 <span class="n">get_facts</span><span class="p">;</span>
	<span class="n">IOCFactsReply_t</span>		<span class="o">*</span><span class="n">facts</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">req_sz</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">reply_sz</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">sz</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">status</span><span class="p">,</span> <span class="n">vv</span><span class="p">;</span>
	<span class="n">u8</span>			 <span class="n">shiftFactor</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* IOC *must* NOT be in RESET state! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">last_state</span> <span class="o">==</span> <span class="n">MPI_IOC_STATE_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">MYNAM</span>
		    <span class="s">&quot;: ERROR - Can&#39;t get IOCFacts, %s NOT READY! (%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">last_state</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">44</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">facts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">;</span>

	<span class="cm">/* Destination (reply area)... */</span>
	<span class="n">reply_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">facts</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">facts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reply_sz</span><span class="p">);</span>

	<span class="cm">/* Request area (get_facts on the stack right now!) */</span>
	<span class="n">req_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">get_facts</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">get_facts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">req_sz</span><span class="p">);</span>

	<span class="n">get_facts</span><span class="p">.</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_IOC_FACTS</span><span class="p">;</span>
	<span class="cm">/* Assert: All other get_facts fields are zero! */</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;Sending get IocFacts request req_sz=%d reply_sz=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">req_sz</span><span class="p">,</span> <span class="n">reply_sz</span><span class="p">));</span>

	<span class="cm">/* No non-zero fields in the get_facts request are greater than</span>
<span class="cm">	 * 1 byte in size, so we can just fire it off as is.</span>
<span class="cm">	 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">mpt_handshake_req_reply_wait</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">req_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">get_facts</span><span class="p">,</span>
			<span class="n">reply_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)</span><span class="n">facts</span><span class="p">,</span> <span class="mi">5</span> <span class="cm">/*seconds*/</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now byte swap (GRRR) the necessary fields before any further</span>
<span class="cm">	 * inspection of reply contents.</span>
<span class="cm">	 *</span>
<span class="cm">	 * But need to do some sanity checks on MsgLength (byte) field</span>
<span class="cm">	 * to make sure we don&#39;t zero IOC&#39;s req_sz!</span>
<span class="cm">	 */</span>
	<span class="cm">/* Did we get a valid reply? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">MsgLength</span> <span class="o">&gt;</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">IOCFactsReply_t</span><span class="p">,</span> <span class="n">RequestFrameSize</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">MPT_HOSTEVENT_IOC_BRINGUP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If not been here, done that, save off first WhoInit value</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FirstWhoInit</span> <span class="o">==</span> <span class="n">WHOINIT_UNKNOWN</span><span class="p">)</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FirstWhoInit</span> <span class="o">=</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">WhoInit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">facts</span><span class="o">-&gt;</span><span class="n">MsgVersion</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">MsgVersion</span><span class="p">);</span>
		<span class="n">facts</span><span class="o">-&gt;</span><span class="n">MsgContext</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">MsgContext</span><span class="p">);</span>
		<span class="n">facts</span><span class="o">-&gt;</span><span class="n">IOCExceptions</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">IOCExceptions</span><span class="p">);</span>
		<span class="n">facts</span><span class="o">-&gt;</span><span class="n">IOCStatus</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">);</span>
		<span class="n">facts</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_IOCSTATUS_MASK</span><span class="p">;</span>
		<span class="cm">/* CHECKME! IOCStatus, IOCLogInfo */</span>

		<span class="n">facts</span><span class="o">-&gt;</span><span class="n">ReplyQueueDepth</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">ReplyQueueDepth</span><span class="p">);</span>
		<span class="n">facts</span><span class="o">-&gt;</span><span class="n">RequestFrameSize</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">RequestFrameSize</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * FC f/w version changed between 1.1 and 1.2</span>
<span class="cm">		 *	Old: u16{Major(4),Minor(4),SubMinor(8)}</span>
<span class="cm">		 *	New: u32{Major(8),Minor(8),Unit(8),Dev(8)}</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">MsgVersion</span> <span class="o">&lt;</span> <span class="n">MPI_VERSION_01_02</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 *	Handle old FC f/w style, convert to new...</span>
<span class="cm">			 */</span>
			<span class="n">u16</span>	 <span class="n">oldv</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">Reserved_0101_FWVersion</span><span class="p">);</span>
			<span class="n">facts</span><span class="o">-&gt;</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span> <span class="o">=</span>
					<span class="p">((</span><span class="n">oldv</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF000000</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">oldv</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="mh">0x000FFF00</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">facts</span><span class="o">-&gt;</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span><span class="p">);</span>

		<span class="n">facts</span><span class="o">-&gt;</span><span class="n">ProductID</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">ProductID</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">ProductID</span> <span class="o">&amp;</span> <span class="n">MPI_FW_HEADER_PID_PROD_MASK</span><span class="p">)</span>
		    <span class="o">&gt;</span> <span class="n">MPI_FW_HEADER_PID_PROD_TARGET_SCSI</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ir_firmware</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">facts</span><span class="o">-&gt;</span><span class="n">CurrentHostMfaHighAddr</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">CurrentHostMfaHighAddr</span><span class="p">);</span>
		<span class="n">facts</span><span class="o">-&gt;</span><span class="n">GlobalCredits</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">GlobalCredits</span><span class="p">);</span>
		<span class="n">facts</span><span class="o">-&gt;</span><span class="n">CurrentSenseBufferHighAddr</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">CurrentSenseBufferHighAddr</span><span class="p">);</span>
		<span class="n">facts</span><span class="o">-&gt;</span><span class="n">CurReplyFrameSize</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">CurReplyFrameSize</span><span class="p">);</span>
		<span class="n">facts</span><span class="o">-&gt;</span><span class="n">IOCCapabilities</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">IOCCapabilities</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Handle NEW (!) IOCFactsReply fields in MPI-1.01.xx</span>
<span class="cm">		 * Older MPI-1.00.xx struct had 13 dwords, and enlarged</span>
<span class="cm">		 * to 14 in MPI-1.01.0x.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">MsgLength</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="n">IOCFactsReply_t</span><span class="p">,</span><span class="n">FWImageSize</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span> <span class="o">&amp;&amp;</span>
		    <span class="n">facts</span><span class="o">-&gt;</span><span class="n">MsgVersion</span> <span class="o">&gt;</span> <span class="n">MPI_VERSION_01_00</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">facts</span><span class="o">-&gt;</span><span class="n">FWImageSize</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">FWImageSize</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">sz</span> <span class="o">=</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">FWImageSize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">sz</span> <span class="o">&amp;</span> <span class="mh">0x01</span> <span class="p">)</span>
			<span class="n">sz</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">sz</span> <span class="o">&amp;</span> <span class="mh">0x02</span> <span class="p">)</span>
			<span class="n">sz</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">facts</span><span class="o">-&gt;</span><span class="n">FWImageSize</span> <span class="o">=</span> <span class="n">sz</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">facts</span><span class="o">-&gt;</span><span class="n">RequestFrameSize</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  Something is wrong!  */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;IOC reported invalid 0 request size!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">55</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">BlockSize</span><span class="p">;</span>
		<span class="n">vv</span> <span class="o">=</span> <span class="p">((</span><span class="mi">63</span> <span class="o">/</span> <span class="p">(</span><span class="n">sz</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">NB_for_64_byte_frame</span> <span class="o">=</span> <span class="n">vv</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span> <span class="n">sz</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="n">shiftFactor</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sz</span> <span class="o">=</span> <span class="n">sz</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">NBShiftFactor</span>  <span class="o">=</span> <span class="n">shiftFactor</span><span class="p">;</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;NB_for_64_byte_frame=%x NBShiftFactor=%x BlockSize=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vv</span><span class="p">,</span> <span class="n">shiftFactor</span><span class="p">,</span> <span class="n">r</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">MPT_HOSTEVENT_IOC_BRINGUP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Set values for this IOC&#39;s request &amp; reply frame sizes,</span>
<span class="cm">			 * and request &amp; reply queue depths...</span>
<span class="cm">			 */</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">MPT_DEFAULT_FRAME_SIZE</span><span class="p">,</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">RequestFrameSize</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">MPT_MAX_REQ_DEPTH</span><span class="p">,</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">GlobalCredits</span><span class="p">);</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span> <span class="o">=</span> <span class="n">MPT_REPLY_FRAME_SIZE</span><span class="p">;</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_depth</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">MPT_DEFAULT_REPLY_DEPTH</span><span class="p">,</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">ReplyQueueDepth</span><span class="p">);</span>

			<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;reply_sz=%3d, reply_depth=%4d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_depth</span><span class="p">));</span>
			<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;req_sz  =%3d, req_depth  =%4d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">));</span>

			<span class="cm">/* Get port facts! */</span>
			<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">GetPortFacts</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
				<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
		     <span class="s">&quot;Invalid IOC facts reply, msgLength=%d offsetof=%zd!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">facts</span><span class="o">-&gt;</span><span class="n">MsgLength</span><span class="p">,</span> <span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="n">IOCFactsReply_t</span><span class="p">,</span>
		     <span class="n">RequestFrameSize</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">66</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	GetPortFacts - Send PortFacts request to MPT adapter.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@portnum: Port number</span>
<span class="cm"> *	@sleepFlag: Specifies whether the process can sleep</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">GetPortFacts</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portnum</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PortFacts_t</span>		 <span class="n">get_pfacts</span><span class="p">;</span>
	<span class="n">PortFactsReply_t</span>	<span class="o">*</span><span class="n">pfacts</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">ii</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">req_sz</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">reply_sz</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">max_id</span><span class="p">;</span>

	<span class="cm">/* IOC *must* NOT be in RESET state! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">last_state</span> <span class="o">==</span> <span class="n">MPI_IOC_STATE_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Can&#39;t get PortFacts NOT READY! (%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">last_state</span> <span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pfacts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">[</span><span class="n">portnum</span><span class="p">];</span>

	<span class="cm">/* Destination (reply area)...  */</span>
	<span class="n">reply_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pfacts</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pfacts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reply_sz</span><span class="p">);</span>

	<span class="cm">/* Request area (get_pfacts on the stack right now!) */</span>
	<span class="n">req_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">get_pfacts</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">get_pfacts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">req_sz</span><span class="p">);</span>

	<span class="n">get_pfacts</span><span class="p">.</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_PORT_FACTS</span><span class="p">;</span>
	<span class="n">get_pfacts</span><span class="p">.</span><span class="n">PortNumber</span> <span class="o">=</span> <span class="n">portnum</span><span class="p">;</span>
	<span class="cm">/* Assert: All other get_pfacts fields are zero! */</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Sending get PortFacts(%d) request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">portnum</span><span class="p">));</span>

	<span class="cm">/* No non-zero fields in the get_pfacts request are greater than</span>
<span class="cm">	 * 1 byte in size, so we can just fire it off as is.</span>
<span class="cm">	 */</span>
	<span class="n">ii</span> <span class="o">=</span> <span class="n">mpt_handshake_req_reply_wait</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">req_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">get_pfacts</span><span class="p">,</span>
				<span class="n">reply_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)</span><span class="n">pfacts</span><span class="p">,</span> <span class="mi">5</span> <span class="cm">/*seconds*/</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ii</span><span class="p">;</span>

	<span class="cm">/* Did we get a valid reply? */</span>

	<span class="cm">/* Now byte swap the necessary fields in the response. */</span>
	<span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">MsgContext</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">MsgContext</span><span class="p">);</span>
	<span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">IOCStatus</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">);</span>
	<span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">);</span>
	<span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">MaxDevices</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">MaxDevices</span><span class="p">);</span>
	<span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">PortSCSIID</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">PortSCSIID</span><span class="p">);</span>
	<span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">ProtocolFlags</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">ProtocolFlags</span><span class="p">);</span>
	<span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">MaxPostedCmdBuffers</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">MaxPostedCmdBuffers</span><span class="p">);</span>
	<span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">MaxPersistentIDs</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">MaxPersistentIDs</span><span class="p">);</span>
	<span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">MaxLanBuckets</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">MaxLanBuckets</span><span class="p">);</span>

	<span class="n">max_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span><span class="p">)</span> <span class="o">?</span> <span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">PortSCSIID</span> <span class="o">:</span>
	    <span class="n">pfacts</span><span class="o">-&gt;</span><span class="n">MaxDevices</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">devices_per_bus</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_id</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="n">max_id</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">number_of_buses</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">devices_per_bus</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">max_id</span><span class="o">/</span><span class="mi">256</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Place all the devices on channels</span>
<span class="cm">	 *</span>
<span class="cm">	 * (for debuging)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_channel_mapping</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">devices_per_bus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">number_of_buses</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_id</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="n">max_id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	SendIocInit - Send IOCInit request to MPT adapter.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@sleepFlag: Specifies whether the process can sleep</span>
<span class="cm"> *</span>
<span class="cm"> *	Send IOCInit followed by PortEnable to bring IOC to OPERATIONAL state.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">SendIocInit</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IOCInit_t</span>		 <span class="n">ioc_init</span><span class="p">;</span>
	<span class="n">MPIDefaultReply_t</span>	 <span class="n">init_reply</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">cntdn</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc_init</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ioc_init</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_reply</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">init_reply</span><span class="p">));</span>

	<span class="n">ioc_init</span><span class="p">.</span><span class="n">WhoInit</span> <span class="o">=</span> <span class="n">MPI_WHOINIT_HOST_DRIVER</span><span class="p">;</span>
	<span class="n">ioc_init</span><span class="p">.</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_IOC_INIT</span><span class="p">;</span>

	<span class="cm">/* If we are in a recovery mode and we uploaded the FW image,</span>
<span class="cm">	 * then this pointer is not NULL. Skip the upload a second time.</span>
<span class="cm">	 * Set this flag if cached_fw set for either IOC.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">MPI_IOCFACTS_FLAGS_FW_DOWNLOAD_BOOT</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">upload_fw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">upload_fw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;upload_fw %d facts.Flags=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">upload_fw</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">Flags</span><span class="p">));</span>

	<span class="n">ioc_init</span><span class="p">.</span><span class="n">MaxDevices</span> <span class="o">=</span> <span class="p">(</span><span class="n">U8</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">devices_per_bus</span><span class="p">;</span>
	<span class="n">ioc_init</span><span class="p">.</span><span class="n">MaxBuses</span> <span class="o">=</span> <span class="p">(</span><span class="n">U8</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">number_of_buses</span><span class="p">;</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;facts.MsgVersion=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MsgVersion</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MsgVersion</span> <span class="o">&gt;=</span> <span class="n">MPI_VERSION_01_05</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>set MsgVersion and HeaderVersion host driver was built with</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ioc_init</span><span class="p">.</span><span class="n">MsgVersion</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MPI_VERSION</span><span class="p">);</span>
	        <span class="n">ioc_init</span><span class="p">.</span><span class="n">HeaderVersion</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MPI_HEADER_VERSION</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">MPI_IOCFACTS_FLAGS_HOST_PAGE_BUFFER_PERSISTENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc_init</span><span class="p">.</span><span class="n">HostPageBufferSGE</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">HostPageBufferSGE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">mpt_host_page_alloc</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc_init</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">99</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc_init</span><span class="p">.</span><span class="n">ReplyFrameSize</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">);</span>	<span class="cm">/* in BYTES */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sg_addr_size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Save the upper 32-bits of the request</span>
<span class="cm">		 * (reply) and sense buffers.</span>
<span class="cm">		 */</span>
		<span class="n">ioc_init</span><span class="p">.</span><span class="n">HostMfaHighAddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">ioc_init</span><span class="p">.</span><span class="n">SenseBufferHighAddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Force 32-bit addressing */</span>
		<span class="n">ioc_init</span><span class="p">.</span><span class="n">HostMfaHighAddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ioc_init</span><span class="p">.</span><span class="n">SenseBufferHighAddr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">CurrentHostMfaHighAddr</span> <span class="o">=</span> <span class="n">ioc_init</span><span class="p">.</span><span class="n">HostMfaHighAddr</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">CurrentSenseBufferHighAddr</span> <span class="o">=</span> <span class="n">ioc_init</span><span class="p">.</span><span class="n">SenseBufferHighAddr</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxDevices</span> <span class="o">=</span> <span class="n">ioc_init</span><span class="p">.</span><span class="n">MaxDevices</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxBuses</span> <span class="o">=</span> <span class="n">ioc_init</span><span class="p">.</span><span class="n">MaxBuses</span><span class="p">;</span>

	<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Sending IOCInit (req @ %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc_init</span><span class="p">));</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">mpt_handshake_req_reply_wait</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IOCInit_t</span><span class="p">),</span> <span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ioc_init</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">MPIDefaultReply_t</span><span class="p">),</span> <span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">init_reply</span><span class="p">,</span> <span class="mi">10</span> <span class="cm">/*seconds*/</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Sending IOCInit failed(%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* No need to byte swap the multibyte fields in the reply</span>
<span class="cm">	 * since we don&#39;t even look at its contents.</span>
<span class="cm">	 */</span>

	<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Sending PortEnable (req @ %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc_init</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">SendPortEnable</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Sending PortEnable failed(%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* YIKES!  SUPER IMPORTANT!!!</span>
<span class="cm">	 *  Poll IocState until _OPERATIONAL while IOC is doing</span>
<span class="cm">	 *  LoopInit and TargetDiscovery!</span>
<span class="cm">	 */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntdn</span> <span class="o">=</span> <span class="p">((</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="o">?</span> <span class="n">HZ</span> <span class="o">:</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>	<span class="cm">/* 60 seconds */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">MPI_IOC_STATE_OPERATIONAL</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">cntdn</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cntdn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Wait IOC_OP state timeout(%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">count</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="n">HZ</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">9</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">state</span> <span class="o">=</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Wait IOC_OPERATIONAL state (cnt=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">aen_event_read_flag</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	SendPortEnable - Send PortEnable request to MPT adapter port.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@portnum: Port number to enable</span>
<span class="cm"> *	@sleepFlag: Specifies whether the process can sleep</span>
<span class="cm"> *</span>
<span class="cm"> *	Send PortEnable to bring IOC to OPERATIONAL state.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">SendPortEnable</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portnum</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PortEnable_t</span>		 <span class="n">port_enable</span><span class="p">;</span>
	<span class="n">MPIDefaultReply_t</span>	 <span class="n">reply_buf</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">req_sz</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">reply_sz</span><span class="p">;</span>

	<span class="cm">/*  Destination...  */</span>
	<span class="n">reply_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MPIDefaultReply_t</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reply_sz</span><span class="p">);</span>

	<span class="n">req_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PortEnable_t</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port_enable</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">req_sz</span><span class="p">);</span>

	<span class="n">port_enable</span><span class="p">.</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_PORT_ENABLE</span><span class="p">;</span>
	<span class="n">port_enable</span><span class="p">.</span><span class="n">PortNumber</span> <span class="o">=</span> <span class="n">portnum</span><span class="p">;</span>
<span class="cm">/*	port_enable.ChainOffset = 0;		*/</span>
<span class="cm">/*	port_enable.MsgFlags = 0;		*/</span>
<span class="cm">/*	port_enable.MsgContext = 0;		*/</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Sending Port(%d)Enable (req @ %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">portnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port_enable</span><span class="p">));</span>

	<span class="cm">/* RAID FW may take a long time to enable</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ir_firmware</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_handshake_req_reply_wait</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">req_sz</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">port_enable</span><span class="p">,</span> <span class="n">reply_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reply_buf</span><span class="p">,</span>
		<span class="mi">300</span> <span class="cm">/*seconds*/</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_handshake_req_reply_wait</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">req_sz</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">port_enable</span><span class="p">,</span> <span class="n">reply_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reply_buf</span><span class="p">,</span>
		<span class="mi">30</span> <span class="cm">/*seconds*/</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mpt_alloc_fw_memory - allocate firmware memory</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *      @size: total FW bytes</span>
<span class="cm"> *</span>
<span class="cm"> *	If memory has already been allocated, the same (cached) value</span>
<span class="cm"> *	is returned.</span>
<span class="cm"> *</span>
<span class="cm"> *	Return 0 if successful, or non-zero for failure</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">mpt_alloc_fw_memory</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* use already allocated memory */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span> <span class="o">&amp;&amp;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">;</span>  <span class="cm">/* use alt_ioc&#39;s memory */</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw_dma</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">cached_fw_dma</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Unable to allocate memory for the cached firmware image!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;FW Image  @ %p[%p], sz=%d[%x] bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">ulong</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw_dma</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">));</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mpt_free_fw_memory - free firmware memory</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *</span>
<span class="cm"> *	If alt_img is NULL, delete from ioc structure.</span>
<span class="cm"> *	Else, delete a secondary image in same format.</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">mpt_free_fw_memory</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWImageSize</span><span class="p">;</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;free_fw_memory: FW Image  @ %p[%p], sz=%d[%x] bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">ulong</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw_dma</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">sz</span><span class="p">));</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw_dma</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span> <span class="o">-=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_do_upload - Construct and Send FWUpload request to MPT adapter port.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@sleepFlag: Specifies whether the process can sleep</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, &gt;0 for handshake failure</span>
<span class="cm"> *		&lt;0 for fw upload failure.</span>
<span class="cm"> *</span>
<span class="cm"> *	Remark: If bound IOC and a successful FWUpload was performed</span>
<span class="cm"> *	on the bound IOC, the second image is discarded</span>
<span class="cm"> *	and memory is free&#39;d. Both channels must upload to prevent</span>
<span class="cm"> *	IOC from running in degraded mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpt_do_upload</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>			 <span class="n">reply</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">FWUploadReply_t</span><span class="p">)];</span>
	<span class="n">FWUpload_t</span>		<span class="o">*</span><span class="n">prequest</span><span class="p">;</span>
	<span class="n">FWUploadReply_t</span>		<span class="o">*</span><span class="n">preply</span><span class="p">;</span>
	<span class="n">FWUploadTCSGE_t</span>		<span class="o">*</span><span class="n">ptcsge</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">flagsLength</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">ii</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">reply_sz</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">cmdStatus</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">request_size</span><span class="p">;</span>
	<span class="cm">/* If the image size is 0, we are done.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWImageSize</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_alloc_fw_memory</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWImageSize</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;: FW Image  @ %p[%p], sz=%d[%x] bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">ulong</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw_dma</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">sz</span><span class="p">));</span>

	<span class="n">prequest</span> <span class="o">=</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">NO_SLEEP</span><span class="p">)</span> <span class="o">?</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)</span> <span class="o">:</span>
	    <span class="n">kzalloc</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prequest</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;fw upload failed &quot;</span>
		    <span class="s">&quot;while allocating memory </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">mpt_free_fw_memory</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">preply</span> <span class="o">=</span> <span class="p">(</span><span class="n">FWUploadReply_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">;</span>

	<span class="n">reply_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">preply</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reply_sz</span><span class="p">);</span>

	<span class="n">prequest</span><span class="o">-&gt;</span><span class="n">ImageType</span> <span class="o">=</span> <span class="n">MPI_FW_UPLOAD_ITYPE_FW_IOC_MEM</span><span class="p">;</span>
	<span class="n">prequest</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_FW_UPLOAD</span><span class="p">;</span>

	<span class="n">ptcsge</span> <span class="o">=</span> <span class="p">(</span><span class="n">FWUploadTCSGE_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">prequest</span><span class="o">-&gt;</span><span class="n">SGL</span><span class="p">;</span>
	<span class="n">ptcsge</span><span class="o">-&gt;</span><span class="n">DetailsLength</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">ptcsge</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">MPI_SGE_FLAGS_TRANSACTION_ELEMENT</span><span class="p">;</span>
	<span class="n">ptcsge</span><span class="o">-&gt;</span><span class="n">ImageSize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sz</span><span class="p">);</span>
	<span class="n">ptcsge</span><span class="o">++</span><span class="p">;</span>

	<span class="n">flagsLength</span> <span class="o">=</span> <span class="n">MPT_SGE_FLAGS_SSIMPLE_READ</span> <span class="o">|</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptcsge</span><span class="p">,</span> <span class="n">flagsLength</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw_dma</span><span class="p">);</span>
	<span class="n">request_size</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">FWUpload_t</span><span class="p">,</span> <span class="n">SGL</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">FWUploadTCSGE_t</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Sending FW Upload &quot;</span>
	    <span class="s">&quot; (req @ %p) fw_size=%d mf_request_size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">prequest</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWImageSize</span><span class="p">,</span> <span class="n">request_size</span><span class="p">));</span>
	<span class="n">DBG_DUMP_FW_REQUEST_FRAME</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">prequest</span><span class="p">);</span>

	<span class="n">ii</span> <span class="o">=</span> <span class="n">mpt_handshake_req_reply_wait</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">request_size</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">prequest</span><span class="p">,</span>
	    <span class="n">reply_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">preply</span><span class="p">,</span> <span class="mi">65</span> <span class="cm">/*seconds*/</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;FW Upload completed &quot;</span>
	    <span class="s">&quot;rc=%x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ii</span><span class="p">));</span>

	<span class="n">cmdStatus</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Handshake transfer was complete and successful.</span>
<span class="cm">		 * Check the Reply Frame.</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">preply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">MPI_IOCSTATUS_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_SUCCESS</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWImageSize</span> <span class="o">==</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">preply</span><span class="o">-&gt;</span><span class="n">ActualImageSize</span><span class="p">))</span>
				<span class="n">cmdStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;: do_upload cmdStatus=%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmdStatus</span><span class="p">));</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">cmdStatus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;fw upload failed, &quot;</span>
		    <span class="s">&quot;freeing image </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">mpt_free_fw_memory</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">prequest</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cmdStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_downloadboot - DownloadBoot code</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@pFwHeader: Pointer to firmware header info</span>
<span class="cm"> *	@sleepFlag: Specifies whether the process can sleep</span>
<span class="cm"> *</span>
<span class="cm"> *	FwDownloadBoot requires Programmed IO access.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success</span>
<span class="cm"> *		-1 FW Image size is 0</span>
<span class="cm"> *		-2 No valid cached_fw Pointer</span>
<span class="cm"> *		&lt;0 for fw upload failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpt_downloadboot</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MpiFwHeader_t</span> <span class="o">*</span><span class="n">pFwHeader</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MpiExtImageHeader_t</span>	<span class="o">*</span><span class="n">pExtImage</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">fwSize</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">diag0val</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">count</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="o">*</span><span class="n">ptrFw</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">diagRwData</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">nextImage</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">load_addr</span><span class="p">;</span>
	<span class="n">u32</span> 			 <span class="n">ioc_state</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;downloadboot: fw size 0x%x (%d), FW Ptr %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pFwHeader</span><span class="o">-&gt;</span><span class="n">ImageSize</span><span class="p">,</span> <span class="n">pFwHeader</span><span class="o">-&gt;</span><span class="n">ImageSize</span><span class="p">,</span> <span class="n">pFwHeader</span><span class="p">));</span>

	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_1ST_KEY_VALUE</span><span class="p">);</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_2ND_KEY_VALUE</span><span class="p">);</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_3RD_KEY_VALUE</span><span class="p">);</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_4TH_KEY_VALUE</span><span class="p">);</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_5TH_KEY_VALUE</span><span class="p">);</span>

	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">,</span> <span class="p">(</span><span class="n">MPI_DIAG_PREVENT_IOC_BOOT</span> <span class="o">|</span> <span class="n">MPI_DIAG_DISABLE_ARM</span><span class="p">));</span>

	<span class="cm">/* wait 1 msec */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mdelay</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">diag0val</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">);</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">,</span> <span class="n">diag0val</span> <span class="o">|</span> <span class="n">MPI_DIAG_RESET_ADAPTER</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">;</span> <span class="n">count</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diag0val</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">diag0val</span> <span class="o">&amp;</span> <span class="n">MPI_DIAG_RESET_ADAPTER</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;RESET_ADAPTER cleared, count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* wait .1 sec */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span> <span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mdelay</span> <span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">30</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;downloadboot failed! &quot;</span>
		<span class="s">&quot;Unable to get MPI_DIAG_DRWE mode, diag0val=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">diag0val</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_1ST_KEY_VALUE</span><span class="p">);</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_2ND_KEY_VALUE</span><span class="p">);</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_3RD_KEY_VALUE</span><span class="p">);</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_4TH_KEY_VALUE</span><span class="p">);</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_5TH_KEY_VALUE</span><span class="p">);</span>

	<span class="cm">/* Set the DiagRwEn and Disable ARM bits */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">,</span> <span class="p">(</span><span class="n">MPI_DIAG_RW_ENABLE</span> <span class="o">|</span> <span class="n">MPI_DIAG_DISABLE_ARM</span><span class="p">));</span>

	<span class="n">fwSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">pFwHeader</span><span class="o">-&gt;</span><span class="n">ImageSize</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">ptrFw</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">pFwHeader</span><span class="p">;</span>

	<span class="cm">/* Write the LoadStartAddress to the DiagRw Address Register</span>
<span class="cm">	 * using Programmed IO</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">errata_flag_1064</span><span class="p">)</span>
		<span class="n">pci_enable_io_access</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>

	<span class="n">CHIPREG_PIO_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pio_chip</span><span class="o">-&gt;</span><span class="n">DiagRwAddress</span><span class="p">,</span> <span class="n">pFwHeader</span><span class="o">-&gt;</span><span class="n">LoadStartAddress</span><span class="p">);</span>
	<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;LoadStart addr written 0x%x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pFwHeader</span><span class="o">-&gt;</span><span class="n">LoadStartAddress</span><span class="p">));</span>

	<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Write FW Image: 0x%x bytes @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fwSize</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">ptrFw</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">fwSize</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CHIPREG_PIO_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pio_chip</span><span class="o">-&gt;</span><span class="n">DiagRwData</span><span class="p">,</span> <span class="o">*</span><span class="n">ptrFw</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nextImage</span> <span class="o">=</span> <span class="n">pFwHeader</span><span class="o">-&gt;</span><span class="n">NextImageHeaderOffset</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nextImage</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pExtImage</span> <span class="o">=</span> <span class="p">(</span><span class="n">MpiExtImageHeader_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pFwHeader</span> <span class="o">+</span> <span class="n">nextImage</span><span class="p">);</span>

		<span class="n">load_addr</span> <span class="o">=</span> <span class="n">pExtImage</span><span class="o">-&gt;</span><span class="n">LoadStartAddress</span><span class="p">;</span>

		<span class="n">fwSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">pExtImage</span><span class="o">-&gt;</span><span class="n">ImageSize</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ptrFw</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">pExtImage</span><span class="p">;</span>

		<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Write Ext Image: 0x%x (%d) bytes @ %p load_addr=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fwSize</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">fwSize</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">ptrFw</span><span class="p">,</span> <span class="n">load_addr</span><span class="p">));</span>
		<span class="n">CHIPREG_PIO_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pio_chip</span><span class="o">-&gt;</span><span class="n">DiagRwAddress</span><span class="p">,</span> <span class="n">load_addr</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">fwSize</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CHIPREG_PIO_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pio_chip</span><span class="o">-&gt;</span><span class="n">DiagRwData</span><span class="p">,</span> <span class="o">*</span><span class="n">ptrFw</span><span class="o">++</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">nextImage</span> <span class="o">=</span> <span class="n">pExtImage</span><span class="o">-&gt;</span><span class="n">NextImageHeaderOffset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write the IopResetVectorRegAddr */</span>
	<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Write IopResetVector Addr=%x! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> 	<span class="n">pFwHeader</span><span class="o">-&gt;</span><span class="n">IopResetRegAddr</span><span class="p">));</span>
	<span class="n">CHIPREG_PIO_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pio_chip</span><span class="o">-&gt;</span><span class="n">DiagRwAddress</span><span class="p">,</span> <span class="n">pFwHeader</span><span class="o">-&gt;</span><span class="n">IopResetRegAddr</span><span class="p">);</span>

	<span class="cm">/* Write the IopResetVectorValue */</span>
	<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Write IopResetVector Value=%x! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pFwHeader</span><span class="o">-&gt;</span><span class="n">IopResetVectorValue</span><span class="p">));</span>
	<span class="n">CHIPREG_PIO_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pio_chip</span><span class="o">-&gt;</span><span class="n">DiagRwData</span><span class="p">,</span> <span class="n">pFwHeader</span><span class="o">-&gt;</span><span class="n">IopResetVectorValue</span><span class="p">);</span>

	<span class="cm">/* Clear the internal flash bad bit - autoincrementing register,</span>
<span class="cm">	 * so must do two writes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SPI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * 1030 and 1035 H/W errata, workaround to access</span>
<span class="cm">		 * the ClearFlashBadSignatureBit</span>
<span class="cm">		 */</span>
		<span class="n">CHIPREG_PIO_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pio_chip</span><span class="o">-&gt;</span><span class="n">DiagRwAddress</span><span class="p">,</span> <span class="mh">0x3F000000</span><span class="p">);</span>
		<span class="n">diagRwData</span> <span class="o">=</span> <span class="n">CHIPREG_PIO_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pio_chip</span><span class="o">-&gt;</span><span class="n">DiagRwData</span><span class="p">);</span>
		<span class="n">diagRwData</span> <span class="o">|=</span> <span class="mh">0x40000000</span><span class="p">;</span>
		<span class="n">CHIPREG_PIO_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pio_chip</span><span class="o">-&gt;</span><span class="n">DiagRwAddress</span><span class="p">,</span> <span class="mh">0x3F000000</span><span class="p">);</span>
		<span class="n">CHIPREG_PIO_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pio_chip</span><span class="o">-&gt;</span><span class="n">DiagRwData</span><span class="p">,</span> <span class="n">diagRwData</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* if((ioc-&gt;bus_type == SAS) || (ioc-&gt;bus_type == FC)) */</span> <span class="p">{</span>
		<span class="n">diag0val</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">);</span>
		<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">,</span> <span class="n">diag0val</span> <span class="o">|</span>
		    <span class="n">MPI_DIAG_CLEAR_FLASH_BAD_SIG</span><span class="p">);</span>

		<span class="cm">/* wait 1 msec */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mdelay</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">errata_flag_1064</span><span class="p">)</span>
		<span class="n">pci_disable_io_access</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>

	<span class="n">diag0val</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">);</span>
	<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;downloadboot diag0val=%x, &quot;</span>
		<span class="s">&quot;turning off PREVENT_IOC_BOOT, DISABLE_ARM, RW_ENABLE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">diag0val</span><span class="p">));</span>
	<span class="n">diag0val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MPI_DIAG_PREVENT_IOC_BOOT</span> <span class="o">|</span> <span class="n">MPI_DIAG_DISABLE_ARM</span> <span class="o">|</span> <span class="n">MPI_DIAG_RW_ENABLE</span><span class="p">);</span>
	<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;downloadboot now diag0val=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">diag0val</span><span class="p">));</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">,</span> <span class="n">diag0val</span><span class="p">);</span>

	<span class="cm">/* Write 0xFF to reset the sequencer */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">GetIocFacts</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">,</span>
				<span class="n">MPT_HOSTEVENT_IOC_BRINGUP</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;GetIocFacts failed: IocState=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc_state</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">count</span><span class="o">&lt;</span><span class="n">HZ</span><span class="o">*</span><span class="mi">20</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">MPI_IOC_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
				<span class="s">&quot;downloadboot successful! (count=%d) IocState=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ioc_state</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">SendIocInit</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
					<span class="s">&quot;downloadboot: SendIocInit failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
					<span class="s">&quot;downloadboot: SendIocInit successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span> <span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mdelay</span> <span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ddlprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		<span class="s">&quot;downloadboot failed! IocState=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc_state</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	KickStart - Perform hard reset of MPT adapter.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@force: Force hard reset</span>
<span class="cm"> *	@sleepFlag: Specifies whether the process can sleep</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine places MPT adapter in diagnostic mode via the</span>
<span class="cm"> *	WriteSequence register, and then performs a hard reset of adapter</span>
<span class="cm"> *	via the Diagnostic register.</span>
<span class="cm"> *</span>
<span class="cm"> *	Inputs:   sleepflag - CAN_SLEEP (non-interrupt thread)</span>
<span class="cm"> *			or NO_SLEEP (interrupt thread, use mdelay)</span>
<span class="cm"> *		  force - 1 if doorbell active, board fault state</span>
<span class="cm"> *				board operational, IOC_RECOVERY or</span>
<span class="cm"> *				IOC_BRINGUP and there is an alt_ioc.</span>
<span class="cm"> *			  0 else</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:</span>
<span class="cm"> *		 1 - hard reset, READY</span>
<span class="cm"> *		 0 - no reset due to History bit, READY</span>
<span class="cm"> *		-1 - no reset due to History bit but not READY</span>
<span class="cm"> *		     OR reset but failed to come READY</span>
<span class="cm"> *		-2 - no reset, could not enter DIAG mode</span>
<span class="cm"> *		-3 - reset but bad FW bit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">KickStart</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hard_reset_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ioc_state</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span><span class="n">cntdn</span><span class="p">;</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;KickStarting!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SPI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Always issue a Msg Unit Reset first. This will clear some</span>
<span class="cm">		 * SCSI bus hang conditions.</span>
<span class="cm">		 */</span>
		<span class="n">SendIocReset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span> <span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mdelay</span> <span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hard_reset_done</span> <span class="o">=</span> <span class="n">mpt_diag_reset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hard_reset_done</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hard_reset_done</span><span class="p">;</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Diagnostic reset successful!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">cntdn</span> <span class="o">=</span> <span class="p">((</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="o">?</span> <span class="n">HZ</span> <span class="o">:</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* 2 seconds */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span><span class="o">&lt;</span><span class="n">cntdn</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ioc_state</span> <span class="o">==</span> <span class="n">MPI_IOC_STATE_READY</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">==</span> <span class="n">MPI_IOC_STATE_OPERATIONAL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;KickStart successful! (cnt=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
 					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cnt</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">hard_reset_done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span> <span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mdelay</span> <span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Failed to come READY after reset! IocState=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)));</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_diag_reset - Perform hard reset of the adapter.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@ignore: Set if to honor and clear to ignore</span>
<span class="cm"> *		the reset history bit</span>
<span class="cm"> *	@sleepFlag: CAN_SLEEP if called in a non-interrupt thread,</span>
<span class="cm"> *		else set to NO_SLEEP (use mdelay instead)</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine places the adapter in diagnostic mode via the</span>
<span class="cm"> *	WriteSequence register and then performs a hard reset of adapter</span>
<span class="cm"> *	via the Diagnostic register. Adapter should be in ready state</span>
<span class="cm"> *	upon successful completion.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns:  1  hard reset successful</span>
<span class="cm"> *		  0  no reset performed because reset history bit set</span>
<span class="cm"> *		 -2  enabling diagnostic mode failed</span>
<span class="cm"> *		 -3  diagnostic reset failed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpt_diag_reset</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignore</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">diag0val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">doorbell</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hard_reset_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">diag1val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">MpiFwHeader_t</span> <span class="o">*</span><span class="n">cached_fw</span><span class="p">;</span>	<span class="cm">/* Pointer to FW */</span>
	<span class="n">u8</span>	 <span class="n">cb_idx</span><span class="p">;</span>

	<span class="cm">/* Clear any existing interrupts */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1078</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ignore</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">drsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;%s: Doorbell=%p; 1078 reset &quot;</span>
			<span class="s">&quot;address=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Reset_1078</span><span class="p">));</span>
		<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Reset_1078</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Call each currently registered protocol IOC reset handler</span>
<span class="cm">		 * with pre-reset indication.</span>
<span class="cm">		 * NOTE: If we&#39;re doing _IOC_BRINGUP, there can be no</span>
<span class="cm">		 * MptResetHandlers[] registered yet.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">cb_idx</span><span class="p">;</span> <span class="n">cb_idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">MptResetHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">])</span>
				<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">MptResetHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]))(</span><span class="n">ioc</span><span class="p">,</span>
						<span class="n">MPT_IOC_PRE_RESET</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">;</span> <span class="n">count</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">doorbell</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">);</span>
			<span class="n">doorbell</span> <span class="o">&amp;=</span> <span class="n">MPI_IOC_STATE_MASK</span><span class="p">;</span>

			<span class="n">drsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
				<span class="s">&quot;looking for READY STATE: doorbell=%x&quot;</span>
			        <span class="s">&quot; count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">doorbell</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">doorbell</span> <span class="o">==</span> <span class="n">MPI_IOC_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* wait 1 sec */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use &quot;Diagnostic reset&quot; method! (only thing available!) */</span>
	<span class="n">diag0val</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">debug_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span>
			<span class="n">diag1val</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;DbG1: diag0=%08x, diag1=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">diag0val</span><span class="p">,</span> <span class="n">diag1val</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Do the reset if we are told to ignore the reset history</span>
<span class="cm">	 * or if the reset history is 0</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ignore</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">diag0val</span> <span class="o">&amp;</span> <span class="n">MPI_DIAG_RESET_HISTORY</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">diag0val</span> <span class="o">&amp;</span> <span class="n">MPI_DIAG_DRWE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Write magic sequence to WriteSequence register</span>
<span class="cm">			 * Loop until in diagnostic mode</span>
<span class="cm">			 */</span>
			<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
			<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_1ST_KEY_VALUE</span><span class="p">);</span>
			<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_2ND_KEY_VALUE</span><span class="p">);</span>
			<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_3RD_KEY_VALUE</span><span class="p">);</span>
			<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_4TH_KEY_VALUE</span><span class="p">);</span>
			<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_5TH_KEY_VALUE</span><span class="p">);</span>

			<span class="cm">/* wait 100 msec */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">msleep</span> <span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mdelay</span> <span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Enable Diagnostic mode FAILED! (%02xh)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">diag0val</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="n">diag0val</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">);</span>

			<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Wrote magic DiagWriteEn sequence (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">diag0val</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">debug_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span>
				<span class="n">diag1val</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;DbG2: diag0=%08x, diag1=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">diag0val</span><span class="p">,</span> <span class="n">diag1val</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Disable the ARM (Bug fix)</span>
<span class="cm">		 *</span>
<span class="cm">		 */</span>
		<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">,</span> <span class="n">diag0val</span> <span class="o">|</span> <span class="n">MPI_DIAG_DISABLE_ARM</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Now hit the reset bit in the Diagnostic register</span>
<span class="cm">		 * (THE BIG HAMMER!) (Clears DRWE bit).</span>
<span class="cm">		 */</span>
		<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">,</span> <span class="n">diag0val</span> <span class="o">|</span> <span class="n">MPI_DIAG_RESET_ADAPTER</span><span class="p">);</span>
		<span class="n">hard_reset_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Diagnostic reset performed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * Call each currently registered protocol IOC reset handler</span>
<span class="cm">		 * with pre-reset indication.</span>
<span class="cm">		 * NOTE: If we&#39;re doing _IOC_BRINGUP, there can be no</span>
<span class="cm">		 * MptResetHandlers[] registered yet.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">cb_idx</span><span class="p">;</span> <span class="n">cb_idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">MptResetHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">mpt_signal_reset</span><span class="p">(</span><span class="n">cb_idx</span><span class="p">,</span>
					<span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_IOC_PRE_RESET</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mpt_signal_reset</span><span class="p">(</span><span class="n">cb_idx</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">,</span> <span class="n">MPT_IOC_PRE_RESET</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">)</span>
			<span class="n">cached_fw</span> <span class="o">=</span> <span class="p">(</span><span class="n">MpiFwHeader_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span> <span class="o">&amp;&amp;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">)</span>
			<span class="n">cached_fw</span> <span class="o">=</span> <span class="p">(</span><span class="n">MpiFwHeader_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">cached_fw</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cached_fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cached_fw</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* If the DownloadBoot operation fails, the</span>
<span class="cm">			 * IOC will be left unusable. This is a fatal error</span>
<span class="cm">			 * case.  _diag_reset will return &lt; 0</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">;</span> <span class="n">count</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diag0val</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">diag0val</span> <span class="o">&amp;</span> <span class="n">MPI_DIAG_RESET_ADAPTER</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;cached_fw: diag0val=%x count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">diag0val</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>
				<span class="cm">/* wait 1 sec */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">msleep</span> <span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">mdelay</span> <span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">=</span> <span class="n">mpt_downloadboot</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">cached_fw</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
					<span class="s">&quot;firmware downloadboot failure (%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Wait for FW to reload and for board</span>
<span class="cm">			 * to go to the READY state.</span>
<span class="cm">			 * Maximum wait is 60 seconds.</span>
<span class="cm">			 * If fail, no error will check again</span>
<span class="cm">			 * with calling program.</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">;</span> <span class="n">count</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">doorbell</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">);</span>
				<span class="n">doorbell</span> <span class="o">&amp;=</span> <span class="n">MPI_IOC_STATE_MASK</span><span class="p">;</span>

				<span class="n">drsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
				    <span class="s">&quot;looking for READY STATE: doorbell=%x&quot;</span>
				    <span class="s">&quot; count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">doorbell</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">doorbell</span> <span class="o">==</span> <span class="n">MPI_IOC_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* wait 1 sec */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">msleep</span> <span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">mdelay</span> <span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">doorbell</span> <span class="o">!=</span> <span class="n">MPI_IOC_STATE_READY</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Failed to come READY &quot;</span>
				    <span class="s">&quot;after reset! IocState=%x&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				    <span class="n">doorbell</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">diag0val</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">debug_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span>
			<span class="n">diag1val</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;DbG3: diag0=%08x, diag1=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">diag0val</span><span class="p">,</span> <span class="n">diag1val</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Clear RESET_HISTORY bit!  Place board in the</span>
<span class="cm">	 * diagnostic mode to update the diag register.</span>
<span class="cm">	 */</span>
	<span class="n">diag0val</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">diag0val</span> <span class="o">&amp;</span> <span class="n">MPI_DIAG_DRWE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Write magic sequence to WriteSequence register</span>
<span class="cm">		 * Loop until in diagnostic mode</span>
<span class="cm">		 */</span>
		<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_1ST_KEY_VALUE</span><span class="p">);</span>
		<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_2ND_KEY_VALUE</span><span class="p">);</span>
		<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_3RD_KEY_VALUE</span><span class="p">);</span>
		<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_4TH_KEY_VALUE</span><span class="p">);</span>
		<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="n">MPI_WRSEQ_5TH_KEY_VALUE</span><span class="p">);</span>

		<span class="cm">/* wait 100 msec */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span> <span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mdelay</span> <span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Enable Diagnostic mode FAILED! (%02xh)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">diag0val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">diag0val</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">diag0val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPI_DIAG_RESET_HISTORY</span><span class="p">;</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">,</span> <span class="n">diag0val</span><span class="p">);</span>
	<span class="n">diag0val</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag0val</span> <span class="o">&amp;</span> <span class="n">MPI_DIAG_RESET_HISTORY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;ResetHistory bit failed to clear!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Disable Diagnostic Mode</span>
<span class="cm">	 */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">WriteSequence</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>

	<span class="cm">/* Check FW reload status flags.</span>
<span class="cm">	 */</span>
	<span class="n">diag0val</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diag0val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MPI_DIAG_FLASH_BAD_SIG</span> <span class="o">|</span> <span class="n">MPI_DIAG_RESET_ADAPTER</span> <span class="o">|</span> <span class="n">MPI_DIAG_DISABLE_ARM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Diagnostic reset FAILED! (%02xh)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">diag0val</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">debug_level</span> <span class="o">&amp;</span> <span class="n">MPT_DEBUG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span>
			<span class="n">diag1val</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Diagnostic</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;DbG4: diag0=%08x, diag1=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">diag0val</span><span class="p">,</span> <span class="n">diag1val</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset flag that says we&#39;ve enabled event notification</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">EventState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">EventState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hard_reset_done</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	SendIocReset - Send IOCReset request to MPT adapter.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@reset_type: reset type, expected values are</span>
<span class="cm"> *	%MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET or %MPI_FUNCTION_IO_UNIT_RESET</span>
<span class="cm"> *	@sleepFlag: Specifies whether the process can sleep</span>
<span class="cm"> *</span>
<span class="cm"> *	Send IOCReset request to the MPT adapter.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">SendIocReset</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reset_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cntdn</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">drsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Sending IOC reset(0x%02x)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">reset_type</span><span class="p">));</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">,</span> <span class="n">reset_type</span><span class="o">&lt;&lt;</span><span class="n">MPI_DOORBELL_FUNCTION_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">WaitForDoorbellAck</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* FW ACK&#39;d request, wait for READY state</span>
<span class="cm">	 */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cntdn</span> <span class="o">=</span> <span class="p">((</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="o">?</span> <span class="n">HZ</span> <span class="o">:</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">15</span><span class="p">;</span>	<span class="cm">/* 15 seconds */</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">state</span> <span class="o">=</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="n">MPI_IOC_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cntdn</span><span class="o">--</span><span class="p">;</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cntdn</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">!=</span> <span class="n">CAN_SLEEP</span><span class="p">)</span>
				<span class="n">count</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
			    <span class="s">&quot;Wait IOC_READY state (0x%x) timeout(%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">count</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="n">HZ</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mdelay</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* 1 msec delay */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* TODO!</span>
<span class="cm">	 *  Cleanup all event stuff for this IOC; re-issue EventNotification</span>
<span class="cm">	 *  request if needed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">Function</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">EventState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	initChainBuffers - Allocate memory for and initialize chain buffers</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Allocates memory for and initializes chain buffers,</span>
<span class="cm"> *	chain buffer control arrays and spinlock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">initChainBuffers</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>		<span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">sz</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">num_chain</span><span class="p">;</span>
	<span class="kt">int</span> 		<span class="n">scale</span><span class="p">,</span> <span class="n">num_sge</span><span class="p">,</span> <span class="n">numSGE</span><span class="p">;</span>

	<span class="cm">/* ReqToChain size must equal the req_depth</span>
<span class="cm">	 * index = req_idx</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ReqToChain</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ReqToChain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">mem</span><span class="p">;</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;ReqToChain alloc  @ %p, sz=%d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">sz</span><span class="p">));</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">RequestNB</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">mem</span><span class="p">;</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;RequestNB alloc  @ %p, sz=%d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">sz</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ReqToChain</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPT_HOST_NO_CHAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ChainToChain size must equal the total number</span>
<span class="cm">	 * of chain buffers to be allocated.</span>
<span class="cm">	 * index = chain_idx</span>
<span class="cm">	 *</span>
<span class="cm">	 * Calculate the number of chain buffers needed(plus 1) per I/O</span>
<span class="cm">	 * then multiply the maximum number of simultaneous cmds</span>
<span class="cm">	 *</span>
<span class="cm">	 * num_sge = num sge in request frame + last chain buffer</span>
<span class="cm">	 * scale = num sge per chain buffer if no chain element</span>
<span class="cm">	 */</span>
	<span class="n">scale</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sg_addr_size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span>
		<span class="n">num_sge</span> <span class="o">=</span>  <span class="n">scale</span> <span class="o">+</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">-</span> <span class="mi">60</span><span class="p">)</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">num_sge</span> <span class="o">=</span>  <span class="mi">1</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">+</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">-</span> <span class="mi">64</span><span class="p">)</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sg_addr_size</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">numSGE</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxChainDepth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">scale</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">-</span> <span class="mi">60</span><span class="p">)</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">numSGE</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">scale</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxChainDepth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
		    <span class="n">scale</span> <span class="o">+</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">-</span> <span class="mi">64</span><span class="p">)</span> <span class="o">/</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">SGE_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;num_sge=%d numSGE=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">num_sge</span><span class="p">,</span> <span class="n">numSGE</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">numSGE</span> <span class="o">&gt;</span> <span class="n">MPT_SCSI_FC_SG_DEPTH</span><span class="p">)</span>
			<span class="n">numSGE</span> <span class="o">=</span> <span class="n">MPT_SCSI_FC_SG_DEPTH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">numSGE</span> <span class="o">&gt;</span> <span class="n">MPT_SCSI_SG_DEPTH</span><span class="p">)</span>
			<span class="n">numSGE</span> <span class="o">=</span> <span class="n">MPT_SCSI_SG_DEPTH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">num_chain</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">numSGE</span> <span class="o">-</span> <span class="n">num_sge</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_chain</span><span class="o">++</span><span class="p">;</span>
		<span class="n">num_sge</span> <span class="o">+=</span> <span class="p">(</span><span class="n">scale</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">num_chain</span><span class="o">++</span><span class="p">;</span>

	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Now numSGE=%d num_sge=%d num_chain=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">numSGE</span><span class="p">,</span> <span class="n">num_sge</span><span class="p">,</span> <span class="n">num_chain</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SPI</span><span class="p">)</span>
		<span class="n">num_chain</span> <span class="o">*=</span> <span class="n">MPT_SCSI_CAN_QUEUE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">SAS</span><span class="p">)</span>
		<span class="n">num_chain</span> <span class="o">*=</span> <span class="n">MPT_SAS_CAN_QUEUE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">num_chain</span> <span class="o">*=</span> <span class="n">MPT_FC_CAN_QUEUE</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">num_chain</span> <span class="o">=</span> <span class="n">num_chain</span><span class="p">;</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="n">num_chain</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainToChain</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainToChain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">mem</span><span class="p">;</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;ChainToChain alloc @ %p, sz=%d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">sz</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainToChain</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">num_chain</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	PrimeIocFifos - Initialize IOC request and reply FIFOs.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine allocates memory for the MPT reply and request frame</span>
<span class="cm"> *	pools (if necessary), and primes the IOC reply FIFO with</span>
<span class="cm"> *	reply frames.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">PrimeIocFifos</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">alloc_dma</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">reply_sz</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">total_size</span><span class="p">,</span> <span class="n">num_chain</span><span class="p">;</span>
	<span class="n">u64</span>	<span class="n">dma_mask</span><span class="p">;</span>

	<span class="n">dma_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*  Prime reply FIFO...  */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_frames</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">num_chain</span> <span class="o">=</span> <span class="n">initChainBuffers</span><span class="p">(</span><span class="n">ioc</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * 1078 errata workaround for the 36GB limitation</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">MPI_MANUFACTPAGE_DEVID_SAS1078</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">&gt;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">35</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			    <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">35</span><span class="p">);</span>
				<span class="n">d36memprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
				    <span class="s">&quot;setting 35 bit addressing for &quot;</span>
				    <span class="s">&quot;Request/Reply/Chain and Sense Buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*Reseting DMA mask to 64 bit*/</span>
				<span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					<span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
				<span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					<span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>

				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span>
				    <span class="s">&quot;failed setting 35 bit addressing for &quot;</span>
				    <span class="s">&quot;Request/Reply/Chain and Sense Buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">total_size</span> <span class="o">=</span> <span class="n">reply_sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_depth</span><span class="p">);</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;ReplyBuffer sz=%d bytes, ReplyDepth=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_depth</span><span class="p">));</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;ReplyBuffer sz=%d[%x] bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">reply_sz</span><span class="p">,</span> <span class="n">reply_sz</span><span class="p">));</span>

		<span class="n">sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">);</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;RequestBuffer sz=%d bytes, RequestDepth=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">));</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;RequestBuffer sz=%d[%x] bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">sz</span><span class="p">));</span>
		<span class="n">total_size</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>

		<span class="n">sz</span> <span class="o">=</span> <span class="n">num_chain</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">;</span> <span class="cm">/* chain buffer pool size */</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;ChainBuffer sz=%d bytes, ChainDepth=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">,</span> <span class="n">num_chain</span><span class="p">));</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;ChainBuffer sz=%d[%x] bytes num_chain=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">num_chain</span><span class="p">));</span>

		<span class="n">total_size</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">total_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alloc_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Unable to allocate Reply, Request, Chain Buffers!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Total alloc @ %p[%p], sz=%d[%x] bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">ulong</span><span class="p">)</span><span class="n">alloc_dma</span><span class="p">,</span> <span class="n">total_size</span><span class="p">,</span> <span class="n">total_size</span><span class="p">));</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">total_size</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span> <span class="o">+=</span> <span class="n">total_size</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_dma</span> <span class="o">=</span> <span class="n">alloc_dma</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_sz</span> <span class="o">=</span> <span class="n">total_size</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_frames</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="p">)</span> <span class="n">mem</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_frames_low_dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">alloc_dma</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>

		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;ReplyBuffers @ %p[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_frames</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">ulong</span><span class="p">)</span><span class="n">alloc_dma</span><span class="p">));</span>

		<span class="n">alloc_dma</span> <span class="o">+=</span> <span class="n">reply_sz</span><span class="p">;</span>
		<span class="n">mem</span> <span class="o">+=</span> <span class="n">reply_sz</span><span class="p">;</span>

		<span class="cm">/*  Request FIFO - WE manage this!  */</span>

		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="p">)</span> <span class="n">mem</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames_dma</span> <span class="o">=</span> <span class="n">alloc_dma</span><span class="p">;</span>

		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;RequestBuffers @ %p[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">ulong</span><span class="p">)</span><span class="n">alloc_dma</span><span class="p">));</span>

		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames_low_dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">alloc_dma</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_MTRR) &amp;&amp; 0</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Enable Write Combining MTRR for IOC&#39;s memory region.</span>
<span class="cm">		 *  (at least as much as we can; &quot;size and base must be</span>
<span class="cm">		 *  multiples of 4 kiB&quot;</span>
<span class="cm">		 */</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mtrr_reg</span> <span class="o">=</span> <span class="n">mtrr_add</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames_dma</span><span class="p">,</span>
					 <span class="n">sz</span><span class="p">,</span>
					 <span class="n">MTRR_TYPE_WRCOMB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;MTRR region registered (base:size=%08x:%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames_dma</span><span class="p">,</span> <span class="n">sz</span><span class="p">));</span>
<span class="cp">#endif</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">alloc_dma</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">;</span>
			<span class="n">mem</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainBuffer</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainBufferDMA</span> <span class="o">=</span> <span class="n">alloc_dma</span><span class="p">;</span>

		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;ChainBuffers @ %p(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainBuffer</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">ulong</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainBufferDMA</span><span class="p">));</span>

		<span class="cm">/* Initialize the free chain Q.</span>
<span class="cm">	 	*/</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeChainQ</span><span class="p">);</span>

		<span class="cm">/* Post the chain buffers to the FreeChainQ.</span>
<span class="cm">	 	*/</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ChainBuffer</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_chain</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mf</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="p">)</span> <span class="n">mem</span><span class="p">;</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">linkage</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeChainQ</span><span class="p">);</span>
			<span class="n">mem</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Initialize Request frames linked list</span>
<span class="cm">		 */</span>
		<span class="n">alloc_dma</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames_dma</span><span class="p">;</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQ</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mf</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="p">)</span> <span class="n">mem</span><span class="p">;</span>

			<span class="cm">/*  Queue REQUESTs *internally*!  */</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">linkage</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQ</span><span class="p">);</span>

			<span class="n">mem</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FreeQlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span> <span class="o">*</span> <span class="n">MPT_SENSE_BUFFER_ALLOC</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool</span> <span class="o">=</span>
			<span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Unable to allocate Sense Buffers!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_low_dma</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool_dma</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>
		<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;SenseBuffers @ %p[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
 			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">ulong</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool_dma</span><span class="p">));</span>

	<span class="p">}</span>

	<span class="cm">/* Post Reply frames to FIFO</span>
<span class="cm">	 */</span>
	<span class="n">alloc_dma</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_dma</span><span class="p">;</span>
	<span class="n">dinitprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;ReplyBuffers @ %p[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	 	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_frames</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">ulong</span><span class="p">)</span><span class="n">alloc_dma</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  Write each address to the IOC!  */</span>
		<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ReplyFifo</span><span class="p">,</span> <span class="n">alloc_dma</span><span class="p">);</span>
		<span class="n">alloc_dma</span> <span class="o">+=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mask</span> <span class="o">==</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">))</span>
		<span class="n">d36memprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;restoring 64 bit addressing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_fail:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_sz</span><span class="p">;</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				<span class="n">sz</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_dma</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_frames</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span> <span class="o">-=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span> <span class="o">*</span> <span class="n">MPT_SENSE_BUFFER_ALLOC</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				<span class="n">sz</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool_dma</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">sense_buf_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mask</span> <span class="o">==</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
	    <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
	    <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span>
		<span class="n">d36memprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;restoring 64 bit addressing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_handshake_req_reply_wait - Send MPT request to and receive reply</span>
<span class="cm"> *	from IOC via doorbell handshake method.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@reqBytes: Size of the request in bytes</span>
<span class="cm"> *	@req: Pointer to MPT request frame</span>
<span class="cm"> *	@replyBytes: Expected size of the reply in bytes</span>
<span class="cm"> *	@u16reply: Pointer to area where reply should be written</span>
<span class="cm"> *	@maxwait: Max wait time for a reply (in seconds)</span>
<span class="cm"> *	@sleepFlag: Specifies whether the process can sleep</span>
<span class="cm"> *</span>
<span class="cm"> *	NOTES: It is the callers responsibility to byte-swap fields in the</span>
<span class="cm"> *	request which are greater than 1 byte in size.  It is also the</span>
<span class="cm"> *	callers responsibility to byte-swap response fields which are</span>
<span class="cm"> *	greater than 1 byte in size.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpt_handshake_req_reply_wait</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reqBytes</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">replyBytes</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">u16reply</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxwait</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPIDefaultReply_t</span> <span class="o">*</span><span class="n">mptReply</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">failcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get ready to cache a handshake reply</span>
<span class="cm">	 */</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hs_reply_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mptReply</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPIDefaultReply_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hs_reply</span><span class="p">;</span>
	<span class="n">mptReply</span><span class="o">-&gt;</span><span class="n">MsgLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure there are no doorbells (WRITE 0 to IntStatus reg),</span>
<span class="cm">	 * then tell IOC that we want to handshake a request of N words.</span>
<span class="cm">	 * (WRITE u32val to Doorbell reg).</span>
<span class="cm">	 */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">,</span>
			<span class="p">((</span><span class="n">MPI_FUNCTION_HANDSHAKE</span><span class="o">&lt;&lt;</span><span class="n">MPI_DOORBELL_FUNCTION_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">((</span><span class="n">reqBytes</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="n">MPI_DOORBELL_ADD_DWORDS_SHIFT</span><span class="p">)));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for IOC&#39;s doorbell handshake int</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">WaitForDoorbellInt</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">failcnt</span><span class="o">++</span><span class="p">;</span>

	<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;HandShake request start reqBytes=%d, WaitCnt=%d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">reqBytes</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">failcnt</span> <span class="o">?</span> <span class="s">&quot; - MISSING DOORBELL HANDSHAKE!&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>

	<span class="cm">/* Read doorbell and check for active bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_DOORBELL_ACTIVE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear doorbell int (WRITE 0 to IntStatus reg),</span>
<span class="cm">	 * then wait for IOC to ACKnowledge that it&#39;s ready for</span>
<span class="cm">	 * our handshake request.</span>
<span class="cm">	 */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">failcnt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">WaitForDoorbellAck</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">failcnt</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">failcnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>	 <span class="n">ii</span><span class="p">;</span>
		<span class="n">u8</span>	<span class="o">*</span><span class="n">req_as_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">req</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Stuff request words via doorbell handshake,</span>
<span class="cm">		 * with ACK from IOC for each.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">failcnt</span> <span class="o">&amp;&amp;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">reqBytes</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">word</span> <span class="o">=</span> <span class="p">((</span><span class="n">req_as_bytes</span><span class="p">[(</span><span class="n">ii</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">(</span><span class="n">req_as_bytes</span><span class="p">[(</span><span class="n">ii</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">(</span><span class="n">req_as_bytes</span><span class="p">[(</span><span class="n">ii</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">(</span><span class="n">req_as_bytes</span><span class="p">[(</span><span class="n">ii</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>

			<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">WaitForDoorbellAck</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">failcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Handshake request frame (@%p) header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">req</span><span class="p">));</span>
		<span class="n">DBG_DUMP_REQUEST_FRAME_HDR</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="p">);</span>

		<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;HandShake request post done, WaitCnt=%d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">failcnt</span> <span class="o">?</span> <span class="s">&quot; - MISSING DOORBELL ACK!&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * Wait for completion of doorbell handshake reply from the IOC</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">failcnt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">WaitForDoorbellReply</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">maxwait</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">failcnt</span><span class="o">++</span><span class="p">;</span>

		<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;HandShake reply count=%d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">failcnt</span> <span class="o">?</span> <span class="s">&quot; - MISSING DOORBELL REPLY!&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * Copy out the cached reply...</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">(</span><span class="n">replyBytes</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">mptReply</span><span class="o">-&gt;</span><span class="n">MsgLength</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
			<span class="n">u16reply</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hs_reply</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">99</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">failcnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	WaitForDoorbellAck - Wait for IOC doorbell handshake acknowledge</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@howlong: How long to wait (in seconds)</span>
<span class="cm"> *	@sleepFlag: Specifies whether the process can sleep</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine waits (up to ~2 seconds max) for IOC doorbell</span>
<span class="cm"> *	handshake ACKnowledge, indicated by the IOP_DOORBELL_STATUS</span>
<span class="cm"> *	bit in its IntStatus register being clear.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns a negative value on failure, else wait loop count.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">WaitForDoorbellAck</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">howlong</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cntdn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intstat</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">cntdn</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">howlong</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">cntdn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">intstat</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">MPI_HIS_IOP_DOORBELL_STATUS</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">cntdn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span> <span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
			<span class="n">intstat</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">MPI_HIS_IOP_DOORBELL_STATUS</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cntdn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;WaitForDoorbell ACK (count=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Doorbell ACK timeout (count=%d), IntStatus=%x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">intstat</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	WaitForDoorbellInt - Wait for IOC to set its doorbell interrupt bit</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@howlong: How long to wait (in seconds)</span>
<span class="cm"> *	@sleepFlag: Specifies whether the process can sleep</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine waits (up to ~2 seconds max) for IOC doorbell interrupt</span>
<span class="cm"> *	(MPI_HIS_DOORBELL_INTERRUPT) to be set in the IntStatus register.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns a negative value on failure, else wait loop count.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">WaitForDoorbellInt</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">howlong</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cntdn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intstat</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">cntdn</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">howlong</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">cntdn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">intstat</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">MPI_HIS_DOORBELL_INTERRUPT</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">cntdn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">intstat</span> <span class="o">=</span> <span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span> <span class="o">&amp;</span> <span class="n">MPI_HIS_DOORBELL_INTERRUPT</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span> <span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cntdn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;WaitForDoorbell INT (cnt=%d) howlong=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">howlong</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Doorbell INT timeout (count=%d), IntStatus=%x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">intstat</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	WaitForDoorbellReply - Wait for and capture an IOC handshake reply.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@howlong: How long to wait (in seconds)</span>
<span class="cm"> *	@sleepFlag: Specifies whether the process can sleep</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine polls the IOC for a handshake reply, 16 bits at a time.</span>
<span class="cm"> *	Reply is cached to IOC private area large enough to hold a maximum</span>
<span class="cm"> *	of 128 bytes of reply data.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns a negative value on failure, else size of reply in WORDS.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">WaitForDoorbellReply</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">howlong</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">u16cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">failcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">hs_reply</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hs_reply</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">MPIDefaultReply_t</span> <span class="o">*</span><span class="n">mptReply</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPIDefaultReply_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hs_reply</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hword</span><span class="p">;</span>

	<span class="n">hs_reply</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hs_reply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hs_reply</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get first two u16&#39;s so we can look at IOC&#39;s intended reply MsgLength</span>
<span class="cm">	 */</span>
	<span class="n">u16cnt</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">WaitForDoorbellInt</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">howlong</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">failcnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hs_reply</span><span class="p">[</span><span class="n">u16cnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
		<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">WaitForDoorbellInt</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">failcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">hs_reply</span><span class="p">[</span><span class="n">u16cnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
			<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;WaitCnt=%d First handshake reply word=%08x%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">hs_reply</span><span class="p">),</span>
			<span class="n">failcnt</span> <span class="o">?</span> <span class="s">&quot; - MISSING DOORBELL HANDSHAKE!&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * If no error (and IOC said MsgLength is &gt; 0), piece together</span>
<span class="cm">	 * reply 16 bits at a time.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">u16cnt</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span> <span class="o">!</span><span class="n">failcnt</span> <span class="o">&amp;&amp;</span> <span class="n">u16cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">mptReply</span><span class="o">-&gt;</span><span class="n">MsgLength</span><span class="p">);</span> <span class="n">u16cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">t</span> <span class="o">=</span> <span class="n">WaitForDoorbellInt</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">failcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">hword</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">CHIPREG_READ32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
		<span class="cm">/* don&#39;t overflow our IOC hs_reply[] buffer! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">u16cnt</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hs_reply</span><span class="p">))</span>
			<span class="n">hs_reply</span><span class="p">[</span><span class="n">u16cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">hword</span><span class="p">;</span>
		<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">failcnt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">WaitForDoorbellInt</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">failcnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntStatus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">failcnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;Handshake reply failure!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">failcnt</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	else if (u16cnt != (2 * mptReply-&gt;MsgLength)) {</span>
<span class="c">		return -101;</span>
<span class="c">	}</span>
<span class="c">	else if ((mptReply-&gt;IOCStatus &amp; MPI_IOCSTATUS_MASK) != MPI_IOCSTATUS_SUCCESS) {</span>
<span class="c">		return -102;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Got Handshake reply:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">DBG_DUMP_REPLY_FRAME</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">mptReply</span><span class="p">);</span>

	<span class="n">dhsprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;WaitForDoorbell REPLY WaitCnt=%d (sz=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">u16cnt</span><span class="o">/</span><span class="mi">2</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">u16cnt</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	GetLanConfigPages - Fetch LANConfig pages.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Return: 0 for success</span>
<span class="cm"> *	-ENOMEM if no memory available</span>
<span class="cm"> *		-EPERM if not allowed due to ISR context</span>
<span class="cm"> *		-EAGAIN if no msg frames currently available</span>
<span class="cm"> *		-EFAULT for non-successful reply or no reply (timeout)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">GetLanConfigPages</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ConfigPageHeader_t</span>	 <span class="n">hdr</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span>		 <span class="n">cfg</span><span class="p">;</span>
	<span class="n">LANPage0_t</span>		<span class="o">*</span><span class="n">ppage0_alloc</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		 <span class="n">page0_dma</span><span class="p">;</span>
	<span class="n">LANPage1_t</span>		<span class="o">*</span><span class="n">ppage1_alloc</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		 <span class="n">page1_dma</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">data_sz</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">copy_sz</span><span class="p">;</span>

	<span class="cm">/* Get LAN Page 0 header */</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_LAN</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data_sz</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ppage0_alloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">LANPage0_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page0_dma</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppage0_alloc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ppage0_alloc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">);</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">page0_dma</span><span class="p">;</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* save the data */</span>
				<span class="n">copy_sz</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LANPage0_t</span><span class="p">),</span> <span class="n">data_sz</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">lan_cnfg_page0</span><span class="p">,</span> <span class="n">ppage0_alloc</span><span class="p">,</span> <span class="n">copy_sz</span><span class="p">);</span>

			<span class="p">}</span>

			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppage0_alloc</span><span class="p">,</span> <span class="n">page0_dma</span><span class="p">);</span>

			<span class="cm">/* FIXME!</span>
<span class="cm">			 *	Normalize endianness of structure data,</span>
<span class="cm">			 *	by byte-swapping all &gt; 1 byte fields!</span>
<span class="cm">			 */</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get LAN Page 1 header */</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_LAN</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">data_sz</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ppage1_alloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">LANPage1_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page1_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppage1_alloc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ppage1_alloc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">);</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">page1_dma</span><span class="p">;</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* save the data */</span>
			<span class="n">copy_sz</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LANPage1_t</span><span class="p">),</span> <span class="n">data_sz</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">lan_cnfg_page1</span><span class="p">,</span> <span class="n">ppage1_alloc</span><span class="p">,</span> <span class="n">copy_sz</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppage1_alloc</span><span class="p">,</span> <span class="n">page1_dma</span><span class="p">);</span>

		<span class="cm">/* FIXME!</span>
<span class="cm">		 *	Normalize endianness of structure data,</span>
<span class="cm">		 *	by byte-swapping all &gt; 1 byte fields!</span>
<span class="cm">		 */</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mptbase_sas_persist_operation - Perform operation on SAS Persistent Table</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@persist_opcode: see below</span>
<span class="cm"> *</span>
<span class="cm"> *	MPI_SAS_OP_CLEAR_NOT_PRESENT - Free all persist TargetID mappings for</span>
<span class="cm"> *		devices not currently present.</span>
<span class="cm"> *	MPI_SAS_OP_CLEAR_ALL_PERSISTENT - Clear al persist TargetID mappings</span>
<span class="cm"> *</span>
<span class="cm"> *	NOTE: Don&#39;t use not this function during interrupt time.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero error</span>
<span class="cm"> */</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="kt">int</span>
<span class="nf">mptbase_sas_persist_operation</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">persist_opcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SasIoUnitControlRequest_t</span>	<span class="o">*</span><span class="n">sasIoUnitCntrReq</span><span class="p">;</span>
	<span class="n">SasIoUnitControlReply_t</span>		<span class="o">*</span><span class="n">sasIoUnitCntrReply</span><span class="p">;</span>
	<span class="n">MPT_FRAME_HDR</span>			<span class="o">*</span><span class="n">mf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">MPIHeader_t</span>			<span class="o">*</span><span class="n">mpi_hdr</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> 	 		<span class="n">timeleft</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* init the internal cmd struct */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">MPT_DEFAULT_FRAME_SIZE</span><span class="p">);</span>
	<span class="n">INITIALIZE_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>

	<span class="cm">/* insure garbage is not sent to fw */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">persist_opcode</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">MPI_SAS_OP_CLEAR_NOT_PRESENT</span>:
	<span class="k">case</span> <span class="n">MPI_SAS_OP_CLEAR_ALL_PERSISTENT</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>  <span class="s">&quot;%s: persist_opcode=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">persist_opcode</span><span class="p">);</span>

	<span class="cm">/* Get a MF for this command.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">mpt_base_index</span><span class="p">,</span> <span class="n">ioc</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: no msg frames!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="n">mpi_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">MPIHeader_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mf</span><span class="p">;</span>
	<span class="n">sasIoUnitCntrReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">SasIoUnitControlRequest_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sasIoUnitCntrReq</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">SasIoUnitControlRequest_t</span><span class="p">));</span>
	<span class="n">sasIoUnitCntrReq</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_SAS_IO_UNIT_CONTROL</span><span class="p">;</span>
	<span class="n">sasIoUnitCntrReq</span><span class="o">-&gt;</span><span class="n">MsgContext</span> <span class="o">=</span> <span class="n">mpi_hdr</span><span class="o">-&gt;</span><span class="n">MsgContext</span><span class="p">;</span>
	<span class="n">sasIoUnitCntrReq</span><span class="o">-&gt;</span><span class="n">Operation</span> <span class="o">=</span> <span class="n">persist_opcode</span><span class="p">;</span>

	<span class="n">mpt_put_msg_frame</span><span class="p">(</span><span class="n">mpt_base_index</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeleft</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
			       <span class="s">&quot;Issuing Reset from %s!!, doorbell=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
			<span class="n">mpt_Soft_Hard_ResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>
			<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sasIoUnitCntrReply</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">SasIoUnitControlReply_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">sasIoUnitCntrReply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MPI_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: IOCStatus=0x%X IOCLogInfo=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">sasIoUnitCntrReply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">,</span>
		    <span class="n">sasIoUnitCntrReply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
 <span class="nl">out:</span>

	<span class="n">CLEAR_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mptbase_raid_process_event_data</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span>
    <span class="n">MpiEventDataRaid_t</span> <span class="o">*</span> <span class="n">pRaidEventData</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> 	<span class="n">volume</span><span class="p">;</span>
	<span class="kt">int</span> 	<span class="n">reason</span><span class="p">;</span>
	<span class="kt">int</span> 	<span class="n">disk</span><span class="p">;</span>
	<span class="kt">int</span> 	<span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> 	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> 	<span class="n">state</span><span class="p">;</span>

	<span class="n">volume</span>	<span class="o">=</span> <span class="n">pRaidEventData</span><span class="o">-&gt;</span><span class="n">VolumeID</span><span class="p">;</span>
	<span class="n">reason</span>	<span class="o">=</span> <span class="n">pRaidEventData</span><span class="o">-&gt;</span><span class="n">ReasonCode</span><span class="p">;</span>
	<span class="n">disk</span>	<span class="o">=</span> <span class="n">pRaidEventData</span><span class="o">-&gt;</span><span class="n">PhysDiskNum</span><span class="p">;</span>
	<span class="n">status</span>	<span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pRaidEventData</span><span class="o">-&gt;</span><span class="n">SettingsStatus</span><span class="p">);</span>
	<span class="n">flags</span>	<span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">state</span>	<span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">MPI_EVENT_RAID_RC_DOMAIN_VAL_NEEDED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">reason</span> <span class="o">&gt;=</span> <span class="n">MPI_EVENT_RAID_RC_PHYSDISK_CREATED</span> <span class="o">&amp;&amp;</span>
	     <span class="n">reason</span> <span class="o">&lt;=</span> <span class="n">MPI_EVENT_RAID_RC_PHYSDISK_STATUS_CHANGED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">MPI_EVENT_RAID_RC_SMART_DATA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;RAID STATUS CHANGE for PhysDisk %d id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="n">volume</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;RAID STATUS CHANGE for VolumeID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">volume</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_VOLUME_CREATED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;  volume has been created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_VOLUME_DELETED</span>:

		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;  volume has been deleted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_VOLUME_SETTINGS_CHANGED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;  volume settings have been changed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_VOLUME_STATUS_CHANGED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;  volume is now %s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">state</span> <span class="o">==</span> <span class="n">MPI_RAIDVOL0_STATUS_STATE_OPTIMAL</span>
			 <span class="o">?</span> <span class="s">&quot;optimal&quot;</span>
			 <span class="o">:</span> <span class="n">state</span> <span class="o">==</span> <span class="n">MPI_RAIDVOL0_STATUS_STATE_DEGRADED</span>
			  <span class="o">?</span> <span class="s">&quot;degraded&quot;</span>
			  <span class="o">:</span> <span class="n">state</span> <span class="o">==</span> <span class="n">MPI_RAIDVOL0_STATUS_STATE_FAILED</span>
			   <span class="o">?</span> <span class="s">&quot;failed&quot;</span>
			   <span class="o">:</span> <span class="s">&quot;state unknown&quot;</span><span class="p">,</span>
			<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPI_RAIDVOL0_STATUS_FLAG_ENABLED</span>
			 <span class="o">?</span> <span class="s">&quot;, enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPI_RAIDVOL0_STATUS_FLAG_QUIESCED</span>
			 <span class="o">?</span> <span class="s">&quot;, quiesced&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPI_RAIDVOL0_STATUS_FLAG_RESYNC_IN_PROGRESS</span>
			 <span class="o">?</span> <span class="s">&quot;, resync in progress&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span> <span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_VOLUME_PHYSDISK_CHANGED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;  volume membership of PhysDisk %d has changed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">disk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_PHYSDISK_CREATED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;  PhysDisk has been created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_PHYSDISK_DELETED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;  PhysDisk has been deleted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_PHYSDISK_SETTINGS_CHANGED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;  PhysDisk settings have been changed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_PHYSDISK_STATUS_CHANGED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;  PhysDisk is now %s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">state</span> <span class="o">==</span> <span class="n">MPI_PHYSDISK0_STATUS_ONLINE</span>
			 <span class="o">?</span> <span class="s">&quot;online&quot;</span>
			 <span class="o">:</span> <span class="n">state</span> <span class="o">==</span> <span class="n">MPI_PHYSDISK0_STATUS_MISSING</span>
			  <span class="o">?</span> <span class="s">&quot;missing&quot;</span>
			  <span class="o">:</span> <span class="n">state</span> <span class="o">==</span> <span class="n">MPI_PHYSDISK0_STATUS_NOT_COMPATIBLE</span>
			   <span class="o">?</span> <span class="s">&quot;not compatible&quot;</span>
			   <span class="o">:</span> <span class="n">state</span> <span class="o">==</span> <span class="n">MPI_PHYSDISK0_STATUS_FAILED</span>
			    <span class="o">?</span> <span class="s">&quot;failed&quot;</span>
			    <span class="o">:</span> <span class="n">state</span> <span class="o">==</span> <span class="n">MPI_PHYSDISK0_STATUS_INITIALIZING</span>
			     <span class="o">?</span> <span class="s">&quot;initializing&quot;</span>
			     <span class="o">:</span> <span class="n">state</span> <span class="o">==</span> <span class="n">MPI_PHYSDISK0_STATUS_OFFLINE_REQUESTED</span>
			      <span class="o">?</span> <span class="s">&quot;offline requested&quot;</span>
			      <span class="o">:</span> <span class="n">state</span> <span class="o">==</span> <span class="n">MPI_PHYSDISK0_STATUS_FAILED_REQUESTED</span>
			       <span class="o">?</span> <span class="s">&quot;failed requested&quot;</span>
			       <span class="o">:</span> <span class="n">state</span> <span class="o">==</span> <span class="n">MPI_PHYSDISK0_STATUS_OTHER_OFFLINE</span>
			        <span class="o">?</span> <span class="s">&quot;offline&quot;</span>
			        <span class="o">:</span> <span class="s">&quot;state unknown&quot;</span><span class="p">,</span>
			<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPI_PHYSDISK0_STATUS_FLAG_OUT_OF_SYNC</span>
			 <span class="o">?</span> <span class="s">&quot;, out of sync&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPI_PHYSDISK0_STATUS_FLAG_QUIESCED</span>
			 <span class="o">?</span> <span class="s">&quot;, quiesced&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span> <span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_DOMAIN_VAL_NEEDED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;  Domain Validation needed for PhysDisk %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">disk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_SMART_DATA</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;  SMART data received, ASC/ASCQ = %02xh/%02xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pRaidEventData</span><span class="o">-&gt;</span><span class="n">ASC</span><span class="p">,</span> <span class="n">pRaidEventData</span><span class="o">-&gt;</span><span class="n">ASCQ</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_REPLACE_ACTION_STARTED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;  replacement of PhysDisk %d has started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">disk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	GetIoUnitPage2 - Retrieve BIOS version and boot order information.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns: 0 for success</span>
<span class="cm"> *	-ENOMEM if no memory available</span>
<span class="cm"> *		-EPERM if not allowed due to ISR context</span>
<span class="cm"> *		-EAGAIN if no msg frames currently available</span>
<span class="cm"> *		-EFAULT for non-successful reply or no reply (timeout)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">GetIoUnitPage2</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ConfigPageHeader_t</span>	 <span class="n">hdr</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span>		 <span class="n">cfg</span><span class="p">;</span>
	<span class="n">IOUnitPage2_t</span>		<span class="o">*</span><span class="n">ppage_alloc</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		 <span class="n">page_dma</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">data_sz</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Get the page header */</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_IO_UNIT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Read the config page */</span>
	<span class="n">data_sz</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ppage_alloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">IOUnitPage2_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">page_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppage_alloc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">ppage_alloc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">);</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">page_dma</span><span class="p">;</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

		<span class="cm">/* If Good, save data */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">biosVersion</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ppage_alloc</span><span class="o">-&gt;</span><span class="n">BiosVersion</span><span class="p">);</span>

		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">data_sz</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ppage_alloc</span><span class="p">,</span> <span class="n">page_dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_GetScsiPortSettings - read SCSI Port Page 0 and 2</span>
<span class="cm"> *	@ioc: Pointer to a Adapter Strucutre</span>
<span class="cm"> *	@portnum: IOC port number</span>
<span class="cm"> *</span>
<span class="cm"> *	Return: -EFAULT if read of config page header fails</span>
<span class="cm"> *			or if no nvram</span>
<span class="cm"> *	If read of SCSI Port Page 0 fails,</span>
<span class="cm"> *		NVRAM = MPT_HOST_NVRAM_INVALID  (0xFFFFFFFF)</span>
<span class="cm"> *		Adapter settings: async, narrow</span>
<span class="cm"> *		Return 1</span>
<span class="cm"> *	If read of SCSI Port Page 2 fails,</span>
<span class="cm"> *		Adapter settings valid</span>
<span class="cm"> *		NVRAM = MPT_HOST_NVRAM_INVALID  (0xFFFFFFFF)</span>
<span class="cm"> *		Return 1</span>
<span class="cm"> *	Else</span>
<span class="cm"> *		Both valid</span>
<span class="cm"> *		Return 0</span>
<span class="cm"> *	CHECK - what type of locking mechanisms should be used????</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpt_GetScsiPortSettings</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>			<span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		 <span class="n">buf_dma</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span>		 <span class="n">cfg</span><span class="p">;</span>
	<span class="n">ConfigPageHeader_t</span>	 <span class="n">header</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">ii</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">data</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Allocate memory</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">nvram</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>	 <span class="n">sz</span><span class="p">;</span>
		<span class="n">u8</span>	<span class="o">*</span><span class="n">mem</span><span class="p">;</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="n">MPT_MAX_SCSI_DEVICES</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">nvram</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">mem</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;SCSI device NVRAM settings @ %p, sz=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">nvram</span><span class="p">,</span> <span class="n">sz</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Invalidate NVRAM information</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MPT_MAX_SCSI_DEVICES</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">nvram</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPT_HOST_NVRAM_INVALID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read SPP0 header, allocate memory, then read page.</span>
<span class="cm">	 */</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_SCSI_PORT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">portnum</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* use default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		 <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pbuf</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pbuf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">buf_dma</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">maxBusWidth</span> <span class="o">=</span> <span class="n">MPT_NARROW</span><span class="p">;</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">maxSyncOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">minSyncFactor</span> <span class="o">=</span> <span class="n">MPT_ASYNC</span><span class="p">;</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">busType</span> <span class="o">=</span> <span class="n">MPT_HOST_BUS_UNKNOWN</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ddvprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
					<span class="s">&quot;Unable to read PortPage0 minSyncFactor=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">minSyncFactor</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Save the Port Page 0 data</span>
<span class="cm">				 */</span>
				<span class="n">SCSIPortPage0_t</span>  <span class="o">*</span><span class="n">pPP0</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIPortPage0_t</span>  <span class="o">*</span><span class="p">)</span> <span class="n">pbuf</span><span class="p">;</span>
				<span class="n">pPP0</span><span class="o">-&gt;</span><span class="n">Capabilities</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPP0</span><span class="o">-&gt;</span><span class="n">Capabilities</span><span class="p">);</span>
				<span class="n">pPP0</span><span class="o">-&gt;</span><span class="n">PhysicalInterface</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPP0</span><span class="o">-&gt;</span><span class="n">PhysicalInterface</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">pPP0</span><span class="o">-&gt;</span><span class="n">Capabilities</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIPORTPAGE0_CAP_QAS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">noQas</span> <span class="o">|=</span> <span class="n">MPT_TARGET_NO_NEGO_QAS</span><span class="p">;</span>
					<span class="n">ddvprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
						<span class="s">&quot;noQas due to Capabilities=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pPP0</span><span class="o">-&gt;</span><span class="n">Capabilities</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">maxBusWidth</span> <span class="o">=</span> <span class="n">pPP0</span><span class="o">-&gt;</span><span class="n">Capabilities</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIPORTPAGE0_CAP_WIDE</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">pPP0</span><span class="o">-&gt;</span><span class="n">Capabilities</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIPORTPAGE0_CAP_MAX_SYNC_OFFSET_MASK</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">maxSyncOffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
					<span class="n">data</span> <span class="o">=</span> <span class="n">pPP0</span><span class="o">-&gt;</span><span class="n">Capabilities</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIPORTPAGE0_CAP_MIN_SYNC_PERIOD_MASK</span><span class="p">;</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">minSyncFactor</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
					<span class="n">ddvprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
						<span class="s">&quot;PortPage0 minSyncFactor=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">minSyncFactor</span><span class="p">));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">maxSyncOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">minSyncFactor</span> <span class="o">=</span> <span class="n">MPT_ASYNC</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">busType</span> <span class="o">=</span> <span class="n">pPP0</span><span class="o">-&gt;</span><span class="n">PhysicalInterface</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIPORTPAGE0_PHY_SIGNAL_TYPE_MASK</span><span class="p">;</span>

				<span class="cm">/* Update the minSyncFactor based on bus type.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">busType</span> <span class="o">==</span> <span class="n">MPI_SCSIPORTPAGE0_PHY_SIGNAL_HVD</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">busType</span> <span class="o">==</span> <span class="n">MPI_SCSIPORTPAGE0_PHY_SIGNAL_SE</span><span class="p">))</span>  <span class="p">{</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">minSyncFactor</span> <span class="o">&lt;</span> <span class="n">MPT_ULTRA</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">minSyncFactor</span> <span class="o">=</span> <span class="n">MPT_ULTRA</span><span class="p">;</span>
						<span class="n">ddvprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
							<span class="s">&quot;HVD or SE detected, minSyncFactor=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">minSyncFactor</span><span class="p">));</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pbuf</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">,</span> <span class="n">buf_dma</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* SCSI Port Page 2 - Read the header then the page.</span>
<span class="cm">	 */</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_SCSI_PORT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">portnum</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Allocate memory and read SCSI Port Page 2</span>
<span class="cm">		 */</span>
		<span class="n">pbuf</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pbuf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_NVRAM</span><span class="p">;</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">buf_dma</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Nvram data is left with INVALID mark</span>
<span class="cm">				 */</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_ATTO</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* This is an ATTO adapter, read Page2 accordingly</span>
<span class="cm">				*/</span>
				<span class="n">ATTO_SCSIPortPage2_t</span> <span class="o">*</span><span class="n">pPP2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATTO_SCSIPortPage2_t</span>  <span class="o">*</span><span class="p">)</span> <span class="n">pbuf</span><span class="p">;</span>
				<span class="n">ATTODeviceInfo_t</span> <span class="o">*</span><span class="n">pdevice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">u16</span> <span class="n">ATTOFlags</span><span class="p">;</span>

				<span class="cm">/* Save the Port Page 2 data</span>
<span class="cm">				 * (reformat into a 32bit quantity)</span>
<span class="cm">				 */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MPT_MAX_SCSI_DEVICES</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				  <span class="n">pdevice</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pPP2</span><span class="o">-&gt;</span><span class="n">DeviceSettings</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
				  <span class="n">ATTOFlags</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pdevice</span><span class="o">-&gt;</span><span class="n">ATTOFlags</span><span class="p">);</span>
				  <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				  <span class="cm">/* Translate ATTO device flags to LSI format</span>
<span class="cm">				   */</span>
				  <span class="k">if</span> <span class="p">(</span><span class="n">ATTOFlags</span> <span class="o">&amp;</span> <span class="n">ATTOFLAG_DISC</span><span class="p">)</span>
				    <span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MPI_SCSIPORTPAGE2_DEVICE_DISCONNECT_ENABLE</span><span class="p">);</span>
				  <span class="k">if</span> <span class="p">(</span><span class="n">ATTOFlags</span> <span class="o">&amp;</span> <span class="n">ATTOFLAG_ID_ENB</span><span class="p">)</span>
				    <span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MPI_SCSIPORTPAGE2_DEVICE_ID_SCAN_ENABLE</span><span class="p">);</span>
				  <span class="k">if</span> <span class="p">(</span><span class="n">ATTOFlags</span> <span class="o">&amp;</span> <span class="n">ATTOFLAG_LUN_ENB</span><span class="p">)</span>
				    <span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MPI_SCSIPORTPAGE2_DEVICE_LUN_SCAN_ENABLE</span><span class="p">);</span>
				  <span class="k">if</span> <span class="p">(</span><span class="n">ATTOFlags</span> <span class="o">&amp;</span> <span class="n">ATTOFLAG_TAGGED</span><span class="p">)</span>
				    <span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MPI_SCSIPORTPAGE2_DEVICE_TAG_QUEUE_ENABLE</span><span class="p">);</span>
				  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ATTOFlags</span> <span class="o">&amp;</span> <span class="n">ATTOFLAG_WIDE_ENB</span><span class="p">))</span>
				    <span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MPI_SCSIPORTPAGE2_DEVICE_WIDE_DISABLE</span><span class="p">);</span>

				  <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pdevice</span><span class="o">-&gt;</span><span class="n">Period</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mi">10</span><span class="p">;</span>
				  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">nvram</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">SCSIPortPage2_t</span> <span class="o">*</span><span class="n">pPP2</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCSIPortPage2_t</span>  <span class="o">*</span><span class="p">)</span> <span class="n">pbuf</span><span class="p">;</span>
				<span class="n">MpiDeviceInfo_t</span>	<span class="o">*</span><span class="n">pdevice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * Save &quot;Set to Avoid SCSI Bus Resets&quot; flag</span>
<span class="cm">				 */</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">bus_reset</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPP2</span><span class="o">-&gt;</span><span class="n">PortFlags</span><span class="p">)</span> <span class="o">&amp;</span>
			        <span class="n">MPI_SCSIPORTPAGE2_PORT_FLAGS_AVOID_SCSI_RESET</span><span class="p">)</span> <span class="o">?</span>
				    <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">;</span>

				<span class="cm">/* Save the Port Page 2 data</span>
<span class="cm">				 * (reformat into a 32bit quantity)</span>
<span class="cm">				 */</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pPP2</span><span class="o">-&gt;</span><span class="n">PortFlags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_SCSIPORTPAGE2_PORT_FLAGS_DV_MASK</span><span class="p">;</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">PortFlags</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">MPT_MAX_SCSI_DEVICES</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pdevice</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pPP2</span><span class="o">-&gt;</span><span class="n">DeviceSettings</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
					<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pdevice</span><span class="o">-&gt;</span><span class="n">DeviceFlags</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
						<span class="p">(</span><span class="n">pdevice</span><span class="o">-&gt;</span><span class="n">SyncFactor</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pdevice</span><span class="o">-&gt;</span><span class="n">Timeout</span><span class="p">;</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">nvram</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">,</span> <span class="n">buf_dma</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Update Adapter limits with those from NVRAM</span>
<span class="cm">	 * Comment: Don&#39;t need to do this. Target performance</span>
<span class="cm">	 * parameters will never exceed the adapters limits.</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_readScsiDevicePageHeaders - save version and length of SDP1</span>
<span class="cm"> *	@ioc: Pointer to a Adapter Strucutre</span>
<span class="cm"> *	@portnum: IOC port number</span>
<span class="cm"> *</span>
<span class="cm"> *	Return: -EFAULT if read of config page header fails</span>
<span class="cm"> *		or 0 if success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpt_readScsiDevicePageHeaders</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CONFIGPARMS</span>		 <span class="n">cfg</span><span class="p">;</span>
	<span class="n">ConfigPageHeader_t</span>	 <span class="n">header</span><span class="p">;</span>

	<span class="cm">/* Read the SCSI Device Page 1 header</span>
<span class="cm">	 */</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_SCSI_DEVICE</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">portnum</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		 <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp1version</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageVersion</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp1length</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageLength</span><span class="p">;</span>

	<span class="n">header</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_SCSI_DEVICE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		 <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp0version</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageVersion</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp0length</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageLength</span><span class="p">;</span>

	<span class="n">dcprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Headers: 0: version %d length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp0version</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp0length</span><span class="p">));</span>

	<span class="n">dcprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Headers: 1: version %d length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp1version</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">sdp1length</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt_inactive_raid_list_free - This clears this link list.</span>
<span class="cm"> * @ioc : pointer to per adapter structure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_inactive_raid_list_free</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inactive_raid_component_info</span> <span class="o">*</span><span class="n">component_info</span><span class="p">,</span> <span class="o">*</span><span class="n">pNext</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">component_info</span><span class="p">,</span> <span class="n">pNext</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">component_info</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">component_info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpt_inactive_raid_volumes - sets up link list of phy_disk_nums for devices belonging in an inactive volume</span>
<span class="cm"> *</span>
<span class="cm"> * @ioc : pointer to per adapter structure</span>
<span class="cm"> * @channel : volume channel</span>
<span class="cm"> * @id : volume target id</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_inactive_raid_volumes</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CONFIGPARMS</span>			<span class="n">cfg</span><span class="p">;</span>
	<span class="n">ConfigPageHeader_t</span>		<span class="n">hdr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">pRaidVolumePage0_t</span>		<span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">i</span><span class="p">;</span>
	<span class="n">RaidPhysDiskPage0_t</span> 		<span class="n">phys_disk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inactive_raid_component_info</span> <span class="o">*</span><span class="n">component_info</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">handle_inactive_volumes</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CONFIGPARMS</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ConfigPageHeader_t</span><span class="p">));</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_RAID_VOLUME</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">NumPhysDisks</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">handle_inactive_volumes</span> <span class="o">=</span>
	   <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">VolumeStatus</span><span class="p">.</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">MPI_RAIDVOL0_STATUS_FLAG_VOLUME_INACTIVE</span> <span class="o">||</span>
	   <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">VolumeStatus</span><span class="p">.</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">MPI_RAIDVOL0_STATUS_FLAG_ENABLED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">VolumeStatus</span><span class="p">.</span><span class="n">State</span> <span class="o">==</span> <span class="n">MPI_RAIDVOL0_STATUS_STATE_FAILED</span> <span class="o">||</span>
	    <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">VolumeStatus</span><span class="p">.</span><span class="n">State</span> <span class="o">==</span> <span class="n">MPI_RAIDVOL0_STATUS_STATE_MISSING</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle_inactive_volumes</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">NumPhysDisks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">mpt_raid_phys_disk_pg0</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">PhysDisk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskNum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phys_disk</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">component_info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">component_info</span><span class="p">),</span>
		 <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">component_info</span><span class="o">-&gt;</span><span class="n">volumeID</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
		<span class="n">component_info</span><span class="o">-&gt;</span><span class="n">volumeBus</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
		<span class="n">component_info</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">PhysDiskNum</span> <span class="o">=</span> <span class="n">phys_disk</span><span class="p">.</span><span class="n">PhysDiskNum</span><span class="p">;</span>
		<span class="n">component_info</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">PhysDiskBus</span> <span class="o">=</span> <span class="n">phys_disk</span><span class="p">.</span><span class="n">PhysDiskBus</span><span class="p">;</span>
		<span class="n">component_info</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">PhysDiskID</span> <span class="o">=</span> <span class="n">phys_disk</span><span class="p">.</span><span class="n">PhysDiskID</span><span class="p">;</span>
		<span class="n">component_info</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">PhysDiskIOC</span> <span class="o">=</span> <span class="n">phys_disk</span><span class="p">.</span><span class="n">PhysDiskIOC</span><span class="p">;</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">component_info</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">inactive_list_mutex</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
		    <span class="n">dma_handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mpt_raid_phys_disk_pg0 - returns phys disk page zero</span>
<span class="cm"> *	@ioc: Pointer to a Adapter Structure</span>
<span class="cm"> *	@phys_disk_num: io unit unique phys disk num generated by the ioc</span>
<span class="cm"> *	@phys_disk: requested payload data returned</span>
<span class="cm"> *</span>
<span class="cm"> *	Return:</span>
<span class="cm"> *	0 on success</span>
<span class="cm"> *	-EFAULT if read of config page header fails or data pointer not NULL</span>
<span class="cm"> *	-ENOMEM if pci_alloc failed</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">mpt_raid_phys_disk_pg0</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phys_disk_num</span><span class="p">,</span>
			<span class="n">RaidPhysDiskPage0_t</span> <span class="o">*</span><span class="n">phys_disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CONFIGPARMS</span>			<span class="n">cfg</span><span class="p">;</span>
	<span class="n">ConfigPageHeader_t</span>		<span class="n">hdr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">pRaidPhysDiskPage0_t</span>		<span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">rc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CONFIGPARMS</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ConfigPageHeader_t</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">phys_disk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RaidPhysDiskPage0_t</span><span class="p">));</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">MPI_RAIDPHYSDISKPAGE0_PAGEVERSION</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_RAID_PHYSDISK</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">phys_disk_num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">phys_disk</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">));</span>
	<span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">MaxLBA</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">MaxLBA</span><span class="p">);</span>

 <span class="nl">out:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
		    <span class="n">dma_handle</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mpt_raid_phys_disk_get_num_paths - returns number paths associated to this phys_num</span>
<span class="cm"> *	@ioc: Pointer to a Adapter Structure</span>
<span class="cm"> *	@phys_disk_num: io unit unique phys disk num generated by the ioc</span>
<span class="cm"> *</span>
<span class="cm"> *	Return:</span>
<span class="cm"> *	returns number paths</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">mpt_raid_phys_disk_get_num_paths</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phys_disk_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CONFIGPARMS</span>		 	<span class="n">cfg</span><span class="p">;</span>
	<span class="n">ConfigPageHeader_t</span>	 	<span class="n">hdr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">pRaidPhysDiskPage1_t</span>		<span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">rc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CONFIGPARMS</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ConfigPageHeader_t</span><span class="p">));</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">MPI_RAIDPHYSDISKPAGE1_PAGEVERSION</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_RAID_PHYSDISK</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">phys_disk_num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">NumPhysDiskPaths</span><span class="p">;</span>
 <span class="nl">out:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
		    <span class="n">dma_handle</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_raid_phys_disk_get_num_paths</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	mpt_raid_phys_disk_pg1 - returns phys disk page 1</span>
<span class="cm"> *	@ioc: Pointer to a Adapter Structure</span>
<span class="cm"> *	@phys_disk_num: io unit unique phys disk num generated by the ioc</span>
<span class="cm"> *	@phys_disk: requested payload data returned</span>
<span class="cm"> *</span>
<span class="cm"> *	Return:</span>
<span class="cm"> *	0 on success</span>
<span class="cm"> *	-EFAULT if read of config page header fails or data pointer not NULL</span>
<span class="cm"> *	-ENOMEM if pci_alloc failed</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">mpt_raid_phys_disk_pg1</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">phys_disk_num</span><span class="p">,</span>
		<span class="n">RaidPhysDiskPage1_t</span> <span class="o">*</span><span class="n">phys_disk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CONFIGPARMS</span>		 	<span class="n">cfg</span><span class="p">;</span>
	<span class="n">ConfigPageHeader_t</span>	 	<span class="n">hdr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>			<span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">pRaidPhysDiskPage1_t</span>		<span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">i</span><span class="p">;</span>
	<span class="n">__le64</span>				<span class="n">sas_address</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CONFIGPARMS</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ConfigPageHeader_t</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">MPI_RAIDPHYSDISKPAGE1_PAGEVERSION</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_RAID_PHYSDISK</span><span class="p">;</span>
	<span class="n">hdr</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
	    <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="n">phys_disk_num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">NumPhysDiskPaths</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">NumPhysDiskPaths</span><span class="p">;</span>
	<span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">PhysDiskNum</span> <span class="o">=</span> <span class="n">phys_disk_num</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">NumPhysDiskPaths</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskID</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskID</span><span class="p">;</span>
		<span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskBus</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PhysDiskBus</span><span class="p">;</span>
		<span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">OwnerIdentifier</span> <span class="o">=</span>
				<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">OwnerIdentifier</span><span class="p">;</span>
		<span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">WWID</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">));</span>
		<span class="n">sas_address</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">WWID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sas_address</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sas_address</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">OwnerWWID</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">));</span>
		<span class="n">sas_address</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">sas_address</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phys_disk</span><span class="o">-&gt;</span><span class="n">Path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">OwnerWWID</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">sas_address</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le64</span><span class="p">));</span>
	<span class="p">}</span>

 <span class="nl">out:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
		    <span class="n">dma_handle</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_raid_phys_disk_pg1</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> *	mpt_findImVolumes - Identify IDs of hidden disks and RAID Volumes</span>
<span class="cm"> *	@ioc: Pointer to a Adapter Strucutre</span>
<span class="cm"> *</span>
<span class="cm"> *	Return:</span>
<span class="cm"> *	0 on success</span>
<span class="cm"> *	-EFAULT if read of config page header fails or data pointer not NULL</span>
<span class="cm"> *	-ENOMEM if pci_alloc failed</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">mpt_findImVolumes</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IOCPage2_t</span>		<span class="o">*</span><span class="n">pIoc2</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		 <span class="n">ioc2_dma</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span>		 <span class="n">cfg</span><span class="p">;</span>
	<span class="n">ConfigPageHeader_t</span>	 <span class="n">header</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">iocpage2sz</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ir_firmware</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Free the old page</span>
<span class="cm">	 */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mpt_inactive_raid_list_free</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="cm">/* Read IOCP2 header then the page.</span>
<span class="cm">	 */</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_IOC</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		 <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">iocpage2sz</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">pIoc2</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">iocpage2sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc2_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pIoc2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">ioc2_dma</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mem</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">iocpage2sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pIoc2</span><span class="p">,</span> <span class="n">iocpage2sz</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg2</span> <span class="o">=</span> <span class="p">(</span><span class="n">IOCPage2_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mem</span><span class="p">;</span>

	<span class="n">mpt_read_ioc_pg_3</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pIoc2</span><span class="o">-&gt;</span><span class="n">NumActiveVolumes</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mpt_inactive_raid_volumes</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="n">pIoc2</span><span class="o">-&gt;</span><span class="n">RaidVolume</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VolumeBus</span><span class="p">,</span>
		    <span class="n">pIoc2</span><span class="o">-&gt;</span><span class="n">RaidVolume</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">VolumeID</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">iocpage2sz</span><span class="p">,</span> <span class="n">pIoc2</span><span class="p">,</span> <span class="n">ioc2_dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpt_read_ioc_pg_3</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IOCPage3_t</span>		<span class="o">*</span><span class="n">pIoc3</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span>		 <span class="n">cfg</span><span class="p">;</span>
	<span class="n">ConfigPageHeader_t</span>	 <span class="n">header</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		 <span class="n">ioc3_dma</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">iocpage3sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Free the old page</span>
<span class="cm">	 */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* There is at least one physical disk.</span>
<span class="cm">	 * Read and save IOC Page 3</span>
<span class="cm">	 */</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_IOC</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Read Header good, alloc memory</span>
<span class="cm">	 */</span>
	<span class="n">iocpage3sz</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">pIoc3</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">iocpage3sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc3_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pIoc3</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Read the Page and save the data</span>
<span class="cm">	 * into malloc&#39;d memory.</span>
<span class="cm">	 */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">ioc3_dma</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">iocpage3sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">pIoc3</span><span class="p">,</span> <span class="n">iocpage3sz</span><span class="p">);</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">raid_data</span><span class="p">.</span><span class="n">pIocPg3</span> <span class="o">=</span> <span class="p">(</span><span class="n">IOCPage3_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mem</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">iocpage3sz</span><span class="p">,</span> <span class="n">pIoc3</span><span class="p">,</span> <span class="n">ioc3_dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_read_ioc_pg_4</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IOCPage4_t</span>		<span class="o">*</span><span class="n">pIoc4</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span>		 <span class="n">cfg</span><span class="p">;</span>
	<span class="n">ConfigPageHeader_t</span>	 <span class="n">header</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		 <span class="n">ioc4_dma</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">iocpage4sz</span><span class="p">;</span>

	<span class="cm">/* Read and save IOC Page 4</span>
<span class="cm">	 */</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_IOC</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">pIoc4</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">pIocPg4</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">iocpage4sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* Allow 4 additional SEP&#39;s */</span>
		<span class="n">pIoc4</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">iocpage4sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc4_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pIoc4</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span> <span class="o">+=</span> <span class="n">iocpage4sz</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ioc4_dma</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">IocPg4_dma</span><span class="p">;</span>
		<span class="n">iocpage4sz</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">IocPg4Sz</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read the Page into dma memory.</span>
<span class="cm">	 */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">ioc4_dma</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">pIocPg4</span> <span class="o">=</span> <span class="p">(</span><span class="n">IOCPage4_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">pIoc4</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">IocPg4_dma</span> <span class="o">=</span> <span class="n">ioc4_dma</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">IocPg4Sz</span> <span class="o">=</span> <span class="n">iocpage4sz</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">iocpage4sz</span><span class="p">,</span> <span class="n">pIoc4</span><span class="p">,</span> <span class="n">ioc4_dma</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">spi_data</span><span class="p">.</span><span class="n">pIocPg4</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_total</span> <span class="o">-=</span> <span class="n">iocpage4sz</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_read_ioc_pg_1</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IOCPage1_t</span>		<span class="o">*</span><span class="n">pIoc1</span><span class="p">;</span>
	<span class="n">CONFIGPARMS</span>		 <span class="n">cfg</span><span class="p">;</span>
	<span class="n">ConfigPageHeader_t</span>	 <span class="n">header</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		 <span class="n">ioc1_dma</span><span class="p">;</span>
	<span class="kt">int</span>			 <span class="n">iocpage1sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span>			 <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* Check the Coalescing Timeout in IOC Page 1</span>
<span class="cm">	 */</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_IOC</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">pageAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Read Header good, alloc memory</span>
<span class="cm">	 */</span>
	<span class="n">iocpage1sz</span> <span class="o">=</span> <span class="n">header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">pIoc1</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">iocpage1sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc1_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pIoc1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Read the Page and check coalescing timeout</span>
<span class="cm">	 */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">ioc1_dma</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pIoc1</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_IOCPAGE1_REPLY_COALESCING</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">MPI_IOCPAGE1_REPLY_COALESCING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pIoc1</span><span class="o">-&gt;</span><span class="n">CoalescingTimeout</span><span class="p">);</span>

			<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Coalescing Enabled Timeout = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tmp</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">MPT_COALESCING_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pIoc1</span><span class="o">-&gt;</span><span class="n">CoalescingTimeout</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MPT_COALESCING_TIMEOUT</span><span class="p">);</span>

				<span class="cm">/* Write NVRAM and current</span>
<span class="cm">				 */</span>
				<span class="n">cfg</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_WRITE_CURRENT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Reset Current Coalescing Timeout to = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">MPT_COALESCING_TIMEOUT</span><span class="p">));</span>

					<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_WRITE_NVRAM</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
								<span class="s">&quot;Reset NVRAM Coalescing Timeout to = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">MPT_COALESCING_TIMEOUT</span><span class="p">));</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
								<span class="s">&quot;Reset NVRAM Coalescing Timeout Failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
					<span class="p">}</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
						<span class="s">&quot;Reset of Current Coalescing Timeout Failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;Coalescing Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">iocpage1sz</span><span class="p">,</span> <span class="n">pIoc1</span><span class="p">,</span> <span class="n">ioc1_dma</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_get_manufacturing_pg_0</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CONFIGPARMS</span>		<span class="n">cfg</span><span class="p">;</span>
	<span class="n">ConfigPageHeader_t</span>	<span class="n">hdr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">buf_dma</span><span class="p">;</span>
	<span class="n">ManufacturingPage0_t</span>	<span class="o">*</span><span class="n">pbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">CONFIGPARMS</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ConfigPageHeader_t</span><span class="p">));</span>

	<span class="n">hdr</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_MANUFACTURING</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_HEADER</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg</span><span class="p">.</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageLength</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">MPI_CONFIG_ACTION_PAGE_READ_CURRENT</span><span class="p">;</span>
	<span class="n">pbuf</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbuf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">physAddr</span> <span class="o">=</span> <span class="n">buf_dma</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">,</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">BoardName</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">board_name</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">board_assembly</span><span class="p">,</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">BoardAssembly</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">board_assembly</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">board_tracer</span><span class="p">,</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">BoardTracerNumber</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">board_tracer</span><span class="p">));</span>

	<span class="nl">out:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pbuf</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">,</span> <span class="n">buf_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	SendEventNotification - Send EventNotification (on or off) request to adapter</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@EvSwitch: Event switch flags</span>
<span class="cm"> *	@sleepFlag: Specifies whether the process can sleep</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">SendEventNotification</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">EvSwitch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">EventNotification_t</span>	<span class="n">evn</span><span class="p">;</span>
	<span class="n">MPIDefaultReply_t</span>	<span class="n">reply_buf</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">evn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">EventNotification_t</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MPIDefaultReply_t</span><span class="p">));</span>

	<span class="n">evn</span><span class="p">.</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_EVENT_NOTIFICATION</span><span class="p">;</span>
	<span class="n">evn</span><span class="p">.</span><span class="n">Switch</span> <span class="o">=</span> <span class="n">EvSwitch</span><span class="p">;</span>
	<span class="n">evn</span><span class="p">.</span><span class="n">MsgContext</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mpt_base_index</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">devtverboseprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;Sending EventNotification (%d) request %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">EvSwitch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">evn</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">mpt_handshake_req_reply_wait</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">EventNotification_t</span><span class="p">),</span>
	    <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">evn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MPIDefaultReply_t</span><span class="p">),</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">reply_buf</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>
	    <span class="n">sleepFlag</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	SendEventAck - Send EventAck request to MPT adapter.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@evnp: Pointer to original EventNotification request</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">SendEventAck</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">EventNotificationReply_t</span> <span class="o">*</span><span class="n">evnp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">EventAck_t</span>	<span class="o">*</span><span class="n">pAck</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pAck</span> <span class="o">=</span> <span class="p">(</span><span class="n">EventAck_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">mpt_base_index</span><span class="p">,</span> <span class="n">ioc</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;%s, no msg frames!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devtverboseprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;Sending EventAck</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">pAck</span><span class="o">-&gt;</span><span class="n">Function</span>     <span class="o">=</span> <span class="n">MPI_FUNCTION_EVENT_ACK</span><span class="p">;</span>
	<span class="n">pAck</span><span class="o">-&gt;</span><span class="n">ChainOffset</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pAck</span><span class="o">-&gt;</span><span class="n">Reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">pAck</span><span class="o">-&gt;</span><span class="n">Reserved</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pAck</span><span class="o">-&gt;</span><span class="n">MsgFlags</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pAck</span><span class="o">-&gt;</span><span class="n">Reserved1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pAck</span><span class="o">-&gt;</span><span class="n">Reserved1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pAck</span><span class="o">-&gt;</span><span class="n">Reserved1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pAck</span><span class="o">-&gt;</span><span class="n">Event</span>        <span class="o">=</span> <span class="n">evnp</span><span class="o">-&gt;</span><span class="n">Event</span><span class="p">;</span>
	<span class="n">pAck</span><span class="o">-&gt;</span><span class="n">EventContext</span> <span class="o">=</span> <span class="n">evnp</span><span class="o">-&gt;</span><span class="n">EventContext</span><span class="p">;</span>

	<span class="n">mpt_put_msg_frame</span><span class="p">(</span><span class="n">mpt_base_index</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="p">(</span><span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="p">)</span><span class="n">pAck</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_config - Generic function to issue config message</span>
<span class="cm"> *	@ioc:   Pointer to an adapter structure</span>
<span class="cm"> *	@pCfg:  Pointer to a configuration structure. Struct contains</span>
<span class="cm"> *		action, page address, direction, physical address</span>
<span class="cm"> *		and pointer to a configuration page header</span>
<span class="cm"> *		Page header is updated.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success</span>
<span class="cm"> *	-EPERM if not allowed due to ISR context</span>
<span class="cm"> *	-EAGAIN if no msg frames currently available</span>
<span class="cm"> *	-EFAULT for non-successful reply or no reply (timeout)</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt_config</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CONFIGPARMS</span> <span class="o">*</span><span class="n">pCfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Config_t</span>	<span class="o">*</span><span class="n">pReq</span><span class="p">;</span>
	<span class="n">ConfigReply_t</span>	<span class="o">*</span><span class="n">pReply</span><span class="p">;</span>
	<span class="n">ConfigExtendedPageHeader_t</span>  <span class="o">*</span><span class="n">pExtHdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">MPT_FRAME_HDR</span>	<span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">ii</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">flagsLength</span><span class="p">;</span>
	<span class="kt">long</span>		 <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">page_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">extend_page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> 	 <span class="n">timeleft</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">flags</span><span class="p">;</span>
    <span class="kt">int</span>		 <span class="n">in_isr</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">issue_hard_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*	Prevent calling wait_event() (below), if caller happens</span>
<span class="cm">	 *	to be in ISR context, because that is fatal!</span>
<span class="cm">	 */</span>
	<span class="n">in_isr</span> <span class="o">=</span> <span class="n">in_interrupt</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_isr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dcprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span> <span class="s">&quot;Config request not allowed in ISR context!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
    <span class="p">}</span>

	<span class="cm">/* don&#39;t send a config page during diag reset */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: busy with host reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* don&#39;t send if no chance of success */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">||</span>
	    <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MPI_IOC_STATE_OPERATIONAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: ioc not operational, %d, %xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span>
		    <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">retry_config:</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="cm">/* init the internal cmd struct */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">MPT_DEFAULT_FRAME_SIZE</span><span class="p">);</span>
	<span class="n">INITIALIZE_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>

	<span class="cm">/* Get and Populate a free Frame</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mf</span> <span class="o">=</span> <span class="n">mpt_get_msg_frame</span><span class="p">(</span><span class="n">mpt_base_index</span><span class="p">,</span> <span class="n">ioc</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dcprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
		<span class="s">&quot;mpt_config: no msg frames!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">Config_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Action</span> <span class="o">=</span> <span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">ChainOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Function</span> <span class="o">=</span> <span class="n">MPI_FUNCTION_CONFIG</span><span class="p">;</span>

	<span class="cm">/* Assume page type is not extended and clear &quot;reserved&quot; fields. */</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">ExtPageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">ExtPageType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">MsgFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Reserved2</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageVersion</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageLength</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageNumber</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="p">(</span><span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageType</span> <span class="o">&amp;</span> <span class="n">MPI_CONFIG_PAGETYPE_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageType</span> <span class="o">&amp;</span> <span class="n">MPI_CONFIG_PAGETYPE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPI_CONFIG_PAGETYPE_EXTENDED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pExtHdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ConfigExtendedPageHeader_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">ehdr</span><span class="p">;</span>
		<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">ExtPageLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pExtHdr</span><span class="o">-&gt;</span><span class="n">ExtPageLength</span><span class="p">);</span>
		<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">ExtPageType</span> <span class="o">=</span> <span class="n">pExtHdr</span><span class="o">-&gt;</span><span class="n">ExtPageType</span><span class="p">;</span>
		<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">MPI_CONFIG_PAGETYPE_EXTENDED</span><span class="p">;</span>

		<span class="cm">/* Page Length must be treated as a reserved field for the</span>
<span class="cm">		 * extended header.</span>
<span class="cm">		 */</span>
		<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">PageAddress</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">pageAddr</span><span class="p">);</span>

	<span class="cm">/* Add a SGE to the config request.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">)</span>
		<span class="n">flagsLength</span> <span class="o">=</span> <span class="n">MPT_SGE_FLAGS_SSIMPLE_WRITE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">flagsLength</span> <span class="o">=</span> <span class="n">MPT_SGE_FLAGS_SSIMPLE_READ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageType</span> <span class="o">&amp;</span> <span class="n">MPI_CONFIG_PAGETYPE_MASK</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">MPI_CONFIG_PAGETYPE_EXTENDED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flagsLength</span> <span class="o">|=</span> <span class="n">pExtHdr</span><span class="o">-&gt;</span><span class="n">ExtPageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">page_type</span> <span class="o">=</span> <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">ExtPageType</span><span class="p">;</span>
		<span class="n">extend_page</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">flagsLength</span> <span class="o">|=</span> <span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageLength</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">page_type</span> <span class="o">=</span> <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageType</span><span class="p">;</span>
		<span class="n">extend_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dcprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;Sending Config request type 0x%x, page 0x%x and action %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">page_type</span><span class="p">,</span> <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageNumber</span><span class="p">,</span> <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Action</span><span class="p">));</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">add_sge</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pReq</span><span class="o">-&gt;</span><span class="n">PageBufferSGE</span><span class="p">,</span> <span class="n">flagsLength</span><span class="p">,</span> <span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">physAddr</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">?</span> <span class="n">HZ</span><span class="o">*</span><span class="mi">15</span> <span class="o">:</span> <span class="n">HZ</span><span class="o">*</span><span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>
	<span class="n">mpt_put_msg_frame</span><span class="p">(</span><span class="n">mpt_base_index</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">,</span>
		<span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_COMMAND_GOOD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="n">dfailprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;Failed Sending Config request type 0x%x, page 0x%x,&quot;</span>
		    <span class="s">&quot; action %d, status %xh, time left %ld</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">page_type</span><span class="p">,</span> <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageNumber</span><span class="p">,</span>
			<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Action</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="n">timeleft</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeleft</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span>
					<span class="n">flags</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;%s: host reset in&quot;</span>
					<span class="s">&quot; progress mpt_config timed out.!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">issue_hard_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_RF_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pReply</span> <span class="o">=</span> <span class="p">(</span><span class="n">ConfigReply_t</span>	<span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">reply</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pReply</span><span class="o">-&gt;</span><span class="n">IOCStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">extend_page</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">ExtPageLength</span> <span class="o">=</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pReply</span><span class="o">-&gt;</span><span class="n">ExtPageLength</span><span class="p">);</span>
			<span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">ehdr</span><span class="o">-&gt;</span><span class="n">ExtPageType</span> <span class="o">=</span>
			    <span class="n">pReply</span><span class="o">-&gt;</span><span class="n">ExtPageType</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageVersion</span> <span class="o">=</span> <span class="n">pReply</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageVersion</span><span class="p">;</span>
		<span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageLength</span> <span class="o">=</span> <span class="n">pReply</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageLength</span><span class="p">;</span>
		<span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageNumber</span> <span class="o">=</span> <span class="n">pReply</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageNumber</span><span class="p">;</span>
		<span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageType</span> <span class="o">=</span> <span class="n">pReply</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageType</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retry_count</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;Retry completed &quot;</span>
		    <span class="s">&quot;ret=0x%x timeleft=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">timeleft</span><span class="p">);</span>

	<span class="n">dcprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;IOCStatus=%04xh, IOCLogInfo=%08xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">ret</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pReply</span><span class="o">-&gt;</span><span class="n">IOCLogInfo</span><span class="p">)));</span>

<span class="nl">out:</span>

	<span class="n">CLEAR_MGMT_STATUS</span><span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">issue_hard_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">issue_hard_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_WARN_FMT</span>
		       <span class="s">&quot;Issuing Reset from %s!!, doorbell=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retry_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mpt_Soft_Hard_ResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">retry_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">mpt_HardResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">CAN_SLEEP</span><span class="p">);</span>

		<span class="n">mpt_free_msg_frame</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
		<span class="cm">/* attempt one retry for a timed out command */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retry_count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span>
			    <span class="s">&quot;Attempting Retry Config request&quot;</span>
			    <span class="s">&quot; type 0x%x, page 0x%x,&quot;</span>
			    <span class="s">&quot; action %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">page_type</span><span class="p">,</span>
			    <span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">cfghdr</span><span class="p">.</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">PageNumber</span><span class="p">,</span> <span class="n">pCfg</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
			<span class="n">retry_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">retry_config</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_ioc_reset - Base cleanup for hard reset</span>
<span class="cm"> *	@ioc: Pointer to the adapter structure</span>
<span class="cm"> *	@reset_phase: Indicates pre- or post-reset functionality</span>
<span class="cm"> *</span>
<span class="cm"> *	Remark: Frees resources with internally generated commands.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpt_ioc_reset</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset_phase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reset_phase</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPT_IOC_SETUP_RESET</span>:
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_quiesce_io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: MPT_IOC_SETUP_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT_IOC_PRE_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: MPT_IOC_PRE_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPT_IOC_POST_RESET</span>:
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;%s: MPT_IOC_POST_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">));</span>
<span class="cm">/* wake up mptbase_cmds */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span>
			    <span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">;</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mptbase_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cm">/* wake up taskmgmt_cmds */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MPT_MGMT_STATUS_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">|=</span>
				<span class="n">MPT_MGMT_STATUS_DID_IOCRESET</span><span class="p">;</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_cmds</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* currently means nothing really */</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_PROC_FS		</span><span class="cm">/* { */</span><span class="cp"></span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	procfs (%MPT_PROCFS_MPTBASEDIR/...) support stuff...</span>
<span class="cm"> */</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	procmpt_create - Create %MPT_PROCFS_MPTBASEDIR entries.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">procmpt_create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mpt_proc_root_dir</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">MPT_PROCFS_MPTBASEDIR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_proc_root_dir</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTDIR</span><span class="p">;</span>

	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;summary&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mpt_proc_root_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt_summary_proc_fops</span><span class="p">);</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;version&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">mpt_proc_root_dir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpt_version_proc_fops</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	procmpt_destroy - Tear down %MPT_PROCFS_MPTBASEDIR entries.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">procmpt_destroy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;version&quot;</span><span class="p">,</span> <span class="n">mpt_proc_root_dir</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;summary&quot;</span><span class="p">,</span> <span class="n">mpt_proc_root_dir</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">MPT_PROCFS_MPTBASEDIR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	Handles read request from /proc/mpt/summary or /proc/mpt/iocN/summary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">seq_mpt_print_ioc_summary</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">showlan</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpt_summary_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_mpt_print_ioc_summary</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ioc_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_mpt_print_ioc_summary</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpt_summary_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mpt_summary_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mpt_summary_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">mpt_summary_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpt_version_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>	 <span class="n">cb_idx</span><span class="p">;</span>
	<span class="kt">int</span>	 <span class="n">scsi</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">sas</span><span class="p">,</span> <span class="n">lan</span><span class="p">,</span> <span class="n">ctl</span><span class="p">,</span> <span class="n">targ</span><span class="p">,</span> <span class="n">dmp</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">drvname</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s-%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;mptlinux&quot;</span><span class="p">,</span> <span class="n">MPT_LINUX_VERSION_COMMON</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  Fusion MPT base driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">scsi</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">sas</span> <span class="o">=</span> <span class="n">lan</span> <span class="o">=</span> <span class="n">ctl</span> <span class="o">=</span> <span class="n">targ</span> <span class="o">=</span> <span class="n">dmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">cb_idx</span><span class="p">;</span> <span class="n">cb_idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drvname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MptCallbacks</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">MptDriverClass</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">MPTSPI_DRIVER</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scsi</span><span class="o">++</span><span class="p">)</span> <span class="n">drvname</span> <span class="o">=</span> <span class="s">&quot;SPI host&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MPTFC_DRIVER</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fc</span><span class="o">++</span><span class="p">)</span> <span class="n">drvname</span> <span class="o">=</span> <span class="s">&quot;FC host&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MPTSAS_DRIVER</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sas</span><span class="o">++</span><span class="p">)</span> <span class="n">drvname</span> <span class="o">=</span> <span class="s">&quot;SAS host&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MPTLAN_DRIVER</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lan</span><span class="o">++</span><span class="p">)</span> <span class="n">drvname</span> <span class="o">=</span> <span class="s">&quot;LAN&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MPTSTM_DRIVER</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">targ</span><span class="o">++</span><span class="p">)</span> <span class="n">drvname</span> <span class="o">=</span> <span class="s">&quot;SCSI target&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MPTCTL_DRIVER</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctl</span><span class="o">++</span><span class="p">)</span> <span class="n">drvname</span> <span class="o">=</span> <span class="s">&quot;ioctl&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">drvname</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  Fusion MPT %s driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drvname</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpt_version_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mpt_version_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mpt_version_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">mpt_version_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpt_iocinfo_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MPT_ADAPTER</span>	<span class="o">*</span><span class="n">ioc</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">char</span>		 <span class="n">expVer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span>		 <span class="n">sz</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">p</span><span class="p">;</span>

	<span class="n">mpt_get_fw_exp_ver</span><span class="p">(</span><span class="n">expVer</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s:&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">MPI_IOCFACTS_FLAGS_FW_DOWNLOAD_BOOT</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  (f/w download boot flag set)&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>if (ioc->facts.IOCExceptions &amp; MPI<em>IOCFACTS</em>EXCEPT<em>CONFIG</em>CHECKSUM<em>FAIL)
    seq</em>printf(m, "  CONFIG<em>CHECKSUM</em>FAIL!");</p></td><td class="code"><div class="highlight"><pre>	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">  ProductID = 0x%04x (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">ProductID</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">prod_name</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  FWVersion = 0x%08x%s&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span><span class="p">,</span> <span class="n">expVer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWImageSize</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; (fw_size=%d)&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWImageSize</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">  MsgVersion = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MsgVersion</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  FirstWhoInit = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">FirstWhoInit</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  EventState = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">EventState</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  CurrentHostMfaHighAddr = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">CurrentHostMfaHighAddr</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  CurrentSenseBufferHighAddr = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">CurrentSenseBufferHighAddr</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  MaxChainDepth = 0x%02x frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxChainDepth</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  MinBlockSize = 0x%02x bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">BlockSize</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  RequestFrames @ 0x%p (Dma @ 0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">ulong</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_frames_dma</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Rounding UP to nearest 4-kB boundary here...</span>
<span class="cm">	 */</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">)</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="p">((</span><span class="n">sz</span> <span class="o">+</span> <span class="mh">0x1000UL</span> <span class="o">-</span> <span class="mi">1UL</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    {CurReqSz=%d} x {CurReqDepth=%d} = %d bytes ^= 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_sz</span><span class="o">*</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    {MaxReqSz=%d}   {MaxReqDepth=%d}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="mi">4</span><span class="o">*</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">RequestFrameSize</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">GlobalCredits</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  Frames   @ 0x%p (Dma @ 0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">ulong</span><span class="p">)</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alloc_dma</span><span class="p">);</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span> <span class="o">*</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_depth</span><span class="p">)</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    {CurRepSz=%d} x {CurRepDepth=%d} = %d bytes ^= 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_depth</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_sz</span><span class="o">*</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reply_depth</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    {MaxRepSz=%d}   {MaxRepDepth=%d}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">CurReplyFrameSize</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">ReplyQueueDepth</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  MaxDevices = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxDevices</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxDevices</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  MaxBuses = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">MaxBuses</span><span class="p">);</span>

	<span class="cm">/* per-port info */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  PortNumber = %d (of %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">ProtocolFlags</span> <span class="o">&amp;</span> <span class="n">MPI_PORTFACTS_PROTOCOL_LAN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">lan_cnfg_page1</span><span class="p">.</span><span class="n">HardwareAddressLow</span><span class="p">;</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    LanAddr = %02X:%02X:%02X:%02X:%02X:%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    WWN = %08X%08X:%08X%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_port_page0</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">WWNN</span><span class="p">.</span><span class="n">High</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_port_page0</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">WWNN</span><span class="p">.</span><span class="n">Low</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_port_page0</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">WWPN</span><span class="p">.</span><span class="n">High</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">fc_port_page0</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">WWPN</span><span class="p">.</span><span class="n">Low</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpt_iocinfo_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mpt_iocinfo_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mpt_iocinfo_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">mpt_iocinfo_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif		</span><span class="cm">/* CONFIG_PROC_FS } */</span><span class="cp"></span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_get_fw_exp_ver</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span><span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0E</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; (Exp %02d%02d)&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">,</span>	<span class="cm">/* Month */</span>
			<span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span>	<span class="cm">/* Day */</span>

		<span class="cm">/* insider hack! */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; [MDBG]&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_print_ioc_summary - Write ASCII summary of IOC to a buffer.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@buffer: Pointer to buffer where IOC summary info should be written</span>
<span class="cm"> *	@size: Pointer to number of bytes we wrote (set by this routine)</span>
<span class="cm"> *	@len: Offset at which to start writing in buffer</span>
<span class="cm"> *	@showlan: Display LAN stuff?</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine writes (english readable) ASCII text, which represents</span>
<span class="cm"> *	a summary of IOC information, to a buffer.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpt_print_ioc_summary</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">showlan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">expVer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">y</span><span class="p">;</span>

	<span class="n">mpt_get_fw_exp_ver</span><span class="p">(</span><span class="n">expVer</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Shorter summary of attached ioc&#39;s...</span>
<span class="cm">	 */</span>
	<span class="n">y</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%s: %s, %s%08xh%s, Ports=%d, MaxQ=%d&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">prod_name</span><span class="p">,</span>
			<span class="n">MPT_FW_REV_MAGIC_ID_STRING</span><span class="p">,</span>	<span class="cm">/* &quot;FwRev=&quot; or somesuch */</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span><span class="p">,</span>
			<span class="n">expVer</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">showlan</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ProtocolFlags</span> <span class="o">&amp;</span> <span class="n">MPI_PORTFACTS_PROTOCOL_LAN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">lan_cnfg_page1</span><span class="p">.</span><span class="n">HardwareAddressLow</span><span class="p">;</span>
		<span class="n">y</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="o">+</span><span class="n">y</span><span class="p">,</span> <span class="s">&quot;, LanAddr=%02X:%02X:%02X:%02X:%02X:%02X&quot;</span><span class="p">,</span>
			<span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">y</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="o">+</span><span class="n">y</span><span class="p">,</span> <span class="s">&quot;, IRQ=%d&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="o">+</span><span class="n">y</span><span class="p">,</span> <span class="s">&quot; (disabled)&quot;</span><span class="p">);</span>

	<span class="n">y</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="o">+</span><span class="n">y</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">seq_mpt_print_ioc_summary</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">showlan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">expVer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">mpt_get_fw_exp_ver</span><span class="p">(</span><span class="n">expVer</span><span class="p">,</span> <span class="n">ioc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Shorter summary of attached ioc&#39;s...</span>
<span class="cm">	 */</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s: %s, %s%08xh%s, Ports=%d, MaxQ=%d&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">prod_name</span><span class="p">,</span>
			<span class="n">MPT_FW_REV_MAGIC_ID_STRING</span><span class="p">,</span>	<span class="cm">/* &quot;FwRev=&quot; or somesuch */</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">FWVersion</span><span class="p">.</span><span class="n">Word</span><span class="p">,</span>
			<span class="n">expVer</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">NumberOfPorts</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">req_depth</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">showlan</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pfacts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ProtocolFlags</span> <span class="o">&amp;</span> <span class="n">MPI_PORTFACTS_PROTOCOL_LAN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">lan_cnfg_page1</span><span class="p">.</span><span class="n">HardwareAddressLow</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;, LanAddr=%02X:%02X:%02X:%02X:%02X:%02X&quot;</span><span class="p">,</span>
			<span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;, IRQ=%d&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">pci_irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; (disabled)&quot;</span><span class="p">);</span>

	<span class="n">seq_putc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mpt_set_taskmgmt_in_progress_flag - set flags associated with task management</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for SUCCESS or -1 if FAILED.</span>
<span class="cm"> *</span>
<span class="cm"> *	If -1 is return, then it was not possible to set the flags</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">mpt_set_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">retval</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span> <span class="o">||</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_in_progress</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span> <span class="o">&amp;&amp;</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_in_progress</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_quiesce_io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_quiesce_io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_set_taskmgmt_in_progress_flag</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	mpt_clear_taskmgmt_in_progress_flag - clear flags associated with task management</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">mpt_clear_taskmgmt_in_progress_flag</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_quiesce_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_quiesce_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_clear_taskmgmt_in_progress_flag</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> *	mpt_halt_firmware - Halts the firmware if it is operational and panic</span>
<span class="cm"> *	the kernel</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="kt">void</span>
<span class="nf">mpt_halt_firmware</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	 <span class="n">ioc_raw_state</span><span class="p">;</span>

	<span class="n">ioc_raw_state</span> <span class="o">=</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ioc_raw_state</span> <span class="o">&amp;</span> <span class="n">MPI_IOC_STATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPI_IOC_STATE_FAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_ERR_FMT</span> <span class="s">&quot;IOC is in FAULT state (%04xh)!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc_raw_state</span> <span class="o">&amp;</span> <span class="n">MPI_DOORBELL_DATA_MASK</span><span class="p">);</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: IOC Fault (%04xh)!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">ioc_raw_state</span> <span class="o">&amp;</span> <span class="n">MPI_DOORBELL_DATA_MASK</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">Doorbell</span><span class="p">,</span> <span class="mh">0xC0FFEE00</span><span class="p">);</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;%s: Firmware is halted due to command timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_halt_firmware</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	mpt_SoftResetHandler - Issues a less expensive reset</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@sleepFlag: Indicates if sleep or schedule must be called.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for SUCCESS or -1 if FAILED.</span>
<span class="cm"> *</span>
<span class="cm"> *	Message Unit Reset - instructs the IOC to reset the Reply Post and</span>
<span class="cm"> *	Free FIFO&#39;s. All the Message Frames on Reply Free FIFO are discarded.</span>
<span class="cm"> *	All posted buffers are freed, and event notification is turned off.</span>
<span class="cm"> *	IOC doesn&#39;t reply to any outstanding request. This will transfer IOC</span>
<span class="cm"> *	to READY state.</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">mpt_SoftResetHandler</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		 <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span>		 <span class="n">ii</span><span class="p">;</span>
	<span class="n">u8</span>		 <span class="n">cb_idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span>		 <span class="n">ioc_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">time_count</span><span class="p">;</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;SoftResetHandler Entered!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_IOC_STATE_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_fwfault_debug</span><span class="p">)</span>
		<span class="n">mpt_halt_firmware</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">==</span> <span class="n">MPI_IOC_STATE_FAULT</span> <span class="o">||</span>
	    <span class="n">ioc_state</span> <span class="o">==</span> <span class="n">MPI_IOC_STATE_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;skipping, either in FAULT or RESET state!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		    <span class="s">&quot;skipping, because the bus type is FC!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">cb_idx</span><span class="p">;</span> <span class="n">cb_idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MptResetHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">])</span>
			<span class="n">mpt_signal_reset</span><span class="p">(</span><span class="n">cb_idx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_IOC_SETUP_RESET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Disable reply interrupts (also blocks FreeQ) */</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">time_count</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendIocReset</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPI_FUNCTION_IOC_MESSAGE_UNIT_RESET</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">cb_idx</span><span class="p">;</span> <span class="n">cb_idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MptResetHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">])</span>
			<span class="n">mpt_signal_reset</span><span class="p">(</span><span class="n">cb_idx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_IOC_PRE_RESET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ioc_state</span> <span class="o">=</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPI_IOC_STATE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_state</span> <span class="o">!=</span> <span class="n">MPI_IOC_STATE_READY</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get IOC facts! Allow 5 retries */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">GetIocFacts</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">,</span>
			<span class="n">MPT_HOSTEVENT_IOC_RECOVER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleepFlag</span> <span class="o">==</span> <span class="n">CAN_SLEEP</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">PrimeIocFifos</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendIocInit</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">SendEventNotification</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hard_resets</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hard_resets</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * At this point, we know soft reset succeeded.</span>
<span class="cm">	 */</span>

	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">CHIPREG_WRITE32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">MPI_HIM_DIM</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_quiesce_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* otherwise, hard reset coming */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">cb_idx</span><span class="p">;</span> <span class="n">cb_idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">MptResetHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">])</span>
				<span class="n">mpt_signal_reset</span><span class="p">(</span><span class="n">cb_idx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span>
					<span class="n">MPT_IOC_POST_RESET</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		<span class="s">&quot;SoftResetHandler: completed (%d seconds): %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">time_count</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span>
		<span class="p">((</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;SUCCESS&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span><span class="p">)));</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mpt_Soft_Hard_ResetHandler - Try less expensive reset</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@sleepFlag: Indicates if sleep or schedule must be called.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for SUCCESS or -1 if FAILED.</span>
<span class="cm"> *	Try for softreset first, only if it fails go for expensive</span>
<span class="cm"> *	HardReset.</span>
<span class="cm"> **/</span>
<span class="kt">int</span>
<span class="nf">mpt_Soft_Hard_ResetHandler</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mpt_SoftResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mpt_HardResetHandler</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_Soft_Hard_ResetHandler</span><span class="p">);</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/*</span>
<span class="cm"> *	Reset Handling</span>
<span class="cm"> */</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_HardResetHandler - Generic reset handler</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@sleepFlag: Indicates if sleep or schedule must be called.</span>
<span class="cm"> *</span>
<span class="cm"> *	Issues SCSI Task Management call based on input arg values.</span>
<span class="cm"> *	If TaskMgmt fails, returns associated SCSI request.</span>
<span class="cm"> *</span>
<span class="cm"> *	Remark: _HardResetHandler can be invoked from an interrupt thread (timer)</span>
<span class="cm"> *	or a non-interrupt thread.  In the former, must not call schedule().</span>
<span class="cm"> *</span>
<span class="cm"> *	Note: A return of -1 is a FATAL error case, as it means a</span>
<span class="cm"> *	FW reload/initialization failed.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for SUCCESS or -1 if FAILED.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mpt_HardResetHandler</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleepFlag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	 <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span>	 <span class="n">cb_idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	 <span class="n">time_count</span><span class="p">;</span>

	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;HardResetHandler Entered!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
<span class="cp">#ifdef MFCNT</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;HardResetHandler Entered!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MF count 0x%x !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">mfcnt</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpt_fwfault_debug</span><span class="p">)</span>
		<span class="n">mpt_halt_firmware</span><span class="p">(</span><span class="n">ioc</span><span class="p">);</span>

	<span class="cm">/* Reset the adapter. Prevent more than 1 call to</span>
<span class="cm">	 * mpt_do_ioc_recovery at any instant in time.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">wait_on_reset_completion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">wait_on_reset_completion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">wait_on_reset_completion</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">time_count</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>


	<span class="cm">/* The SCSI driver needs to adjust timeouts on all current</span>
<span class="cm">	 * commands prior to the diagnostic reset being issued.</span>
<span class="cm">	 * Prevents timeouts occurring during a diagnostic reset...very bad.</span>
<span class="cm">	 * For all other protocol drivers, this is a no-op.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">cb_idx</span><span class="p">;</span> <span class="n">cb_idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MptResetHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">mpt_signal_reset</span><span class="p">(</span><span class="n">cb_idx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_IOC_SETUP_RESET</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span>
				<span class="n">mpt_signal_reset</span><span class="p">(</span><span class="n">cb_idx</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">,</span>
					<span class="n">MPT_IOC_SETUP_RESET</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">time_count</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mpt_do_ioc_recovery</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_HOSTEVENT_IOC_RECOVER</span><span class="p">,</span> <span class="n">sleepFlag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">MYNAM</span>
		       <span class="s">&quot;: WARNING - (%d) Cannot recover %s, doorbell=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rc</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mpt_GetIocState</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hard_resets</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">hard_resets</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_quiesce_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">reset_status</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">ioc_reset_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_quiesce_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">taskmgmt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">cb_idx</span><span class="p">;</span> <span class="n">cb_idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MptResetHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">mpt_signal_reset</span><span class="p">(</span><span class="n">cb_idx</span><span class="p">,</span> <span class="n">ioc</span><span class="p">,</span> <span class="n">MPT_IOC_POST_RESET</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">)</span>
				<span class="n">mpt_signal_reset</span><span class="p">(</span><span class="n">cb_idx</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">alt_ioc</span><span class="p">,</span> <span class="n">MPT_IOC_POST_RESET</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">exit:</span>
	<span class="n">dtmprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
		<span class="s">&quot;HardResetHandler: completed (%d seconds): %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">time_count</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="p">((</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
		<span class="s">&quot;SUCCESS&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span><span class="p">)));</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FUSION_LOGGING</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_display_event_info</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">EventNotificationReply_t</span> <span class="o">*</span><span class="n">pEventReply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">evData0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">evStr</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">evStr</span><span class="p">;</span>

	<span class="n">event</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pEventReply</span><span class="o">-&gt;</span><span class="n">Event</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">evData0</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pEventReply</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_NONE</span>:
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;None&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_LOG_DATA</span>:
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Log Data&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_STATE_CHANGE</span>:
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;State Change&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_UNIT_ATTENTION</span>:
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Unit Attention&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_IOC_BUS_RESET</span>:
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;IOC Bus Reset&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_EXT_BUS_RESET</span>:
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;External Bus Reset&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_RESCAN</span>:
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Bus Rescan Event&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_LINK_STATUS_CHANGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">evData0</span> <span class="o">==</span> <span class="n">MPI_EVENT_LINK_STATUS_FAILURE</span><span class="p">)</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Link Status(FAILURE) Change&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Link Status(ACTIVE) Change&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_LOOP_STATE_CHANGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">evData0</span> <span class="o">==</span> <span class="n">MPI_EVENT_LOOP_STATE_CHANGE_LIP</span><span class="p">)</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Loop State(LIP) Change&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">evData0</span> <span class="o">==</span> <span class="n">MPI_EVENT_LOOP_STATE_CHANGE_LPE</span><span class="p">)</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Loop State(LPE) Change&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Loop State(LPB) Change&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_LOGOUT</span>:
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Logout&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_EVENT_CHANGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">evData0</span><span class="p">)</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Events ON&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Events OFF&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_INTEGRATED_RAID</span>:
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">ReasonCode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ReasonCode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_VOLUME_CREATED</span> :
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Integrated Raid: Volume Created&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_VOLUME_DELETED</span> :
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Integrated Raid: Volume Deleted&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_VOLUME_SETTINGS_CHANGED</span> :
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Integrated Raid: Volume Settings Changed&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_VOLUME_STATUS_CHANGED</span> :
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Integrated Raid: Volume Status Changed&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_VOLUME_PHYSDISK_CHANGED</span> :
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Integrated Raid: Volume Physdisk Changed&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_PHYSDISK_CREATED</span> :
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Integrated Raid: Physdisk Created&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_PHYSDISK_DELETED</span> :
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Integrated Raid: Physdisk Deleted&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_PHYSDISK_SETTINGS_CHANGED</span> :
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Integrated Raid: Physdisk Settings Changed&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_PHYSDISK_STATUS_CHANGED</span> :
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Integrated Raid: Physdisk Status Changed&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_DOMAIN_VAL_NEEDED</span> :
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Integrated Raid: Domain Validation Needed&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_SMART_DATA</span> :
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Integrated Raid; Smart Data&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_RAID_RC_REPLACE_ACTION_STARTED</span> :
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Integrated Raid: Replace Action Started&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Integrated Raid&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SCSI_DEVICE_STATUS_CHANGE</span>:
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;SCSI Device Status Change&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEVICE_STATUS_CHANGE</span>:
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">ReasonCode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ReasonCode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_ADDED</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS Device Status Change: Added: &quot;</span>
			    <span class="s">&quot;id=%d channel=%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_NOT_RESPONDING</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS Device Status Change: Deleted: &quot;</span>
			    <span class="s">&quot;id=%d channel=%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_SMART_DATA</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS Device Status Change: SMART Data: &quot;</span>
			    <span class="s">&quot;id=%d channel=%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_NO_PERSIST_ADDED</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS Device Status Change: No Persistancy: &quot;</span>
			    <span class="s">&quot;id=%d channel=%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_UNSUPPORTED</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS Device Status Change: Unsupported Device &quot;</span>
			    <span class="s">&quot;Discovered : id=%d channel=%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_INTERNAL_DEVICE_RESET</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS Device Status Change: Internal Device &quot;</span>
			    <span class="s">&quot;Reset : id=%d channel=%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_TASK_ABORT_INTERNAL</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS Device Status Change: Internal Task &quot;</span>
			    <span class="s">&quot;Abort : id=%d channel=%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_ABORT_TASK_SET_INTERNAL</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS Device Status Change: Internal Abort &quot;</span>
			    <span class="s">&quot;Task Set : id=%d channel=%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_CLEAR_TASK_SET_INTERNAL</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS Device Status Change: Internal Clear &quot;</span>
			    <span class="s">&quot;Task Set : id=%d channel=%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DEV_STAT_RC_QUERY_TASK_INTERNAL</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS Device Status Change: Internal Query &quot;</span>
			    <span class="s">&quot;Task : id=%d channel=%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS Device Status Change: Unknown: &quot;</span>
			    <span class="s">&quot;id=%d channel=%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_ON_BUS_TIMER_EXPIRED</span>:
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Bus Timer Expired&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_QUEUE_FULL</span>:
	<span class="p">{</span>
		<span class="n">u16</span> <span class="n">curr_depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">evData0</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span><span class="p">);</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
		   <span class="s">&quot;Queue Full: channel=%d id=%d depth=%d&quot;</span><span class="p">,</span>
		   <span class="n">channel</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">curr_depth</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_SES</span>:
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;SAS SES Event&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_PERSISTENT_TABLE_FULL</span>:
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Persistent Table Full&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_PHY_LINK_STATUS</span>:
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">LinkRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">PhyNumber</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span><span class="p">);</span>
		<span class="n">LinkRates</span> <span class="o">=</span> <span class="p">(</span><span class="n">LinkRates</span> <span class="o">&amp;</span> <span class="n">MPI_EVENT_SAS_PLS_LR_CURRENT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">MPI_EVENT_SAS_PLS_LR_CURRENT_SHIFT</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">LinkRates</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_PLS_LR_RATE_UNKNOWN</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			   <span class="s">&quot;SAS PHY Link Status: Phy=%d:&quot;</span>
			   <span class="s">&quot; Rate Unknown&quot;</span><span class="p">,</span><span class="n">PhyNumber</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_PLS_LR_RATE_PHY_DISABLED</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			   <span class="s">&quot;SAS PHY Link Status: Phy=%d:&quot;</span>
			   <span class="s">&quot; Phy Disabled&quot;</span><span class="p">,</span><span class="n">PhyNumber</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_PLS_LR_RATE_FAILED_SPEED_NEGOTIATION</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			   <span class="s">&quot;SAS PHY Link Status: Phy=%d:&quot;</span>
			   <span class="s">&quot; Failed Speed Nego&quot;</span><span class="p">,</span><span class="n">PhyNumber</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_PLS_LR_RATE_SATA_OOB_COMPLETE</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			   <span class="s">&quot;SAS PHY Link Status: Phy=%d:&quot;</span>
			   <span class="s">&quot; Sata OOB Completed&quot;</span><span class="p">,</span><span class="n">PhyNumber</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_PLS_LR_RATE_1_5</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			   <span class="s">&quot;SAS PHY Link Status: Phy=%d:&quot;</span>
			   <span class="s">&quot; Rate 1.5 Gbps&quot;</span><span class="p">,</span><span class="n">PhyNumber</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_PLS_LR_RATE_3_0</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			   <span class="s">&quot;SAS PHY Link Status: Phy=%d:&quot;</span>
			   <span class="s">&quot; Rate 3.0 Gbps&quot;</span><span class="p">,</span> <span class="n">PhyNumber</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_PLS_LR_RATE_6_0</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			   <span class="s">&quot;SAS PHY Link Status: Phy=%d:&quot;</span>
			   <span class="s">&quot; Rate 6.0 Gbps&quot;</span><span class="p">,</span> <span class="n">PhyNumber</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			   <span class="s">&quot;SAS PHY Link Status: Phy=%d&quot;</span><span class="p">,</span> <span class="n">PhyNumber</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DISCOVERY_ERROR</span>:
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;SAS Discovery Error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_IR_RESYNC_UPDATE</span>:
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">resync_complete</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
		    <span class="s">&quot;IR Resync Update: Complete = %d:&quot;</span><span class="p">,</span><span class="n">resync_complete</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_IR2</span>:
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">phys_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">ReasonCode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ReasonCode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_IR2_RC_LD_STATE_CHANGED</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;IR2: LD State Changed: &quot;</span>
			    <span class="s">&quot;id=%d channel=%d phys_num=%d&quot;</span><span class="p">,</span>
			    <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">phys_num</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_IR2_RC_PD_STATE_CHANGED</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;IR2: PD State Changed &quot;</span>
			    <span class="s">&quot;id=%d channel=%d phys_num=%d&quot;</span><span class="p">,</span>
			    <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">phys_num</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_IR2_RC_BAD_BLOCK_TABLE_FULL</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;IR2: Bad Block Table Full: &quot;</span>
			    <span class="s">&quot;id=%d channel=%d phys_num=%d&quot;</span><span class="p">,</span>
			    <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">phys_num</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_IR2_RC_PD_INSERTED</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;IR2: PD Inserted: &quot;</span>
			    <span class="s">&quot;id=%d channel=%d phys_num=%d&quot;</span><span class="p">,</span>
			    <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">phys_num</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_IR2_RC_PD_REMOVED</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;IR2: PD Removed: &quot;</span>
			    <span class="s">&quot;id=%d channel=%d phys_num=%d&quot;</span><span class="p">,</span>
			    <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">phys_num</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_IR2_RC_FOREIGN_CFG_DETECTED</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;IR2: Foreign CFG Detected: &quot;</span>
			    <span class="s">&quot;id=%d channel=%d phys_num=%d&quot;</span><span class="p">,</span>
			    <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">phys_num</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_IR2_RC_REBUILD_MEDIUM_ERROR</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;IR2: Rebuild Medium Error: &quot;</span>
			    <span class="s">&quot;id=%d channel=%d phys_num=%d&quot;</span><span class="p">,</span>
			    <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">phys_num</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_IR2_RC_DUAL_PORT_ADDED</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;IR2: Dual Port Added: &quot;</span>
			    <span class="s">&quot;id=%d channel=%d phys_num=%d&quot;</span><span class="p">,</span>
			    <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">phys_num</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_IR2_RC_DUAL_PORT_REMOVED</span>:
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;IR2: Dual Port Removed: &quot;</span>
			    <span class="s">&quot;id=%d channel=%d phys_num=%d&quot;</span><span class="p">,</span>
			    <span class="n">id</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">phys_num</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;IR2&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_DISCOVERY</span>:
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evData0</span><span class="p">)</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;SAS Discovery: Start&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;SAS Discovery: Stop&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_LOG_ENTRY_ADDED</span>:
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;SAS Log Entry Added&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_BROADCAST_PRIMITIVE</span>:
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">phy_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">port_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">port_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">primative</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
		    <span class="s">&quot;SAS Broadcase Primative: phy=%d port=%d &quot;</span>
		    <span class="s">&quot;width=%d primative=0x%02x&quot;</span><span class="p">,</span>
		    <span class="n">phy_num</span><span class="p">,</span> <span class="n">port_num</span><span class="p">,</span> <span class="n">port_width</span><span class="p">,</span> <span class="n">primative</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_INIT_DEVICE_STATUS_CHANGE</span>:
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">reason</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_INIT_RC_ADDED</span>:
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;SAS Initiator Status Change: Added&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_INIT_RC_REMOVED</span>:
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;SAS Initiator Status Change: Deleted&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;SAS Initiator Status Change&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_INIT_TABLE_OVERFLOW</span>:
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">max_init</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">current_init</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
		    <span class="s">&quot;SAS Initiator Device Table Overflow: max initiators=%02d &quot;</span>
		    <span class="s">&quot;current initators=%02d&quot;</span><span class="p">,</span>
		    <span class="n">max_init</span><span class="p">,</span> <span class="n">current_init</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_SMP_ERROR</span>:
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">port_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">MPI_EVENT_SAS_SMP_FUNCTION_RESULT_VALID</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS SMP Error: port=%d result=0x%02x&quot;</span><span class="p">,</span>
			    <span class="n">port_num</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">MPI_EVENT_SAS_SMP_CRC_ERROR</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS SMP Error: port=%d : CRC Error&quot;</span><span class="p">,</span>
			    <span class="n">port_num</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">MPI_EVENT_SAS_SMP_TIMEOUT</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS SMP Error: port=%d : Timeout&quot;</span><span class="p">,</span>
			    <span class="n">port_num</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">MPI_EVENT_SAS_SMP_NO_DESTINATION</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS SMP Error: port=%d : No Destination&quot;</span><span class="p">,</span>
			    <span class="n">port_num</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">MPI_EVENT_SAS_SMP_BAD_DESTINATION</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS SMP Error: port=%d : Bad Destination&quot;</span><span class="p">,</span>
			    <span class="n">port_num</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
			    <span class="s">&quot;SAS SMP Error: port=%d : status=0x%02x&quot;</span><span class="p">,</span>
			    <span class="n">port_num</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">MPI_EVENT_SAS_EXPANDER_STATUS_CHANGE</span>:
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">reason</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">evData0</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_EXP_RC_ADDED</span>:
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Expander Status Change: Added&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MPI_EVENT_SAS_EXP_RC_NOT_RESPONDING</span>:
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Expander Status Change: Deleted&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Expander Status Change&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  MPT base &quot;custom&quot; events may be added here...</span>
<span class="cm">	 */</span>
	<span class="nl">default:</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ds</span><span class="p">)</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">evStr</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">);</span>


	<span class="n">devtprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
	    <span class="s">&quot;MPT event:(%02Xh) : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">evStr</span><span class="p">));</span>

	<span class="n">devtverboseprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">MYNAM</span>
	    <span class="s">&quot;: Event data:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pEventReply</span><span class="o">-&gt;</span><span class="n">EventDataLength</span><span class="p">);</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span>
		<span class="n">devtverboseprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot; %08x&quot;</span><span class="p">,</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pEventReply</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">[</span><span class="n">ii</span><span class="p">])));</span>
	<span class="n">devtverboseprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	ProcessEventNotification - Route EventNotificationReply to all event handlers</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@pEventReply: Pointer to EventNotification reply frame</span>
<span class="cm"> *	@evHandlers: Pointer to integer, number of event handlers</span>
<span class="cm"> *</span>
<span class="cm"> *	Routes a received EventNotificationReply to all currently registered</span>
<span class="cm"> *	event handlers.</span>
<span class="cm"> *	Returns sum of event handlers return values.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ProcessEventNotification</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">EventNotificationReply_t</span> <span class="o">*</span><span class="n">pEventReply</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">evHandlers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">evDataLen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">evData0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ii</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cb_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handlers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">event</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Do platform normalization of values</span>
<span class="cm">	 */</span>
	<span class="n">event</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pEventReply</span><span class="o">-&gt;</span><span class="n">Event</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">evDataLen</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pEventReply</span><span class="o">-&gt;</span><span class="n">EventDataLength</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evDataLen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">evData0</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pEventReply</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_FUSION_LOGGING</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">evDataLen</span><span class="p">)</span>
		<span class="n">mpt_display_event_info</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">pEventReply</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Do general / base driver event processing</span>
<span class="cm">	 */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_EVENT_CHANGE</span>:		<span class="cm">/* 0A */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">evDataLen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">evState</span> <span class="o">=</span> <span class="n">evData0</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

			<span class="cm">/* CHECKME! What if evState unexpectedly says OFF (0)? */</span>

			<span class="cm">/* Update EventState field in cached IocFacts */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">Function</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">facts</span><span class="p">.</span><span class="n">EventState</span> <span class="o">=</span> <span class="n">evState</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_EVENT_INTEGRATED_RAID</span>:
		<span class="n">mptbase_raid_process_event_data</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">MpiEventDataRaid_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pEventReply</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Should this event be logged? Events are written sequentially.</span>
<span class="cm">	 * When buffer is full, start again at the top.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">eventTypes</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">event</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

		<span class="n">idx</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">eventContext</span> <span class="o">%</span> <span class="n">MPTCTL_EVENT_LOG_SIZE</span><span class="p">;</span>

		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">eventContext</span> <span class="o">=</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">eventContext</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&lt;</span> <span class="n">evDataLen</span><span class="p">)</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pEventReply</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">[</span><span class="n">ii</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">eventContext</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 *  Call each currently registered protocol event handler.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">cb_idx</span><span class="p">;</span> <span class="n">cb_idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MptEvHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">devtverboseprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			    <span class="s">&quot;Routing Event to event handler #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cb_idx</span><span class="p">));</span>
			<span class="n">r</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">MptEvHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]))(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">pEventReply</span><span class="p">);</span>
			<span class="n">handlers</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* FIXME?  Examine results here? */</span>

	<span class="cm">/*</span>
<span class="cm">	 *  If needed, send (a single) EventAck.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pEventReply</span><span class="o">-&gt;</span><span class="n">AckRequired</span> <span class="o">==</span> <span class="n">MPI_EVENT_NOTIFICATION_ACK_REQUIRED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devtverboseprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span>
			<span class="s">&quot;EventAck required</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ii</span> <span class="o">=</span> <span class="n">SendEventAck</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">pEventReply</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devtverboseprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;SendEventAck returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ii</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">evHandlers</span> <span class="o">=</span> <span class="n">handlers</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_fc_log_info - Log information returned from Fibre Channel IOC.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@log_info: U32 LogInfo reply word from the IOC</span>
<span class="cm"> *</span>
<span class="cm"> *	Refer to lsi/mpi_log_fc.h.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_fc_log_info</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">log_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">log_info</span> <span class="o">&amp;</span> <span class="mh">0xFF000000</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPI_IOCLOGINFO_FC_INIT_BASE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;FCP Initiator&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCLOGINFO_FC_TARGET_BASE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;FCP Target&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCLOGINFO_FC_LAN_BASE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;LAN&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCLOGINFO_FC_MSG_BASE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;MPI Message Layer&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCLOGINFO_FC_LINK_BASE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;FC Link&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCLOGINFO_FC_CTX_BASE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Context Manager&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCLOGINFO_FC_INVALID_FIELD_BYTE_OFFSET</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Invalid Field Offset&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPI_IOCLOGINFO_FC_STATE_CHANGE</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;State Change Info&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;LogInfo(0x%08x): SubClass={%s}, Value=(0x%06x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">log_info</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="p">(</span><span class="n">log_info</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_spi_log_info - Log information returned from SCSI Parallel IOC.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@log_info: U32 LogInfo word from the IOC</span>
<span class="cm"> *</span>
<span class="cm"> *	Refer to lsi/sp_log.h.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_spi_log_info</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">log_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">info</span> <span class="o">=</span> <span class="n">log_info</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00010000</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;bug! MID not found&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x00020000</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Parity Error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x00030000</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;ASYNC Outbound Overrun&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x00040000</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;SYNC Offset Error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x00050000</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;BM Change&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x00060000</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Msg In Overflow&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x00070000</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;DMA Error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x00080000</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Outbound DMA Overrun&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x00090000</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Task Management&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x000A0000</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Device Problem&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x000B0000</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Invalid Phase Change&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x000C0000</span>:
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Untagged Table Size&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span> <span class="s">&quot;LogInfo(0x%08x): F/W: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">log_info</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* strings for sas loginfo */</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">originator_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;IOP&quot;</span><span class="p">,</span>						<span class="cm">/* 00h */</span>
		<span class="s">&quot;PL&quot;</span><span class="p">,</span>						<span class="cm">/* 01h */</span>
		<span class="s">&quot;IR&quot;</span>						<span class="cm">/* 02h */</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">iop_code_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 00h */</span>
		<span class="s">&quot;Invalid SAS Address&quot;</span><span class="p">,</span>				<span class="cm">/* 01h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 02h */</span>
		<span class="s">&quot;Invalid Page&quot;</span><span class="p">,</span>					<span class="cm">/* 03h */</span>
		<span class="s">&quot;Diag Message Error&quot;</span><span class="p">,</span>				<span class="cm">/* 04h */</span>
		<span class="s">&quot;Task Terminated&quot;</span><span class="p">,</span>				<span class="cm">/* 05h */</span>
		<span class="s">&quot;Enclosure Management&quot;</span><span class="p">,</span>				<span class="cm">/* 06h */</span>
		<span class="s">&quot;Target Mode&quot;</span>					<span class="cm">/* 07h */</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pl_code_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 00h */</span>
		<span class="s">&quot;Open Failure&quot;</span><span class="p">,</span>					<span class="cm">/* 01h */</span>
		<span class="s">&quot;Invalid Scatter Gather List&quot;</span><span class="p">,</span>			<span class="cm">/* 02h */</span>
		<span class="s">&quot;Wrong Relative Offset or Frame Length&quot;</span><span class="p">,</span>	<span class="cm">/* 03h */</span>
		<span class="s">&quot;Frame Transfer Error&quot;</span><span class="p">,</span>				<span class="cm">/* 04h */</span>
		<span class="s">&quot;Transmit Frame Connected Low&quot;</span><span class="p">,</span>			<span class="cm">/* 05h */</span>
		<span class="s">&quot;SATA Non-NCQ RW Error Bit Set&quot;</span><span class="p">,</span>		<span class="cm">/* 06h */</span>
		<span class="s">&quot;SATA Read Log Receive Data Error&quot;</span><span class="p">,</span>		<span class="cm">/* 07h */</span>
		<span class="s">&quot;SATA NCQ Fail All Commands After Error&quot;</span><span class="p">,</span>	<span class="cm">/* 08h */</span>
		<span class="s">&quot;SATA Error in Receive Set Device Bit FIS&quot;</span><span class="p">,</span>	<span class="cm">/* 09h */</span>
		<span class="s">&quot;Receive Frame Invalid Message&quot;</span><span class="p">,</span>		<span class="cm">/* 0Ah */</span>
		<span class="s">&quot;Receive Context Message Valid Error&quot;</span><span class="p">,</span>		<span class="cm">/* 0Bh */</span>
		<span class="s">&quot;Receive Frame Current Frame Error&quot;</span><span class="p">,</span>		<span class="cm">/* 0Ch */</span>
		<span class="s">&quot;SATA Link Down&quot;</span><span class="p">,</span>				<span class="cm">/* 0Dh */</span>
		<span class="s">&quot;Discovery SATA Init W IOS&quot;</span><span class="p">,</span>			<span class="cm">/* 0Eh */</span>
		<span class="s">&quot;Config Invalid Page&quot;</span><span class="p">,</span>				<span class="cm">/* 0Fh */</span>
		<span class="s">&quot;Discovery SATA Init Timeout&quot;</span><span class="p">,</span>			<span class="cm">/* 10h */</span>
		<span class="s">&quot;Reset&quot;</span><span class="p">,</span>					<span class="cm">/* 11h */</span>
		<span class="s">&quot;Abort&quot;</span><span class="p">,</span>					<span class="cm">/* 12h */</span>
		<span class="s">&quot;IO Not Yet Executed&quot;</span><span class="p">,</span>				<span class="cm">/* 13h */</span>
		<span class="s">&quot;IO Executed&quot;</span><span class="p">,</span>					<span class="cm">/* 14h */</span>
		<span class="s">&quot;Persistent Reservation Out Not Affiliation &quot;</span>
		    <span class="s">&quot;Owner&quot;</span><span class="p">,</span> 					<span class="cm">/* 15h */</span>
		<span class="s">&quot;Open Transmit DMA Abort&quot;</span><span class="p">,</span>			<span class="cm">/* 16h */</span>
		<span class="s">&quot;IO Device Missing Delay Retry&quot;</span><span class="p">,</span>		<span class="cm">/* 17h */</span>
		<span class="s">&quot;IO Cancelled Due to Receive Error&quot;</span><span class="p">,</span>		<span class="cm">/* 18h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 19h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 1Ah */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 1Bh */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 1Ch */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 1Dh */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 1Eh */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 1Fh */</span>
		<span class="s">&quot;Enclosure Management&quot;</span>				<span class="cm">/* 20h */</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ir_code_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Raid Action Error&quot;</span><span class="p">,</span>				<span class="cm">/* 00h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 00h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 01h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 02h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 03h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 04h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 05h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 06h */</span>
		<span class="nb">NULL</span>						<span class="cm">/* 07h */</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">raid_sub_code_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="nb">NULL</span><span class="p">,</span> 						<span class="cm">/* 00h */</span>
		<span class="s">&quot;Volume Creation Failed: Data Passed too &quot;</span>
		    <span class="s">&quot;Large&quot;</span><span class="p">,</span> 					<span class="cm">/* 01h */</span>
		<span class="s">&quot;Volume Creation Failed: Duplicate Volumes &quot;</span>
		    <span class="s">&quot;Attempted&quot;</span><span class="p">,</span> 				<span class="cm">/* 02h */</span>
		<span class="s">&quot;Volume Creation Failed: Max Number &quot;</span>
		    <span class="s">&quot;Supported Volumes Exceeded&quot;</span><span class="p">,</span>		<span class="cm">/* 03h */</span>
		<span class="s">&quot;Volume Creation Failed: DMA Error&quot;</span><span class="p">,</span>		<span class="cm">/* 04h */</span>
		<span class="s">&quot;Volume Creation Failed: Invalid Volume Type&quot;</span><span class="p">,</span>	<span class="cm">/* 05h */</span>
		<span class="s">&quot;Volume Creation Failed: Error Reading &quot;</span>
		    <span class="s">&quot;MFG Page 4&quot;</span><span class="p">,</span> 				<span class="cm">/* 06h */</span>
		<span class="s">&quot;Volume Creation Failed: Creating Internal &quot;</span>
		    <span class="s">&quot;Structures&quot;</span><span class="p">,</span> 				<span class="cm">/* 07h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 08h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 09h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 0Ah */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 0Bh */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 0Ch */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 0Dh */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 0Eh */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 0Fh */</span>
		<span class="s">&quot;Activation failed: Already Active Volume&quot;</span><span class="p">,</span> 	<span class="cm">/* 10h */</span>
		<span class="s">&quot;Activation failed: Unsupported Volume Type&quot;</span><span class="p">,</span> 	<span class="cm">/* 11h */</span>
		<span class="s">&quot;Activation failed: Too Many Active Volumes&quot;</span><span class="p">,</span> 	<span class="cm">/* 12h */</span>
		<span class="s">&quot;Activation failed: Volume ID in Use&quot;</span><span class="p">,</span> 		<span class="cm">/* 13h */</span>
		<span class="s">&quot;Activation failed: Reported Failure&quot;</span><span class="p">,</span> 		<span class="cm">/* 14h */</span>
		<span class="s">&quot;Activation failed: Importing a Volume&quot;</span><span class="p">,</span> 	<span class="cm">/* 15h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 16h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 17h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 18h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 19h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 1Ah */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 1Bh */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 1Ch */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 1Dh */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 1Eh */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 1Fh */</span>
		<span class="s">&quot;Phys Disk failed: Too Many Phys Disks&quot;</span><span class="p">,</span> 	<span class="cm">/* 20h */</span>
		<span class="s">&quot;Phys Disk failed: Data Passed too Large&quot;</span><span class="p">,</span>	<span class="cm">/* 21h */</span>
		<span class="s">&quot;Phys Disk failed: DMA Error&quot;</span><span class="p">,</span> 			<span class="cm">/* 22h */</span>
		<span class="s">&quot;Phys Disk failed: Invalid &lt;channel:id&gt;&quot;</span><span class="p">,</span> 	<span class="cm">/* 23h */</span>
		<span class="s">&quot;Phys Disk failed: Creating Phys Disk Config &quot;</span>
		    <span class="s">&quot;Page&quot;</span><span class="p">,</span> 					<span class="cm">/* 24h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 25h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 26h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 27h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 28h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 29h */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 2Ah */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 2Bh */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 2Ch */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 2Dh */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 2Eh */</span>
		<span class="nb">NULL</span><span class="p">,</span>						<span class="cm">/* 2Fh */</span>
		<span class="s">&quot;Compatibility Error: IR Disabled&quot;</span><span class="p">,</span>		<span class="cm">/* 30h */</span>
		<span class="s">&quot;Compatibility Error: Inquiry Command Failed&quot;</span><span class="p">,</span>	<span class="cm">/* 31h */</span>
		<span class="s">&quot;Compatibility Error: Device not Direct Access &quot;</span>
		    <span class="s">&quot;Device &quot;</span><span class="p">,</span>					<span class="cm">/* 32h */</span>
		<span class="s">&quot;Compatibility Error: Removable Device Found&quot;</span><span class="p">,</span>	<span class="cm">/* 33h */</span>
		<span class="s">&quot;Compatibility Error: Device SCSI Version not &quot;</span>
		    <span class="s">&quot;2 or Higher&quot;</span><span class="p">,</span> 				<span class="cm">/* 34h */</span>
		<span class="s">&quot;Compatibility Error: SATA Device, 48 BIT LBA &quot;</span>
		    <span class="s">&quot;not Supported&quot;</span><span class="p">,</span> 				<span class="cm">/* 35h */</span>
		<span class="s">&quot;Compatibility Error: Device doesn&#39;t have &quot;</span>
		    <span class="s">&quot;512 Byte Block Sizes&quot;</span><span class="p">,</span> 			<span class="cm">/* 36h */</span>
		<span class="s">&quot;Compatibility Error: Volume Type Check Failed&quot;</span><span class="p">,</span> <span class="cm">/* 37h */</span>
		<span class="s">&quot;Compatibility Error: Volume Type is &quot;</span>
		    <span class="s">&quot;Unsupported by FW&quot;</span><span class="p">,</span> 			<span class="cm">/* 38h */</span>
		<span class="s">&quot;Compatibility Error: Disk Drive too Small for &quot;</span>
		    <span class="s">&quot;use in Volume&quot;</span><span class="p">,</span> 				<span class="cm">/* 39h */</span>
		<span class="s">&quot;Compatibility Error: Phys Disk for Create &quot;</span>
		    <span class="s">&quot;Volume not Found&quot;</span><span class="p">,</span> 			<span class="cm">/* 3Ah */</span>
		<span class="s">&quot;Compatibility Error: Too Many or too Few &quot;</span>
		    <span class="s">&quot;Disks for Volume Type&quot;</span><span class="p">,</span> 			<span class="cm">/* 3Bh */</span>
		<span class="s">&quot;Compatibility Error: Disk stripe Sizes &quot;</span>
		    <span class="s">&quot;Must be 64KB&quot;</span><span class="p">,</span> 				<span class="cm">/* 3Ch */</span>
		<span class="s">&quot;Compatibility Error: IME Size Limited to &lt; 2TB&quot;</span><span class="p">,</span> <span class="cm">/* 3Dh */</span>
	<span class="p">};</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_sas_log_info - Log information returned from SAS IOC.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@log_info: U32 LogInfo reply word from the IOC</span>
<span class="cm"> *	@cb_idx: callback function&#39;s handle</span>
<span class="cm"> *</span>
<span class="cm"> *	Refer to lsi/mpi_log_sas.h.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_sas_log_info</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">log_info</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cb_idx</span><span class="p">)</span>
<span class="p">{</span>
<span class="k">union</span> <span class="n">loginfo_type</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">loginfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span>	<span class="n">subcode</span><span class="o">:</span><span class="mi">16</span><span class="p">;</span>
		<span class="n">u32</span>	<span class="n">code</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
		<span class="n">u32</span>	<span class="n">originator</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
		<span class="n">u32</span>	<span class="n">bus_type</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span><span class="n">dw</span><span class="p">;</span>
<span class="p">};</span>
	<span class="k">union</span> <span class="n">loginfo_type</span> <span class="n">sas_loginfo</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">originator_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">code_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sub_code_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sas_loginfo</span><span class="p">.</span><span class="n">loginfo</span> <span class="o">=</span> <span class="n">log_info</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="mi">3</span> <span class="cm">/*SAS*/</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">originator</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">originator_str</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">originator_desc</span> <span class="o">=</span> <span class="n">originator_str</span><span class="p">[</span><span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">originator</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">originator</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="mi">0</span>:  <span class="cm">/* IOP */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">code</span> <span class="o">&lt;</span>
			    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">iop_code_str</span><span class="p">))</span>
				<span class="n">code_desc</span> <span class="o">=</span> <span class="n">iop_code_str</span><span class="p">[</span><span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">code</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:  <span class="cm">/* PL */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">code</span> <span class="o">&lt;</span>
			    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pl_code_str</span><span class="p">))</span>
				<span class="n">code_desc</span> <span class="o">=</span> <span class="n">pl_code_str</span><span class="p">[</span><span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">code</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:  <span class="cm">/* IR */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">code</span> <span class="o">&gt;=</span>
			    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ir_code_str</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">code_desc</span> <span class="o">=</span> <span class="n">ir_code_str</span><span class="p">[</span><span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">code</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">subcode</span> <span class="o">&gt;=</span>
			    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">raid_sub_code_str</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">sub_code_desc</span> <span class="o">=</span>
				    <span class="n">raid_sub_code_str</span><span class="p">[</span><span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">subcode</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sub_code_desc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span>
			<span class="s">&quot;LogInfo(0x%08x): Originator={%s}, Code={%s},&quot;</span>
			<span class="s">&quot; SubCode={%s} cb_idx %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">log_info</span><span class="p">,</span> <span class="n">originator_desc</span><span class="p">,</span> <span class="n">code_desc</span><span class="p">,</span>
			<span class="n">sub_code_desc</span><span class="p">,</span> <span class="n">MptCallbacksName</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code_desc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span>
			<span class="s">&quot;LogInfo(0x%08x): Originator={%s}, Code={%s},&quot;</span>
			<span class="s">&quot; SubCode(0x%04x) cb_idx %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">log_info</span><span class="p">,</span> <span class="n">originator_desc</span><span class="p">,</span> <span class="n">code_desc</span><span class="p">,</span>
			<span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">subcode</span><span class="p">,</span> <span class="n">MptCallbacksName</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_INFO_FMT</span>
			<span class="s">&quot;LogInfo(0x%08x): Originator={%s}, Code=(0x%02x),&quot;</span>
			<span class="s">&quot; SubCode(0x%04x) cb_idx %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">log_info</span><span class="p">,</span> <span class="n">originator_desc</span><span class="p">,</span>
			<span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">code</span><span class="p">,</span> <span class="n">sas_loginfo</span><span class="p">.</span><span class="n">dw</span><span class="p">.</span><span class="n">subcode</span><span class="p">,</span>
			<span class="n">MptCallbacksName</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	mpt_iocstatus_info_config - IOCSTATUS information for config pages</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@ioc_status: U32 IOCStatus word from IOC</span>
<span class="cm"> *	@mf: Pointer to MPT request frame</span>
<span class="cm"> *</span>
<span class="cm"> *	Refer to lsi/mpi.h.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_iocstatus_info_config</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ioc_status</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Config_t</span> <span class="o">*</span><span class="n">pReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">Config_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">extend_desc</span><span class="p">[</span><span class="n">EVENT_DESCR_STR_SZ</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">form</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">page_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageType</span> <span class="o">==</span> <span class="n">MPI_CONFIG_PAGETYPE_EXTENDED</span><span class="p">)</span>
		<span class="n">page_type</span> <span class="o">=</span> <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">ExtPageType</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">page_type</span> <span class="o">=</span> <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageType</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ignore invalid page messages for GET_NEXT_HANDLE</span>
<span class="cm">	 */</span>
	<span class="n">form</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pReq</span><span class="o">-&gt;</span><span class="n">PageAddress</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ioc_status</span> <span class="o">==</span> <span class="n">MPI_IOCSTATUS_CONFIG_INVALID_PAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page_type</span> <span class="o">==</span> <span class="n">MPI_CONFIG_EXTPAGETYPE_SAS_DEVICE</span> <span class="o">||</span>
		    <span class="n">page_type</span> <span class="o">==</span> <span class="n">MPI_CONFIG_EXTPAGETYPE_SAS_EXPANDER</span> <span class="o">||</span>
		    <span class="n">page_type</span> <span class="o">==</span> <span class="n">MPI_CONFIG_EXTPAGETYPE_ENCLOSURE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">form</span> <span class="o">&gt;&gt;</span> <span class="n">MPI_SAS_DEVICE_PGAD_FORM_SHIFT</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">MPI_SAS_DEVICE_PGAD_FORM_GET_NEXT_HANDLE</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page_type</span> <span class="o">==</span> <span class="n">MPI_CONFIG_PAGETYPE_FC_DEVICE</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">form</span> <span class="o">&amp;</span> <span class="n">MPI_FC_DEVICE_PGAD_FORM_MASK</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">MPI_FC_DEVICE_PGAD_FORM_NEXT_DID</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">extend_desc</span><span class="p">,</span> <span class="n">EVENT_DESCR_STR_SZ</span><span class="p">,</span>
	    <span class="s">&quot;type=%02Xh, page=%02Xh, action=%02Xh, form=%08Xh&quot;</span><span class="p">,</span>
	    <span class="n">page_type</span><span class="p">,</span> <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Header</span><span class="p">.</span><span class="n">PageNumber</span><span class="p">,</span> <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">Action</span><span class="p">,</span> <span class="n">form</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ioc_status</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_CONFIG_INVALID_ACTION</span>: <span class="cm">/* 0x0020 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Config Page Invalid Action&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_CONFIG_INVALID_TYPE</span>:   <span class="cm">/* 0x0021 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Config Page Invalid Type&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_CONFIG_INVALID_PAGE</span>:   <span class="cm">/* 0x0022 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Config Page Invalid Page&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_CONFIG_INVALID_DATA</span>:   <span class="cm">/* 0x0023 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Config Page Invalid Data&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_CONFIG_NO_DEFAULTS</span>:    <span class="cm">/* 0x0024 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Config Page No Defaults&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_CONFIG_CANT_COMMIT</span>:    <span class="cm">/* 0x0025 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Config Page Can&#39;t Commit&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dreplyprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;IOCStatus(0x%04X): %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ioc_status</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">extend_desc</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	mpt_iocstatus_info - IOCSTATUS information returned from IOC.</span>
<span class="cm"> *	@ioc: Pointer to MPT_ADAPTER structure</span>
<span class="cm"> *	@ioc_status: U32 IOCStatus word from IOC</span>
<span class="cm"> *	@mf: Pointer to MPT request frame</span>
<span class="cm"> *</span>
<span class="cm"> *	Refer to lsi/mpi.h.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpt_iocstatus_info</span><span class="p">(</span><span class="n">MPT_ADAPTER</span> <span class="o">*</span><span class="n">ioc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ioc_status</span><span class="p">,</span> <span class="n">MPT_FRAME_HDR</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ioc_status</span> <span class="o">&amp;</span> <span class="n">MPI_IOCSTATUS_MASK</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*  Common IOCStatus values for all replies                                 */</span>
<span class="cm">/****************************************************************************/</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_INVALID_FUNCTION</span>: <span class="cm">/* 0x0001 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Invalid Function&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_BUSY</span>: <span class="cm">/* 0x0002 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Busy&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_INVALID_SGL</span>: <span class="cm">/* 0x0003 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Invalid SGL&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_INTERNAL_ERROR</span>: <span class="cm">/* 0x0004 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Internal Error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_RESERVED</span>: <span class="cm">/* 0x0005 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Reserved&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_INSUFFICIENT_RESOURCES</span>: <span class="cm">/* 0x0006 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Insufficient Resources&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_INVALID_FIELD</span>: <span class="cm">/* 0x0007 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Invalid Field&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_INVALID_STATE</span>: <span class="cm">/* 0x0008 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Invalid State&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*  Config IOCStatus values                                                 */</span>
<span class="cm">/****************************************************************************/</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_CONFIG_INVALID_ACTION</span>: <span class="cm">/* 0x0020 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_CONFIG_INVALID_TYPE</span>:   <span class="cm">/* 0x0021 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_CONFIG_INVALID_PAGE</span>:   <span class="cm">/* 0x0022 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_CONFIG_INVALID_DATA</span>:   <span class="cm">/* 0x0023 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_CONFIG_NO_DEFAULTS</span>:    <span class="cm">/* 0x0024 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_CONFIG_CANT_COMMIT</span>:    <span class="cm">/* 0x0025 */</span>
		<span class="n">mpt_iocstatus_info_config</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*  SCSIIO Reply (SPI, FCP, SAS) initiator values                           */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/*  Look at mptscsih_iocstatus_info_scsiio in mptscsih.c */</span>
<span class="cm">/*                                                                          */</span>
<span class="cm">/****************************************************************************/</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_RECOVERED_ERROR</span>: <span class="cm">/* 0x0040 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_DATA_UNDERRUN</span>: <span class="cm">/* 0x0045 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_INVALID_BUS</span>: <span class="cm">/* 0x0041 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_INVALID_TARGETID</span>: <span class="cm">/* 0x0042 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_DEVICE_NOT_THERE</span>: <span class="cm">/* 0x0043 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_DATA_OVERRUN</span>: <span class="cm">/* 0x0044 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_IO_DATA_ERROR</span>: <span class="cm">/* 0x0046 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_PROTOCOL_ERROR</span>: <span class="cm">/* 0x0047 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_TASK_TERMINATED</span>: <span class="cm">/* 0x0048 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_RESIDUAL_MISMATCH</span>: <span class="cm">/* 0x0049 */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_TASK_MGMT_FAILED</span>: <span class="cm">/* 0x004A */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_IOC_TERMINATED</span>: <span class="cm">/* 0x004B */</span>
	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SCSI_EXT_TERMINATED</span>: <span class="cm">/* 0x004C */</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*  SCSI Target values                                                      */</span>
<span class="cm">/****************************************************************************/</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_TARGET_PRIORITY_IO</span>: <span class="cm">/* 0x0060 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Target: Priority IO&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_TARGET_INVALID_PORT</span>: <span class="cm">/* 0x0061 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Target: Invalid Port&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_TARGET_INVALID_IO_INDEX</span>: <span class="cm">/* 0x0062 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Target Invalid IO Index:&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_TARGET_ABORTED</span>: <span class="cm">/* 0x0063 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Target: Aborted&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_TARGET_NO_CONN_RETRYABLE</span>: <span class="cm">/* 0x0064 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Target: No Conn Retryable&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_TARGET_NO_CONNECTION</span>: <span class="cm">/* 0x0065 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Target: No Connection&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_TARGET_XFER_COUNT_MISMATCH</span>: <span class="cm">/* 0x006A */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Target: Transfer Count Mismatch&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_TARGET_STS_DATA_NOT_SENT</span>: <span class="cm">/* 0x006B */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Target: STS Data not Sent&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_TARGET_DATA_OFFSET_ERROR</span>: <span class="cm">/* 0x006D */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Target: Data Offset Error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_TARGET_TOO_MUCH_WRITE_DATA</span>: <span class="cm">/* 0x006E */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Target: Too Much Write Data&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_TARGET_IU_TOO_SHORT</span>: <span class="cm">/* 0x006F */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Target: IU Too Short&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_TARGET_ACK_NAK_TIMEOUT</span>: <span class="cm">/* 0x0070 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Target: ACK NAK Timeout&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_TARGET_NAK_RECEIVED</span>: <span class="cm">/* 0x0071 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Target: Nak Received&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*  Fibre Channel Direct Access values                                      */</span>
<span class="cm">/****************************************************************************/</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_FC_ABORTED</span>: <span class="cm">/* 0x0066 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;FC: Aborted&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_FC_RX_ID_INVALID</span>: <span class="cm">/* 0x0067 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;FC: RX ID Invalid&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_FC_DID_INVALID</span>: <span class="cm">/* 0x0068 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;FC: DID Invalid&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_FC_NODE_LOGGED_OUT</span>: <span class="cm">/* 0x0069 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;FC: Node Logged Out&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_FC_EXCHANGE_CANCELED</span>: <span class="cm">/* 0x006C */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;FC: Exchange Canceled&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*  LAN values                                                              */</span>
<span class="cm">/****************************************************************************/</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_LAN_DEVICE_NOT_FOUND</span>: <span class="cm">/* 0x0080 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;LAN: Device not Found&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_LAN_DEVICE_FAILURE</span>: <span class="cm">/* 0x0081 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;LAN: Device Failure&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_LAN_TRANSMIT_ERROR</span>: <span class="cm">/* 0x0082 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;LAN: Transmit Error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_LAN_TRANSMIT_ABORTED</span>: <span class="cm">/* 0x0083 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;LAN: Transmit Aborted&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_LAN_RECEIVE_ERROR</span>: <span class="cm">/* 0x0084 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;LAN: Receive Error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_LAN_RECEIVE_ABORTED</span>: <span class="cm">/* 0x0085 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;LAN: Receive Aborted&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_LAN_PARTIAL_PACKET</span>: <span class="cm">/* 0x0086 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;LAN: Partial Packet&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_LAN_CANCELED</span>: <span class="cm">/* 0x0087 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;LAN: Canceled&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cm">/****************************************************************************/</span>
<span class="cm">/*  Serial Attached SCSI values                                             */</span>
<span class="cm">/****************************************************************************/</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SAS_SMP_REQUEST_FAILED</span>: <span class="cm">/* 0x0090 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;SAS: SMP Request Failed&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MPI_IOCSTATUS_SAS_SMP_DATA_OVERRUN</span>: <span class="cm">/* 0x0090 */</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;SAS: SMP Data Overrun&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Others&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dreplyprintk</span><span class="p">(</span><span class="n">ioc</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">MYIOC_s_DEBUG_FMT</span> <span class="s">&quot;IOCStatus(0x%04X): %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ioc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">desc</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_attach</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_detach</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_resume</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_suspend</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ioc_list</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_register</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_deregister</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_event_register</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_event_deregister</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_reset_register</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_reset_deregister</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_device_driver_register</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_device_driver_deregister</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_get_msg_frame</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_put_msg_frame</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_put_msg_frame_hi_pri</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_free_msg_frame</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_send_handshake_request</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_verify_adapter</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_GetIocState</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_print_ioc_summary</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_HardResetHandler</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_config</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_findImVolumes</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_alloc_fw_memory</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_free_fw_memory</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mptbase_sas_persist_operation</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpt_raid_phys_disk_pg0</span><span class="p">);</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	fusion_init - Fusion MPT base driver initialization routine.</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns 0 for success, non-zero for failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">fusion_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cb_idx</span><span class="p">;</span>

	<span class="n">show_mptmod_ver</span><span class="p">(</span><span class="n">my_NAME</span><span class="p">,</span> <span class="n">my_VERSION</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">COPYRIGHT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cb_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cb_idx</span> <span class="o">&lt;</span> <span class="n">MPT_MAX_PROTOCOL_DRIVERS</span><span class="p">;</span> <span class="n">cb_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MptCallbacks</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">MptDriverClass</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">MPTUNKNOWN_DRIVER</span><span class="p">;</span>
		<span class="n">MptEvHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">MptResetHandlers</span><span class="p">[</span><span class="n">cb_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*  Register ourselves (mptbase) in order to facilitate</span>
<span class="cm">	 *  EventNotification handling.</span>
<span class="cm">	 */</span>
	<span class="n">mpt_base_index</span> <span class="o">=</span> <span class="n">mpt_register</span><span class="p">(</span><span class="n">mptbase_reply</span><span class="p">,</span> <span class="n">MPTBASE_DRIVER</span><span class="p">,</span>
	    <span class="s">&quot;mptbase_reply&quot;</span><span class="p">);</span>

	<span class="cm">/* Register for hard reset handling callbacks.</span>
<span class="cm">	 */</span>
	<span class="n">mpt_reset_register</span><span class="p">(</span><span class="n">mpt_base_index</span><span class="p">,</span> <span class="n">mpt_ioc_reset</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">procmpt_create</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=*/</span>
<span class="cm">/**</span>
<span class="cm"> *	fusion_exit - Perform driver unload cleanup.</span>
<span class="cm"> *</span>
<span class="cm"> *	This routine frees all resources associated with each MPT adapter</span>
<span class="cm"> *	and removes all %MPT_PROCFS_MPTBASEDIR entries.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">fusion_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">mpt_reset_deregister</span><span class="p">(</span><span class="n">mpt_base_index</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="n">procmpt_destroy</span><span class="p">();</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">fusion_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">fusion_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
