<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › parport › parport_pc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>parport_pc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Low-level parallel-port routines for 8255-based PC-style hardware.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Phil Blundell &lt;philb@gnu.org&gt;</span>
<span class="cm"> *          Tim Waugh &lt;tim@cyberelk.demon.co.uk&gt;</span>
<span class="cm"> *	    Jose Renau &lt;renau@acm.org&gt;</span>
<span class="cm"> *          David Campbell</span>
<span class="cm"> *          Andrea Arcangeli</span>
<span class="cm"> *</span>
<span class="cm"> * based on work by Grant Guenther &lt;grant@torque.net&gt; and Phil Blundell.</span>
<span class="cm"> *</span>
<span class="cm"> * Cleaned up include files - Russell King &lt;linux@arm.uk.linux.org&gt;</span>
<span class="cm"> * DMA support - Bert De Jonghe &lt;bert@sophis.be&gt;</span>
<span class="cm"> * Many ECP bugs fixed.  Fred Barnes &amp; Jamie Lokier, 1999</span>
<span class="cm"> * More PCI support now conditional on CONFIG_PCI, 03/2001, Paul G.</span>
<span class="cm"> * Various hacks, Fred Barnes, 04/2001</span>
<span class="cm"> * Updated probing logic - Adam Belay &lt;ambx1@neo.rr.com&gt;</span>
<span class="cm"> */</span>

<span class="cm">/* This driver should work with any hardware that is broadly compatible</span>
<span class="cm"> * with that in the IBM PC.  This applies to the majority of integrated</span>
<span class="cm"> * I/O chipsets that are commonly available.  The expected register</span>
<span class="cm"> * layout is:</span>
<span class="cm"> *</span>
<span class="cm"> *	base+0		data</span>
<span class="cm"> *	base+1		status</span>
<span class="cm"> *	base+2		control</span>
<span class="cm"> *</span>
<span class="cm"> * In addition, there are some optional registers:</span>
<span class="cm"> *</span>
<span class="cm"> *	base+3		EPP address</span>
<span class="cm"> *	base+4		EPP data</span>
<span class="cm"> *	base+0x400	ECP config A</span>
<span class="cm"> *	base+0x401	ECP config B</span>
<span class="cm"> *	base+0x402	ECP control</span>
<span class="cm"> *</span>
<span class="cm"> * All registers are 8 bits wide and read/write.  If your hardware differs</span>
<span class="cm"> * only in register addresses (eg because your registers are on 32-bit</span>
<span class="cm"> * word boundaries) then you can alter the constants in parport_pc.h to</span>
<span class="cm"> * accommodate this.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that the ECP registers may not start at offset 0x400 for PCI cards,</span>
<span class="cm"> * but rather will start at port-&gt;base_hi.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/pnp.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/sysctl.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cp">#include &lt;asm/dma.h&gt;</span>

<span class="cp">#include &lt;linux/parport.h&gt;</span>
<span class="cp">#include &lt;linux/parport_pc.h&gt;</span>
<span class="cp">#include &lt;linux/via.h&gt;</span>
<span class="cp">#include &lt;asm/parport.h&gt;</span>

<span class="cp">#define PARPORT_PC_MAX_PORTS PARPORT_MAX</span>

<span class="cp">#ifdef CONFIG_ISA_DMA_API</span>
<span class="cp">#define HAS_DMA</span>
<span class="cp">#endif</span>

<span class="cm">/* ECR modes */</span>
<span class="cp">#define ECR_SPP 00</span>
<span class="cp">#define ECR_PS2 01</span>
<span class="cp">#define ECR_PPF 02</span>
<span class="cp">#define ECR_ECP 03</span>
<span class="cp">#define ECR_EPP 04</span>
<span class="cp">#define ECR_VND 05</span>
<span class="cp">#define ECR_TST 06</span>
<span class="cp">#define ECR_CNF 07</span>
<span class="cp">#define ECR_MODE_MASK 0xe0</span>
<span class="cp">#define ECR_WRITE(p, v) frob_econtrol((p), 0xff, (v))</span>

<span class="cp">#undef DEBUG</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define DPRINTK  printk</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTK(stuff...)</span>
<span class="cp">#endif</span>


<span class="cp">#define NR_SUPERIOS 3</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">superio_struct</span> <span class="p">{</span>	<span class="cm">/* For Super-IO chips autodetection */</span>
	<span class="kt">int</span> <span class="n">io</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma</span><span class="p">;</span>
<span class="p">}</span> <span class="n">superios</span><span class="p">[</span><span class="n">NR_SUPERIOS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,},};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">user_specified</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_PARPORT_PC_SUPERIO) || \</span>
<span class="cp">       (defined(CONFIG_PARPORT_1284) &amp;&amp; defined(CONFIG_PARPORT_PC_FIFO))</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">verbose_probing</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pci_registered_parport</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pnp_registered_parport</span><span class="p">;</span>

<span class="cm">/* frob_control, but for ECR */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">frob_econtrol</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">m</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ectr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">ectr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;frob_econtrol(%02x,%02x): %02x -&gt; %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">m</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">ectr</span><span class="p">,</span> <span class="p">(</span><span class="n">ectr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">m</span><span class="p">)</span> <span class="o">^</span> <span class="n">v</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">((</span><span class="n">ectr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">m</span><span class="p">)</span> <span class="o">^</span> <span class="n">v</span><span class="p">,</span> <span class="n">ECONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">frob_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">frob_econtrol</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ECR_MODE_MASK</span><span class="p">,</span> <span class="n">mode</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PARPORT_PC_FIFO</span>
<span class="cm">/* Safely change the mode bits in the ECR</span>
<span class="cm">   Returns:</span>
<span class="cm">	    0    : Success</span>
<span class="cm">	   -EBUSY: Could not drain FIFO in some finite amount of time,</span>
<span class="cm">		   mode not changed!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">change_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">oecr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;parport change_mode ECP-ISA to mode 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ecr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;change_mode: but there&#39;s no ECR!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Bits &lt;7:5&gt; contain the mode. */</span>
	<span class="n">oecr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">oecr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">m</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctr</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* This mode resets the FIFO, so we may</span>
<span class="cm">		 * have to wait for it to drain first. */</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expire</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">cad</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">counter</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ECR_PPF</span>: <span class="cm">/* Parallel Port FIFO mode */</span>
		<span class="k">case</span> <span class="n">ECR_ECP</span>: <span class="cm">/* ECP Parallel Port mode */</span>
			<span class="cm">/* Busy wait for 200us */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">;</span> <span class="n">counter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* Poll slowly. */</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">expire</span><span class="p">))</span>
					<span class="cm">/* The FIFO is stuck. */</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
				<span class="n">schedule_timeout_interruptible</span><span class="p">(</span>
							<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">m</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We have to go through mode 001 */</span>
		<span class="n">oecr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">oecr</span> <span class="o">|=</span> <span class="n">ECR_PS2</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">oecr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set the mode. */</span>
	<span class="n">oecr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">oecr</span> <span class="o">|=</span> <span class="n">m</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">oecr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* FIFO support */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Clear TIMEOUT BIT in EPP MODE</span>
<span class="cm"> *</span>
<span class="cm"> * This is also used in SPP detection.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">clear_epp_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">parport_pc_read_status</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* To clear timeout some chips require double read */</span>
	<span class="n">parport_pc_read_status</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">parport_pc_read_status</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">r</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span> <span class="cm">/* Some reset by writing 1 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span> <span class="cm">/* Others by writing 0 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">parport_pc_read_status</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Access functions.</span>
<span class="cm"> *</span>
<span class="cm"> * Most of these aren&#39;t static because they may be used by the</span>
<span class="cm"> * parport_xxx_yyy macros.  extern __inline__ versions of several</span>
<span class="cm"> * of these are in parport_pc.h.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">parport_pc_init_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pardevice</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">parport_state</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pc</span><span class="p">.</span><span class="n">ctr</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_func</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">)</span>
		<span class="cm">/* Set ackIntEn */</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pc</span><span class="p">.</span><span class="n">ctr</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pc</span><span class="p">.</span><span class="n">ecr</span> <span class="o">=</span> <span class="mh">0x34</span><span class="p">;</span> <span class="cm">/* NetMos chip can cause problems 0x24;</span>
<span class="cm">			     * D.Gruszka VScom */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">parport_pc_save_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">parport_state</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pc</span><span class="p">.</span><span class="n">ctr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ecr</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pc</span><span class="p">.</span><span class="n">ecr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">parport_pc_restore_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">parport_state</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pc</span><span class="p">.</span><span class="n">ctr</span> <span class="o">&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctr_writable</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctr</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ecr</span><span class="p">)</span>
		<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pc</span><span class="p">.</span><span class="n">ecr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PARPORT_1284</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">parport_pc_epp_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">got</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PARPORT_W91284PIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">left</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

		<span class="cm">/* use knowledge about data lines..:</span>
<span class="cm">		 *  nFault is 0 if there is at least 1 byte in the Warp&#39;s FIFO</span>
<span class="cm">		 *  pError is 1 if there are 16 bytes in the Warp&#39;s FIFO</span>
<span class="cm">		 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">STATUS</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">got</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;=</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* can grab 16 bytes from warp fifo */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">))</span>
					<span class="n">insl</span><span class="p">(</span><span class="n">EPPDATA</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">insb</span><span class="p">(</span><span class="n">EPPDATA</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">buf</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">got</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">left</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* grab single byte from the warp fifo */</span>
				<span class="o">*</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">)</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EPPDATA</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
				<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
				<span class="n">got</span><span class="o">++</span><span class="p">;</span>
				<span class="n">left</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">STATUS</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* EPP timeout should never occur... */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
<span class="s">&quot;%s: EPP timeout occurred while talking to w91284pic (should not have done)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">got</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PARPORT_EPP_FAST</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="n">buf</span> <span class="o">|</span> <span class="n">length</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">))</span>
			<span class="n">insl</span><span class="p">(</span><span class="n">EPPDATA</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">insb</span><span class="p">(</span><span class="n">EPPDATA</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">STATUS</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">got</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">got</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">)</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EPPDATA</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">STATUS</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* EPP timeout */</span>
			<span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">got</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">parport_pc_epp_write_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
					<span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PARPORT_EPP_FAST</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(((</span><span class="kt">long</span><span class="p">)</span><span class="n">buf</span> <span class="o">|</span> <span class="n">length</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">))</span>
			<span class="n">outsl</span><span class="p">(</span><span class="n">EPPDATA</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">outsb</span><span class="p">(</span><span class="n">EPPDATA</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">STATUS</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">written</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">written</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">),</span> <span class="n">EPPDATA</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">STATUS</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">written</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">parport_pc_epp_read_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
					<span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">got</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PARPORT_EPP_FAST</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">insb</span><span class="p">(</span><span class="n">EPPADDR</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">STATUS</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">got</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">got</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">)</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">EPPADDR</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">STATUS</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">got</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">parport_pc_epp_write_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PARPORT_EPP_FAST</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">outsb</span><span class="p">(</span><span class="n">EPPADDR</span><span class="p">(</span><span class="n">port</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">STATUS</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">written</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">written</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">),</span> <span class="n">EPPADDR</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">STATUS</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">written</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">parport_pc_ecpepp_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
					  <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">got</span><span class="p">;</span>

	<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ECR_EPP</span><span class="p">);</span>
	<span class="n">parport_pc_data_reverse</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">parport_pc_write_control</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
	<span class="n">got</span> <span class="o">=</span> <span class="n">parport_pc_epp_read_data</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ECR_PS2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">got</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">parport_pc_ecpepp_write_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					   <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">written</span><span class="p">;</span>

	<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ECR_EPP</span><span class="p">);</span>
	<span class="n">parport_pc_write_control</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
	<span class="n">parport_pc_data_forward</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">written</span> <span class="o">=</span> <span class="n">parport_pc_epp_write_data</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ECR_PS2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">written</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">parport_pc_ecpepp_read_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
					  <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">got</span><span class="p">;</span>

	<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ECR_EPP</span><span class="p">);</span>
	<span class="n">parport_pc_data_reverse</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">parport_pc_write_control</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
	<span class="n">got</span> <span class="o">=</span> <span class="n">parport_pc_epp_read_addr</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ECR_PS2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">got</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">parport_pc_ecpepp_write_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					    <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">written</span><span class="p">;</span>

	<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ECR_EPP</span><span class="p">);</span>
	<span class="n">parport_pc_write_control</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
	<span class="n">parport_pc_data_forward</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">written</span> <span class="o">=</span> <span class="n">parport_pc_epp_write_addr</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ECR_PS2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">written</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* IEEE 1284 support */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PARPORT_PC_FIFO</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">parport_pc_fifo_write_block_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					       <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bufp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">left</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expire</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">cad</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">fifo</span> <span class="o">=</span> <span class="n">FIFO</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">poll_for</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* 80 usecs */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">fifo_depth</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_depth</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="p">;</span>

	<span class="cm">/* We don&#39;t want to be interrupted every character. */</span>
	<span class="n">parport_pc_disable_irq</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="cm">/* set nErrIntrEn and serviceIntr */</span>
	<span class="n">frob_econtrol</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">));</span>

	<span class="cm">/* Forward mode. */</span>
	<span class="n">parport_pc_data_forward</span><span class="p">(</span><span class="n">port</span><span class="p">);</span> <span class="cm">/* Must be in PS2 mode */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ecrval</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">need_resched</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">expire</span><span class="p">))</span>
			<span class="cm">/* Can&#39;t yield the port. */</span>
			<span class="n">schedule</span><span class="p">();</span>

		<span class="cm">/* Anyone else waiting for the port? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">waithead</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Somebody wants the port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ecrval</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* FIFO is full. Wait for interrupt. */</span>

			<span class="cm">/* Clear serviceIntr */</span>
			<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ecrval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">));</span>
<span class="nl">false_alarm:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">parport_wait_event</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">expire</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Timed out. */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;FIFO write timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ecrval</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ecrval</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">need_resched</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
				    <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">expire</span><span class="p">))</span>
					<span class="n">schedule</span><span class="p">();</span>

				<span class="k">goto</span> <span class="n">false_alarm</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Can&#39;t fail now. */</span>
		<span class="n">expire</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">cad</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>

<span class="nl">poll:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ecrval</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* FIFO is empty. Blast it full. */</span>
			<span class="k">const</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&lt;</span> <span class="n">fifo_depth</span> <span class="o">?</span> <span class="n">left</span> <span class="o">:</span> <span class="n">fifo_depth</span><span class="p">;</span>
			<span class="n">outsb</span><span class="p">(</span><span class="n">fifo</span><span class="p">,</span> <span class="n">bufp</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
			<span class="n">bufp</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">left</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>

			<span class="cm">/* Adjust the poll time. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">poll_for</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
				<span class="n">poll_for</span><span class="o">--</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">poll_for</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">ecrval</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">poll</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Half-full(call me an optimist) */</span>
		<span class="n">byte</span> <span class="o">=</span> <span class="o">*</span><span class="n">bufp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
		<span class="n">left</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dump_parport_state</span><span class="p">(</span><span class="s">&quot;leave fifo_write_block_pio&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">length</span> <span class="o">-</span> <span class="n">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef HAS_DMA</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">parport_pc_fifo_write_block_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					       <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dmaflag</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">left</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">maxlen</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span> <span class="cm">/* max 64k per DMA transfer */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dump_parport_state</span><span class="p">(</span><span class="s">&quot;enter fifo_write_block_dma&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">MAX_DMA_ADDRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If it would cross a 64k boundary, cap it at the end. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start</span> <span class="o">^</span> <span class="n">end</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xffffUL</span><span class="p">)</span>
			<span class="n">maxlen</span> <span class="o">=</span> <span class="mh">0x10000</span> <span class="o">-</span> <span class="p">(</span><span class="n">start</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

		<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_handle</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
						       <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* above 16 MB we use a bounce buffer as ISA-DMA</span>
<span class="cm">		   is not possible */</span>
		<span class="n">maxlen</span>   <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>          <span class="cm">/* sizeof(priv-&gt;dma_buf) */</span>
		<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_handle</span><span class="p">;</span>
		<span class="n">dma_handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="p">;</span>

	<span class="cm">/* We don&#39;t want to be interrupted every character. */</span>
	<span class="n">parport_pc_disable_irq</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="cm">/* set nErrIntrEn and serviceIntr */</span>
	<span class="n">frob_econtrol</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">));</span>

	<span class="cm">/* Forward mode. */</span>
	<span class="n">parport_pc_data_forward</span><span class="p">(</span><span class="n">port</span><span class="p">);</span> <span class="cm">/* Must be in PS2 mode */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expire</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">cad</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>

		<span class="kt">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">maxlen</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">maxlen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_handle</span><span class="p">)</span>   <span class="cm">/* bounce buffer ! */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

		<span class="n">dmaflag</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="n">disable_dma</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">DMA_MODE_WRITE</span><span class="p">);</span>
		<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">);</span>
		<span class="n">set_dma_count</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

		<span class="cm">/* Set DMA mode */</span>
		<span class="n">frob_econtrol</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">);</span>

		<span class="cm">/* Clear serviceIntr */</span>
		<span class="n">frob_econtrol</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">enable_dma</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">dmaflag</span><span class="p">);</span>

		<span class="cm">/* assume DMA will be successful */</span>
		<span class="n">left</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">buf</span>  <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_handle</span><span class="p">)</span>
			<span class="n">dma_addr</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

		<span class="cm">/* Wait for interrupt. */</span>
<span class="nl">false_alarm:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">parport_wait_event</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">expire</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Timed out. */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DMA write timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Is serviceIntr set? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">cond_resched</span><span class="p">();</span>

			<span class="k">goto</span> <span class="n">false_alarm</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dmaflag</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="n">disable_dma</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">dmaflag</span><span class="p">);</span>

		<span class="n">cond_resched</span><span class="p">();</span> <span class="cm">/* Can&#39;t yield the port. */</span>

		<span class="cm">/* Anyone else waiting for the port? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">waithead</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Somebody wants the port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* update for possible DMA residue ! */</span>
		<span class="n">buf</span>  <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">left</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_handle</span><span class="p">)</span>
			<span class="n">dma_addr</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Maybe got here through break, so adjust for DMA residue! */</span>
	<span class="n">dmaflag</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">left</span> <span class="o">+=</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">dmaflag</span><span class="p">);</span>

	<span class="cm">/* Turn off DMA mode */</span>
	<span class="n">frob_econtrol</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_handle</span><span class="p">)</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">dump_parport_state</span><span class="p">(</span><span class="s">&quot;leave fifo_write_block_dma&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">length</span> <span class="o">-</span> <span class="n">left</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">parport_pc_fifo_write_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					       <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef HAS_DMA</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">!=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">parport_pc_fifo_write_block_dma</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">parport_pc_fifo_write_block_pio</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Parallel Port FIFO mode (ECP chipsets) */</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">parport_pc_compat_write_block_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
						 <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span>
						 <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">written</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expire</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* Special case: a timeout of zero means we cannot call schedule().</span>
<span class="cm">	 * Also if O_NONBLOCK is set then use the default implementation. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">cad</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="n">PARPORT_INACTIVITY_O_NONBLOCK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">parport_ieee1284_write_compat</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
						      <span class="n">length</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Set up parallel port FIFO mode.*/</span>
	<span class="n">parport_pc_data_forward</span><span class="p">(</span><span class="n">port</span><span class="p">);</span> <span class="cm">/* Must be in PS2 mode */</span>
	<span class="n">parport_pc_frob_control</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">PARPORT_CONTROL_STROBE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">change_mode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ECR_PPF</span><span class="p">);</span> <span class="cm">/* Parallel port FIFO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Warning change_mode ECR_PPF failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">ieee1284</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">IEEE1284_PH_FWD_DATA</span><span class="p">;</span>

	<span class="cm">/* Write the data to the FIFO. */</span>
	<span class="n">written</span> <span class="o">=</span> <span class="n">parport_pc_fifo_write_block</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="cm">/* Finish up. */</span>
	<span class="cm">/* For some hardware we don&#39;t want to touch the mode until</span>
<span class="cm">	 * the FIFO is empty, so allow 4 seconds for each position</span>
<span class="cm">	 * in the fifo.</span>
<span class="cm">	 */</span>
	<span class="n">expire</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_depth</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Wait for the FIFO to empty */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">change_mode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ECR_PS2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">expire</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: FIFO is stuck</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="cm">/* Prevent further data transfer. */</span>
		<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ECR_TST</span><span class="p">);</span>

		<span class="cm">/* Adjust for the contents of the FIFO. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">written</span> <span class="o">-=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_depth</span><span class="p">;</span> <span class="p">;</span> <span class="n">written</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Full up. */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">FIFO</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* Reset the FIFO and return to PS2 mode. */</span>
		<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ECR_PS2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">parport_wait_peripheral</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
				     <span class="n">PARPORT_STATUS_BUSY</span><span class="p">,</span>
				     <span class="n">PARPORT_STATUS_BUSY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			<span class="s">&quot;%s: BUSY timeout (%d) in compat_write_block_pio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">ieee1284</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">IEEE1284_PH_FWD_IDLE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">written</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ECP */</span>
<span class="cp">#ifdef CONFIG_PARPORT_1284</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">parport_pc_ecp_write_block_pio</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					      <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span>
					      <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">written</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expire</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* Special case: a timeout of zero means we cannot call schedule().</span>
<span class="cm">	 * Also if O_NONBLOCK is set then use the default implementation. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">cad</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="n">PARPORT_INACTIVITY_O_NONBLOCK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">parport_ieee1284_ecp_write_data</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
							<span class="n">length</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Switch to forward mode if necessary. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">ieee1284</span><span class="p">.</span><span class="n">phase</span> <span class="o">!=</span> <span class="n">IEEE1284_PH_FWD_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Event 47: Set nInit high. */</span>
		<span class="n">parport_frob_control</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
				      <span class="n">PARPORT_CONTROL_INIT</span>
				      <span class="o">|</span> <span class="n">PARPORT_CONTROL_AUTOFD</span><span class="p">,</span>
				      <span class="n">PARPORT_CONTROL_INIT</span>
				      <span class="o">|</span> <span class="n">PARPORT_CONTROL_AUTOFD</span><span class="p">);</span>

		<span class="cm">/* Event 49: PError goes high. */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">parport_wait_peripheral</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
					     <span class="n">PARPORT_STATUS_PAPEROUT</span><span class="p">,</span>
					     <span class="n">PARPORT_STATUS_PAPEROUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PError timeout (%d) &quot;</span>
				<span class="s">&quot;in ecp_write_block_pio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Set up ECP parallel port mode.*/</span>
	<span class="n">parport_pc_data_forward</span><span class="p">(</span><span class="n">port</span><span class="p">);</span> <span class="cm">/* Must be in PS2 mode */</span>
	<span class="n">parport_pc_frob_control</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
				 <span class="n">PARPORT_CONTROL_STROBE</span> <span class="o">|</span>
				 <span class="n">PARPORT_CONTROL_AUTOFD</span><span class="p">,</span>
				 <span class="mi">0</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">change_mode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ECR_ECP</span><span class="p">);</span> <span class="cm">/* ECP FIFO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Warning change_mode ECR_ECP failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">ieee1284</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">IEEE1284_PH_FWD_DATA</span><span class="p">;</span>

	<span class="cm">/* Write the data to the FIFO. */</span>
	<span class="n">written</span> <span class="o">=</span> <span class="n">parport_pc_fifo_write_block</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="cm">/* Finish up. */</span>
	<span class="cm">/* For some hardware we don&#39;t want to touch the mode until</span>
<span class="cm">	 * the FIFO is empty, so allow 4 seconds for each position</span>
<span class="cm">	 * in the fifo.</span>
<span class="cm">	 */</span>
	<span class="n">expire</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_depth</span> <span class="o">*</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* Wait for the FIFO to empty */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">change_mode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ECR_PS2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">expire</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: FIFO is stuck</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="cm">/* Prevent further data transfer. */</span>
		<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ECR_TST</span><span class="p">);</span>

		<span class="cm">/* Adjust for the contents of the FIFO. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">written</span> <span class="o">-=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_depth</span><span class="p">;</span> <span class="p">;</span> <span class="n">written</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Full up. */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">FIFO</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* Reset the FIFO and return to PS2 mode. */</span>
		<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ECR_PS2</span><span class="p">);</span>

		<span class="cm">/* Host transfer recovery. */</span>
		<span class="n">parport_pc_data_reverse</span><span class="p">(</span><span class="n">port</span><span class="p">);</span> <span class="cm">/* Must be in PS2 mode */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">parport_frob_control</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">PARPORT_CONTROL_INIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">parport_wait_peripheral</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">PARPORT_STATUS_PAPEROUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PE,1 timeout (%d) &quot;</span>
				<span class="s">&quot;in ecp_write_block_pio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

		<span class="n">parport_frob_control</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
				      <span class="n">PARPORT_CONTROL_INIT</span><span class="p">,</span>
				      <span class="n">PARPORT_CONTROL_INIT</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">parport_wait_peripheral</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
					     <span class="n">PARPORT_STATUS_PAPEROUT</span><span class="p">,</span>
					     <span class="n">PARPORT_STATUS_PAPEROUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PE,2 timeout (%d) &quot;</span>
				<span class="s">&quot;in ecp_write_block_pio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">parport_wait_peripheral</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
				     <span class="n">PARPORT_STATUS_BUSY</span><span class="p">,</span>
				     <span class="n">PARPORT_STATUS_BUSY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			<span class="s">&quot;%s: BUSY timeout (%d) in ecp_write_block_pio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">ieee1284</span><span class="p">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">IEEE1284_PH_FWD_IDLE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">written</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* IEEE 1284 support */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* Allowed to use FIFO/DMA */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> *	******************************************</span>
<span class="cm"> *	INITIALISATION AND MODULE STUFF BELOW HERE</span>
<span class="cm"> *	******************************************</span>
<span class="cm"> */</span>

<span class="cm">/* GCC is not inlining extern inline function later overwriten to non-inline,</span>
<span class="cm">   so we use outlined_ variants here.  */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">parport_operations</span> <span class="n">parport_pc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">write_data</span>	<span class="o">=</span> <span class="n">parport_pc_write_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_data</span>	<span class="o">=</span> <span class="n">parport_pc_read_data</span><span class="p">,</span>

	<span class="p">.</span><span class="n">write_control</span>	<span class="o">=</span> <span class="n">parport_pc_write_control</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_control</span>	<span class="o">=</span> <span class="n">parport_pc_read_control</span><span class="p">,</span>
	<span class="p">.</span><span class="n">frob_control</span>	<span class="o">=</span> <span class="n">parport_pc_frob_control</span><span class="p">,</span>

	<span class="p">.</span><span class="n">read_status</span>	<span class="o">=</span> <span class="n">parport_pc_read_status</span><span class="p">,</span>

	<span class="p">.</span><span class="n">enable_irq</span>	<span class="o">=</span> <span class="n">parport_pc_enable_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_irq</span>	<span class="o">=</span> <span class="n">parport_pc_disable_irq</span><span class="p">,</span>

	<span class="p">.</span><span class="n">data_forward</span>	<span class="o">=</span> <span class="n">parport_pc_data_forward</span><span class="p">,</span>
	<span class="p">.</span><span class="n">data_reverse</span>	<span class="o">=</span> <span class="n">parport_pc_data_reverse</span><span class="p">,</span>

	<span class="p">.</span><span class="n">init_state</span>	<span class="o">=</span> <span class="n">parport_pc_init_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">save_state</span>	<span class="o">=</span> <span class="n">parport_pc_save_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore_state</span>	<span class="o">=</span> <span class="n">parport_pc_restore_state</span><span class="p">,</span>

	<span class="p">.</span><span class="n">epp_write_data</span>	<span class="o">=</span> <span class="n">parport_ieee1284_epp_write_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">epp_read_data</span>	<span class="o">=</span> <span class="n">parport_ieee1284_epp_read_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">epp_write_addr</span>	<span class="o">=</span> <span class="n">parport_ieee1284_epp_write_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">epp_read_addr</span>	<span class="o">=</span> <span class="n">parport_ieee1284_epp_read_addr</span><span class="p">,</span>

	<span class="p">.</span><span class="n">ecp_write_data</span>	<span class="o">=</span> <span class="n">parport_ieee1284_ecp_write_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ecp_read_data</span>	<span class="o">=</span> <span class="n">parport_ieee1284_ecp_read_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ecp_write_addr</span>	<span class="o">=</span> <span class="n">parport_ieee1284_ecp_write_addr</span><span class="p">,</span>

	<span class="p">.</span><span class="n">compat_write_data</span>	<span class="o">=</span> <span class="n">parport_ieee1284_write_compat</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nibble_read_data</span>	<span class="o">=</span> <span class="n">parport_ieee1284_read_nibble</span><span class="p">,</span>
	<span class="p">.</span><span class="n">byte_read_data</span>		<span class="o">=</span> <span class="n">parport_ieee1284_read_byte</span><span class="p">,</span>

	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PARPORT_PC_SUPERIO</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">superio_struct</span> <span class="o">*</span><span class="nf">find_free_superio</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_SUPERIOS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">superios</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">io</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">superios</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Super-IO chipset detection, Winbond, SMSC */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">show_parconfig_smsc37c669</span><span class="p">(</span><span class="kt">int</span> <span class="n">io</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cr1</span><span class="p">,</span> <span class="n">cr4</span><span class="p">,</span> <span class="n">cra</span><span class="p">,</span> <span class="n">cr23</span><span class="p">,</span> <span class="n">cr26</span><span class="p">,</span> <span class="n">cr27</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">superio_struct</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;SPP and Bidirectional (PS/2)&quot;</span><span class="p">,</span>
		<span class="s">&quot;EPP and SPP&quot;</span><span class="p">,</span>
		<span class="s">&quot;ECP&quot;</span><span class="p">,</span>
		<span class="s">&quot;ECP and EPP&quot;</span> <span class="p">};</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">cr1</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">cr4</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x0a</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">cra</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x23</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">cr23</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x26</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">cr26</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x27</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">cr27</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xaa</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">verbose_probing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;SMSC 37c669 LPT Config: cr_1=0x%02x, 4=0x%02x, &quot;</span>
			<span class="s">&quot;A=0x%2x, 23=0x%02x, 26=0x%02x, 27=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cr1</span><span class="p">,</span> <span class="n">cr4</span><span class="p">,</span> <span class="n">cra</span><span class="p">,</span> <span class="n">cr23</span><span class="p">,</span> <span class="n">cr26</span><span class="p">,</span> <span class="n">cr27</span><span class="p">);</span>

		<span class="cm">/* The documentation calls DMA and IRQ-Lines by letters, so</span>
<span class="cm">		   the board maker can/will wire them</span>
<span class="cm">		   appropriately/randomly...  G=reserved H=IDE-irq, */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	<span class="s">&quot;SMSC LPT Config: io=0x%04x, irq=%c, dma=%c, fifo threshold=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cr23</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
				<span class="p">(</span><span class="n">cr27</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;A&#39;</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">cr27</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">cr26</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;A&#39;</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">cr26</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span>
				<span class="n">cra</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;SMSC LPT Config: enabled=%s power=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">cr23</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">&gt;=</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">cr1</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;SMSC LPT Config: Port mode=%s, EPP version =%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">cr1</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Standard mode only (SPP)&quot;</span>
					      <span class="o">:</span> <span class="n">modes</span><span class="p">[</span><span class="n">cr4</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">],</span>
				<span class="p">(</span><span class="n">cr4</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;1.7&quot;</span> <span class="o">:</span> <span class="s">&quot;1.9&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Heuristics !  BIOS setup for this mainboard device limits</span>
<span class="cm">	   the choices to standard settings, i.e. io-address and IRQ</span>
<span class="cm">	   are related, however DMA can be 1 or 3, assume DMA_A=DMA1,</span>
<span class="cm">	   DMA_C=DMA3 (this is true e.g. for TYAN 1564D Tomcat IV) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cr23</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">&gt;=</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* if active */</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">find_free_superio</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Super-IO: too many chips!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">d</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cr23</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x3bc</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">io</span> <span class="o">=</span> <span class="mh">0x3bc</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x378</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">io</span> <span class="o">=</span> <span class="mh">0x378</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x278</span>:
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">io</span> <span class="o">=</span> <span class="mh">0x278</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr26</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">show_parconfig_winbond</span><span class="p">(</span><span class="kt">int</span> <span class="n">io</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cr30</span><span class="p">,</span> <span class="n">cr60</span><span class="p">,</span> <span class="n">cr61</span><span class="p">,</span> <span class="n">cr70</span><span class="p">,</span> <span class="n">cr74</span><span class="p">,</span> <span class="n">crf0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">superio_struct</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Standard (SPP) and Bidirectional(PS/2)&quot;</span><span class="p">,</span> <span class="cm">/* 0 */</span>
		<span class="s">&quot;EPP-1.9 and SPP&quot;</span><span class="p">,</span>
		<span class="s">&quot;ECP&quot;</span><span class="p">,</span>
		<span class="s">&quot;ECP and EPP-1.9&quot;</span><span class="p">,</span>
		<span class="s">&quot;Standard (SPP)&quot;</span><span class="p">,</span>
		<span class="s">&quot;EPP-1.7 and SPP&quot;</span><span class="p">,</span>		<span class="cm">/* 5 */</span>
		<span class="s">&quot;undefined!&quot;</span><span class="p">,</span>
		<span class="s">&quot;ECP and EPP-1.7&quot;</span> <span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">irqtypes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;pulsed low, high-Z&quot;</span><span class="p">,</span>
		<span class="s">&quot;follows nACK&quot;</span> <span class="p">};</span>

	<span class="cm">/* The registers are called compatible-PnP because the</span>
<span class="cm">	   register layout is modelled after ISA-PnP, the access</span>
<span class="cm">	   method is just another ... */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>   <span class="cm">/* Register 7: Select Logical Device */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* LD1 is Parallel Port */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">cr30</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">cr60</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x61</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">cr61</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">cr70</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x74</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">cr74</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xf0</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">crf0</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xaa</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">verbose_probing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
    <span class="s">&quot;Winbond LPT Config: cr_30=%02x 60,61=%02x%02x 70=%02x 74=%02x, f0=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">cr30</span><span class="p">,</span> <span class="n">cr60</span><span class="p">,</span> <span class="n">cr61</span><span class="p">,</span> <span class="n">cr70</span><span class="p">,</span> <span class="n">cr74</span><span class="p">,</span> <span class="n">crf0</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Winbond LPT Config: active=%s, io=0x%02x%02x irq=%d, &quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">cr30</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">,</span> <span class="n">cr60</span><span class="p">,</span> <span class="n">cr61</span><span class="p">,</span> <span class="n">cr70</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cr74</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dma=none</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dma=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cr74</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		    <span class="s">&quot;Winbond LPT Config: irqtype=%s, ECP fifo threshold=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">irqtypes</span><span class="p">[</span><span class="n">crf0</span><span class="o">&gt;&gt;</span><span class="mi">7</span><span class="p">],</span> <span class="p">(</span><span class="n">crf0</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x0f</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Winbond LPT Config: Port mode=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">modes</span><span class="p">[</span><span class="n">crf0</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cr30</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* the settings can be interrogated later ... */</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">find_free_superio</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Super-IO: too many chips!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">io</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr60</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">cr61</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">cr70</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="p">(((</span><span class="n">cr74</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span>
					   <span class="n">PARPORT_DMA_NONE</span> <span class="o">:</span> <span class="p">(</span><span class="n">cr74</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">decode_winbond</span><span class="p">(</span><span class="kt">int</span> <span class="n">efer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devid</span><span class="p">,</span>
							<span class="kt">int</span> <span class="n">devrev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oldid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">progif</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devid</span> <span class="o">==</span> <span class="n">devrev</span><span class="p">)</span>
		<span class="cm">/* simple heuristics, we happened to read some</span>
<span class="cm">		   non-winbond register */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">devid</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">devrev</span><span class="p">;</span>

	<span class="cm">/* Values are from public data sheets pdf files, I can just</span>
<span class="cm">	   confirm 83977TF is correct :-) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0x9771</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;83977F/AF&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0x9773</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;83977TF / SMSC 97w33x/97w34x&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0x9774</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;83977ATF&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x5270</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;83977CTF / SMSC 97w36x&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x52f0</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;83977EF / SMSC 97w35x&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x5210</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;83627&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x6010</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;83697HF&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">oldid</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0a</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;83877F&quot;</span><span class="p">;</span>
		<span class="n">progif</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">oldid</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;83877AF&quot;</span><span class="p">;</span>
		<span class="n">progif</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">oldid</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;83877TF&quot;</span><span class="p">;</span>
		<span class="n">progif</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">oldid</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0d</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;83877ATF&quot;</span><span class="p">;</span>
		<span class="n">progif</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">progif</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">verbose_probing</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Winbond chip at EFER=0x%x key=0x%02x &quot;</span>
		       <span class="s">&quot;devid=%02x devrev=%02x oldid=%02x type=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">efer</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">devrev</span><span class="p">,</span> <span class="n">oldid</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">progif</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">show_parconfig_winbond</span><span class="p">(</span><span class="n">efer</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">decode_smsc</span><span class="p">(</span><span class="kt">int</span> <span class="n">efer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devrev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="kt">int</span> <span class="n">io</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devid</span> <span class="o">==</span> <span class="n">devrev</span><span class="p">)</span>
		<span class="cm">/* simple heuristics, we happened to read some</span>
<span class="cm">		   non-smsc register */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">devid</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">devrev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0x0302</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;37c669&quot;</span><span class="p">;</span>
		<span class="n">func</span> <span class="o">=</span> <span class="n">show_parconfig_smsc37c669</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0x6582</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;37c665IR&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span>	<span class="p">(</span><span class="n">devid</span> <span class="o">==</span> <span class="mh">0x65</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;37c665GT&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span>	<span class="p">(</span><span class="n">devid</span> <span class="o">==</span> <span class="mh">0x66</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;37c666GT&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">verbose_probing</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;SMSC chip at EFER=0x%x &quot;</span>
		       <span class="s">&quot;key=0x%02x devid=%02x devrev=%02x type=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">efer</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">devrev</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="p">)</span>
		<span class="n">func</span><span class="p">(</span><span class="n">efer</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">winbond_check</span><span class="p">(</span><span class="kt">int</span> <span class="n">io</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">origval</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">devrev</span><span class="p">,</span> <span class="n">oldid</span><span class="p">,</span> <span class="n">x_devid</span><span class="p">,</span> <span class="n">x_devrev</span><span class="p">,</span> <span class="n">x_oldid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">origval</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span><span class="p">);</span> <span class="cm">/* Save original value */</span>

	<span class="cm">/* First probe without key */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">x_devid</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x21</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">x_devrev</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x09</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">x_oldid</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>     <span class="cm">/* Write Magic Sequence to EFER, extended</span>
<span class="cm">			      function enable register */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>    <span class="cm">/* Write EFIR, extended function index register */</span>
	<span class="n">devid</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>  <span class="cm">/* Read EFDR, extended function data register */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x21</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">devrev</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x09</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">oldid</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xaa</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>    <span class="cm">/* Magic Seal */</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">origval</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span> <span class="cm">/* in case we poked some entirely different hardware */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">x_devid</span> <span class="o">==</span> <span class="n">devid</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">x_devrev</span> <span class="o">==</span> <span class="n">devrev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">x_oldid</span> <span class="o">==</span> <span class="n">oldid</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* protection against false positives */</span>

	<span class="n">decode_winbond</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">devrev</span><span class="p">,</span> <span class="n">oldid</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">winbond_check2</span><span class="p">(</span><span class="kt">int</span> <span class="n">io</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">origval</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">devid</span><span class="p">,</span> <span class="n">devrev</span><span class="p">,</span> <span class="n">oldid</span><span class="p">,</span> <span class="n">x_devid</span><span class="p">,</span> <span class="n">x_devrev</span><span class="p">,</span> <span class="n">x_oldid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">origval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span><span class="p">);</span> <span class="cm">/* Save original values */</span>
	<span class="n">origval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">origval</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* First probe without the key */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">x_devid</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x21</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">x_devrev</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x09</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">x_oldid</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>     <span class="cm">/* Write Magic Byte to EFER, extended</span>
<span class="cm">			      function enable register */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>  <span class="cm">/* Write EFIR, extended function index register */</span>
	<span class="n">devid</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>  <span class="cm">/* Read EFDR, extended function data register */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x21</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">devrev</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x09</span><span class="p">,</span> <span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">oldid</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xaa</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>    <span class="cm">/* Magic Seal */</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">origval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">io</span><span class="p">);</span> <span class="cm">/* in case we poked some entirely different hardware */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">origval</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">origval</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">io</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x_devid</span> <span class="o">==</span> <span class="n">devid</span> <span class="o">&amp;&amp;</span> <span class="n">x_devrev</span> <span class="o">==</span> <span class="n">devrev</span> <span class="o">&amp;&amp;</span> <span class="n">x_oldid</span> <span class="o">==</span> <span class="n">oldid</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* protection against false positives */</span>

	<span class="n">decode_winbond</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">devrev</span><span class="p">,</span> <span class="n">oldid</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">smsc_check</span><span class="p">(</span><span class="kt">int</span> <span class="n">io</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">origval</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span> <span class="n">oldid</span><span class="p">,</span> <span class="n">oldrev</span><span class="p">,</span> <span class="n">x_id</span><span class="p">,</span> <span class="n">x_rev</span><span class="p">,</span> <span class="n">x_oldid</span><span class="p">,</span> <span class="n">x_oldrev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">origval</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span><span class="p">);</span> <span class="cm">/* Save original value */</span>

	<span class="cm">/* First probe without the key */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x0d</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">x_oldid</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x0e</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">x_oldrev</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">x_id</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x21</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">x_rev</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>     <span class="cm">/* Write Magic Sequence to EFER, extended</span>
<span class="cm">			      function enable register */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x0d</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>    <span class="cm">/* Write EFIR, extended function index register */</span>
	<span class="n">oldid</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>  <span class="cm">/* Read EFDR, extended function data register */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x0e</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">oldrev</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x21</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>
	<span class="n">rev</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xaa</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span>    <span class="cm">/* Magic Seal */</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">origval</span><span class="p">,</span> <span class="n">io</span><span class="p">);</span> <span class="cm">/* in case we poked some entirely different hardware */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x_id</span> <span class="o">==</span> <span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="n">x_oldrev</span> <span class="o">==</span> <span class="n">oldrev</span> <span class="o">&amp;&amp;</span>
	    <span class="n">x_oldid</span> <span class="o">==</span> <span class="n">oldid</span> <span class="o">&amp;&amp;</span> <span class="n">x_rev</span> <span class="o">==</span> <span class="n">rev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* protection against false positives */</span>

	<span class="n">decode_smsc</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">oldid</span><span class="p">,</span> <span class="n">oldrev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">detect_and_report_winbond</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">verbose_probing</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Winbond Super-IO detection, now testing ports 3F0,370,250,4E,2E ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">winbond_check</span><span class="p">(</span><span class="mh">0x3f0</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">);</span>
	<span class="n">winbond_check</span><span class="p">(</span><span class="mh">0x370</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">);</span>
	<span class="n">winbond_check</span><span class="p">(</span><span class="mh">0x2e</span> <span class="p">,</span> <span class="mh">0x87</span><span class="p">);</span>
	<span class="n">winbond_check</span><span class="p">(</span><span class="mh">0x4e</span> <span class="p">,</span> <span class="mh">0x87</span><span class="p">);</span>
	<span class="n">winbond_check</span><span class="p">(</span><span class="mh">0x3f0</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>
	<span class="n">winbond_check2</span><span class="p">(</span><span class="mh">0x250</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
	<span class="n">winbond_check2</span><span class="p">(</span><span class="mh">0x250</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">detect_and_report_smsc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">verbose_probing</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;SMSC Super-IO detection, now testing Ports 2F0, 370 ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">smsc_check</span><span class="p">(</span><span class="mh">0x3f0</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
	<span class="n">smsc_check</span><span class="p">(</span><span class="mh">0x370</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
	<span class="n">smsc_check</span><span class="p">(</span><span class="mh">0x3f0</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
	<span class="n">smsc_check</span><span class="p">(</span><span class="mh">0x370</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">detect_and_report_it87</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">origval</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">verbose_probing</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;IT8705 Super-IO detection, now testing port 2E ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_muxed_region</span><span class="p">(</span><span class="mh">0x2e</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">origval</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x2e</span><span class="p">);</span>		<span class="cm">/* Save original value */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x2f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">|=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x2f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="mh">0x8712</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">==</span> <span class="mh">0x8705</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">==</span> <span class="mh">0x8715</span> <span class="o">||</span>
	    <span class="n">dev</span> <span class="o">==</span> <span class="mh">0x8716</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">==</span> <span class="mh">0x8718</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">==</span> <span class="mh">0x8726</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;IT%04X SuperIO detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x2E</span><span class="p">);</span>	<span class="cm">/* Parallel Port */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x2E</span><span class="p">);</span>	<span class="cm">/* BOOT 0x80 off */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x2f</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0x2E</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">r</span> <span class="o">|</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x2E</span><span class="p">);</span>	<span class="cm">/* Lock */</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">origval</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">);</span>	<span class="cm">/* Oops, sorry to disturb */</span>
	<span class="p">}</span>
	<span class="n">release_region</span><span class="p">(</span><span class="mh">0x2e</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PARPORT_PC_SUPERIO */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">superio_struct</span> <span class="o">*</span><span class="nf">find_superio</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_SUPERIOS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">superios</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">io</span> <span class="o">!=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">superios</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_superio_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">superio_struct</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">find_superio</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_superio_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">superio_struct</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">find_superio</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* --- Mode detection ------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * Checks for port existence, all ports support SPP MODE</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *         0           :  No parallel port at this address</span>
<span class="cm"> *  PARPORT_MODE_PCSPP :  SPP port detected</span>
<span class="cm"> *                        (if the user specified an ioport himself,</span>
<span class="cm"> *                         this shall always be the case!)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parport_SPP_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * first clear an eventually pending EPP timeout</span>
<span class="cm">	 * I (sailer@ife.ee.ethz.ch) have an SMSC chipset</span>
<span class="cm">	 * that does not even respond to SPP cycles if an EPP</span>
<span class="cm">	 * timeout is pending</span>
<span class="cm">	 */</span>
	<span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>

	<span class="cm">/* Do a simple read-write test to make sure the port exists. */</span>
	<span class="n">w</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>

	<span class="cm">/* Is there a control register that we can read from?  Some</span>
<span class="cm">	 * ports don&#39;t allow reads, so read_control just returns a</span>
<span class="cm">	 * software copy. Some ports _do_ allow reads, so bypass the</span>
<span class="cm">	 * software copy here.  In addition, some bits aren&#39;t</span>
<span class="cm">	 * writable. */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">CONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="n">w</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w</span> <span class="o">=</span> <span class="mh">0xe</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">CONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xc</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="n">w</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">PARPORT_MODE_PCSPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user_specified</span><span class="p">)</span>
		<span class="cm">/* That didn&#39;t work, but the user thinks there&#39;s a</span>
<span class="cm">		 * port here. */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;parport 0x%lx (WARNING): CTR: &quot;</span>
			<span class="s">&quot;wrote 0x%02x, read 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="cm">/* Try the data register.  The data lines aren&#39;t tri-stated at</span>
<span class="cm">	 * this stage, so we expect back what we wrote. */</span>
	<span class="n">w</span> <span class="o">=</span> <span class="mh">0xaa</span><span class="p">;</span>
	<span class="n">parport_pc_write_data</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">parport_pc_read_data</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">w</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
		<span class="n">parport_pc_write_data</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">parport_pc_read_data</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">w</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">PARPORT_MODE_PCSPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user_specified</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Didn&#39;t work, but the user is convinced this is the</span>
<span class="cm">		 * place. */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;parport 0x%lx (WARNING): DATA: &quot;</span>
			<span class="s">&quot;wrote 0x%02x, read 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;parport 0x%lx: You gave this address, &quot;</span>
			<span class="s">&quot;but there is probably no parallel port there!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* It&#39;s possible that we can&#39;t read the control register or</span>
<span class="cm">	 * the data register.  In that case just believe the user. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_specified</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PARPORT_MODE_PCSPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Check for ECR</span>
<span class="cm"> *</span>
<span class="cm"> * Old style XT ports alias io ports every 0x400, hence accessing ECR</span>
<span class="cm"> * on these cards actually accesses the CTR.</span>
<span class="cm"> *</span>
<span class="cm"> * Modern cards don&#39;t do this but reading from ECR will return 0xff</span>
<span class="cm"> * regardless of what is written here if the card does NOT support</span>
<span class="cm"> * ECP.</span>
<span class="cm"> *</span>
<span class="cm"> * We first check to see if ECR is the same as CTR.  If not, the low</span>
<span class="cm"> * two bits of ECR aren&#39;t writable, so we check by writing ECR and</span>
<span class="cm"> * reading it back to see if it&#39;s what we expect.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parport_ECR_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pb</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">r</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">r</span> <span class="o">^</span> <span class="mh">0x2</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span> <span class="cm">/* Toggle bit 1 */</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">CONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">no_reg</span><span class="p">;</span> <span class="cm">/* Sure that no ECR register exists */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_reg</span><span class="p">;</span>

	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x35</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_reg</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ecr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xc</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>

	<span class="cm">/* Go to mode 000 */</span>
	<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">ECR_SPP</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

 <span class="nl">no_reg:</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xc</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PARPORT_1284</span>
<span class="cm">/* Detect PS/2 support.</span>
<span class="cm"> *</span>
<span class="cm"> * Bit 5 (0x20) sets the PS/2 data direction; setting this high</span>
<span class="cm"> * allows us to read data from the data lines.  In theory we would get back</span>
<span class="cm"> * 0xff but any peripheral attached to the port may drag some or all of the</span>
<span class="cm"> * lines down to zero.  So if we get back anything that isn&#39;t the contents</span>
<span class="cm"> * of the data register we deem PS/2 support to be present.</span>
<span class="cm"> *</span>
<span class="cm"> * Some SPP ports have &quot;half PS/2&quot; ability - you can&#39;t turn off the line</span>
<span class="cm"> * drivers, but an external peripheral with sufficiently beefy drivers of</span>
<span class="cm"> * its own can overpower them and assert its own levels onto the bus, from</span>
<span class="cm"> * where they can then be read back as normal.  Ports with this property</span>
<span class="cm"> * and the right type of device attached are likely to fail the SPP test,</span>
<span class="cm"> * (as they will appear to have stuck bits) and so the fact that they might</span>
<span class="cm"> * be misdetected here is rather academic.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parport_PS2_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>

	<span class="cm">/* try to tri-state the buffer */</span>
	<span class="n">parport_pc_data_reverse</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>

	<span class="n">parport_pc_write_data</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parport_pc_read_data</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55</span><span class="p">)</span>
		<span class="n">ok</span><span class="o">++</span><span class="p">;</span>

	<span class="n">parport_pc_write_data</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parport_pc_read_data</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xaa</span><span class="p">)</span>
		<span class="n">ok</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* cancel input mode */</span>
	<span class="n">parport_pc_data_forward</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pb</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">|=</span> <span class="n">PARPORT_MODE_TRISTATE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pb</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctr_writable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PARPORT_PC_FIFO</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parport_ECP_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">config</span><span class="p">,</span> <span class="n">configb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pword</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pb</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="cm">/* Translate ECP intrLine to ISA irq value */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">intrline</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span> <span class="p">};</span>

	<span class="cm">/* If there is no ECR, we have no hope of supporting ECP. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ecr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Find out FIFO depth */</span>
	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">ECR_SPP</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span> <span class="cm">/* Reset FIFO */</span>
	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">ECR_TST</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span> <span class="cm">/* TEST FIFO */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1024</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xaa</span><span class="p">,</span> <span class="n">FIFO</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Using LGS chipset it uses ECR register, but</span>
<span class="cm">	 * it doesn&#39;t support ECP or FIFO MODE</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">ECR_SPP</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_depth</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">verbose_probing</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;0x%lx: FIFO is %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Find out writeIntrThreshold */</span>
	<span class="n">frob_econtrol</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">frob_econtrol</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">FIFO</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">verbose_probing</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;0x%lx: writeIntrThreshold is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* Number of bytes we know we can write if we get an</span>
<span class="cm">		   interrupt. */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">writeIntrThreshold</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Find out readIntrThreshold */</span>
	<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">ECR_PS2</span><span class="p">);</span> <span class="cm">/* Reset FIFO and enable PS2 */</span>
	<span class="n">parport_pc_data_reverse</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span> <span class="cm">/* Must be in PS2 mode */</span>
	<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">ECR_TST</span><span class="p">);</span> <span class="cm">/* Test FIFO */</span>
	<span class="n">frob_econtrol</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">frob_econtrol</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_depth</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xaa</span><span class="p">,</span> <span class="n">FIFO</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">verbose_probing</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;0x%lx: readIntrThreshold is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* Number of bytes we can read if we get an interrupt. */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">readIntrThreshold</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">ECR_SPP</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span> <span class="cm">/* Reset FIFO */</span>
	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">);</span> <span class="cm">/* Configuration mode */</span>
	<span class="n">config</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">CONFIGA</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>
	<span class="n">pword</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pword</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">pword</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;0x%lx: Unsupported pword size!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">pword</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;0x%lx: Unsupported pword size!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;0x%lx: Unknown implementation ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="cm">/* Assume 1 */</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">pword</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pword</span> <span class="o">=</span> <span class="n">pword</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">verbose_probing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;0x%lx: PWord is %d bits</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">pword</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;0x%lx: Interrupts are ISA-%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
			<span class="n">config</span> <span class="o">&amp;</span> <span class="mh">0x80</span> <span class="o">?</span> <span class="s">&quot;Level&quot;</span> <span class="o">:</span> <span class="s">&quot;Pulses&quot;</span><span class="p">);</span>

		<span class="n">configb</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">CONFIGB</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;0x%lx: ECP port cfgA=0x%02x cfgB=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">configb</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;0x%lx: ECP settings irq=&quot;</span><span class="p">,</span> <span class="n">pb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">configb</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">intrline</span><span class="p">[(</span><span class="n">configb</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;&lt;none or set by other means&gt;&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; dma=&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">configb</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;&lt;none or set by other means&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">configb</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Go back to mode 000 */</span>
	<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">ECR_SPP</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parport_ECPPS2_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pb</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">oecr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ecr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">oecr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>
	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">ECR_PS2</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">parport_PS2_supported</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>
	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">oecr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* EPP mode detection  */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parport_EPP_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pb</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Theory:</span>
<span class="cm">	 *	Bit 0 of STR is the EPP timeout bit, this bit is 0</span>
<span class="cm">	 *	when EPP is possible and is set high when an EPP timeout</span>
<span class="cm">	 *	occurs (EPP uses the HALT line to stop the CPU while it does</span>
<span class="cm">	 *	the byte transfer, an EPP timeout occurs if the attached</span>
<span class="cm">	 *	device fails to respond after 10 micro seconds).</span>
<span class="cm">	 *</span>
<span class="cm">	 *	This bit is cleared by either reading it (National Semi)</span>
<span class="cm">	 *	or writing a 1 to the bit (SMC, UMC, WinBond), others ???</span>
<span class="cm">	 *	This bit is always high in non EPP modes.</span>
<span class="cm">	 */</span>

	<span class="cm">/* If EPP timeout bit clear then EPP available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">pb</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* No way to clear timeout */</span>

	<span class="cm">/* Check for Intel bug. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ecr</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">pb</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Phony EPP in ECP. */</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pb</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">|=</span> <span class="n">PARPORT_MODE_EPP</span><span class="p">;</span>

	<span class="cm">/* Set up access functions to use EPP hardware. */</span>
	<span class="n">pb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">epp_read_data</span> <span class="o">=</span> <span class="n">parport_pc_epp_read_data</span><span class="p">;</span>
	<span class="n">pb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">epp_write_data</span> <span class="o">=</span> <span class="n">parport_pc_epp_write_data</span><span class="p">;</span>
	<span class="n">pb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">epp_read_addr</span> <span class="o">=</span> <span class="n">parport_pc_epp_read_addr</span><span class="p">;</span>
	<span class="n">pb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">epp_write_addr</span> <span class="o">=</span> <span class="n">parport_pc_epp_write_addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parport_ECPEPP_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pb</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">oecr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ecr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">oecr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>
	<span class="cm">/* Search for SMC style EPP+ECP mode */</span>
	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">parport_EPP_supported</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>

	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">oecr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set up access functions to use ECP+EPP hardware. */</span>
		<span class="n">pb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">epp_read_data</span> <span class="o">=</span> <span class="n">parport_pc_ecpepp_read_data</span><span class="p">;</span>
		<span class="n">pb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">epp_write_data</span> <span class="o">=</span> <span class="n">parport_pc_ecpepp_write_data</span><span class="p">;</span>
		<span class="n">pb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">epp_read_addr</span> <span class="o">=</span> <span class="n">parport_pc_ecpepp_read_addr</span><span class="p">;</span>
		<span class="n">pb</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">epp_write_addr</span> <span class="o">=</span> <span class="n">parport_pc_ecpepp_write_addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* No IEEE 1284 support */</span><span class="cp"></span>

<span class="cm">/* Don&#39;t bother probing for modes we know we won&#39;t use. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">parport_PS2_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="cp">#ifdef CONFIG_PARPORT_PC_FIFO</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parport_ECP_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">parport_EPP_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">parport_ECPEPP_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">parport_ECPPS2_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* No IEEE 1284 support */</span><span class="cp"></span>

<span class="cm">/* --- IRQ detection -------------------------------------- */</span>

<span class="cm">/* Only if supports ECP mode */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">programmable_irq_support</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">intrLine</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">oecr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">lookup</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">PARPORT_IRQ_NONE</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">5</span>
	<span class="p">};</span>

	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">ECR_CNF</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span> <span class="cm">/* Configuration MODE */</span>

	<span class="n">intrLine</span> <span class="o">=</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">CONFIGB</span><span class="p">(</span><span class="n">pb</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">lookup</span><span class="p">[</span><span class="n">intrLine</span><span class="p">];</span>

	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">oecr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">irq_probe_ECP</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqs</span><span class="p">;</span>

	<span class="n">irqs</span> <span class="o">=</span> <span class="n">probe_irq_on</span><span class="p">();</span>

	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">ECR_SPP</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span> <span class="cm">/* Reset FIFO */</span>
	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="p">(</span><span class="n">ECR_TST</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">ECR_TST</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* If Full FIFO sure that writeIntrThreshold is generated */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1024</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xaa</span><span class="p">,</span> <span class="n">FIFO</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>

	<span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">probe_irq_off</span><span class="p">(</span><span class="n">irqs</span><span class="p">);</span>
	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">ECR_SPP</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This detection seems that only works in National Semiconductors</span>
<span class="cm"> * This doesn&#39;t work in SMC, LGS, and Winbond</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">irq_probe_EPP</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef ADVANCED_DETECT</span>
	<span class="k">return</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="kt">int</span> <span class="n">irqs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">oecr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">&amp;</span> <span class="n">PARPORT_MODE_PCECR</span><span class="p">)</span>
		<span class="n">oecr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">pb</span><span class="p">));</span>

	<span class="n">irqs</span> <span class="o">=</span> <span class="n">probe_irq_on</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">&amp;</span> <span class="n">PARPORT_MODE_PCECR</span><span class="p">)</span>
		<span class="n">frob_econtrol</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>

	<span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>
	<span class="n">parport_pc_frob_control</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">parport_pc_frob_control</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>

	<span class="cm">/* Device isn&#39;t expecting an EPP read</span>
<span class="cm">	 * and generates an IRQ.</span>
<span class="cm">	 */</span>
	<span class="n">parport_pc_read_epp</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">probe_irq_off</span><span class="p">(</span><span class="n">irqs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">&amp;</span> <span class="n">PARPORT_MODE_PCECR</span><span class="p">)</span>
		<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">oecr</span><span class="p">);</span>
	<span class="n">parport_pc_write_control</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* Advanced detection */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">irq_probe_SPP</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Don&#39;t even try to do this. */</span>
	<span class="k">return</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* We will attempt to share interrupt requests since other devices</span>
<span class="cm"> * such as sound cards and network cards seem to like using the</span>
<span class="cm"> * printer IRQs.</span>
<span class="cm"> *</span>
<span class="cm"> * When ECP is available we can autoprobe for IRQs.</span>
<span class="cm"> * NOTE: If we can autoprobe it, we can register the IRQ.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parport_irq_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">pb</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ecr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">programmable_irq_support</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">)</span>
			<span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq_probe_ECP</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ecr</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">&amp;</span> <span class="n">PARPORT_MODE_EPP</span><span class="p">))</span>
		<span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq_probe_EPP</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>

	<span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">PARPORT_IRQ_NONE</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">&amp;</span> <span class="n">PARPORT_MODE_EPP</span><span class="p">))</span>
		<span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq_probe_EPP</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>

	<span class="n">clear_epp_timeout</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">)</span>
		<span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq_probe_SPP</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">)</span>
		<span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">get_superio_irq</span><span class="p">(</span><span class="n">pb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pb</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --- DMA detection -------------------------------------- */</span>

<span class="cm">/* Only if chipset conforms to ECP ISA Interface Standard */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">programmable_dma_support</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">oecr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ECONTROL</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">dma</span><span class="p">;</span>

	<span class="n">frob_set_mode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ECR_CNF</span><span class="p">);</span>

	<span class="n">dma</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">CONFIGB</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="cm">/* 000: Indicates jumpered 8-bit DMA if read-only.</span>
<span class="cm">	   100: Indicates jumpered 16-bit DMA if read-only. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dma</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">;</span>

	<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">oecr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dma</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parport_dma_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ecr</span><span class="p">)</span>		<span class="cm">/* ask ECP chipset first */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">programmable_dma_support</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">==</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ask known Super-IO chips proper, although these</span>
<span class="cm">		   claim ECP compatible, some don&#39;t report their DMA</span>
<span class="cm">		   conforming to ECP standards */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">get_superio_dma</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --- Initialisation code -------------------------------- */</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">ports_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">ports_lock</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="nf">parport_pc_probe_port</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">base_hi</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">irqflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">parport_operations</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">probedirq</span> <span class="o">=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">base_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>	<span class="o">*</span><span class="n">ECR_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>	<span class="o">*</span><span class="n">EPP_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We need a physical device to attach to, but none was</span>
<span class="cm">		 * provided. Create our own. */</span>
		<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_register_simple</span><span class="p">(</span><span class="s">&quot;parport_pc&quot;</span><span class="p">,</span>
						       <span class="n">base</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">coherent_dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">coherent_dma_mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ops</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport_operations</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport_pc_private</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>

	<span class="cm">/* a misnomer, actually - it&#39;s allocate and reserve parport number */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">parport_register_port</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>

	<span class="n">base_res</span> <span class="o">=</span> <span class="n">request_region</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base_res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out4</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parport_pc_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport_operations</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctr</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctr_writable</span> <span class="o">=</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ecr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">base_hi</span> <span class="o">=</span> <span class="n">base_hi</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">=</span> <span class="n">PARPORT_MODE_PCSPP</span> <span class="o">|</span> <span class="n">PARPORT_MODE_SAFEININT</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">base_hi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ECR_res</span> <span class="o">=</span> <span class="n">request_region</span><span class="p">(</span><span class="n">base_hi</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ECR_res</span><span class="p">)</span>
			<span class="n">parport_ECR_present</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">!=</span> <span class="mh">0x3bc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EPP_res</span> <span class="o">=</span> <span class="n">request_region</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="mh">0x3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">EPP_res</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parport_EPP_supported</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
				<span class="n">parport_ECPEPP_supported</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parport_SPP_supported</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
		<span class="cm">/* No port. */</span>
		<span class="k">goto</span> <span class="n">out5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ecr</span><span class="p">)</span>
		<span class="n">parport_ECPPS2_supported</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">parport_PS2_supported</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">&amp;</span> <span class="n">PARPORT_MODE_EPP</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: PC-style at 0x%lx&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">base_hi</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ecr</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; (0x%lx)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">base_hi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">PARPORT_IRQ_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">;</span>
		<span class="n">parport_irq_probe</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">PARPORT_IRQ_PROBEONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">;</span>
		<span class="n">parport_irq_probe</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">probedirq</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;, irq %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ctr_writable</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">==</span> <span class="n">PARPORT_DMA_AUTO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">;</span>
			<span class="n">parport_dma_probe</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">==</span> <span class="n">PARPORT_DMA_AUTO</span><span class="p">)</span> <span class="cm">/* To use DMA, giving the irq</span>
<span class="cm">					   is mandatory (see above) */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PARPORT_PC_FIFO</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parport_ECP_supported</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">!=</span> <span class="n">PARPORT_DMA_NOFIFO</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fifo_depth</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">|=</span> <span class="n">PARPORT_MODE_ECP</span> <span class="o">|</span> <span class="n">PARPORT_MODE_COMPAT</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">compat_write_data</span> <span class="o">=</span> <span class="n">parport_pc_compat_write_block_pio</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PARPORT_1284</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">ecp_write_data</span> <span class="o">=</span> <span class="n">parport_pc_ecp_write_block_pio</span><span class="p">;</span>
		<span class="cm">/* currently broken, but working on it.. (FB) */</span>
		<span class="cm">/* p-&gt;ops-&gt;ecp_read_data = parport_pc_ecp_read_block_pio; */</span>
<span class="cp">#endif </span><span class="cm">/* IEEE 1284 support */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">!=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;, dma %d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">|=</span> <span class="n">PARPORT_MODE_DMA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;, using FIFO&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* We can&#39;t use the DMA channel after all. */</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* Allowed to use FIFO/DMA */</span><span class="cp"></span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; [&quot;</span><span class="p">);</span>

<span class="cp">#define printmode(x) \</span>
<span class="cp">	{\</span>
<span class="cp">		if (p-&gt;modes &amp; PARPORT_MODE_##x) {\</span>
<span class="cp">			printk(KERN_CONT &quot;%s%s&quot;, f ? &quot;,&quot; : &quot;&quot;, #x);\</span>
<span class="cp">			f++;\</span>
<span class="cp">		} \</span>
<span class="cp">	}</span>

	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printmode</span><span class="p">(</span><span class="n">PCSPP</span><span class="p">);</span>
		<span class="n">printmode</span><span class="p">(</span><span class="n">TRISTATE</span><span class="p">);</span>
		<span class="n">printmode</span><span class="p">(</span><span class="n">COMPAT</span><span class="p">)</span>
		<span class="n">printmode</span><span class="p">(</span><span class="n">EPP</span><span class="p">);</span>
		<span class="n">printmode</span><span class="p">(</span><span class="n">ECP</span><span class="p">);</span>
		<span class="n">printmode</span><span class="p">(</span><span class="n">DMA</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#undef printmode</span>
<span class="cp">#ifndef CONFIG_PARPORT_1284</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;(,...)&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PARPORT_1284 */</span><span class="cp"></span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">probedirq</span> <span class="o">!=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: irq %d detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">probedirq</span><span class="p">);</span>

	<span class="cm">/* If No ECP release the ports grabbed above. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ECR_res</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">&amp;</span> <span class="n">PARPORT_MODE_ECP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">base_hi</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">ECR_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Likewise for EEP ports */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EPP_res</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">&amp;</span> <span class="n">PARPORT_MODE_EPP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">EPP_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">parport_irq_handler</span><span class="p">,</span>
				 <span class="n">irqflags</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: irq %d in use, &quot;</span>
				<span class="s">&quot;resorting to polled operation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">;</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PARPORT_PC_FIFO</span>
<span class="cp">#ifdef HAS_DMA</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">!=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: dma %d in use, &quot;</span>
					<span class="s">&quot;resorting to PIO operation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_buf</span> <span class="o">=</span>
				  <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						       <span class="n">PAGE_SIZE</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_handle</span><span class="p">,</span>
						       <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_buf</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: &quot;</span>
						<span class="s">&quot;cannot get buffer for DMA, &quot;</span>
						<span class="s">&quot;resorting to PIO operation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">free_dma</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* Done probing.  Now put the port into a sensible start-up state. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ecr</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * Put the ECP detected port in PS2 mode.</span>
<span class="cm">		 * Do this also for ports that have ECR but don&#39;t do ECP.</span>
<span class="cm">		 */</span>
		<span class="n">ECR_WRITE</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">);</span>

	<span class="n">parport_pc_write_data</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">parport_pc_data_forward</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="cm">/* Now that we&#39;ve told the sharing engine about the port, and</span>
<span class="cm">	   found out its characteristics, let the high-level drivers</span>
<span class="cm">	   know about it. */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ports_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ports_list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ports_lock</span><span class="p">);</span>
	<span class="n">parport_announce_port</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>

<span class="nl">out5:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ECR_res</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">base_hi</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">EPP_res</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="mh">0x3</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="nl">out4:</span>
	<span class="n">parport_put_port</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="nl">out3:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">out2:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="nl">out1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="p">)</span>
		<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">parport_pc_probe_port</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">parport_pc_unregister_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">parport_operations</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="n">parport_remove_port</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ports_lock</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ports_lock</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PARPORT_PC_FIFO) &amp;&amp; defined(HAS_DMA)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">!=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">)</span>
		<span class="n">free_dma</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">modes</span> <span class="o">&amp;</span> <span class="n">PARPORT_MODE_ECP</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">base_hi</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PARPORT_PC_FIFO) &amp;&amp; defined(HAS_DMA)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_buf</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_buf</span><span class="p">,</span>
				    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dma_handle</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="n">parport_put_port</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span> <span class="cm">/* hope no-one cached it */</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">parport_pc_unregister_port</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PCI</span>

<span class="cm">/* ITE support maintained by Rich Liu &lt;richliu@poorman.org&gt; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sio_ite_8872_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autoirq</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">autodma</span><span class="p">,</span>
					 <span class="k">const</span> <span class="k">struct</span> <span class="n">parport_pc_via_data</span> <span class="o">*</span><span class="n">via</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">inta_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x2A0</span><span class="p">,</span> <span class="mh">0x2C0</span><span class="p">,</span> <span class="mh">0x220</span><span class="p">,</span> <span class="mh">0x240</span><span class="p">,</span> <span class="mh">0x1E0</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">ite8872set</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ite8872_lpt</span><span class="p">,</span> <span class="n">ite8872_lpthi</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ite8872_irq</span><span class="p">,</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sio_ite_8872_probe()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* make sure which one chip */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="n">inta_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;it887x&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">test</span><span class="p">;</span>
			<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span>
						<span class="mh">0xe5000000</span> <span class="o">|</span> <span class="n">inta_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span>
						<span class="mh">0x00000000</span> <span class="o">|</span> <span class="n">inta_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">test</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">inta_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">inta_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">32</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;parport_pc: cannot find ITE8872 INTA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">inta_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x2</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;parport_pc: ITE8871 found (1P)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ite8872set</span> <span class="o">=</span> <span class="mh">0x64200000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xa</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;parport_pc: ITE8875 found (1P)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ite8872set</span> <span class="o">=</span> <span class="mh">0x64200000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xe</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;parport_pc: ITE8872 found (2S1P)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ite8872set</span> <span class="o">=</span> <span class="mh">0x64e00000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x6</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;parport_pc: ITE8873 found (1S)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">inta_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">32</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x8</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;parport_pc: ITE8874 found (2S)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">inta_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">32</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;parport_pc: unknown ITE887x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;parport_pc: please mail &#39;lspci -nvv&#39; &quot;</span>
			<span class="s">&quot;output to Rich.Liu@ite.com.tw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">inta_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">32</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ite8872_irq</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ite8872_lpt</span><span class="p">);</span>
	<span class="n">ite8872_lpt</span> <span class="o">&amp;=</span> <span class="mh">0x0000ff00</span><span class="p">;</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ite8872_lpthi</span><span class="p">);</span>
	<span class="n">ite8872_lpthi</span> <span class="o">&amp;=</span> <span class="mh">0x0000ff00</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xe3000000</span> <span class="o">|</span> <span class="n">ite8872_lpt</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xe3000000</span> <span class="o">|</span> <span class="n">ite8872_lpthi</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="p">(</span><span class="n">ite8872_lpthi</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">ite8872_lpt</span><span class="p">);</span>
	<span class="cm">/* SET SPP&amp;EPP , Parallel Port NO DMA , Enable All Function */</span>
	<span class="cm">/* SET Parallel IRQ */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span>
				<span class="n">ite8872set</span> <span class="o">|</span> <span class="p">(</span><span class="n">ite8872_irq</span> <span class="o">*</span> <span class="mh">0x11111</span><span class="p">));</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ITE887x: The IRQ is %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ite8872_irq</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ITE887x: The PARALLEL I/O port is 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ite8872_lpt</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ITE887x: The PARALLEL I/O porthi is 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ite8872_lpthi</span><span class="p">);</span>

	<span class="cm">/* Let the user (or defaults) steer us away from interrupts */</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">ite8872_irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">autoirq</span> <span class="o">!=</span> <span class="n">PARPORT_IRQ_AUTO</span><span class="p">)</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Release the resource so that parport_pc_probe_port can get it.</span>
<span class="cm">	 */</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">inta_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parport_pc_probe_port</span><span class="p">(</span><span class="n">ite8872_lpt</span><span class="p">,</span> <span class="n">ite8872_lpthi</span><span class="p">,</span>
				   <span class="n">irq</span><span class="p">,</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;parport_pc: ITE 8872 parallel port: io=0x%X&quot;</span><span class="p">,</span>
								<span class="n">ite8872_lpt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, irq=%d&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* VIA 8231 support by Pavel Fedin &lt;sonic_amiga@rambler.ru&gt;</span>
<span class="cm">   based on VIA 686a support code by Jeff Garzik &lt;jgarzik@pobox.com&gt; */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinitdata</span> <span class="n">parport_init_mode</span><span class="p">;</span>

<span class="cm">/* Data for two known VIA chips */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">parport_pc_via_data</span> <span class="n">via_686a_data</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x51</span><span class="p">,</span>
	<span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x85</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span>
	<span class="mh">0xE2</span><span class="p">,</span>
	<span class="mh">0xF0</span><span class="p">,</span>
	<span class="mh">0xE6</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">parport_pc_via_data</span> <span class="n">via_8231_data</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x45</span><span class="p">,</span>
	<span class="mh">0x44</span><span class="p">,</span>
	<span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0xF2</span><span class="p">,</span>
	<span class="mh">0xFA</span><span class="p">,</span>
	<span class="mh">0xF6</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sio_via_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autoirq</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">autodma</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">parport_pc_via_data</span> <span class="o">*</span><span class="n">via</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">,</span> <span class="n">siofunc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ppcontrol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">port1</span><span class="p">,</span> <span class="n">port2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">have_epp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;parport_pc: VIA 686A/8231 detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">parport_init_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;parport_pc: setting SPP mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">siofunc</span> <span class="o">=</span> <span class="n">VIA_FUNCTION_PARPORT_SPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;parport_pc: setting PS/2 mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">siofunc</span> <span class="o">=</span> <span class="n">VIA_FUNCTION_PARPORT_SPP</span><span class="p">;</span>
		<span class="n">ppcontrol</span> <span class="o">=</span> <span class="n">VIA_PARPORT_BIDIR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;parport_pc: setting EPP mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">siofunc</span> <span class="o">=</span> <span class="n">VIA_FUNCTION_PARPORT_EPP</span><span class="p">;</span>
		<span class="n">ppcontrol</span> <span class="o">=</span> <span class="n">VIA_PARPORT_BIDIR</span><span class="p">;</span>
		<span class="n">have_epp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;parport_pc: setting ECP mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">siofunc</span> <span class="o">=</span> <span class="n">VIA_FUNCTION_PARPORT_ECP</span><span class="p">;</span>
		<span class="n">ppcontrol</span> <span class="o">=</span> <span class="n">VIA_PARPORT_BIDIR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;parport_pc: setting EPP+ECP mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">siofunc</span> <span class="o">=</span> <span class="n">VIA_FUNCTION_PARPORT_ECP</span><span class="p">;</span>
		<span class="n">ppcontrol</span> <span class="o">=</span> <span class="n">VIA_PARPORT_BIDIR</span><span class="o">|</span><span class="n">VIA_PARPORT_ECPEPP</span><span class="p">;</span>
		<span class="n">have_epp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			<span class="s">&quot;parport_pc: probing current configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">siofunc</span> <span class="o">=</span> <span class="n">VIA_FUNCTION_PROBE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * unlock super i/o configuration</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">via</span><span class="o">-&gt;</span><span class="n">via_pci_superio_config_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">via</span><span class="o">-&gt;</span><span class="n">via_pci_superio_config_data</span><span class="p">;</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">via</span><span class="o">-&gt;</span><span class="n">via_pci_superio_config_reg</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* Bits 1-0: Parallel Port Mode / Enable */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">via</span><span class="o">-&gt;</span><span class="n">viacfg_function</span><span class="p">,</span> <span class="n">VIA_CONFIG_INDEX</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">VIA_CONFIG_DATA</span><span class="p">);</span>
	<span class="cm">/* Bit 5: EPP+ECP enable; bit 7: PS/2 bidirectional port enable */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">via</span><span class="o">-&gt;</span><span class="n">viacfg_parport_control</span><span class="p">,</span> <span class="n">VIA_CONFIG_INDEX</span><span class="p">);</span>
	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">VIA_CONFIG_DATA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">siofunc</span> <span class="o">==</span> <span class="n">VIA_FUNCTION_PROBE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">siofunc</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">VIA_FUNCTION_PARPORT_DISABLE</span><span class="p">;</span>
		<span class="n">ppcontrol</span> <span class="o">=</span> <span class="n">tmp2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIA_FUNCTION_PARPORT_DISABLE</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">siofunc</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">via</span><span class="o">-&gt;</span><span class="n">viacfg_function</span><span class="p">,</span> <span class="n">VIA_CONFIG_INDEX</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">VIA_CONFIG_DATA</span><span class="p">);</span>
		<span class="n">tmp2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VIA_PARPORT_BIDIR</span><span class="o">|</span><span class="n">VIA_PARPORT_ECPEPP</span><span class="p">);</span>
		<span class="n">tmp2</span> <span class="o">|=</span> <span class="n">ppcontrol</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">via</span><span class="o">-&gt;</span><span class="n">viacfg_parport_control</span><span class="p">,</span> <span class="n">VIA_CONFIG_INDEX</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">tmp2</span><span class="p">,</span> <span class="n">VIA_CONFIG_DATA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Parallel Port I/O Base Address, bits 9-2 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">via</span><span class="o">-&gt;</span><span class="n">viacfg_parport_base</span><span class="p">,</span> <span class="n">VIA_CONFIG_INDEX</span><span class="p">);</span>
	<span class="n">port1</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">VIA_CONFIG_DATA</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;parport_pc: Current parallel port base: 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
									<span class="n">port1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port1</span> <span class="o">==</span> <span class="mh">0x3BC</span> <span class="o">&amp;&amp;</span> <span class="n">have_epp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">via</span><span class="o">-&gt;</span><span class="n">viacfg_parport_base</span><span class="p">,</span> <span class="n">VIA_CONFIG_INDEX</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">((</span><span class="mh">0x378</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">VIA_CONFIG_DATA</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			<span class="s">&quot;parport_pc: Parallel port base changed to 0x378</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">port1</span> <span class="o">=</span> <span class="mh">0x378</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * lock super i/o configuration</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">via</span><span class="o">-&gt;</span><span class="n">via_pci_superio_config_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">via</span><span class="o">-&gt;</span><span class="n">via_pci_superio_config_data</span><span class="p">;</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">via</span><span class="o">-&gt;</span><span class="n">via_pci_superio_config_reg</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">siofunc</span> <span class="o">==</span> <span class="n">VIA_FUNCTION_PARPORT_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;parport_pc: VIA parallel port disabled in BIOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Bits 7-4: PnP Routing for Parallel Port IRQ */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">via</span><span class="o">-&gt;</span><span class="n">via_pci_parport_irq_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">VIA_IRQCONTROL_PARALLEL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">siofunc</span> <span class="o">==</span> <span class="n">VIA_FUNCTION_PARPORT_ECP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Bits 3-2: PnP Routing for Parallel Port DMA */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">via</span><span class="o">-&gt;</span><span class="n">via_pci_parport_dma_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">VIA_DMACONTROL_PARALLEL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* if ECP not enabled, DMA is not enabled, assumed</span>
<span class="cm">		   bogus &#39;dma&#39; value */</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">;</span>

	<span class="cm">/* Let the user (or defaults) steer us away from interrupts and DMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">autoirq</span> <span class="o">==</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">;</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">autodma</span> <span class="o">==</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">)</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">port1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x3bc</span>:
		<span class="n">port2</span> <span class="o">=</span> <span class="mh">0x7bc</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x378</span>:
		<span class="n">port2</span> <span class="o">=</span> <span class="mh">0x778</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x278</span>:
		<span class="n">port2</span> <span class="o">=</span> <span class="mh">0x678</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;parport_pc: Weird VIA parport base 0x%X, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
									<span class="n">port1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* filter bogus IRQs */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="k">case</span> <span class="mi">13</span>:
		<span class="n">irq</span> <span class="o">=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span> <span class="cm">/* do nothing */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* finally, do the probe with values obtained */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parport_pc_probe_port</span><span class="p">(</span><span class="n">port1</span><span class="p">,</span> <span class="n">port2</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;parport_pc: VIA parallel port: io=0x%X&quot;</span><span class="p">,</span> <span class="n">port1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, irq=%d&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span> <span class="o">!=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, dma=%d&quot;</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;parport_pc: Strange, can&#39;t probe VIA parallel port: io=0x%X, irq=%d, dma=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">port1</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">enum</span> <span class="n">parport_pc_sio_types</span> <span class="p">{</span>
	<span class="n">sio_via_686a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>   <span class="cm">/* Via VT82C686A motherboard Super I/O */</span>
	<span class="n">sio_via_8231</span><span class="p">,</span>	    <span class="cm">/* Via VT8231 south bridge integrated Super IO */</span>
	<span class="n">sio_ite_8872</span><span class="p">,</span>
	<span class="n">last_sio</span>
<span class="p">};</span>

<span class="cm">/* each element directly indexed from enum list, above */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">parport_pc_superio</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">probe</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autoirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autodma</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">parport_pc_via_data</span> <span class="o">*</span><span class="n">via</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">parport_pc_via_data</span> <span class="o">*</span><span class="n">via</span><span class="p">;</span>
<span class="p">}</span> <span class="n">parport_pc_superio_info</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">sio_via_probe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">via_686a_data</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">sio_via_probe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">via_8231_data</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">sio_ite_8872_probe</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">parport_pc_pci_cards</span> <span class="p">{</span>
	<span class="n">siig_1p_10x</span> <span class="o">=</span> <span class="n">last_sio</span><span class="p">,</span>
	<span class="n">siig_2p_10x</span><span class="p">,</span>
	<span class="n">siig_1p_20x</span><span class="p">,</span>
	<span class="n">siig_2p_20x</span><span class="p">,</span>
	<span class="n">lava_parallel</span><span class="p">,</span>
	<span class="n">lava_parallel_dual_a</span><span class="p">,</span>
	<span class="n">lava_parallel_dual_b</span><span class="p">,</span>
	<span class="n">boca_ioppar</span><span class="p">,</span>
	<span class="n">plx_9050</span><span class="p">,</span>
	<span class="n">timedia_4006a</span><span class="p">,</span>
	<span class="n">timedia_4014</span><span class="p">,</span>
	<span class="n">timedia_4008a</span><span class="p">,</span>
	<span class="n">timedia_4018</span><span class="p">,</span>
	<span class="n">timedia_9018a</span><span class="p">,</span>
	<span class="n">syba_2p_epp</span><span class="p">,</span>
	<span class="n">syba_1p_ecp</span><span class="p">,</span>
	<span class="n">titan_010l</span><span class="p">,</span>
	<span class="n">titan_1284p1</span><span class="p">,</span>
	<span class="n">titan_1284p2</span><span class="p">,</span>
	<span class="n">avlab_1p</span><span class="p">,</span>
	<span class="n">avlab_2p</span><span class="p">,</span>
	<span class="n">oxsemi_952</span><span class="p">,</span>
	<span class="n">oxsemi_954</span><span class="p">,</span>
	<span class="n">oxsemi_840</span><span class="p">,</span>
	<span class="n">oxsemi_pcie_pport</span><span class="p">,</span>
	<span class="n">aks_0100</span><span class="p">,</span>
	<span class="n">mobility_pp</span><span class="p">,</span>
	<span class="n">netmos_9705</span><span class="p">,</span>
	<span class="n">netmos_9715</span><span class="p">,</span>
	<span class="n">netmos_9755</span><span class="p">,</span>
	<span class="n">netmos_9805</span><span class="p">,</span>
	<span class="n">netmos_9815</span><span class="p">,</span>
	<span class="n">netmos_9901</span><span class="p">,</span>
	<span class="n">netmos_9865</span><span class="p">,</span>
	<span class="n">quatech_sppxp100</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* each element directly indexed from enum list, above</span>
<span class="cm"> * (but offset by last_sio) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">parport_pc_pci</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">numports</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span> <span class="cm">/* BAR (base address registers) numbers in the config</span>
<span class="cm">		    space header */</span>
		<span class="kt">int</span> <span class="n">lo</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">hi</span><span class="p">;</span>
		<span class="cm">/* -1 if not there, &gt;6 for offset-method (max BAR is 6) */</span>
	<span class="p">}</span> <span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* If set, this is called immediately after pci_enable_device.</span>
<span class="cm">	 * If it returns non-zero, no probing will take place and the</span>
<span class="cm">	 * ports will not be used. */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">preinit_hook</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autoirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autodma</span><span class="p">);</span>

	<span class="cm">/* If set, this is called after probing for ports.  If &#39;failed&#39;</span>
<span class="cm">	 * is non-zero we couldn&#39;t use any of the ports. */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">postinit_hook</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">failed</span><span class="p">);</span>
<span class="p">}</span> <span class="n">cards</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* siig_1p_10x */</span>		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* siig_2p_10x */</span>		<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* siig_1p_20x */</span>		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* siig_2p_20x */</span>		<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* lava_parallel */</span>		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* lava_parallel_dual_a */</span>	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* lava_parallel_dual_b */</span>	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* boca_ioppar */</span>		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* plx_9050 */</span>			<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* timedia_4006a */</span>             <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* timedia_4014  */</span>             <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* timedia_4008a */</span>             <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* timedia_4018  */</span>             <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* timedia_9018a */</span>             <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
					<span class="cm">/* SYBA uses fixed offsets in</span>
<span class="cm">					   a 1K io window */</span>
	<span class="cm">/* syba_2p_epp AP138B */</span>	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x078</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x178</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* syba_1p_ecp W83787 */</span>	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x078</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* titan_010l */</span>		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* titan_1284p1 */</span>              <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* titan_1284p2 */</span>		<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* avlab_1p		*/</span>	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* avlab_2p		*/</span>	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},}</span> <span class="p">},</span>
	<span class="cm">/* The Oxford Semi cards are unusual: 954 doesn&#39;t support ECP,</span>
<span class="cm">	 * and 840 locks up if you write 1 to bit 2! */</span>
	<span class="cm">/* oxsemi_952 */</span>		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* oxsemi_954 */</span>		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* oxsemi_840 */</span>		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* oxsemi_pcie_pport */</span>		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* aks_0100 */</span>                  <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* mobility_pp */</span>		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>

	<span class="cm">/* The netmos entries below are untested */</span>
	<span class="cm">/* netmos_9705 */</span>               <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* netmos_9715 */</span>               <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},}</span> <span class="p">},</span>
	<span class="cm">/* netmos_9755 */</span>               <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},}</span> <span class="p">},</span>
	<span class="cm">/* netmos_9805 */</span>               <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* netmos_9815 */</span>               <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* netmos_9901 */</span>               <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* netmos_9865 */</span>               <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* quatech_sppxp100 */</span>		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">parport_pc_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Super-IO onboard chips */</span>
	<span class="p">{</span> <span class="mh">0x1106</span><span class="p">,</span> <span class="mh">0x0686</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sio_via_686a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1106</span><span class="p">,</span> <span class="mh">0x8231</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sio_via_8231</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ITE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ITE_8872</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sio_ite_8872</span> <span class="p">},</span>

	<span class="cm">/* PCI cards */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_SIIG</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SIIG_1P_10x</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">siig_1p_10x</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_SIIG</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SIIG_2P_10x</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">siig_2p_10x</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_SIIG</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SIIG_1P_20x</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">siig_1p_20x</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_SIIG</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SIIG_2P_20x</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">siig_2p_20x</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LAVA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_LAVA_PARALLEL</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lava_parallel</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LAVA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_LAVA_DUAL_PAR_A</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lava_parallel_dual_a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LAVA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_LAVA_DUAL_PAR_B</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lava_parallel_dual_b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_LAVA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_LAVA_BOCA_IOPPAR</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">boca_ioppar</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_PLX</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_PLX_9050</span><span class="p">,</span>
	  <span class="n">PCI_SUBVENDOR_ID_EXSYS</span><span class="p">,</span> <span class="n">PCI_SUBDEVICE_ID_EXSYS_4014</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">plx_9050</span> <span class="p">},</span>
	<span class="cm">/* PCI_VENDOR_ID_TIMEDIA/SUNIX has many differing cards ...*/</span>
	<span class="p">{</span> <span class="mh">0x1409</span><span class="p">,</span> <span class="mh">0x7268</span><span class="p">,</span> <span class="mh">0x1409</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timedia_4006a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1409</span><span class="p">,</span> <span class="mh">0x7268</span><span class="p">,</span> <span class="mh">0x1409</span><span class="p">,</span> <span class="mh">0x0102</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timedia_4014</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1409</span><span class="p">,</span> <span class="mh">0x7268</span><span class="p">,</span> <span class="mh">0x1409</span><span class="p">,</span> <span class="mh">0x0103</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timedia_4008a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1409</span><span class="p">,</span> <span class="mh">0x7268</span><span class="p">,</span> <span class="mh">0x1409</span><span class="p">,</span> <span class="mh">0x0104</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timedia_4018</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1409</span><span class="p">,</span> <span class="mh">0x7268</span><span class="p">,</span> <span class="mh">0x1409</span><span class="p">,</span> <span class="mh">0x9018</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">timedia_9018a</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_SYBA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SYBA_2P_EPP</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">syba_2p_epp</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_SYBA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SYBA_1P_ECP</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">syba_1p_ecp</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_TITAN</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_TITAN_010L</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">titan_010l</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x9710</span><span class="p">,</span> <span class="mh">0x9805</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">titan_1284p1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x9710</span><span class="p">,</span> <span class="mh">0x9815</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">titan_1284p2</span> <span class="p">},</span>
	<span class="cm">/* PCI_VENDOR_ID_AVLAB/Intek21 has another bunch of cards ...*/</span>
	<span class="cm">/* AFAVLAB_TK9902 */</span>
	<span class="p">{</span> <span class="mh">0x14db</span><span class="p">,</span> <span class="mh">0x2120</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">avlab_1p</span><span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x14db</span><span class="p">,</span> <span class="mh">0x2121</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">avlab_2p</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_OXSEMI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_OXSEMI_16PCI952PP</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oxsemi_952</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_OXSEMI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_OXSEMI_16PCI954PP</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oxsemi_954</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_OXSEMI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_OXSEMI_12PCI840</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oxsemi_840</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_OXSEMI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_OXSEMI_PCIe840</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oxsemi_pcie_pport</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_OXSEMI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_OXSEMI_PCIe840_G</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oxsemi_pcie_pport</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_OXSEMI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_OXSEMI_PCIe952_0</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oxsemi_pcie_pport</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_OXSEMI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_OXSEMI_PCIe952_0_G</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oxsemi_pcie_pport</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_OXSEMI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_OXSEMI_PCIe952_1</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oxsemi_pcie_pport</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_OXSEMI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_OXSEMI_PCIe952_1_G</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oxsemi_pcie_pport</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_OXSEMI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_OXSEMI_PCIe952_1_U</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oxsemi_pcie_pport</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_OXSEMI</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_OXSEMI_PCIe952_1_GU</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oxsemi_pcie_pport</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_AKS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_AKS_ALADDINCARD</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aks_0100</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x14f2</span><span class="p">,</span> <span class="mh">0x0121</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mobility_pp</span> <span class="p">},</span>
	<span class="cm">/* NetMos communication controllers */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_NETMOS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NETMOS_9705</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">netmos_9705</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_NETMOS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NETMOS_9715</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">netmos_9715</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_NETMOS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NETMOS_9755</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">netmos_9755</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_NETMOS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NETMOS_9805</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">netmos_9805</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_NETMOS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NETMOS_9815</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">netmos_9815</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_NETMOS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NETMOS_9901</span><span class="p">,</span>
	  <span class="mh">0xA000</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">netmos_9901</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_NETMOS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NETMOS_9865</span><span class="p">,</span>
	  <span class="mh">0xA000</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">netmos_9865</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_NETMOS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NETMOS_9865</span><span class="p">,</span>
	  <span class="mh">0xA000</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">netmos_9865</span> <span class="p">},</span>
	<span class="cm">/* Quatech SPPXP-100 Parallel port PCI ExpressCard */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_QUATECH</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_QUATECH_SPPXP_100</span><span class="p">,</span>
	  <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">quatech_sppxp100</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span> <span class="cm">/* terminate list */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">parport_pc_pci_tbl</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">pci_parport_data</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">ports</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parport_pc_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_parport_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">last_sio</span><span class="p">)</span>
		<span class="cm">/* This is an onboard Super-IO and has already been probed */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* This is a PCI card */</span>
	<span class="n">i</span> <span class="o">-=</span> <span class="n">last_sio</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_parport_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">preinit_hook</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">preinit_hook</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">,</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">numports</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">lo</span> <span class="o">=</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">lo</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">hi</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_lo</span><span class="p">,</span> <span class="n">io_hi</span><span class="p">;</span>
		<span class="n">io_lo</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lo</span><span class="p">);</span>
		<span class="n">io_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hi</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">))</span>
			<span class="n">io_hi</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">io_lo</span> <span class="o">+=</span> <span class="n">hi</span><span class="p">;</span> <span class="cm">/* Reinterpret the meaning of</span>
<span class="cm">					&quot;hi&quot; as an offset (see SYBA</span>
<span class="cm">					def.) */</span>
		<span class="cm">/* TODO: test if sharing interrupts works */</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="n">IRQ_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	<span class="s">&quot;PCI parallel port detected: %04x:%04x, I/O at %#lx(%#lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">parport_pc_pci_tbl</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">last_sio</span><span class="p">].</span><span class="n">vendor</span><span class="p">,</span>
				<span class="n">parport_pc_pci_tbl</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">last_sio</span><span class="p">].</span><span class="n">device</span><span class="p">,</span>
				<span class="n">io_lo</span><span class="p">,</span> <span class="n">io_hi</span><span class="p">);</span>
			<span class="n">irq</span> <span class="o">=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	<span class="s">&quot;PCI parallel port detected: %04x:%04x, I/O at %#lx(%#lx), IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">parport_pc_pci_tbl</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">last_sio</span><span class="p">].</span><span class="n">vendor</span><span class="p">,</span>
				<span class="n">parport_pc_pci_tbl</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">last_sio</span><span class="p">].</span><span class="n">device</span><span class="p">,</span>
				<span class="n">io_lo</span><span class="p">,</span> <span class="n">io_hi</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">parport_pc_probe_port</span><span class="p">(</span><span class="n">io_lo</span><span class="p">,</span> <span class="n">io_hi</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span>
					       <span class="n">PARPORT_DMA_NONE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					       <span class="n">IRQF_SHARED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">count</span><span class="p">])</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">postinit_hook</span><span class="p">)</span>
		<span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">postinit_hook</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">parport_pc_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_parport_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="n">parport_pc_unregister_port</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">parport_pc_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;parport_pc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">parport_pc_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">parport_pc_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">parport_pc_pci_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parport_pc_init_superio</span><span class="p">(</span><span class="kt">int</span> <span class="n">autoirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autodma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">for_each_pci_dev</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">pci_match_id</span><span class="p">(</span><span class="n">parport_pc_pci_tbl</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&gt;=</span> <span class="n">last_sio</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">parport_pc_superio_info</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">probe</span><span class="p">(</span>
			<span class="n">pdev</span><span class="p">,</span> <span class="n">autoirq</span><span class="p">,</span> <span class="n">autodma</span><span class="p">,</span>
			<span class="n">parport_pc_superio_info</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">via</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span> <span class="cm">/* number of devices found */</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">parport_pc_pci_driver</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parport_pc_init_superio</span><span class="p">(</span><span class="kt">int</span> <span class="n">autoirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autodma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PNP</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="n">parport_pc_pnp_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Standard LPT Printer Port */</span>
	<span class="p">{.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;PNP0400&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/* ECP Printer Port */</span>
	<span class="p">{.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;PNP0401&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pnp</span><span class="p">,</span> <span class="n">parport_pc_pnp_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parport_pc_pnp_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_lo</span><span class="p">,</span> <span class="n">io_hi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_port_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">pnp_port_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_DISABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">io_lo</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_port_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">pnp_port_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_DISABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">io_hi</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">io_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_irq_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">pnp_irq_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_DISABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_dma_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">pnp_dma_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_DISABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">pnp_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reported by %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="n">parport_pc_probe_port</span><span class="p">(</span><span class="n">io_lo</span><span class="p">,</span> <span class="n">io_hi</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pnp_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pdata</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">parport_pc_pnp_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="p">)</span><span class="n">pnp_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">parport_pc_unregister_port</span><span class="p">(</span><span class="n">pdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* we only need the pnp layer to activate the device, at least for now */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_driver</span> <span class="n">parport_pc_pnp_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;parport_pc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">parport_pc_pnp_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">parport_pc_pnp_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">parport_pc_pnp_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_driver</span> <span class="n">parport_pc_pnp_driver</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PNP */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">parport_pc_platform_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Always succeed, the actual probing is done in</span>
<span class="cm">	 * parport_pc_probe_port(). */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">parport_pc_platform_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;parport_pc&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">parport_pc_platform_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* This is called by parport_pc_find_nonpci_ports (in asm/parport.h) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">unused</span><span class="p">))</span>
<span class="n">parport_pc_find_isa_ports</span><span class="p">(</span><span class="kt">int</span> <span class="n">autoirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autodma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parport_pc_probe_port</span><span class="p">(</span><span class="mh">0x3bc</span><span class="p">,</span> <span class="mh">0x7bc</span><span class="p">,</span> <span class="n">autoirq</span><span class="p">,</span> <span class="n">autodma</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parport_pc_probe_port</span><span class="p">(</span><span class="mh">0x378</span><span class="p">,</span> <span class="mh">0x778</span><span class="p">,</span> <span class="n">autoirq</span><span class="p">,</span> <span class="n">autodma</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parport_pc_probe_port</span><span class="p">(</span><span class="mh">0x278</span><span class="p">,</span> <span class="mh">0x678</span><span class="p">,</span> <span class="n">autoirq</span><span class="p">,</span> <span class="n">autodma</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function is called by parport_pc_init if the user didn&#39;t</span>
<span class="cm"> * specify any ports to probe.  Its job is to find some ports.  Order</span>
<span class="cm"> * is important here -- we want ISA ports to be registered first,</span>
<span class="cm"> * followed by PCI cards (for least surprise), but before that we want</span>
<span class="cm"> * to do chipset-specific tests for some onboard ports that we know</span>
<span class="cm"> * about.</span>
<span class="cm"> *</span>
<span class="cm"> * autoirq is PARPORT_IRQ_NONE, PARPORT_IRQ_AUTO, or PARPORT_IRQ_PROBEONLY</span>
<span class="cm"> * autodma is PARPORT_DMA_NONE or PARPORT_DMA_AUTO</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">parport_pc_find_ports</span><span class="p">(</span><span class="kt">int</span> <span class="n">autoirq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autodma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PARPORT_PC_SUPERIO</span>
	<span class="n">detect_and_report_it87</span><span class="p">();</span>
	<span class="n">detect_and_report_winbond</span><span class="p">();</span>
	<span class="n">detect_and_report_smsc</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="cm">/* Onboard SuperIO chipsets that show themselves on the PCI bus. */</span>
	<span class="n">count</span> <span class="o">+=</span> <span class="n">parport_pc_init_superio</span><span class="p">(</span><span class="n">autoirq</span><span class="p">,</span> <span class="n">autodma</span><span class="p">);</span>

	<span class="cm">/* PnP ports, skip detection if SuperIO already found them */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pnp_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parport_pc_pnp_driver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">pnp_registered_parport</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ISA ports and whatever (see asm/parport.h). */</span>
	<span class="n">parport_pc_find_nonpci_ports</span><span class="p">(</span><span class="n">autoirq</span><span class="p">,</span> <span class="n">autodma</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parport_pc_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">pci_registered_parport</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Piles of crap below pretend to be a parser for module and kernel</span>
<span class="cm"> *	parameters.  Say &quot;thank you&quot; to whoever had come up with that</span>
<span class="cm"> *	syntax and keep in mind that code below is a cleaned up version.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">io</span><span class="p">[</span><span class="n">PARPORT_PC_MAX_PORTS</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">PARPORT_PC_MAX_PORTS</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">io_hi</span><span class="p">[</span><span class="n">PARPORT_PC_MAX_PORTS</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">PARPORT_PC_MAX_PORTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">PARPORT_IOHI_AUTO</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">dmaval</span><span class="p">[</span><span class="n">PARPORT_PC_MAX_PORTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">PARPORT_PC_MAX_PORTS</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">PARPORT_DMA_NONE</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">irqval</span><span class="p">[</span><span class="n">PARPORT_PC_MAX_PORTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">PARPORT_PC_MAX_PORTS</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">PARPORT_IRQ_PROBEONLY</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parport_parse_param</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">automatic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">none</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nofifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;auto&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">automatic</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">none</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nofifo</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;nofifo&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">nofifo</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">!=</span> <span class="n">s</span><span class="p">)</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;parport: bad specifier `%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parport_parse_irq</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">irqstr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">parport_parse_param</span><span class="p">(</span><span class="n">irqstr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">PARPORT_IRQ_AUTO</span><span class="p">,</span>
				     <span class="n">PARPORT_IRQ_NONE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parport_parse_dma</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dmastr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">parport_parse_param</span><span class="p">(</span><span class="n">dmastr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">PARPORT_DMA_AUTO</span><span class="p">,</span>
				     <span class="n">PARPORT_DMA_NONE</span><span class="p">,</span> <span class="n">PARPORT_DMA_NOFIFO</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parport_init_mode_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	     <span class="s">&quot;parport_pc.c: Specified parameter parport_init_mode=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;spp&quot;</span><span class="p">))</span>
		<span class="n">parport_init_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;ps2&quot;</span><span class="p">))</span>
		<span class="n">parport_init_mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;epp&quot;</span><span class="p">))</span>
		<span class="n">parport_init_mode</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;ecp&quot;</span><span class="p">))</span>
		<span class="n">parport_init_mode</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;ecpepp&quot;</span><span class="p">))</span>
		<span class="n">parport_init_mode</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">irq</span><span class="p">[</span><span class="n">PARPORT_PC_MAX_PORTS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dma</span><span class="p">[</span><span class="n">PARPORT_PC_MAX_PORTS</span><span class="p">];</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s">&quot;Base I/O address (SPP regs)&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io_hi</span><span class="p">,</span> <span class="s">&quot;Base I/O address (ECR)&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">io_hi</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;IRQ line&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="s">&quot;DMA channel&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_PARPORT_PC_SUPERIO) || \</span>
<span class="cp">       (defined(CONFIG_PARPORT_1284) &amp;&amp; defined(CONFIG_PARPORT_PC_FIFO))</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">verbose_probing</span><span class="p">,</span> <span class="s">&quot;Log chit-chat during initialisation&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">verbose_probing</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">init_mode</span><span class="p">;</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">init_mode</span><span class="p">,</span>
	<span class="s">&quot;Initialise mode for VIA VT8231 port (spp, ps2, epp, ecp or ecpepp)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">init_mode</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parse_parport_params</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_mode</span><span class="p">)</span>
		<span class="n">parport_init_mode_setup</span><span class="p">(</span><span class="n">init_mode</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PARPORT_PC_MAX_PORTS</span> <span class="o">&amp;&amp;</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parport_parse_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">irqval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parport_parse_dma</span><span class="p">(</span><span class="n">dma</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dmaval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* The user can make us use any IRQs or DMAs we find. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">parport_parse_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PARPORT_IRQ_NONE</span>:
			<span class="k">case</span> <span class="n">PARPORT_IRQ_AUTO</span>:
				<span class="n">irqval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					<span class="s">&quot;parport_pc: irq specified &quot;</span>
					<span class="s">&quot;without base address.  Use &#39;io=&#39; &quot;</span>
					<span class="s">&quot;to specify one</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">parport_parse_dma</span><span class="p">(</span><span class="n">dma</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PARPORT_DMA_NONE</span>:
			<span class="k">case</span> <span class="n">PARPORT_DMA_AUTO</span>:
				<span class="n">dmaval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					<span class="s">&quot;parport_pc: dma specified &quot;</span>
					<span class="s">&quot;without base address.  Use &#39;io=&#39; &quot;</span>
					<span class="s">&quot;to specify one</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">parport_setup_ptr</span> <span class="n">__initdata</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Acceptable parameters:</span>
<span class="cm"> *</span>
<span class="cm"> * parport=0</span>
<span class="cm"> * parport=auto</span>
<span class="cm"> * parport=0xBASE[,IRQ[,DMA]]</span>
<span class="cm"> *</span>
<span class="cm"> * IRQ/DMA may be numeric or &#39;auto&#39; or &#39;none&#39;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parport_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">endptr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">str</span> <span class="o">||</span> <span class="o">!*</span><span class="n">str</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!*</span><span class="p">(</span><span class="n">str</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Disable parport if &quot;parport=0&quot; in cmdline */</span>
		<span class="n">io</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PARPORT_DISABLE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;auto&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">irqval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PARPORT_IRQ_AUTO</span><span class="p">;</span>
		<span class="n">dmaval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PARPORT_DMA_AUTO</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">endptr</span> <span class="o">==</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;parport=%s not understood</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parport_setup_ptr</span> <span class="o">==</span> <span class="n">PARPORT_PC_MAX_PORTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;parport=%s ignored, too many ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">io</span><span class="p">[</span><span class="n">parport_setup_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">irqval</span><span class="p">[</span><span class="n">parport_setup_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">PARPORT_IRQ_NONE</span><span class="p">;</span>
	<span class="n">dmaval</span><span class="p">[</span><span class="n">parport_setup_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">PARPORT_DMA_NONE</span><span class="p">;</span>

	<span class="n">sep</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sep</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parport_parse_irq</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">irqval</span><span class="p">[</span><span class="n">parport_setup_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">sep</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sep</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">parport_parse_dma</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dmaval</span><span class="p">[</span><span class="n">parport_setup_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">parport_setup_ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parse_parport_params</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">io</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">PARPORT_DISABLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;parport=&quot;</span><span class="p">,</span> <span class="n">parport_setup</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Acceptable parameters:</span>
<span class="cm"> *</span>
<span class="cm"> * parport_init_mode=[spp|ps2|epp|ecp|ecpepp]</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_PCI</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;parport_init_mode=&quot;</span><span class="p">,</span> <span class="n">parport_init_mode_setup</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cm">/* &quot;Parser&quot; ends here */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">parport_pc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_parport_params</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parport_pc_platform_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="cm">/* Only probe the ports we were given. */</span>
		<span class="n">user_specified</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PARPORT_PC_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">io_hi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">PARPORT_IOHI_AUTO</span><span class="p">)</span>
				<span class="n">io_hi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">parport_pc_probe_port</span><span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">io_hi</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">irqval</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dmaval</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">parport_pc_find_ports</span><span class="p">(</span><span class="n">irqval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dmaval</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">parport_pc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_registered_parport</span><span class="p">)</span>
		<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parport_pc_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_registered_parport</span><span class="p">)</span>
		<span class="n">pnp_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parport_pc_pnp_driver</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parport_pc_platform_driver</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ports_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">parport_pc_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
		<span class="n">priv</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ports_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">parport_pc_private</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">platform_bus_type</span><span class="p">)</span>
			<span class="n">platform_device_unregister</span><span class="p">(</span>
				<span class="n">to_platform_device</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
		<span class="n">parport_pc_unregister_port</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Phil Blundell, Tim Waugh, others&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;PC-style parallel port driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">parport_pc_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">parport_pc_exit</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
