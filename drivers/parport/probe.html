<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › parport › probe.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>probe.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Parallel port device probing code</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:    Carsten Gross, carsten@sol.wohnheim.uni-ulm.de</span>
<span class="cm"> *             Philip Blundell &lt;philb@gnu.org&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/parport.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">classes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span>            <span class="s">&quot;Legacy device&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;PRINTER&quot;</span><span class="p">,</span>     <span class="s">&quot;Printer&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;MODEM&quot;</span><span class="p">,</span>       <span class="s">&quot;Modem&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;NET&quot;</span><span class="p">,</span>         <span class="s">&quot;Network device&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;HDC&quot;</span><span class="p">,</span>       	 <span class="s">&quot;Hard disk&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;PCMCIA&quot;</span><span class="p">,</span>      <span class="s">&quot;PCMCIA&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;MEDIA&quot;</span><span class="p">,</span>       <span class="s">&quot;Multimedia device&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;FDC&quot;</span><span class="p">,</span>         <span class="s">&quot;Floppy disk&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;PORTS&quot;</span><span class="p">,</span>       <span class="s">&quot;Ports&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SCANNER&quot;</span><span class="p">,</span>     <span class="s">&quot;Scanner&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;DIGICAM&quot;</span><span class="p">,</span>     <span class="s">&quot;Digital camera&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span>            <span class="s">&quot;Unknown device&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span>            <span class="s">&quot;Unspecified&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SCSIADAPTER&quot;</span><span class="p">,</span> <span class="s">&quot;SCSI adapter&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span>          <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pretty_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">parport_device_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">probe_info</span><span class="p">[</span><span class="n">device</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot; (addr %d)&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>

	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;: %s&quot;</span><span class="p">,</span> <span class="n">classes</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">].</span><span class="n">descr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, %s %s&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mfr</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">parse_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">txt</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">txt</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">guessed_class</span> <span class="o">=</span> <span class="n">PARPORT_CLASS_UNSPEC</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">parport_device_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">probe_info</span><span class="p">[</span><span class="n">device</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s probe: memory squeeze</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">sep</span><span class="p">;</span>
		<span class="n">q</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sc">&#39;;&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sep</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">u</span><span class="p">;</span>
			<span class="o">*</span><span class="p">(</span><span class="n">sep</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* Get rid of trailing blanks */</span>
			<span class="n">u</span> <span class="o">=</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">u</span> <span class="o">&gt;=</span> <span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">u</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
				<span class="o">*</span><span class="n">u</span><span class="o">--</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">u</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">u</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="o">*</span><span class="n">u</span><span class="p">);</span>
				<span class="n">u</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;MFG&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;MANUFACTURER&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mfr</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">mfr</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;MDL&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;MODEL&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;CLS&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;CLASS&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

				<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">class_name</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">class_name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">u</span> <span class="o">=</span> <span class="n">sep</span><span class="p">;</span> <span class="o">*</span><span class="n">u</span><span class="p">;</span> <span class="n">u</span><span class="o">++</span><span class="p">)</span>
					<span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="o">*</span><span class="n">u</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">token</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">token</span><span class="p">,</span> <span class="n">sep</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
						<span class="k">goto</span> <span class="n">rock_on</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s probe: warning, class &#39;%s&#39; not understood.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sep</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">PARPORT_CLASS_OTHER</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;CMD&quot;</span><span class="p">)</span> <span class="o">||</span>
				   <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;COMMAND SET&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmdset</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">cmdset</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="cm">/* if it speaks printer language, it&#39;s</span>
<span class="cm">				   probably a printer */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="s">&quot;PJL&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="n">strstr</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="s">&quot;PCL&quot;</span><span class="p">))</span>
					<span class="n">guessed_class</span> <span class="o">=</span> <span class="n">PARPORT_CLASS_PRINTER</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;DES&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;DESCRIPTION&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">description</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="nl">rock_on:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If the device didn&#39;t tell us its class, maybe we have managed to</span>
<span class="cm">	   guess one from the things it did say. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">PARPORT_CLASS_UNSPEC</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">guessed_class</span><span class="p">;</span>

	<span class="n">pretty_print</span> <span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">txt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read up to count-1 bytes of device id. Terminate buffer with</span>
<span class="cm"> * &#39;\0&#39;. Buffer begins with two Device ID length bytes as given by</span>
<span class="cm"> * device. */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">parport_read_device_id</span> <span class="p">(</span><span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">length</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">lelen</span><span class="p">,</span> <span class="n">belen</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">idlens</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">numidlens</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">current_idlen</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* First two bytes are MSB,LSB of inclusive length. */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">parport_read</span> <span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Some devices wrongly send LE length, and some send it two</span>
<span class="cm">	 * bytes short. Construct a sorted array of lengths to try. */</span>
	<span class="n">belen</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">length</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">lelen</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">length</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">idlens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">belen</span><span class="p">,</span> <span class="n">lelen</span><span class="p">);</span>
	<span class="n">idlens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">idlens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">belen</span> <span class="o">!=</span> <span class="n">lelen</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* Don&#39;t try lengths of 0x100 and 0x200 as 1 and 2 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idlens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">idlens</span><span class="p">[</span><span class="n">off</span><span class="p">]</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">belen</span><span class="p">,</span> <span class="n">lelen</span><span class="p">);</span>
		<span class="n">idlens</span><span class="p">[</span><span class="n">off</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">idlens</span><span class="p">[</span><span class="n">off</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
		<span class="n">numidlens</span> <span class="o">=</span> <span class="n">off</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Some devices don&#39;t truly implement Device ID, but</span>
<span class="cm">		 * just return constant nibble forever. This catches</span>
<span class="cm">		 * also those cases. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idlens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">idlens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0xFFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: reported broken Device ID&quot;</span>
				<span class="s">&quot; length of %#zX bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">idlens</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">numidlens</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Try to respect the given ID length despite all the bugs in</span>
<span class="cm">	 * the ID length. Read according to shortest possible ID</span>
<span class="cm">	 * first. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">current_idlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">current_idlen</span> <span class="o">&lt;</span> <span class="n">numidlens</span><span class="p">;</span> <span class="o">++</span><span class="n">current_idlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">idlen</span> <span class="o">=</span> <span class="n">idlens</span><span class="p">[</span><span class="n">current_idlen</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idlen</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">parport_read</span> <span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">idlen</span><span class="o">-</span><span class="n">len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">retval</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">physport</span><span class="o">-&gt;</span><span class="n">ieee1284</span><span class="p">.</span><span class="n">phase</span> <span class="o">!=</span> <span class="n">IEEE1284_PH_HBUSY_DAVAIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">belen</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Device ID was %zd bytes&quot;</span>
					<span class="s">&quot; while device told it would be %d&quot;</span>
					<span class="s">&quot; bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">belen</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* This might end reading the Device ID too</span>
<span class="cm">		 * soon. Hopefully the needed fields were already in</span>
<span class="cm">		 * the first 256 bytes or so that we must have read so</span>
<span class="cm">		 * far. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;;&#39;</span><span class="p">)</span> <span class="p">{</span>
 			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Device ID reading stopped&quot;</span>
				<span class="s">&quot; before device told data not available. &quot;</span>
				<span class="s">&quot;Current idlen %u of %u, len bytes %02X %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">current_idlen</span><span class="p">,</span> <span class="n">numidlens</span><span class="p">,</span>
				<span class="n">length</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">length</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_idlen</span> <span class="o">&lt;</span> <span class="n">numidlens</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Buffer not large enough, read to end of buffer. */</span>
		<span class="kt">size_t</span> <span class="n">idlen</span><span class="p">,</span> <span class="n">len2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">parport_read</span> <span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="n">count</span><span class="o">-</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="n">retval</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Read the whole ID since some devices would not</span>
<span class="cm">		 * otherwise give back the Device ID from beginning</span>
<span class="cm">		 * next time when asked. */</span>
		<span class="n">idlen</span> <span class="o">=</span> <span class="n">idlens</span><span class="p">[</span><span class="n">current_idlen</span><span class="p">];</span>
		<span class="n">len2</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">while</span><span class="p">(</span><span class="n">len2</span> <span class="o">&lt;</span> <span class="n">idlen</span> <span class="o">&amp;&amp;</span> <span class="n">retval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">parport_read</span> <span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
					       <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">idlen</span><span class="o">-</span><span class="n">len2</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
			<span class="n">len2</span> <span class="o">+=</span> <span class="n">retval</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* In addition, there are broken devices out there that don&#39;t</span>
<span class="cm">	   even finish off with a semi-colon. We do not need to care</span>
<span class="cm">	   about those at this time. */</span>
 <span class="nl">done:</span>
	<span class="n">buffer</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get Std 1284 Device ID. */</span>
<span class="kt">ssize_t</span> <span class="nf">parport_device_id</span> <span class="p">(</span><span class="kt">int</span> <span class="n">devnum</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pardevice</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">parport_open</span> <span class="p">(</span><span class="n">devnum</span><span class="p">,</span> <span class="s">&quot;Device ID probe&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">parport_claim_or_block</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Negotiate to compatibility mode, and then to device ID</span>
<span class="cm">	 * mode. (This so that we start form beginning of device ID if</span>
<span class="cm">	 * already in device ID mode.) */</span>
	<span class="n">parport_negotiate</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">IEEE1284_MODE_COMPAT</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">parport_negotiate</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
				    <span class="n">IEEE1284_MODE_NIBBLE</span> <span class="o">|</span> <span class="n">IEEE1284_DEVICEID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">parport_read_device_id</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">parport_negotiate</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">IEEE1284_MODE_COMPAT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">parse_data</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">daisy</span><span class="p">,</span> <span class="n">buffer</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">parport_release</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">parport_close</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
